<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Vishal Bakshi&#39;s Blog</title>
<link>https://vishalbakshi.github.io/blog/index.html</link>
<atom:link href="https://vishalbakshi.github.io/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>Machine Learning blog by Vishal Bakshi</description>
<generator>quarto-1.2.335</generator>
<lastBuildDate>Sun, 27 Apr 2025 07:00:00 GMT</lastBuildDate>
<item>
  <title>TinyScale Lab Update: Training Cost Analysis and Evaluation Infrastructure Plans</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-27-TSL-Initial-Training-Runs/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I’ll share results from some quick and dirty training runs executed so I get a rough but reasonable estimate of training time and costs using L4 and A100 GPUs on Google Colab Pro.</p>
</section>
<section id="model-sizes" class="level2">
<h2 class="anchored" data-anchor-id="model-sizes">Model Sizes</h2>
<p>In these experiments, I’m training four model sizes: 5M, 25M, 60M and 125M. I’ve chosen to roughly follow the TinyStories models, using the hidden dimension and intermediate dimension for the TinyStories-1M, -8M, -28M and -33M models, in each case there is a 4x increase from hidden to intermediate dimension in the MLP layers. These are just initial architectural choices which might change over the course of the project as I learn more about what results in a better performing model.</p>
<p>For now, I’m using 8 attention heads (for all models) and the Llama-2 tokenizer with a 32000 vocab size.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model Name</th>
<th style="text-align: center;">Hidden Dim</th>
<th style="text-align: center;">Intermediate Dim</th>
<th style="text-align: center;">Number of Layers</th>
<th style="text-align: center;">Number of Params</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">5M</td>
<td style="text-align: center;">64</td>
<td style="text-align: center;">256</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">4_949_696</td>
</tr>
<tr class="even">
<td style="text-align: center;">25M</td>
<td style="text-align: center;">256</td>
<td style="text-align: center;">1024</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">24_776_960</td>
</tr>
<tr class="odd">
<td style="text-align: center;">60M</td>
<td style="text-align: center;">512</td>
<td style="text-align: center;">2048</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">57_940_480</td>
</tr>
<tr class="even">
<td style="text-align: center;">125M</td>
<td style="text-align: center;">768</td>
<td style="text-align: center;">3072</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">124_662_528</td>
</tr>
</tbody>
</table>
</section>
<section id="training-dataset" class="level2">
<h2 class="anchored" data-anchor-id="training-dataset">Training Dataset</h2>
<p>I’ve tokenized the <a href="https://huggingface.co/datasets/roneneldan/TinyStories/blob/main/TinyStories_all_data.tar.gz">TinyStories_all_data.tar.gz</a> dataset which contains 4.9M stories generated by GPT3.5 and GPT4, using the <code>meta-llama/Llama-2-7b-hf</code> tokenizer. I haven’t performed any data cleaning (yet). The total number of tokens in this dataset is little over 1B: <strong>1_028_013_532</strong>.</p>
</section>
<section id="training-duration" class="level2">
<h2 class="anchored" data-anchor-id="training-duration">Training Duration</h2>
<p>I’m training all initial runs for 1 epoch.</p>
</section>
<section id="training-gpus" class="level2">
<h2 class="anchored" data-anchor-id="training-gpus">Training GPUs</h2>
<p>I trained the 5M and 25M models on both L4 (22.5 GB VRAM) and A100 (40GB VRAM) GPUs. I trained the 60M and 125M models on the A100 GPU.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>All models are trained for 1 epoch (1.03 tokens):</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Hardware</th>
<th style="text-align: center;">Model Size</th>
<th style="text-align: center;">Time (hr)</th>
<th style="text-align: center;">Batch Size</th>
<th style="text-align: center;">Max Memory</th>
<th style="text-align: center;">Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">L4</td>
<td style="text-align: center;">5M</td>
<td style="text-align: center;">0.87</td>
<td style="text-align: center;">384</td>
<td style="text-align: center;">20%</td>
<td style="text-align: center;">$0.18</td>
</tr>
<tr class="even">
<td style="text-align: center;">L4</td>
<td style="text-align: center;">25M</td>
<td style="text-align: center;">1.45</td>
<td style="text-align: center;">288</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">$0.30</td>
</tr>
<tr class="odd">
<td style="text-align: center;">A100-40GB</td>
<td style="text-align: center;">5M</td>
<td style="text-align: center;">0.32</td>
<td style="text-align: center;">2048</td>
<td style="text-align: center;">78%</td>
<td style="text-align: center;">$0.25</td>
</tr>
<tr class="even">
<td style="text-align: center;">A100-40GB</td>
<td style="text-align: center;">25M</td>
<td style="text-align: center;">0.35</td>
<td style="text-align: center;">1536</td>
<td style="text-align: center;">98%</td>
<td style="text-align: center;">$0.27</td>
</tr>
<tr class="odd">
<td style="text-align: center;">A100-40GB</td>
<td style="text-align: center;">60M</td>
<td style="text-align: center;">0.54</td>
<td style="text-align: center;">1152</td>
<td style="text-align: center;">86%</td>
<td style="text-align: center;">$0.41</td>
</tr>
<tr class="even">
<td style="text-align: center;">A100-40GB</td>
<td style="text-align: center;">125M</td>
<td style="text-align: center;">1.10</td>
<td style="text-align: center;">512</td>
<td style="text-align: center;">99%</td>
<td style="text-align: center;">$0.84</td>
</tr>
</tbody>
</table>
</section>
<section id="takeaways" class="level2">
<h2 class="anchored" data-anchor-id="takeaways">Takeaways</h2>
<p>From this analysis, only the 5M model makes sense to train on the L4. It’s 3 cents cheaper per hour to train the 25M model on the A100, though I’m flirting with OOM so I should reduce the batch size.</p>
<p>I’ll need to perform longer trainings to get a sense of how many full epochs I need to produce coherent language-generating models, but from my TinyHackathon experience, it took 20 epochs for the 60M model to perform decently (3/5 LLM Judge overall score). I would expect the 125M model to require less epochs, and the smaller models more epochs, to achieve comparable performance. But we’ll see!</p>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<p>Here are the <code>LlamaConfig</code> objects for each model:</p>
<section id="m" class="level3">
<h3 class="anchored" data-anchor-id="m">5M</h3>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">config <span class="op" style="color: #5E5E5E;">=</span> LlamaConfig(</span>
<span id="cb1-2">    vocab_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">32000</span>,</span>
<span id="cb1-3">    hidden_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">64</span>,</span>
<span id="cb1-4">    intermediate_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>,</span>
<span id="cb1-5">    num_hidden_layers<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">13</span>,</span>
<span id="cb1-6">    num_attention_heads<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb1-7">    max_position_embeddings<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">512</span>,</span>
<span id="cb1-8">    rope_theta<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">10000.0</span>,</span>
<span id="cb1-9">    attention_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb1-10">    mlp_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,</span>
<span id="cb1-11">    attn_implementation<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"flash_attention_2"</span>,</span>
<span id="cb1-12">    torch_dtype<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bfloat16"</span></span>
<span id="cb1-13">)</span></code></pre></div>
</section>
<section id="m-1" class="level3">
<h3 class="anchored" data-anchor-id="m-1">25M</h3>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">config <span class="op" style="color: #5E5E5E;">=</span> LlamaConfig(</span>
<span id="cb2-2">    vocab_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">32000</span>,</span>
<span id="cb2-3">    hidden_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>,</span>
<span id="cb2-4">    intermediate_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1024</span>,</span>
<span id="cb2-5">    num_hidden_layers<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb2-6">    num_attention_heads<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb2-7">    max_position_embeddings<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">512</span>,</span>
<span id="cb2-8">    rope_theta<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">10000.0</span>,</span>
<span id="cb2-9">    attention_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb2-10">    mlp_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,</span>
<span id="cb2-11">    attn_implementation<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"flash_attention_2"</span>,</span>
<span id="cb2-12">    torch_dtype<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bfloat16"</span></span>
<span id="cb2-13">)</span></code></pre></div>
</section>
<section id="m-2" class="level3">
<h3 class="anchored" data-anchor-id="m-2">60M</h3>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">config <span class="op" style="color: #5E5E5E;">=</span> LlamaConfig(</span>
<span id="cb3-2">    vocab_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">32000</span>,</span>
<span id="cb3-3">    hidden_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">512</span>,</span>
<span id="cb3-4">    intermediate_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2048</span>,</span>
<span id="cb3-5">    num_hidden_layers<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">6</span>,</span>
<span id="cb3-6">    num_attention_heads<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb3-7">    max_position_embeddings<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">512</span>,</span>
<span id="cb3-8">    rope_theta<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">10000.0</span>,</span>
<span id="cb3-9">    attention_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb3-10">    mlp_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,</span>
<span id="cb3-11">    attn_implementation<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"flash_attention_2"</span>,</span>
<span id="cb3-12">    torch_dtype<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bfloat16"</span></span>
<span id="cb3-13">)</span></code></pre></div>
</section>
<section id="m-3" class="level3">
<h3 class="anchored" data-anchor-id="m-3">125M</h3>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">config <span class="op" style="color: #5E5E5E;">=</span> LlamaConfig(</span>
<span id="cb4-2">    vocab_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">32000</span>,</span>
<span id="cb4-3">    hidden_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">768</span>,</span>
<span id="cb4-4">    intermediate_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3072</span>,</span>
<span id="cb4-5">    num_hidden_layers<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb4-6">    num_attention_heads<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>,</span>
<span id="cb4-7">    max_position_embeddings<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">512</span>,</span>
<span id="cb4-8">    rope_theta<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">10000.0</span>,</span>
<span id="cb4-9">    attention_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb4-10">    mlp_bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,</span>
<span id="cb4-11">    attn_implementation<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"flash_attention_2"</span>,</span>
<span id="cb4-12">    torch_dtype<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bfloat16"</span></span>
<span id="cb4-13">)</span></code></pre></div>


</section>
</section>

 ]]></description>
  <category>LLM</category>
  <category>deep learning</category>
  <category>TinyScale-Lab</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-27-TSL-Initial-Training-Runs/index.html</guid>
  <pubDate>Sun, 27 Apr 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>TinyScale Lab: Bridging Training Dynamics and Model Capabilities</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-26-TinyScale-Lab-Kickoff/index.html</link>
  <description><![CDATA[ 



<iframe width="560" height="315" src="https://www.youtube.com/embed/82mE39Ef5eY?si=5h9fdvnAF0071VcA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>I’m excited to announce the kickoff of TinyScale Lab, a research project focused on exploring the connection between training dynamics and model capabilities. This research is motivated by two papers that I’ve studied in detail: <a href="https://arxiv.org/abs/2305.07759">“TinyStories: How Small Can Language Models Be and Still Speak Coherent English?” by Ronen Eldan and Yuanzhi Li</a>, and <a href="https://arxiv.org/abs/2309.14322">“Small-scale proxies for Large-scale Transformer Training Instabilities” by Wortsman, et al</a>.</p>
<p>Most LLM training-related research requires computational resources that are financially out of reach for individual researchers or small teams. At the same time, recent work has shown that tiny models exhibit emergent capabilities (as demonstrated in the TinyStories paper) and exhibit large-scale training dynamics (as shown in the Small-scale proxies paper).</p>
<p>While I don’t claim to be creating a definitive blueprint, I believe this approach—using tiny models as proxies to study phenomena relevant to models of all sizes—represents an underexplored path that could benefit other resource-constrained researchers.</p>
<p>I think this is how most of the world’s potential researchers would need to work. Making ML research accessible to resource-constrained environments isn’t trivial - it’s essential for the field’s diversity and progress.</p>
</section>
<section id="research-hypotheses" class="level2">
<h2 class="anchored" data-anchor-id="research-hypotheses">Research Hypotheses</h2>
<p>I’ve developed four main hypotheses that will guide my research:</p>
<ol type="1">
<li><strong>H1</strong>: Training stability directly affects specific model capabilities in predictable ways.</li>
<li><strong>H2</strong>: Different model capabilities (like grammar or consistency) respond differently to training adjustments.</li>
<li><strong>H3</strong>: Early training signals can predict which capabilities a model will or won’t develop before training is complete.</li>
<li><strong>H4</strong>: Techniques that stabilize training will have varying effects on different types of model capabilities.</li>
</ol>
<p>I’ve kept these hypotheses general at a high level because I really don’t know what I’m going to learn, but I do have a sense based on the TinyStories and Small-scale proxies papers that there is something around these four elements that I’m going to experience, and I expect to see some relationships.</p>
<p>I want to bridge the TinyStories paper analysis on emergent capabilities (grammar, consistency, factual knowledge, reasoning, etc.) with the Small-scale proxies paper training dynamics analysis (attention logits, training instabilities, learning rates, etc.).</p>
</section>
<section id="experimental-design" class="level2">
<h2 class="anchored" data-anchor-id="experimental-design">Experimental Design</h2>
<p>For my experimental design, I’ve decided to focus on four model sizes:</p>
<ul>
<li>~3M parameters</li>
<li>~20M parameters</li>
<li>~60M parameters</li>
<li>~120M parameters</li>
</ul>
<p>This follows the TinyStories paper closely, with the addition of a 120M parameter model.</p>
<p>I’ll use the same learning rates as the Small-scale proxies paper, ranging from 3e-4 to 3e-1 with seven learning rates in total: <code>{3e-4, 1e-3, 3e-3, 1e-2, 3e-2, 1e-1, 3e-1}</code></p>
<p>I’ll implement two stability techniques from the Small-scale proxies paper:</p>
<ul>
<li>QK layer norm (to mitigate attention logit growth)</li>
<li>Z loss (to mitigate output logit divergence)</li>
</ul>
<p>What will remain fixed across all training runs are the datasets, the number of training steps, and other hyperparameters like weight decay and warm-up steps.</p>
<p>The training dynamics I’ll log throughout training include:</p>
<ul>
<li>Logits</li>
<li>Gradients</li>
<li>Parameters</li>
<li>Loss</li>
</ul>
<p>For each of these, I’ll capture norms, means, maximum values, and RMS values.</p>
<p>The capabilities I want to evaluate are split into three categories:</p>
<ol type="1">
<li><strong>Foundational language</strong>: Grammar and context-tracking (consistency)</li>
<li><strong>Emergent capabilities</strong>: Factual knowledge, reasoning, and creativity</li>
<li><strong>Story-related</strong>: Plot</li>
</ol>
<p>The relationship between these training dynamics and capabilities is what I want to explore.</p>
</section>
<section id="success-criteria" class="level2">
<h2 class="anchored" data-anchor-id="success-criteria">Success Criteria</h2>
<p>My success criteria are simple but not easy: establishing clear connections between training dynamics and tiny model capabilities. This work is exploratory, and I’m open to discovering that the relationships might be more complex or different than initially hypothesized.</p>
</section>
<section id="risk-assessment" class="level2">
<h2 class="anchored" data-anchor-id="risk-assessment">Risk Assessment</h2>
<p>I’ve identified several risks that could impact this project:</p>
<ol type="1">
<li>Lack of connection between training dynamics and tiny model capabilities</li>
<li>Technical challenges in monitoring complex training dynamics</li>
<li>Sub-optimal parameter usage</li>
<li>Compute and inference costs ballooning beyond budget</li>
</ol>
</section>
<section id="risk-mitigation" class="level2">
<h2 class="anchored" data-anchor-id="risk-mitigation">Risk Mitigation</h2>
<p>To mitigate these risks, I plan to:</p>
<ol type="1">
<li>Shorten the iteration loop</li>
<li>Ensure evaluations are robust from the start</li>
<li>Start at the tiniest scale and progressively increase model size</li>
<li>Implement early stopping to avoid wasting compute</li>
</ol>
<p>I learned from the fastAI course and community that you want to shorten the iteration loop and ensure that evals are robust from the start. This gives you quick, immediate, robust, clear signal when you get feedback on how your model is performing.</p>
</section>
<section id="deliverables" class="level2">
<h2 class="anchored" data-anchor-id="deliverables">Deliverables</h2>
<p>My commitment is to produce:</p>
<ol type="1">
<li>Comprehensive research repositories including code, trained models, and detailed datasets (training dynamics and LLM Judge scores)</li>
<li>Weekly video content and blog posts</li>
<li>Technical report</li>
<li>Interactive visualizations</li>
</ol>
<p>The main thing I want to emphasize is that I’ll be doing this publicly and open-source. All models, code, and findings will be freely available to enable broader participation in ML research.</p>
</section>
<section id="timeline-and-budget" class="level2">
<h2 class="anchored" data-anchor-id="timeline-and-budget">Timeline and Budget</h2>
<p>I’ve broken the project into four phases:</p>
<ol type="1">
<li><strong>Phase 1</strong>: Eval/Logging Setup, Initial Training Runs (2-3 months)</li>
<li><strong>Phase 2</strong>: Experimental Implementation (3-4 months)</li>
<li><strong>Phase 3</strong>: Analysis &amp; Synthesis (2-3 months)</li>
<li><strong>Phase 4</strong>: Documentation &amp; Finalization (1 month)</li>
</ol>
<p>At minimum, I think this work will take eight months, and it could go well past a year.</p>
<p>For the budget, I’m estimating: - <strong>Training</strong>: $1700 (approximately 100 training runs on 25B tokens) - <strong>Inference</strong>: $200 (using Gemini 2.5 Flash for LLM Judge scoring) - <strong>Total</strong>: $2000</p>
<p>At this point, I’m considering whether it makes sense to buy my own GPU rig. If this is going to cost $2,000, why not spend a little more or twice as much and get a GPU rig that I can own? There are a lot of variables when it comes to budget and timeline, so I’m going to take it one week at a time and make adjustments as necessary.</p>
</section>
<section id="closing-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="closing-thoughts">Closing Thoughts</h2>
<p>To recap, TinyScale Lab aims to:</p>
<ol type="1">
<li>Bridge training dynamics and model capabilities to understand what makes tiny models effective</li>
<li>Create a systematic framework for understanding how training choices affect specific model capabilities</li>
<li>Demonstrate that meaningful ML research is accessible with modest computational resources</li>
<li>Open-source all models, code, and findings to enable broader participation in ML research</li>
</ol>
<p>As Nick Sirianni (championship winning coach of the Philadelphia Eagles) said, “You cannot be great without the greatness of others.” I truly stand on the shoulders of giants, especially the authors of the TinyStories and Small-scale proxies papers. Without their work and contributions in the open source space, I would not be able to even approach this kind of research.</p>
<p>If someone with similar interests sees this work and it inspires them, or they can use something I built that saves them time, saves them money, or gives them insight–that would be the best reward that comes out of this work.</p>
<p>I hope you’ll follow along with this journey. I’ll be keeping everything in the <a href="https://www.youtube.com/playlist?list=PLVaenshL7UUD8iFmDDUpLCcuB-K_72mwI">TinyScale Lab playlist on my YouTube</a> and will tag related posts on my blog.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="TinyScale-Lab bridges the gap between tiny model capabilities and training dynamics"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-26-TinyScale-Lab-Kickoff/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">TinyScale-Lab bridges the gap between tiny model capabilities and training dynamics</figcaption><p></p>
</figure>
</div>


</section>

 ]]></description>
  <category>LLM</category>
  <category>deep learning</category>
  <category>TinyScale-Lab</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-26-TinyScale-Lab-Kickoff/index.html</guid>
  <pubDate>Sat, 26 Apr 2025 07:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2025-04-26-TinyScale-Lab-Kickoff/1.png" medium="image" type="image/png" height="216" width="144"/>
</item>
<item>
  <title>LossInspector: A Deep Dive Into LLM-Foundry’s Next-Token Prediction with a Custom Composer Callback</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-22-LossInspector/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I’m working on a research project where we’ll be fine-tuning small models with various techniques and datasets using LLM-Foundry. As part of our infrastructure setup, we wanted to make sure that we thoroughly understood how a batch of data is prepared by LLM-Foundry, and how the outputs of a model, along with the labels, are passed to the loss function to calculate the loss. To do so, with the help of Claude, I wrote up a custom Composer Callback. This is the third custom callback I’ve written for Composer/LLM-Foundry, you can read more about <a href="https://vishalbakshi.github.io/blog/posts/2025-03-30-Composer-Callback/">my first</a> and <a href="https://vishalbakshi.github.io/blog/posts/2025-04-02-Composer-Callback-Logging-dtypes/">second</a> callbacks.</p>
<p>I was initially going to have two or three callbacks: one to inspect inputs/outputs to the embedding, one to inspect the input/outputs to the model’s forward pass, and one to inspect the loss function. 27 commits later, I had a relatively lean single callback that gave me all the information I needed.</p>
<p>I focused on three events during Composer’s <a href="https://docs.mosaicml.com/projects/composer/en/stable/trainer/events.html">training loop</a>:</p>
<ul>
<li><code>before_loss</code>: to store the “untouched” batch from Composer’s <code>state</code>.</li>
<li><code>before_forward</code>: to store the untouched <code>input_ids</code> and <code>labels</code> from the state’s batch.</li>
<li><code>after_loss</code>: to both capture the calculated loss and “manually” calculate the loss using the model’s loss function.</li>
</ul>
<p>Before we go further into detail, here’s the callback code (and necessary imports):</p>
<p>Here’s my video walkthrough of the code in this notebook:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/9ffnmeiDF_M?si=DVAZhHFDfxkuzG6n" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>
</section>
<section id="lossinspector-callback" class="level2">
<h2 class="anchored" data-anchor-id="lossinspector-callback"><code>LossInspector</code> Callback</h2>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> composer.core.callback <span class="im" style="color: #00769E;">import</span> Callback</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> composer.core <span class="im" style="color: #00769E;">import</span> State</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> composer.loggers <span class="im" style="color: #00769E;">import</span> Logger</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb1-5"></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;">class</span> LossInspector(Callback):       </span>
<span id="cb1-8">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb1-9">        <span class="bu" style="color: null;">super</span>().<span class="fu" style="color: #4758AB;">__init__</span>()</span>
<span id="cb1-10">        <span class="va" style="color: #111111;">self</span>.inspected <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb1-11">        <span class="va" style="color: #111111;">self</span>.input_ids <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb1-12">        <span class="va" style="color: #111111;">self</span>.labels <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb1-13">    </span>
<span id="cb1-14">    <span class="kw" style="color: #003B4F;">def</span> before_loss(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-15">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.inspected:</span>
<span id="cb1-16">            <span class="cf" style="color: #003B4F;">return</span></span>
<span id="cb1-17">        <span class="va" style="color: #111111;">self</span>.state_outputs <span class="op" style="color: #5E5E5E;">=</span> state.outputs</span>
<span id="cb1-18">        <span class="va" style="color: #111111;">self</span>.state_batch <span class="op" style="color: #5E5E5E;">=</span> state.batch</span>
<span id="cb1-19">        </span>
<span id="cb1-20"></span>
<span id="cb1-21">    <span class="kw" style="color: #003B4F;">def</span> before_forward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-22">        <span class="co" style="color: #5E5E5E;"># check that input_ids and labels are the same as after loss</span></span>
<span id="cb1-23">        <span class="va" style="color: #111111;">self</span>.input_ids <span class="op" style="color: #5E5E5E;">=</span> state.batch[<span class="st" style="color: #20794D;">'input_ids'</span>][<span class="dv" style="color: #AD0000;">0</span>].detach().cpu()</span>
<span id="cb1-24">        <span class="va" style="color: #111111;">self</span>.labels <span class="op" style="color: #5E5E5E;">=</span> state.batch[<span class="st" style="color: #20794D;">'labels'</span>][<span class="dv" style="color: #AD0000;">0</span>].detach().cpu()</span>
<span id="cb1-25">    </span>
<span id="cb1-26">    <span class="kw" style="color: #003B4F;">def</span> after_loss(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-27">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.inspected:</span>
<span id="cb1-28">            <span class="cf" style="color: #003B4F;">return</span></span>
<span id="cb1-29">            </span>
<span id="cb1-30">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">=== LOSS CALCULATION INSPECTION ==="</span>)</span>
<span id="cb1-31">        </span>
<span id="cb1-32">        <span class="co" style="color: #5E5E5E;"># Get the framework loss from state</span></span>
<span id="cb1-33">        framework_loss <span class="op" style="color: #5E5E5E;">=</span> state.loss.item()</span>
<span id="cb1-34">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Framework loss: </span><span class="sc" style="color: #5E5E5E;">{</span>framework_loss<span class="sc" style="color: #5E5E5E;">:.6f}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-35">        </span>
<span id="cb1-36">        <span class="co" style="color: #5E5E5E;"># Access model's loss_function directly</span></span>
<span id="cb1-37">        logits <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.state_outputs[<span class="st" style="color: #20794D;">'logits'</span>]</span>
<span id="cb1-38">        labels <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.state_batch[<span class="st" style="color: #20794D;">'labels'</span>]</span>
<span id="cb1-39">        vocab_size <span class="op" style="color: #5E5E5E;">=</span> state.model.model.config.vocab_size</span>
<span id="cb1-40">        </span>
<span id="cb1-41">        direct_loss <span class="op" style="color: #5E5E5E;">=</span> state.model.model.loss_function(</span>
<span id="cb1-42">            logits<span class="op" style="color: #5E5E5E;">=</span>logits,</span>
<span id="cb1-43">            labels<span class="op" style="color: #5E5E5E;">=</span>labels,</span>
<span id="cb1-44">            vocab_size<span class="op" style="color: #5E5E5E;">=</span>vocab_size</span>
<span id="cb1-45">        )</span>
<span id="cb1-46">        </span>
<span id="cb1-47">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Direct call to model.loss_function: </span><span class="sc" style="color: #5E5E5E;">{</span>direct_loss<span class="sc" style="color: #5E5E5E;">.</span>item()<span class="sc" style="color: #5E5E5E;">:.6f}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-48">        </span>
<span id="cb1-49">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">-------- input_ids --------"</span>)</span>
<span id="cb1-50">        input_ids <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.state_batch[<span class="st" style="color: #20794D;">'input_ids'</span>][<span class="dv" style="color: #AD0000;">0</span>].detach().cpu()</span>
<span id="cb1-51">        <span class="bu" style="color: null;">print</span>(input_ids.tolist())</span>
<span id="cb1-52">        decoded_input <span class="op" style="color: #5E5E5E;">=</span> state.model.tokenizer.decode(input_ids)</span>
<span id="cb1-53">        <span class="bu" style="color: null;">print</span>(decoded_input[:<span class="dv" style="color: #AD0000;">1000</span>])</span>
<span id="cb1-54">        </span>
<span id="cb1-55">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">-------- labels --------"</span>)</span>
<span id="cb1-56">        labels <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.state_batch[<span class="st" style="color: #20794D;">'labels'</span>][<span class="dv" style="color: #AD0000;">0</span>].detach().cpu()</span>
<span id="cb1-57">        <span class="bu" style="color: null;">print</span>(labels.tolist())</span>
<span id="cb1-58">        valid_labels <span class="op" style="color: #5E5E5E;">=</span> labels[labels <span class="op" style="color: #5E5E5E;">!=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">100</span>]</span>
<span id="cb1-59">        decoded_labels <span class="op" style="color: #5E5E5E;">=</span> state.model.tokenizer.decode(valid_labels)</span>
<span id="cb1-60">        <span class="bu" style="color: null;">print</span>(decoded_labels)</span>
<span id="cb1-61"></span>
<span id="cb1-62">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">-------- matches before_forward values? --------"</span>)</span>
<span id="cb1-63">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"input_ids: </span><span class="sc" style="color: #5E5E5E;">{</span>torch<span class="sc" style="color: #5E5E5E;">.</span>allclose(input_ids, <span class="va" style="color: #111111;">self</span>.input_ids)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-64">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"labels: </span><span class="sc" style="color: #5E5E5E;">{</span>torch<span class="sc" style="color: #5E5E5E;">.</span>allclose(labels, <span class="va" style="color: #111111;">self</span>.labels)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-65">        </span>
<span id="cb1-66">        <span class="va" style="color: #111111;">self</span>.inspected <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span></code></pre></div>
<p>The callback is then appended to the <code>callbacks</code> list before passed to the Composer trainer.</p>
</section>
<section id="smollm2-135m-loss-function" class="level2">
<h2 class="anchored" data-anchor-id="smollm2-135m-loss-function">SmolLM2-135M Loss Function</h2>
<p>It was surprisingly difficult to inspect the loss function. Or rather my lack of Composer/HuggingFace internals knowledge immediately surfaced with this task! Looking through the Composer GitHub repo and documentation, I found the following references to the model’s loss function—all quite helpful but too general:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">loss <span class="op" style="color: #5E5E5E;">=</span> model.loss(outputs, targets)</span></code></pre></div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;">for</span> epoch <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(NUM_EPOCHS):</span>
<span id="cb3-2">    <span class="cf" style="color: #003B4F;">for</span> inputs, targets <span class="kw" style="color: #003B4F;">in</span> dataloader:</span>
<span id="cb3-3">        outputs <span class="op" style="color: #5E5E5E;">=</span> model.forward(inputs)</span>
<span id="cb3-4">        loss <span class="op" style="color: #5E5E5E;">=</span> model.loss(outputs, targets)</span>
<span id="cb3-5">        loss.backward()</span>
<span id="cb3-6">        optimizer.step()</span>
<span id="cb3-7">        optimizer.zero_grad()</span></code></pre></div>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;">def</span> loss(<span class="va" style="color: #111111;">self</span>, outputs, batch):</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;"># pass batches and `forward` outputs to the loss</span></span>
<span id="cb4-3">    _, targets <span class="op" style="color: #5E5E5E;">=</span> batch</span>
<span id="cb4-4">    <span class="cf" style="color: #003B4F;">return</span> F.cross_entropy(outputs, targets)</span></code></pre></div>
<p>I looked at their MixUp algorithm’s source code in hopes for more detail but found none—though it did help me confirm how batches are handled:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;">class</span> MixUp(Algorithm):</span>
<span id="cb5-2">    <span class="kw" style="color: #003B4F;">def</span> match(<span class="va" style="color: #111111;">self</span>, event: Event, state: State) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="bu" style="color: null;">bool</span>:</span>
<span id="cb5-3">        <span class="co" style="color: #5E5E5E;">"""Determines whether the algorithm should run on a given event."""</span></span>
<span id="cb5-4">        <span class="cf" style="color: #003B4F;">return</span> event <span class="kw" style="color: #003B4F;">in</span> [Event.AFTER_DATALOADER, Event.AFTER_LOSS]</span>
<span id="cb5-5"></span>
<span id="cb5-6">    <span class="kw" style="color: #003B4F;">def</span> <span class="bu" style="color: null;">apply</span>(<span class="va" style="color: #111111;">self</span>, event: Event, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb5-7">        <span class="co" style="color: #5E5E5E;">"""Run the algorithm by modifying the State."""</span></span>
<span id="cb5-8">        <span class="bu" style="color: null;">input</span>, target <span class="op" style="color: #5E5E5E;">=</span> state.batch</span>
<span id="cb5-9"></span>
<span id="cb5-10">        <span class="cf" style="color: #003B4F;">if</span> event <span class="op" style="color: #5E5E5E;">==</span> Event.AFTER_DATALOADER:</span>
<span id="cb5-11">            new_input, <span class="va" style="color: #111111;">self</span>.permuted_target, <span class="va" style="color: #111111;">self</span>.mixing <span class="op" style="color: #5E5E5E;">=</span> mixup_batch(<span class="bu" style="color: null;">input</span>, target, alpha<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.2</span>)</span>
<span id="cb5-12">            state.batch <span class="op" style="color: #5E5E5E;">=</span> (new_input, target)</span>
<span id="cb5-13"></span>
<span id="cb5-14">        <span class="cf" style="color: #003B4F;">if</span> event <span class="op" style="color: #5E5E5E;">==</span> Event.AFTER_LOSS:</span>
<span id="cb5-15">            modified_batch <span class="op" style="color: #5E5E5E;">=</span> (<span class="bu" style="color: null;">input</span>, <span class="va" style="color: #111111;">self</span>.permuted_target)</span>
<span id="cb5-16">            new_loss <span class="op" style="color: #5E5E5E;">=</span> state.model.loss(state.outputs, modified_batch)</span>
<span id="cb5-17">            state.loss <span class="op" style="color: #5E5E5E;">*=</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="va" style="color: #111111;">self</span>.mixing)</span>
<span id="cb5-18">            state.loss <span class="op" style="color: #5E5E5E;">+=</span> <span class="va" style="color: #111111;">self</span>.mixing <span class="op" style="color: #5E5E5E;">*</span> new_loss</span></code></pre></div>
<p>Looking at Composer’s <code>HuggingFaceModel</code> did not give me the necessary detail, but provided the key for the next step: the loss was stored in <code>outputs</code>.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;">def</span> loss(<span class="va" style="color: #111111;">self</span>, outputs, batch):</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.config.use_return_dict:</span>
<span id="cb6-3">        <span class="cf" style="color: #003B4F;">return</span> outputs[<span class="st" style="color: #20794D;">'loss'</span>]</span>
<span id="cb6-4">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb6-5">        <span class="co" style="color: #5E5E5E;"># loss is at index 0 in the output tuple</span></span>
<span id="cb6-6">        <span class="cf" style="color: #003B4F;">return</span> outputs[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<p>Did this mean that the loss function was tucked away in the forward pass? Let’s take a look.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> AutoModelForCausalLM, AutoTokenizer</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">model_name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"HuggingFaceTB/SmolLM2-135M"</span></span>
<span id="cb8-2">tokenizer <span class="op" style="color: #5E5E5E;">=</span> AutoTokenizer.from_pretrained(model_name)</span>
<span id="cb8-3">model <span class="op" style="color: #5E5E5E;">=</span> AutoModelForCausalLM.from_pretrained(model_name)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;">import</span> inspect</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">forward_method <span class="op" style="color: #5E5E5E;">=</span> inspect.getsource(model.forward)</span>
<span id="cb10-2"><span class="bu" style="color: null;">print</span>(forward_method)</span></code></pre></div>
</div>
<p>I won’t print out the whole forward method, but will highlight that tucked away in there was the loss function call!</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">loss <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;">if</span> labels <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb11-3">    loss <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.loss_function(logits<span class="op" style="color: #5E5E5E;">=</span>logits, labels<span class="op" style="color: #5E5E5E;">=</span>labels, vocab_size<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.config.vocab_size, <span class="op" style="color: #5E5E5E;">**</span>kwargs)</span></code></pre></div>
<p>Aha! The function in question is <code>loss_function</code>. Inspecting that in more detail:</p>
<div class="cell" data-outputid="d9ba0d35-319f-444b-e060-7842ce9c6ebf" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">hasattr</span>(model, <span class="st" style="color: #20794D;">'loss_function'</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
</div>
<p>This was a great opportunity for a refresher on the next-token objective and auto-regressive nature of this model.</p>
<div class="cell" data-outputid="be12edc7-9551-4d19-99f6-16d6af06abe1" data-execution_count="16">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="bu" style="color: null;">print</span>(inspect.getsource(model.loss_function))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>def ForCausalLMLoss(
    logits,
    labels,
    vocab_size: int,
    num_items_in_batch: Optional[int] = None,
    ignore_index: int = -100,
    shift_labels: Optional[torch.Tensor] = None,
    **kwargs,
) -&gt; torch.Tensor:
    # Upcast to float if we need to compute the loss to avoid potential precision issues
    logits = logits.float()

    if shift_labels is None:
        # Shift so that tokens &lt; n predict n
        labels = nn.functional.pad(labels, (0, 1), value=ignore_index)
        shift_labels = labels[..., 1:].contiguous()

    # Flatten the tokens
    logits = logits.view(-1, vocab_size)
    shift_labels = shift_labels.view(-1)
    # Enable model parallelism
    shift_labels = shift_labels.to(logits.device)
    loss = fixed_cross_entropy(logits, shift_labels, num_items_in_batch, ignore_index, **kwargs)
    return loss
</code></pre>
</div>
</div>
<p>The key for understanding next-token prediction are the following lines:</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="cf" style="color: #003B4F;">if</span> shift_labels <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb16-2">    <span class="co" style="color: #5E5E5E;"># Shift so that tokens &lt; n predict n</span></span>
<span id="cb16-3">    labels <span class="op" style="color: #5E5E5E;">=</span> nn.functional.pad(labels, (<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), value<span class="op" style="color: #5E5E5E;">=</span>ignore_index)</span>
<span id="cb16-4">    shift_labels <span class="op" style="color: #5E5E5E;">=</span> labels[..., <span class="dv" style="color: #AD0000;">1</span>:].contiguous()</span></code></pre></div>
<p><code>nn.functional.pad</code> adds padding tokens to <code>labels</code>, specifically <code>0</code> to the left-most end of the last dimension and <code>1</code> padding token to the right-most end. The token it uses as padding is <code>ignore_index</code>, which is <code>-100</code>.</p>
<p>Next, it <em>shifts</em> the labels by 1 element to the left with <code>labels[..., 1:]</code>. I took a moment to realize what this meant: the <code>input_ids</code> and <code>labels</code>, in terms of position, are the same! To align the <code>labels</code> with the <code>logits</code> (which are already “shifted” in the sense that the first position in <code>logits</code> corresponds to the first predicted token: the second token in the context) we have to shift the <code>labels</code> by 1. To ensure that the final token in <code>input_ids</code> doesn’t predict anything, we pad <code>labels</code> with <code>-100</code>, the value ignored in the loss calculation.</p>
<p>As a reminder, if the context we’re training our model on is “the cat sat on the table”, each next token is predicted based on all previous tokens:</p>
<pre><code>the --&gt; cat
the cat --&gt; sat
the cat sat --&gt; on
the cat sat on --&gt; the
the cat sat on the --&gt; table</code></pre>
<p>This is a good time to return to our callback and analyze its output, but before I do, here’s a quick demo of the label shifting operation:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;">from</span> torch.nn.functional <span class="im" style="color: #00769E;">import</span> pad</span>
<span id="cb18-2"><span class="im" style="color: #00769E;">from</span> torch <span class="im" style="color: #00769E;">import</span> tensor</span></code></pre></div>
</div>
<div class="cell" data-outputid="71616038-3f2d-43e5-85f2-adcc9b90a766" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">labels <span class="op" style="color: #5E5E5E;">=</span> tensor([<span class="dv" style="color: #AD0000;">3</span>, <span class="dv" style="color: #AD0000;">6</span>, <span class="dv" style="color: #AD0000;">4</span>, <span class="dv" style="color: #AD0000;">2</span>])</span>
<span id="cb19-2">labels</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>tensor([3, 6, 4, 2])</code></pre>
</div>
</div>
<div class="cell" data-outputid="72be094b-fdd3-4317-fea6-53ce914d3b3d" data-execution_count="11">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">pad(labels, (<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>), value<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>tensor([   3,    6,    4,    2, -100])</code></pre>
</div>
</div>
<div class="cell" data-outputid="1184fe03-3d4d-41db-e07f-3d0cf1de0823" data-execution_count="12">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">pad(labels, (<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">0</span>), value<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>tensor([-100,    3,    6,    4,    2])</code></pre>
</div>
</div>
<div class="cell" data-outputid="5893adca-e559-46bd-c16c-c02c7a876779" data-execution_count="13">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">pad(labels, (<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">1</span>), value<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor([-100,    3,    6,    4,    2, -100])</code></pre>
</div>
</div>
<div class="cell" data-outputid="4d957eab-06ec-4c64-9c1e-54b4a13e8a59" data-execution_count="14">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">pad(labels, (<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>), value<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">100</span>)[...,<span class="dv" style="color: #AD0000;">1</span>:]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>tensor([   6,    4,    2, -100])</code></pre>
</div>
</div>
</section>
<section id="callback-logs" class="level2">
<h2 class="anchored" data-anchor-id="callback-logs">Callback Logs</h2>
<p>There were four key print statements of interest in my callback. I’ll display each and show their printed value:</p>
<ol type="1">
<li><code>print(f"Framework loss: {framework_loss:.6f}")</code></li>
</ol>
<pre><code>Framework loss: 1.067513</code></pre>
<ol start="2" type="1">
<li><code>print(f"Direct call to model.loss_function: {direct_loss.item():.6f}")</code></li>
</ol>
<pre><code>Direct call to model.loss_function: 1.067513</code></pre>
<ol start="3" type="1">
<li><code>print(input_ids.tolist())</code></li>
<li><code>print(labels.tolist())</code></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="input_ids (top) and labels (bottom) with the response highlighted in yellow"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-22-LossInspector/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption"><code>input_ids</code> (top) and <code>labels</code> (bottom) with the response highlighted in yellow</figcaption><p></p>
</figure>
</div>
<p>The first two print statements confirmed that I was calling <code>state.model.loss_function</code> correctly. It also confirmed that the loss function doesn’t take in the <code>input_ids</code>.</p>
<p>The last two print statements confirmed my understanding: positionally speaking, the <code>input_ids</code> and <code>labels</code> are the same. In <code>labels</code> the positions of <code>input_ids</code> tokens that contain the prompt (and EOS tokens) are replaced with <code>-100</code> and the tokens that represent the response are kept as is. For reference, here’s what <code>input_ids</code> looks like (both the prompt and the response) coming from an item of the MetaMathQA dataset (I have ommitted the hundreds of padding EOS tokens and formatted the text for clearer presentation):</p>
<pre><code>A box with a volume of 16 $\text{cm}^3$ can hold X paperclips.
How many paperclips could a box with a volume of 48 $\text{cm}^3$ hold?
If we know the answer to the above question is 150, what is the value of unknown variable X?

We are given that a box with a volume of 16 $\text{cm}^3$ can hold $X$ paperclips.
To find out how many paperclips a box with a volume of 48 $\text{cm}^3$ can hold, we can set up a proportion using the given information.
We can write the proportion as:
16 $\text{cm}^3$ / $X$ paperclips = 48 $\text{cm}^3$ / 150 paperclips
We can cross-multiply and solve for $X$:
16 * 150 = 48 * $X$
2400 = 48 * $X$
Dividing both sides by 48, we get:
$X$ = 50
The value of $X$ is 50.
The answer is: 50&lt;|endoftext|&gt;</code></pre>
<p><code>labels</code> has the prompt replaced with <code>-100</code>s, and the loss function then left-shifts the <code>labels</code> tokens by 1 spot to align with the logits for next-token prediction comparison.</p>
<p>Unsurprisingly, the <code>input_ids</code> and <code>labels</code> before the forward pass and after the loss calculation are the same:</p>
<pre><code>print("\n-------- matches before_forward values? --------")
print(f"input_ids: {torch.allclose(input_ids, self.input_ids)}")
print(f"labels: {torch.allclose(labels, self.labels)}")</code></pre>
<pre><code>-------- matches before_forward values? --------
input_ids: True
labels: True</code></pre>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>With this baseline established, I can use this callback everytime we have processed a new dataset for training, inspecting the tokens, decoded text and loss values to ensure that the training loop will run properly for next-token prediction, whether it’s a continued pretraining or instruction fine-tuning dataset! Working with LLM-Foundry is a steep learning curve but I am learning a TON.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-22-LossInspector/index.html</guid>
  <pubDate>Tue, 22 Apr 2025 07:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2025-04-22-LossInspector/1.png" medium="image" type="image/png" height="70" width="144"/>
</item>
<item>
  <title>Optimizing Matrix Multiplication Using Numba and Broadcasting</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I’ll solidy the matrix multiplication concepts taught in Lesson 11 of the fastai course (part 2). Most importantly, I want to make sure I understand the use of broadcasting to make the matmul operation 7000x faster!</p>
<p>Here’s a summary of run times for the five methods explored in this blog post:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Method</th>
<th style="text-align: center;">Images</th>
<th style="text-align: center;">Run Time (ms)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Python for-loops</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1090ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">Numba-compiled Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.555ms</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Python Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.47ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">PyTorch Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.22ms</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PyTorch Broadcasting</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.158ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">Numba-compiled Broadcasting</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.0936ms</td>
</tr>
</tbody>
</table>
<p>Here’s my video walkthrough of the code in this notebook:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-t8b7Otfmjo?si=XxML2gDu0u2H9P0g" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>
</section>
<section id="load-the-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-data">Load the Data</h2>
<p>We’ll use the MNIST dataset for this exercise.</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> torch <span class="im" style="color: #00769E;">import</span> tensor</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> pathlib <span class="im" style="color: #00769E;">import</span> Path</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">import</span> pickle, gzip, math, os, time, shutil, matplotlib <span class="im" style="color: #00769E;">as</span> mpl, matplotlib.pyplot <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> urllib.request <span class="im" style="color: #00769E;">import</span> urlretrieve</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span></code></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">MNIST_URL<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'https://github.com/mnielsen/neural-networks-and-deep-learning/blob/master/data/mnist.pkl.gz?raw=true'</span></span>
<span id="cb2-2">path_data <span class="op" style="color: #5E5E5E;">=</span> Path(<span class="st" style="color: #20794D;">'data'</span>)</span>
<span id="cb2-3">path_data.mkdir(exist_ok<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb2-4">path_gz <span class="op" style="color: #5E5E5E;">=</span> path_data<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'mnist.pkl.gz'</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> path_gz.exists(): urlretrieve(MNIST_URL, path_gz)</span>
<span id="cb3-2"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(path_gz, <span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> f: ((x_train, y_train), (x_valid, y_valid), _) <span class="op" style="color: #5E5E5E;">=</span> pickle.load(f, encoding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'latin-1'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="314ea9fa-e0ee-4889-b82b-2fa6eb76da22" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="op" style="color: #5E5E5E;">!</span>ls <span class="op" style="color: #5E5E5E;">-</span>l data</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>total 16656
-rw-r--r-- 1 root root 17051982 Apr 21 22:56 mnist.pkl.gz</code></pre>
</div>
</div>
<div class="cell" data-outputid="35f01f0b-da44-4f57-ecd7-0735437dd72e" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">x_train,y_train,x_valid,y_valid <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">map</span>(tensor, (x_train,y_train,x_valid,y_valid))</span>
<span id="cb6-2">x_train.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>torch.Size([50000, 784])</code></pre>
</div>
</div>
<div class="cell" data-outputid="b485d5c3-2095-4a56-87d4-1aa1d0932eed" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">imgs <span class="op" style="color: #5E5E5E;">=</span> x_train.reshape((<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">28</span>,<span class="dv" style="color: #AD0000;">28</span>))</span>
<span id="cb8-2">imgs.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>torch.Size([50000, 28, 28])</code></pre>
</div>
</div>
<div class="cell" data-outputid="2bf4f561-0371-41b3-fae9-e322e1b8d812" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">plt.imshow(imgs[<span class="dv" style="color: #AD0000;">0</span>])<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-8-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>For our weights, we’ll create a set of random floats with shape 784 (rows) x 10 (columns). In an applied sense, these 10 outputs would be the logits associated with the ten possible digits (0-9) for each 28x28 image.</p>
<div class="cell" data-outputid="1f22c0e7-a087-4b0b-b0d1-dd41e8940ecb" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">torch.manual_seed(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb11-2">weights <span class="op" style="color: #5E5E5E;">=</span> torch.randn(<span class="dv" style="color: #AD0000;">784</span>, <span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb11-3">weights.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>torch.Size([784, 10])</code></pre>
</div>
</div>
<p>For our inputs (which get multiplied by our weights) we’ll use the first 5 digits (28x28 images) from the validation set. These inputs and our weights are the two matrices we want to multiply!</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">m1 <span class="op" style="color: #5E5E5E;">=</span> x_valid[:<span class="dv" style="color: #AD0000;">5</span>]</span>
<span id="cb13-2">m2 <span class="op" style="color: #5E5E5E;">=</span> weights</span></code></pre></div>
</div>
<div class="cell" data-outputid="212a05d8-26bd-4556-860b-257409a0fee5" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">m1.shape,m2.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(torch.Size([5, 784]), torch.Size([784, 10]))</code></pre>
</div>
</div>
</section>
<section id="initial-solution-python-for-loops" class="level2">
<h2 class="anchored" data-anchor-id="initial-solution-python-for-loops">Initial Solution: Python for-Loops</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" title="Naive implementation of matrix multiplication" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Naive implementation of matrix multiplication</figcaption><p></p>
</figure>
</div>
<p>For our first iteration, we’ll do a nested for-loop—the most naive implementation of matrix multiplication in this exercise.</p>
<p>We iterate through the 5 rows of our input matrix (images). For each row, we iterate through each column of our weights matrix. For each of the 784 elements in that row/column (i,j) combination, we take the dot product and store it in the output matrix. 5 images x 10 outputs x 784 elements = 39200 total items operated on.</p>
<div class="cell" data-outputid="cb867e65-bd14-4756-a67d-532d55b3abd1" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="dv" style="color: #AD0000;">5</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">784</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>39200</code></pre>
</div>
</div>
<div class="cell" data-outputid="60c72dc6-52ab-412f-a330-aa63684b44da" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">ar,ac <span class="op" style="color: #5E5E5E;">=</span> m1.shape <span class="co" style="color: #5E5E5E;"># n_rows * n_cols</span></span>
<span id="cb18-2">br,bc <span class="op" style="color: #5E5E5E;">=</span> m2.shape</span>
<span id="cb18-3">(ar,ac),(br,bc)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>((5, 784), (784, 10))</code></pre>
</div>
</div>
<div class="cell" data-outputid="8425c8be-f9b5-40d5-f2d0-d7d301d18c05" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">t1 <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc) <span class="co" style="color: #5E5E5E;"># resultant tensor</span></span>
<span id="cb20-2">t1.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>torch.Size([5, 10])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar): <span class="co" style="color: #5E5E5E;">#5</span></span>
<span id="cb22-2">    <span class="cf" style="color: #003B4F;">for</span> j <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(bc): <span class="co" style="color: #5E5E5E;"># 10</span></span>
<span id="cb22-3">        <span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ac): <span class="co" style="color: #5E5E5E;"># 784</span></span>
<span id="cb22-4">            t1[i,j] <span class="op" style="color: #5E5E5E;">+=</span> m1[i,k] <span class="op" style="color: #5E5E5E;">*</span> m2[k,j]</span></code></pre></div>
</div>
<p>The resulting matrix has 5 rows (1 for each image) and 10 columns (one for each “neuron” in our weights matrix).</p>
<div class="cell" data-outputid="237f3596-1c48-43c0-bb07-bae65246ac40" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">torch.set_printoptions(precision<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, linewidth<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">140</span>, sci_mode<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb23-2">t1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>tensor([[-10.94,  -0.68,  -7.00,  -4.01,  -2.09,  -3.36,   3.91,  -3.44, -11.47,  -2.12],
        [ 14.54,   6.00,   2.89,  -4.08,   6.59, -14.74,  -9.28,   2.16, -15.28,  -2.68],
        [  2.22,  -3.22,  -4.80,  -6.05,  14.17,  -8.98,  -4.79,  -5.44, -20.68,  13.57],
        [ -6.71,   8.90,  -7.46,  -7.90,   2.70,  -4.73, -11.03, -12.98,  -6.44,   3.64],
        [ -2.44,  -6.40,  -2.40,  -9.04,  11.18,  -5.77,  -8.92,  -3.79,  -8.98,   5.28]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb25-2">np.set_printoptions(precision<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, linewidth<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">140</span>)</span></code></pre></div>
</div>
<p>Wrapping this code into a function we can time it.</p>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb26-2">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb26-3">    c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc)</span>
<span id="cb26-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar):</span>
<span id="cb26-5">        <span class="cf" style="color: #003B4F;">for</span> j <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(bc):</span>
<span id="cb26-6">            <span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ac): c[i,j] <span class="op" style="color: #5E5E5E;">+=</span> a[i,k] <span class="op" style="color: #5E5E5E;">*</span> b[k,j]</span>
<span id="cb26-7">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-outputid="20110470-6efe-4296-fe08-6e37fb72d9aa" data-execution_count="137">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="op" style="color: #5E5E5E;">%</span>time _<span class="op" style="color: #5E5E5E;">=</span>matmul(m1, m2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.09 s, sys: 544 µs, total: 1.09 s
Wall time: 1.09 s</code></pre>
</div>
</div>
<p>It takes a whopping 1.09 seconds to perform this matrix multiplication for 5 images! Let’s optimize this with numba.</p>
</section>
<section id="compiling-the-dot-product-with-numba" class="level2">
<h2 class="anchored" data-anchor-id="compiling-the-dot-product-with-numba">Compiling the Dot Product with Numba</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="2.png" class="lightbox" title="Matrix multiplication using a numba-compiled dot product operation" data-gallery="quarto-lightbox-gallery-3"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/2.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Matrix multiplication using a numba-compiled dot product operation</figcaption><p></p>
</figure>
</div>
<p>To reduce the number of python for-loops, we write the dot product (between the two 784-element vectors) in numba:</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;">from</span> numba <span class="im" style="color: #00769E;">import</span> njit</span></code></pre></div>
</div>
<div class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="at" style="color: #657422;">@njit</span></span>
<span id="cb30-2"><span class="kw" style="color: #003B4F;">def</span> dot(a,b):</span>
<span id="cb30-3">    res <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.</span></span>
<span id="cb30-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(a)): res<span class="op" style="color: #5E5E5E;">+=</span>a[i]<span class="op" style="color: #5E5E5E;">*</span>b[i]</span>
<span id="cb30-5">    <span class="cf" style="color: #003B4F;">return</span> res</span></code></pre></div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;">from</span> numpy <span class="im" style="color: #00769E;">import</span> array</span></code></pre></div>
</div>
<p>The first run of <code>dot</code> takes longer as it includes the compile time:</p>
<div class="cell" data-outputid="61b070bc-e64a-4931-eb9a-16dc74db549c" data-execution_count="141">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="op" style="color: #5E5E5E;">%</span>time dot(array([<span class="fl" style="color: #AD0000;">1.</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>]),array([<span class="fl" style="color: #AD0000;">2.</span>,<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">4</span>]))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 123 ms, sys: 0 ns, total: 123 ms
Wall time: 124 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>20.0</code></pre>
</div>
</div>
<p>The second run is 250x times faster.</p>
<div class="cell" data-outputid="8b7c64a0-582c-4b7f-ba4c-fae8fbcf9c26" data-execution_count="143">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="fl" style="color: #AD0000;">0.124</span><span class="op" style="color: #5E5E5E;">/</span><span class="fl" style="color: #AD0000;">0.000489</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>253.5787321063395</code></pre>
</div>
</div>
<div class="cell" data-outputid="30d7d3a4-c845-477c-9623-675a383c6fbb" data-execution_count="142">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="op" style="color: #5E5E5E;">%</span>time dot(array([<span class="fl" style="color: #AD0000;">1.</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>]),array([<span class="fl" style="color: #AD0000;">2.</span>,<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">4</span>]))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 40 µs, sys: 5 µs, total: 45 µs
Wall time: 48.9 µs</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>20.0</code></pre>
</div>
</div>
<p>We replace the third for-loop with our numba <code>dot</code> function:</p>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb40-2">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb40-3">    c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc)</span>
<span id="cb40-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar):</span>
<span id="cb40-5">        <span class="cf" style="color: #003B4F;">for</span> j <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(bc): c[i,j] <span class="op" style="color: #5E5E5E;">=</span> dot(a[i,:], b[:,j])</span>
<span id="cb40-6">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">m1a,m2a <span class="op" style="color: #5E5E5E;">=</span> m1.numpy(),m2.numpy()</span></code></pre></div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="im" style="color: #00769E;">from</span> fastcore.test <span class="im" style="color: #00769E;">import</span> <span class="op" style="color: #5E5E5E;">*</span></span></code></pre></div>
</div>
<p>We test that it yields the same result:</p>
<div class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">test_close(t1,matmul(m1a, m2a))</span></code></pre></div>
</div>
<div class="cell" data-outputid="b9655c05-775a-425e-8921-91505c5a4d48" data-execution_count="151">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">50</span> matmul(m1a,m2a)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>555 µs ± 14.5 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)</code></pre>
</div>
</div>
<p>Our numba-compiled <code>dot</code> operation makes our matrix multiplication 2000x faster!</p>
<div class="cell" data-outputid="5d850c83-dc19-43fb-a238-e613ef13bfc8" data-execution_count="152">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="fl" style="color: #AD0000;">1.09</span><span class="op" style="color: #5E5E5E;">/</span><span class="fl" style="color: #AD0000;">555e-6</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>1963.963963963964</code></pre>
</div>
</div>
<p>The same operation can be done in Python:</p>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb48-2">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb48-3">    c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc)</span>
<span id="cb48-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar):</span>
<span id="cb48-5">        <span class="cf" style="color: #003B4F;">for</span> j <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(bc): c[i,j] <span class="op" style="color: #5E5E5E;">=</span> (a[i,:] <span class="op" style="color: #5E5E5E;">*</span> b[:,j]).<span class="bu" style="color: null;">sum</span>()</span>
<span id="cb48-6">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">test_close(t1,matmul(m1, m2))</span></code></pre></div>
</div>
<p>But it’s three times slower than numba:</p>
<div class="cell" data-outputid="e9b4fe5b-ca19-4d9c-ab52-6b6e5b7f5cc9" data-execution_count="166">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">50</span> _<span class="op" style="color: #5E5E5E;">=</span>matmul(m1, m2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.47 ms ± 32.3 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)</code></pre>
</div>
</div>
<p>Using <code>torch.dot</code> is a smidge faster than Python:</p>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb52-2">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb52-3">    c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc)</span>
<span id="cb52-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar):</span>
<span id="cb52-5">        <span class="cf" style="color: #003B4F;">for</span> j <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(bc): c[i,j] <span class="op" style="color: #5E5E5E;">=</span> torch.dot(a[i,:], b[:,j])</span>
<span id="cb52-6">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">test_close(t1,matmul(m1, m2))</span></code></pre></div>
</div>
<div class="cell" data-outputid="60fdda95-41de-4628-b901-bd94f407e572" data-execution_count="169">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">50</span> _<span class="op" style="color: #5E5E5E;">=</span>matmul(m1, m2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.22 ms ± 39.1 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)</code></pre>
</div>
</div>
</section>
<section id="faster-use-broadcasting" class="level2">
<h2 class="anchored" data-anchor-id="faster-use-broadcasting">Faster: Use Broadcasting!</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="3.png" class="lightbox" title="Using broadcasting to compute all image/weight dot products simultaneously!" data-gallery="quarto-lightbox-gallery-4"><img src="https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/3.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Using broadcasting to compute all image/weight dot products simultaneously!</figcaption><p></p>
</figure>
</div>
<p>Broadcasting effectively expands the smaller matrix to match the size of the larger one so that element-wise operations can take place.</p>
<p>Suppose we wanted to take the dot product between the first image and all 10 columns of weights. Adding a <code>None</code> during indexing adds a unit axis at that position:</p>
<div class="cell" data-outputid="2676c4cc-c732-4947-e7d1-851a3b0fadf1" data-execution_count="21">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">m1[<span class="dv" style="color: #AD0000;">0</span>,:].shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>torch.Size([784])</code></pre>
</div>
</div>
<div class="cell" data-outputid="bc6ed9d8-f7cc-48b8-b6e5-a0e3e5edcf7b" data-execution_count="22">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">m1[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>].shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>torch.Size([784, 1])</code></pre>
</div>
</div>
<div class="cell" data-outputid="8c97f11e-a361-4495-dc0e-1b02a7a41a11" data-execution_count="23">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">m2.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>torch.Size([784, 10])</code></pre>
</div>
</div>
<p>Multiplying (element-wise) <code>m1[0, :, None]</code> with <code>m2</code> <em>broadcasts</em> <code>m1[0, :, None]</code> across the 10 columns of <code>m2</code>. In other words, each row of <code>m1[0]</code> is virtually copied over 10 times, one for each column of <code>m2</code>.</p>
<div class="cell" data-outputid="851cd77c-a7c6-47c4-b5ab-4cf31b2f3992" data-execution_count="25">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">(m1[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> m2).shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>torch.Size([784, 10])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ff7e2357-7bd5-4fcc-b145-209686989ebb" data-execution_count="36">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">m1.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>torch.Size([5, 784])</code></pre>
</div>
</div>
<div class="cell" data-outputid="6d3005bf-b2b3-47df-ed78-974f090d94e6" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>tensor([[0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.]])</code></pre>
</div>
</div>
<p>Here’s a smaller example. <code>a</code> has 5 rows, “images”, each with 4 pixels.</p>
<div class="cell" data-outputid="a1c16304-fd94-4b01-e12c-dfe5d97511b6" data-execution_count="37">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">a <span class="op" style="color: #5E5E5E;">=</span> torch.randint(low<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>, high<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5</span>, size<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">5</span>,<span class="dv" style="color: #AD0000;">4</span>))</span>
<span id="cb68-2">a</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>tensor([[1, 4, 3, 4],
        [1, 4, 1, 3],
        [3, 2, 2, 4],
        [3, 1, 3, 1],
        [2, 3, 1, 1]])</code></pre>
</div>
</div>
<p>We pluck out the first “image” with <code>0</code>, then add a unit axis at the end with <code>None</code> to make it “broadcastable”</p>
<div class="cell" data-outputid="917a5f84-282b-4c51-bf82-4860c08cc859" data-execution_count="38">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">a[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>tensor([[1],
        [4],
        [3],
        [4]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="19287d6f-36f8-42e6-8136-36cb6881f1ff" data-execution_count="43">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">a.shape, a[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>].shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>(torch.Size([5, 4]), torch.Size([4, 1]))</code></pre>
</div>
</div>
<p>Suppose we have weights <code>w</code> with 4 rows, each 10 columns wide.</p>
<div class="cell" data-outputid="2370ca54-9190-4415-d920-171c9c705707" data-execution_count="47">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1">w <span class="op" style="color: #5E5E5E;">=</span> torch.randint(low<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>, high<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5</span>, size<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">4</span>, <span class="dv" style="color: #AD0000;">10</span>))</span>
<span id="cb74-2">w</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>tensor([[2, 2, 1, 1, 4, 3, 4, 2, 4, 3],
        [1, 2, 4, 2, 4, 1, 3, 1, 2, 1],
        [4, 3, 4, 3, 1, 2, 1, 3, 3, 4],
        [1, 3, 3, 3, 3, 1, 1, 1, 4, 4]])</code></pre>
</div>
</div>
<p>We broadcast the 4-vector <code>a[0, :, None]</code> across all 10 4-vectors in <code>w</code>:</p>
<div class="cell" data-outputid="73442351-22b9-46eb-cde5-d4ee374d2679" data-execution_count="48">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">a[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> w</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>tensor([[ 2,  2,  1,  1,  4,  3,  4,  2,  4,  3],
        [ 4,  8, 16,  8, 16,  4, 12,  4,  8,  4],
        [12,  9, 12,  9,  3,  6,  3,  9,  9, 12],
        [ 4, 12, 12, 12, 12,  4,  4,  4, 16, 16]])</code></pre>
</div>
</div>
<p>Then take the sum down the columns (along the row axis) to get the 10 output “activations” for this “image”:</p>
<div class="cell" data-outputid="0795be2f-d5b5-42a7-91f8-13d352fc7a46" data-execution_count="49">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">(a[<span class="dv" style="color: #AD0000;">0</span>, :, <span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> w).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>tensor([22, 31, 41, 30, 35, 17, 23, 19, 37, 35])</code></pre>
</div>
</div>
<p>Looking at the first value of <code>22</code>, it comes from the dot product between the first “image” in <code>a</code> and the first row of weights (the “neuron”) in <code>w</code>:</p>
<p>22 = 1*2 + 4*1 + 3*4 + 4*1 = 2 + 4 + 12 + 4</p>
<p>In this way, we have the dot product between the first image and all 10 columns. This is the first row of the matrix product between <code>a</code> and <code>w</code>.</p>
<p>We can then loop over the images, broadcasting it across the weight matrix, summing down the columns to get each subsequent row of our resultant matrix product:</p>
<div class="cell" data-outputid="db6f46a2-bfa0-48a7-b336-5f5c1332f01f" data-execution_count="51">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1">(ar,ac),(wr,wc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,w.shape</span>
<span id="cb80-2">ar,ac,wr,wc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(5, 4, 4, 10)</code></pre>
</div>
</div>
<div class="cell" data-outputid="2b8330a8-6dbd-4092-8f5f-6aaeaf7ccdfb" data-execution_count="52">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1">c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, wc)</span>
<span id="cb82-2">c.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>torch.Size([5, 10])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ab5b28b8-b7be-4d85-da36-730fd8943ca4" data-execution_count="53">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar):</span>
<span id="cb84-2">    c[i] <span class="op" style="color: #5E5E5E;">=</span> (a[i, :, <span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> w).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb84-3">c</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>tensor([[22., 31., 41., 30., 35., 17., 23., 19., 37., 35.],
        [13., 22., 30., 21., 30., 12., 20., 12., 27., 23.],
        [20., 28., 31., 25., 34., 19., 24., 18., 38., 35.],
        [20., 20., 22., 17., 22., 17., 19., 17., 27., 26.],
        [12., 16., 21., 14., 24., 12., 19., 11., 21., 17.]])</code></pre>
</div>
</div>
<p>In this way, we have performed matrix multiplication by taking the dot product of each row/column using broadcasting! Returning to our original dataset:</p>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb86-2">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb86-3">    c <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(ar, bc)</span>
<span id="cb86-4">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar): c[i]  <span class="op" style="color: #5E5E5E;">=</span> (a[i,:,<span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> b).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb86-5">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">test_close(t1,matmul(m1, m2))</span></code></pre></div>
</div>
<div class="cell" data-outputid="dcb5e610-3ea9-4af8-83bf-c0390020cd2c" data-execution_count="58">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">50</span> _<span class="op" style="color: #5E5E5E;">=</span>matmul(m1, m2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>158 µs ± 15.1 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)</code></pre>
</div>
</div>
<p>This gives us a 8x speedup from the numba-compiled dot product (1.22ms –&gt; 0.158 ms).</p>
<p>Now, instead of 5 images we can perform matmul with all 50k images in our dataset.</p>
<div class="cell" data-outputid="3877da3f-6cfe-433f-f7bc-6e70d2b80678" data-execution_count="59">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1">tr <span class="op" style="color: #5E5E5E;">=</span> matmul(x_train, weights)</span>
<span id="cb90-2">tr</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>tensor([[  0.96,  -2.96,  -2.11,  ..., -15.09, -17.69,   0.60],
        [  6.89,  -0.34,   0.79,  ..., -17.13, -25.36,  16.23],
        [-10.18,   7.38,   4.13,  ...,  -6.73,  -6.79,  -1.58],
        ...,
        [  7.40,   7.64,  -3.50,  ...,  -1.02, -16.22,   2.07],
        [  3.25,   9.52,  -9.37,  ...,   2.98, -19.58,  -1.96],
        [ 15.70,   4.12,  -5.62,  ...,   8.08, -12.21,   0.42]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="a96bae33-3c9c-4380-c4da-7df3c44e1cb3" data-execution_count="60">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1">tr.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>torch.Size([50000, 10])</code></pre>
</div>
</div>
<p>This operation now takes less than two seconds!</p>
<div class="cell" data-outputid="9b5bb005-9613-4419-dfc5-af1c2b30c464" data-execution_count="63">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="op" style="color: #5E5E5E;">%</span>time _<span class="op" style="color: #5E5E5E;">=</span>matmul(x_train, weights)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.62 s, sys: 0 ns, total: 1.62 s
Wall time: 1.63 s</code></pre>
</div>
</div>
</section>
<section id="fastest-numba-broadcasting" class="level2">
<h2 class="anchored" data-anchor-id="fastest-numba-broadcasting">Fastest: Numba Broadcasting</h2>
<div class="cell" data-outputid="4af16216-46bd-41a9-a893-aa5229bb6d54" data-execution_count="69">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1">m1a.shape, m2a.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>((5, 784), (784, 10))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><span class="at" style="color: #657422;">@njit</span></span>
<span id="cb98-2"><span class="kw" style="color: #003B4F;">def</span> matmul(a,b):</span>
<span id="cb98-3">    (ar,ac),(br,bc) <span class="op" style="color: #5E5E5E;">=</span> a.shape,b.shape</span>
<span id="cb98-4">    c <span class="op" style="color: #5E5E5E;">=</span> np.zeros((ar, bc))</span>
<span id="cb98-5">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(ar): c[i] <span class="op" style="color: #5E5E5E;">=</span> (a[i,:,<span class="va" style="color: #111111;">None</span>] <span class="op" style="color: #5E5E5E;">*</span> b).<span class="bu" style="color: null;">sum</span>(axis<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb98-6">    <span class="cf" style="color: #003B4F;">return</span> c</span></code></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">test_close(t1,matmul(m1a, m2a))</span></code></pre></div>
</div>
<div class="cell" data-outputid="13b4fff2-ef89-4c34-9bc9-0d77963e5334" data-execution_count="86">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">50</span> _<span class="op" style="color: #5E5E5E;">=</span>matmul(m1a, m2a)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>93.6 µs ± 9.26 µs per loop (mean ± std. dev. of 7 runs, 50 loops each)</code></pre>
</div>
</div>
<p>We can now perform matrix multiplication for all 50_000 images in less time than we could for 5 images using nested for-loops. AMAZING!</p>
<div class="cell" data-outputid="6f076764-93d6-41d6-a7bf-b82f5ee271a2" data-execution_count="91">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><span class="op" style="color: #5E5E5E;">%</span>time _<span class="op" style="color: #5E5E5E;">=</span>matmul(x_train.numpy(), weights.numpy())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 885 ms, sys: 0 ns, total: 885 ms
Wall time: 881 ms</code></pre>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I’ve been busy with other ML projects over the past few months but I’m so glad I have gotten back in the driver’s seat for fastai course part 2! The videos, content, and potential projects/exercises that spring forth are absolutely delicious. Using relatively simple building blocks, I was able to understand matrix multiplication through Python loops, numba dot product, and Yorick-inspired PyTorch broadcasting. Creating the visuals (in excalidraw) was a <em>must</em> because I really needed to cement these concepts in my mind, as encouraged by Jeremy in the video.</p>
<p>Here’s the summary again of run times for each of the methods shown above:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Method</th>
<th style="text-align: center;">Images</th>
<th style="text-align: center;">Run Time (ms)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Python for-loops</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1090ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">Numba-compiled Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.555ms</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Python Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.47ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">PyTorch Dot Product</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.22ms</td>
</tr>
<tr class="odd">
<td style="text-align: center;">PyTorch Broadcasting</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.158ms</td>
</tr>
<tr class="even">
<td style="text-align: center;">Numba-compiled Broadcasting</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.0936ms</td>
</tr>
</tbody>
</table>
<p>Using numba-compiled broadcasting, the 5-image matrix multiplication with weights experienced a 12000x speedup compared to the naive Python nested for-loop implementation! Amazing!!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/index.html</guid>
  <pubDate>Mon, 21 Apr 2025 07:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2025-04-21-Matrix-Multiplication/1.png" medium="image" type="image/png" height="49" width="144"/>
</item>
<item>
  <title>Logging Data Types for Activations, Gradients, Weights, Optimizer States and Loss during Training with LLM-Foundry</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-02-Composer-Callback-Logging-dtypes/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In a <a href="https://vishalbakshi.github.io/blog/posts/2025-03-30-Composer-Callback/">previous blog post</a> I shared my first couple of iterations of custom Composer callback used to log data types of different entities (activations, gradients, weights, optimizer states, and loss) during training with LLM-Foundry. In this blog post I’ll share my final callback iteration’s code, some lessons I learned along the way (i.e.&nbsp;LLaMA’s self-attention module doesn’t have positional arguments!) and analyze the logging results to observe entity data types throughout the training loop.</p>
</section>
<section id="composer-callback-walkthrough" class="level2">
<h2 class="anchored" data-anchor-id="composer-callback-walkthrough">Composer Callback Walkthrough</h2>
<p>The data types of entities (activations, gradients, weights, loss, and optimizer states) are logged during training with a custom Composer callback <code>DtypeLogger</code> passed to the Composer <code>Trainer</code>. This callback was built up and tested event-by-event using Claude. There is one event handler in the callback for each Composer event from <code>&lt;FIT_START&gt;</code> to <code>&lt;BATCH_END&gt;</code>:</p>
<pre><code># &lt;INIT&gt;
# &lt;BEFORE_LOAD&gt;
# &lt;AFTER_LOAD&gt;
# &lt;FIT_START&gt;
for epoch in range(NUM_EPOCHS):
    # &lt;EPOCH_START&gt;
    while True:
        # &lt;BEFORE_DATALOADER&gt;
        batch = next(dataloader)
        if batch is None:
            break
        inputs, targets = batch
        # &lt;AFTER_DATALOADER&gt;

        # &lt;BATCH_START&gt;

        # &lt;BEFORE_FORWARD&gt;
        outputs = model.forward(inputs)
        # &lt;AFTER_FORWARD&gt;

        # &lt;BEFORE_LOSS&gt;
        loss = model.loss(outputs, targets)
        # &lt;AFTER_LOSS&gt;

        # &lt;BEFORE_BACKWARD&gt;
        loss.backward()
        # &lt;AFTER_BACKWARD&gt;

        optimizer.step()
        optimizer.zero_grad()

        # &lt;BATCH_END&gt;
    # &lt;EPOCH_END&gt;</code></pre>
<p>There are four explicit logging functions:</p>
<ul>
<li><code>_log_model_weight_dtypes</code></li>
<li><code>_log_gradient_dtypes</code></li>
<li><code>_log_optimizer_state_dtypes</code></li>
<li><code>_log_loss_dtype</code></li>
</ul>
<p>Additionally, activations are logged using <code>register_forward_hook</code> for all modules except self-attention (more on that below). Self-attention inputs are logged using a monkey-patched forward pass.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;">class</span> DtypeLogger(Callback):</span>
<span id="cb2-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, save_path<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"/model-checkpoints/dtype_tracking"</span>, log_interval<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb2-3">        <span class="va" style="color: #111111;">self</span>.save_path <span class="op" style="color: #5E5E5E;">=</span> Path(save_path)</span>
<span id="cb2-4">        <span class="va" style="color: #111111;">self</span>.dtype_logs <span class="op" style="color: #5E5E5E;">=</span> {<span class="st" style="color: #20794D;">'log'</span>: {}}</span>
<span id="cb2-5">        <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">=</span> log_interval</span>
<span id="cb2-6">        <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb2-7">        </span>
<span id="cb2-8">    <span class="kw" style="color: #003B4F;">def</span> fit_start(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-9">        <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"fit_start"</span>)</span>
<span id="cb2-10">        <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-11">        </span>
<span id="cb2-12">    <span class="kw" style="color: #003B4F;">def</span> epoch_start(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-13">        <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"epoch_start"</span>)</span>
<span id="cb2-14">        <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-15">    </span>
<span id="cb2-16">    <span class="kw" style="color: #003B4F;">def</span> before_dataloader(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-17">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-18">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"before_dataloader"</span>)</span>
<span id="cb2-19">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-20">            </span>
<span id="cb2-21">    <span class="kw" style="color: #003B4F;">def</span> after_dataloader(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-22">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-23">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"after_dataloader"</span>)</span>
<span id="cb2-24">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-25">            </span>
<span id="cb2-26">    <span class="kw" style="color: #003B4F;">def</span> batch_start(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-27">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-28">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"batch_start"</span>)</span>
<span id="cb2-29">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-30">            </span>
<span id="cb2-31">    <span class="kw" style="color: #003B4F;">def</span> before_forward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-32">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-33">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"before_forward"</span>)</span>
<span id="cb2-34">            </span>
<span id="cb2-35">            <span class="co" style="color: #5E5E5E;"># Clear old hooks</span></span>
<span id="cb2-36">            <span class="cf" style="color: #003B4F;">for</span> hook <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.hooks:</span>
<span id="cb2-37">                hook.remove()</span>
<span id="cb2-38">            <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb2-39">            </span>
<span id="cb2-40">            <span class="co" style="color: #5E5E5E;"># Get the model</span></span>
<span id="cb2-41">            model <span class="op" style="color: #5E5E5E;">=</span> state.model.model.base_model.model</span>
<span id="cb2-42">            transformer_model <span class="op" style="color: #5E5E5E;">=</span> model.model  <span class="co" style="color: #5E5E5E;"># This is the transformer part</span></span>
<span id="cb2-43">            batch_id <span class="op" style="color: #5E5E5E;">=</span> state.timestamp.batch.value</span>
<span id="cb2-44">            </span>
<span id="cb2-45">            <span class="co" style="color: #5E5E5E;"># Store original forward methods to restore later</span></span>
<span id="cb2-46">            <span class="va" style="color: #111111;">self</span>.original_forward_methods <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb2-47">            </span>
<span id="cb2-48">            <span class="kw" style="color: #003B4F;">def</span> hook_fn(layer_name, module_name):</span>
<span id="cb2-49">                <span class="kw" style="color: #003B4F;">def</span> _hook(module, inputs, outputs):</span>
<span id="cb2-50">                    <span class="co" style="color: #5E5E5E;"># Log input activation dtype</span></span>
<span id="cb2-51">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(inputs, <span class="bu" style="color: null;">tuple</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(inputs) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-52">                        <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"forward:</span><span class="sc" style="color: #5E5E5E;">{</span>module_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>layer_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:activation_input"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(inputs[<span class="dv" style="color: #AD0000;">0</span>].dtype)</span>
<span id="cb2-53">                    </span>
<span id="cb2-54">                    <span class="co" style="color: #5E5E5E;"># Log output activation dtype</span></span>
<span id="cb2-55">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(outputs, torch.Tensor):</span>
<span id="cb2-56">                        <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"forward:</span><span class="sc" style="color: #5E5E5E;">{</span>module_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>layer_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:activation_output"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(outputs.dtype)</span>
<span id="cb2-57">                    <span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(outputs, <span class="bu" style="color: null;">tuple</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(outputs) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-58">                        <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"forward:</span><span class="sc" style="color: #5E5E5E;">{</span>module_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>layer_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:activation_output"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(outputs[<span class="dv" style="color: #AD0000;">0</span>].dtype)</span>
<span id="cb2-59">                <span class="cf" style="color: #003B4F;">return</span> _hook</span>
<span id="cb2-60">            </span>
<span id="cb2-61">            <span class="co" style="color: #5E5E5E;"># Monkey patch self-attention modules</span></span>
<span id="cb2-62">            <span class="cf" style="color: #003B4F;">for</span> layer_idx, layer <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(transformer_model.layers):</span>
<span id="cb2-63">                <span class="co" style="color: #5E5E5E;"># Store the original forward method</span></span>
<span id="cb2-64">                original_forward <span class="op" style="color: #5E5E5E;">=</span> layer.self_attn.forward</span>
<span id="cb2-65">                <span class="va" style="color: #111111;">self</span>.original_forward_methods[layer_idx] <span class="op" style="color: #5E5E5E;">=</span> original_forward</span>
<span id="cb2-66">                </span>
<span id="cb2-67">                <span class="co" style="color: #5E5E5E;"># Define a closure to capture the current layer_idx</span></span>
<span id="cb2-68">                <span class="kw" style="color: #003B4F;">def</span> make_patched_forward(layer_idx, orig_forward):</span>
<span id="cb2-69">                    <span class="kw" style="color: #003B4F;">def</span> patched_forward(self_attn, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs):</span>
<span id="cb2-70">                        <span class="co" style="color: #5E5E5E;"># Log the hidden_states dtype</span></span>
<span id="cb2-71">                        <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'hidden_states'</span> <span class="kw" style="color: #003B4F;">in</span> kwargs <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">hasattr</span>(kwargs[<span class="st" style="color: #20794D;">'hidden_states'</span>], <span class="st" style="color: #20794D;">'dtype'</span>):</span>
<span id="cb2-72">                            <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"forward:self_attn:layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:activation_input"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(kwargs[<span class="st" style="color: #20794D;">'hidden_states'</span>].dtype)</span>
<span id="cb2-73">                        </span>
<span id="cb2-74">                        <span class="co" style="color: #5E5E5E;"># Call the original method as a bound method</span></span>
<span id="cb2-75">                        <span class="co" style="color: #5E5E5E;"># This ensures 'self_attn' is correctly passed as 'self'</span></span>
<span id="cb2-76">                        <span class="cf" style="color: #003B4F;">return</span> orig_forward.<span class="fu" style="color: #4758AB;">__get__</span>(self_attn, <span class="bu" style="color: null;">type</span>(self_attn))(<span class="op" style="color: #5E5E5E;">**</span>kwargs)</span>
<span id="cb2-77">                    </span>
<span id="cb2-78">                    <span class="cf" style="color: #003B4F;">return</span> patched_forward</span>
<span id="cb2-79">                </span>
<span id="cb2-80">                <span class="co" style="color: #5E5E5E;"># Replace the forward method</span></span>
<span id="cb2-81">                layer.self_attn.forward <span class="op" style="color: #5E5E5E;">=</span> make_patched_forward(layer_idx, original_forward).<span class="fu" style="color: #4758AB;">__get__</span>(layer.self_attn, <span class="bu" style="color: null;">type</span>(layer.self_attn))</span>
<span id="cb2-82">            </span>
<span id="cb2-83">            <span class="co" style="color: #5E5E5E;"># Register hook for lm_head</span></span>
<span id="cb2-84">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(model, <span class="st" style="color: #20794D;">'lm_head'</span>):</span>
<span id="cb2-85">                <span class="va" style="color: #111111;">self</span>.hooks.append(model.lm_head.register_forward_hook(hook_fn(<span class="st" style="color: #20794D;">"output"</span>, <span class="st" style="color: #20794D;">"lm_head"</span>)))</span>
<span id="cb2-86">            </span>
<span id="cb2-87">            <span class="co" style="color: #5E5E5E;"># Register hook for embedding layer</span></span>
<span id="cb2-88">            <span class="va" style="color: #111111;">self</span>.hooks.append(transformer_model.embed_tokens.register_forward_hook(hook_fn(<span class="st" style="color: #20794D;">"embeddings"</span>, <span class="st" style="color: #20794D;">"embed_tokens"</span>)))</span>
<span id="cb2-89">            </span>
<span id="cb2-90">            <span class="co" style="color: #5E5E5E;"># Register hooks for each transformer layer</span></span>
<span id="cb2-91">            <span class="cf" style="color: #003B4F;">for</span> layer_idx, layer <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(transformer_model.layers):</span>
<span id="cb2-92">                <span class="co" style="color: #5E5E5E;"># Self-attention components - we still register hooks for outputs</span></span>
<span id="cb2-93">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.self_attn.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"self_attn"</span>)))</span>
<span id="cb2-94">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.self_attn.q_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"q_proj"</span>)))</span>
<span id="cb2-95">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.self_attn.k_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"k_proj"</span>)))</span>
<span id="cb2-96">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.self_attn.v_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"v_proj"</span>)))</span>
<span id="cb2-97">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.self_attn.o_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"o_proj"</span>)))</span>
<span id="cb2-98">                </span>
<span id="cb2-99">                <span class="co" style="color: #5E5E5E;"># MLP components</span></span>
<span id="cb2-100">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.mlp.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"mlp"</span>)))</span>
<span id="cb2-101">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.mlp.gate_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"gate_proj"</span>)))</span>
<span id="cb2-102">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.mlp.up_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"up_proj"</span>)))</span>
<span id="cb2-103">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.mlp.down_proj.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"down_proj"</span>)))</span>
<span id="cb2-104">                </span>
<span id="cb2-105">                <span class="co" style="color: #5E5E5E;"># Layer norms</span></span>
<span id="cb2-106">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.input_layernorm.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"input_layernorm"</span>)))</span>
<span id="cb2-107">                <span class="va" style="color: #111111;">self</span>.hooks.append(layer.post_attention_layernorm.register_forward_hook(hook_fn(<span class="ss" style="color: #20794D;">f"layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>, <span class="st" style="color: #20794D;">"post_attention_layernorm"</span>)))</span>
<span id="cb2-108">            </span>
<span id="cb2-109">            <span class="co" style="color: #5E5E5E;"># Final layer norm</span></span>
<span id="cb2-110">            <span class="va" style="color: #111111;">self</span>.hooks.append(transformer_model.norm.register_forward_hook(hook_fn(<span class="st" style="color: #20794D;">"final"</span>, <span class="st" style="color: #20794D;">"norm"</span>)))</span>
<span id="cb2-111">            </span>
<span id="cb2-112">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-113">            </span>
<span id="cb2-114">    <span class="kw" style="color: #003B4F;">def</span> after_forward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-115">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-116">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"after_forward"</span>)</span>
<span id="cb2-117">            </span>
<span id="cb2-118">            <span class="co" style="color: #5E5E5E;"># Restore original forward methods</span></span>
<span id="cb2-119">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(<span class="va" style="color: #111111;">self</span>, <span class="st" style="color: #20794D;">'original_forward_methods'</span>):</span>
<span id="cb2-120">                model <span class="op" style="color: #5E5E5E;">=</span> state.model.model.base_model.model</span>
<span id="cb2-121">                transformer_model <span class="op" style="color: #5E5E5E;">=</span> model.model</span>
<span id="cb2-122">                </span>
<span id="cb2-123">                <span class="cf" style="color: #003B4F;">for</span> layer_idx, original_forward <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.original_forward_methods.items():</span>
<span id="cb2-124">                    transformer_model.layers[layer_idx].self_attn.forward <span class="op" style="color: #5E5E5E;">=</span> original_forward</span>
<span id="cb2-125">                </span>
<span id="cb2-126">                <span class="va" style="color: #111111;">self</span>.original_forward_methods <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb2-127">            </span>
<span id="cb2-128">            <span class="co" style="color: #5E5E5E;"># Clear hooks</span></span>
<span id="cb2-129">            <span class="cf" style="color: #003B4F;">for</span> hook <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.hooks:</span>
<span id="cb2-130">                hook.remove()</span>
<span id="cb2-131">            <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb2-132">            </span>
<span id="cb2-133">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-134">            </span>
<span id="cb2-135">    <span class="kw" style="color: #003B4F;">def</span> before_loss(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-136">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-137">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"before_loss"</span>)</span>
<span id="cb2-138">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-139">            </span>
<span id="cb2-140">    <span class="kw" style="color: #003B4F;">def</span> after_loss(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-141">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-142">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"after_loss"</span>)</span>
<span id="cb2-143">            <span class="va" style="color: #111111;">self</span>._log_loss_dtype(state, <span class="st" style="color: #20794D;">"after_loss"</span>)</span>
<span id="cb2-144">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-145">            </span>
<span id="cb2-146">    <span class="kw" style="color: #003B4F;">def</span> before_backward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-147">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-148">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"before_backward"</span>)</span>
<span id="cb2-149">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-150">            </span>
<span id="cb2-151">    <span class="kw" style="color: #003B4F;">def</span> after_backward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-152">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-153">            <span class="co" style="color: #5E5E5E;"># Log gradient dtypes as before</span></span>
<span id="cb2-154">            <span class="va" style="color: #111111;">self</span>._log_gradient_dtypes(state, <span class="st" style="color: #20794D;">"after_backward"</span>)</span>
<span id="cb2-155">            </span>
<span id="cb2-156">            <span class="co" style="color: #5E5E5E;"># Track weight dtypes before optimizer step</span></span>
<span id="cb2-157">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"before_optim_step"</span>)</span>
<span id="cb2-158">            </span>
<span id="cb2-159">            <span class="co" style="color: #5E5E5E;"># Log optimizer state dtypes</span></span>
<span id="cb2-160">            <span class="va" style="color: #111111;">self</span>._log_optimizer_state_dtypes(state, <span class="st" style="color: #20794D;">"optimizer_step"</span>)</span>
<span id="cb2-161">            </span>
<span id="cb2-162">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-163">                    </span>
<span id="cb2-164">    <span class="kw" style="color: #003B4F;">def</span> batch_end(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-165">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb2-166">            <span class="co" style="color: #5E5E5E;"># Track weight dtypes after optimizer step to detect precision changes</span></span>
<span id="cb2-167">            <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"after_optim_step"</span>)</span>
<span id="cb2-168">            <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-169"></span>
<span id="cb2-170">    <span class="kw" style="color: #003B4F;">def</span> epoch_end(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-171">        <span class="va" style="color: #111111;">self</span>._log_model_weight_dtypes(state, <span class="st" style="color: #20794D;">"epoch_end"</span>)</span>
<span id="cb2-172">        <span class="va" style="color: #111111;">self</span>._save_logs()</span>
<span id="cb2-173">        </span>
<span id="cb2-174">    <span class="kw" style="color: #003B4F;">def</span> _log_model_weight_dtypes(<span class="va" style="color: #111111;">self</span>, state: State, event_name: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-175">        model <span class="op" style="color: #5E5E5E;">=</span> state.model</span>
<span id="cb2-176">        <span class="cf" style="color: #003B4F;">for</span> name, param <span class="kw" style="color: #003B4F;">in</span> model.named_parameters():</span>
<span id="cb2-177">            name <span class="op" style="color: #5E5E5E;">=</span> name.removeprefix(<span class="st" style="color: #20794D;">"model.base_model.model.model."</span>)</span>
<span id="cb2-178">            <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>event_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:weights"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(param.dtype)</span>
<span id="cb2-179"></span>
<span id="cb2-180">    <span class="kw" style="color: #003B4F;">def</span> _log_gradient_dtypes(<span class="va" style="color: #111111;">self</span>, state: State, event_name: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-181">        model <span class="op" style="color: #5E5E5E;">=</span> state.model</span>
<span id="cb2-182">        <span class="cf" style="color: #003B4F;">for</span> name, param <span class="kw" style="color: #003B4F;">in</span> model.named_parameters():</span>
<span id="cb2-183">            name <span class="op" style="color: #5E5E5E;">=</span> name.removeprefix(<span class="st" style="color: #20794D;">"model.base_model.model.model."</span>)</span>
<span id="cb2-184">            <span class="cf" style="color: #003B4F;">if</span> param.grad <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>: <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">'log'</span>][<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>event_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:gradients"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(param.grad.dtype)</span>
<span id="cb2-185">            <span class="cf" style="color: #003B4F;">else</span>: <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">'log'</span>][<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>event_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:gradients"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"None"</span></span>
<span id="cb2-186">    </span>
<span id="cb2-187">    <span class="kw" style="color: #003B4F;">def</span> _log_loss_dtype(<span class="va" style="color: #111111;">self</span>, state: State, event_name: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-188">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(state, <span class="st" style="color: #20794D;">'loss'</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">hasattr</span>(state.loss, <span class="st" style="color: #20794D;">'dtype'</span>):</span>
<span id="cb2-189">            <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>event_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:loss"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(state.loss.dtype)</span>
<span id="cb2-190">            </span>
<span id="cb2-191">    <span class="kw" style="color: #003B4F;">def</span> _log_optimizer_state_dtypes(<span class="va" style="color: #111111;">self</span>, state: State, event_name: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-192">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(state, <span class="st" style="color: #20794D;">'optimizers'</span>) <span class="kw" style="color: #003B4F;">and</span> state.optimizers <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-193">            <span class="co" style="color: #5E5E5E;"># Handle single optimizer or list of optimizers</span></span>
<span id="cb2-194">            optimizers <span class="op" style="color: #5E5E5E;">=</span> state.optimizers <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(state.optimizers, <span class="bu" style="color: null;">list</span>) <span class="cf" style="color: #003B4F;">else</span> [state.optimizers]</span>
<span id="cb2-195">            </span>
<span id="cb2-196">            <span class="cf" style="color: #003B4F;">for</span> opt_idx, optimizer <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(optimizers):</span>
<span id="cb2-197">                <span class="co" style="color: #5E5E5E;"># Get optimizer state dict</span></span>
<span id="cb2-198">                opt_state <span class="op" style="color: #5E5E5E;">=</span> optimizer.state_dict()</span>
<span id="cb2-199">                </span>
<span id="cb2-200">                <span class="co" style="color: #5E5E5E;"># Check if 'state' exists in the optimizer state dict</span></span>
<span id="cb2-201">                <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'state'</span> <span class="kw" style="color: #003B4F;">in</span> opt_state:</span>
<span id="cb2-202">                    <span class="cf" style="color: #003B4F;">for</span> param_id, param_state <span class="kw" style="color: #003B4F;">in</span> opt_state[<span class="st" style="color: #20794D;">'state'</span>].items():</span>
<span id="cb2-203">                        <span class="cf" style="color: #003B4F;">for</span> state_name, state_value <span class="kw" style="color: #003B4F;">in</span> param_state.items():</span>
<span id="cb2-204">                            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(state_value, torch.Tensor):</span>
<span id="cb2-205">                                <span class="co" style="color: #5E5E5E;"># Store dtype of optimizer state tensors (momentum buffers, etc.)</span></span>
<span id="cb2-206">                                key <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"optimizer_</span><span class="sc" style="color: #5E5E5E;">{</span>opt_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_param_</span><span class="sc" style="color: #5E5E5E;">{</span>param_id<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_</span><span class="sc" style="color: #5E5E5E;">{</span>state_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span>
<span id="cb2-207">                                <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>event_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:</span><span class="sc" style="color: #5E5E5E;">{</span>key<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:optimizer_states"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(state_value.dtype)</span>
<span id="cb2-208">            </span>
<span id="cb2-209">    <span class="kw" style="color: #003B4F;">def</span> _save_logs(<span class="va" style="color: #111111;">self</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb2-210">        os.makedirs(<span class="va" style="color: #111111;">self</span>.save_path, exist_ok<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb2-211">        log_file <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.save_path <span class="op" style="color: #5E5E5E;">/</span> <span class="st" style="color: #20794D;">"dtype_logs.json"</span></span>
<span id="cb2-212">        <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(log_file, <span class="st" style="color: #20794D;">'w'</span>) <span class="im" style="color: #00769E;">as</span> f:</span>
<span id="cb2-213">            json.dump(<span class="va" style="color: #111111;">self</span>.dtype_logs, f, indent<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<p>The most involved event handler is <code>before_forward</code> which involves creating a hook function (<code>hook_fn</code>) passed to PyTorch’s <a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module.register_forward_hook"><code>register_forward_hook</code></a> which exposes the positional inputs and outputs of a module’s <code>forward</code> pass. The hook function modifies <code>self.dtype_logs</code> directly by storing the data type string of inputs and outputs. <code>hook_fn</code> is used for all modules except self attention.</p>
<p>Self attention <a href="https://github.com/huggingface/transformers/issues/29247#issuecomment-1965894085">cannot utilize <code>register_forward_hook</code></a> because the <a href="https://github.com/huggingface/transformers/blob/bf41e54fc8242dafa31bf6203e3d505bcb907119/src/transformers/models/llama/modeling_llama.py#L345">LlamaDecoderLayer</a> does not call self attention forward pass with any positional arguments:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">hidden_states, self_attn_weights <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.self_attn(</span>
<span id="cb3-2">    hidden_states<span class="op" style="color: #5E5E5E;">=</span>hidden_states,</span>
<span id="cb3-3">    attention_mask<span class="op" style="color: #5E5E5E;">=</span>attention_mask,</span>
<span id="cb3-4">    position_ids<span class="op" style="color: #5E5E5E;">=</span>position_ids,</span>
<span id="cb3-5">    past_key_value<span class="op" style="color: #5E5E5E;">=</span>past_key_value,</span>
<span id="cb3-6">    output_attentions<span class="op" style="color: #5E5E5E;">=</span>output_attentions,</span>
<span id="cb3-7">    use_cache<span class="op" style="color: #5E5E5E;">=</span>use_cache,</span>
<span id="cb3-8">    cache_position<span class="op" style="color: #5E5E5E;">=</span>cache_position,</span>
<span id="cb3-9">    position_embeddings<span class="op" style="color: #5E5E5E;">=</span>position_embeddings,</span>
<span id="cb3-10">    <span class="op" style="color: #5E5E5E;">**</span>kwargs,</span>
<span id="cb3-11">)</span></code></pre></div>
<p>Contrast this with how the forward pass of other modules are called with positional arguments only:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;"># self attention sublayers</span></span>
<span id="cb4-2">query_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.q_proj(hidden_states).view(hidden_shape).transpose(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb4-3">key_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.k_proj(hidden_states).view(hidden_shape).transpose(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb4-4">value_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.v_proj(hidden_states).view(hidden_shape).transpose(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb4-5">attn_output <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.o_proj(attn_output)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;"># mlp sublayers</span></span>
<span id="cb4-8">down_proj <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.down_proj(<span class="va" style="color: #111111;">self</span>.act_fn(<span class="va" style="color: #111111;">self</span>.gate_proj(x)) <span class="op" style="color: #5E5E5E;">*</span> <span class="va" style="color: #111111;">self</span>.up_proj(x))</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;"># non-self attention modules</span></span>
<span id="cb4-11">hidden_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.input_layernorm(hidden_states)</span>
<span id="cb4-12">hidden_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.post_attention_layernorm(hidden_states)</span>
<span id="cb4-13">hidden_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.mlp(hidden_states)</span>
<span id="cb4-14">hidden_states <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.norm(hidden_states)</span></code></pre></div>
<p>Since self-attention inputs can’t be captured by a hook I had to monkey patch its forward pass to log its inputs’ data type:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="cf" style="color: #003B4F;">for</span> layer_idx, layer <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(transformer_model.layers):</span>
<span id="cb5-2">    <span class="co" style="color: #5E5E5E;"># Store the original forward method</span></span>
<span id="cb5-3">    original_forward <span class="op" style="color: #5E5E5E;">=</span> layer.self_attn.forward</span>
<span id="cb5-4">    <span class="va" style="color: #111111;">self</span>.original_forward_methods[layer_idx] <span class="op" style="color: #5E5E5E;">=</span> original_forward</span>
<span id="cb5-5">    </span>
<span id="cb5-6">    <span class="co" style="color: #5E5E5E;"># Define a closure to capture the current layer_idx</span></span>
<span id="cb5-7">    <span class="kw" style="color: #003B4F;">def</span> make_patched_forward(layer_idx, orig_forward):</span>
<span id="cb5-8">        <span class="kw" style="color: #003B4F;">def</span> patched_forward(self_attn, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs):</span>
<span id="cb5-9">            <span class="co" style="color: #5E5E5E;"># Log the hidden_states dtype</span></span>
<span id="cb5-10">            <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'hidden_states'</span> <span class="kw" style="color: #003B4F;">in</span> kwargs <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">hasattr</span>(kwargs[<span class="st" style="color: #20794D;">'hidden_states'</span>], <span class="st" style="color: #20794D;">'dtype'</span>):</span>
<span id="cb5-11">                <span class="va" style="color: #111111;">self</span>.dtype_logs[<span class="st" style="color: #20794D;">"log"</span>][<span class="ss" style="color: #20794D;">f"forward:self_attn:layer_</span><span class="sc" style="color: #5E5E5E;">{</span>layer_idx<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:activation_input"</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(kwargs[<span class="st" style="color: #20794D;">'hidden_states'</span>].dtype)</span>
<span id="cb5-12">            </span>
<span id="cb5-13">            <span class="co" style="color: #5E5E5E;"># Call the original method as a bound method</span></span>
<span id="cb5-14">            <span class="co" style="color: #5E5E5E;"># This ensures 'self_attn' is correctly passed as 'self'</span></span>
<span id="cb5-15">            <span class="cf" style="color: #003B4F;">return</span> orig_forward.<span class="fu" style="color: #4758AB;">__get__</span>(self_attn, <span class="bu" style="color: null;">type</span>(self_attn))(<span class="op" style="color: #5E5E5E;">**</span>kwargs)</span>
<span id="cb5-16">        </span>
<span id="cb5-17">        <span class="cf" style="color: #003B4F;">return</span> patched_forward</span>
<span id="cb5-18"></span>
<span id="cb5-19">    <span class="co" style="color: #5E5E5E;"># Replace the forward method</span></span>
<span id="cb5-20">    layer.self_attn.forward <span class="op" style="color: #5E5E5E;">=</span> make_patched_forward(layer_idx, original_forward).<span class="fu" style="color: #4758AB;">__get__</span>(layer.self_attn, <span class="bu" style="color: null;">type</span>(layer.self_attn))</span></code></pre></div>
<p><code>patched_forward</code> receives positional arguments <code>*args</code> (of which there are none) and keyword arguments <code>**kwargs</code> (all of the arguments to the self-attention forward) and logs the data types of the inputs to self-attention (<code>hidden_states</code>) as <code>self_attn_input</code> before returning the outputs of the original forward pass.</p>
<p>A key line is <code>orig_forward.__get__(self_attn, type(self_attn))(**kwargs)</code>. As Claude’s comment mentions, this is to avoid using <code>orig_forward(self_attn, **kwargs)</code> which was causing the following error because the first argument, <code>self_attn</code>, was being interpreted as <code>hidden_states</code> whereas it was intended to represent <code>self</code>:</p>
<pre><code>TypeError: LlamaFlashAttention2.forward() got multiple values for argument 'hidden_states'</code></pre>
<p>In short, when you call <code>__get__(obj, type)</code> on a function it will bind that function as a method to the given object, thus no longer requiring you to pass in <code>self</code> as an argument. This is critical because <code>self_attn.forward</code> <em>has no positional arguments</em>. We can then pass in the keyword arguments to the bound method <code>orig_forward.__get__(self_attn, type(self_attn))(**kwargs)</code>, and let the model continue using self-attention correctly. See the <a href="https://docs.python.org/3/howto/descriptor.html#functions-and-methods:~:text=To%20recap%2C%20functions%20have%20a%20__get__()%20method%20so%20that%20they%20can%20be%20converted%20to%20a%20method%20when%20accessed%20as%20attributes.%20The%20non%2Ddata%20descriptor%20transforms%20an%20obj.f(*args)%20call%20into%20f(obj%2C%20*args).%20Calling%20cls.f(*args)%20becomes%20f(*args).">Descriptor Guide in the Python docs</a> for more information.</p>
</section>
<section id="helper-functions" class="level2">
<h2 class="anchored" data-anchor-id="helper-functions">Helper Functions</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;">import</span> re</span>
<span id="cb7-2"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb7-3"><span class="im" style="color: #00769E;">import</span> json</span>
<span id="cb7-4"><span class="im" style="color: #00769E;">import</span> requests</span></code></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;">def</span> parse_index(string):</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;">"""Extract structured information from parameter names"""</span></span>
<span id="cb8-3">    info <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb8-4">        <span class="st" style="color: #20794D;">'layer_number'</span>: <span class="va" style="color: #111111;">None</span>,</span>
<span id="cb8-5">        <span class="st" style="color: #20794D;">'module'</span>: <span class="va" style="color: #111111;">None</span>,</span>
<span id="cb8-6">        <span class="st" style="color: #20794D;">'layer_name'</span>: <span class="va" style="color: #111111;">None</span>,</span>
<span id="cb8-7">        <span class="st" style="color: #20794D;">'lora_layer'</span>: <span class="va" style="color: #111111;">None</span>,</span>
<span id="cb8-8">        <span class="st" style="color: #20794D;">'training_step'</span>: <span class="va" style="color: #111111;">None</span>,</span>
<span id="cb8-9">        <span class="st" style="color: #20794D;">'entity'</span>: <span class="va" style="color: #111111;">None</span></span>
<span id="cb8-10">    }</span>
<span id="cb8-11"></span>
<span id="cb8-12">    <span class="co" style="color: #5E5E5E;"># layer = string.split(":")[1]</span></span>
<span id="cb8-13">    <span class="co" style="color: #5E5E5E;"># info["layer"] = layer</span></span>
<span id="cb8-14"></span>
<span id="cb8-15">    layer_number_match <span class="op" style="color: #5E5E5E;">=</span> re.search(<span class="vs" style="color: #20794D;">r'layers\.(\d+)'</span>, string)</span>
<span id="cb8-16">    <span class="cf" style="color: #003B4F;">if</span> layer_number_match: info[<span class="st" style="color: #20794D;">'layer_number'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(layer_number_match.group(<span class="dv" style="color: #AD0000;">1</span>))</span>
<span id="cb8-17"></span>
<span id="cb8-18">    modules <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb8-19">        <span class="st" style="color: #20794D;">"embed_tokens"</span>,</span>
<span id="cb8-20">        <span class="st" style="color: #20794D;">"input_layernorm"</span>,</span>
<span id="cb8-21">        <span class="st" style="color: #20794D;">"self_attn"</span>,</span>
<span id="cb8-22">        <span class="st" style="color: #20794D;">"post_attention_layernorm"</span>,</span>
<span id="cb8-23">        <span class="st" style="color: #20794D;">"mlp"</span>,</span>
<span id="cb8-24">        <span class="st" style="color: #20794D;">"norm"</span>,</span>
<span id="cb8-25">        <span class="st" style="color: #20794D;">"lm_head"</span></span>
<span id="cb8-26">    ]</span>
<span id="cb8-27"></span>
<span id="cb8-28">    module_match <span class="op" style="color: #5E5E5E;">=</span> re.search(<span class="vs" style="color: #20794D;">r'(mlp|self_attn|input_layernorm|post_attention_layernorm|embed_tokens|norm|lm_head)'</span>, string)</span>
<span id="cb8-29">    <span class="cf" style="color: #003B4F;">if</span> module_match: info[<span class="st" style="color: #20794D;">'module'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(modules.index(module_match.group(<span class="dv" style="color: #AD0000;">1</span>))).zfill(<span class="dv" style="color: #AD0000;">2</span>) <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">'_'</span> <span class="op" style="color: #5E5E5E;">+</span> module_match.group(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb8-30"></span>
<span id="cb8-31">    layer_name_match <span class="op" style="color: #5E5E5E;">=</span> re.search(<span class="vs" style="color: #20794D;">r'(q_proj|k_proj|v_proj|o_proj|gate_proj|up_proj|down_proj)'</span>, string)</span>
<span id="cb8-32">    <span class="cf" style="color: #003B4F;">if</span> layer_name_match: info[<span class="st" style="color: #20794D;">'layer_name'</span>] <span class="op" style="color: #5E5E5E;">=</span> layer_name_match.group(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb8-33"></span>
<span id="cb8-34">    lora_match <span class="op" style="color: #5E5E5E;">=</span> re.search(<span class="vs" style="color: #20794D;">r'(base_layer|lora_A|lora_B)'</span>, string)</span>
<span id="cb8-35">    <span class="cf" style="color: #003B4F;">if</span> lora_match: info[<span class="st" style="color: #20794D;">'lora_layer'</span>] <span class="op" style="color: #5E5E5E;">=</span> lora_match.group(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb8-36">    <span class="cf" style="color: #003B4F;">else</span>: info[<span class="st" style="color: #20794D;">'lora_layer'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Not a LoRA Layer"</span></span>
<span id="cb8-37"></span>
<span id="cb8-38">    training_steps <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb8-39">        <span class="st" style="color: #20794D;">"fit_start"</span>,</span>
<span id="cb8-40">        <span class="st" style="color: #20794D;">"epoch_start"</span>,</span>
<span id="cb8-41">        <span class="st" style="color: #20794D;">"before_dataloader"</span>,</span>
<span id="cb8-42">        <span class="st" style="color: #20794D;">"after_dataloader"</span>,</span>
<span id="cb8-43">        <span class="st" style="color: #20794D;">"batch_start"</span>,</span>
<span id="cb8-44">        <span class="st" style="color: #20794D;">"before_forward"</span>,</span>
<span id="cb8-45">        <span class="st" style="color: #20794D;">"forward"</span>,</span>
<span id="cb8-46">        <span class="st" style="color: #20794D;">"after_forward"</span>,</span>
<span id="cb8-47">        <span class="st" style="color: #20794D;">"before_loss"</span>,</span>
<span id="cb8-48">        <span class="st" style="color: #20794D;">"after_loss"</span>,</span>
<span id="cb8-49">        <span class="st" style="color: #20794D;">"before_backward"</span>,</span>
<span id="cb8-50">        <span class="st" style="color: #20794D;">"after_backward"</span>,</span>
<span id="cb8-51">        <span class="st" style="color: #20794D;">"before_optim_step"</span>,</span>
<span id="cb8-52">        <span class="st" style="color: #20794D;">"optimizer_step"</span>,</span>
<span id="cb8-53">        <span class="st" style="color: #20794D;">"after_optim_step"</span></span>
<span id="cb8-54">        ]</span>
<span id="cb8-55"></span>
<span id="cb8-56">    training_step <span class="op" style="color: #5E5E5E;">=</span> string.split(<span class="st" style="color: #20794D;">":"</span>)[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb8-57">    info[<span class="st" style="color: #20794D;">'training_step'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(training_steps.index(training_step)).zfill(<span class="dv" style="color: #AD0000;">2</span>) <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">'_'</span> <span class="op" style="color: #5E5E5E;">+</span> training_step</span>
<span id="cb8-58"></span>
<span id="cb8-59">    info[<span class="st" style="color: #20794D;">'entity'</span>] <span class="op" style="color: #5E5E5E;">=</span> string.split(<span class="st" style="color: #20794D;">":"</span>)[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb8-60"></span>
<span id="cb8-61"></span>
<span id="cb8-62">    <span class="cf" style="color: #003B4F;">return</span> info</span></code></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;">def</span> _df(url):</span>
<span id="cb9-2">    dtype_data <span class="op" style="color: #5E5E5E;">=</span> json.loads(requests.get(url).text)</span>
<span id="cb9-3"></span>
<span id="cb9-4">    df <span class="op" style="color: #5E5E5E;">=</span> pd.DataFrame(dtype_data).reset_index()</span>
<span id="cb9-5">    df <span class="op" style="color: #5E5E5E;">=</span> df.rename(columns<span class="op" style="color: #5E5E5E;">=</span>{<span class="st" style="color: #20794D;">"index"</span>: <span class="st" style="color: #20794D;">"index"</span>, <span class="st" style="color: #20794D;">"log"</span>: <span class="st" style="color: #20794D;">"dtype"</span>})</span>
<span id="cb9-6"></span>
<span id="cb9-7">    parsed_info <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'index'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: parse_index(x))</span>
<span id="cb9-8"></span>
<span id="cb9-9">    df[<span class="st" style="color: #20794D;">'layer_number'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'layer_number'</span>])</span>
<span id="cb9-10">    df[<span class="st" style="color: #20794D;">'module'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'module'</span>])</span>
<span id="cb9-11">    df[<span class="st" style="color: #20794D;">'layer_name'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'layer_name'</span>])</span>
<span id="cb9-12">    df[<span class="st" style="color: #20794D;">'lora_layer'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'lora_layer'</span>])</span>
<span id="cb9-13">    df[<span class="st" style="color: #20794D;">'training_step'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'training_step'</span>])</span>
<span id="cb9-14">    df[<span class="st" style="color: #20794D;">'entity'</span>] <span class="op" style="color: #5E5E5E;">=</span> parsed_info.<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x[<span class="st" style="color: #20794D;">'entity'</span>])</span>
<span id="cb9-15"></span>
<span id="cb9-16">    <span class="cf" style="color: #003B4F;">return</span> df</span></code></pre></div>
</div>
</section>
<section id="model-in-fp32-master_weights_dtypenone" class="level2">
<h2 class="anchored" data-anchor-id="model-in-fp32-master_weights_dtypenone">Model in fp32 (<code>master_weights_dtype==None</code>)</h2>
<p>In this case, <code>master_weights_dtype</code> is not provided in the training YAML file.</p>
<div class="cell" data-outputid="73fb1c7d-f091-413b-90af-cf9fb0c6eb51" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">url <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"https://gist.githubusercontent.com/vishalbakshi/9ade8d501629d4c30e8aecfa1c6f67cf/raw/0c162e2305002fbe57fd2570ade302c3659140a1/dtypes_logs_1ba_fp32.json"</span></span>
<span id="cb10-2">df <span class="op" style="color: #5E5E5E;">=</span> _df(url)</span>
<span id="cb10-3">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">


  <div id="df-f6bb70e8-9110-47f0-85d1-46d907c311a6" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>index</th>
      <th>dtype</th>
      <th>layer_number</th>
      <th>module</th>
      <th>layer_name</th>
      <th>lora_layer</th>
      <th>training_step</th>
      <th>entity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>fit_start:embed_tokens.weight:weights</td>
      <td>torch.float32</td>
      <td>NaN</td>
      <td>00_embed_tokens</td>
      <td>None</td>
      <td>Not a LoRA Layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>1</th>
      <td>fit_start:layers.0.self_attn.q_proj.base_layer...</td>
      <td>torch.float32</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>base_layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fit_start:layers.0.self_attn.q_proj.lora_A.def...</td>
      <td>torch.float32</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>lora_A</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>3</th>
      <td>fit_start:layers.0.self_attn.q_proj.lora_B.def...</td>
      <td>torch.float32</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>lora_B</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>4</th>
      <td>fit_start:layers.0.self_attn.k_proj.base_layer...</td>
      <td>torch.float32</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>k_proj</td>
      <td>base_layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-f6bb70e8-9110-47f0-85d1-46d907c311a6')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-f6bb70e8-9110-47f0-85d1-46d907c311a6 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-f6bb70e8-9110-47f0-85d1-46d907c311a6');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-b878e7a4-6a3d-484e-8565-4873e2d61a8a">
  <button class="colab-df-quickchart" onclick="quickchart('df-b878e7a4-6a3d-484e-8565-4873e2d61a8a')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-b878e7a4-6a3d-484e-8565-4873e2d61a8a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<section id="data-types-by-lora_layer" class="level3">
<h3 class="anchored" data-anchor-id="data-types-by-lora_layer">Data Types by <code>lora_layer</code></h3>
<p>All LoRA layer entities are in fp32.</p>
<div class="cell" data-outputid="d3494bca-3fbd-4a42-ae1b-5087d3ef6618" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">df.groupby([<span class="st" style="color: #20794D;">'lora_layer'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>lora_layer</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">Not a LoRA Layer</th>
      <th>None</th>
      <td>62</td>
    </tr>
    <tr>
      <th>torch.bfloat16</th>
      <td>331</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>2339</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">base_layer</th>
      <th>None</th>
      <td>210</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>2520</td>
    </tr>
    <tr>
      <th>lora_A</th>
      <th>torch.float32</th>
      <td>2730</td>
    </tr>
    <tr>
      <th>lora_B</th>
      <th>torch.float32</th>
      <td>2730</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
<section id="data-types-by-entity-activations-gradients-loss-optimizer-states-and-weights" class="level3">
<h3 class="anchored" data-anchor-id="data-types-by-entity-activations-gradients-loss-optimizer-states-and-weights">Data Types by <code>entity</code> (Activations, Gradients, Loss, Optimizer States and Weights)</h3>
<p>Every entity except activations are in fp32. Some parameters don’t have gradients because we are training with LoRA.</p>
<div class="cell" data-outputid="78343b50-69b7-4e1e-f2eb-58f2a3fbc781" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">df.groupby([<span class="st" style="color: #20794D;">'entity'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>entity</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">activation_input</th>
      <th>torch.bfloat16</th>
      <td>60</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">activation_output</th>
      <th>torch.bfloat16</th>
      <td>271</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>62</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">gradients</th>
      <th>None</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>420</td>
    </tr>
    <tr>
      <th>loss</th>
      <th>torch.float32</th>
      <td>1</td>
    </tr>
    <tr>
      <th>optimizer_states</th>
      <th>torch.float32</th>
      <td>1260</td>
    </tr>
    <tr>
      <th>weights</th>
      <th>torch.float32</th>
      <td>8304</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
<section id="data-types-by-composer-training-step" class="level3">
<h3 class="anchored" data-anchor-id="data-types-by-composer-training-step">Data Types by Composer Training Step</h3>
<div class="cell" data-outputid="98def9cf-d2c3-4003-a11c-1293b9879460" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">df.groupby([<span class="st" style="color: #20794D;">'training_step'</span>, <span class="st" style="color: #20794D;">'entity'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>training_step</th>
      <th>entity</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00_fit_start</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>01_epoch_start</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>02_before_dataloader</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>03_after_dataloader</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>04_batch_start</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>05_before_forward</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">06_forward</th>
      <th rowspan="3" valign="top">activation_input</th>
      <th>torch.bfloat16</th>
      <td>60</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">activation_output</th>
      <th>torch.bfloat16</th>
      <td>271</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>62</td>
    </tr>
    <tr>
      <th>07_after_forward</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>08_before_loss</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">09_after_loss</th>
      <th>loss</th>
      <th>torch.float32</th>
      <td>1</td>
    </tr>
    <tr>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>10_before_backward</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">11_after_backward</th>
      <th rowspan="2" valign="top">gradients</th>
      <th>None</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>420</td>
    </tr>
    <tr>
      <th>12_before_optim_step</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
    <tr>
      <th>13_optimizer_step</th>
      <th>optimizer_states</th>
      <th>torch.float32</th>
      <td>1260</td>
    </tr>
    <tr>
      <th>14_after_optim_step</th>
      <th>weights</th>
      <th>torch.float32</th>
      <td>692</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
</section>
<section id="model-in-bf16-master_weights_dtypebfloat16" class="level2">
<h2 class="anchored" data-anchor-id="model-in-bf16-master_weights_dtypebfloat16">Model in bf16 (<code>master_weights_dtype==bfloat16</code>)</h2>
<p>I also logged data types after setting <code>master_weights_dtype</code> in the training YAML to <code>bfloat16</code>.</p>
<div class="cell" data-outputid="5b638922-40c0-42a9-9c0e-8b907d105abd" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">url <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"https://gist.githubusercontent.com/vishalbakshi/ec91a59754633611fd8eb33b59031243/raw/5b83a7ebd5759cf6bd2db2369edf1c73e1fb67cf/dtypes_logs_1ba_bf16.json"</span></span>
<span id="cb14-2">df <span class="op" style="color: #5E5E5E;">=</span> _df(url)</span>
<span id="cb14-3">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">


  <div id="df-6f3e8532-20df-451d-8e93-caa52d279f3f" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>index</th>
      <th>dtype</th>
      <th>layer_number</th>
      <th>module</th>
      <th>layer_name</th>
      <th>lora_layer</th>
      <th>training_step</th>
      <th>entity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>fit_start:embed_tokens.weight:weights</td>
      <td>torch.bfloat16</td>
      <td>NaN</td>
      <td>00_embed_tokens</td>
      <td>None</td>
      <td>Not a LoRA Layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>1</th>
      <td>fit_start:layers.0.self_attn.q_proj.base_layer...</td>
      <td>torch.bfloat16</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>base_layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fit_start:layers.0.self_attn.q_proj.lora_A.def...</td>
      <td>torch.bfloat16</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>lora_A</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>3</th>
      <td>fit_start:layers.0.self_attn.q_proj.lora_B.def...</td>
      <td>torch.bfloat16</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>q_proj</td>
      <td>lora_B</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
    <tr>
      <th>4</th>
      <td>fit_start:layers.0.self_attn.k_proj.base_layer...</td>
      <td>torch.bfloat16</td>
      <td>0.0</td>
      <td>02_self_attn</td>
      <td>k_proj</td>
      <td>base_layer</td>
      <td>00_fit_start</td>
      <td>weights</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-6f3e8532-20df-451d-8e93-caa52d279f3f')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-6f3e8532-20df-451d-8e93-caa52d279f3f button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-6f3e8532-20df-451d-8e93-caa52d279f3f');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-159646a6-3c88-49de-8770-5f4464ad1b49">
  <button class="colab-df-quickchart" onclick="quickchart('df-159646a6-3c88-49de-8770-5f4464ad1b49')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-159646a6-3c88-49de-8770-5f4464ad1b49 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<section id="data-type-by-lora_layer" class="level3">
<h3 class="anchored" data-anchor-id="data-type-by-lora_layer">Data Type by <code>lora_layer</code></h3>
<p>Interestingly, setting <code>master_weights_dtype</code> makes all LoRA layers bfloat16 but some non-LoRA layers’ entities are still in fp32.</p>
<div class="cell" data-outputid="b18ff791-dbf5-40a8-fcfe-402ed510d645" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">df.groupby([<span class="st" style="color: #20794D;">'lora_layer'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>lora_layer</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">Not a LoRA Layer</th>
      <th>None</th>
      <td>62</td>
    </tr>
    <tr>
      <th>torch.bfloat16</th>
      <td>2249</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>421</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">base_layer</th>
      <th>None</th>
      <td>210</td>
    </tr>
    <tr>
      <th>torch.bfloat16</th>
      <td>2520</td>
    </tr>
    <tr>
      <th>lora_A</th>
      <th>torch.bfloat16</th>
      <td>2730</td>
    </tr>
    <tr>
      <th>lora_B</th>
      <th>torch.bfloat16</th>
      <td>2730</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
<section id="data-types-by-entity-activations-gradients-loss-optimizer-states-and-weights-1" class="level3">
<h3 class="anchored" data-anchor-id="data-types-by-entity-activations-gradients-loss-optimizer-states-and-weights-1">Data Types by <code>entity</code> (Activations, Gradients, Loss, Optimizer States and Weights)</h3>
<p>All floating point values are in bfloat16 except for the loss and some of the optimizer states. I’m not sure why some optimizer states are in bf16, even though it says in the <a href="https://docs.mosaicml.com/projects/composer/en/latest/notes/numerics.html#automatic-mixed-precision-amp-training">Composer docs</a>:</p>
<blockquote class="blockquote">
<p>Store the weights and perform the optimizer step in single precision, enabling the weight update to be done more precisely.</p>
</blockquote>
<div class="cell" data-outputid="17283b63-7034-448d-f2a6-b51857b9d320" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">df.groupby([<span class="st" style="color: #20794D;">'entity'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>entity</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">activation_input</th>
      <th>torch.bfloat16</th>
      <td>332</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th>activation_output</th>
      <th>torch.bfloat16</th>
      <td>333</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">gradients</th>
      <th>None</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.bfloat16</th>
      <td>420</td>
    </tr>
    <tr>
      <th>loss</th>
      <th>torch.float32</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">optimizer_states</th>
      <th>torch.bfloat16</th>
      <td>840</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>420</td>
    </tr>
    <tr>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>8304</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
<section id="data-type-by-composer-training-step" class="level3">
<h3 class="anchored" data-anchor-id="data-type-by-composer-training-step">Data Type by Composer Training Step</h3>
<div class="cell" data-outputid="168d15bc-1303-40c0-cc01-7a529ed5cb5d" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">df.groupby([<span class="st" style="color: #20794D;">'training_step'</span>, <span class="st" style="color: #20794D;">'entity'</span>, <span class="st" style="color: #20794D;">'dtype'</span>])[<span class="st" style="color: #20794D;">'dtype'</span>].count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th></th>
      <th>dtype</th>
    </tr>
    <tr>
      <th>training_step</th>
      <th>entity</th>
      <th>dtype</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00_fit_start</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>01_epoch_start</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>02_before_dataloader</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>03_after_dataloader</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>04_batch_start</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>05_before_forward</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">06_forward</th>
      <th rowspan="2" valign="top">activation_input</th>
      <th>torch.bfloat16</th>
      <td>332</td>
    </tr>
    <tr>
      <th>torch.int64</th>
      <td>1</td>
    </tr>
    <tr>
      <th>activation_output</th>
      <th>torch.bfloat16</th>
      <td>333</td>
    </tr>
    <tr>
      <th>07_after_forward</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>08_before_loss</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">09_after_loss</th>
      <th>loss</th>
      <th>torch.float32</th>
      <td>1</td>
    </tr>
    <tr>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th>10_before_backward</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">11_after_backward</th>
      <th rowspan="2" valign="top">gradients</th>
      <th>None</th>
      <td>272</td>
    </tr>
    <tr>
      <th>torch.bfloat16</th>
      <td>420</td>
    </tr>
    <tr>
      <th>12_before_optim_step</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">13_optimizer_step</th>
      <th rowspan="2" valign="top">optimizer_states</th>
      <th>torch.bfloat16</th>
      <td>840</td>
    </tr>
    <tr>
      <th>torch.float32</th>
      <td>420</td>
    </tr>
    <tr>
      <th>14_after_optim_step</th>
      <th>weights</th>
      <th>torch.bfloat16</th>
      <td>692</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I absolutely loved this exercise. I learned a ton about callbacks, data types during mixed precision training, and Python fundamentals. Working with LLM-Foundry has opened up a whole universe of learning opportunities as I try to better understand what’s going on under the hood. It’s a gift that keeps giving!</p>
<p>I’m trying to grow <a href="https://www.youtube.com/@vishal_learner">my YouTube channel</a> so please give it a visit and subscribe if you want to stay in the loop.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-02-Composer-Callback-Logging-dtypes/index.html</guid>
  <pubDate>Wed, 02 Apr 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>Understanding Python Descriptors</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-04-01-Python-Descriptor/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>When monkey-patching the Llama self-attention forward pass (to log its inputs’ data type) I was vibe coding with Claude and it generated the following line to pass the necessary arguments to the original forward pass of the module:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">orig_forward.<span class="fu" style="color: #4758AB;">__get__</span>(self_attn, <span class="bu" style="color: null;">type</span>(self_attn))(<span class="op" style="color: #5E5E5E;">**</span>kwargs)</span></code></pre></div>
<p>In a prior iteration, I was using the following line suggested by Claude, with the intention of passing <code>self_attn</code> as <code>self</code>:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">orig_forward(self_attn, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs)</span></code></pre></div>
<p>This was essentially doing the following:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">orig_forward(self_attn, hidden_states<span class="op" style="color: #5E5E5E;">=</span>hidden_states, attention_mask<span class="op" style="color: #5E5E5E;">=</span>attention_mask, ...)</span></code></pre></div>
<p>Which caused the following error:</p>
<pre><code>TypeError: LlamaFlashAttention2.forward() got multiple values for argument 'hidden_states'</code></pre>
<p><code>self_attn</code> was being passed as the argument to the <code>hidden_states</code> parameter, and then <code>hidden_states=hidden_states</code> was again assigning an argument to the <code>hidden_states</code> parameter. So how do we pass <code>self_attn</code> as <code>self</code>? This is where the <code>__get__</code> method comes in which is part of the Python <a href="https://docs.python.org/3/glossary.html#term-descriptor">Descriptor</a>. Descriptors are:</p>
<blockquote class="blockquote">
<p>Any object which defines the methods <code>__get__()</code>, <code>__set__()</code>, or <code>__delete__()</code>. When a class attribute is a descriptor, its special binding behavior is triggered upon attribute lookup. Normally, using <em>a.b</em> to get, set or delete an attribute looks up the object named <em>b</em> in the class dictionary for <em>a</em>, but if <em>b</em> is a descriptor, the respective descriptor method gets called. Understanding descriptors is a key to a deep understanding of Python because they are the basis for many features including functions, methods, properties, class methods, static methods, and reference to super classes.</p>
</blockquote>
<p>After reading that a few times I still didn’t understand it! Though I think the key is:</p>
<blockquote class="blockquote">
<p>When a class attribute is a descriptor, its special binding behavior is triggered upon attribute lookup.</p>
</blockquote>
<p>Claude explained it this way:</p>
<blockquote class="blockquote">
<p><code>__get__</code> is a special method that converts a function into a bound method. It’s like saying “make this function a method of this object.”</p>
</blockquote>
<p>Translating that to my use case: <code>__get__</code> makes <code>orig_forward</code> a method of <code>self_attn</code>, no longer requiring us to pass <code>self_attn</code> as it now is <code>self</code>.</p>
<p>That certainly makes sense (i.e.&nbsp;I understand those words) but I don’t really understand why or how. That led me to the Python documentation’s <a href="https://docs.python.org/3/howto/descriptor.html#id1">Descriptor Guide</a> which I’ll walk through here.</p>
<p>(There was also this interesting <a href="https://discuss.python.org/t/changing-the-name-of-get-to-bind/14243">discussion</a> about changing the name to <code>__bind__</code> when calling it on a function as it binds the function as a method of the given object, which we’ll see later on).</p>
</section>
<section id="primer" class="level2">
<h2 class="anchored" data-anchor-id="primer">Primer</h2>
<section id="simple-example-a-descriptor-that-returns-a-constant" class="level3">
<h3 class="anchored" data-anchor-id="simple-example-a-descriptor-that-returns-a-constant">Simple example: A descriptor that returns a constant</h3>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;">class</span> Ten:</span>
<span id="cb5-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb5-3">        <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">10</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="eeac4968-a49d-4411-c5f6-3231b2ff396c" data-execution_count="18">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">t <span class="op" style="color: #5E5E5E;">=</span> Ten()</span>
<span id="cb6-2">t</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>&lt;__main__.Ten at 0x78b2fd072c50&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="3c8c18b5-e974-4c71-90cd-bed54365c3f9" data-execution_count="19">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;">type</span>(t)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>__main__.Ten</code></pre>
</div>
</div>
<div class="cell" data-outputid="6af99ff9-5bb6-4561-b5df-af18e218253f" data-execution_count="20">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">t.<span class="fu" style="color: #4758AB;">__get__</span>(<span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>10</code></pre>
</div>
</div>
<p>I think the only reason <code>Ten</code> is a descriptor is because it “defines the methods <code>__get__()</code>, <code>__set__()</code>, or <code>__delete__()</code>”.</p>
<blockquote class="blockquote">
<p>To use the descriptor, it must be stored as a class variable in another class:</p>
</blockquote>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;">class</span> A:</span>
<span id="cb12-2">    x <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">5</span>                       <span class="co" style="color: #5E5E5E;"># Regular class attribute</span></span>
<span id="cb12-3">    y <span class="op" style="color: #5E5E5E;">=</span> Ten()                   <span class="co" style="color: #5E5E5E;"># Descriptor instance</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="fe3fcdb4-845c-4e7e-d4aa-83f23603d858" data-execution_count="22">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">a <span class="op" style="color: #5E5E5E;">=</span> A()                     <span class="co" style="color: #5E5E5E;"># Make an instance of class A</span></span>
<span id="cb13-2">a</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>&lt;__main__.A at 0x78b2fd0707d0&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="93f0602a-05b0-4a09-b674-aa00ee892704" data-execution_count="23">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">a.x                         <span class="co" style="color: #5E5E5E;"># Normal attribute lookup</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>5</code></pre>
</div>
</div>
<div class="cell" data-outputid="52372c3e-1077-4f9a-b2f8-71b3394c8b1b" data-execution_count="24">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">a.y                         <span class="co" style="color: #5E5E5E;"># Descriptor lookup</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>10</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Note that the value 10 is not stored in either the class dictionary or the instance dictionary. Instead, the value 10 is computed on demand.</p>
</blockquote>
<div class="cell" data-outputid="afb4e225-ef85-4202-eb56-db22b5269554" data-execution_count="25">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">A.__dict__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>mappingproxy({'__module__': '__main__',
              'x': 5,
              'y': &lt;__main__.Ten at 0x78b2fd0722d0&gt;,
              '__dict__': &lt;attribute '__dict__' of 'A' objects&gt;,
              '__weakref__': &lt;attribute '__weakref__' of 'A' objects&gt;,
              '__doc__': None})</code></pre>
</div>
</div>
<p>Modifying <code>Ten</code> a bit to visualize this:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;">class</span> Ten2:</span>
<span id="cb21-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb21-3">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"__get__ called with obj=</span><span class="sc" style="color: #5E5E5E;">{</span>obj<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">, objtype=</span><span class="sc" style="color: #5E5E5E;">{</span>objtype<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb21-4">        <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="kw" style="color: #003B4F;">class</span> A2:</span>
<span id="cb21-7">    x <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">5</span></span>
<span id="cb21-8">    y <span class="op" style="color: #5E5E5E;">=</span> Ten2()  <span class="co" style="color: #5E5E5E;"># Descriptor instance</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">a2 <span class="op" style="color: #5E5E5E;">=</span> A2()</span></code></pre></div>
</div>
<div class="cell" data-outputid="e528db12-faa4-463b-b3ba-71897fc0b887" data-execution_count="28">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">a2.y</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2fd089710&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>10</code></pre>
</div>
</div>
<p>Cool!</p>
</section>
<section id="dynamic-lookups" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-lookups">Dynamic Lookups</h3>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb26-2"></span>
<span id="cb26-3"><span class="kw" style="color: #003B4F;">class</span> DirectorySize:</span>
<span id="cb26-4"></span>
<span id="cb26-5">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb26-6">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">len</span>(os.listdir(obj.dirname))</span>
<span id="cb26-7"></span>
<span id="cb26-8"><span class="kw" style="color: #003B4F;">class</span> Directory:</span>
<span id="cb26-9"></span>
<span id="cb26-10">    size <span class="op" style="color: #5E5E5E;">=</span> DirectorySize()              <span class="co" style="color: #5E5E5E;"># Descriptor instance</span></span>
<span id="cb26-11"></span>
<span id="cb26-12">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, dirname):</span>
<span id="cb26-13">        <span class="va" style="color: #111111;">self</span>.dirname <span class="op" style="color: #5E5E5E;">=</span> dirname          <span class="co" style="color: #5E5E5E;"># Regular instance attribute</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">s <span class="op" style="color: #5E5E5E;">=</span> Directory(<span class="st" style="color: #20794D;">'songs'</span>)</span>
<span id="cb27-2">g <span class="op" style="color: #5E5E5E;">=</span> Directory(<span class="st" style="color: #20794D;">'games'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="09aa2729-6427-4da8-e619-fb6ce2abd29e" data-execution_count="54">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">s.size</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>4</code></pre>
</div>
</div>
<div class="cell" data-outputid="5f1ace26-b65a-4747-dccf-150ae2da1111" data-execution_count="48">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">g.size</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>2</code></pre>
</div>
</div>
<p>Removing a file then calling the descriptor’s <code>__get__</code> dynamically calculates the new value:</p>
<div class="cell" data-outputid="0e7788d5-e734-40fc-df0c-07077782244a" data-execution_count="49">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">os.remove(<span class="st" style="color: #20794D;">'games/game1.txt'</span>)            <span class="co" style="color: #5E5E5E;"># Delete a game</span></span>
<span id="cb32-2">g.size</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>1</code></pre>
</div>
</div>
</section>
<section id="managed-attributes" class="level3">
<h3 class="anchored" data-anchor-id="managed-attributes">Managed attributes</h3>
<blockquote class="blockquote">
<p>The descriptor is assigned to a public attribute in the class dictionary while the actual data is stored as a private attribute in the instance dictionary.</p>
</blockquote>
<p>Note that I wasn’t able to see the logging output in this notebook so I’m using print statements instead.</p>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;">class</span> LoggedAgeAccess:</span>
<span id="cb34-2"></span>
<span id="cb34-3">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb34-4">        value <span class="op" style="color: #5E5E5E;">=</span> obj._age</span>
<span id="cb34-5">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Accessing age giving </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb34-6">        <span class="cf" style="color: #003B4F;">return</span> value</span>
<span id="cb34-7"></span>
<span id="cb34-8">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__set__</span>(<span class="va" style="color: #111111;">self</span>, obj, value):</span>
<span id="cb34-9">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Updating age to </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb34-10">        obj._age <span class="op" style="color: #5E5E5E;">=</span> value</span>
<span id="cb34-11"></span>
<span id="cb34-12"><span class="kw" style="color: #003B4F;">class</span> Person:</span>
<span id="cb34-13"></span>
<span id="cb34-14">    age <span class="op" style="color: #5E5E5E;">=</span> LoggedAgeAccess()             <span class="co" style="color: #5E5E5E;"># Descriptor instance</span></span>
<span id="cb34-15"></span>
<span id="cb34-16">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, name, age):</span>
<span id="cb34-17">        <span class="va" style="color: #111111;">self</span>.name <span class="op" style="color: #5E5E5E;">=</span> name                <span class="co" style="color: #5E5E5E;"># Regular instance attribute</span></span>
<span id="cb34-18">        <span class="va" style="color: #111111;">self</span>.age <span class="op" style="color: #5E5E5E;">=</span> age                  <span class="co" style="color: #5E5E5E;"># Calls __set__()</span></span>
<span id="cb34-19"></span>
<span id="cb34-20">    <span class="kw" style="color: #003B4F;">def</span> birthday(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb34-21">        <span class="va" style="color: #111111;">self</span>.age <span class="op" style="color: #5E5E5E;">+=</span> <span class="dv" style="color: #AD0000;">1</span>                   <span class="co" style="color: #5E5E5E;"># Calls both __get__() and __set__()</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="8b75d44a-d3d3-4a0f-8b6a-b1526c61850c" data-execution_count="82">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">mary <span class="op" style="color: #5E5E5E;">=</span> Person(<span class="st" style="color: #20794D;">'Mary M'</span>, <span class="dv" style="color: #AD0000;">30</span>)         <span class="co" style="color: #5E5E5E;"># The initial age update is logged</span></span>
<span id="cb35-2">dave <span class="op" style="color: #5E5E5E;">=</span> Person(<span class="st" style="color: #20794D;">'David D'</span>, <span class="dv" style="color: #AD0000;">40</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Updating age to 30
Updating age to 40</code></pre>
</div>
</div>
<div class="cell" data-outputid="6bfbbf95-7e19-4375-e7d0-3ea569224486" data-execution_count="83">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="bu" style="color: null;">vars</span>(mary), <span class="bu" style="color: null;">vars</span>(dave)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>({'name': 'Mary M', '_age': 30}, {'name': 'David D', '_age': 40})</code></pre>
</div>
</div>
<div class="cell" data-outputid="b498be42-317d-4880-e5cd-0ec735143778" data-execution_count="84">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">mary.age</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accessing age giving 30</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>30</code></pre>
</div>
</div>
<div class="cell" data-outputid="c30f9e43-22cb-4d26-b75b-75d9c486f9b9" data-execution_count="85">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">mary.birthday()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accessing age giving 30
Updating age to 31</code></pre>
</div>
</div>
<div class="cell" data-outputid="317f28b0-1e3a-49ed-ef6b-fa6904e9c636" data-execution_count="86">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">mary.age</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accessing age giving 31</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>31</code></pre>
</div>
</div>
<div class="cell" data-outputid="805635b0-8485-4fdb-b066-60314f8ff50c" data-execution_count="87">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">dave.name</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>'David D'</code></pre>
</div>
</div>
<div class="cell" data-outputid="a14b4606-f0e2-4654-956e-0b937a8bc394" data-execution_count="88">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">dave.age</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accessing age giving 40</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>40</code></pre>
</div>
</div>
</section>
<section id="customized-names" class="level3">
<h3 class="anchored" data-anchor-id="customized-names">Customized names</h3>
<blockquote class="blockquote">
<p>When a class uses descriptors, it can inform each descriptor about which variable name was used.</p>
</blockquote>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="kw" style="color: #003B4F;">class</span> LoggedAccess:</span>
<span id="cb52-2"></span>
<span id="cb52-3">    <span class="kw" style="color: #003B4F;">def</span> __set_name__(<span class="va" style="color: #111111;">self</span>, owner, name):</span>
<span id="cb52-4">        <span class="va" style="color: #111111;">self</span>.public_name <span class="op" style="color: #5E5E5E;">=</span> name</span>
<span id="cb52-5">        <span class="va" style="color: #111111;">self</span>.private_name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'_'</span> <span class="op" style="color: #5E5E5E;">+</span> name</span>
<span id="cb52-6"></span>
<span id="cb52-7">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb52-8">        value <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(obj, <span class="va" style="color: #111111;">self</span>.private_name)</span>
<span id="cb52-9">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Accessing </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>public_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> giving </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb52-10">        <span class="cf" style="color: #003B4F;">return</span> value</span>
<span id="cb52-11"></span>
<span id="cb52-12">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__set__</span>(<span class="va" style="color: #111111;">self</span>, obj, value):</span>
<span id="cb52-13">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Updating </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>public_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> to </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb52-14">        <span class="bu" style="color: null;">setattr</span>(obj, <span class="va" style="color: #111111;">self</span>.private_name, value)</span>
<span id="cb52-15"></span>
<span id="cb52-16"><span class="kw" style="color: #003B4F;">class</span> Person:</span>
<span id="cb52-17"></span>
<span id="cb52-18">    name <span class="op" style="color: #5E5E5E;">=</span> LoggedAccess()                <span class="co" style="color: #5E5E5E;"># First descriptor instance</span></span>
<span id="cb52-19">    age <span class="op" style="color: #5E5E5E;">=</span> LoggedAccess()                 <span class="co" style="color: #5E5E5E;"># Second descriptor instance</span></span>
<span id="cb52-20"></span>
<span id="cb52-21">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, name, age):</span>
<span id="cb52-22">        <span class="va" style="color: #111111;">self</span>.name <span class="op" style="color: #5E5E5E;">=</span> name                 <span class="co" style="color: #5E5E5E;"># Calls the first descriptor</span></span>
<span id="cb52-23">        <span class="va" style="color: #111111;">self</span>.age <span class="op" style="color: #5E5E5E;">=</span> age                   <span class="co" style="color: #5E5E5E;"># Calls the second descriptor</span></span>
<span id="cb52-24"></span>
<span id="cb52-25">    <span class="kw" style="color: #003B4F;">def</span> birthday(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb52-26">        <span class="va" style="color: #111111;">self</span>.age <span class="op" style="color: #5E5E5E;">+=</span> <span class="dv" style="color: #AD0000;">1</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="84700369-3ad4-4565-f86b-10eb90e39f15" data-execution_count="97">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="bu" style="color: null;">vars</span>(Person)[<span class="st" style="color: #20794D;">'name'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>&lt;__main__.LoggedAccess at 0x78b2edeb8950&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="7cac51e2-e623-48fd-8fb0-5a24e8eb9ec0" data-execution_count="98">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="bu" style="color: null;">vars</span>(<span class="bu" style="color: null;">vars</span>(Person)[<span class="st" style="color: #20794D;">'name'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>{'public_name': 'name', 'private_name': '_name'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="92758304-fcce-4f59-b09d-4b5e8bd02aae" data-execution_count="91">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="bu" style="color: null;">vars</span>(<span class="bu" style="color: null;">vars</span>(Person)[<span class="st" style="color: #20794D;">'age'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>{'public_name': 'age', 'private_name': '_age'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="1eaab803-e055-4a57-c28e-be9a86a91e4e" data-execution_count="92">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">pete <span class="op" style="color: #5E5E5E;">=</span> Person(<span class="st" style="color: #20794D;">'Peter P'</span>, <span class="dv" style="color: #AD0000;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Updating name to Peter P
Updating age to 10</code></pre>
</div>
</div>
<div class="cell" data-outputid="90fbd1f4-dd19-4e81-ddc0-fa6fc51f8cca" data-execution_count="93">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">kate <span class="op" style="color: #5E5E5E;">=</span> Person(<span class="st" style="color: #20794D;">'Catherine C'</span>, <span class="dv" style="color: #AD0000;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Updating name to Catherine C
Updating age to 20</code></pre>
</div>
</div>
<div class="cell" data-outputid="aa93dc1b-bbef-4bba-ec4f-adea7923f972" data-execution_count="94">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="bu" style="color: null;">vars</span>(pete)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>{'_name': 'Peter P', '_age': 10}</code></pre>
</div>
</div>
<div class="cell" data-outputid="b45e31dc-98a5-4fca-c3ab-f0f18e80416f" data-execution_count="95">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="bu" style="color: null;">vars</span>(kate)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>{'_name': 'Catherine C', '_age': 20}</code></pre>
</div>
</div>
<p>I think the main takeaway here is that we didn’t specify the name of the field so we could use the same descriptor for both <code>name</code> and <code>age</code>.</p>
</section>
<section id="closing-thoughts" class="level3">
<h3 class="anchored" data-anchor-id="closing-thoughts">Closing thoughts</h3>
<p>Looking at how <code>__set_name__</code> behaves (the example in the <a href="https://docs.python.org/3/reference/datamodel.html#object.__set_name__">docs</a>):</p>
<div class="cell" data-outputid="0db303bd-1e64-4471-940d-7dd8c37833e8" data-execution_count="103">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="kw" style="color: #003B4F;">class</span> C:</span>
<span id="cb67-2">    <span class="kw" style="color: #003B4F;">def</span> __set_name__(<span class="va" style="color: #111111;">self</span>, owner, name):</span>
<span id="cb67-3">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"__set_name__ called with owner=</span><span class="sc" style="color: #5E5E5E;">{</span>owner<span class="sc" style="color: #5E5E5E;">.</span><span class="va" style="color: #111111;">__name__</span><span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">, name='</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'"</span>)</span>
<span id="cb67-4">        <span class="va" style="color: #111111;">self</span>.name <span class="op" style="color: #5E5E5E;">=</span> name</span>
<span id="cb67-5"></span>
<span id="cb67-6"><span class="kw" style="color: #003B4F;">class</span> A:</span>
<span id="cb67-7">    x <span class="op" style="color: #5E5E5E;">=</span> C()  <span class="co" style="color: #5E5E5E;"># This will trigger __set_name__</span></span>
<span id="cb67-8">    y <span class="op" style="color: #5E5E5E;">=</span> C()  <span class="co" style="color: #5E5E5E;"># This will trigger it again with a different name</span></span>
<span id="cb67-9">    bananas <span class="op" style="color: #5E5E5E;">=</span> C()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set_name__ called with owner=A, name='x'
__set_name__ called with owner=A, name='y'
__set_name__ called with owner=A, name='bananas'</code></pre>
</div>
</div>
<div class="cell" data-outputid="940a7982-0418-4c1f-aa86-adf2fecace1f" data-execution_count="104">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1">a <span class="op" style="color: #5E5E5E;">=</span> A()</span>
<span id="cb69-2">a.x, a.y, a.x.name, a.y.name, a.bananas.name</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>(&lt;__main__.C at 0x78b331674190&gt;,
 &lt;__main__.C at 0x78b2df52ccd0&gt;,
 'x',
 'y',
 'bananas')</code></pre>
</div>
</div>
<p>The part of particular interest to me is:</p>
<blockquote class="blockquote">
<p>Descriptors are used throughout the language. It is how functions turn into bound methods.</p>
</blockquote>
</section>
</section>
<section id="complete-practical-example" class="level2">
<h2 class="anchored" data-anchor-id="complete-practical-example">Complete practical example</h2>
<section id="validator-class" class="level3">
<h3 class="anchored" data-anchor-id="validator-class">Validator class</h3>
<blockquote class="blockquote">
<p>A validator is a descriptor for managed attribute access. Prior to storing any data, it verifies that the new value meets various type and range restrictions. If those restrictions aren’t met, it raises an exception to prevent data corruption at its source.</p>
</blockquote>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="im" style="color: #00769E;">from</span> abc <span class="im" style="color: #00769E;">import</span> ABC, abstractmethod</span>
<span id="cb71-2"></span>
<span id="cb71-3"><span class="kw" style="color: #003B4F;">class</span> Validator(ABC):</span>
<span id="cb71-4"></span>
<span id="cb71-5">    <span class="kw" style="color: #003B4F;">def</span> __set_name__(<span class="va" style="color: #111111;">self</span>, owner, name):</span>
<span id="cb71-6">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"__set_name__ is called"</span>)</span>
<span id="cb71-7">        <span class="va" style="color: #111111;">self</span>.private_name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'_'</span> <span class="op" style="color: #5E5E5E;">+</span> name</span>
<span id="cb71-8"></span>
<span id="cb71-9">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb71-10">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"__get__ is called"</span>)</span>
<span id="cb71-11">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">getattr</span>(obj, <span class="va" style="color: #111111;">self</span>.private_name)</span>
<span id="cb71-12"></span>
<span id="cb71-13">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__set__</span>(<span class="va" style="color: #111111;">self</span>, obj, value):</span>
<span id="cb71-14">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"__set__ is called"</span>)</span>
<span id="cb71-15">        <span class="va" style="color: #111111;">self</span>.validate(value)</span>
<span id="cb71-16">        <span class="bu" style="color: null;">setattr</span>(obj, <span class="va" style="color: #111111;">self</span>.private_name, value)</span>
<span id="cb71-17"></span>
<span id="cb71-18">    <span class="at" style="color: #657422;">@abstractmethod</span></span>
<span id="cb71-19">    <span class="kw" style="color: #003B4F;">def</span> validate(<span class="va" style="color: #111111;">self</span>, value):</span>
<span id="cb71-20">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"validate is called"</span>)</span>
<span id="cb71-21">        <span class="cf" style="color: #003B4F;">pass</span></span></code></pre></div>
</div>
</section>
<section id="custom-validators" class="level3">
<h3 class="anchored" data-anchor-id="custom-validators">Custom validators</h3>
<blockquote class="blockquote">
<p>Here are three practical data validation utilities:</p>
<ol type="1">
<li><p><code>OneOf</code> verifies that a value is one of a restricted set of options.</p></li>
<li><p><code>Number</code> verifies that a value is either an int or float. Optionally, it verifies that a value is between a given minimum or maximum.</p></li>
<li><p><code>String</code> verifies that a value is a str. Optionally, it validates a given minimum or maximum length. It can validate a user-defined predicate as well.</p></li>
</ol>
</blockquote>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><span class="kw" style="color: #003B4F;">class</span> OneOf(Validator):</span>
<span id="cb72-2"></span>
<span id="cb72-3">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, <span class="op" style="color: #5E5E5E;">*</span>options):</span>
<span id="cb72-4">        <span class="va" style="color: #111111;">self</span>.options <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(options)</span>
<span id="cb72-5"></span>
<span id="cb72-6">    <span class="kw" style="color: #003B4F;">def</span> validate(<span class="va" style="color: #111111;">self</span>, value):</span>
<span id="cb72-7">        <span class="cf" style="color: #003B4F;">if</span> value <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.options:</span>
<span id="cb72-8">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-9">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be one of </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>options<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-10">            )</span>
<span id="cb72-11"></span>
<span id="cb72-12"><span class="kw" style="color: #003B4F;">class</span> Number(Validator):</span>
<span id="cb72-13"></span>
<span id="cb72-14">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, minvalue<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>, maxvalue<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb72-15">        <span class="va" style="color: #111111;">self</span>.minvalue <span class="op" style="color: #5E5E5E;">=</span> minvalue</span>
<span id="cb72-16">        <span class="va" style="color: #111111;">self</span>.maxvalue <span class="op" style="color: #5E5E5E;">=</span> maxvalue</span>
<span id="cb72-17"></span>
<span id="cb72-18">    <span class="kw" style="color: #003B4F;">def</span> validate(<span class="va" style="color: #111111;">self</span>, value):</span>
<span id="cb72-19">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> <span class="bu" style="color: null;">isinstance</span>(value, (<span class="bu" style="color: null;">int</span>, <span class="bu" style="color: null;">float</span>)):</span>
<span id="cb72-20">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">TypeError</span>(<span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be an int or float'</span>)</span>
<span id="cb72-21">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.minvalue <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span> <span class="kw" style="color: #003B4F;">and</span> value <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="va" style="color: #111111;">self</span>.minvalue:</span>
<span id="cb72-22">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-23">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be at least </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>minvalue<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-24">            )</span>
<span id="cb72-25">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.maxvalue <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span> <span class="kw" style="color: #003B4F;">and</span> value <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="va" style="color: #111111;">self</span>.maxvalue:</span>
<span id="cb72-26">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-27">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be no more than </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>maxvalue<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-28">            )</span>
<span id="cb72-29"></span>
<span id="cb72-30"><span class="kw" style="color: #003B4F;">class</span> String(Validator):</span>
<span id="cb72-31"></span>
<span id="cb72-32">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, minsize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>, maxsize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>, predicate<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb72-33">        <span class="va" style="color: #111111;">self</span>.minsize <span class="op" style="color: #5E5E5E;">=</span> minsize</span>
<span id="cb72-34">        <span class="va" style="color: #111111;">self</span>.maxsize <span class="op" style="color: #5E5E5E;">=</span> maxsize</span>
<span id="cb72-35">        <span class="va" style="color: #111111;">self</span>.predicate <span class="op" style="color: #5E5E5E;">=</span> predicate</span>
<span id="cb72-36"></span>
<span id="cb72-37">    <span class="kw" style="color: #003B4F;">def</span> validate(<span class="va" style="color: #111111;">self</span>, value):</span>
<span id="cb72-38">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> <span class="bu" style="color: null;">isinstance</span>(value, <span class="bu" style="color: null;">str</span>):</span>
<span id="cb72-39">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">TypeError</span>(<span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be an str'</span>)</span>
<span id="cb72-40">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.minsize <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span> <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(value) <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="va" style="color: #111111;">self</span>.minsize:</span>
<span id="cb72-41">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-42">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be no smaller than </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>minsize<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-43">            )</span>
<span id="cb72-44">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.maxsize <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span> <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(value) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="va" style="color: #111111;">self</span>.maxsize:</span>
<span id="cb72-45">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-46">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;"> to be no bigger than </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>maxsize<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-47">            )</span>
<span id="cb72-48">        <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.predicate <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span> <span class="kw" style="color: #003B4F;">and</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">self</span>.predicate(value):</span>
<span id="cb72-49">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(</span>
<span id="cb72-50">                <span class="ss" style="color: #20794D;">f'Expected </span><span class="sc" style="color: #5E5E5E;">{</span><span class="va" style="color: #111111;">self</span><span class="sc" style="color: #5E5E5E;">.</span>predicate<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> to be true for </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">!r}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb72-51">            )</span></code></pre></div>
</div>
</section>
<section id="practical-application" class="level3">
<h3 class="anchored" data-anchor-id="practical-application">Practical application</h3>
<div class="cell" data-outputid="a291dd22-396d-4771-ef6d-f9ccf1dd7aa8" data-execution_count="119">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="kw" style="color: #003B4F;">class</span> Component:</span>
<span id="cb73-2"></span>
<span id="cb73-3">    name <span class="op" style="color: #5E5E5E;">=</span> String(minsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>, maxsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>, predicate<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">str</span>.isupper)</span>
<span id="cb73-4">    kind <span class="op" style="color: #5E5E5E;">=</span> OneOf(<span class="st" style="color: #20794D;">'wood'</span>, <span class="st" style="color: #20794D;">'metal'</span>, <span class="st" style="color: #20794D;">'plastic'</span>)</span>
<span id="cb73-5">    quantity <span class="op" style="color: #5E5E5E;">=</span> Number(minvalue<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb73-6"></span>
<span id="cb73-7">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, name, kind, quantity):</span>
<span id="cb73-8">        <span class="va" style="color: #111111;">self</span>.name <span class="op" style="color: #5E5E5E;">=</span> name</span>
<span id="cb73-9">        <span class="va" style="color: #111111;">self</span>.kind <span class="op" style="color: #5E5E5E;">=</span> kind</span>
<span id="cb73-10">        <span class="va" style="color: #111111;">self</span>.quantity <span class="op" style="color: #5E5E5E;">=</span> quantity</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set_name__ is called
__set_name__ is called
__set_name__ is called</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>The descriptors prevent invalid instances from being created:</p>
</blockquote>
<div class="cell" data-outputid="3b846377-b1de-40cd-dc38-47f088d7bda6" data-execution_count="120">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1">Component(<span class="st" style="color: #20794D;">'Widget'</span>, <span class="st" style="color: #20794D;">'metal'</span>, <span class="dv" style="color: #AD0000;">5</span>)      <span class="co" style="color: #5E5E5E;"># Blocked: 'Widget' is not all uppercase</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set__ is called</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: Expected &lt;method 'isupper' of 'str' objects&gt; to be true for 'Widget'</code></pre>
</div>
</div>
<div class="cell" data-outputid="a1ff6411-3569-4dca-91df-dc09c8cfe544" data-execution_count="121">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">Component(<span class="st" style="color: #20794D;">'WIDGET'</span>, <span class="st" style="color: #20794D;">'metle'</span>, <span class="dv" style="color: #AD0000;">5</span>)      <span class="co" style="color: #5E5E5E;"># Blocked: 'metle' is misspelled</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set__ is called
__set__ is called</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: Expected 'metle' to be one of {'metal', 'plastic', 'wood'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="8b1180ca-b0c2-4911-a392-e358c0b51258" data-execution_count="122">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">Component(<span class="st" style="color: #20794D;">'WIDGET'</span>, <span class="st" style="color: #20794D;">'metal'</span>, <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">5</span>)     <span class="co" style="color: #5E5E5E;"># Blocked: -5 is negative</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set__ is called
__set__ is called
__set__ is called</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: Expected -5 to be at least 0</code></pre>
</div>
</div>
<div class="cell" data-outputid="f79c42d5-1ba2-48b0-a112-012fbf3be47b" data-execution_count="123">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1">Component(<span class="st" style="color: #20794D;">'WIDGET'</span>, <span class="st" style="color: #20794D;">'metal'</span>, <span class="st" style="color: #20794D;">'V'</span>)    <span class="co" style="color: #5E5E5E;"># Blocked: 'V' isn't a number</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set__ is called
__set__ is called
__set__ is called</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>TypeError: Expected 'V' to be an int or float</code></pre>
</div>
</div>
<div class="cell" data-outputid="b0422385-73be-45e5-b490-fe4632f4fe19" data-execution_count="124">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">c <span class="op" style="color: #5E5E5E;">=</span> Component(<span class="st" style="color: #20794D;">'WIDGET'</span>, <span class="st" style="color: #20794D;">'metal'</span>, <span class="dv" style="color: #AD0000;">5</span>)  <span class="co" style="color: #5E5E5E;"># Allowed:  The inputs are valid</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__set__ is called
__set__ is called
__set__ is called</code></pre>
</div>
</div>
<div class="cell" data-outputid="bdccab04-b422-445b-dd67-18994ae02b77" data-execution_count="125">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1">c.name</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ is called</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>'WIDGET'</code></pre>
</div>
</div>
</section>
</section>
<section id="technical-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="technical-tutorial">Technical tutorial</h2>
<p>After the reading the introduction of this guide I assumed I would skip the technical tutorial, expecting it to be too technical, but after skimming it I’ve decided to go through it as it might clear some things up for me and the following line was attractive:</p>
<blockquote class="blockquote">
<p>Learning about descriptors not only provides access to a larger toolset, it creates a deeper understanding of how Python works.</p>
</blockquote>
<section id="definition-and-introduction" class="level3">
<h3 class="anchored" data-anchor-id="definition-and-introduction">Definition and introduction</h3>
<p>Reiterating the important definition that a descriptor is anything that has one of the methods in the descriptor protocol:</p>
<blockquote class="blockquote">
<p>In general, a descriptor is an attribute value that has one of the methods in the descriptor protocol. Those methods are <code>__get__()</code>, <code>__set__()</code>, and <code>__delete__()</code>. If any of those methods are defined for an attribute, it is said to be a descriptor.</p>
</blockquote>
<p>And the main goal of descriptors:</p>
<blockquote class="blockquote">
<p>The default behavior for attribute access is to get, set, or delete the attribute from an object’s dictionary.</p>
</blockquote>
</section>
<section id="descriptor-protocol" class="level3">
<h3 class="anchored" data-anchor-id="descriptor-protocol">Descriptor protocol</h3>
<p>I don’t have any comments for this section other than reiterating the following points:</p>
<blockquote class="blockquote">
<p><code>descr.__get__(self, obj, type=None)</code></p>
<p><code>descr.__set__(self, obj, value)</code></p>
<p><code>descr.__delete__(self, obj)</code></p>
<p>That is all there is to it. Define any of these methods and an object is considered a descriptor and can override default behavior upon being looked up as an attribute.</p>
</blockquote>
<blockquote class="blockquote">
<p>If an object defines <code>__set__()</code> or <code>__delete__()</code>, it is considered a data descriptor. Descriptors that only define <code>__get__()</code> are called non-data descriptors (they are often used for methods but other uses are possible).</p>
</blockquote>
</section>
<section id="overview-of-descriptor-invocation" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-descriptor-invocation">Overview of descriptor invocation</h3>
<blockquote class="blockquote">
<p>A descriptor can be called directly with <code>desc.__get__(obj)</code> or <code>desc.__get__(None, cls)</code>.</p>
</blockquote>
<blockquote class="blockquote">
<p>But it is more common for a descriptor to be invoked automatically from attribute access.</p>
</blockquote>
<p>We saw this earlier, but putting that example here again:</p>
<div class="cell" data-outputid="4b62a4a6-552d-4080-eb17-deeba13a03de" data-execution_count="127">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="kw" style="color: #003B4F;">class</span> Ten2:</span>
<span id="cb92-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb92-3">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"__get__ called with obj=</span><span class="sc" style="color: #5E5E5E;">{</span>obj<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">, objtype=</span><span class="sc" style="color: #5E5E5E;">{</span>objtype<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb92-4">        <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb92-5"></span>
<span id="cb92-6"><span class="kw" style="color: #003B4F;">class</span> A2:</span>
<span id="cb92-7">    x <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">5</span></span>
<span id="cb92-8">    y <span class="op" style="color: #5E5E5E;">=</span> Ten2()  <span class="co" style="color: #5E5E5E;"># Descriptor instance</span></span>
<span id="cb92-9"></span>
<span id="cb92-10">a2 <span class="op" style="color: #5E5E5E;">=</span> A2()</span>
<span id="cb92-11">a2.y</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2ded96890&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>10</code></pre>
</div>
</div>
</section>
<section id="invocation-from-an-instance" class="level3">
<h3 class="anchored" data-anchor-id="invocation-from-an-instance">Invocation from an instance</h3>
<blockquote class="blockquote">
<p>Instance lookup scans through a chain of namespaces giving data descriptors the highest priority, followed by instance variables, then non-data descriptors, then class variables, and lastly <code>__getattr__()</code> if it is provided.</p>
</blockquote>
<p>I’ve added some print statements in their example code to show which option is triggered:</p>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><span class="kw" style="color: #003B4F;">def</span> find_name_in_mro(cls, name, default):</span>
<span id="cb95-2">    <span class="co" style="color: #5E5E5E;">"Emulate _PyType_Lookup() in Objects/typeobject.c"</span></span>
<span id="cb95-3">    <span class="cf" style="color: #003B4F;">for</span> base <span class="kw" style="color: #003B4F;">in</span> cls.__mro__:</span>
<span id="cb95-4">        <span class="cf" style="color: #003B4F;">if</span> name <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">vars</span>(base):</span>
<span id="cb95-5">            <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">vars</span>(base)[name]</span>
<span id="cb95-6">    <span class="cf" style="color: #003B4F;">return</span> default</span>
<span id="cb95-7"></span>
<span id="cb95-8"><span class="kw" style="color: #003B4F;">def</span> object_getattribute(obj, name):</span>
<span id="cb95-9">    <span class="co" style="color: #5E5E5E;">"Emulate PyObject_GenericGetAttr() in Objects/object.c"</span></span>
<span id="cb95-10">    null <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">object</span>()</span>
<span id="cb95-11">    objtype <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">type</span>(obj)</span>
<span id="cb95-12">    cls_var <span class="op" style="color: #5E5E5E;">=</span> find_name_in_mro(objtype, name, null)</span>
<span id="cb95-13">    descr_get <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(<span class="bu" style="color: null;">type</span>(cls_var), <span class="st" style="color: #20794D;">'__get__'</span>, null)</span>
<span id="cb95-14">    <span class="cf" style="color: #003B4F;">if</span> descr_get <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> null:</span>
<span id="cb95-15">        <span class="cf" style="color: #003B4F;">if</span> (<span class="bu" style="color: null;">hasattr</span>(<span class="bu" style="color: null;">type</span>(cls_var), <span class="st" style="color: #20794D;">'__set__'</span>)</span>
<span id="cb95-16">            <span class="kw" style="color: #003B4F;">or</span> <span class="bu" style="color: null;">hasattr</span>(<span class="bu" style="color: null;">type</span>(cls_var), <span class="st" style="color: #20794D;">'__delete__'</span>)):</span>
<span id="cb95-17">            <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"returning data descriptor set/delete"</span>)</span>
<span id="cb95-18">            <span class="cf" style="color: #003B4F;">return</span> descr_get(cls_var, obj, objtype)     <span class="co" style="color: #5E5E5E;"># data descriptor</span></span>
<span id="cb95-19">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(obj, <span class="st" style="color: #20794D;">'__dict__'</span>) <span class="kw" style="color: #003B4F;">and</span> name <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">vars</span>(obj):</span>
<span id="cb95-20">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"returning instance variable"</span>)</span>
<span id="cb95-21">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">vars</span>(obj)[name]                          <span class="co" style="color: #5E5E5E;"># instance variable</span></span>
<span id="cb95-22">    <span class="cf" style="color: #003B4F;">if</span> descr_get <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> null:</span>
<span id="cb95-23">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"returning descr_get"</span>)</span>
<span id="cb95-24">        <span class="cf" style="color: #003B4F;">return</span> descr_get(cls_var, obj, objtype)         <span class="co" style="color: #5E5E5E;"># non-data descriptor</span></span>
<span id="cb95-25">    <span class="cf" style="color: #003B4F;">if</span> cls_var <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> null:</span>
<span id="cb95-26">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"returning class variable"</span>)</span>
<span id="cb95-27">        <span class="cf" style="color: #003B4F;">return</span> cls_var                                  <span class="co" style="color: #5E5E5E;"># class variable</span></span>
<span id="cb95-28">    <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">AttributeError</span>(name)</span></code></pre></div>
</div>
<div class="cell" data-outputid="7624e6f8-8312-40d2-9c43-178a8e8a5655" data-execution_count="139">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1">object_getattribute(a2, <span class="st" style="color: #20794D;">'y'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>returning descr_get
__get__ called with obj=&lt;__main__.A2 object at 0x78b2ded96890&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>10</code></pre>
</div>
</div>
<div class="cell" data-outputid="588ae176-621c-4ae7-b37c-c7a616007844" data-execution_count="140">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">object_getattribute(a2, <span class="st" style="color: #20794D;">'x'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>returning class variable</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>5</code></pre>
</div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><span class="kw" style="color: #003B4F;">def</span> getattr_hook(obj, name):</span>
<span id="cb102-2">    <span class="co" style="color: #5E5E5E;">"Emulate slot_tp_getattr_hook() in Objects/typeobject.c"</span></span>
<span id="cb102-3">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb102-4">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"__getattribute__"</span>)</span>
<span id="cb102-5">        <span class="cf" style="color: #003B4F;">return</span> obj.<span class="fu" style="color: #4758AB;">__getattribute__</span>(name)</span>
<span id="cb102-6">    <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">AttributeError</span>:</span>
<span id="cb102-7">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> <span class="bu" style="color: null;">hasattr</span>(<span class="bu" style="color: null;">type</span>(obj), <span class="st" style="color: #20794D;">'__getattr__'</span>):</span>
<span id="cb102-8">            <span class="cf" style="color: #003B4F;">raise</span></span>
<span id="cb102-9">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"__getattr__"</span>)</span>
<span id="cb102-10">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">type</span>(obj).<span class="fu" style="color: #4758AB;">__getattr__</span>(obj, name)</span></code></pre></div>
</div>
<div class="cell" data-outputid="0aabb2c0-7a6d-416b-893c-47b6c94dd29e" data-execution_count="146">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">getattr_hook(a2, <span class="st" style="color: #20794D;">'y'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__getattribute__
__get__ called with obj=&lt;__main__.A2 object at 0x78b2ded96890&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre><code>10</code></pre>
</div>
</div>
<div class="cell" data-outputid="f95a8401-3380-4234-b372-e43d61463745" data-execution_count="147">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1">getattr_hook(a2, <span class="st" style="color: #20794D;">'x'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__getattribute__</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>5</code></pre>
</div>
</div>
</section>
<section id="invocation-from-a-class" class="level3">
<h3 class="anchored" data-anchor-id="invocation-from-a-class">Invocation from a class</h3>
<blockquote class="blockquote">
<p>The logic for a dotted lookup such as <code>A.x</code> is in <code>type.__getattribute__()</code>.</p>
</blockquote>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1">A2.<span class="fu" style="color: #4758AB;">__getattribute__</span>??</span></code></pre></div>
</div>
<pre><code>Signature:   A2.__getattribute__(*args, **kwargs)
Type:        wrapper_descriptor
String form: &lt;slot wrapper '__getattribute__' of 'object' objects&gt;
Docstring:   Return getattr(self, name).</code></pre>
<div class="cell" data-outputid="a7e35d14-2e01-4cb6-f616-cc491f83a923" data-execution_count="152">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1">A2.<span class="fu" style="color: #4758AB;">__getattribute__</span>(A2, <span class="st" style="color: #20794D;">'y'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>&lt;__main__.Ten2 at 0x78b2dee79310&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="da9fcb9a-e92a-4040-eaee-008bfaff133b" data-execution_count="153">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1">A2.<span class="fu" style="color: #4758AB;">__getattribute__</span>(A2, <span class="st" style="color: #20794D;">'x'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>5</code></pre>
</div>
</div>
</section>
<section id="invocation-from-super" class="level3">
<h3 class="anchored" data-anchor-id="invocation-from-super">Invocation from super</h3>
<blockquote class="blockquote">
<p>A dotted lookup such as <code>super(A, obj).m</code> searches <code>obj.__class__.__mro__</code> for the base class <code>B</code> immediately following <code>A</code> and then returns <code>B.__dict__['m'].__get__(obj, A)</code>. If not a descriptor, <code>m</code> is returned unchanged.</p>
</blockquote>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><span class="kw" style="color: #003B4F;">class</span> Base:</span>
<span id="cb115-2">    z <span class="op" style="color: #5E5E5E;">=</span> Ten2()  <span class="co" style="color: #5E5E5E;"># Descriptor in the base class</span></span>
<span id="cb115-3"></span>
<span id="cb115-4"><span class="kw" style="color: #003B4F;">class</span> A2(Base):</span>
<span id="cb115-5">    x <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">5</span></span>
<span id="cb115-6">    y <span class="op" style="color: #5E5E5E;">=</span> Ten2()  <span class="co" style="color: #5E5E5E;"># Descriptor instance in A2</span></span>
<span id="cb115-7"></span>
<span id="cb115-8">    <span class="kw" style="color: #003B4F;">def</span> show_super_lookup(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb115-9">        <span class="co" style="color: #5E5E5E;"># This will trigger the descriptor lookup through super()</span></span>
<span id="cb115-10">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">super</span>().z</span></code></pre></div>
</div>
<div class="cell" data-outputid="31c162b5-50cb-4d2f-aeab-40bc3a875242" data-execution_count="176">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1">a <span class="op" style="color: #5E5E5E;">=</span> A2()</span>
<span id="cb116-2">a.y</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2dededa90&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="176">
<pre><code>10</code></pre>
</div>
</div>
<div class="cell" data-outputid="506d9028-2db4-425b-e3e3-2dadd34ff683" data-execution_count="177">
<div class="sourceCode cell-code" id="cb119" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><span class="bu" style="color: null;">super</span>(A2, a).z</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2dededa90&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>10</code></pre>
</div>
</div>
<div class="cell" data-outputid="f4e57871-b58e-4058-ca54-b2d696eca82e" data-execution_count="178">
<div class="sourceCode cell-code" id="cb122" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1">Base.__dict__[<span class="st" style="color: #20794D;">'z'</span>].<span class="fu" style="color: #4758AB;">__get__</span>(a, A2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2dededa90&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="178">
<pre><code>10</code></pre>
</div>
</div>
<div class="cell" data-outputid="b2270d8e-31ea-4f77-d03f-f9679b1e541e" data-execution_count="179">
<div class="sourceCode cell-code" id="cb125" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1">a.__class__.__mro__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="179">
<pre><code>(__main__.A2, __main__.Base, object)</code></pre>
</div>
</div>
</section>
<section id="summary-of-invocation-logic" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-invocation-logic">Summary of invocation logic</h3>
<p>Showing examples of some of the bullet points in the summary:</p>
<ul>
<li>Descriptors are invoked by the <code>__getattribute__()</code> method.</li>
</ul>
<div class="cell" data-outputid="ea38ba47-a928-4128-a1fb-cbc231fa3a35" data-execution_count="180">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1">a.<span class="fu" style="color: #4758AB;">__getattribute__</span>(<span class="st" style="color: #20794D;">'y'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.A2 object at 0x78b2dededa90&gt;, objtype=&lt;class '__main__.A2'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="180">
<pre><code>10</code></pre>
</div>
</div>
<ul>
<li>Overriding <code>__getattribute__()</code> prevents automatic descriptor calls because all the descriptor logic is in that method.</li>
</ul>
<div class="cell" data-outputid="68ac78c2-2ec1-4ee6-f840-32491435634e" data-execution_count="195">
<div class="sourceCode cell-code" id="cb130" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><span class="kw" style="color: #003B4F;">class</span> MyDescriptor:</span>
<span id="cb130-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb130-3">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Descriptor __get__ called!"</span>)</span>
<span id="cb130-4">        <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">42</span></span>
<span id="cb130-5"></span>
<span id="cb130-6"><span class="kw" style="color: #003B4F;">class</span> Normal:</span>
<span id="cb130-7">    x <span class="op" style="color: #5E5E5E;">=</span> MyDescriptor()</span>
<span id="cb130-8"></span>
<span id="cb130-9">n <span class="op" style="color: #5E5E5E;">=</span> Normal()</span>
<span id="cb130-10">n.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Descriptor __get__ called!</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="195">
<pre><code>42</code></pre>
</div>
</div>
<div class="cell" data-outputid="4c3bfd01-d824-4254-9e21-daf3ab13b60b" data-execution_count="196">
<div class="sourceCode cell-code" id="cb133" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><span class="kw" style="color: #003B4F;">class</span> OverrideGetattribute:</span>
<span id="cb133-2">    x <span class="op" style="color: #5E5E5E;">=</span> MyDescriptor()</span>
<span id="cb133-3">    y <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">5</span></span>
<span id="cb133-4"></span>
<span id="cb133-5">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__getattribute__</span>(<span class="va" style="color: #111111;">self</span>, name):</span>
<span id="cb133-6">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Custom __getattribute__ called for </span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb133-7">        <span class="cf" style="color: #003B4F;">if</span> name <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'x'</span>:</span>
<span id="cb133-8">            <span class="cf" style="color: #003B4F;">return</span> <span class="st" style="color: #20794D;">"Bypassed descriptor"</span></span>
<span id="cb133-9">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">object</span>.<span class="fu" style="color: #4758AB;">__getattribute__</span>(<span class="va" style="color: #111111;">self</span>, name)</span>
<span id="cb133-10"></span>
<span id="cb133-11">o <span class="op" style="color: #5E5E5E;">=</span> OverrideGetattribute()</span>
<span id="cb133-12">o.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Custom __getattribute__ called for x</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="196">
<pre><code>'Bypassed descriptor'</code></pre>
</div>
</div>
<div class="cell" data-outputid="db10e098-648b-42ca-8ca4-51a062eb62c8" data-execution_count="197">
<div class="sourceCode cell-code" id="cb136" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1">o.y</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Custom __getattribute__ called for y</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="197">
<pre><code>5</code></pre>
</div>
</div>
<ul>
<li><code>object.__getattribute__()</code> and <code>type.__getattribute__()</code> make different calls to <code>__get__()</code>. The first includes the instance and may include the class. The second puts in <code>None</code> for the instance and always includes the class.</li>
</ul>
<div class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb139" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><span class="kw" style="color: #003B4F;">class</span> DetailedDescriptor:</span>
<span id="cb139-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb139-3">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"__get__ called with obj=</span><span class="sc" style="color: #5E5E5E;">{</span>obj<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">, objtype=</span><span class="sc" style="color: #5E5E5E;">{</span>objtype<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb139-4">        <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">42</span></span>
<span id="cb139-5"></span>
<span id="cb139-6"><span class="kw" style="color: #003B4F;">class</span> Normal:</span>
<span id="cb139-7">    x <span class="op" style="color: #5E5E5E;">=</span> DetailedDescriptor()</span>
<span id="cb139-8"></span>
<span id="cb139-9">n <span class="op" style="color: #5E5E5E;">=</span> Normal()</span></code></pre></div>
</div>
<div class="cell" data-outputid="0d60c5f0-9623-4c6f-ccb4-fbcddfa7a428" data-execution_count="209">
<div class="sourceCode cell-code" id="cb140" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1">n.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=&lt;__main__.Normal object at 0x78b2dedf0750&gt;, objtype=&lt;class '__main__.Normal'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="209">
<pre><code>42</code></pre>
</div>
</div>
<div class="cell" data-outputid="cc7f4537-465e-48e7-c91d-0060eac405d9" data-execution_count="210">
<div class="sourceCode cell-code" id="cb143" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1">Normal.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>__get__ called with obj=None, objtype=&lt;class '__main__.Normal'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="210">
<pre><code>42</code></pre>
</div>
</div>
<ul>
<li>Data descriptors always override instance dictionaries.</li>
</ul>
<div class="cell" data-execution_count="211">
<div class="sourceCode cell-code" id="cb146" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><span class="kw" style="color: #003B4F;">class</span> DataDescriptor:</span>
<span id="cb146-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, initial_value<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb146-3">        <span class="va" style="color: #111111;">self</span>.value <span class="op" style="color: #5E5E5E;">=</span> initial_value</span>
<span id="cb146-4"></span>
<span id="cb146-5">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb146-6">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"DataDescriptor.__get__ called"</span>)</span>
<span id="cb146-7">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span>.value</span>
<span id="cb146-8"></span>
<span id="cb146-9">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__set__</span>(<span class="va" style="color: #111111;">self</span>, obj, value):</span>
<span id="cb146-10">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"DataDescriptor.__set__ called with value: </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb146-11">        <span class="va" style="color: #111111;">self</span>.value <span class="op" style="color: #5E5E5E;">=</span> value</span>
<span id="cb146-12"></span>
<span id="cb146-13"><span class="kw" style="color: #003B4F;">class</span> Example:</span>
<span id="cb146-14">    x <span class="op" style="color: #5E5E5E;">=</span> DataDescriptor(<span class="dv" style="color: #AD0000;">42</span>)  <span class="co" style="color: #5E5E5E;"># Data descriptor defined in class</span></span>
<span id="cb146-15"></span>
<span id="cb146-16">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb146-17">        <span class="co" style="color: #5E5E5E;"># Try to override with instance attribute</span></span>
<span id="cb146-18">        <span class="va" style="color: #111111;">self</span>.__dict__[<span class="st" style="color: #20794D;">'x'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Instance value"</span></span>
<span id="cb146-19"></span>
<span id="cb146-20"></span>
<span id="cb146-21">example <span class="op" style="color: #5E5E5E;">=</span> Example()</span></code></pre></div>
</div>
<div class="cell" data-outputid="1733a8ce-6f53-4e41-9649-7fa4ddd997f3" data-execution_count="212">
<div class="sourceCode cell-code" id="cb147" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1">example.__dict__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="212">
<pre><code>{'x': 'Instance value'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="1d03bcd6-c2b8-4c63-cbfc-cc7c91dbe214" data-execution_count="213">
<div class="sourceCode cell-code" id="cb149" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1">example.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataDescriptor.__get__ called</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="213">
<pre><code>42</code></pre>
</div>
</div>
<div class="cell" data-outputid="11962f2b-4023-4831-cbb2-cff4a1d85fa1" data-execution_count="215">
<div class="sourceCode cell-code" id="cb152" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1">example.x <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">100</span></span>
<span id="cb152-2">example.__dict__[<span class="st" style="color: #20794D;">'x'</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataDescriptor.__set__ called with value: 100</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="215">
<pre><code>'Instance value'</code></pre>
</div>
</div>
<div class="cell" data-outputid="b74e3010-a30c-4e4e-b9e3-6d8ddee5a1e8" data-execution_count="216">
<div class="sourceCode cell-code" id="cb155" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1">example.x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataDescriptor.__get__ called</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="216">
<pre><code>100</code></pre>
</div>
</div>
<ul>
<li>Non-data descriptors may be overridden by instance dictionaries.</li>
</ul>
<div class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb158" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><span class="kw" style="color: #003B4F;">class</span> NonDataDescriptor:</span>
<span id="cb158-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, initial_value<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb158-3">        <span class="va" style="color: #111111;">self</span>.value <span class="op" style="color: #5E5E5E;">=</span> initial_value</span>
<span id="cb158-4"></span>
<span id="cb158-5">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb158-6">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"DataDescriptor.__get__ called"</span>)</span>
<span id="cb158-7">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span>.value</span>
<span id="cb158-8"></span>
<span id="cb158-9"><span class="kw" style="color: #003B4F;">class</span> Example:</span>
<span id="cb158-10">    x <span class="op" style="color: #5E5E5E;">=</span> NonDataDescriptor(<span class="dv" style="color: #AD0000;">42</span>)  <span class="co" style="color: #5E5E5E;"># Data descriptor defined in class</span></span>
<span id="cb158-11"></span>
<span id="cb158-12">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb158-13">        <span class="co" style="color: #5E5E5E;"># Try to override with instance attribute</span></span>
<span id="cb158-14">        <span class="va" style="color: #111111;">self</span>.__dict__[<span class="st" style="color: #20794D;">'x'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Instance value"</span></span>
<span id="cb158-15"></span>
<span id="cb158-16"></span>
<span id="cb158-17">example <span class="op" style="color: #5E5E5E;">=</span> Example()</span></code></pre></div>
</div>
<div class="cell" data-outputid="2e68841b-5462-42ae-d551-9bda604be404" data-execution_count="218">
<div class="sourceCode cell-code" id="cb159" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1">example.__dict__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="218">
<pre><code>{'x': 'Instance value'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="01acab7f-edb3-4c11-e650-0fa57a156ceb" data-execution_count="219">
<div class="sourceCode cell-code" id="cb161" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1">example.x</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="219">
<pre><code>'Instance value'</code></pre>
</div>
</div>
</section>
<section id="automatic-name-notification" class="level3">
<h3 class="anchored" data-anchor-id="automatic-name-notification">Automatic name notification</h3>
<blockquote class="blockquote">
<p>Sometimes it is desirable for a descriptor to know what class variable name it was assigned to. When a new class is created, the <code>type</code> metaclass scans the dictionary of the new class. If any of the entries are descriptors and if they define <code>__set_name__()</code>, that method is called with two arguments. The owner is the class where the descriptor is used, and the name is the class variable the descriptor was assigned to.</p>
</blockquote>
<div class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb163" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><span class="kw" style="color: #003B4F;">class</span> NameTracker:</span>
<span id="cb163-2">   <span class="kw" style="color: #003B4F;">def</span> __set_name__(<span class="va" style="color: #111111;">self</span>, owner, name): <span class="va" style="color: #111111;">self</span>.name <span class="op" style="color: #5E5E5E;">=</span> name</span></code></pre></div>
</div>
<div class="cell" data-execution_count="228">
<div class="sourceCode cell-code" id="cb164" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1">class_dict <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb164-2">        <span class="st" style="color: #20794D;">'x'</span>: NameTracker(),</span>
<span id="cb164-3">        <span class="st" style="color: #20794D;">'y'</span>: NameTracker(),</span>
<span id="cb164-4">        <span class="st" style="color: #20794D;">'z'</span>: <span class="dv" style="color: #AD0000;">5</span></span>
<span id="cb164-5">    }</span></code></pre></div>
</div>
<div class="cell" data-execution_count="229">
<div class="sourceCode cell-code" id="cb165" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1">Demo <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">type</span>(<span class="st" style="color: #20794D;">'Demo'</span>, (), class_dict)</span></code></pre></div>
</div>
<div class="cell" data-outputid="c1ee1f3c-ddbe-4e35-bced-a11f96ae3cc4" data-execution_count="231">
<div class="sourceCode cell-code" id="cb166" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1">Demo.x.name</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">
<pre><code>'x'</code></pre>
</div>
</div>
<div class="cell" data-outputid="b3867517-a51b-4675-b24b-70b33ce13579" data-execution_count="232">
<div class="sourceCode cell-code" id="cb168" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1">Demo.y.name</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="232">
<pre><code>'y'</code></pre>
</div>
</div>
<p>I’m skipping the ORM example since I don’t have access to the example database.</p>
</section>
</section>
<section id="pure-python-equivalents" class="level2">
<h2 class="anchored" data-anchor-id="pure-python-equivalents">Pure Python Equivalents</h2>
<p>Finally! The section I’m most interested in.</p>
<blockquote class="blockquote">
<p>Properties, bound methods, static methods, class methods, and <code>__slots__</code> are all based on the descriptor protocol.</p>
</blockquote>
<p>I’m going to focus on the functions and methods section.</p>
<section id="functions-and-methods" class="level3">
<h3 class="anchored" data-anchor-id="functions-and-methods">Functions and methods</h3>
<blockquote class="blockquote">
<p>Functions stored in class dictionaries get turned into methods when invoked. Methods only differ from regular functions in that the object instance is prepended to the other arguments. By convention, the instance is called self but could be called this or any other variable name.</p>
</blockquote>
<blockquote class="blockquote">
<p>Methods can be created manually with types.MethodType which is roughly equivalent to:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb170" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><span class="kw" style="color: #003B4F;">class</span> MethodType:</span>
<span id="cb170-2">    <span class="co" style="color: #5E5E5E;">"Emulate PyMethod_Type in Objects/classobject.c"</span></span>
<span id="cb170-3"></span>
<span id="cb170-4">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, func, obj):</span>
<span id="cb170-5">        <span class="va" style="color: #111111;">self</span>.__func__ <span class="op" style="color: #5E5E5E;">=</span> func</span>
<span id="cb170-6">        <span class="va" style="color: #111111;">self</span>.__self__ <span class="op" style="color: #5E5E5E;">=</span> obj</span>
<span id="cb170-7"></span>
<span id="cb170-8">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__call__</span>(<span class="va" style="color: #111111;">self</span>, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs):</span>
<span id="cb170-9">        func <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.__func__</span>
<span id="cb170-10">        obj <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.__self__</span>
<span id="cb170-11">        <span class="cf" style="color: #003B4F;">return</span> func(obj, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs)</span>
<span id="cb170-12"></span>
<span id="cb170-13">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__getattribute__</span>(<span class="va" style="color: #111111;">self</span>, name):</span>
<span id="cb170-14">        <span class="co" style="color: #5E5E5E;">"Emulate method_getset() in Objects/classobject.c"</span></span>
<span id="cb170-15">        <span class="cf" style="color: #003B4F;">if</span> name <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'__doc__'</span>:</span>
<span id="cb170-16">            <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span>.__func__.__doc__</span>
<span id="cb170-17">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">object</span>.<span class="fu" style="color: #4758AB;">__getattribute__</span>(<span class="va" style="color: #111111;">self</span>, name)</span>
<span id="cb170-18"></span>
<span id="cb170-19">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__getattr__</span>(<span class="va" style="color: #111111;">self</span>, name):</span>
<span id="cb170-20">        <span class="co" style="color: #5E5E5E;">"Emulate method_getattro() in Objects/classobject.c"</span></span>
<span id="cb170-21">        <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">getattr</span>(<span class="va" style="color: #111111;">self</span>.__func__, name)</span>
<span id="cb170-22"></span>
<span id="cb170-23">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb170-24">        <span class="co" style="color: #5E5E5E;">"Emulate method_descr_get() in Objects/classobject.c"</span></span>
<span id="cb170-25">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span></span></code></pre></div>
</div>
<p>The key dunder method of interest is <code>__call</code>__:</p>
<div class="sourceCode" id="cb171" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__call__</span>(<span class="va" style="color: #111111;">self</span>, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs):</span>
<span id="cb171-2">    func <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.__func__</span>
<span id="cb171-3">    obj <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.__self__</span>
<span id="cb171-4">    <span class="cf" style="color: #003B4F;">return</span> func(obj, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs)</span></code></pre></div>
<p>In the example of the self attention module, it has no positional arguments <code>*args</code> and so when I passed <code>self_attn</code> to the <code>obj</code> parameter in <code>func(obj, *args, **kwargs)</code> it understood it to be the first keyword argument.</p>
<blockquote class="blockquote">
<p>The interesting behavior occurs during dotted access from an instance. The dotted lookup calls <strong>get</strong>() which returns a bound method object:</p>
</blockquote>
<div class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb172" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><span class="kw" style="color: #003B4F;">class</span> D:</span>
<span id="cb172-2">    <span class="kw" style="color: #003B4F;">def</span> f(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb172-3">         <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="d7863453-4518-4486-909a-226a3a4b8b2c" data-execution_count="238">
<div class="sourceCode cell-code" id="cb173" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1">d <span class="op" style="color: #5E5E5E;">=</span> D()</span>
<span id="cb173-2"><span class="bu" style="color: null;">print</span>(d.f)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;bound method D.f of &lt;__main__.D object at 0x78b2dec54790&gt;&gt;</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Internally, the bound method stores the underlying function and the bound instance:</p>
</blockquote>
<div class="cell" data-outputid="e01f04f2-79f4-4fb7-df6d-734f9a3490e7" data-execution_count="240">
<div class="sourceCode cell-code" id="cb175" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><span class="bu" style="color: null;">print</span>(d.f.__func__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;function D.f at 0x78b2dedd3ba0&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="be868138-560a-4319-d92a-2572e6d78318" data-execution_count="241">
<div class="sourceCode cell-code" id="cb177" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><span class="bu" style="color: null;">print</span>(d.f.__self__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;__main__.D object at 0x78b2dec54790&gt;</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>If you have ever wondered where <code>self</code> comes from in regular methods or where <code>cls</code> comes from in class methods, this is it!</p>
</blockquote>
</section>
<section id="kinds-of-methods" class="level3">
<h3 class="anchored" data-anchor-id="kinds-of-methods">Kinds of methods</h3>
<p>Here’s the crux of what I was looking for:</p>
<blockquote class="blockquote">
<p>To recap, functions have a <code>__get__()</code> method so that they can be converted to a method when accessed as attributes. The non-data descriptor transforms an <code>obj.f(*args</code>) call into <code>f(obj, *args)</code>. Calling <code>cls.f(*args)</code> becomes <code>f(*args)</code>.</p>
</blockquote>
<p>If I call <code>__get__(d)</code> on <code>d.f</code> it creates a bound method which passes in the object as <code>self</code>, the first argument of a bound method.</p>
<div class="cell" data-outputid="881f67c4-ba12-49a2-f010-d585a5594103" data-execution_count="243">
<div class="sourceCode cell-code" id="cb179" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><span class="bu" style="color: null;">print</span>(d.f.<span class="fu" style="color: #4758AB;">__get__</span>(d))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;bound method D.f of &lt;__main__.D object at 0x78b2dec54790&gt;&gt;</code></pre>
</div>
</div>
<p>Now when I call <code>d.f.__get__(d)()</code> I don’t need to explicitly pass in the object:</p>
<div class="cell" data-outputid="b9d99ad4-baa0-4101-b3bc-a8de2a759be3" data-execution_count="244">
<div class="sourceCode cell-code" id="cb181" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1">d.f.<span class="fu" style="color: #4758AB;">__get__</span>(d)()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="244">
<pre><code>&lt;__main__.D at 0x78b2dec54790&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Thanks to vibe coding, Claude introduced me to Python behavior I was unfamiliar with, and thanks to the excellent Python documentation, I understood it at a much deeper level than I was planning to.</p>
<p>I think something that still confuses me, and where I feel empathy for <a href="https://discuss.python.org/t/changing-the-name-of-get-to-bind/14243">this poster</a>, is how <code>__get__</code> has special behavior for functions where it binds it to the given object.</p>
<p>In the Primer, initial examples of <code>__get__</code> all, well, get a value:</p>
<div class="sourceCode" id="cb183" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb183-2">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"__get__ called with obj=</span><span class="sc" style="color: #5E5E5E;">{</span>obj<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">, objtype=</span><span class="sc" style="color: #5E5E5E;">{</span>objtype<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb183-3">    <span class="cf" style="color: #003B4F;">return</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb183-4"></span>
<span id="cb183-5"></span>
<span id="cb183-6"><span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb183-7">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">len</span>(os.listdir(obj.dirname))</span>
<span id="cb183-8"></span>
<span id="cb183-9"></span>
<span id="cb183-10"><span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__get__</span>(<span class="va" style="color: #111111;">self</span>, obj, objtype<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb183-11">    value <span class="op" style="color: #5E5E5E;">=</span> obj._age</span>
<span id="cb183-12">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Accessing age giving </span><span class="sc" style="color: #5E5E5E;">{</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb183-13">    <span class="cf" style="color: #003B4F;">return</span> value</span></code></pre></div>
<p>How that behavior is related to binding a function to an object is beyond my current understanding.</p>
<p>This poster’s response does make sense:</p>
<blockquote class="blockquote">
<p>If descriptors were only callables that bind as methods when accessed as an attribute, then perhaps <code>__bind__()</code> would be a reasonable name for the method. But the descriptor protocol (i.e.&nbsp;<code>__get__</code>, <code>__set__</code>, and <code>__delete__</code>) is a means of implementing a computed attribute in general, which is not necessarily about binding a callable to the instance or type. For example, the <code>__get__()</code> method of a property named <code>x</code> might return the instance attribute <code>_x</code>.</p>
</blockquote>
<p>So perhaps of a computed attributed is generalizable whether your using <code>__get__</code> on a callable descriptor or otherwise. For a function, the “computation” of the attribute is binding it to the object.</p>
<p>I hope you enjoyed this blog post! I’m trying to <a href="https://www.youtube.com/@vishal_learner">grow my YouTube channel</a> so please give that a look/subscribe.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-04-01-Python-Descriptor/index.html</guid>
  <pubDate>Tue, 01 Apr 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>TIL: Creating a Custom Composer Callback</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-03-30-Composer-Callback/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I’m learning to use LLM-Foundry to finetune SLMs. To better understand what’s going on in the training loop when using Flash Attention 2 (for SmolLM2-135M), I decided to ask Claude to write me a custom callback. Here is my <a href="https://claude.ai/share/9bb6c135-2ffb-42be-91bc-b4e4a6356173">full Claude conversation</a>.</p>
</section>
<section id="initial-plan" class="level2">
<h2 class="anchored" data-anchor-id="initial-plan">Initial Plan</h2>
<p>At first, I was planning to fork Composer (which I did), create a new branch for edits (print statements of datatypes in the <code>Trainer</code> code), and install that repo/branch for training. However, as I was chatting with Claude, it offered an option to write a callback instead. Being that <a href="https://docs.mosaicml.com/projects/composer/en/stable/getting_started/welcome_tour.html#:~:text=This%20is%20based%20on%20the%20two%2Dway%20callback%20system%20from%20(Howard%20et%20al%2C%202020)">this is a core philosophy of how Composer is built</a>, it was a no brainer for me to pursue.</p>
</section>
<section id="first-callback" class="level2">
<h2 class="anchored" data-anchor-id="first-callback">First Callback</h2>
<p>The first callback Claude wrote (I guided it a little bit by feeding it Composer’s <code>trainer.py</code> and giving it their callback example from the docs) was as follows:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;">class</span> WeightDtypeMonitor(Callback):</span>
<span id="cb1-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, backward_log_interval<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5</span>):</span>
<span id="cb1-3">        <span class="va" style="color: #111111;">self</span>.backward_log_interval <span class="op" style="color: #5E5E5E;">=</span> backward_log_interval</span>
<span id="cb1-4">    </span>
<span id="cb1-5">    <span class="kw" style="color: #003B4F;">def</span> fit_start(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-6">        <span class="va" style="color: #111111;">self</span>._log_dtypes(state, logger, <span class="st" style="color: #20794D;">"fit_start"</span>)</span>
<span id="cb1-7">    </span>
<span id="cb1-8">    <span class="kw" style="color: #003B4F;">def</span> after_backward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-9">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.backward_log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb1-10">            <span class="va" style="color: #111111;">self</span>._log_dtypes(state, logger, <span class="ss" style="color: #20794D;">f"backward_</span><span class="sc" style="color: #5E5E5E;">{</span>state<span class="sc" style="color: #5E5E5E;">.</span>timestamp<span class="sc" style="color: #5E5E5E;">.</span>batch<span class="sc" style="color: #5E5E5E;">.</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-11">    </span>
<span id="cb1-12">    <span class="kw" style="color: #003B4F;">def</span> epoch_end(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-13">        <span class="va" style="color: #111111;">self</span>._log_dtypes(state, logger, <span class="ss" style="color: #20794D;">f"epoch_</span><span class="sc" style="color: #5E5E5E;">{</span>state<span class="sc" style="color: #5E5E5E;">.</span>timestamp<span class="sc" style="color: #5E5E5E;">.</span>epoch<span class="sc" style="color: #5E5E5E;">.</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb1-14">    </span>
<span id="cb1-15">    <span class="kw" style="color: #003B4F;">def</span> _log_dtypes(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger, prefix: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb1-16">        model <span class="op" style="color: #5E5E5E;">=</span> state.model</span>
<span id="cb1-17">        logger.log_metrics({</span>
<span id="cb1-18">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/lm_head"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.lm_head.weight.dtype),</span>
<span id="cb1-19">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_base"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.base_layer.weight.dtype),</span>
<span id="cb1-20">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_lora_A"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.lora_A.default.weight.dtype),</span>
<span id="cb1-21">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_lora_B"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.lora_B.default.weight.dtype)</span>
<span id="cb1-22">        })</span></code></pre></div>
<p>For reference, here is the list of events available in Composer during the training loop:</p>
<pre><code># &lt;INIT&gt;
# &lt;BEFORE_LOAD&gt;
# &lt;AFTER_LOAD&gt;
# &lt;FIT_START&gt;
for epoch in range(NUM_EPOCHS):
    # &lt;EPOCH_START&gt;
    while True:
        # &lt;BEFORE_DATALOADER&gt;
        batch = next(dataloader)
        if batch is None:
            break
        inputs, targets = batch
        # &lt;AFTER_DATALOADER&gt;

        # &lt;BATCH_START&gt;

        # &lt;BEFORE_FORWARD&gt;
        outputs = model.forward(inputs)
        # &lt;AFTER_FORWARD&gt;

        # &lt;BEFORE_LOSS&gt;
        loss = model.loss(outputs, targets)
        # &lt;AFTER_LOSS&gt;

        # &lt;BEFORE_BACKWARD&gt;
        loss.backward()
        # &lt;AFTER_BACKWARD&gt;

        optimizer.step()
        optimizer.zero_grad()

        # &lt;BATCH_END&gt;
    # &lt;EPOCH_END&gt;</code></pre>
<p>For each event I wanted to log data types for, the callback passes <code>state</code> (where the <code>model</code> is stored), <code>logger</code> (to do the logging) and a <code>prefix</code> (to denote what’s being logged). Only every <code>backward_log_interval</code>-th batch’s backward pass is logged, to avoid clutter.</p>
<p>Here is example output:</p>
<pre><code># fit_start
Train dtype/fit_start/lm_head: "torch.float32"
Train dtype/fit_start/q_proj_base: "torch.float32"
Train dtype/fit_start/q_proj_lora_A: "torch.float32" 
Train dtype/fit_start/q_proj_lora_B: "torch.float32"

# after_backward
Train dtype/backward_0/lm_head: "torch.float32"
Train dtype/backward_0/q_proj_base: "torch.float32"
Train dtype/backward_0/q_proj_lora_A: "torch.float32"
Train dtype/backward_0/q_proj_lora_B: "torch.float32"</code></pre>
<p>I was surprised to see that everything was in float32, I thought Flash Attention 2 (FA2) used mixed precision? Note that I haven’t read the FA2 paper.</p>
</section>
<section id="second-callback" class="level2">
<h2 class="anchored" data-anchor-id="second-callback">Second Callback</h2>
<p>Now that I understood a basic logging callback, I asked Claude to generate a callback that would help me see where mixed precision came into play. This one was a bit more involved:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;">class</span> DtypeMonitor(Callback):</span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, log_interval<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb4-3">        <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">=</span> log_interval</span>
<span id="cb4-4">        <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb4-5">    </span>
<span id="cb4-6">    <span class="kw" style="color: #003B4F;">def</span> fit_start(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-7">        <span class="va" style="color: #111111;">self</span>._log_weight_dtypes(state, logger, <span class="st" style="color: #20794D;">"fit_start"</span>)</span>
<span id="cb4-8">    </span>
<span id="cb4-9">    <span class="kw" style="color: #003B4F;">def</span> before_forward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-10">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-11">            <span class="co" style="color: #5E5E5E;"># Log input tensor dtypes</span></span>
<span id="cb4-12">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(state.batch, <span class="bu" style="color: null;">dict</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="st" style="color: #20794D;">'input_ids'</span> <span class="kw" style="color: #003B4F;">in</span> state.batch:</span>
<span id="cb4-13">                logger.log_metrics({</span>
<span id="cb4-14">                    <span class="st" style="color: #20794D;">"dtype/input/input_ids"</span>: <span class="bu" style="color: null;">str</span>(state.batch[<span class="st" style="color: #20794D;">'input_ids'</span>].dtype)</span>
<span id="cb4-15">                })</span>
<span id="cb4-16">            </span>
<span id="cb4-17">            <span class="co" style="color: #5E5E5E;"># Register hooks to capture activation dtypes</span></span>
<span id="cb4-18">            layer <span class="op" style="color: #5E5E5E;">=</span> state.model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn</span>
<span id="cb4-19">            </span>
<span id="cb4-20">            <span class="kw" style="color: #003B4F;">def</span> hook_fn(name):</span>
<span id="cb4-21">                <span class="kw" style="color: #003B4F;">def</span> _hook(module, inputs, outputs):</span>
<span id="cb4-22">                    <span class="co" style="color: #5E5E5E;"># Log input activation dtype</span></span>
<span id="cb4-23">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(inputs, <span class="bu" style="color: null;">tuple</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(inputs) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-24">                        logger.log_metrics({<span class="ss" style="color: #20794D;">f"dtype/activation/</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_input"</span>: <span class="bu" style="color: null;">str</span>(inputs[<span class="dv" style="color: #AD0000;">0</span>].dtype)})</span>
<span id="cb4-25">                    </span>
<span id="cb4-26">                    <span class="co" style="color: #5E5E5E;"># Log output activation dtype</span></span>
<span id="cb4-27">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(outputs, torch.Tensor):</span>
<span id="cb4-28">                        logger.log_metrics({<span class="ss" style="color: #20794D;">f"dtype/activation/</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_output"</span>: <span class="bu" style="color: null;">str</span>(outputs.dtype)})</span>
<span id="cb4-29">                    <span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(outputs, <span class="bu" style="color: null;">tuple</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">len</span>(outputs) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-30">                        logger.log_metrics({<span class="ss" style="color: #20794D;">f"dtype/activation/</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_output"</span>: <span class="bu" style="color: null;">str</span>(outputs[<span class="dv" style="color: #AD0000;">0</span>].dtype)})</span>
<span id="cb4-31">                <span class="cf" style="color: #003B4F;">return</span> _hook</span>
<span id="cb4-32">            </span>
<span id="cb4-33">            <span class="co" style="color: #5E5E5E;"># Clear old hooks</span></span>
<span id="cb4-34">            <span class="cf" style="color: #003B4F;">for</span> hook <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.hooks:</span>
<span id="cb4-35">                hook.remove()</span>
<span id="cb4-36">            <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb4-37">            </span>
<span id="cb4-38">            <span class="co" style="color: #5E5E5E;"># Register new hooks</span></span>
<span id="cb4-39">            <span class="va" style="color: #111111;">self</span>.hooks.append(layer.q_proj.register_forward_hook(hook_fn(<span class="st" style="color: #20794D;">"q_proj"</span>)))</span>
<span id="cb4-40">            <span class="va" style="color: #111111;">self</span>.hooks.append(layer.register_forward_hook(hook_fn(<span class="st" style="color: #20794D;">"self_attn"</span>)))</span>
<span id="cb4-41">    </span>
<span id="cb4-42">    <span class="kw" style="color: #003B4F;">def</span> after_forward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-43">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-44">            <span class="co" style="color: #5E5E5E;"># Log model output dtype</span></span>
<span id="cb4-45">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(state.outputs, torch.Tensor):</span>
<span id="cb4-46">                logger.log_metrics({</span>
<span id="cb4-47">                    <span class="st" style="color: #20794D;">"dtype/computation/output"</span>: <span class="bu" style="color: null;">str</span>(state.outputs.dtype)</span>
<span id="cb4-48">                })</span>
<span id="cb4-49">    </span>
<span id="cb4-50">    <span class="kw" style="color: #003B4F;">def</span> after_loss(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-51">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-52">            <span class="co" style="color: #5E5E5E;"># Log loss dtype</span></span>
<span id="cb4-53">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(state.loss, torch.Tensor):</span>
<span id="cb4-54">                logger.log_metrics({</span>
<span id="cb4-55">                    <span class="st" style="color: #20794D;">"dtype/computation/loss"</span>: <span class="bu" style="color: null;">str</span>(state.loss.dtype)</span>
<span id="cb4-56">                })</span>
<span id="cb4-57">            <span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(state.loss, <span class="bu" style="color: null;">dict</span>) <span class="kw" style="color: #003B4F;">and</span> <span class="st" style="color: #20794D;">'total'</span> <span class="kw" style="color: #003B4F;">in</span> state.loss:</span>
<span id="cb4-58">                logger.log_metrics({</span>
<span id="cb4-59">                    <span class="st" style="color: #20794D;">"dtype/computation/loss"</span>: <span class="bu" style="color: null;">str</span>(state.loss[<span class="st" style="color: #20794D;">'total'</span>].dtype)</span>
<span id="cb4-60">                })</span>
<span id="cb4-61">    </span>
<span id="cb4-62">    <span class="kw" style="color: #003B4F;">def</span> after_backward(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-63">        <span class="cf" style="color: #003B4F;">if</span> state.timestamp.batch.value <span class="op" style="color: #5E5E5E;">%</span> <span class="va" style="color: #111111;">self</span>.log_interval <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb4-64">            <span class="va" style="color: #111111;">self</span>._log_weight_dtypes(state, logger, <span class="ss" style="color: #20794D;">f"backward_</span><span class="sc" style="color: #5E5E5E;">{</span>state<span class="sc" style="color: #5E5E5E;">.</span>timestamp<span class="sc" style="color: #5E5E5E;">.</span>batch<span class="sc" style="color: #5E5E5E;">.</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb4-65">            </span>
<span id="cb4-66">            <span class="co" style="color: #5E5E5E;"># Check gradient dtypes</span></span>
<span id="cb4-67">            model <span class="op" style="color: #5E5E5E;">=</span> state.model</span>
<span id="cb4-68">            lora_A <span class="op" style="color: #5E5E5E;">=</span> model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.lora_A.default</span>
<span id="cb4-69">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">hasattr</span>(lora_A, <span class="st" style="color: #20794D;">'weight'</span>) <span class="kw" style="color: #003B4F;">and</span> lora_A.weight.grad <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-70">                logger.log_metrics({</span>
<span id="cb4-71">                    <span class="st" style="color: #20794D;">"dtype/gradient/q_proj_lora_A"</span>: <span class="bu" style="color: null;">str</span>(lora_A.weight.grad.dtype)</span>
<span id="cb4-72">                })</span>
<span id="cb4-73">    </span>
<span id="cb4-74">    <span class="kw" style="color: #003B4F;">def</span> epoch_end(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-75">        <span class="va" style="color: #111111;">self</span>._log_weight_dtypes(state, logger, <span class="ss" style="color: #20794D;">f"epoch_</span><span class="sc" style="color: #5E5E5E;">{</span>state<span class="sc" style="color: #5E5E5E;">.</span>timestamp<span class="sc" style="color: #5E5E5E;">.</span>epoch<span class="sc" style="color: #5E5E5E;">.</span>value<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb4-76">        <span class="co" style="color: #5E5E5E;"># Remove any remaining hooks</span></span>
<span id="cb4-77">        <span class="cf" style="color: #003B4F;">for</span> hook <span class="kw" style="color: #003B4F;">in</span> <span class="va" style="color: #111111;">self</span>.hooks:</span>
<span id="cb4-78">            hook.remove()</span>
<span id="cb4-79">        <span class="va" style="color: #111111;">self</span>.hooks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb4-80">    </span>
<span id="cb4-81">    <span class="kw" style="color: #003B4F;">def</span> _log_weight_dtypes(<span class="va" style="color: #111111;">self</span>, state: State, logger: Logger, prefix: <span class="bu" style="color: null;">str</span>) <span class="op" style="color: #5E5E5E;">-&gt;</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb4-82">        model <span class="op" style="color: #5E5E5E;">=</span> state.model</span>
<span id="cb4-83">        logger.log_metrics({</span>
<span id="cb4-84">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/lm_head"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.lm_head.weight.dtype),</span>
<span id="cb4-85">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_base"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.base_layer.weight.dtype),</span>
<span id="cb4-86">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_lora_A"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.lora_A.default.weight.dtype),</span>
<span id="cb4-87">            <span class="ss" style="color: #20794D;">f"dtype/</span><span class="sc" style="color: #5E5E5E;">{</span>prefix<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">/q_proj_lora_B"</span>: <span class="bu" style="color: null;">str</span>(model.model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.lora_B.default.weight.dtype)</span>
<span id="cb4-88">        })</span></code></pre></div>
<p>Fortunately, I had just recently learned about <code>register_forward_hook</code> and created a short TIL video about it:</p>
<div class="quarto-video ratio ratio-16x9"><iframe src="https://www.youtube.com/embed/Y6qgWxU3oO4" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>In short, <code>register_forward_hook</code> exposes the forward pass inputs and outputs. You can manipulate both but you have access to inputs/outputs <em>after</em> the forward pass so you can’t change the inputs before they go into the forward pass. Thankfully that restriction doesn’t matter in my case, as I only want to log data types.</p>
<p>Running the training loop with this callback generated the following logs:</p>
<pre><code> Train dtype/input/input_ids: "torch.int64"
 Train dtype/activation/q_proj_input: "torch.float32"
 Train dtype/activation/q_proj_output: "torch.bfloat16"
 Train dtype/activation/self_attn_output: "torch.bfloat16"
 Train dtype/computation/loss: "torch.float32"
 Train dtype/backward_0/lm_head: "torch.float32"
 Train dtype/backward_0/q_proj_base: "torch.float32"
 Train dtype/backward_0/q_proj_lora_A: "torch.float32"
 Train dtype/backward_0/q_proj_lora_B: "torch.float32"
 Train dtype/gradient/q_proj_lora_A: "torch.float32"</code></pre>
<p>This shed some more light into what’s going on! The inputs to <code>q_proj</code> is float32 but the outputs are bfloat16. The loss and gradients are both in float32.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>This exercise has blown up the possibilities available to me for better understanding what goes on during training! I have only gotten a cursory glimpse at the internal mechanism of mixed precision training, but it’s relatively simple for me take this a step further by analyzing more data types during all training events for all model components. That’ll be a future blog post or video this week.</p>
<p>Thanks for reading! Lots more content on my <a href="https://www.youtube.com/@vishal_learner">YouTube channel</a> that I’m working on growing this year so please subscribe to stay in the loop.</p>


</section>

 ]]></description>
  <category>LLM</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-03-30-Composer-Callback/index.html</guid>
  <pubDate>Sun, 30 Mar 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>RAGatouille/ColBERT Indexing Deep Dive</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-03-12-RAGatouille-ColBERT-Indexing-Deep-Dive/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this blog post I dive deeply into the internals of the RAGatouille and ColBERT libraries to understand the intermediate steps taken when building an index for a collection of documents.</p>
<ul>
<li>RAGatouille
<ul>
<li>ragatouille/RAGPretrainedModel.py
<ul>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/RAGPretrainedModel.py#L129"><code>_process_corpus</code></a></li>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/RAGPretrainedModel.py#L171"><code>index</code></a></li>
</ul></li>
<li>ragatouille/models/colbert.py
<ul>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/colbert.py#L294"><code>index</code></a></li>
</ul></li>
<li>ragatouille/models/index.py
<ul>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L460"><code>ModelIndexFactory.construct</code></a></li>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L132"><code>PLAIDModelIndex.construct</code></a></li>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L156"><code>PLAIDModelIndex.build</code></a></li>
<li><a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L212"><code>indexer.index</code></a></li>
</ul></li>
</ul></li>
<li>ColBERT
<ul>
<li>colbert/indexer.py
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexer.py#L85"><code>Launcher(encode)</code></a></li>
</ul></li>
<li>colbert/indexing/collection_indexer.py
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L31"><code>encode</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L51"><code>Collection.cast</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L61"><code>CollectionIndexer.run</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L80"><code>CollectionIndexer.setup</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L114"><code>CollectionIndexer._sample_pids</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L133"><code>CollectionIndexer._sample_embeddings</code></a>
<ul>
<li>colbert/indexing/collection_encoder.py: <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_encoder.py#L13"><code>CollectionEncoder.encode_passages</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/modeling/checkpoint.py#L122"><code>Checkpoint.docFromText</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/modeling/colbert.py#L95"><code>ColBERT.doc</code></a></li>
</ul></li>
</ul></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L210"><code>CollectionIndexer._save_plan</code></a></li>
</ul></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L226"><code>CollectionIndexer.train</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L500"><code>compute_faiss_kmeans</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L314"><code>CollectionIndexer._compute_avg_residual</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/codecs/residual.py#L204"><code>ResidualCodec.compress_into_codes</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/codecs/residual.py#L222"><code>ResidualCodec.lookup_centroids</code></a></li>
</ul></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/index_saver.py#L17"><code>IndexSaver.save_codec</code></a></li>
</ul></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L346"><code>CollectionIndexer.index</code></a>
<ul>
<li>colbert/indexing/collection_encoder.py: <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_encoder.py#L13"><code>CollectionEncoder.encode_passages</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/index_saver.py#L70"><code>IndexSaver.save_chunk</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/codecs/residual.py#L167"><code>ResidualCodec.compress</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/codecs/residual.py#L186"><code>ResidualCodec.binarize</code></a></li>
</ul></li>
</ul></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L378"><code>CollectionIndexer.finalize</code></a>
<ul>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L438"><code>CollectionIndexer._build_ivf</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/utils.py#L8"><code>optimize_ivf</code></a></li>
<li><a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/collection_indexer.py#L484"><code>CollectionIndexer._update_metadata</code></a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install datasets ragatouille <span class="op" style="color: #5E5E5E;">-</span>qq</span></code></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;">from</span> datasets <span class="im" style="color: #00769E;">import</span> load_dataset</span>
<span id="cb2-2"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb2-3"><span class="im" style="color: #00769E;">from</span> fastcore.utils <span class="im" style="color: #00769E;">import</span> Path</span>
<span id="cb2-4"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb2-5"><span class="im" style="color: #00769E;">import</span> srsly</span>
<span id="cb2-6"><span class="im" style="color: #00769E;">import</span> uuid</span>
<span id="cb2-7"><span class="im" style="color: #00769E;">from</span> ragatouille.data <span class="im" style="color: #00769E;">import</span> CorpusProcessor</span>
<span id="cb2-8"><span class="im" style="color: #00769E;">from</span> llama_index.core.text_splitter <span class="im" style="color: #00769E;">import</span> SentenceSplitter</span>
<span id="cb2-9"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb2-10"><span class="im" style="color: #00769E;">from</span> ragatouille.models.index <span class="im" style="color: #00769E;">import</span> PLAIDModelIndex</span>
<span id="cb2-11"><span class="im" style="color: #00769E;">from</span> colbert.infra <span class="im" style="color: #00769E;">import</span> ColBERTConfig, RunConfig</span>
<span id="cb2-12"><span class="im" style="color: #00769E;">from</span> colbert.data.collection <span class="im" style="color: #00769E;">import</span> Collection</span>
<span id="cb2-13"><span class="im" style="color: #00769E;">from</span> colbert.modeling.checkpoint <span class="im" style="color: #00769E;">import</span> Checkpoint</span>
<span id="cb2-14"><span class="im" style="color: #00769E;">from</span> colbert.indexing.collection_encoder <span class="im" style="color: #00769E;">import</span> CollectionEncoder</span>
<span id="cb2-15"><span class="im" style="color: #00769E;">from</span> colbert.indexing.collection_indexer <span class="im" style="color: #00769E;">import</span> CollectionIndexer</span>
<span id="cb2-16"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb2-17"><span class="im" style="color: #00769E;">import</span> random</span>
<span id="cb2-18"><span class="im" style="color: #00769E;">from</span> colbert.indexing.collection_indexer <span class="im" style="color: #00769E;">import</span> compute_faiss_kmeans</span>
<span id="cb2-19"><span class="im" style="color: #00769E;">from</span> sklearn.decomposition <span class="im" style="color: #00769E;">import</span> PCA</span>
<span id="cb2-20"><span class="im" style="color: #00769E;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb2-21"><span class="im" style="color: #00769E;">from</span> colbert.indexing.codecs.residual <span class="im" style="color: #00769E;">import</span> ResidualCodec</span>
<span id="cb2-22"><span class="im" style="color: #00769E;">from</span> colbert.utils.utils <span class="im" style="color: #00769E;">import</span> flatten</span>
<span id="cb2-23"><span class="im" style="color: #00769E;">import</span> tqdm</span></code></pre></div>
</div>
<div class="cell" data-outputid="48a0a8b7-2a76-40ef-f24a-3d0c8f01860b" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;">def</span> set_all_seeds(seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">123</span>):</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;">"""Set seeds for all random number generators"""</span></span>
<span id="cb3-3">    <span class="im" style="color: #00769E;">import</span> random</span>
<span id="cb3-4">    <span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb3-5">    <span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb3-6">    <span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb3-7"></span>
<span id="cb3-8">    <span class="co" style="color: #5E5E5E;"># Python's random module</span></span>
<span id="cb3-9">    random.seed(seed)</span>
<span id="cb3-10"></span>
<span id="cb3-11">    <span class="co" style="color: #5E5E5E;"># NumPy</span></span>
<span id="cb3-12">    np.random.seed(seed)</span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;"># PyTorch</span></span>
<span id="cb3-15">    torch.manual_seed(seed)</span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;">if</span> torch.cuda.is_available():</span>
<span id="cb3-17">        torch.cuda.manual_seed(seed)</span>
<span id="cb3-18">        torch.cuda.manual_seed_all(seed)  <span class="co" style="color: #5E5E5E;"># For multi-GPU</span></span>
<span id="cb3-19"></span>
<span id="cb3-20">    <span class="co" style="color: #5E5E5E;"># Set PYTHONHASHSEED for reproducibility across runs</span></span>
<span id="cb3-21">    os.environ[<span class="st" style="color: #20794D;">'PYTHONHASHSEED'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(seed)</span>
<span id="cb3-22"></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;"># Set deterministic algorithms for PyTorch</span></span>
<span id="cb3-24">    torch.backends.cudnn.deterministic <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb3-25">    torch.backends.cudnn.benchmark <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb3-26"></span>
<span id="cb3-27">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"All seeds set to </span><span class="sc" style="color: #5E5E5E;">{</span>seed<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;"># Call this at the beginning of your script</span></span>
<span id="cb3-30">set_all_seeds(<span class="dv" style="color: #AD0000;">123</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All seeds set to 123</code></pre>
</div>
</div>
</section>
<section id="ragatouille-rag.index" class="level2">
<h2 class="anchored" data-anchor-id="ragatouille-rag.index">RAGatouille <code>RAG.index</code></h2>
<p>Everything in this notebook will be compared to what’s generated with <code>RAG.index</code>.</p>
<p>For this exercise, I’ll use 1000 passages from the UKPLab/DAPR ConditionalQA dataset.</p>
<div class="cell" data-outputid="7e33ac84-a51a-4f14-bd44-d14716248acd" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">passages <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="ss" style="color: #20794D;">f"ConditionalQA-corpus"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test[:1000]"</span>)</span>
<span id="cb5-2">passages</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/huggingface_hub/utils/_auth.py:94: UserWarning: 
The secret `HF_TOKEN` does not exist in your Colab secrets.
To authenticate with the Hugging Face Hub, create a token in your settings tab (https://huggingface.co/settings/tokens), set it as secret in your Google Colab and restart your session.
You will be able to reuse this secret in all of your notebooks.
Please note that authentication is recommended but still optional to access public models or datasets.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a0c3f7d9bbee4b7db19b8050f440b0ab","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c39bb21b350347678bee62cb857f9e99","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"caae6430636d4781a9d42a33bb39b203","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Dataset({
    features: ['_id', 'text', 'title', 'doc_id', 'paragraph_no', 'total_paragraphs', 'is_candidate'],
    num_rows: 1000
})</code></pre>
</div>
</div>
<div class="cell" data-outputid="f796ba22-e08b-459f-a2de-80af227ab588" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">passages[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'text'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>'Overview'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">model_nm <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"answerdotai/answerai-colbert-small-v1"</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="3b8db5f6-6d4e-4e74-b628-ab197b09d564" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(model_nm)</span>
<span id="cb11-2">index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(index_name<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"cqa_index"</span>, collection<span class="op" style="color: #5E5E5E;">=</span>passages[<span class="st" style="color: #20794D;">'text'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"84a8a4d001ab4ddc9cc43766750856cb","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3d8bdabc4fb24e89829a523480a4bff0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"88424e552e604d548a38219144b45b13","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e607d9321eb047b5aeac1e38a4da9e35","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fd3556a3f0e942db8ccfb750453de036","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fb94def1a1c341108f6aad992b5cd66f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"566b3397334148e5a490173a285cf92d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6613c12c3da94caf9a022f77525b9918","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:12: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  self.scaler = torch.cuda.amp.GradScaler()</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>---- WARNING! You are using PLAID with an experimental replacement for FAISS for greater compatibility ----
This is a behaviour change from RAGatouille 0.8.0 onwards.
This works fine for most users and smallish datasets, but can be considerably slower than FAISS and could cause worse results in some situations.
If you're confident with FAISS working on your machine, pass use_faiss=True to revert to the FAISS-using behaviour.
--------------------


[Mar 13, 01:15:09] #&gt; Creating directory .ragatouille/colbert/indexes/cqa_index 


[Mar 13, 01:15:11] [0]       #&gt; Encoding 1000 passages..</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:15: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  return torch.cuda.amp.autocast() if self.activated else NullContextManager()</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:15:14] [0]       avg_doclen_est = 15.197999954223633     len(local_sample) = 1,000
[Mar 13, 01:15:14] [0]       Creating 1,024 partitions.
[Mar 13, 01:15:14] [0]       *Estimated* 15,197 embeddings.
[Mar 13, 01:15:14] [0]       #&gt; Saving the indexing plan to .ragatouille/colbert/indexes/cqa_index/plan.json ..</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/indexing/collection_indexer.py:256: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  sub_sample = torch.load(sub_sample_path)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>used 20 iterations (0.5189s) to cluster 14439 items into 1024 clusters
[Mar 13, 01:15:14] Loading decompress_residuals_cpp extension (set COLBERT_LOAD_TORCH_EXTENSION_VERBOSE=True for more info)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/torch/utils/cpp_extension.py:1964: UserWarning: TORCH_CUDA_ARCH_LIST is not set, all archs for visible cards are included for compilation. 
If this is not desired, please set os.environ['TORCH_CUDA_ARCH_LIST'].
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:16:51] Loading packbits_cpp extension (set COLBERT_LOAD_TORCH_EXTENSION_VERBOSE=True for more info)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/torch/utils/cpp_extension.py:1964: UserWarning: TORCH_CUDA_ARCH_LIST is not set, all archs for visible cards are included for compilation. 
If this is not desired, please set os.environ['TORCH_CUDA_ARCH_LIST'].
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.015, 0.016, 0.015, 0.015, 0.013, 0.016, 0.015, 0.016, 0.017, 0.014, 0.013, 0.015, 0.017, 0.014, 0.015, 0.017, 0.014, 0.015, 0.015, 0.014, 0.015, 0.016, 0.015, 0.015, 0.014, 0.014, 0.015, 0.015, 0.015, 0.015, 0.014, 0.014, 0.015, 0.014, 0.015, 0.015, 0.014, 0.015, 0.016, 0.015, 0.014, 0.015, 0.015, 0.014, 0.014, 0.017, 0.016, 0.017, 0.014, 0.015, 0.016, 0.015, 0.016, 0.016, 0.012, 0.015, 0.016, 0.015, 0.016, 0.016, 0.015, 0.015, 0.016, 0.014, 0.015, 0.017, 0.016, 0.015, 0.014, 0.015, 0.015, 0.015, 0.014, 0.016, 0.016, 0.016, 0.014, 0.015, 0.015, 0.014, 0.014, 0.014, 0.016, 0.015, 0.016, 0.015, 0.014, 0.014, 0.014, 0.015, 0.016, 0.014, 0.014, 0.016, 0.014, 0.015]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/indexing/codecs/residual.py:141: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  centroids = torch.load(centroids_path, map_location='cpu')
/usr/local/lib/python3.11/dist-packages/colbert/indexing/codecs/residual.py:142: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  avg_residual = torch.load(avgresidual_path, map_location='cpu')
/usr/local/lib/python3.11/dist-packages/colbert/indexing/codecs/residual.py:143: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  bucket_cutoffs, bucket_weights = torch.load(buckets_path, map_location='cpu')
0it [00:00, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:18:16] [0]       #&gt; Encoding 1000 passages..</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:15: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  return torch.cuda.amp.autocast() if self.activated else NullContextManager()
1it [00:00,  1.39it/s]
  0%|          | 0/1 [00:00&lt;?, ?it/s]/usr/local/lib/python3.11/dist-packages/colbert/indexing/codecs/residual_embeddings.py:86: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  return torch.load(codes_path, map_location='cpu')
100%|██████████| 1/1 [00:00&lt;00:00, 787.81it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:18:16] #&gt; Optimizing IVF to store map from centroids to list of pids..
[Mar 13, 01:18:16] #&gt; Building the emb2pid mapping..
[Mar 13, 01:18:16] len(emb2pid) = 15198</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
100%|██████████| 1024/1024 [00:00&lt;00:00, 61154.86it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:18:16] #&gt; Saved optimized IVF to .ragatouille/colbert/indexes/cqa_index/ivf.pid.pt
Done indexing!</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div class="cell" data-outputid="43f5fe3b-967d-4ee9-c806-a6cf68612e98" data-execution_count="8">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">index_path <span class="op" style="color: #5E5E5E;">=</span> Path(index_path)</span>
<span id="cb29-2">index_path</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Path('.ragatouille/colbert/indexes/cqa_index')</code></pre>
</div>
</div>
<div class="cell" data-outputid="cf51663d-a6b5-46a1-c3e4-64054d65c53a" data-execution_count="9">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="cf" style="color: #003B4F;">for</span> o <span class="kw" style="color: #003B4F;">in</span> index_path.ls(): <span class="bu" style="color: null;">print</span>(o)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.ragatouille/colbert/indexes/cqa_index/buckets.pt
.ragatouille/colbert/indexes/cqa_index/collection.json
.ragatouille/colbert/indexes/cqa_index/metadata.json
.ragatouille/colbert/indexes/cqa_index/ivf.pid.pt
.ragatouille/colbert/indexes/cqa_index/doclens.0.json
.ragatouille/colbert/indexes/cqa_index/0.residuals.pt
.ragatouille/colbert/indexes/cqa_index/centroids.pt
.ragatouille/colbert/indexes/cqa_index/0.metadata.json
.ragatouille/colbert/indexes/cqa_index/plan.json
.ragatouille/colbert/indexes/cqa_index/0.codes.pt
.ragatouille/colbert/indexes/cqa_index/avg_residual.pt
.ragatouille/colbert/indexes/cqa_index/pid_docid_map.json</code></pre>
</div>
</div>
<p>While it’s a bit tedious to do so (since I’m chomping at the bit to get to the deep dive!) I think it’s worth analyzing the contents of each of these files, as we’ll be recreating them in this notebook.</p>
<section id="buckets.pt" class="level3">
<h3 class="anchored" data-anchor-id="buckets.pt">buckets.pt</h3>
<p>Looking at <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/codecs/residual.py#L160">Line 160</a> of the ColBERT repo’s <code>residual.py</code>, buckets.py stores bucket_cutoffs and bucket_weights. We’ll go into detail into what these exactly are later on.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">_bucket_cutoffs, _bucket_weights <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'buckets.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="21050d94-0825-497b-80a5-cc4123b93ac0" data-execution_count="11">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">_bucket_cutoffs.shape, _bucket_weights.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>(torch.Size([15]), torch.Size([16]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="9bc408df-7960-4f11-a4bf-21989452487c" data-execution_count="12">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">_bucket_cutoffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>tensor([-0.0307, -0.0205, -0.0146, -0.0099, -0.0064, -0.0037, -0.0016,  0.0000,
         0.0017,  0.0038,  0.0066,  0.0102,  0.0150,  0.0211,  0.0313],
       device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="4368b89d-459e-4270-a55e-c200fad278c5" data-execution_count="13">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">_bucket_weights</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor([-0.0411, -0.0247, -0.0173, -0.0121, -0.0081, -0.0050, -0.0026, -0.0007,
         0.0007,  0.0027,  0.0052,  0.0083,  0.0124,  0.0178,  0.0253,  0.0421],
       device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
</section>
<section id="residuals.pt" class="level3">
<h3 class="anchored" data-anchor-id="residuals.pt">0.residuals.pt</h3>
<p>IIUC, there are 15198 tokens in our collection, each with a 48-dimension vector representation, and each integer value represents two 4-bit codes that each correspond to a quantized value. So there are actually 96 values in each vector.</p>
<div class="cell" data-outputid="f41f7dd3-b478-4bb8-a3be-9fa16b012687" data-execution_count="14">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">_residuals <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'0.residuals.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb40-2">_residuals</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>tensor([[ 30, 225, 225,  ..., 238, 238,  30],
        [230,  22, 158,  ..., 233, 106, 170],
        [238, 238, 238,  ..., 238, 238, 238],
        ...,
        [ 43,  22,  23,  ..., 104,  31, 208],
        [222, 254,  91,  ..., 128,   8, 189],
        [229,  82,  22,  ..., 170,  94, 154]], dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="00b115a3-0966-477c-b933-a9ce207a0e22" data-execution_count="15">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">_residuals.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>torch.Size([15198, 48])</code></pre>
</div>
</div>
<div class="cell" data-outputid="bdd729b1-6b9b-48bd-ac9b-753df5045ba7" data-execution_count="16">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="dv" style="color: #AD0000;">48</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>96.0</code></pre>
</div>
</div>
</section>
<section id="ivf.pid.pt" class="level3">
<h3 class="anchored" data-anchor-id="ivf.pid.pt">ivf.pid.pt</h3>
<p>IIRC, <code>ivf</code> contains a flattened sequence of passage IDs corresponding to each centroid. There are 1024 centroids and the first 8 passage IDs in <code>ivf</code> correspond to the 0-th centroid.</p>
<div class="cell" data-outputid="c5627cea-ba7c-411f-9d79-67d80cfa25d8" data-execution_count="17">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">_ivf, _ivf_lengths <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'ivf.pid.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb46-2">_ivf.shape, _ivf_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(torch.Size([11759]), torch.Size([1024]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="ed2b73e1-c8b7-4f2b-bed0-c2eca6183261" data-execution_count="18">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">_ivf[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>tensor([895, 896, 902, 904, 909], dtype=torch.int32)</code></pre>
</div>
</div>
<div class="cell" data-outputid="792c0d0f-a376-451e-8395-d05a7ecb44e3" data-execution_count="19">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">_ivf_lengths[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>tensor(8)</code></pre>
</div>
</div>
</section>
<section id="metadata.json" class="level3">
<h3 class="anchored" data-anchor-id="metadata.json">0.metadata.json</h3>
<p>There are 1000 passages totaling 15198 tokens.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="kw" style="color: #003B4F;">def</span> load_json(path, filename): <span class="cf" style="color: #003B4F;">return</span> srsly.read_json(<span class="bu" style="color: null;">str</span>(Path(path) <span class="op" style="color: #5E5E5E;">/</span> filename))</span></code></pre></div>
</div>
<div class="cell" data-outputid="5271803e-f8e9-4608-8c89-ffe2bf71f511" data-execution_count="21">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">load_json(index_path, <span class="st" style="color: #20794D;">"0.metadata.json"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>{'passage_offset': 0,
 'num_passages': 1000,
 'num_embeddings': 15198,
 'embedding_offset': 0}</code></pre>
</div>
</div>
</section>
<section id="collection.json" class="level3">
<h3 class="anchored" data-anchor-id="collection.json">collection.json</h3>
<p>This JSON contains, as a list, the strings of the 1000 passages in our collection.</p>
<div class="cell" data-outputid="f9f4876a-5fc7-446c-8477-c4e6846aeb73" data-execution_count="22">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">_collection <span class="op" style="color: #5E5E5E;">=</span> load_json(index_path, <span class="st" style="color: #20794D;">"collection.json"</span>)</span>
<span id="cb55-2"><span class="bu" style="color: null;">len</span>(_collection), _collection[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(1000, 'Overview')</code></pre>
</div>
</div>
</section>
<section id="avg_residual.pt" class="level3">
<h3 class="anchored" data-anchor-id="avg_residual.pt">avg_residual.pt</h3>
<p>I believe this is the average residual across the 15198 tokens (i.e.&nbsp;the average distance in vector-space between the tokens and their closest centroids).</p>
<div class="cell" data-outputid="ddcc0531-f023-458e-99cf-e1042dd6cec7" data-execution_count="23">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1">_avg_residual <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'avg_residual.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb57-2">_avg_residual</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>tensor(0.0150, device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
</section>
<section id="doclens.0.json" class="level3">
<h3 class="anchored" data-anchor-id="doclens.0.json">doclens.0.json</h3>
<p>This contains a mapping (list) between passages IDs (indices) and the number of tokens in the document (values).</p>
<div class="cell" data-outputid="a9af0411-007e-440f-d78d-16219ef8cdd0" data-execution_count="24">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">_doclens <span class="op" style="color: #5E5E5E;">=</span> load_json(index_path, <span class="st" style="color: #20794D;">"doclens.0.json"</span>)</span>
<span id="cb59-2"><span class="bu" style="color: null;">len</span>(_doclens), _doclens[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(1000, [4, 20, 18, 23, 8])</code></pre>
</div>
</div>
<div class="cell" data-outputid="64fb7278-8964-4a4a-fa37-d2f490e5f7bf" data-execution_count="142">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="bu" style="color: null;">sum</span>(doclens)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>15198</code></pre>
</div>
</div>
</section>
<section id="metadata.json-1" class="level3">
<h3 class="anchored" data-anchor-id="metadata.json-1">metadata.json</h3>
<p>Lots of information in here, will highlight the number of centroids and the number of token embeddings in the collection:</p>
<pre><code>'num_partitions': 1024,
'num_embeddings': 15198</code></pre>
<div class="cell" data-outputid="05ffedca-2da2-4a9b-f4b1-4e9325ecac06" data-execution_count="25">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">load_json(index_path, <span class="st" style="color: #20794D;">"metadata.json"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>{'config': {'query_token_id': '[unused0]',
  'doc_token_id': '[unused1]',
  'query_token': '[Q]',
  'doc_token': '[D]',
  'ncells': None,
  'centroid_score_threshold': None,
  'ndocs': None,
  'load_index_with_mmap': False,
  'index_path': None,
  'index_bsize': 32,
  'nbits': 4,
  'kmeans_niters': 20,
  'resume': False,
  'pool_factor': 1,
  'clustering_mode': 'hierarchical',
  'protected_tokens': 0,
  'similarity': 'cosine',
  'bsize': 64,
  'accumsteps': 1,
  'lr': 1e-05,
  'maxsteps': 15626,
  'save_every': None,
  'warmup': 781,
  'warmup_bert': None,
  'relu': False,
  'nway': 32,
  'use_ib_negatives': False,
  'reranker': False,
  'distillation_alpha': 1.0,
  'ignore_scores': False,
  'model_name': 'answerdotai/AnswerAI-ColBERTv2.5-small',
  'query_maxlen': 32,
  'attend_to_mask_tokens': False,
  'interaction': 'colbert',
  'dim': 96,
  'doc_maxlen': 256,
  'mask_punctuation': True,
  'checkpoint': 'answerdotai/answerai-colbert-small-v1',
  'triples': '/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl',
  'collection': ['list with 1000 elements starting with...',
   ['Overview',
    'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
    'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.']],
  'queries': '/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv',
  'index_name': 'cqa_index',
  'overwrite': False,
  'root': '.ragatouille/',
  'experiment': 'colbert',
  'index_root': None,
  'name': '2025-03/13/01.14.35',
  'rank': 0,
  'nranks': 1,
  'amp': True,
  'gpus': 1,
  'avoid_fork_if_possible': False},
 'num_chunks': 1,
 'num_partitions': 1024,
 'num_embeddings': 15198,
 'avg_doclen': 15.198,
 'RAGatouille': {'index_config': {'index_type': 'PLAID',
   'index_name': 'cqa_index'}}}</code></pre>
</div>
</div>
</section>
<section id="centroids.pt" class="level3">
<h3 class="anchored" data-anchor-id="centroids.pt">centroids.pt</h3>
<p>There are 1024 96-dimension centroid vectors stored.</p>
<div class="cell" data-outputid="56aaee76-7ad0-4269-f01b-aaeafc824b29" data-execution_count="26">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1">_centroids <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'centroids.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb66-2">_centroids.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>torch.Size([1024, 96])</code></pre>
</div>
</div>
<p>They store the full uncompressed values for the centroids.</p>
<div class="cell" data-outputid="0ade9405-521f-46f7-c241-fa63dadfb05c" data-execution_count="27">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">_centroids[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>tensor([-0.0649,  0.1193, -0.0551,  0.0561, -0.0826], device='cuda:0',
       dtype=torch.float16)</code></pre>
</div>
</div>
</section>
<section id="codes.pt" class="level3">
<h3 class="anchored" data-anchor-id="codes.pt">0.codes.pt</h3>
<p>I believe this is a mapping (list) between tokens (indices) and centroid IDs (values).</p>
<div class="cell" data-outputid="7128258c-5e5b-4b15-f877-f157d71d2bd4" data-execution_count="28">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">_codes <span class="op" style="color: #5E5E5E;">=</span> torch.load(index_path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'0.codes.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb70-2">_codes.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>torch.Size([15198])</code></pre>
</div>
</div>
<div class="cell" data-outputid="62d80166-6b60-45db-8305-fab765339cbb" data-execution_count="29">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">_codes[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>tensor([138, 843, 273, 138, 561], dtype=torch.int32)</code></pre>
</div>
</div>
</section>
<section id="pid_docid_map.json" class="level3">
<h3 class="anchored" data-anchor-id="pid_docid_map.json">pid_docid_map.json</h3>
<p>A mapping between passage ID (0-999) and document ID (UUID).</p>
<div class="cell" data-outputid="e16d0b3d-96c4-4a25-b2b0-b61aa712aa97" data-execution_count="30">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1">_pid_docid_map <span class="op" style="color: #5E5E5E;">=</span> load_json(index_path, <span class="st" style="color: #20794D;">"pid_docid_map.json"</span>)</span>
<span id="cb74-2">_pid_docid_map[<span class="st" style="color: #20794D;">'999'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>'2be086c6-04cc-4d73-b372-08236f76cbe6'</code></pre>
</div>
</div>
</section>
<section id="plan.json" class="level3">
<h3 class="anchored" data-anchor-id="plan.json">plan.json</h3>
<p>This seems to contain the same information as metadata.json.</p>
<div class="cell" data-outputid="4a7d667f-74ca-4a32-8a34-43d295ef9d52" data-execution_count="31">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">_plan <span class="op" style="color: #5E5E5E;">=</span> load_json(index_path, <span class="st" style="color: #20794D;">"plan.json"</span>)</span>
<span id="cb76-2">_plan</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>{'config': {'query_token_id': '[unused0]',
  'doc_token_id': '[unused1]',
  'query_token': '[Q]',
  'doc_token': '[D]',
  'ncells': None,
  'centroid_score_threshold': None,
  'ndocs': None,
  'load_index_with_mmap': False,
  'index_path': None,
  'index_bsize': 32,
  'nbits': 4,
  'kmeans_niters': 20,
  'resume': False,
  'pool_factor': 1,
  'clustering_mode': 'hierarchical',
  'protected_tokens': 0,
  'similarity': 'cosine',
  'bsize': 64,
  'accumsteps': 1,
  'lr': 1e-05,
  'maxsteps': 15626,
  'save_every': None,
  'warmup': 781,
  'warmup_bert': None,
  'relu': False,
  'nway': 32,
  'use_ib_negatives': False,
  'reranker': False,
  'distillation_alpha': 1.0,
  'ignore_scores': False,
  'model_name': 'answerdotai/AnswerAI-ColBERTv2.5-small',
  'query_maxlen': 32,
  'attend_to_mask_tokens': False,
  'interaction': 'colbert',
  'dim': 96,
  'doc_maxlen': 256,
  'mask_punctuation': True,
  'checkpoint': 'answerdotai/answerai-colbert-small-v1',
  'triples': '/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl',
  'collection': ['list with 1000 elements starting with...',
   ['Overview',
    'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
    'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.']],
  'queries': '/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv',
  'index_name': 'cqa_index',
  'overwrite': False,
  'root': '.ragatouille/',
  'experiment': 'colbert',
  'index_root': None,
  'name': '2025-03/13/01.14.35',
  'rank': 0,
  'nranks': 1,
  'amp': True,
  'gpus': 1,
  'avoid_fork_if_possible': False},
 'num_chunks': 1,
 'num_partitions': 1024,
 'num_embeddings_est': 15197.999954223633,
 'avg_doclen_est': 15.197999954223633}</code></pre>
</div>
</div>
<p>In the following sections, I’ll try to recreate each of these <code>index_path</code> elements.</p>
</section>
</section>
<section id="process_corpus" class="level2">
<h2 class="anchored" data-anchor-id="process_corpus">_process_corpus</h2>
<p>Inside <code>RAG.index</code>, <code>_process_corpus</code> is called on the documents and document IDs.</p>
<div class="cell" data-outputid="91ca6abf-bd88-4652-efd4-a4b2b77907c2" data-execution_count="32">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">passage_ids <span class="op" style="color: #5E5E5E;">=</span> [<span class="bu" style="color: null;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(passages))]</span>
<span id="cb78-2">passage_ids[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>'d4cdfec5-a949-43e0-94b3-feb24caeac5e'</code></pre>
</div>
</div>
<p>Use the corpus processor to convert the passages into <code>{'document_id': '...', 'content': '...'}</code> dictionaries with 256-token max length.</p>
<div class="cell" data-outputid="40335ff4-def8-4944-8c0b-157d7823934b" data-execution_count="33">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1">cp <span class="op" style="color: #5E5E5E;">=</span> CorpusProcessor()</span>
<span id="cb80-2">cp</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>&lt;ragatouille.data.corpus_processor.CorpusProcessor at 0x794fa0323690&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="dd183218-3093-4c9b-e4f5-7f31c5b9517b" data-execution_count="34">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1">collection_with_ids <span class="op" style="color: #5E5E5E;">=</span> cp.process_corpus(passages[<span class="st" style="color: #20794D;">'text'</span>], passage_ids, chunk_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>)</span>
<span id="cb82-2"><span class="bu" style="color: null;">len</span>(collection_with_ids), collection_with_ids[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(1000,
 {'document_id': 'd4cdfec5-a949-43e0-94b3-feb24caeac5e',
  'content': 'Overview'})</code></pre>
</div>
</div>
<p>As a brief aside, I’ll take a look at the maximum token length of the passages.</p>
<div class="cell" data-outputid="8bba83eb-1120-4e91-819c-c2d0e5315a93" data-execution_count="35">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1">node_parser <span class="op" style="color: #5E5E5E;">=</span> SentenceSplitter(chunk_size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>)</span>
<span id="cb84-2">node_parser._token_size</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>llama_index.core.node_parser.text.sentence.SentenceSplitter._token_size</b><br>def _token_size(text: str) -&gt; int</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.11/dist-packages/llama_index/core/node_parser/text/sentence.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 307);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<div class="cell" data-outputid="e76d0bf8-1cb0-4106-bbfc-a3afaf329571" data-execution_count="36">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">tk_szs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb85-2"><span class="cf" style="color: #003B4F;">for</span> p <span class="kw" style="color: #003B4F;">in</span> passages[<span class="st" style="color: #20794D;">'text'</span>]: tk_szs.append(node_parser._token_size(p))</span>
<span id="cb85-3">pd.Series(tk_szs).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>13.217000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>10.192635</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>5.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>10.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>19.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>65.000000</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> float64</label>
</div>
</div>
<p>This collection of passages has relatively short passages (a max of 65 tokens).</p>
<p><code>_process_corpus</code> then creates</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1">pid_docid_map <span class="op" style="color: #5E5E5E;">=</span> {index: item[<span class="st" style="color: #20794D;">"document_id"</span>] <span class="cf" style="color: #003B4F;">for</span> index, item <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(collection_with_ids)}</span></code></pre></div>
</div>
<div class="cell" data-outputid="d0e99497-9dca-4320-f03f-32432c30bd0a" data-execution_count="38">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">pid_docid_map[<span class="dv" style="color: #AD0000;">999</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>'096e054e-3041-4881-ac48-b20f1804f650'</code></pre>
</div>
</div>
<p>This matches the content of <code>pid_docid_map.json</code>.</p>
<p><code>_process_corpus</code> also defines a list of strings, <code>collection</code>:</p>
<div class="cell" data-outputid="a8fec22c-5857-42c9-a9fd-a1d68382bff2" data-execution_count="39">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1">collection <span class="op" style="color: #5E5E5E;">=</span> [x[<span class="st" style="color: #20794D;">"content"</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> collection_with_ids]</span>
<span id="cb89-2">collection[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>'Overview'</code></pre>
</div>
</div>
<p><code>_process_corpus</code> also calls <code>_process_metadata</code> which defines <code>docid_metadata_map</code> as <code>None</code> when <code>document_metadatas</code> is <code>None</code> (which it is in our case).</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1">docid_metadata_map <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span></code></pre></div>
</div>
</section>
<section id="rag.index-internals" class="level2">
<h2 class="anchored" data-anchor-id="rag.index-internals"><code>RAG.index</code> Internals</h2>
<p>After calling <code>_process_corpus</code>, <code>RAG.index</code> calls <code>model.index</code>, where <code>model</code> is:</p>
<div class="sourceCode" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1">instance.model <span class="op" style="color: #5E5E5E;">=</span> ColBERT(</span>
<span id="cb92-2">            pretrained_model_name_or_path, n_gpu, index_root<span class="op" style="color: #5E5E5E;">=</span>index_root, verbose<span class="op" style="color: #5E5E5E;">=</span>verbose</span>
<span id="cb92-3">        )</span></code></pre></div>
<p><code>ColBERT.index</code> in turn calls:</p>
<div class="sourceCode" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1">ModelIndexFactory.construct</span></code></pre></div>
<p>By default the type of index is PLAID, so the following is called:</p>
<div class="sourceCode" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1">PLAIDModelIndex(config).build(</span>
<span id="cb94-2">            checkpoint, collection, index_name, overwrite, verbose, <span class="op" style="color: #5E5E5E;">**</span>kwargs</span>
<span id="cb94-3">        )</span></code></pre></div>
<section id="plaidmodelindex.build" class="level3">
<h3 class="anchored" data-anchor-id="plaidmodelindex.build">PLAIDModelIndex.build</h3>
<p>A couple of key configuration values are set in this method, starting with the bsize (which I think is batch size?) defaulting to 32.</p>
<div class="cell" data-outputid="713f95b3-a2dd-4045-8a63-2831279ab052" data-execution_count="41">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1">PLAIDModelIndex._DEFAULT_INDEX_BSIZE</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>32</code></pre>
</div>
</div>
<div class="cell" data-outputid="509c34cf-aaab-43ae-98e3-1236b1783297" data-execution_count="42">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1">bsize <span class="op" style="color: #5E5E5E;">=</span> PLAIDModelIndex._DEFAULT_INDEX_BSIZE</span>
<span id="cb97-2">bsize</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>32</code></pre>
</div>
</div>
<p>The size of compressed residual embedding values is determined based on the size of the collection.</p>
<div class="cell" data-outputid="fcd4d4e2-a40c-4bb1-e23c-38198b4d9f3b" data-execution_count="43">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(collection) <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">10000</span>: nbits <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb99-2">nbits</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>4</code></pre>
</div>
</div>
<p>It then defines a <code>ColBERTConfig</code> object, which I believe is instantiated as follows when the <code>ColBERT</code> checkpoint is instantiated:</p>
<div class="cell" data-outputid="45f559af-99fc-449e-a652-ac3a4b9e433a" data-execution_count="44">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1">ckpt_config <span class="op" style="color: #5E5E5E;">=</span> ColBERTConfig.load_from_checkpoint(<span class="bu" style="color: null;">str</span>(model_nm))</span>
<span id="cb101-2">ckpt_config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=None, centroid_score_threshold=None, ndocs=None, load_index_with_mmap=False, index_path=None, index_bsize=64, nbits=1, kmeans_niters=4, resume=False, pool_factor=1, clustering_mode='hierarchical', protected_tokens=0, similarity='cosine', bsize=32, accumsteps=1, lr=1e-05, maxsteps=15626, save_every=None, warmup=781, warmup_bert=None, relu=False, nway=32, use_ib_negatives=False, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name='answerdotai/AnswerAI-ColBERTv2.5-small', query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=96, doc_maxlen=300, mask_punctuation=True, checkpoint='/root/.cache/huggingface/hub/models--answerdotai--answerai-colbert-small-v1/snapshots/be1703c55532145a844da800eea4c9a692d7e267/', triples='/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl', collection='/home/bclavie/colbertv2.5_en/data/msmarco/collection.tsv', queries='/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv', index_name=None, overwrite=False, root='/home/bclavie/colbertv2.5_en/experiments', experiment='minicolbertv2.5', index_root=None, name='2024-08/07/08.16.20', rank=0, nranks=4, amp=True, gpus=4, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<div class="cell" data-outputid="6030245b-21ac-43ab-bc51-a9702c22a661" data-execution_count="45">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">config <span class="op" style="color: #5E5E5E;">=</span> ColBERTConfig.from_existing(ckpt_config)</span>
<span id="cb103-2">config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=None, centroid_score_threshold=None, ndocs=None, load_index_with_mmap=False, index_path=None, index_bsize=64, nbits=1, kmeans_niters=4, resume=False, pool_factor=1, clustering_mode='hierarchical', protected_tokens=0, similarity='cosine', bsize=32, accumsteps=1, lr=1e-05, maxsteps=15626, save_every=None, warmup=781, warmup_bert=None, relu=False, nway=32, use_ib_negatives=False, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name='answerdotai/AnswerAI-ColBERTv2.5-small', query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=96, doc_maxlen=300, mask_punctuation=True, checkpoint='/root/.cache/huggingface/hub/models--answerdotai--answerai-colbert-small-v1/snapshots/be1703c55532145a844da800eea4c9a692d7e267/', triples='/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl', collection='/home/bclavie/colbertv2.5_en/data/msmarco/collection.tsv', queries='/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv', index_name=None, overwrite=False, root='/home/bclavie/colbertv2.5_en/experiments', experiment='minicolbertv2.5', index_root=None, name='2024-08/07/08.16.20', rank=0, nranks=4, amp=True, gpus=4, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<p>We also need to create a <code>RunConfig</code> object:</p>
<div class="cell" data-outputid="36d6fd1b-c4b7-4f84-a1a9-ceb78c9accb1" data-execution_count="46">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1">run_config <span class="op" style="color: #5E5E5E;">=</span> RunConfig(nranks<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">1</span>, experiment<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbert"</span>, root<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">".ragatouille/"</span>)</span>
<span id="cb105-2">run_config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>RunConfig(overwrite=False, root='.ragatouille/', experiment='colbert', index_root=None, name='2025-03/13/01.14.35', rank=0, nranks=-1, amp=True, gpus=1, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<p>A couple more config values are set:</p>
<div class="cell" data-outputid="d74d250c-86e3-43d0-ed8b-2420290082d6" data-execution_count="47">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">config.avoid_fork_if_possible <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb107-2"></span>
<span id="cb107-3"><span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(collection) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">100000</span>:</span>
<span id="cb107-4">    config.kmeans_niters <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb107-5"><span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">len</span>(collection) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50000</span>:</span>
<span id="cb107-6">    config.kmeans_niters <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb107-7"><span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb107-8">    config.kmeans_niters <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">20</span></span>
<span id="cb107-9">config.avoid_fork_if_possible, config.kmeans_niters</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(True, 20)</code></pre>
</div>
</div>
<p>After determining whether the PyTorch or FAISS k-means implementation will be used, <code>Indexer.index</code> is called.</p>
</section>
</section>
<section id="indexer.index" class="level2">
<h2 class="anchored" data-anchor-id="indexer.index">Indexer.index</h2>
<p>The <code>Indexer</code> comes from the ColBERT repo, so this is essentially the connection point between the RAGatouille and ColBERT libraries.</p>
<section id="launcher" class="level3">
<h3 class="anchored" data-anchor-id="launcher">Launcher</h3>
<p>Inside <code>Indexer.index</code>, <code>__launch</code> is called, from within which a <code>Launcher</code> instance is created with the <code>encode</code> function.</p>
<p>I’m a bit fuzzy on the next part but I’ll give it a shot:</p>
<p>when <code>Launcher.launch</code> is called, the following two lines are called (where <code>callee</code> is the <code>encode</code> function):</p>
<div class="sourceCode" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1">args_ <span class="op" style="color: #5E5E5E;">=</span> (<span class="va" style="color: #111111;">self</span>.callee, port, return_value_queue, new_config, <span class="op" style="color: #5E5E5E;">*</span>args)</span>
<span id="cb109-2">all_procs.append(mp.Process(target<span class="op" style="color: #5E5E5E;">=</span>setup_new_process, args<span class="op" style="color: #5E5E5E;">=</span>args_))</span></code></pre></div>
<p><code>setup_new_process</code> contains the following lines:</p>
<div class="sourceCode" id="cb110" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><span class="cf" style="color: #003B4F;">with</span> Run().context(config, inherit_config<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>):</span>
<span id="cb110-2">    return_val <span class="op" style="color: #5E5E5E;">=</span> callee(config, <span class="op" style="color: #5E5E5E;">*</span>args)</span></code></pre></div>
<p>With <code>callee</code> being called, let’s look at the function that <code>callee</code> is : <code>encode</code>, which is part of the collection_indexer.py file.</p>
</section>
</section>
<section id="encode" class="level2">
<h2 class="anchored" data-anchor-id="encode">encode</h2>
<div class="sourceCode" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><span class="kw" style="color: #003B4F;">def</span> encode(config, collection, shared_lists, shared_queues, verbose: <span class="bu" style="color: null;">int</span> <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">3</span>):</span>
<span id="cb111-2">    encoder <span class="op" style="color: #5E5E5E;">=</span> CollectionIndexer(config<span class="op" style="color: #5E5E5E;">=</span>config, collection<span class="op" style="color: #5E5E5E;">=</span>collection, verbose<span class="op" style="color: #5E5E5E;">=</span>verbose)</span>
<span id="cb111-3">    encoder.run(shared_lists)</span></code></pre></div>
<p>This leads us to <code>encoder.run</code> which is <code>CollectionIndexer.run</code>. But before that, we need to look at how the collection is transformed when <code>CollectionIndexer</code> is instantiated.</p>
</section>
<section id="collectionindexer.__init__" class="level2">
<h2 class="anchored" data-anchor-id="collectionindexer.__init__">CollectionIndexer.__init__</h2>
<p>There are two important objects created when the <code>CollectionIndexer</code> is instantiated. First is the <code>Collection</code> object, which turns our list <code>collection</code>:</p>
<div class="cell" data-outputid="7e5b183f-41a1-4a6b-d0a0-526ed5504b0e" data-execution_count="48">
<div class="sourceCode cell-code" id="cb112" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><span class="bu" style="color: null;">type</span>(collection)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>list</code></pre>
</div>
</div>
<p>into a <code>Collection</code> object:</p>
<div class="cell" data-outputid="4542f1a3-6850-4403-ec5d-229a6867ac95" data-execution_count="49">
<div class="sourceCode cell-code" id="cb114" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1">collection <span class="op" style="color: #5E5E5E;">=</span> Collection.cast(collection)</span>
<span id="cb114-2">collection</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>&lt;colbert.data.collection.Collection at 0x794fa037e410&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="1b3747d7-93d9-4b39-c5bb-d9a6cd236a16" data-execution_count="50">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><span class="bu" style="color: null;">type</span>(collection)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.data.collection.Collection</b><br>def __init__(path=None, data=None)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.11/dist-packages/colbert/data/collection.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 14);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<p>Next, it creates a <code>CollectionEncoder</code> object:</p>
<div class="cell" data-outputid="287c057a-b53b-4e29-b8e2-3fa7945b558c" data-execution_count="51">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1">checkpoint <span class="op" style="color: #5E5E5E;">=</span> Checkpoint(config.checkpoint, colbert_config<span class="op" style="color: #5E5E5E;">=</span>config)</span>
<span id="cb117-2">encoder <span class="op" style="color: #5E5E5E;">=</span> CollectionEncoder(config, checkpoint)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:12: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  self.scaler = torch.cuda.amp.GradScaler()</code></pre>
</div>
</div>
<p><code>checkpoint</code> is our model:</p>
<div class="cell" data-outputid="d4e3ee56-c931-4512-c4e5-4e3b94ffeaa4" data-execution_count="52">
<div class="sourceCode cell-code" id="cb119" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1">checkpoint</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>Checkpoint(
  (model): HF_ColBERT(
    (linear): Linear(in_features=384, out_features=96, bias=False)
    (bert): BertModel(
      (embeddings): BertEmbeddings(
        (word_embeddings): Embedding(30522, 384, padding_idx=0)
        (position_embeddings): Embedding(512, 384)
        (token_type_embeddings): Embedding(2, 384)
        (LayerNorm): LayerNorm((384,), eps=1e-12, elementwise_affine=True)
        (dropout): Dropout(p=0.1, inplace=False)
      )
      (encoder): BertEncoder(
        (layer): ModuleList(
          (0-11): 12 x BertLayer(
            (attention): BertAttention(
              (self): BertSdpaSelfAttention(
                (query): Linear(in_features=384, out_features=384, bias=True)
                (key): Linear(in_features=384, out_features=384, bias=True)
                (value): Linear(in_features=384, out_features=384, bias=True)
                (dropout): Dropout(p=0.1, inplace=False)
              )
              (output): BertSelfOutput(
                (dense): Linear(in_features=384, out_features=384, bias=True)
                (LayerNorm): LayerNorm((384,), eps=1e-12, elementwise_affine=True)
                (dropout): Dropout(p=0.1, inplace=False)
              )
            )
            (intermediate): BertIntermediate(
              (dense): Linear(in_features=384, out_features=1536, bias=True)
              (intermediate_act_fn): GELUActivation()
            )
            (output): BertOutput(
              (dense): Linear(in_features=1536, out_features=384, bias=True)
              (LayerNorm): LayerNorm((384,), eps=1e-12, elementwise_affine=True)
              (dropout): Dropout(p=0.1, inplace=False)
            )
          )
        )
      )
      (pooler): BertPooler(
        (dense): Linear(in_features=384, out_features=384, bias=True)
        (activation): Tanh()
      )
    )
  )
)</code></pre>
</div>
</div>
<p>The <code>CollectionEncoder</code> will be used later on to encode the passages.</p>
<div class="cell" data-outputid="4a91eac1-1fcd-4304-9aa7-c9116e131bc4" data-execution_count="53">
<div class="sourceCode cell-code" id="cb121" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1">encoder</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>&lt;colbert.indexing.collection_encoder.CollectionEncoder at 0x794fa0683dd0&gt;</code></pre>
</div>
</div>
<p>Next we’ll dive into <code>CollectionIndexer.run</code> within which all of the indexing operations that I’m most interested in take place, starting with <code>setup</code>.</p>
</section>
<section id="collectionindexer.run" class="level2">
<h2 class="anchored" data-anchor-id="collectionindexer.run">CollectionIndexer.run</h2>
<section id="collectionindexer.setup" class="level3">
<h3 class="anchored" data-anchor-id="collectionindexer.setup">CollectionIndexer.setup</h3>
<pre><code>'''
Calculates and saves plan.json for the whole collection.

plan.json { config, num_chunks, num_partitions, num_embeddings_est, avg_doclen_est}
num_partitions is the number of centroids to be generated.
'''</code></pre>
<p>We’ll see where <code>num_chunks</code> is used, but for now I’ll just define it:</p>
<div class="cell" data-outputid="4608be3d-b02a-4824-9af6-5179e47e4662" data-execution_count="54">
<div class="sourceCode cell-code" id="cb124" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1">num_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(np.ceil(<span class="bu" style="color: null;">len</span>(collection) <span class="op" style="color: #5E5E5E;">/</span> collection.get_chunksize()))</span>
<span id="cb124-2"><span class="bu" style="color: null;">len</span>(collection), collection.get_chunksize(), num_chunks</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>(1000, 1001, 1)</code></pre>
</div>
</div>
<p>Next we look at <code>_sample_pids</code> and <code>_sample_embeddings</code> which are later clustered to get our centroids.</p>
<section id="sample_pids" class="level4">
<h4 class="anchored" data-anchor-id="sample_pids">_sample_pids</h4>
<div class="cell" data-outputid="bf8f7646-fe8c-48d8-a32a-bb2183c3d9aa" data-execution_count="55">
<div class="sourceCode cell-code" id="cb126" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1">num_passages <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(collection)</span>
<span id="cb126-2">num_passages</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>1000</code></pre>
</div>
</div>
<p>It’s awesome to see one of the heuristics mentioned in the <a href="https://arxiv.org/abs/2112.01488">ColBERTv2 paper</a>:</p>
<blockquote class="blockquote">
<p>To reduce memory consumption, we apply k-means clustering to the embeddings produced by invoking our BERT encoder over only a sample of all passages, proportional to the square root of the collection size, an approach we found to perform well in practice.</p>
</blockquote>
<div class="cell" data-outputid="3dc9f49f-7fe1-42c1-a2b3-8e7780d9d1ee" data-execution_count="56">
<div class="sourceCode cell-code" id="cb128" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1">typical_doclen <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">120</span></span>
<span id="cb128-2">sampled_pids <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">16</span> <span class="op" style="color: #5E5E5E;">*</span> np.sqrt(typical_doclen <span class="op" style="color: #5E5E5E;">*</span> num_passages)</span>
<span id="cb128-3">sampled_pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>5542.562584220407</code></pre>
</div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb130" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1">sampled_pids <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="bu" style="color: null;">int</span>(sampled_pids), num_passages)</span></code></pre></div>
</div>
<p>In this case because my toy collection is so small (1000 passages) we will use all of them for centroid clustering.</p>
<div class="cell" data-outputid="d9d310be-a543-4cac-aadd-94fe8439164f" data-execution_count="58">
<div class="sourceCode cell-code" id="cb131" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1">sampled_pids <span class="op" style="color: #5E5E5E;">=</span> random.sample(<span class="bu" style="color: null;">range</span>(num_passages), sampled_pids)</span>
<span id="cb131-2">sampled_pids <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(sampled_pids)</span>
<span id="cb131-3"><span class="bu" style="color: null;">len</span>(sampled_pids), <span class="bu" style="color: null;">min</span>(sampled_pids), <span class="bu" style="color: null;">max</span>(sampled_pids)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>(1000, 0, 999)</code></pre>
</div>
</div>
</section>
<section id="sample_embeddings" class="level4">
<h4 class="anchored" data-anchor-id="sample_embeddings">_sample_embeddings</h4>
<div class="cell" data-outputid="695c7b09-bd48-4085-ddcb-78113cbe4cbf" data-execution_count="59">
<div class="sourceCode cell-code" id="cb133" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1">local_pids <span class="op" style="color: #5E5E5E;">=</span> collection.<span class="bu" style="color: null;">enumerate</span>(rank<span class="op" style="color: #5E5E5E;">=</span>config.rank)</span>
<span id="cb133-2">local_pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>&lt;generator object Collection.enumerate at 0x794fa067dc40&gt;</code></pre>
</div>
</div>
<p><code>sampled_pids</code> contains all of our passages</p>
<div class="cell" data-outputid="131ba5cd-16c8-42ae-c811-fe0eaecfb591" data-execution_count="60">
<div class="sourceCode cell-code" id="cb135" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1">local_sample <span class="op" style="color: #5E5E5E;">=</span> [passage <span class="cf" style="color: #003B4F;">for</span> pid, passage <span class="kw" style="color: #003B4F;">in</span> local_pids <span class="cf" style="color: #003B4F;">if</span> pid <span class="kw" style="color: #003B4F;">in</span> sampled_pids]</span>
<span id="cb135-2"><span class="bu" style="color: null;">len</span>(local_sample)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>1000</code></pre>
</div>
</div>
<p>Next come another critical process—encoding our passages!</p>
</section>
<section id="collectionencoder.encode_passages" class="level4">
<h4 class="anchored" data-anchor-id="collectionencoder.encode_passages">CollectionEncoder.encode_passages</h4>
<p>Inside <code>encode_passages</code> we call <code>checkpoint.docFromText</code>.</p>
</section>
<section id="checkpoint.docfromtext" class="level4">
<h4 class="anchored" data-anchor-id="checkpoint.docfromtext">checkpoint.docFromText</h4>
<p>And inside <code>checkpoint.docFromText</code> we call <code>checkpoint.doc</code></p>
</section>
<section id="checkpoint.doc" class="level4">
<h4 class="anchored" data-anchor-id="checkpoint.doc">checkpoint.doc</h4>
<p>Inside <code>ColBERT.doc</code> we finally call the lowest-level method in this chain:</p>
<div class="sourceCode" id="cb137" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1">D <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.bert(input_ids, attention_mask<span class="op" style="color: #5E5E5E;">=</span>attention_mask)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<p>One key point to visualize is that the BERT output is normalized:</p>
<div class="sourceCode" id="cb138" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"> D <span class="op" style="color: #5E5E5E;">=</span> torch.nn.functional.normalize(D, p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<p>I’ll zoom out again and call <code>encode_passages</code>.</p>
<div class="cell" data-outputid="baf86309-4cd0-415d-d2c2-239648f21835" data-execution_count="61">
<div class="sourceCode cell-code" id="cb139" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1">local_sample_embs, doclens <span class="op" style="color: #5E5E5E;">=</span> encoder.encode_passages(local_sample)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:18:18] [0]       #&gt; Encoding 1000 passages..</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:15: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  return torch.cuda.amp.autocast() if self.activated else NullContextManager()</code></pre>
</div>
</div>
<div class="cell" data-outputid="5368e56a-dc60-4b05-e281-6bc83260149d" data-execution_count="62">
<div class="sourceCode cell-code" id="cb142" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1">local_sample_embs.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>torch.Size([15198, 96])</code></pre>
</div>
</div>
<p>Note that the token embeddings are a unit vector:</p>
<div class="cell" data-outputid="7535c91f-acbc-4310-fe2c-eceaa0aac05e" data-execution_count="63">
<div class="sourceCode cell-code" id="cb144" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1">local_sample_embs[<span class="dv" style="color: #AD0000;">0</span>].norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>tensor(1., dtype=torch.float16)</code></pre>
</div>
</div>
<div class="cell" data-outputid="51a948d6-7cc9-424f-f0fd-aec96603de60" data-execution_count="64">
<div class="sourceCode cell-code" id="cb146" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><span class="bu" style="color: null;">len</span>(doclens), doclens[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>(1000, [4, 20, 18, 23, 8])</code></pre>
</div>
</div>
<p>We have 15198 token embeddings (embedded into answerai-colbert-small-v1’s 96-dimension space) and a mapping (list) of passage ID (indices) to number of tokens (values).</p>
<div class="cell" data-outputid="58d443ae-bb70-432c-fa22-e4d6508ee855" data-execution_count="65">
<div class="sourceCode cell-code" id="cb148" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1">avg_doclen_est <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sum</span>(doclens) <span class="op" style="color: #5E5E5E;">/</span> <span class="bu" style="color: null;">len</span>(doclens) <span class="cf" style="color: #003B4F;">if</span> doclens <span class="cf" style="color: #003B4F;">else</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb148-2">avg_doclen_est</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>15.198</code></pre>
</div>
</div>
<p>On average, each passage (document) is 15 tokens long.</p>
<p>Zooming back out to CollectionIndexer.setup we have a few more steps before our planning is complete:</p>
<div class="cell" data-outputid="204bfd18-33ef-4bdb-c0f9-08f6fb4a4261" data-execution_count="66">
<div class="sourceCode cell-code" id="cb150" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1">num_passages <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(collection)</span>
<span id="cb150-2">num_embeddings_est <span class="op" style="color: #5E5E5E;">=</span> num_passages <span class="op" style="color: #5E5E5E;">*</span> avg_doclen_est</span>
<span id="cb150-3">num_partitions <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">**</span> np.floor(np.log2(<span class="dv" style="color: #AD0000;">16</span> <span class="op" style="color: #5E5E5E;">*</span> np.sqrt(num_embeddings_est))))</span>
<span id="cb150-4">num_passages, num_embeddings_est, num_partitions</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>(1000, 15198.0, 1024)</code></pre>
</div>
</div>
<p><code>num_partitions</code> is the number of clusters we will cluster our 15198 token embeddings into.</p>
<p>This is the information that was in plan.json in <code>index_path</code> (in addition to the other ColBERTConfig information).</p>
</section>
</section>
</section>
<section id="collectionindexer.train" class="level2">
<h2 class="anchored" data-anchor-id="collectionindexer.train">CollectionIndexer.train</h2>
<p>After <code>setup</code> is complete, the next method called in <code>run</code> is <code>train</code>.</p>
<p>The first step in <code>train</code> is to split our <code>local_sample_embs</code> into <code>sample</code> and <code>sample_heldout</code>.</p>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb152" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1">local_sample_embs <span class="op" style="color: #5E5E5E;">=</span> local_sample_embs[torch.randperm(local_sample_embs.size(<span class="dv" style="color: #AD0000;">0</span>))]</span></code></pre></div>
</div>
<div class="cell" data-outputid="ec7757d2-ca75-477d-84f3-f81c3517883a" data-execution_count="68">
<div class="sourceCode cell-code" id="cb153" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1">heldout_fraction <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.05</span></span>
<span id="cb153-2">heldout_size <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(<span class="bu" style="color: null;">min</span>(heldout_fraction <span class="op" style="color: #5E5E5E;">*</span> local_sample_embs.size(<span class="dv" style="color: #AD0000;">0</span>), <span class="dv" style="color: #AD0000;">50_000</span>))</span>
<span id="cb153-3">heldout_size</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>759</code></pre>
</div>
</div>
<div class="cell" data-outputid="6f55866f-73fe-4764-8f4b-75357ff74422" data-execution_count="69">
<div class="sourceCode cell-code" id="cb155" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1">sample, sample_heldout <span class="op" style="color: #5E5E5E;">=</span> local_sample_embs.split([local_sample_embs.size(<span class="dv" style="color: #AD0000;">0</span>) <span class="op" style="color: #5E5E5E;">-</span> heldout_size, heldout_size], dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb155-2">sample.shape, sample_heldout.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>(torch.Size([14439, 96]), torch.Size([759, 96]))</code></pre>
</div>
</div>
<section id="compute_faiss_kmeans" class="level3">
<h3 class="anchored" data-anchor-id="compute_faiss_kmeans">compute_faiss_kmeans</h3>
<p>Next we get the centroids using <code>compute_faiss_kmeans</code></p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb157" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1">args_ <span class="op" style="color: #5E5E5E;">=</span> [config.dim, num_partitions, config.kmeans_niters, [[sample]]]</span></code></pre></div>
</div>
<div class="cell" data-outputid="054f14d5-c959-471a-8b5e-ed27aa85b2a3" data-execution_count="71">
<div class="sourceCode cell-code" id="cb158" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1">centroids <span class="op" style="color: #5E5E5E;">=</span> compute_faiss_kmeans(<span class="op" style="color: #5E5E5E;">*</span>args_)</span>
<span id="cb158-2">centroids.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>torch.Size([1024, 96])</code></pre>
</div>
</div>
<p>We then normalize the centroids</p>
<div class="cell" data-outputid="cf1bbf89-4877-4093-fe5c-81dc240a6794" data-execution_count="72">
<div class="sourceCode cell-code" id="cb160" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1">centroids <span class="op" style="color: #5E5E5E;">=</span> torch.nn.functional.normalize(centroids, dim<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb160-2">centroids.shape, centroids[<span class="dv" style="color: #AD0000;">0</span>].norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>(torch.Size([1024, 96]), tensor(1.))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb162" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1">centroids <span class="op" style="color: #5E5E5E;">=</span> centroids.half()</span></code></pre></div>
</div>
<p>I was hoping to get the same values as <code>RAG.index</code> centroids by setting seeds at the start of this notebook, but I am not getting the same result.</p>
<div class="cell" data-outputid="9f560916-f170-474e-f865-9a7313707a5c" data-execution_count="74">
<div class="sourceCode cell-code" id="cb163" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1">_centroids[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>tensor([-0.0649,  0.1193, -0.0551,  0.0561, -0.0826], device='cuda:0',
       dtype=torch.float16)</code></pre>
</div>
</div>
<div class="cell" data-outputid="d9d7ff01-dce7-403d-fa02-f04cb7ac8318" data-execution_count="75">
<div class="sourceCode cell-code" id="cb165" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1">centroids[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor([-0.0587,  0.0379, -0.0847, -0.0224, -0.0636], dtype=torch.float16)</code></pre>
</div>
</div>
<p>I’ll use PCA to compare the two sets of centroids:</p>
<div class="cell" data-outputid="364dc72a-4316-4c4b-c262-4ce9c136f239" data-execution_count="76">
<div class="sourceCode cell-code" id="cb167" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><span class="co" style="color: #5E5E5E;"># Project to 2D</span></span>
<span id="cb167-2">pca <span class="op" style="color: #5E5E5E;">=</span> PCA(n_components<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb167-3">prev_2d <span class="op" style="color: #5E5E5E;">=</span> pca.fit_transform(_centroids.cpu().numpy())</span>
<span id="cb167-4">new_2d <span class="op" style="color: #5E5E5E;">=</span> pca.transform(centroids.cpu().numpy())</span>
<span id="cb167-5"></span>
<span id="cb167-6"><span class="co" style="color: #5E5E5E;"># Plot</span></span>
<span id="cb167-7">plt.figure(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">10</span>, <span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb167-8">plt.scatter(prev_2d[:, <span class="dv" style="color: #AD0000;">0</span>], prev_2d[:, <span class="dv" style="color: #AD0000;">1</span>], alpha<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.5</span>, label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Previous'</span>)</span>
<span id="cb167-9">plt.scatter(new_2d[:, <span class="dv" style="color: #AD0000;">0</span>], new_2d[:, <span class="dv" style="color: #AD0000;">1</span>], alpha<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.5</span>, label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'New'</span>)</span>
<span id="cb167-10">plt.legend()</span>
<span id="cb167-11">plt.title(<span class="st" style="color: #20794D;">'PCA projection of centroids'</span>)</span>
<span id="cb167-12">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-78-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2025-03-12-RAGatouille-ColBERT-Indexing-Deep-Dive/index_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I’m not super familiar with interpreting PCA plots, so I asked Claude what it thought about this result:</p>
<blockquote class="blockquote">
<p>I would describe this as showing “good structural similarity but with expected local variations.” The centroids aren’t identical (which would show perfect overlap), but they capture similar patterns in the embedding space. This suggests that while individual centroid positions differ, the overall index structure should perform similarly for retrieval tasks.</p>
</blockquote>
<p>For now, I’ll consider this part of indexing completing, as we have generated similar contents to what’s in centroids.pt.</p>
</section>
<section id="compute_avg_residual" class="level3">
<h3 class="anchored" data-anchor-id="compute_avg_residual">_compute_avg_residual</h3>
<p>This next section was quite eye opening for me, as it was the first time I understood how quantization is implemented.</p>
<p>The <code>ResidualCodec</code> does all of the compression/binarization/decompress of residuals.</p>
<div class="cell" data-outputid="63e544fc-d70a-4ec4-c20d-f662dcd573dd" data-execution_count="77">
<div class="sourceCode cell-code" id="cb168" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1">compressor <span class="op" style="color: #5E5E5E;">=</span> ResidualCodec(config<span class="op" style="color: #5E5E5E;">=</span>config, centroids<span class="op" style="color: #5E5E5E;">=</span>centroids, avg_residual<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>)</span>
<span id="cb168-2">compressor</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>&lt;colbert.indexing.codecs.residual.ResidualCodec at 0x794f9aacfdd0&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="91dd3f8e-f5d4-4011-b8b6-8f07d856f678" data-execution_count="78">
<div class="sourceCode cell-code" id="cb170" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1">heldout_reconstruct <span class="op" style="color: #5E5E5E;">=</span> compressor.compress_into_codes(sample_heldout, out_device<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'cuda'</span> )</span>
<span id="cb170-2">heldout_reconstruct.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>torch.Size([759])</code></pre>
</div>
</div>
<p><code>compress_into_codes</code> finds the nearest centroid IDs to the token embeddings. It does so using cosine similarity:</p>
<div class="sourceCode" id="cb172" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1">indices <span class="op" style="color: #5E5E5E;">=</span> (<span class="va" style="color: #111111;">self</span>.centroids <span class="op" style="color: #5E5E5E;">@</span> batch.T.cuda().half()).<span class="bu" style="color: null;">max</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>).indices.to(device<span class="op" style="color: #5E5E5E;">=</span>out_device)</span></code></pre></div>
<div class="cell" data-outputid="7d386c67-5697-4b06-bc60-3016a5268171" data-execution_count="79">
<div class="sourceCode cell-code" id="cb173" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1">heldout_reconstruct[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>tensor([633, 667, 738, 641, 443], device='cuda:0')</code></pre>
</div>
</div>
<p><code>lookup_centroids</code> gets the full vectors related to the centroid IDs in <code>heldout_reconstruct</code></p>
<div class="cell" data-outputid="1828d155-c7d2-49d6-ee0b-bf28088fed2f" data-execution_count="80">
<div class="sourceCode cell-code" id="cb175" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1">heldout_reconstruct <span class="op" style="color: #5E5E5E;">=</span> compressor.lookup_centroids(heldout_reconstruct, out_device<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'cuda'</span>)</span>
<span id="cb175-2">heldout_reconstruct.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>torch.Size([759, 96])</code></pre>
</div>
</div>
<p>The residual between the heldout token embeddings and the closest centroids is then calculated:</p>
<div class="cell" data-outputid="fa4c97ef-1b38-47cb-e495-71769187250b" data-execution_count="81">
<div class="sourceCode cell-code" id="cb177" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1">heldout_avg_residual <span class="op" style="color: #5E5E5E;">=</span> sample_heldout.cuda() <span class="op" style="color: #5E5E5E;">-</span> heldout_reconstruct</span>
<span id="cb177-2">heldout_avg_residual.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>torch.Size([759, 96])</code></pre>
</div>
</div>
<p>We then calculate the average residual vector (96 dimensions):</p>
<div class="cell" data-outputid="1abb38ee-908f-4466-ee55-18874f0cf623" data-execution_count="82">
<div class="sourceCode cell-code" id="cb179" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1">avg_residual <span class="op" style="color: #5E5E5E;">=</span> torch.<span class="bu" style="color: null;">abs</span>(heldout_avg_residual).mean(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>).cpu()</span>
<span id="cb179-2">avg_residual.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>torch.Size([96])</code></pre>
</div>
</div>
<p>The average residual is somewhat similar to the stored value in avg_residual.pt.</p>
<div class="cell" data-outputid="9851ccd2-9b46-4391-ca49-60e73eb9143b" data-execution_count="83">
<div class="sourceCode cell-code" id="cb181" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1">_avg_residual, avg_residual.mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>(tensor(0.0150, device='cuda:0', dtype=torch.float16),
 tensor(0.0158, dtype=torch.float16))</code></pre>
</div>
</div>
<p>To match the <code>RAG.index</code> defaults, I’m going to set <code>nbits</code> to 4.</p>
<div class="cell" data-outputid="d40f05df-3a4a-49ea-d2d3-c95a13fe8f05" data-execution_count="84">
<div class="sourceCode cell-code" id="cb183" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1">config.nbits</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell" data-outputid="b221b665-e69d-4f60-d7bf-e103bc4f07ea" data-execution_count="85">
<div class="sourceCode cell-code" id="cb185" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1">config.nbits <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb185-2">config.nbits</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>4</code></pre>
</div>
</div>
<div class="cell" data-outputid="caa9c096-c212-4d1d-c2fc-5dc98b08f134" data-execution_count="86">
<div class="sourceCode cell-code" id="cb187" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1">num_options <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">**</span> config.nbits</span>
<span id="cb187-2">config.nbits, num_options</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>(4, 16)</code></pre>
</div>
</div>
<p>A 4-bit value has four 0 or 1 values and there are 16 possible combinations:</p>
<table class="table">
<thead>
<tr class="header">
<th>Binary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0000</td>
</tr>
<tr class="even">
<td>0001</td>
</tr>
<tr class="odd">
<td>0010</td>
</tr>
<tr class="even">
<td>0011</td>
</tr>
<tr class="odd">
<td>0100</td>
</tr>
<tr class="even">
<td>0101</td>
</tr>
<tr class="odd">
<td>0110</td>
</tr>
<tr class="even">
<td>0111</td>
</tr>
<tr class="odd">
<td>1000</td>
</tr>
<tr class="even">
<td>1001</td>
</tr>
<tr class="odd">
<td>1010</td>
</tr>
<tr class="even">
<td>1011</td>
</tr>
<tr class="odd">
<td>1100</td>
</tr>
<tr class="even">
<td>1101</td>
</tr>
<tr class="odd">
<td>1110</td>
</tr>
<tr class="even">
<td>1111</td>
</tr>
</tbody>
</table>
<p>We split 0-to-1 into 16 equal parts:</p>
<div class="cell" data-outputid="d7e5088e-a9a2-4bf2-ef43-6cd89420cbbb" data-execution_count="87">
<div class="sourceCode cell-code" id="cb189" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1">quantiles <span class="op" style="color: #5E5E5E;">=</span> torch.arange(<span class="dv" style="color: #AD0000;">0</span>, num_options, device<span class="op" style="color: #5E5E5E;">=</span>heldout_avg_residual.device) <span class="op" style="color: #5E5E5E;">*</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> num_options)</span>
<span id="cb189-2">quantiles.shape, quantiles</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>(torch.Size([16]),
 tensor([0.0000, 0.0625, 0.1250, 0.1875, 0.2500, 0.3125, 0.3750, 0.4375, 0.5000,
         0.5625, 0.6250, 0.6875, 0.7500, 0.8125, 0.8750, 0.9375],
        device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-outputid="aad0ff4d-d8f5-490c-8ab5-ea569284ecb7" data-execution_count="88">
<div class="sourceCode cell-code" id="cb191" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1">bucket_cutoffs_quantiles, bucket_weights_quantiles <span class="op" style="color: #5E5E5E;">=</span> quantiles[<span class="dv" style="color: #AD0000;">1</span>:], quantiles <span class="op" style="color: #5E5E5E;">+</span> (<span class="fl" style="color: #AD0000;">0.5</span> <span class="op" style="color: #5E5E5E;">/</span> num_options)</span>
<span id="cb191-2">bucket_cutoffs_quantiles, bucket_weights_quantiles</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>(tensor([0.0625, 0.1250, 0.1875, 0.2500, 0.3125, 0.3750, 0.4375, 0.5000, 0.5625,
         0.6250, 0.6875, 0.7500, 0.8125, 0.8750, 0.9375], device='cuda:0'),
 tensor([0.0312, 0.0938, 0.1562, 0.2188, 0.2812, 0.3438, 0.4062, 0.4688, 0.5312,
         0.5938, 0.6562, 0.7188, 0.7812, 0.8438, 0.9062, 0.9688],
        device='cuda:0'))</code></pre>
</div>
</div>
<p>IIUC, the weights’ quantiles are the midpoints between adjacent cutoffs’ quantiles.</p>
<div class="cell" data-outputid="91a23e13-086b-4777-aa6f-a9f5b246825f" data-execution_count="89">
<div class="sourceCode cell-code" id="cb193" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1">(bucket_cutoffs_quantiles[<span class="dv" style="color: #AD0000;">1</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs_quantiles[<span class="dv" style="color: #AD0000;">2</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>tensor(0.1562, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="e84a2eef-9e00-4ba8-c455-645783076de1" data-execution_count="90">
<div class="sourceCode cell-code" id="cb195" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1">(bucket_cutoffs_quantiles[<span class="dv" style="color: #AD0000;">3</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs_quantiles[<span class="dv" style="color: #AD0000;">4</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor(0.2812, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="770906cf-1692-4c8a-c273-26905182aeac" data-execution_count="91">
<div class="sourceCode cell-code" id="cb197" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1">(bucket_cutoffs_quantiles[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs_quantiles[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>tensor(0.9062, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb199" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1">bucket_cutoffs <span class="op" style="color: #5E5E5E;">=</span> heldout_avg_residual.<span class="bu" style="color: null;">float</span>().quantile(bucket_cutoffs_quantiles)</span>
<span id="cb199-2">bucket_weights <span class="op" style="color: #5E5E5E;">=</span> heldout_avg_residual.<span class="bu" style="color: null;">float</span>().quantile(bucket_weights_quantiles)</span></code></pre></div>
</div>
<p>IIUC, <code>bucket_cutoffs</code> are the values with which we can group our (flattened) <code>heldout_avg_residual</code>s into 16 equal groups. Visualized here by setting the bins to <code>bucket_cutoffs</code>.</p>
<div class="cell" data-outputid="a25d3724-e9fe-4ba8-f0e4-07621a74e7c3" data-execution_count="93">
<div class="sourceCode cell-code" id="cb200" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1">pd.Series(heldout_avg_residual.flatten().cpu()).hist(bins<span class="op" style="color: #5E5E5E;">=</span>bucket_cutoffs.cpu())</span>
<span id="cb200-2">plt.xlim([<span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.035</span>, <span class="fl" style="color: #AD0000;">0.035</span>])</span>
<span id="cb200-3">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-95-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2025-03-12-RAGatouille-ColBERT-Indexing-Deep-Dive/index_files/figure-html/cell-95-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Perhaps due to randomness during the sample split, my manually calculated cutoffs are not quite the same as the <code>RAG.index</code> values.</p>
<div class="cell" data-outputid="51ca7346-ac8f-43dd-aad1-4cd0e1d4885e" data-execution_count="94">
<div class="sourceCode cell-code" id="cb201" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1">bucket_cutoffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>tensor([-0.0322, -0.0219, -0.0156, -0.0108, -0.0070, -0.0040, -0.0017,  0.0000,
         0.0019,  0.0042,  0.0071,  0.0108,  0.0155,  0.0220,  0.0327],
       device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="ff1b5563-7c6b-48d7-8d25-c2742fca0614" data-execution_count="95">
<div class="sourceCode cell-code" id="cb203" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1">_bucket_cutoffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>tensor([-0.0307, -0.0205, -0.0146, -0.0099, -0.0064, -0.0037, -0.0016,  0.0000,
         0.0017,  0.0038,  0.0066,  0.0102,  0.0150,  0.0211,  0.0313],
       device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="0bbd9adb-7d24-49d1-ae17-80ea28e16e61" data-execution_count="96">
<div class="sourceCode cell-code" id="cb205" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1">bucket_weights</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>tensor([-0.0434, -0.0261, -0.0185, -0.0131, -0.0088, -0.0054, -0.0028, -0.0009,
         0.0009,  0.0029,  0.0055,  0.0088,  0.0130,  0.0184,  0.0262,  0.0441],
       device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="8eed6fed-a09a-4a78-d340-2deaeb08189b" data-execution_count="97">
<div class="sourceCode cell-code" id="cb207" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1">_bucket_weights</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>tensor([-0.0411, -0.0247, -0.0173, -0.0121, -0.0081, -0.0050, -0.0026, -0.0007,
         0.0007,  0.0027,  0.0052,  0.0083,  0.0124,  0.0178,  0.0253,  0.0421],
       device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>There seems to be some rounding differences (or perhaps it depends on the distribution?) but the weights again seem to be the midpoints-ish between the cutoffs.</p>
<div class="cell" data-outputid="fae360c9-59e9-4c91-84b1-5282a62c4dd8" data-execution_count="98">
<div class="sourceCode cell-code" id="cb209" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1">(bucket_cutoffs[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs[<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>tensor(-0.0270, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="0ce69033-621e-4ed5-ebee-c03c57bf4ee1" data-execution_count="99">
<div class="sourceCode cell-code" id="cb211" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1">(bucket_cutoffs[<span class="dv" style="color: #AD0000;">3</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs[<span class="dv" style="color: #AD0000;">4</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>tensor(-0.0089, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="228f1503-ef60-4224-fb95-34e25c4540f0" data-execution_count="100">
<div class="sourceCode cell-code" id="cb213" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1">(bucket_cutoffs[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>] <span class="op" style="color: #5E5E5E;">+</span> bucket_cutoffs[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor(0.0273, device='cuda:0')</code></pre>
</div>
</div>
</section>
</section>
<section id="collectionindexer.index" class="level2">
<h2 class="anchored" data-anchor-id="collectionindexer.index">CollectionIndexer.index</h2>
<p>Thus far we have found centroids from a sample of our token embeddings (5%, or 759) and calculated bucket cutoffs and bucket weights for quantization. We also know what the average residual mean value is.</p>
<p>Now we find the closest centroids and residuals for all passages’ token embeddings, starting first by encoding all 15198 tokens with our model:</p>
<div class="cell" data-outputid="dbfd1e50-465c-4ec6-85f8-d9e4cc6050c9" data-execution_count="101">
<div class="sourceCode cell-code" id="cb215" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1">embs, doclens <span class="op" style="color: #5E5E5E;">=</span> encoder.encode_passages(collection)</span>
<span id="cb215-2">embs.shape, <span class="bu" style="color: null;">len</span>(doclens), doclens[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Mar 13, 01:18:21] [0]       #&gt; Encoding 1000 passages..</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.11/dist-packages/colbert/utils/amp.py:15: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  return torch.cuda.amp.autocast() if self.activated else NullContextManager()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>(torch.Size([15198, 96]), 1000, [4, 20, 18, 23, 8])</code></pre>
</div>
</div>
<p>Then we call <code>save_chunk</code> which is inside the <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/indexing/index_saver.py#L70"><code>IndexSaver</code></a> within which some interesting things take place:</p>
<div class="sourceCode" id="cb219" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><span class="kw" style="color: #003B4F;">def</span> save_chunk(<span class="va" style="color: #111111;">self</span>, chunk_idx, offset, embs, doclens):</span>
<span id="cb219-2">        compressed_embs <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.codec.compress(embs)</span></code></pre></div>
<p>Looking into <code>ResidualCodec.compress</code>:</p>
<div class="sourceCode" id="cb220" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><span class="kw" style="color: #003B4F;">def</span> compress(<span class="va" style="color: #111111;">self</span>, embs):</span>
<span id="cb220-2">        codes, residuals <span class="op" style="color: #5E5E5E;">=</span> [], []</span>
<span id="cb220-3"></span>
<span id="cb220-4">        <span class="cf" style="color: #003B4F;">for</span> batch <span class="kw" style="color: #003B4F;">in</span> embs.split(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;">18</span>):</span>
<span id="cb220-5">            <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.use_gpu:</span>
<span id="cb220-6">                batch <span class="op" style="color: #5E5E5E;">=</span> batch.cuda().half()</span>
<span id="cb220-7">            codes_ <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.compress_into_codes(batch, out_device<span class="op" style="color: #5E5E5E;">=</span>batch.device)</span>
<span id="cb220-8">            centroids_ <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.lookup_centroids(codes_, out_device<span class="op" style="color: #5E5E5E;">=</span>batch.device)</span>
<span id="cb220-9"></span>
<span id="cb220-10">            residuals_ <span class="op" style="color: #5E5E5E;">=</span> (batch <span class="op" style="color: #5E5E5E;">-</span> centroids_)</span>
<span id="cb220-11"></span>
<span id="cb220-12">            codes.append(codes_.cpu())</span>
<span id="cb220-13">            residuals.append(<span class="va" style="color: #111111;">self</span>.binarize(residuals_).cpu())</span>
<span id="cb220-14"></span>
<span id="cb220-15">        codes <span class="op" style="color: #5E5E5E;">=</span> torch.cat(codes)</span>
<span id="cb220-16">        residuals <span class="op" style="color: #5E5E5E;">=</span> torch.cat(residuals)</span>
<span id="cb220-17"></span>
<span id="cb220-18">        <span class="cf" style="color: #003B4F;">return</span> ResidualCodec.Embeddings(codes, residuals)</span></code></pre></div>
<p>We’ve seen <code>compress_into_codes</code> and <code>lookup_centroids</code> before:</p>
<div class="cell" data-outputid="82757a39-cced-4d5c-c8c3-f758c840585d" data-execution_count="102">
<div class="sourceCode cell-code" id="cb221" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1">codes_ <span class="op" style="color: #5E5E5E;">=</span> compressor.compress_into_codes(embs, out_device<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'cuda'</span>)</span>
<span id="cb221-2">codes_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>torch.Size([15198])</code></pre>
</div>
</div>
<p>These codes are the centroids ID closest to each token embeddings.</p>
<div class="cell" data-outputid="63da570e-358e-43bd-88c2-f0b1a74b801c" data-execution_count="103">
<div class="sourceCode cell-code" id="cb223" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1">codes_[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>tensor([654, 843, 401, 654, 926], device='cuda:0')</code></pre>
</div>
</div>
<p>We then get those 15198 centroid vectors:</p>
<div class="cell" data-outputid="fda18ac7-ee33-4d4f-ec04-9528e2453ce3" data-execution_count="104">
<div class="sourceCode cell-code" id="cb225" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1">centroids_ <span class="op" style="color: #5E5E5E;">=</span> compressor.lookup_centroids(codes_, out_device<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'cuda'</span>)</span>
<span id="cb225-2">centroids_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>torch.Size([15198, 96])</code></pre>
</div>
</div>
<p>A reminder that our centroids and our token embeddings are unit vectors:</p>
<div class="cell" data-outputid="b1543905-9715-4783-b3be-e13eb3094026" data-execution_count="105">
<div class="sourceCode cell-code" id="cb227" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1">centroids_[<span class="dv" style="color: #AD0000;">0</span>].norm(), embs[<span class="dv" style="color: #AD0000;">0</span>].norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>(tensor(1., device='cuda:0', dtype=torch.float16),
 tensor(1., dtype=torch.float16))</code></pre>
</div>
</div>
<p>We then find the residuals between token embeddings and centroids:</p>
<div class="cell" data-outputid="a5dda6a8-5743-4fd3-9b0d-36917f21a02e" data-execution_count="106">
<div class="sourceCode cell-code" id="cb229" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1">residuals_ <span class="op" style="color: #5E5E5E;">=</span> (embs.cpu() <span class="op" style="color: #5E5E5E;">-</span> centroids_.cpu())</span>
<span id="cb229-2">residuals_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>torch.Size([15198, 96])</code></pre>
</div>
</div>
<p>The next piece is <em>super cool</em>. We <code>binarize</code> the residuals, starting by using <code>bucketize</code>:</p>
<div class="cell" data-outputid="e860a0ef-35b7-4d10-8336-2a3ea3e6bd72" data-execution_count="107">
<div class="sourceCode cell-code" id="cb231" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1">residuals <span class="op" style="color: #5E5E5E;">=</span> torch.bucketize(residuals_.<span class="bu" style="color: null;">float</span>().cpu(), bucket_cutoffs.cpu()).to(dtype<span class="op" style="color: #5E5E5E;">=</span>torch.uint8)</span>
<span id="cb231-2">residuals.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>torch.Size([15198, 96])</code></pre>
</div>
</div>
<div class="cell" data-outputid="e7f706cd-4b35-4663-9d89-d7de3d093130" data-execution_count="108">
<div class="sourceCode cell-code" id="cb233" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1">residuals[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>tensor([8, 7, 7, 8, 7], dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="dd9263e6-caaf-48ac-a88f-19c118c8e13b" data-execution_count="109">
<div class="sourceCode cell-code" id="cb235" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1">residuals_[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>tensor([6.1035e-05, 0.0000e+00, 0.0000e+00, 1.9073e-06, 0.0000e+00],
       dtype=torch.float16)</code></pre>
</div>
</div>
<div class="cell" data-outputid="a952ad43-2fc7-4847-c66d-998ff667af2e" data-execution_count="144">
<div class="sourceCode cell-code" id="cb237" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1">residuals_[<span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">10</span>:<span class="dv" style="color: #AD0000;">20</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="144">
<pre><code>tensor([ 0.0234, -0.0100,  0.0046, -0.0078, -0.0111,  0.0249, -0.0081, -0.0048,
         0.0270,  0.0037], dtype=torch.float16)</code></pre>
</div>
</div>
<div class="cell" data-outputid="5bbaf19f-fb73-4ba3-98a8-2f0869a7cad8" data-execution_count="110">
<div class="sourceCode cell-code" id="cb239" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1">bucket_cutoffs[<span class="dv" style="color: #AD0000;">6</span>:<span class="dv" style="color: #AD0000;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>tensor([-0.0017,  0.0000,  0.0019,  0.0042], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="6e97f8aa-771d-4d69-df7a-50648e37149f" data-execution_count="111">
<div class="sourceCode cell-code" id="cb241" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1">residuals.<span class="bu" style="color: null;">min</span>(), residuals.<span class="bu" style="color: null;">max</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="111">
<pre><code>(tensor(0, dtype=torch.uint8), tensor(15, dtype=torch.uint8))</code></pre>
</div>
</div>
<p>The values of <code>residuals</code> are now the ID (indices) of the buckets that the residual values fall into!</p>
<div class="cell" data-outputid="f379c67e-3051-4a0e-9d35-33c033a39828" data-execution_count="112">
<div class="sourceCode cell-code" id="cb243" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1">residuals <span class="op" style="color: #5E5E5E;">=</span> residuals.unsqueeze(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>).expand(<span class="op" style="color: #5E5E5E;">*</span>residuals.size(), config.nbits)</span>
<span id="cb243-2">residuals.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>torch.Size([15198, 96, 4])</code></pre>
</div>
</div>
<p>We add a space for 4-bits per residual.</p>
<div class="cell" data-outputid="ebcfa0f0-782f-46d9-b050-0215c1833fb6" data-execution_count="113">
<div class="sourceCode cell-code" id="cb245" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1">arange_bits <span class="op" style="color: #5E5E5E;">=</span> torch.arange(<span class="dv" style="color: #AD0000;">0</span>, config.nbits, device<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'cuda'</span>, dtype<span class="op" style="color: #5E5E5E;">=</span>torch.uint8)</span>
<span id="cb245-2">arange_bits</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>tensor([0, 1, 2, 3], device='cuda:0', dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="a9d88007-2fc8-4d6f-847a-0b6635666954" data-execution_count="114">
<div class="sourceCode cell-code" id="cb247" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1">residuals <span class="op" style="color: #5E5E5E;">=</span> residuals.cpu() <span class="op" style="color: #5E5E5E;">&gt;&gt;</span> arange_bits.cpu()</span>
<span id="cb247-2">residuals.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>torch.Size([15198, 96, 4])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ef3c7ef7-9a30-462a-90ae-a617cf11e584" data-execution_count="115">
<div class="sourceCode cell-code" id="cb249" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1">residuals[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>tensor([[8, 4, 2, 1],
        [7, 3, 1, 0],
        [7, 3, 1, 0],
        [8, 4, 2, 1],
        [7, 3, 1, 0]], dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb251" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1">residuals <span class="op" style="color: #5E5E5E;">=</span> residuals <span class="op" style="color: #5E5E5E;">&amp;</span> <span class="dv" style="color: #AD0000;">1</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="49ffdff1-767f-4e6d-e76c-7d224a302255" data-execution_count="117">
<div class="sourceCode cell-code" id="cb252" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1">residuals[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>tensor([[0, 0, 0, 1],
        [1, 1, 1, 0],
        [1, 1, 1, 0],
        [0, 0, 0, 1],
        [1, 1, 1, 0]], dtype=torch.uint8)</code></pre>
</div>
</div>
<p>We have now converted the bucket ID into the actual 4-bit binary value it represents.</p>
<div class="cell" data-outputid="3570c048-cb9b-4262-87e9-07ee6275be44" data-execution_count="118">
<div class="sourceCode cell-code" id="cb254" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1">residuals_packed <span class="op" style="color: #5E5E5E;">=</span> np.packbits(np.asarray(residuals.contiguous().flatten()))</span>
<span id="cb254-2">residuals_packed <span class="op" style="color: #5E5E5E;">=</span> torch.as_tensor(residuals_packed, dtype<span class="op" style="color: #5E5E5E;">=</span>torch.uint8)</span>
<span id="cb254-3">residuals_packed <span class="op" style="color: #5E5E5E;">=</span> residuals_packed.reshape(residuals.size(<span class="dv" style="color: #AD0000;">0</span>), config.dim <span class="op" style="color: #5E5E5E;">//</span> <span class="dv" style="color: #AD0000;">8</span> <span class="op" style="color: #5E5E5E;">*</span> config.nbits)</span>
<span id="cb254-4">residuals_packed.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>torch.Size([15198, 48])</code></pre>
</div>
</div>
<div class="cell" data-outputid="a627b3f7-5234-458e-cef0-c483e854316a" data-execution_count="119">
<div class="sourceCode cell-code" id="cb256" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1">residuals_packed[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>tensor([ 30, 225, 225, 238, 238], dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="68dcabcf-bddb-4463-b81e-8168b29a1fba" data-execution_count="120">
<div class="sourceCode cell-code" id="cb258" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><span class="ss" style="color: #20794D;">f"30 in binary: </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">bin</span>(<span class="dv" style="color: #AD0000;">30</span>)[<span class="dv" style="color: #AD0000;">2</span>:]<span class="sc" style="color: #5E5E5E;">.</span>zfill(<span class="dv" style="color: #AD0000;">8</span>)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>'30 in binary: 00011110'</code></pre>
</div>
</div>
<p>For each residual vector with 96 values, each value is represented with 4-bits (e.g.&nbsp;0, 0, 0, 1). Every 8 bits are stored into an integer (e.g.&nbsp;0001 and 1110 concatenate to become the integer 30) so we have cut the number of values in half (from 96 to 48).</p>
<p>These residuals would be stored in 0.residuals.pt.</p>
<section id="build_ivf" class="level3">
<h3 class="anchored" data-anchor-id="build_ivf">_build_ivf</h3>
<p>This is a critical piece—the mapping between passages and centroids!</p>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb260" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1">codes <span class="op" style="color: #5E5E5E;">=</span> codes_.sort()</span>
<span id="cb260-2">ivf, values <span class="op" style="color: #5E5E5E;">=</span> codes.indices, codes.values</span></code></pre></div>
</div>
<p>Token embeddings IDs:</p>
<div class="cell" data-outputid="0a8941c2-e96a-453a-ad35-687d6b05d7fa" data-execution_count="122">
<div class="sourceCode cell-code" id="cb261" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1">ivf</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>tensor([  936,  1171,  2363,  ..., 12051, 12147, 12161], device='cuda:0')</code></pre>
</div>
</div>
<p>Centroid IDs:</p>
<div class="cell" data-outputid="9c575499-74e7-437c-a7ec-3f6224bdace3" data-execution_count="123">
<div class="sourceCode cell-code" id="cb263" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1">values</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>tensor([   0,    0,    0,  ..., 1023, 1023, 1023], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="2625c9fd-341c-43fa-cc67-8cd42aab05b0" data-execution_count="124">
<div class="sourceCode cell-code" id="cb265" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1">ivf.shape, values.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">
<pre><code>(torch.Size([15198]), torch.Size([15198]))</code></pre>
</div>
</div>
<p><code>ivf</code> contains the token embedding ID (the indices of <code>codes_</code>) and <code>values</code> contains the centroid ID (the values of <code>codes_</code>).</p>
<p>We then get the number of tokens per centroid ID:</p>
<div class="cell" data-outputid="c9f64c61-1c04-4218-fbe1-7ee963268021" data-execution_count="125">
<div class="sourceCode cell-code" id="cb267" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1">ivf_lengths <span class="op" style="color: #5E5E5E;">=</span> torch.bincount(values, minlength<span class="op" style="color: #5E5E5E;">=</span>num_partitions)</span>
<span id="cb267-2">ivf_lengths</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>tensor([10, 11, 17,  ..., 17,  9, 29], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="cb4967d4-6fa5-46dc-9a60-1e2fce30a0a5" data-execution_count="126">
<div class="sourceCode cell-code" id="cb269" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1">ivf_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>torch.Size([1024])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ab06f90b-3457-4c00-97f5-e332b495a3a7" data-execution_count="127">
<div class="sourceCode cell-code" id="cb271" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1">ivf_lengths.<span class="bu" style="color: null;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>tensor(15198, device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="colbertindexingutils.py-optimize_ivf" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingutils.py-optimize_ivf">colbert/indexing/utils.py: optimize_ivf</h3>
<p>We have 1000 documents containing a total of 15198 tokens.</p>
<div class="cell" data-outputid="36918e33-d687-4eb3-f114-0b0dfbc6ca7e" data-execution_count="128">
<div class="sourceCode cell-code" id="cb273" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1">total_num_embeddings <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sum</span>(doclens)</span>
<span id="cb273-2"><span class="bu" style="color: null;">len</span>(doclens), total_num_embeddings</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>(1000, 15198)</code></pre>
</div>
</div>
<p>Instantiating an empty mapping between token embeddings IDs and passage IDs</p>
<div class="cell" data-outputid="349ec960-7935-41db-ead6-9b1e4d4f4175" data-execution_count="129">
<div class="sourceCode cell-code" id="cb275" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1">emb2pid <span class="op" style="color: #5E5E5E;">=</span> torch.zeros(total_num_embeddings, dtype<span class="op" style="color: #5E5E5E;">=</span>torch.<span class="bu" style="color: null;">int</span>)</span>
<span id="cb275-2">emb2pid.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>torch.Size([15198])</code></pre>
</div>
</div>
<p>The indices of <code>doclens</code> are passage IDs <code>pid</code>. The values are the number of tokens in the document <code>dlength</code>.</p>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb277" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1">offset_doclens <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb277-2"><span class="cf" style="color: #003B4F;">for</span> pid, dlength <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(doclens):</span>
<span id="cb277-3">    emb2pid[offset_doclens: offset_doclens <span class="op" style="color: #5E5E5E;">+</span> dlength] <span class="op" style="color: #5E5E5E;">=</span> pid</span>
<span id="cb277-4">    offset_doclens <span class="op" style="color: #5E5E5E;">+=</span> dlength</span></code></pre></div>
</div>
<div class="cell" data-outputid="abd41ab8-b033-4cab-f477-0020bca35b9b" data-execution_count="131">
<div class="sourceCode cell-code" id="cb278" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1">emb2pid.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre><code>torch.Size([15198])</code></pre>
</div>
</div>
<p>The first 4 token embeddings correspond to the first passage, the next 20 token embeddings to the second passage, and so on.</p>
<div class="cell" data-outputid="185d9dde-73dd-4676-972d-110d141244dd" data-execution_count="132">
<div class="sourceCode cell-code" id="cb280" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1">emb2pid[:<span class="dv" style="color: #AD0000;">50</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>tensor([0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3,
        3, 3], dtype=torch.int32)</code></pre>
</div>
</div>
<p>Recall that <code>ivf</code> contained as values the token embeddings IDs which are the indices of <code>emb2pid</code>. The values of <code>emb2pid</code> are passage IDs. Indexing into <code>emb2pid</code> with <code>ivf</code> pulls out the passage IDs corresponding to tokens. Note that <code>ivf</code> is sorted by centroid ID.</p>
<div class="cell" data-outputid="9a5ff539-5781-4b8a-909d-d71e67b45e4f" data-execution_count="133">
<div class="sourceCode cell-code" id="cb282" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1">ivf</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>tensor([  936,  1171,  2363,  ..., 12051, 12147, 12161], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="2d3478d4-a6db-435d-84c3-26586af708e8" data-execution_count="134">
<div class="sourceCode cell-code" id="cb284" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1">values</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="134">
<pre><code>tensor([   0,    0,    0,  ..., 1023, 1023, 1023], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="c8de26e5-55cc-47fa-9211-ec2d3137c285" data-execution_count="135">
<div class="sourceCode cell-code" id="cb286" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1">new_ivf <span class="op" style="color: #5E5E5E;">=</span> emb2pid[ivf.cpu()]</span>
<span id="cb286-2">new_ivf.shape, new_ivf[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>(torch.Size([15198]), tensor([ 55,  69, 143, 416, 471], dtype=torch.int32))</code></pre>
</div>
</div>
<div class="cell" data-outputid="8b3ce2a7-0e4c-4f41-fc9f-c2c0a711cf76" data-execution_count="136">
<div class="sourceCode cell-code" id="cb288" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1">new_ivf</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>tensor([ 55,  69, 143,  ..., 795, 800, 800], dtype=torch.int32)</code></pre>
</div>
</div>
<p>The first token embedding corresponding to centroid ID of 0 corresponds to passage ID 55.</p>
<div class="cell" data-outputid="3422eb75-44e7-4bf3-e2c9-393a22fbb47f" data-execution_count="137">
<div class="sourceCode cell-code" id="cb290" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1">emb2pid[<span class="dv" style="color: #AD0000;">936</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>tensor(55, dtype=torch.int32)</code></pre>
</div>
</div>
<p><code>new_ivf</code> is a mapping from its indices (token embeddings) to values (passage IDs) which is now aligned to the <code>ivf_lengths</code> tensor which contains number of tokens per centroid ID (which came from <code>values</code>).</p>
<p>Next, we iterate through <code>ivf_lengths</code>, which contains the number of tokens per centroid ID. For each <code>length</code> we get the unique passages IDs from <code>new_ivf</code>, and append that to <code>unique_pids_per_centroid</code>. The number of unique pids for that centroid is added to <code>new_ivf_lengths</code>.</p>
<div class="cell" data-outputid="e0a2e628-3973-4569-d3fe-0fd919828152" data-execution_count="138">
<div class="sourceCode cell-code" id="cb292" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1">unique_pids_per_centroid <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb292-2">new_ivf_lengths <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb292-3"></span>
<span id="cb292-4">offset <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb292-5"><span class="cf" style="color: #003B4F;">for</span> length <span class="kw" style="color: #003B4F;">in</span> tqdm.tqdm(ivf_lengths.tolist()):</span>
<span id="cb292-6">    pids <span class="op" style="color: #5E5E5E;">=</span> torch.unique(new_ivf[offset:offset<span class="op" style="color: #5E5E5E;">+</span>length])</span>
<span id="cb292-7">    unique_pids_per_centroid.append(pids)</span>
<span id="cb292-8">    new_ivf_lengths.append(pids.shape[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb292-9">    offset <span class="op" style="color: #5E5E5E;">+=</span> length</span>
<span id="cb292-10">ivf <span class="op" style="color: #5E5E5E;">=</span> torch.cat(unique_pids_per_centroid)</span>
<span id="cb292-11">new_ivf_lengths <span class="op" style="color: #5E5E5E;">=</span> torch.tensor(new_ivf_lengths)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1024/1024 [00:00&lt;00:00, 35975.77it/s]
&lt;ipython-input-138-6c68981e98f9&gt;:11: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  new_ivf_lengths = torch.tensor(ivf_lengths)</code></pre>
</div>
</div>
<div class="cell" data-outputid="037fa496-6036-491b-ee1b-8ccbd2686e75" data-execution_count="139">
<div class="sourceCode cell-code" id="cb294" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1">ivf.shape, new_ivf_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>(torch.Size([11593]), torch.Size([1024]))</code></pre>
</div>
</div>
<p>Note that there are now fewer values in <code>ivf</code> than 15198 since we are only capturing the unique pids per centroid.</p>
<div class="cell" data-outputid="c0dd2e47-ad6c-4298-e895-dcfd39ff4898" data-execution_count="140">
<div class="sourceCode cell-code" id="cb296" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1">ivf[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>tensor([ 55,  69, 143, 416, 471], dtype=torch.int32)</code></pre>
</div>
</div>
<div class="cell" data-outputid="1b6b71a0-fe95-40a4-ad3e-8dd8c089d87d" data-execution_count="141">
<div class="sourceCode cell-code" id="cb298" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1">new_ivf_lengths[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>tensor([10, 11, 17,  1, 34], device='cuda:0')</code></pre>
</div>
</div>
<p><code>new_ivf_lengths</code> is the count of unique passage IDs per centroid. So, for example the first 10 pids correspond to centroid ID <code>0</code>.</p>
<p><code>ivf</code> and <code>new_ivf_lengths</code> would be stored in ivf.pid.pt.</p>
<p>After updating metadata, this completes the indexing process in RAGatouille and ColBERT!</p>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>There were of course many details that I didn’t fully explain in this walkthrough, and since I wasn’t able to exactly replicate some of the indexing artifacts there may be some errors in my code, but I think I both covered and understood the main components to creating an index. Getting to this stage involved a <em>lot</em> of discussion with Claude. I used AnswerAI’s toolslm to create context from the RAGatouille and ColBERT repos to provide as Claude project knowledge. I also pored through the codebase for hours, making sure to trace my steps from method-to-method. While I could do more deep dives into the individual components of indexing, I feel satisfied with this walk through for now. I hope you enjoyed this blog post!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>information retrieval</category>
  <category>machine learning</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-03-12-RAGatouille-ColBERT-Indexing-Deep-Dive/index.html</guid>
  <pubDate>Wed, 12 Mar 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>TIL: PeftModel Base Model Behavior</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-03-10-TIL-PeftModel-Behavior/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this TIL blog post I share some unexpected behavior when using <code>PeftModel</code>. In short, when merging LoRA adapter weights with the base model, the base model gets overwritten. While unexpected, in hindsight this makes sense if you want to minimize memory usage.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> AutoModelForCausalLM</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> peft <span class="im" style="color: #00769E;">import</span> PeftModel</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> psutil</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">import</span> copy</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">import</span> gc</span></code></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;">from</span> google.colab <span class="im" style="color: #00769E;">import</span> userdata</span>
<span id="cb2-2"></span>
<span id="cb2-3">os.environ[<span class="st" style="color: #20794D;">'HUGGING_FACE_HUB_TOKEN'</span>] <span class="op" style="color: #5E5E5E;">=</span> userdata.get(<span class="st" style="color: #20794D;">'HUGGING_FACE_HUB_TOKEN'</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;">def</span> _mem(): <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"RAM Usage: </span><span class="sc" style="color: #5E5E5E;">{</span>psutil<span class="sc" style="color: #5E5E5E;">.</span>virtual_memory()<span class="sc" style="color: #5E5E5E;">.</span>percent<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">% (Used: </span><span class="sc" style="color: #5E5E5E;">{</span>psutil<span class="sc" style="color: #5E5E5E;">.</span>virtual_memory()<span class="sc" style="color: #5E5E5E;">.</span>used <span class="op" style="color: #5E5E5E;">/</span> (<span class="dv" style="color: #AD0000;">1024</span><span class="op" style="color: #5E5E5E;">**</span><span class="dv" style="color: #AD0000;">3</span>)<span class="sc" style="color: #5E5E5E;">:.2f}</span><span class="ss" style="color: #20794D;"> GB / Total: </span><span class="sc" style="color: #5E5E5E;">{</span>psutil<span class="sc" style="color: #5E5E5E;">.</span>virtual_memory()<span class="sc" style="color: #5E5E5E;">.</span>total <span class="op" style="color: #5E5E5E;">/</span> (<span class="dv" style="color: #AD0000;">1024</span><span class="op" style="color: #5E5E5E;">**</span><span class="dv" style="color: #AD0000;">3</span>)<span class="sc" style="color: #5E5E5E;">:.2f}</span><span class="ss" style="color: #20794D;"> GB)"</span>)</span></code></pre></div>
</div>
</section>
<section id="merging-lora-adapter-weights" class="level2">
<h2 class="anchored" data-anchor-id="merging-lora-adapter-weights">Merging LoRA Adapter Weights</h2>
<p>Before loading any model, here is the memory usage. I’m using an A100 GPU with Colab Pro.</p>
<div class="cell" data-outputid="b461255e-c263-4bba-c06b-4148a74092f9" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 3.5% (Used: 2.10 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">base_model <span class="op" style="color: #5E5E5E;">=</span> AutoModelForCausalLM.from_pretrained(<span class="st" style="color: #20794D;">"meta-llama/Llama-2-7b-hf"</span>).to(<span class="st" style="color: #20794D;">"cpu"</span>)</span></code></pre></div>
</div>
<p>After loading the base model (Llama2-7B) the memory usage increases to 27GB.</p>
<div class="cell" data-outputid="8bf9d682-b07b-4bc0-c632-3081f1f8dce6" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 33.8% (Used: 27.35 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<p>Loading the LoRA adapter weights increases the memory usage to 28 GB.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">model_to_merge <span class="op" style="color: #5E5E5E;">=</span> PeftModel.from_pretrained(</span>
<span id="cb9-2">    model<span class="op" style="color: #5E5E5E;">=</span>base_model,</span>
<span id="cb9-3">    model_id<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"LoRA-TMLR-2024/magicoder-lora-rank-64-alpha-128"</span></span>
<span id="cb9-4">).to(<span class="st" style="color: #20794D;">"cpu"</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="c5110313-9aa0-4808-dd9f-36ab1d38cb0b" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 34.8% (Used: 28.22 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">merged_model <span class="op" style="color: #5E5E5E;">=</span> model_to_merge.merge_and_unload()</span></code></pre></div>
</div>
<p>Merging the model essentially keeps the memory usage constant at 28GB.</p>
<div class="cell" data-outputid="53481002-dcec-4742-84c1-ed3e7770493f" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 34.9% (Used: 28.28 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
</section>
<section id="comparing-base_model-and-merged_model-weights" class="level2">
<h2 class="anchored" data-anchor-id="comparing-base_model-and-merged_model-weights">Comparing <code>base_model</code> and <code>merged_model</code> Weights</h2>
<p>However, saving memory comes at a cost! You no longer have access to the base model. I’ll first do a visual inspection of one of the weight matrices.</p>
<div class="cell" data-outputid="71d52a31-eed0-4dec-f48c-bf132f221ed5" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">base_model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.weight</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Parameter containing:
tensor([[-0.0020, -0.0156,  0.0023,  ...,  0.0098, -0.0017, -0.0031],
        [ 0.0283, -0.0176,  0.0062,  ..., -0.0076,  0.0004,  0.0087],
        [-0.0230,  0.0225,  0.0001,  ...,  0.0028,  0.0190, -0.0063],
        ...,
        [ 0.0003,  0.0016, -0.0013,  ...,  0.0081, -0.0308,  0.0110],
        [ 0.0259,  0.0203,  0.0045,  ..., -0.0310, -0.0147, -0.0111],
        [-0.0077, -0.0174,  0.0012,  ...,  0.0182,  0.0181, -0.0070]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="9b2f1df8-7c78-4f23-ef3b-77c2b981ff99" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">merged_model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.q_proj.weight</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Parameter containing:
tensor([[-0.0020, -0.0156,  0.0023,  ...,  0.0098, -0.0017, -0.0031],
        [ 0.0283, -0.0176,  0.0062,  ..., -0.0076,  0.0004,  0.0087],
        [-0.0230,  0.0225,  0.0001,  ...,  0.0028,  0.0190, -0.0063],
        ...,
        [ 0.0003,  0.0016, -0.0013,  ...,  0.0081, -0.0308,  0.0110],
        [ 0.0259,  0.0203,  0.0045,  ..., -0.0310, -0.0147, -0.0111],
        [-0.0077, -0.0174,  0.0012,  ...,  0.0182,  0.0181, -0.0070]])</code></pre>
</div>
</div>
<p>Both matrices are equal. Analyzing weight matrix differences more systematically:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;">def</span> _diffs(model1, model2):</span>
<span id="cb19-2">    n_diff <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb19-3">    <span class="cf" style="color: #003B4F;">for</span> layer_idx <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">32</span>):</span>
<span id="cb19-4">        <span class="cf" style="color: #003B4F;">for</span> component <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">"q_proj"</span>, <span class="st" style="color: #20794D;">"k_proj"</span>, <span class="st" style="color: #20794D;">"o_proj"</span>, <span class="st" style="color: #20794D;">"v_proj"</span>]:</span>
<span id="cb19-5">            W1 <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(model1.model.layers[layer_idx].self_attn, component).weight</span>
<span id="cb19-6">            W2<span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(model2.model.layers[layer_idx].self_attn, component).weight</span>
<span id="cb19-7">            <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> torch.allclose(W1, W2, rtol<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1e-5</span>, atol<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1e-8</span>): n_diff <span class="op" style="color: #5E5E5E;">+=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb19-8">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Different Self-Attention Matrices: </span><span class="sc" style="color: #5E5E5E;">{</span>n_diff<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb19-9">    n_diff <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb19-10">    <span class="cf" style="color: #003B4F;">for</span> layer_idx <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">32</span>):</span>
<span id="cb19-11">        <span class="cf" style="color: #003B4F;">for</span> component <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">"up_proj"</span>, <span class="st" style="color: #20794D;">"down_proj"</span>, <span class="st" style="color: #20794D;">"gate_proj"</span>]:</span>
<span id="cb19-12">            W1 <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(model1.model.layers[layer_idx].mlp, component).weight</span>
<span id="cb19-13">            W2 <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">getattr</span>(model2.model.layers[layer_idx].mlp, component).weight</span>
<span id="cb19-14">            <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> torch.allclose(W1, W2, rtol<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1e-5</span>, atol<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1e-8</span>): n_diff <span class="op" style="color: #5E5E5E;">+=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb19-15">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Different MLP Weight Matrices: </span><span class="sc" style="color: #5E5E5E;">{</span>n_diff<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="3725270e-f6e2-494a-ea46-28c2fa835116" data-execution_count="21">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">_diffs(base_model, merged_model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Different Self-Attention Matrices: 0
Different MLP Weight Matrices: 0</code></pre>
</div>
</div>
<p>For both self-attention and MLP modules, all weight matrices between the <code>base_model</code> and the <code>merged_model</code> are the same. Using the <code>is</code> operator we can see that they reference the same object in memory (which is where the memory savings come from):</p>
<div class="cell" data-outputid="f6d7747c-a8d9-4c32-8172-0b6ba59831ed" data-execution_count="23">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">base_model <span class="kw" style="color: #003B4F;">is</span> merged_model</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>True</code></pre>
</div>
</div>
</section>
<section id="copying-the-base-model-for-comparison" class="level2">
<h2 class="anchored" data-anchor-id="copying-the-base-model-for-comparison">Copying the Base Model for Comparison</h2>
<p>I’ll now load the base model again to compare with the merged model weights.</p>
<div class="cell" data-outputid="7cefff4e-025f-4b4c-bff5-09676d8af019" data-execution_count="24">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 35.4% (Used: 28.68 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;">del</span> base_model</span></code></pre></div>
</div>
<div class="cell" data-outputid="213ac2ca-846f-4460-cce6-4b4bed5ad05f" data-execution_count="27">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">gc.collect()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>483</code></pre>
</div>
</div>
<div class="cell" data-outputid="8a10f443-157a-456a-cb0a-34e11771d03b" data-execution_count="54">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 35.5% (Used: 28.78 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<p>Note that deleting the base model did not change the memory usage.</p>
<div class="cell" data-outputid="74341ad5-ee28-474b-d505-0a5f04e140e5" data-execution_count="55">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">base_model <span class="op" style="color: #5E5E5E;">=</span> AutoModelForCausalLM.from_pretrained(<span class="st" style="color: #20794D;">"meta-llama/Llama-2-7b-hf"</span>).to(<span class="st" style="color: #20794D;">"cpu"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ee5aafe00d32446f95ab002be2ec8fcc","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell" data-outputid="faa5c925-2fdc-45b9-b943-07f8baf2e19c" data-execution_count="56">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">_mem()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RAM Usage: 65.7% (Used: 53.94 GB / Total: 83.48 GB)</code></pre>
</div>
</div>
<p>With a new base model loaded, the memory usage jumps up to 54 GB.</p>
<div class="cell" data-outputid="83d16db7-457a-4ca2-c6a9-f24e099d27c6" data-execution_count="57">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">_diffs(base_model, merged_model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Different Self-Attention Matrices: 128
Different MLP Weight Matrices: 96</code></pre>
</div>
</div>
<p>There are 32 layers in this Llama model, and each model’s self-attention module has 4 weight matrices we are comparing, resulting in 128 matrices in total. The MLP module has 3 weight matrices we are comparing, resulting in 96 total across the model. The base model and merged model are fully different models (in terms of weight matrix values).</p>
</section>
<section id="using-.get_base_model" class="level2">
<h2 class="anchored" data-anchor-id="using-.get_base_model">Using <code>.get_base_model</code></h2>
<p>Looking at the <code>PeftModel</code> documentation, I noted the method <code>get_base_model</code> which seems relevant to this exercise. However, using that method results in the same weights as the merged model:</p>
<div class="cell" data-outputid="6ba3da16-ba96-4c24-9b8b-d0abcff91230" data-execution_count="59">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">model_to_merge.get_base_model</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>peft.peft_model.PeftModel.get_base_model</b><br>def get_base_model() -&gt; torch.nn.Module</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.11/dist-packages/peft/peft_model.pyReturns the base model.</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 912);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<div class="cell" data-outputid="28cc252a-570d-41b6-cecd-2a7dbbab953d" data-execution_count="60">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">_diffs(merged_model, model_to_merge.get_base_model())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Different Self-Attention Matrices: 0
Different MLP Weight Matrices: 0</code></pre>
</div>
</div>
<hr>
<p>I am planning to do more of these short TIL blog posts this year! It helps me solidify concepts as I come across them. I hope you enjoyed this blog post!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>machine learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-03-10-TIL-PeftModel-Behavior/index.html</guid>
  <pubDate>Mon, 10 Mar 2025 07:00:00 GMT</pubDate>
</item>
<item>
  <title>Memory Profiling raw ColBERT and RAGatouille</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-02-14-RAGatouille-ColBERT-Memory-Profiling/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>A disclaimer: this is the first time I’ve done memory profiling, and while I’ve probably spent 8-10 hours <a href="https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/">poring through the RAGatouille and ColBERT codebases</a> I still consider myself a beginner, and don’t have a solid mental model of how indexing (and search) work.</p>
<p>With that out of the way, let’s dig in!</p>
<p><a href="https://vishalbakshi.github.io/blog/posts/2025-02-12-indexing-memory/">In a previous blog post</a> I used <code>psutil.Process().memory_info().rss</code> in a separate thread to monitor memory usage while indexing 100k, 250k, 500k, 1M and 2M documents from the Genomics datasets (via UKPLab/DAPR) with RAGatouille. I have also run this for raw ColBERT. Here’s an example comparison (for 250k docs on an RTX6000Ada instance) with RAGatouille on the left and raw ColBERT on the right:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="CPU memory usage while indexing 250k documents"><img src="https://vishalbakshi.github.io/blog/posts/2025-02-14-RAGatouille-ColBERT-Memory-Profiling/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">CPU memory usage while indexing 250k documents</figcaption><p></p>
</figure>
</div>
<p>While the peak memory increased with number of documents, they all follow the same trend. ColBERT always has a significantly lower peak memory. The ColBERT runs in total took about an hour and the RAGatouille runs took about 1.5 hours. Comparison of all collection sizes can be seen in <a href="https://github.com/vishalbakshi/RAGatouille/tree/profiling/profiling_results/memory_time_plots">this folder</a>.</p>
<p>In this blog post I go deeper and use the <code>memory_profiler</code> package to understand how much memory is being consumed by different functions down the chain of calls when you index 100k, 250k, 500k, 1M and 2M documents using raw ColBERT and RAGatouille. For all of these runs I use a RTX6000Ada instance on Jarvis Labs. When using RAGatouille, I execute all runs with <code>use_faiss=False</code> (since that’s the default value in RAGatouille) and runs of 100k, 250k and 500k with <code>use_faiss=True</code>.</p>
</section>
<section id="repo-setup-and-installation" class="level2">
<h2 class="anchored" data-anchor-id="repo-setup-and-installation">Repo Setup and Installation</h2>
<p>Since I needed to add the <code>@profile</code> decorator above each function I wanted to profile, I created my own forks of the raw ColBERT and RAGatouille repos and created a <code>profiling</code> branch. Since RAGatouille is built on top of ColBERT, I switched the <code>colbert-ai</code> dependency in my RAGatouille fork from <code>"colbert-ai&gt;=0.2.19"</code> to:</p>
<pre><code>"colbert-ai @ git+https://github.com/vishalbakshi/ColBERT.git@profiling"</code></pre>
<p>I also added <code>memory-profiler</code> as a dependency for both ColBERT and RAGatouille.</p>
<p>I used the terminal for all experiments. Here are the commands to install RAGatouille:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;">python</span> <span class="at" style="color: #657422;">-m</span> venv ragatouille-env</span>
<span id="cb2-2"><span class="bu" style="color: null;">source</span> ragatouille-env/bin/activate</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;">git</span> clone <span class="at" style="color: #657422;">-b</span> profiling https://github.com/vishalbakshi/RAGatouille.git</span>
<span id="cb2-4"><span class="bu" style="color: null;">cd</span> RAGatouille</span>
<span id="cb2-5"><span class="ex" style="color: null;">pip</span> install <span class="at" style="color: #657422;">-e</span> .</span>
<span id="cb2-6"><span class="ex" style="color: null;">pip</span> install datasets</span>
<span id="cb2-7"><span class="ex" style="color: null;">pip</span> uninstall <span class="at" style="color: #657422;">--y</span> faiss-cpu</span>
<span id="cb2-8"><span class="ex" style="color: null;">pip</span> install faiss-gpu-cu12</span></code></pre></div>
<p>Note that I uninstalled <code>faiss-cpu</code> and installed <code>faiss-gpu-cu12</code>.</p>
<p>Here are the commands to install ColBERT (which took considerably more effort, and assistance from Claude, to figure out):</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;">git</span> clone <span class="at" style="color: #657422;">-b</span> profiling https://github.com/vishalbakshi/ColBERT.git</span>
<span id="cb3-2"><span class="bu" style="color: null;">cd</span> ColBERT</span>
<span id="cb3-3"><span class="ex" style="color: null;">conda</span> env create <span class="at" style="color: #657422;">-f</span> conda_env.yml</span>
<span id="cb3-4"><span class="ex" style="color: null;">conda</span> init</span>
<span id="cb3-5"><span class="bu" style="color: null;">source</span> ~/.bashrc</span>
<span id="cb3-6"><span class="ex" style="color: null;">conda</span> activate colbert</span>
<span id="cb3-7"><span class="ex" style="color: null;">pip</span> install <span class="at" style="color: #657422;">-e</span> .</span>
<span id="cb3-8"><span class="ex" style="color: null;">conda</span> remove <span class="at" style="color: #657422;">-y</span> <span class="at" style="color: #657422;">--force</span> pytorch torchvision torchaudio cudatoolkit</span>
<span id="cb3-9"><span class="ex" style="color: null;">pip3</span> install torch torchvision torchaudio <span class="at" style="color: #657422;">--index-url</span> https://download.pytorch.org/whl/cu118</span>
<span id="cb3-10"><span class="ex" style="color: null;">apt-get</span> update</span>
<span id="cb3-11"><span class="ex" style="color: null;">apt-get</span> install <span class="at" style="color: #657422;">-y</span> gcc-11 g++-11</span>
<span id="cb3-12"><span class="bu" style="color: null;">export</span> <span class="va" style="color: #111111;">CC</span><span class="op" style="color: #5E5E5E;">=</span>gcc-11</span>
<span id="cb3-13"><span class="bu" style="color: null;">export</span> <span class="va" style="color: #111111;">CXX</span><span class="op" style="color: #5E5E5E;">=</span>g++-11</span></code></pre></div>
<p>I had to uninstall pytorch, torchvision, torchaudio, cudatoolkit and reinstall them to resolve the following error:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;">File</span> <span class="st" style="color: #20794D;">"/home/ColBERT/colbert/utils/utils.py"</span>, line 3, in <span class="op" style="color: #5E5E5E;">&lt;</span>module<span class="op" style="color: #5E5E5E;">&gt;</span></span>
<span id="cb4-2">    <span class="ex" style="color: null;">import</span> torch</span>
<span id="cb4-3">  <span class="ex" style="color: null;">File</span> <span class="st" style="color: #20794D;">"/root/miniconda3/envs/colbert/lib/python3.8/site-packages/torch/__init__.py"</span>, line 218, in <span class="op" style="color: #5E5E5E;">&lt;</span>module<span class="op" style="color: #5E5E5E;">&gt;</span></span>
<span id="cb4-4">    <span class="ex" style="color: null;">from</span> torch._C import <span class="pp" style="color: #AD0000;">*</span>  <span class="co" style="color: #5E5E5E;"># noqa: F403</span></span>
<span id="cb4-5"><span class="ex" style="color: null;">ImportError:</span> /root/miniconda3/envs/colbert/lib/python3.8/site-packages/torch/lib/libtorch_cpu.so: undefined symbol: iJIT_NotifyEvent</span></code></pre></div>
<p>The last four commands I ran:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;">apt-get</span> update</span>
<span id="cb5-2"><span class="ex" style="color: null;">apt-get</span> install <span class="at" style="color: #657422;">-y</span> gcc-11 g++-11</span>
<span id="cb5-3"><span class="bu" style="color: null;">export</span> <span class="va" style="color: #111111;">CC</span><span class="op" style="color: #5E5E5E;">=</span>gcc-11</span>
<span id="cb5-4"><span class="bu" style="color: null;">export</span> <span class="va" style="color: #111111;">CXX</span><span class="op" style="color: #5E5E5E;">=</span>g++-11</span></code></pre></div>
<p>Resolved <code>fatal error: crypt.h: No such file or directory</code>/<code>ninja: build stopped: subcommand failed</code> as is detailed in ColBERT issue <a href="https://github.com/stanford-futuredata/ColBERT/issues/371">#371</a>.</p>
</section>
<section id="functions-selected-for-profiling" class="level2">
<h2 class="anchored" data-anchor-id="functions-selected-for-profiling">Functions Selected for Profiling</h2>
<p>I determined which functions to profile by trial and error, adding/removing the <code>@profile</code> decorator to see which function was being called. Again, lots of Claude assistance was needed. Here are the filenames and method names that I chose to profile:</p>
<section id="colbert" class="level3">
<h3 class="anchored" data-anchor-id="colbert">ColBERT</h3>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Filename</th>
<th style="text-align: center;">Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">indexer.py</td>
<td style="text-align: center;"><code>index</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">indexer.py</td>
<td style="text-align: center;"><code>__launch</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>encode</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>run</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>setup</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>__sample_pids</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>__sample_embeddings</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">indexing/collection_indexer.py</td>
<td style="text-align: center;"><code>encoder.encode_passages</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">infra/launcher.py</td>
<td style="text-align: center;"><code>launch</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">infra/launcher.py</td>
<td style="text-align: center;"><code>launch_without_fork</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">infra/launcher.py</td>
<td style="text-align: center;"><code>run_process_without_mp</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">infra/launcher.py</td>
<td style="text-align: center;"><code>callee</code></td>
</tr>
</tbody>
</table>
</section>
<section id="ragatouille" class="level3">
<h3 class="anchored" data-anchor-id="ragatouille">RAGatouille</h3>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Filename</th>
<th style="text-align: center;">Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">RAGPretrainedModel.py</td>
<td style="text-align: center;"><code>_process_corpus</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGPretrainedModel.py</td>
<td style="text-align: center;"><code>model.index</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">models/colbert.py</td>
<td style="text-align: center;"><code>ModelIndexFactory.construct</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">models/index.py</td>
<td style="text-align: center;"><code>PLAIDModelIndex.__init__</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">models/index.py</td>
<td style="text-align: center;"><code>PLAIDModelIndex.construct</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">models/index.py</td>
<td style="text-align: center;"><code>PLAIDModelIndex.build</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">models/index.py</td>
<td style="text-align: center;"><code>PLAIDModelIndex.indexer.index</code></td>
</tr>
</tbody>
</table>
<p>Note that in RAGatouille, <code>PLAIDModelIndex.indexer</code> is of class <code>Indexer</code> which is imported from ColBERT, so I understood this to be the “bridge” between the RAGatouille and ColBERT repos during profiling.</p>
</section>
</section>
<section id="scripts" class="level2">
<h2 class="anchored" data-anchor-id="scripts">Scripts</h2>
<p>Here’s the script for indexing using ColBERT:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;">import</span> colbert</span>
<span id="cb6-2"><span class="im" style="color: #00769E;">from</span> colbert <span class="im" style="color: #00769E;">import</span> Indexer, Searcher</span>
<span id="cb6-3"><span class="im" style="color: #00769E;">from</span> colbert.infra <span class="im" style="color: #00769E;">import</span> Run, RunConfig, ColBERTConfig</span>
<span id="cb6-4"><span class="im" style="color: #00769E;">from</span> colbert.data <span class="im" style="color: #00769E;">import</span> Queries, Collection</span>
<span id="cb6-5"><span class="im" style="color: #00769E;">from</span> datasets <span class="im" style="color: #00769E;">import</span> load_dataset</span>
<span id="cb6-6"><span class="im" style="color: #00769E;">from</span> memory_profiler <span class="im" style="color: #00769E;">import</span> profile</span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="at" style="color: #657422;">@profile</span></span>
<span id="cb6-9"><span class="kw" style="color: #003B4F;">def</span> _index(indexer, name, collection):</span>
<span id="cb6-10">    <span class="cf" style="color: #003B4F;">return</span> indexer.index(name<span class="op" style="color: #5E5E5E;">=</span>name, collection<span class="op" style="color: #5E5E5E;">=</span>collection, overwrite<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb6-11"></span>
<span id="cb6-12"><span class="kw" style="color: #003B4F;">def</span> main():</span>
<span id="cb6-13">    nbits <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">2</span>  </span>
<span id="cb6-14">    ndocs <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">100_000</span></span>
<span id="cb6-15">    dataset_name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Genomics"</span></span>
<span id="cb6-16">    index_name <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">.</span><span class="sc" style="color: #5E5E5E;">{</span>nbits<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">bits'</span></span>
<span id="cb6-17"></span>
<span id="cb6-18">    passages <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">-corpus"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test"</span>)</span>
<span id="cb6-19">    checkpoint <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'answerdotai/answerai-colbert-small-v1'</span></span>
<span id="cb6-20"></span>
<span id="cb6-21">    <span class="cf" style="color: #003B4F;">with</span> Run().context(RunConfig(nranks<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>, experiment<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'notebook'</span>)):</span>
<span id="cb6-22">        config <span class="op" style="color: #5E5E5E;">=</span> ColBERTConfig(doc_maxlen<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>, nbits<span class="op" style="color: #5E5E5E;">=</span>nbits, kmeans_niters<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>, avoid_fork_if_possible<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb6-23">        indexer <span class="op" style="color: #5E5E5E;">=</span> Indexer(checkpoint<span class="op" style="color: #5E5E5E;">=</span>checkpoint, config<span class="op" style="color: #5E5E5E;">=</span>config)</span>
<span id="cb6-24">        _index(indexer, index_name, passages[:ndocs][<span class="st" style="color: #20794D;">"text"</span>])</span>
<span id="cb6-25"></span>
<span id="cb6-26"><span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">__name__</span> <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'__main__'</span>:</span>
<span id="cb6-27">    main()</span></code></pre></div>
<p>and the script for RAGatouille:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;">from</span> memory_profiler <span class="im" style="color: #00769E;">import</span> profile</span>
<span id="cb7-2"><span class="im" style="color: #00769E;">from</span> datasets <span class="im" style="color: #00769E;">import</span> load_dataset</span>
<span id="cb7-3"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb7-4"></span>
<span id="cb7-5">dataset_name <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Genomics"</span></span>
<span id="cb7-6">passages <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">-corpus"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test"</span>)</span>
<span id="cb7-7">RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(<span class="st" style="color: #20794D;">"answerdotai/answerai-colbert-small-v1"</span>)</span>
<span id="cb7-8">ndocs<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">250_000</span></span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="at" style="color: #657422;">@profile</span></span>
<span id="cb7-11"><span class="kw" style="color: #003B4F;">def</span> _index():</span>
<span id="cb7-12">    <span class="cf" style="color: #003B4F;">return</span> RAG.index(</span>
<span id="cb7-13">        index_name<span class="op" style="color: #5E5E5E;">=</span><span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_index"</span>,</span>
<span id="cb7-14">        collection<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"text"</span>],</span>
<span id="cb7-15">        document_ids<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"_id"</span>],</span>
<span id="cb7-16">        use_faiss<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span> <span class="co" style="color: #5E5E5E;"># or False</span></span>
<span id="cb7-17">    )</span>
<span id="cb7-18"></span>
<span id="cb7-19">_index()</span></code></pre></div>
<p>Finally, here’s the terminal command to run the scripts and profile them:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;">python</span> <span class="at" style="color: #657422;">-m</span> memory_profiler ../colbert_index_2M.py <span class="op" style="color: #5E5E5E;">&gt;</span> ../colbert_2M_RTX6000Ada.txt</span></code></pre></div>
</section>
<section id="profiling-results" class="level2">
<h2 class="anchored" data-anchor-id="profiling-results">Profiling Results</h2>
<p>The profile logs were 400+ lines each (you can see the full files <a href="https://github.com/vishalbakshi/RAGatouille/tree/profiling/profiling_results">here</a>) so I have only included some of the lines with non-zero memory changes. I have showed the starting memory, memory increment and final memory.</p>
<p>Here’s how I’m interpreting the profiler logs–given this log:</p>
<pre><code>Filename: /home/RAGatouille/ragatouille/models/index.py

Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   198   3406.4 MiB   3406.4 MiB           1           @profile
   199                                                 def _index_with_profiling(indexer, name, collection, overwrite):
   200   4872.2 MiB   1465.8 MiB           1               return indexer.index(name=name, collection=collection, overwrite=overwrite)</code></pre>
<p>I would interpret that to mean that before <code>indexer.index</code> was called, 3406.4 MB memory was used, and the <code>indexer.index</code> call increased it by 1465.8 MB to 4872.2 MB.</p>
<section id="colbertindexer.pyindexer.index" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexer.pyindexer.index">colbert/indexer.py/<code>indexer.index</code></h3>
<p>For RAGatouille, this call takes place in <a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L243">ragatouille/models/index.py</a>.</p>
<p>It’s interesting to note that even before <code>indexer.index</code> is called, the starting memory varies between raw ColBERT and RAGatouille. Most notably, for 2M documents, ColBERT starts at ~<mark>4GB</mark> while RAGatouille starts at ~<mark>8 GB</mark>.</p>
<p>Even more interesting, the memory increments for ColBERT are <mark>2x to 35x</mark> smaller than RAGatouille for each collection size.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Starting Memory</th>
<th style="text-align: center;">Memory Increment</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1596.9 MB</td>
<td style="text-align: center;">36.7 MB</td>
<td style="text-align: center;">1633.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">1754.0 MB</td>
<td style="text-align: center;">92.8 MB</td>
<td style="text-align: center;">1846.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">2072.1 MB</td>
<td style="text-align: center;">199.1 MB</td>
<td style="text-align: center;">2271.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">2707.3 MB</td>
<td style="text-align: center;">421.9 MB</td>
<td style="text-align: center;">3129.2 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">4000.6 MB</td>
<td style="text-align: center;">876.4 MB</td>
<td style="text-align: center;">4877.1 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">2114.2 MB</td>
<td style="text-align: center;">1320.1 MB</td>
<td style="text-align: center;">3434.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2592.5 MB</td>
<td style="text-align: center;">1175.0 MB</td>
<td style="text-align: center;">3767.5 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3405.0 MB</td>
<td style="text-align: center;">1430.0 MB</td>
<td style="text-align: center;">4835.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1750.9 MB</td>
<td style="text-align: center;">1203.9 MB</td>
<td style="text-align: center;">2954.8 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2597.4 MB</td>
<td style="text-align: center;">1341.4 MB</td>
<td style="text-align: center;">3938.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3406.4 MB</td>
<td style="text-align: center;">1465.8 MB</td>
<td style="text-align: center;">4872.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">5040.1 MB</td>
<td style="text-align: center;">1593.3 MB</td>
<td style="text-align: center;">6633.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">8354.7 MB</td>
<td style="text-align: center;">1882.0 MB</td>
<td style="text-align: center;">10236.8 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.pyencoder.encode_passages" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.pyencoder.encode_passages">colbert/indexing/collection_indexer.py/<code>encoder.encode_passages</code></h3>
<p><code>encoder.encode_passages</code> involves the following code:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;">def</span> encode_passages(<span class="va" style="color: #111111;">self</span>, passages):</span>
<span id="cb10-3">        Run().<span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"#&gt; Encoding </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(passages)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> passages.."</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(passages) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>:</span>
<span id="cb10-6">            <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">None</span>, <span class="va" style="color: #111111;">None</span></span>
<span id="cb10-7"></span>
<span id="cb10-8">        <span class="cf" style="color: #003B4F;">with</span> torch.inference_mode():</span>
<span id="cb10-9">            embs, doclens <span class="op" style="color: #5E5E5E;">=</span> [], []</span>
<span id="cb10-10"></span>
<span id="cb10-11">            <span class="cf" style="color: #003B4F;">for</span> passages_batch <span class="kw" style="color: #003B4F;">in</span> batch(passages, <span class="va" style="color: #111111;">self</span>.config.index_bsize <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">50</span>):</span>
<span id="cb10-12">                embs_, doclens_ <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.checkpoint.docFromText(</span>
<span id="cb10-13">                    passages_batch,</span>
<span id="cb10-14">                    bsize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.config.index_bsize,</span>
<span id="cb10-15">                    keep_dims<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"flatten"</span>,</span>
<span id="cb10-16">                    showprogress<span class="op" style="color: #5E5E5E;">=</span>(<span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">self</span>.use_gpu),</span>
<span id="cb10-17">                    pool_factor<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.config.pool_factor,</span>
<span id="cb10-18">                    clustering_mode<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.config.clustering_mode,</span>
<span id="cb10-19">                    protected_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.config.protected_tokens,</span>
<span id="cb10-20">                )</span>
<span id="cb10-21">                embs.append(embs_)</span>
<span id="cb10-22">                doclens.extend(doclens_)</span>
<span id="cb10-23"></span>
<span id="cb10-24">            embs <span class="op" style="color: #5E5E5E;">=</span> torch.cat(embs)</span>
<span id="cb10-25"></span>
<span id="cb10-26">        <span class="cf" style="color: #003B4F;">return</span> embs, doclens</span></code></pre></div>
<p>IIUC, this is calling <code>docFromText</code> on the ColBERT model (<code>answerai-colbert-small-v1</code> in our case). I would expect raw ColBERT and RAGatouille to experience equal memory change during this method call but RAGatouille uses <mark>10-15%</mark> more memory for each dataset size.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">732.9 MB</td>
<td style="text-align: center;">1502.4 MB</td>
<td style="text-align: center;">2235.3 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">829.7 MB</td>
<td style="text-align: center;">1991.1 MB</td>
<td style="text-align: center;">2820.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">1000.2 MB</td>
<td style="text-align: center;">2549.8 MB</td>
<td style="text-align: center;">3550.0 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">1351.6 MB</td>
<td style="text-align: center;">3462.0 MB</td>
<td style="text-align: center;">4813.6 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">1997.3 MB</td>
<td style="text-align: center;">4692.3 MB</td>
<td style="text-align: center;">6689.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">2115.0 MB</td>
<td style="text-align: center;">1677.3 MB</td>
<td style="text-align: center;">3792.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2593.5 MB</td>
<td style="text-align: center;">2279.7 MB</td>
<td style="text-align: center;">4873.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3405.1 MB</td>
<td style="text-align: center;">3004.6 MB</td>
<td style="text-align: center;">6409.6 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1751.0 MB</td>
<td style="text-align: center;">1685.6 MB</td>
<td style="text-align: center;">3436.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2597.9 MB</td>
<td style="text-align: center;">2270.4 MB</td>
<td style="text-align: center;">4868.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3406.4 MB</td>
<td style="text-align: center;">3003.8 MB</td>
<td style="text-align: center;">6410.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">5040.7 MB</td>
<td style="text-align: center;">3915.3 MB</td>
<td style="text-align: center;">8956.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">8355.1 MB</td>
<td style="text-align: center;">5349.5 MB</td>
<td style="text-align: center;">13704.6 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.py_sample_embeddings" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.py_sample_embeddings">colbert/indexing/collection_indexer.py/<code>_sample_embeddings</code></h3>
<p><code>encode_passages</code> is called from inside <code>_sample_embeddings</code>. For ColBERT, <code>_sample_embeddings</code> has different starting/final memory values than <code>_encode_passages</code> while for RAGatouille they are the same.</p>
<p>For example, for 100k documents using raw ColBERT, <code>_sample_embeddings</code> increases memory by 797 MB while for <code>encoder.encode_passages</code> the memory increases by 1488.8MB.</p>
<p>For 100k using RAGatouille, both memory increases the same (1677.3 MB for <code>use_faiss=True</code> and 1685.6 MB for <code>use_faiss=False</code>). I’m not sure what this means so I asked Claude and got the response:</p>
<blockquote class="blockquote">
<p>This discrepancy reveals memory reuse patterns between function calls. In ColBERT, the 1488.8 MB used by <code>encode_passages</code> is partially freed before returning to <code>_sample_embeddings</code>, resulting in a net increase of 797 MB. In RAGatouille, the memory appears to be retained between calls, showing the same 1677.3 MB increase at both levels.</p>
</blockquote>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">732.9 MB</td>
<td style="text-align: center;">813.8 MB</td>
<td style="text-align: center;">1546.7 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">829.7 MB</td>
<td style="text-align: center;">809.0 MB</td>
<td style="text-align: center;">1638.7 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">1000.2 MB</td>
<td style="text-align: center;">770.1 MB</td>
<td style="text-align: center;">1770.3 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">1351.6 MB</td>
<td style="text-align: center;">813.3 MB</td>
<td style="text-align: center;">2164.9 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">1997.3 MB</td>
<td style="text-align: center;">782.4 MB</td>
<td style="text-align: center;">2779.7 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">2115.0 MB</td>
<td style="text-align: center;">1677.3 MB</td>
<td style="text-align: center;">3792.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2593.5 MB</td>
<td style="text-align: center;">2279.7 MB</td>
<td style="text-align: center;">4873.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3405.1 MB</td>
<td style="text-align: center;">3004.6 MB</td>
<td style="text-align: center;">6409.6 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1751.0 MB</td>
<td style="text-align: center;">1685.6 MB</td>
<td style="text-align: center;">3436.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2597.9 MB</td>
<td style="text-align: center;">2270.4 MB</td>
<td style="text-align: center;">4868.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">3406.4 MB</td>
<td style="text-align: center;">3003.8 MB</td>
<td style="text-align: center;">6410.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">5040.7 MB</td>
<td style="text-align: center;">3915.3 MB</td>
<td style="text-align: center;">8956.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">8355.1 MB</td>
<td style="text-align: center;">5349.5 MB</td>
<td style="text-align: center;">13704.6 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.pysetup" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.pysetup">colbert/indexing/collection_indexer.py/<code>setup</code></h3>
<p>A similar pattern for <code>setup</code>, within which <code>_sample_embeddings</code> is called. Raw ColBERT seems more efficient in releasing memory while RAGatouille retains it.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">727.9 MB</td>
<td style="text-align: center;">817.5 MB</td>
<td style="text-align: center;">1545.5 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">815.7 MB</td>
<td style="text-align: center;">816.4 MB</td>
<td style="text-align: center;">1632.1 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">978.2 MB</td>
<td style="text-align: center;">787.9 MB</td>
<td style="text-align: center;">1766.1 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">1305.6 MB</td>
<td style="text-align: center;">840.2 MB</td>
<td style="text-align: center;">2145.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">1966.3 MB</td>
<td style="text-align: center;">822.2 MB</td>
<td style="text-align: center;">2788.5 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3434.3 MB</td>
<td style="text-align: center;">1677.3 MB</td>
<td style="text-align: center;">3792.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">3767.5 MB</td>
<td style="text-align: center;">2279.7 MB</td>
<td style="text-align: center;">4873.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">4835.0 MB</td>
<td style="text-align: center;">3004.6 MB</td>
<td style="text-align: center;">6409.6 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">2954.8 MB</td>
<td style="text-align: center;">1685.6 MB</td>
<td style="text-align: center;">3436.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">3938.8 MB</td>
<td style="text-align: center;">2270.4 MB</td>
<td style="text-align: center;">4868.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">4872.2 MB</td>
<td style="text-align: center;">3003.8 MB</td>
<td style="text-align: center;">6410.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">6633.3 MB</td>
<td style="text-align: center;">3915.3 MB</td>
<td style="text-align: center;">8956.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">10236.8 MB</td>
<td style="text-align: center;">5349.5 MB</td>
<td style="text-align: center;">13704.6 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.pytrain" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.pytrain">colbert/indexing/collection_indexer.py/<code>train</code></h3>
<p>IIUC, this function call finds centroids based on a sample of document token embeddings. Interesting to note that the memory change for raw ColBERT is smallest for 1M documents (87.2 MB) and for RAGatouille, 2M docs is the smallest (23.4 MB). For most collection sizes, RAGatouille uses <mark>40-50%</mark> more memory for this operation.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1545.5 MB</td>
<td style="text-align: center;">115.8 MB</td>
<td style="text-align: center;">1661.3 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">1632.1 MB</td>
<td style="text-align: center;">128.8 MB</td>
<td style="text-align: center;">1760.9 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">1766.1 MB</td>
<td style="text-align: center;">124.3 MB</td>
<td style="text-align: center;">1890.4 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">2145.8 MB</td>
<td style="text-align: center;">87.2 MB</td>
<td style="text-align: center;">2233.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">2788.5 MB</td>
<td style="text-align: center;">133.5 MB</td>
<td style="text-align: center;">2921.9 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3792.3 MB</td>
<td style="text-align: center;">179.6 MB</td>
<td style="text-align: center;">3971.9 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">4873.2 MB</td>
<td style="text-align: center;">182.7 MB</td>
<td style="text-align: center;">5055.9 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">6409.6 MB</td>
<td style="text-align: center;">174.1 MB</td>
<td style="text-align: center;">6583.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3436.6 MB</td>
<td style="text-align: center;">175.9 MB</td>
<td style="text-align: center;">3612.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">4868.3 MB</td>
<td style="text-align: center;">181.5 MB</td>
<td style="text-align: center;">5049.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">6410.2 MB</td>
<td style="text-align: center;">179.2 MB</td>
<td style="text-align: center;">6589.4 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">8956.0 MB</td>
<td style="text-align: center;">191.5 MB</td>
<td style="text-align: center;">9147.5 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">13704.6 MB</td>
<td style="text-align: center;">23.4 MB</td>
<td style="text-align: center;">13728.1 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.pyindex" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.pyindex">colbert/indexing/collection_indexer.py/<code>index</code></h3>
<p>This is one of the more interesting results—raw ColBERT has a positive memory change during this operation (which IIUC is the indexing of all document token embeddings) while <em>all</em> RAGatouille <code>index()</code> operations actually <em>reduce the memory usage</em>. Not sure what that means. The final memory for raw ColBERT is less than RAGatouille.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1661.3 MB</td>
<td style="text-align: center;">287.0 MB</td>
<td style="text-align: center;">1948.3 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">1760.9 MB</td>
<td style="text-align: center;">263.5 MB</td>
<td style="text-align: center;">2024.4 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">1890.4 MB</td>
<td style="text-align: center;">371.9 MB</td>
<td style="text-align: center;">2262.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">2233.0 MB</td>
<td style="text-align: center;">599.9 MB</td>
<td style="text-align: center;">2832.9 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">2921.9 MB</td>
<td style="text-align: center;">958.0 MB</td>
<td style="text-align: center;">3880.0 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3971.9 MB</td>
<td style="text-align: center;">-536.3 MB</td>
<td style="text-align: center;">3435.6 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">5055.9 MB</td>
<td style="text-align: center;">-1375.8 MB</td>
<td style="text-align: center;">3680.1 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">6583.8 MB</td>
<td style="text-align: center;">-1936.3 MB</td>
<td style="text-align: center;">4647.5 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3612.6 MB</td>
<td style="text-align: center;">-652.4 MB</td>
<td style="text-align: center;">2960.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">5049.8 MB</td>
<td style="text-align: center;">-1112.5 MB</td>
<td style="text-align: center;">3937.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">6589.4 MB</td>
<td style="text-align: center;">-1906.8 MB</td>
<td style="text-align: center;">4682.6 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">9147.5 MB</td>
<td style="text-align: center;">-2917.3 MB</td>
<td style="text-align: center;">6230.1 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">13728.1 MB</td>
<td style="text-align: center;">-4910.2 MB</td>
<td style="text-align: center;">8817.9 MB</td>
</tr>
</tbody>
</table>
</section>
<section id="colbertindexingcollection_indexer.pyfinalize" class="level3">
<h3 class="anchored" data-anchor-id="colbertindexingcollection_indexer.pyfinalize">colbert/indexing/collection_indexer.py/<code>finalize</code></h3>
<p>This function maps passage IDs to centroid IDs—one of the efficiencies of the PLAID indexing approach. Within each approach (raw ColBERT and RAGatouille) the memory change varies drastically between less than 0 and up to ~500MB.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Indexing Method</th>
<th style="text-align: center;">Document Size</th>
<th style="text-align: center;">Initial Memory</th>
<th style="text-align: center;">Memory Change</th>
<th style="text-align: center;">Final Memory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">1948.3 MB</td>
<td style="text-align: center;">35.1 MB</td>
<td style="text-align: center;">1983.3 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">2024.4 MB</td>
<td style="text-align: center;">-0.4 MB</td>
<td style="text-align: center;">2024.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">2262.2 MB</td>
<td style="text-align: center;">59.2 MB</td>
<td style="text-align: center;">2321.5 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">2832.9 MB</td>
<td style="text-align: center;">201.5 MB</td>
<td style="text-align: center;">3034.4 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERT</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">3880.0 MB</td>
<td style="text-align: center;">490.2 MB</td>
<td style="text-align: center;">4370.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>use_faiss=True</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">3435.6 MB</td>
<td style="text-align: center;">-1.3 MB</td>
<td style="text-align: center;">3434.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">3680.1 MB</td>
<td style="text-align: center;">87.4 MB</td>
<td style="text-align: center;">3767.5 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>True</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">4647.5 MB</td>
<td style="text-align: center;">187.5 MB</td>
<td style="text-align: center;">4835.0 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>use_faiss=False</code>)</td>
<td style="text-align: center;">100k</td>
<td style="text-align: center;">2960.2 MB</td>
<td style="text-align: center;">-5.3 MB</td>
<td style="text-align: center;">2954.8 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">250k</td>
<td style="text-align: center;">3937.3 MB</td>
<td style="text-align: center;">1.5 MB</td>
<td style="text-align: center;">3938.8 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">500k</td>
<td style="text-align: center;">4682.6 MB</td>
<td style="text-align: center;">189.6 MB</td>
<td style="text-align: center;">4872.2 MB</td>
</tr>
<tr class="even">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">1M</td>
<td style="text-align: center;">6230.1 MB</td>
<td style="text-align: center;">403.2 MB</td>
<td style="text-align: center;">6633.3 MB</td>
</tr>
<tr class="odd">
<td style="text-align: center;">RAGatouille (<code>False</code>)</td>
<td style="text-align: center;">2M</td>
<td style="text-align: center;">8817.9 MB</td>
<td style="text-align: center;">1418.9 MB</td>
<td style="text-align: center;">10236.8 MB</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="indexing-time" class="level2">
<h2 class="anchored" data-anchor-id="indexing-time">Indexing Time</h2>
<p>I didn’t measure runtime for each run, but some observations:</p>
<ul>
<li>During passage encoding (25k passages per iteration) ColBERT took about <mark>20 seconds/it</mark> and RAGatouille took about <mark>110 seconds/it</mark>. Note that without profiling ColBERT took about 9/seconds/it and RAGatouille 12 seconds/it.</li>
<li>ColBERT encoding lasted 4, 10, 20, 40 and 80 iterations for 100k, 250k, 500k, 1M and 2M docs. RAGatouille always overshot it (e.g.&nbsp;14 iters for 250k docs or 22 iters for 500k docs).</li>
<li>Overall ColBERT profiling took ~2 hours while RAGatouille took ~16 hours.</li>
<li>It took a lot of time before the final encoding takes place, I think that’s because of the initial “planning” step that ColBERT and RAGatouille both do.</li>
</ul>
</section>
<section id="indexing-10k-documents-pytorch-vs-faiss-k-means-clustering" class="level2">
<h2 class="anchored" data-anchor-id="indexing-10k-documents-pytorch-vs-faiss-k-means-clustering">Indexing 10k Documents (PyTorch vs FAISS K-means Clustering)</h2>
<p>While I was experimenting indexing scripts with 10k documents I noticed curious behavior. For 10k documents, with <code>use_faiss=False</code>, RAGatouille attempts to use PyTorch for K-means clustering. The memory usage for <code>encoder.encode_passages</code> during this attempt:</p>
<pre><code>Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   146   1849.2 MiB   1849.2 MiB           1           @profile
   147                                                 def _encode_passages_profiled(*args, **kwargs):
   148   2675.7 MiB    826.5 MiB           1               return self.encoder.encode_passages(*args, **kwargs)</code></pre>
<p>It then runs into an OOM error:</p>
<pre><code>PyTorch-based indexing did not succeed with error: CUDA out of memory. Tried to allocate 27.55 GiB. GPU 0 has a total capacity of 47.51 GiB of which 4.88 GiB is free.</code></pre>
<p>And switches to FAISS K-means. The memory usage for <code>encoder.encode_passages</code> changes (note the drop from an increase of 826.5 MB to an increase of 373 MB, but an increase in initial memory usage from 1849.2 MB to 2652.6MB):</p>
<pre><code>Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   146   2652.6 MiB   2652.6 MiB           1           @profile
   147                                                 def _encode_passages_profiled(*args, **kwargs):
   148   3025.6 MiB    373.0 MiB           1               return self.encoder.encode_passages(*args, **kwargs)</code></pre>
<p>When I run the script with <code>use_faiss=True</code>, the <code>encoder.encode_passages</code> memory usage reflects the PyTorch attempt, whereas I would expect the memory increase to be 373 MB:</p>
<pre><code>Line #    Mem usage    Increment  Occurrences   Line Contents
=============================================================
   146   1853.4 MiB   1853.4 MiB           1           @profile
   147                                                 def _encode_passages_profiled(*args, **kwargs):
   148   2678.8 MiB    825.4 MiB           1               return self.encoder.encode_passages(*args, **kwargs)</code></pre>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>This exercise has left me with more questions than answers that I need to explore:</p>
<ul>
<li>Is this the best way to go about profiling memory?</li>
<li>Am I interpreting the memory profiling results correctly?</li>
<li>Why does RAGatouille have a higher initial memory before indexing starts?</li>
<li>Why does RAGatouille retain more memory after indexing than ColBERT?</li>
<li>Why does RAGatouille memory usage drastically <em>decrease</em> during <code>index()</code>?</li>
<li>Why does RAGatouille max out CUDA memory for 10k documents? Related to <a href="https://github.com/AnswerDotAI/RAGatouille/issues/247">Issue #247</a>.</li>
<li>Why does RAGatouille’s memory usage when <code>use_faiss=True</code> match PyTorch K-means’ memory usage and not the FAISS K-means’ memory usage after PyTorch’s attempt fails with OOM?</li>
</ul>
<p>Additionally, and probably relatedly, I still haven’t figured out what is causing the large memory spike in the diagram below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="CPU memory usage while indexing 250k documents"><img src="https://vishalbakshi.github.io/blog/posts/2025-02-14-RAGatouille-ColBERT-Memory-Profiling/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">CPU memory usage while indexing 250k documents</figcaption><p></p>
</figure>
</div>
<p>The largest memory value profiled while indexing 250k docs using RAGatouille was 5 GB but the chart shows a spike up to ~8GB. Where’s the ghost 3GB?</p>
<p>TBD.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>information retrieval</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-02-14-RAGatouille-ColBERT-Memory-Profiling/index.html</guid>
  <pubDate>Mon, 17 Feb 2025 08:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2025-02-14-RAGatouille-ColBERT-Memory-Profiling/1.png" medium="image" type="image/png" height="60" width="144"/>
</item>
<item>
  <title>Estimating Storage and CPU RAM Requirements for Indexing 12.6M Documents</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-02-12-indexing-memory/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>After a few days of flailing about trying to index the 12.6M document <em>Genomics</em> dataset (from <a href="https://huggingface.co/datasets/UKPLab/dapr">UKPLab/DAPR</a>) in Google Colab Pro using RAGatouille, I decided to plan the attempt in a more organized way. In this blog post I’ll share my findings and next actions.</p>
<p>Here’s an example text from the corpus:</p>
<pre><code>The 33D1 rat MoAb92  identifies a low-density Ag on mouse (marginal zone) spleen DC. The antibody does not stain DC in cryostat sections and does not react with LC. No biochemical data on the Ag are available. Nonetheless, this antibody has proved extremely useful for C lysis of mouse spleen DC.\r\n</code></pre>
<p>The average length of text in this corpus is ~540 characters.</p>
</section>
<section id="rag.index" class="level2">
<h2 class="anchored" data-anchor-id="rag.index"><code>RAG.index</code></h2>
<p>The main function of interest if <code>RAG.index</code> which takes a list of documents and indexes them in preparation for retrieval.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(</span>
<span id="cb2-2">            index_name<span class="op" style="color: #5E5E5E;">=</span><span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_index"</span>,</span>
<span id="cb2-3">            collection<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"text"</span>],</span>
<span id="cb2-4">            document_ids<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"_id"</span>]</span>
<span id="cb2-5">        )</span></code></pre></div>
<p>I used the following code to log the RAM memory usage, with <code>ndocs</code> being defined globally:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;">def</span> memory_monitor(stop_event, readings):</span>
<span id="cb3-2">    <span class="cf" style="color: #003B4F;">while</span> <span class="kw" style="color: #003B4F;">not</span> stop_event.is_set():</span>
<span id="cb3-3">        mem <span class="op" style="color: #5E5E5E;">=</span> psutil.Process().memory_info().rss <span class="op" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">1024</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">1024</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">1024</span></span>
<span id="cb3-4">        readings.append((datetime.now(), mem))</span>
<span id="cb3-5">        time.sleep(<span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="kw" style="color: #003B4F;">def</span> log_memory_during_index():</span>
<span id="cb3-8">    stop_event <span class="op" style="color: #5E5E5E;">=</span> threading.Event()</span>
<span id="cb3-9">    readings <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb3-10">    monitor_thread <span class="op" style="color: #5E5E5E;">=</span> threading.Thread(target<span class="op" style="color: #5E5E5E;">=</span>memory_monitor, args<span class="op" style="color: #5E5E5E;">=</span>(stop_event, readings))</span>
<span id="cb3-11">    monitor_thread.start()</span>
<span id="cb3-12">    </span>
<span id="cb3-13">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb3-14">        index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(</span>
<span id="cb3-15">            index_name<span class="op" style="color: #5E5E5E;">=</span><span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_index"</span>,</span>
<span id="cb3-16">            collection<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"text"</span>],</span>
<span id="cb3-17">            document_ids<span class="op" style="color: #5E5E5E;">=</span>passages[:ndocs][<span class="st" style="color: #20794D;">"_id"</span>]</span>
<span id="cb3-18">        )</span>
<span id="cb3-19">    <span class="cf" style="color: #003B4F;">finally</span>:</span>
<span id="cb3-20">        stop_event.<span class="bu" style="color: null;">set</span>()</span>
<span id="cb3-21">        monitor_thread.join()</span>
<span id="cb3-22">    </span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;">return</span> index_path, readings</span>
<span id="cb3-24"></span>
<span id="cb3-25">index_path, memory_readings <span class="op" style="color: #5E5E5E;">=</span> log_memory_during_index()</span></code></pre></div>
</section>
<section id="memory-logging-results" class="level2">
<h2 class="anchored" data-anchor-id="memory-logging-results">Memory Logging Results</h2>
<p>I used two machines for these experiments:</p>
<ul>
<li>T4 GPU (16 GB vRAM, 51GB RAM) using Google Colab Pro.</li>
<li>RTX6000Ada (48GB vRAM, 128GB RAM) using Jarvis Labs.</li>
</ul>
<p>I chose the following number of documents to index: - 100k - 250k - 500k - 1M - 2M</p>
<p>Here are the results:</p>
<p><em>RTX6000Ada (48GB vRAM, 128GB RAM)</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"># Docs</th>
<th style="text-align: center;">index_path Size</th>
<th style="text-align: center;">Max RAM</th>
<th style="text-align: center;">Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">100k</td>
<td style="text-align: center;">0.41 GB</td>
<td style="text-align: center;">6.96 GB</td>
<td style="text-align: center;">4 min</td>
</tr>
<tr class="even">
<td style="text-align: center;">250k</td>
<td style="text-align: center;">1.1 GB</td>
<td style="text-align: center;">8.4 GB</td>
<td style="text-align: center;">6.4 min</td>
</tr>
<tr class="odd">
<td style="text-align: center;">500k</td>
<td style="text-align: center;">2.2 GB</td>
<td style="text-align: center;">11.4 GB</td>
<td style="text-align: center;">12 min</td>
</tr>
<tr class="even">
<td style="text-align: center;">1M</td>
<td style="text-align: center;">4.5 GB</td>
<td style="text-align: center;">16.3 GB</td>
<td style="text-align: center;">24 min</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2M</td>
<td style="text-align: center;">9.1 GB</td>
<td style="text-align: center;">24 GB</td>
<td style="text-align: center;">47 min</td>
</tr>
</tbody>
</table>
<p><em>T4 w/High-RAM (16GB vRAM, 51GB RAM)</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"># Docs</th>
<th style="text-align: center;">index_path Size</th>
<th style="text-align: center;">Max RAM</th>
<th style="text-align: center;">Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">100k</td>
<td style="text-align: center;">0.41 GB</td>
<td style="text-align: center;">6.5 GB</td>
<td style="text-align: center;">8 min</td>
</tr>
<tr class="even">
<td style="text-align: center;">250k</td>
<td style="text-align: center;">1.1 GB</td>
<td style="text-align: center;">8.8 GB</td>
<td style="text-align: center;">20 min</td>
</tr>
<tr class="odd">
<td style="text-align: center;">500k</td>
<td style="text-align: center;">2.2 GB</td>
<td style="text-align: center;">11.8 GB</td>
<td style="text-align: center;">36 min</td>
</tr>
<tr class="even">
<td style="text-align: center;">1M</td>
<td style="text-align: center;">4.5 GB</td>
<td style="text-align: center;">18.8 GB</td>
<td style="text-align: center;">78 min</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2M</td>
<td style="text-align: center;">9.1 GB</td>
<td style="text-align: center;">28.6 GB</td>
<td style="text-align: center;">145 min</td>
</tr>
</tbody>
</table>
<p>I also used the A100 instance on Google Colab Pro for some initial experiments. It’s interesting to note the difference in speed of encoding 25k passages:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">GPU</th>
<th style="text-align: center;">seconds/25k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">RTX6000Ada</td>
<td style="text-align: center;">12</td>
</tr>
<tr class="even">
<td style="text-align: center;">A100</td>
<td style="text-align: center;">22</td>
</tr>
<tr class="odd">
<td style="text-align: center;">T4</td>
<td style="text-align: center;">44</td>
</tr>
</tbody>
</table>
</section>
<section id="extrapolating-to-12.6m-documents" class="level2">
<h2 class="anchored" data-anchor-id="extrapolating-to-12.6m-documents">Extrapolating to 12.6M Documents</h2>
<p>I’ll start with the easier one: the size of the directory created by <code>RAG.index</code>. Doubling the number of documents doubles its size (approximately) so if 1M documents takes up 4.5GB of space I expect 12.6M documents to take up ~54GB of space. I’ll set my storage size to 100GB just in case.</p>
<p>The maximum RAM used (by the CPU, not the GPU vRAM) for 12.6M documents is a bit more involved. I’m planning to use the RTX6000Ada machine so I’ll use its numbers.</p>
<p><em>RTX6000Ada (48GB vRAM, 128GB RAM)</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"># Docs</th>
<th style="text-align: center;">Max RAM</th>
<th style="text-align: center;">Increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">100k</td>
<td style="text-align: center;">6.96 GB</td>
<td style="text-align: center;">–</td>
</tr>
<tr class="even">
<td style="text-align: center;">250k</td>
<td style="text-align: center;">8.4 GB</td>
<td style="text-align: center;">20%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">500k</td>
<td style="text-align: center;">11.4 GB</td>
<td style="text-align: center;">36%</td>
</tr>
<tr class="even">
<td style="text-align: center;">1M</td>
<td style="text-align: center;">16.3 GB</td>
<td style="text-align: center;">43%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2M</td>
<td style="text-align: center;">24 GB</td>
<td style="text-align: center;">47%</td>
</tr>
</tbody>
</table>
<p>The percent increase amount is slowing down. Let’s say it plateaus at a 50% increase going from 2M to 4M documents (doubling). 2M to 12.6M is ~2.66 doublings (is that a word?). 24 GB x 1.5^2.66 = 70GB. If I was using Colab numbers: 28.6 x 1.5^2.66 = 84 GB. When I tried to index 12.6M documents with an A100 High-RAM (83.5 GB CPU) instance on Google Colab Pro, the runtime crashed as it ran out of System RAM so this checks out.</p>
<p>Finally, let’s say the time it takes to index documents doubles when the number of documents doubles from 2M onwards. 47 min x 2^2.66 = 300 minutes or 5 hours. At about $1/hr, this would take $5 on an RTX6000Ada.</p>
<p>I should note that in all my experiments, the GPU vRAM usage didn’t go past 3-4 GB.</p>
<p>While the peak CPU RAM usage varied, in all instances the plots looked like the following (2M documents on RTX6000Ada):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="RTX6000/2M.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="System RAM Usage over Indexing Time"><img src="https://vishalbakshi.github.io/blog/posts/2025-02-12-indexing-memory/RTX6000/2M.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">System RAM Usage over Indexing Time</figcaption><p></p>
</figure>
</div>
<p>I couldn’t figure out from my profiler the exact function call during that largest spike. Also note the spike near the end before indexing is finished.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Time will tell if these calculations are worth anything, but it seems like my best option is to use Jarvis Labs’ RTX6000Ada machine with 128GB CPU RAM. Once I successfully index the 12.6M-document <em>Genomics</em> dataset, I’ll have a better estimate for how much it will cost to index the largest dataset in the DAPR collection: MIRACL (32.9M documents). Stay tuned!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>information retrieval</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-02-12-indexing-memory/index.html</guid>
  <pubDate>Wed, 12 Feb 2025 08:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2025-02-12-indexing-memory/RTX6000/2M.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Evaluating the DAPR ConditionalQA Dataset with RAGatouille</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-02-08-ConditionalQA-RAGatouille/index.html</link>
  <description><![CDATA[ 



<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install datasets ragatouille pytrec_eval ranx</span></code></pre></div>
</div>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;">from</span> datasets <span class="im" style="color: #00769E;">import</span> load_dataset</span>
<span id="cb2-2"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb2-5"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="im" style="color: #00769E;">import</span> pytrec_eval</span>
<span id="cb2-8"><span class="im" style="color: #00769E;">from</span> ranx <span class="im" style="color: #00769E;">import</span> evaluate</span>
<span id="cb2-9"><span class="im" style="color: #00769E;">from</span> ranx <span class="im" style="color: #00769E;">import</span> Qrels, Run</span></code></pre></div>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I wanted to get familiar with classic information retrieval datasets, especially those with explicit documents. I searched with Perplexity and ChatGPT and came across <a href="https://huggingface.co/datasets/UKPLab/dapr">DAPR: Document-Aware Passage Retrieval</a> which sounded perfect for my use case.</p>
<p>In this blog post I’ll work through evaluating the test split of the <em>ConditionalQA</em> dataset in DAPR using RAGatouille and the <code>answerai-colbert-small-v1</code> model for retrieval and the pytrec and ranx libraries for evaluation. I’ll use the simple Recall@10 metric as it’s the easiest to manually check.</p>
</section>
<section id="load-and-view-data" class="level2">
<h2 class="anchored" data-anchor-id="load-and-view-data">Load and View Data</h2>
<p>Here are the three datasets we are going to use for this evaluation:</p>
<ul>
<li><code>ConditionalQA-corpus</code>, our <em>passages</em></li>
<li><code>ConditionalQA_queries</code>, our <em>queries</em></li>
<li>and <code>ConditionalQA_qrels</code>, the mapping between queries and passages.</li>
</ul>
<div class="cell" data-outputid="ceab6651-e1f3-4b5a-8373-82e45f396356" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">passages <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="st" style="color: #20794D;">"ConditionalQA-corpus"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test"</span>)</span>
<span id="cb3-2">passages</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>Dataset({
    features: ['_id', 'text', 'title', 'doc_id', 'paragraph_no', 'total_paragraphs', 'is_candidate'],
    num_rows: 69199
})</code></pre>
</div>
</div>
<div class="cell" data-outputid="e8490f49-f5ff-4825-d72d-1f7ea5e95830" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">passages[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'_id': '0-0',
 'text': 'Overview',
 'title': 'Child Tax Credit',
 'doc_id': '0',
 'paragraph_no': 0,
 'total_paragraphs': 77,
 'is_candidate': True}</code></pre>
</div>
</div>
<div class="cell" data-outputid="b8182782-913d-452c-9309-cf3619b76b74" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">queries <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="st" style="color: #20794D;">"ConditionalQA-queries"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test"</span>)</span>
<span id="cb7-2">queries</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Dataset({
    features: ['_id', 'text'],
    num_rows: 271
})</code></pre>
</div>
</div>
<div class="cell" data-outputid="d6c6b29f-4247-4d08-a3c2-0127dfbd2976" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">queries[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'_id': 'dev-0',
 'text': 'My brother and his wife are in prison for carrying out a large fraud scheme. Their 7 and 8 year old children have been living with me for the last 4 years. I want to become their Special Guardian to look after them permanently How long will it be before I hear back from the court?'}</code></pre>
</div>
</div>
<div class="cell" data-outputid="3143c688-ff8e-4d82-c86f-45cc6a5740c6" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">qrels_rows <span class="op" style="color: #5E5E5E;">=</span> load_dataset(<span class="st" style="color: #20794D;">"UKPLab/dapr"</span>, <span class="st" style="color: #20794D;">"ConditionalQA-qrels"</span>, split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"test"</span>)</span>
<span id="cb11-2">qrels_rows</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>Dataset({
    features: ['query_id', 'corpus_id', 'score'],
    num_rows: 1165
})</code></pre>
</div>
</div>
<div class="cell" data-outputid="4f02605d-6926-402d-a9fa-d64c632e8d45" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">qrels_rows[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>{'query_id': 'dev-0', 'corpus_id': '86-41', 'score': 1}</code></pre>
</div>
</div>
<p>Load <code>answerai-colbert-small-v1</code>:</p>
<div class="cell" data-outputid="26b62465-2651-46fc-dd7c-b2d4f18cbf11" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(<span class="st" style="color: #20794D;">"answerdotai/answerai-colbert-small-v1"</span>)</span>
<span id="cb15-2">RAG</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;ragatouille.RAGPretrainedModel.RAGPretrainedModel at 0x7e5328fdced0&gt;</code></pre>
</div>
</div>
<p>Structure the passages for indexing:</p>
<div class="cell" data-outputid="0a932d5e-c59b-4730-c312-b1fdbecf20c7" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">passages[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>{'_id': ['0-0', '0-1', '0-2', '0-3', '0-4'],
 'text': ['Overview',
  'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
  'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.',
  'You might be able to apply for Pension Credit if you and your partner are State Pension age or over.',
  'What you’ll get'],
 'title': ['Child Tax Credit',
  'Child Tax Credit',
  'Child Tax Credit',
  'Child Tax Credit',
  'Child Tax Credit'],
 'doc_id': ['0', '0', '0', '0', '0'],
 'paragraph_no': [0, 1, 2, 3, 4],
 'total_paragraphs': [77, 77, 77, 77, 77],
 'is_candidate': [True, True, True, True, True]}</code></pre>
</div>
</div>
<div class="cell" data-outputid="06d8e8e2-5646-4526-a747-90b40a622637" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">passage_texts <span class="op" style="color: #5E5E5E;">=</span> [p[<span class="st" style="color: #20794D;">'text'</span>] <span class="cf" style="color: #003B4F;">for</span> p <span class="kw" style="color: #003B4F;">in</span> passages]</span>
<span id="cb19-2">passage_texts[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>['Overview',
 'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
 'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.',
 'You might be able to apply for Pension Credit if you and your partner are State Pension age or over.',
 'What you’ll get']</code></pre>
</div>
</div>
<div class="cell" data-outputid="5b1b49c9-3b17-460c-a60d-4219b7ab425e" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">passage_ids <span class="op" style="color: #5E5E5E;">=</span> [p[<span class="st" style="color: #20794D;">'_id'</span>] <span class="cf" style="color: #003B4F;">for</span> p <span class="kw" style="color: #003B4F;">in</span> passages]</span>
<span id="cb21-2">passage_ids[:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>['0-0', '0-1', '0-2', '0-3', '0-4']</code></pre>
</div>
</div>
</section>
<section id="build-the-index-and-run-search" class="level2">
<h2 class="anchored" data-anchor-id="build-the-index-and-run-search">Build the index and run search</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(</span>
<span id="cb23-2">    index_name<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"conditionalqa_index"</span>,</span>
<span id="cb23-3">    collection<span class="op" style="color: #5E5E5E;">=</span>passage_texts,</span>
<span id="cb23-4">    document_ids<span class="op" style="color: #5E5E5E;">=</span>passage_ids</span>
<span id="cb23-5">)</span></code></pre></div>
</div>
<p>Taking a look at the results for a single query. Each result has a <code>content</code>, <code>score</code>, <code>rank</code>, <code>document_id</code>, and <code>passage_id</code>. Note a bit of confusing terminology: <code>document_id</code> is actually the id of the item in the <code>passages</code> dataset and <code>passage_id</code> is an identifier created by RAGatouille, unrelated to the datasets.</p>
<div class="cell" data-outputid="4e79a9a3-9bc4-4613-d584-aedc0e59c16c" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">results <span class="op" style="color: #5E5E5E;">=</span> RAG.search(queries[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'text'</span>], k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb24-2">results</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>[{'content': 'You must advertise your claim within 14 days from the day you get a date for the first court hearing. The advert must appear in a print or online newspaper that covers the missing person’s last known usual address.',
  'score': 70.0,
  'rank': 1,
  'document_id': '107-103',
  'passage_id': 10480},
 {'content': 'The guardianship order will make you a guardian for a maximum of 4 years.',
  'score': 70.0,
  'rank': 2,
  'document_id': '107-242',
  'passage_id': 10619},
 {'content': 'You can claim joint Housing Benefit for up to 13 weeks if one of you has gone to prison and is likely to return home in 13 weeks or less - including any time on remand.',
  'score': 69.9375,
  'rank': 3,
  'document_id': '8-67',
  'passage_id': 911},
 {'content': 'The date will be either 14 or 28 days after your court hearing. If you’re in an exceptionally difficult situation, you may be able to convince the judge to delay this for up to 6 weeks.',
  'score': 69.9375,
  'rank': 4,
  'document_id': '496-116',
  'passage_id': 47939},
 {'content': 'You can claim or continue to claim joint Council Tax Reduction if your partner’s expected to be in prison for 13 weeks or less – including any time on remand.',
  'score': 69.875,
  'rank': 5,
  'document_id': '8-80',
  'passage_id': 924},
 {'content': 'Sometimes you’ll be given a 2 to 4 week period that you’ll need to keep free - this is known as a ‘warned period’ or ‘floating trial’. If this happens, you’ll be given 1 working day’s notice before you are due to go to court.',
  'score': 69.875,
  'rank': 6,
  'document_id': '254-4',
  'passage_id': 23999},
 {'content': 'Your Child Benefit payments will stop after 8 weeks if your child goes to prison or is on remand. You’ll get arrears if they’re cleared of the offence.',
  'score': 69.8125,
  'rank': 7,
  'document_id': '8-116',
  'passage_id': 960},
 {'content': 'You may be able to make a claim if you’re the dependant of someone who suffered from a dust-related disease but who has died. A dependant claim must be made within 12 months of the death of the sufferer.',
  'score': 69.8125,
  'rank': 8,
  'document_id': '45-133',
  'passage_id': 4921},
 {'content': 'You’ll be responsible for looking after the child until they’re 18 (unless the court takes your responsibility away earlier).',
  'score': 69.8125,
  'rank': 9,
  'document_id': '86-2',
  'passage_id': 8150},
 {'content': 'If it’s less than 90 days since the person went missing, explain you need the guardianship order urgently, for example, because the person is going to lose their house.',
  'score': 69.8125,
  'rank': 10,
  'document_id': '107-43',
  'passage_id': 10420}]</code></pre>
</div>
</div>
</section>
<section id="evaluation" class="level2">
<h2 class="anchored" data-anchor-id="evaluation">Evaluation</h2>
<p>I’ll prepare <code>qrels</code> for the pytrec evaluator as is done in the DAPR dataset card example on HF:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">qrels <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb26-2"><span class="cf" style="color: #003B4F;">for</span> qrel_row <span class="kw" style="color: #003B4F;">in</span> qrels_rows:</span>
<span id="cb26-3">    qid <span class="op" style="color: #5E5E5E;">=</span> qrel_row[<span class="st" style="color: #20794D;">"query_id"</span>]</span>
<span id="cb26-4">    pid <span class="op" style="color: #5E5E5E;">=</span> qrel_row[<span class="st" style="color: #20794D;">"corpus_id"</span>]</span>
<span id="cb26-5">    rel <span class="op" style="color: #5E5E5E;">=</span> qrel_row[<span class="st" style="color: #20794D;">"score"</span>]</span>
<span id="cb26-6">    qrels.setdefault(qid, {})</span>
<span id="cb26-7">    qrels[qid][pid] <span class="op" style="color: #5E5E5E;">=</span> rel</span></code></pre></div>
</div>
<p><code>dev-5</code> is a query ID with multiple passages so I’ve chosen it as the test example:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">qid <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'dev-5'</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="0cab7461-acd2-49c9-f942-456f2daae9a3" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">qrels[qid]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>{'61-1': 1, '61-4': 1, '61-5': 1, '61-17': 1, '61-37': 1, '61-39': 1}</code></pre>
</div>
</div>
<div class="cell" data-outputid="fcb898ec-c639-4b1a-bb0c-69cf15d6fcfe" data-execution_count="22">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">pytrec_results <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb30-2">pytrec_results</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>{}</code></pre>
</div>
</div>
<p>Next we’ll run retrieval and structure results for the pytrec evaluator, again copying the DAPR example which structures the retrieval results as:</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">retrieval_scores[query_id][passage_id] <span class="op" style="color: #5E5E5E;">=</span> score</span></code></pre></div>
<p>Note again that <code>document_id</code> means passage_id.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> queries:</span>
<span id="cb33-2">    results <span class="op" style="color: #5E5E5E;">=</span> RAG.search(q[<span class="st" style="color: #20794D;">'text'</span>], k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb33-3">    pytrec_results[q[<span class="st" style="color: #20794D;">'_id'</span>]] <span class="op" style="color: #5E5E5E;">=</span> {result[<span class="st" style="color: #20794D;">'document_id'</span>]: <span class="bu" style="color: null;">float</span>(result[<span class="st" style="color: #20794D;">'score'</span>]) <span class="cf" style="color: #003B4F;">for</span> result <span class="kw" style="color: #003B4F;">in</span> results}</span></code></pre></div>
</div>
<p>We can see the 10 passages and each one has a corresponding score.</p>
<div class="cell" data-outputid="3d972b82-3755-4937-9ac6-ad20f8c672fc" data-execution_count="36">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">pytrec_results[qid]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>{'61-1': 71.125,
 '423-16': 70.5625,
 '61-27': 70.4375,
 '61-109': 70.375,
 '61-110': 70.25,
 '61-113': 70.25,
 '61-114': 70.25,
 '426-22': 70.1875,
 '420-42': 70.1875,
 '423-7': 70.125}</code></pre>
</div>
</div>
<p>Calculate Recall for all queries and viewing a single query’s Recall:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">evaluator <span class="op" style="color: #5E5E5E;">=</span> pytrec_eval.RelevanceEvaluator(qrels, {<span class="st" style="color: #20794D;">'recall.10'</span>})</span></code></pre></div>
</div>
<p>There are 271 queries and 271 metrics (one per query):</p>
<div class="cell" data-outputid="571e47c0-b984-4d5c-dba4-7b501c02f139" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">metrics <span class="op" style="color: #5E5E5E;">=</span> evaluator.evaluate(pytrec_results)</span>
<span id="cb37-2"><span class="bu" style="color: null;">len</span>(metrics)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>271</code></pre>
</div>
</div>
<p>For our <code>dev-5</code> query the Recall@10 is 0.167 or 1/6.</p>
<div class="cell" data-outputid="07661f1e-4732-4c1f-ca8b-896b1afff7e0" data-execution_count="26">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">metrics[qid]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>{'recall_10': 0.16666666666666666}</code></pre>
</div>
</div>
<p>Here are the 6 passages that we needed to retrieve to fully answer this question:</p>
<div class="cell" data-outputid="2d1792f4-7e92-4f3e-bab5-a8d0ff79fbdf" data-execution_count="27">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">qrels[qid]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>{'61-1': 1, '61-4': 1, '61-5': 1, '61-17': 1, '61-37': 1, '61-39': 1}</code></pre>
</div>
</div>
<p>And here are the results again—only 1 relevant passage, <code>61-1</code>, was retrieved.</p>
<div class="cell" data-outputid="b638ed99-ba08-486a-ee92-bba78540238a" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">pytrec_results[qid]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>{'61-1': 71.125,
 '423-16': 70.5625,
 '61-27': 70.4375,
 '61-109': 70.375,
 '61-110': 70.25,
 '61-113': 70.25,
 '61-114': 70.25,
 '426-22': 70.1875,
 '420-42': 70.1875,
 '423-7': 70.125}</code></pre>
</div>
</div>
<p>Calculating mean Recall across all queries to get our mean Recall@10 for the entire collection of queries:</p>
<div class="cell" data-outputid="ab74903a-5984-4afb-90df-d77c18d0cc50" data-execution_count="29">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">mean_recall <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sum</span>(metrics[qid][<span class="st" style="color: #20794D;">'recall_10'</span>] <span class="cf" style="color: #003B4F;">for</span> qid <span class="kw" style="color: #003B4F;">in</span> metrics.keys()) <span class="op" style="color: #5E5E5E;">/</span> <span class="bu" style="color: null;">len</span>(metrics)</span>
<span id="cb45-2">mean_recall</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.28046940381859803</code></pre>
</div>
</div>
<p>So, about 28% of all queries’ relevant passages were present in the top-10 passages retrieved.</p>
<p>I wanted to confirm my calculation so I’ll also calculate Recall@10 using the ranx library.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">qrels_ranx <span class="op" style="color: #5E5E5E;">=</span> Qrels(qrels)</span>
<span id="cb47-2">ranx_results <span class="op" style="color: #5E5E5E;">=</span> Run(pytrec_results)</span></code></pre></div>
</div>
<div class="cell" data-outputid="8924772d-4e13-4e1e-c1d6-1edbeba5faff" data-execution_count="35">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">evaluate(qrels_ranx, ranx_results, <span class="st" style="color: #20794D;">"recall@10"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>0.2804694038185978</code></pre>
</div>
</div>
<p>And we get the same results. Great!</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>In a future blog post I’ll calculate Recall@10 (and other metrics) on all of the datasets included in DAPR:</p>
<ul>
<li>ConditionalQA</li>
<li>MS MARCO</li>
<li>Genomics</li>
<li>MIRACL</li>
<li>Natural Questions</li>
</ul>
<p>Once that’s done, I’ll pick a few different retrieval models and compare their results across these datasets.</p>
<p>I think by the end of these experiments I’ll have a better grasp on how to work with classic IR datasets and metrics.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>information retrieval</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-02-08-ConditionalQA-RAGatouille/index.html</guid>
  <pubDate>Sat, 08 Feb 2025 08:00:00 GMT</pubDate>
</item>
<item>
  <title>DoRA’s Magnitude Vector</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2025-02-01-DoRA-Magnitude-Vector/index.html</link>
  <description><![CDATA[ 



<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> peft <span class="im" style="color: #00769E;">import</span> LoraConfig, get_peft_model</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">import</span> transformers</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;"># the following imports are from dora.py</span></span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> copy <span class="im" style="color: #00769E;">import</span> deepcopy</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">import</span> torch.nn.functional <span class="im" style="color: #00769E;">as</span> F</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">from</span> torch <span class="im" style="color: #00769E;">import</span> nn</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="im" style="color: #00769E;">from</span> peft.utils.integrations <span class="im" style="color: #00769E;">import</span> dequantize_module_weight, gather_params_ctx</span>
<span id="cb1-12"><span class="im" style="color: #00769E;">from</span> peft.utils.other <span class="im" style="color: #00769E;">import</span> transpose</span></code></pre></div>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I am currently re-reading the DoRA (Weight-Decomposed Low-Rank Adaptation) <a href="https://arxiv.org/abs/2402.09353">paper</a>. I took a bit of a detour and worked through the fantastic article <a href="https://magazine.sebastianraschka.com/p/lora-and-dora-from-scratch">Improving LoRA: Implementing Weight-Decomposed Low-Rank Adaptation (DoRA) from Scratch</a> by Sebastian Raschka (I am also reading his book <a href="https://www.manning.com/books/build-a-large-language-model-from-scratch">Building a Large Language Model (from scratch)</a> as part of a fastai study group). The article is full of helpful diagrams and breakdowns of concepts as well as easily digestible implementation in code. One particular breakthrough for me while reading the article was his demonstration of the distributive law of multiplication:</p>
<blockquote class="blockquote">
<p><strong>x.(W+ΔW) = x.W + x.ΔW</strong></p>
<p>Similarly, we can write the following for LoRA:</p>
<p><strong>x.(W+A.B) = x.W + x.A.B</strong></p>
</blockquote>
<p>Reading this made it click for me why and how LoRA adapters are such an efficient way of handling downstream tasks.</p>
<p>I also took a deep dive into the peft library’s implementation of DoRA. I recently made <a href="https://youtu.be/GE6jRudHhzY">a video</a> of this deep dive.</p>
<p>In this blog post I am going to compare Raschka’s article’s implementation with peft’s and highlight a key difference that I found between them in how they implement the decomposition of a weight matrix into its magnitude and directional components.</p>
<p>I’ll start by reviewing both approaches.</p>
</section>
<section id="raschkas-implementation" class="level2">
<h2 class="anchored" data-anchor-id="raschkas-implementation">Raschka’s Implementation</h2>
<p>I want to add a caveat that this implementation I assume is by no means a “final” or “production” implementation, as I understand it to be more educational and illustrative.</p>
<p>I’ll start by copy/pasting relevant code: <code>LoRALayer</code> (DoRA uses LoRA to fine-tune the directional component) and <code>LinearWithDoRAMerged</code>.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;">class</span> LoRALayer(nn.Module):</span>
<span id="cb2-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, in_dim, out_dim, rank, alpha):</span>
<span id="cb2-3">        <span class="bu" style="color: null;">super</span>().<span class="fu" style="color: #4758AB;">__init__</span>()</span>
<span id="cb2-4">        std_dev <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> torch.sqrt(torch.tensor(rank).<span class="bu" style="color: null;">float</span>())</span>
<span id="cb2-5">        <span class="va" style="color: #111111;">self</span>.A <span class="op" style="color: #5E5E5E;">=</span> nn.Parameter(torch.randn(in_dim, rank) <span class="op" style="color: #5E5E5E;">*</span> std_dev)</span>
<span id="cb2-6">        <span class="va" style="color: #111111;">self</span>.B <span class="op" style="color: #5E5E5E;">=</span> nn.Parameter(torch.zeros(rank, out_dim))</span>
<span id="cb2-7">        <span class="va" style="color: #111111;">self</span>.alpha <span class="op" style="color: #5E5E5E;">=</span> alpha</span>
<span id="cb2-8"></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;">def</span> forward(<span class="va" style="color: #111111;">self</span>, x):</span>
<span id="cb2-10">        x <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.alpha <span class="op" style="color: #5E5E5E;">*</span> (x <span class="op" style="color: #5E5E5E;">@</span> <span class="va" style="color: #111111;">self</span>.A <span class="op" style="color: #5E5E5E;">@</span> <span class="va" style="color: #111111;">self</span>.B)</span>
<span id="cb2-11">        <span class="cf" style="color: #003B4F;">return</span> x</span></code></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;">class</span> LinearWithDoRAMerged(nn.Module):</span>
<span id="cb3-2"></span>
<span id="cb3-3">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, linear, rank, alpha):</span>
<span id="cb3-4">        <span class="bu" style="color: null;">super</span>().<span class="fu" style="color: #4758AB;">__init__</span>()</span>
<span id="cb3-5">        <span class="va" style="color: #111111;">self</span>.linear <span class="op" style="color: #5E5E5E;">=</span> linear</span>
<span id="cb3-6">        <span class="va" style="color: #111111;">self</span>.lora <span class="op" style="color: #5E5E5E;">=</span> LoRALayer(</span>
<span id="cb3-7">            linear.in_features, linear.out_features, rank, alpha</span>
<span id="cb3-8">        )</span>
<span id="cb3-9">        <span class="va" style="color: #111111;">self</span>.m <span class="op" style="color: #5E5E5E;">=</span> nn.Parameter(</span>
<span id="cb3-10">            <span class="va" style="color: #111111;">self</span>.linear.weight.norm(p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>))</span>
<span id="cb3-11"></span>
<span id="cb3-12"></span>
<span id="cb3-13">  <span class="co" style="color: #5E5E5E;"># Code loosely inspired by</span></span>
<span id="cb3-14">  <span class="co" style="color: #5E5E5E;"># https://github.com/catid/dora/blob/main/dora.py</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">    <span class="kw" style="color: #003B4F;">def</span> forward(<span class="va" style="color: #111111;">self</span>, x):</span>
<span id="cb3-17">        lora <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.lora.A <span class="op" style="color: #5E5E5E;">@</span> <span class="va" style="color: #111111;">self</span>.lora.B</span>
<span id="cb3-18">        numerator <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.linear.weight <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">self</span>.lora.alpha<span class="op" style="color: #5E5E5E;">*</span>lora.T</span>
<span id="cb3-19">        denominator <span class="op" style="color: #5E5E5E;">=</span> numerator.norm(p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb3-20">        directional_component <span class="op" style="color: #5E5E5E;">=</span> numerator <span class="op" style="color: #5E5E5E;">/</span> denominator</span>
<span id="cb3-21">        new_weight <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.m <span class="op" style="color: #5E5E5E;">*</span> directional_component</span>
<span id="cb3-22">        <span class="cf" style="color: #003B4F;">return</span> F.linear(x, new_weight, <span class="va" style="color: #111111;">self</span>.linear.bias)</span></code></pre></div>
</div>
<p>I’ll also create a regular linear layer using one of the in/out feature values in the Raschka article:</p>
<div class="cell" data-outputid="5a631bc3-b6ef-49b4-c1df-1c32dab0254f" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">linear <span class="op" style="color: #5E5E5E;">=</span> nn.Linear(in_features<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">784</span>, out_features<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">128</span>, bias<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb4-2">linear</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Linear(in_features=784, out_features=128, bias=True)</code></pre>
</div>
</div>
<div class="cell" data-outputid="f7d1e34c-c79b-4135-e904-3d1cfa69f834" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">dora_layer <span class="op" style="color: #5E5E5E;">=</span> LinearWithDoRAMerged(linear, <span class="dv" style="color: #AD0000;">256</span>, <span class="dv" style="color: #AD0000;">512</span>)</span>
<span id="cb6-2">dora_layer</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>LinearWithDoRAMerged(
  (linear): Linear(in_features=784, out_features=128, bias=True)
  (lora): LoRALayer()
)</code></pre>
</div>
</div>
<p>Here’s the key value: the shape of the magnitude vector. In Raschka’s code, it’s 1 x 784, where 784 is the number of linear <code>in_features</code>.</p>
<div class="cell" data-outputid="6dd100d0-55e6-42bc-c49a-9d0eecf0d5a2" data-execution_count="11">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">dora_layer.m.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>torch.Size([1, 784])</code></pre>
</div>
</div>
<p>Looking at <code>LinearWithDoRAMerged.__init__</code>:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="va" style="color: #111111;">self</span>.m <span class="op" style="color: #5E5E5E;">=</span> nn.Parameter(</span>
<span id="cb10-2">            <span class="va" style="color: #111111;">self</span>.linear.weight.norm(p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>))</span></code></pre></div>
<p>The <code>norm</code> is taking over <code>dim=0</code>, which is the dimension of <code>out_features</code>:</p>
<div class="cell" data-outputid="c9bf9bab-831b-4c3a-ea4a-f0c54642b4a0" data-execution_count="13">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">linear.weight.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>torch.Size([128, 784])</code></pre>
</div>
</div>
<p>In other words, we end up with 1 magnitude value for each of the 784 input neurons.</p>
</section>
<section id="peft-implementation" class="level2">
<h2 class="anchored" data-anchor-id="peft-implementation"><code>peft</code> Implementation</h2>
<p>From <a href="https://github.com/huggingface/peft/blob/main/src/peft/tuners/lora/dora.py"><code>src/peft/tuners/lora/dora.py</code></a>:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;">class</span> DoraLinearLayer(nn.Module):</span>
<span id="cb13-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, fan_in_fan_out):</span>
<span id="cb13-3">        <span class="bu" style="color: null;">super</span>().<span class="fu" style="color: #4758AB;">__init__</span>()</span>
<span id="cb13-4">        <span class="va" style="color: #111111;">self</span>.fan_in_fan_out <span class="op" style="color: #5E5E5E;">=</span> fan_in_fan_out</span>
<span id="cb13-5"></span>
<span id="cb13-6">    <span class="kw" style="color: #003B4F;">def</span> get_weight_norm(<span class="va" style="color: #111111;">self</span>, weight, lora_weight, scaling) <span class="op" style="color: #5E5E5E;">-&gt;</span> torch.Tensor:</span>
<span id="cb13-7">        <span class="co" style="color: #5E5E5E;"># calculate L2 norm of weight matrix, column-wise</span></span>
<span id="cb13-8">        weight <span class="op" style="color: #5E5E5E;">=</span> transpose(weight, <span class="va" style="color: #111111;">self</span>.fan_in_fan_out)</span>
<span id="cb13-9">        weight <span class="op" style="color: #5E5E5E;">=</span> weight <span class="op" style="color: #5E5E5E;">+</span> scaling <span class="op" style="color: #5E5E5E;">*</span> lora_weight</span>
<span id="cb13-10">        weight_norm <span class="op" style="color: #5E5E5E;">=</span> torch.linalg.norm(weight, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>).to(weight.dtype)</span>
<span id="cb13-11">        <span class="cf" style="color: #003B4F;">return</span> weight_norm</span>
<span id="cb13-12"></span>
<span id="cb13-13">    ...</span></code></pre></div>
<p>The very important attribute here is <code>fan_in_fan_out</code>. I found a few places in the peft codebase which documented it as follows:</p>
<pre><code>Set this to True if the layer to replace stores weight like (fan_in, fan_out)</code></pre>
<ul>
<li><a href="https://github.com/huggingface/peft/blob/0facdebf6208139cbd8f3586875acb378813dd97/src/peft/tuners/ia3/config.py#L79">src/peft/tuners/ia3/config.py</a></li>
<li><a href="https://github.com/huggingface/peft/blob/0facdebf6208139cbd8f3586875acb378813dd97/src/peft/tuners/vblora/layer.py#L122">src/peft/tuners/vblora/layer.py</a></li>
<li><a href="https://github.com/huggingface/peft/blob/0facdebf6208139cbd8f3586875acb378813dd97/src/peft/tuners/vblora/layer.py#L122">src/peft/tuners/vblora/layer.py</a></li>
</ul>
<p>How I interpret this: if the weights are stored as (in, out), <code>fan_in_fan_out</code> is <code>True</code>, if stored as (out, in) <code>fan_in_fan_out</code> is <code>False</code>.</p>
<p>Looking at an example, I’ll peft-ify SmolLM2-135M:</p>
<div class="cell" data-outputid="f2fdc27d-3a29-4b72-9c84-ce1d79ea74d9" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">model_nm <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'HuggingFaceTB/SmolLM2-135M'</span></span>
<span id="cb15-2">model_nm</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>'HuggingFaceTB/SmolLM2-135M'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">model <span class="op" style="color: #5E5E5E;">=</span> transformers.AutoModelForSequenceClassification.from_pretrained(model_nm, num_labels<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">peft_config <span class="op" style="color: #5E5E5E;">=</span> LoraConfig(r<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>, use_rslora<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>, use_dora<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, target_modules<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'down_proj'</span>, <span class="st" style="color: #20794D;">'gate_proj'</span>, <span class="st" style="color: #20794D;">'k_proj'</span>, <span class="st" style="color: #20794D;">'o_proj'</span>, <span class="st" style="color: #20794D;">'q_proj'</span>, <span class="st" style="color: #20794D;">'up_proj'</span>, <span class="st" style="color: #20794D;">'v_proj'</span>])</span></code></pre></div>
</div>
<div class="cell" data-outputid="4166bf0b-8ce5-44df-bc5f-43ac8a7e4bc2" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">model <span class="op" style="color: #5E5E5E;">=</span> get_peft_model(model, peft_config)</span>
<span id="cb19-2">model.print_trainable_parameters()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>trainable params: 78,307,200 || all params: 212,823,360 || trainable%: 36.7945</code></pre>
</div>
</div>
<p>Looking at one of the layers which has a different number of input and output features, <code>k_proj</code>:</p>
<div class="cell" data-outputid="c9b363b2-1042-4507-e625-7065bdaa5d89" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">k_proj <span class="op" style="color: #5E5E5E;">=</span> model.base_model.model.model.layers[<span class="dv" style="color: #AD0000;">0</span>].self_attn.k_proj</span>
<span id="cb21-2">k_proj</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>lora.Linear(
  (base_layer): Linear(in_features=576, out_features=192, bias=False)
  (lora_dropout): ModuleDict(
    (default): Identity()
  )
  (lora_A): ModuleDict(
    (default): Linear(in_features=576, out_features=256, bias=False)
  )
  (lora_B): ModuleDict(
    (default): Linear(in_features=256, out_features=192, bias=False)
  )
  (lora_embedding_A): ParameterDict()
  (lora_embedding_B): ParameterDict()
  (lora_magnitude_vector): ModuleDict(
    (default): lora.dora.DoraLinearLayer()
  )
)</code></pre>
</div>
</div>
<p>The base layer has 576 <code>in_features</code> and 192 <code>out_features</code>:</p>
<div class="cell" data-outputid="937ded35-e1fd-4b5c-d98b-4a4781871a2d" data-execution_count="22">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">k_proj.base_layer.weight.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>torch.Size([192, 576])</code></pre>
</div>
</div>
<p>The <code>fan_in_fan_out</code> attribute is <code>False</code> which checks out by looking at the shape above which is (out, in).</p>
<div class="cell" data-outputid="a2b509cf-8cba-425d-95ae-d29baf2d806c" data-execution_count="24">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">k_proj.fan_in_fan_out</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>False</code></pre>
</div>
</div>
<p>Why is <code>fan_in_fan_out</code> such a big deal to me? Well, because look at how <code>get_weight_norm</code> is written:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;">def</span> get_weight_norm(<span class="va" style="color: #111111;">self</span>, weight, lora_weight, scaling) <span class="op" style="color: #5E5E5E;">-&gt;</span> torch.Tensor:</span>
<span id="cb27-2">    <span class="co" style="color: #5E5E5E;"># calculate L2 norm of weight matrix, column-wise</span></span>
<span id="cb27-3">    weight <span class="op" style="color: #5E5E5E;">=</span> transpose(weight, <span class="va" style="color: #111111;">self</span>.fan_in_fan_out)</span>
<span id="cb27-4">    weight <span class="op" style="color: #5E5E5E;">=</span> weight <span class="op" style="color: #5E5E5E;">+</span> scaling <span class="op" style="color: #5E5E5E;">*</span> lora_weight</span>
<span id="cb27-5">    weight_norm <span class="op" style="color: #5E5E5E;">=</span> torch.linalg.norm(weight, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>).to(weight.dtype)</span>
<span id="cb27-6">    <span class="cf" style="color: #003B4F;">return</span> weight_norm</span></code></pre></div>
<p>I’ll walk through each line, starting with the base layers weight matrix:</p>
<div class="cell" data-outputid="b473b742-2715-4f33-d00b-259cf0805815" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">weight <span class="op" style="color: #5E5E5E;">=</span> k_proj.base_layer.weight</span>
<span id="cb28-2">weight.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>torch.Size([192, 576])</code></pre>
</div>
</div>
<p>We then pass the weight and <code>fan_in_fan_out</code> to <code>transpose</code>:</p>
<div class="cell" data-outputid="d762eab8-6ab5-4627-c458-26759b37999c" data-execution_count="26">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">weight <span class="op" style="color: #5E5E5E;">=</span> transpose(weight, k_proj.fan_in_fan_out)</span>
<span id="cb30-2">weight.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>torch.Size([192, 576])</code></pre>
</div>
</div>
<p>It doesn’t transpose it! That’s because <a href="https://github.com/huggingface/peft/blob/0facdebf6208139cbd8f3586875acb378813dd97/src/peft/utils/other.py#L559">in <code>tranpose</code></a> if <code>fan_in_fan_out</code> is <code>False</code> it returns the <code>weight</code> as is:</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="kw" style="color: #003B4F;">def</span> transpose(weight, fan_in_fan_out):</span>
<span id="cb32-2">    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> fan_in_fan_out:</span>
<span id="cb32-3">        <span class="cf" style="color: #003B4F;">return</span> weight</span>
<span id="cb32-4"></span>
<span id="cb32-5">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(weight, torch.nn.Parameter):</span>
<span id="cb32-6">        <span class="cf" style="color: #003B4F;">return</span> torch.nn.Parameter(weight.T)</span>
<span id="cb32-7">    <span class="cf" style="color: #003B4F;">return</span> weight.T</span></code></pre></div>
<p>This is absolutely critical in determining the shape of the magnitude vector:</p>
<div class="cell" data-outputid="769830c0-55ff-49cd-85bc-399aa864a4f9" data-execution_count="27">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">weight_norm <span class="op" style="color: #5E5E5E;">=</span> torch.linalg.norm(weight, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>).to(weight.dtype)</span>
<span id="cb33-2">weight_norm.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>torch.Size([192])</code></pre>
</div>
</div>
<p>Note two things here: - they take the <code>norm</code> across <code>dim=1</code> (the number of <code>in_features</code>) - we end up with 1 magnitude value for each of the 192 <em>output</em> neurons. Contrast this with Raschka’s article where we had 1 magnitude value for each of the <em>input</em> neurons.</p>
</section>
<section id="aside-claude-conversation" class="level2">
<h2 class="anchored" data-anchor-id="aside-claude-conversation">Aside: Claude Conversation</h2>
<p>While I was re-reading the DoRA paper, I found the emphasis on <em>column-wise</em> vector norm interesting so I asked Claude about it:</p>
<blockquote class="blockquote">
<p><strong>Prompt</strong>: Why columns? What is special about doing this for columns and not rows. Is there something fundamental about columns in a matrix of pretrained weights?</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Response</strong>: For neural networks, columns of weight matrices map features from one layer’s dimension to another’s. Each column represents all the connections to a single output neuron. So columns form natural functional units, making column-wise normalization more meaningful than row-wise for understanding and modifying the network’s learned transformations.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Prompt</strong>: So suppose we have an input vector <code>x</code> which contains values corresponding to each input variable, the pretrained weight matrix would is d x k so <code>x</code> would be 1 x d.&nbsp;Each row in pretrained weight matrix would represent one input variable. Multiplying 1 x d with d x k gives us 1 x k where k is the number of activations (i.e.&nbsp;the number of neurons).</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Response</strong>: Yes, that’s correct. The output for a single neuron (one column of the weight matrix) is the dot product between the input vector and that column’s weights. So when we do column-wise normalization, we’re normalizing the set of weights that feed into each individual output neuron. This helps explain why column-wise normalization is natural - each column represents a complete “unit” in terms of how the network processes information to produce one output activation.</p>
</blockquote>
<p>So, it seems like decomposing the weight matrix into a magnitude vector and direction matrix <em>corresponding to output neurons</em> seems really important.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Explorations like this is why I’m grateful for open source code. The efforts of folks like HuggingFace and Raschka to democratize LLMs allows folks like me to curate insightful explorations for myself, and I’m obviously happy to share them out in this blog post. If you find something incorrect in my interpretation of Raschka’s or peft’s code, please at me on Twitter <span class="citation" data-cites="vishal_learner">@vishal_learner</span>.</p>
<p>A future exercise that I want to do: train DoRA implementations with a column-wise norm and a row-wise norm and compare results. This would truly highlight whether it’s important to align the decomposition with the output neurons of the weight matrix.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>deep learning</category>
  <category>machine learning</category>
  <category>LLM</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2025-02-01-DoRA-Magnitude-Vector/index.html</guid>
  <pubDate>Sat, 01 Feb 2025 08:00:00 GMT</pubDate>
</item>
<item>
  <title>Recreating the PLAID ColBERTv2 Scoring Pipeline: From Research Code to RAGatouille</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/index.html</link>
  <description><![CDATA[ 



<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install RAGatouille <span class="op" style="color: #5E5E5E;">-</span>qq</span></code></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb2-2"><span class="im" style="color: #00769E;">import</span> colbert</span>
<span id="cb2-3"><span class="im" style="color: #00769E;">from</span> fastcore.utils <span class="im" style="color: #00769E;">import</span> Path</span>
<span id="cb2-4"><span class="im" style="color: #00769E;">import</span> json</span>
<span id="cb2-5"><span class="im" style="color: #00769E;">import</span> torch</span></code></pre></div>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>This walkthrough reconstructs the PLAID scoring pipeline by tracing code paths in the <a href="https://github.com/stanford-futuredata/ColBERT">ColBERT research codebase</a> that reproduce RAGatouille’s verified results. This is a reverse engineering process - I pulled at promising threads (code related to centroids, passage IDs, and scores) and validated my understanding by comparing against RAGatouille’s known-correct outputs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" title="4-Stage PLAID Scoring Pipeline" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">4-Stage PLAID Scoring Pipeline</figcaption><p></p>
</figure>
</div>
<p>Here’s my video walkthrough of the code in this notebook:</p>
<div class="quarto-video ratio ratio-16x9"><iframe src="https://www.youtube.com/embed/XRPP5LHHk0o" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="ragatouille-results" class="level2">
<h2 class="anchored" data-anchor-id="ragatouille-results">RAGatouille Results</h2>
<p>In this notebook, the gold truth scores for the documents given a query are determined by the RAGatouille library. I create a query (<em>What is Python?</em>) and a simple set of documents where one document is the obvious right answer (<em>Python is a programming language. It is easy to learn</em>) , one is a hard negative in that it’s about Python (<em>Python was created by Guido van Rossum in 1991</em>) and one is a easier negative as it’s related to the programming but not about Python (<em>Java is a popular coding language used in many applications</em>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(<span class="st" style="color: #20794D;">"colbert-ir/colbertv2.0"</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="89b586b3-11b0-4cae-8e03-54496bf75f35" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">q <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"What is Python?"</span></span>
<span id="cb4-2">q</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>'What is Python?'</code></pre>
</div>
</div>
<div class="cell" data-outputid="5e61a859-1291-48d1-e3cb-430ec494cdf7" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">documents <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb6-2">    <span class="st" style="color: #20794D;">"Python is a programming language. It is easy to learn"</span>,</span>
<span id="cb6-3">    <span class="st" style="color: #20794D;">"Java is a popular coding language used in many applications"</span>,</span>
<span id="cb6-4">    <span class="st" style="color: #20794D;">"Python was created by Guido van Rossum in 1991"</span></span>
<span id="cb6-5">]</span>
<span id="cb6-6">documents</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>['Python is a programming language. It is easy to learn',
 'Java is a popular coding language used in many applications',
 'Python was created by Guido van Rossum in 1991']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(index_name<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"toy_example"</span>, collection<span class="op" style="color: #5E5E5E;">=</span>documents)</span></code></pre></div>
</div>
<div class="cell" data-outputid="14b79968-f1f3-4da6-801c-631016f860b3" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">index_path</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>'.ragatouille/colbert/indexes/toy_example'</code></pre>
</div>
</div>
<div class="cell" data-outputid="9e40747b-0e07-4e78-abe4-d3dc5f3d94ff" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">results <span class="op" style="color: #5E5E5E;">=</span> RAG.search(q)</span>
<span id="cb11-2">results</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: k value is larger than the number of documents in the index! Lowering k to 3...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>[{'content': 'Python is a programming language. It is easy to learn',
  'score': 27.6875,
  'rank': 1,
  'document_id': '8aa5aade-10d5-4144-b634-c7866578b43c',
  'passage_id': 0},
 {'content': 'Python was created by Guido van Rossum in 1991',
  'score': 22.28125,
  'rank': 2,
  'document_id': '12352328-9bb1-4a51-896e-a002d3548adc',
  'passage_id': 2},
 {'content': 'Java is a popular coding language used in many applications',
  'score': 13.953125,
  'rank': 3,
  'document_id': '1fe9788e-ccec-4b9e-a004-14acc657915e',
  'passage_id': 1}]</code></pre>
</div>
</div>
<p>Note the <code>score</code> and <code>passage_id</code>—these are values I’ll continuously reference throughout my walkthrough:</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>passage_id</code></th>
<th style="text-align: center;"><code>score</code></th>
<th style="text-align: center;">passage text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">27.6875</td>
<td style="text-align: center;">“Python is a programming language. It is easy to learn”</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">22.28125</td>
<td style="text-align: center;">“Python was created by Guido van Rossum in 1991”</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">13.953125</td>
<td style="text-align: center;">“Java is a popular coding language used in many applications”</td>
</tr>
</tbody>
</table>
</section>
<section id="where-to-start" class="level2">
<h2 class="anchored" data-anchor-id="where-to-start">Where to Start?</h2>
<p>Starting at the top—the model in play: of type <code>ColBERT</code></p>
<div class="cell" data-outputid="a569389d-4ae5-45fe-e11d-3e4c9c340d81" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">m <span class="op" style="color: #5E5E5E;">=</span> RAG.model</span>
<span id="cb14-2">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>&lt;ragatouille.models.colbert.ColBERT at 0x7d0a4cc14670&gt;</code></pre>
</div>
</div>
<p>And its index—of type <code>PLAIDModelIndex</code>.</p>
<div class="cell" data-outputid="07afbe51-fa27-4156-e6c5-a4a01e73de0c" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">index <span class="op" style="color: #5E5E5E;">=</span> m.model_index</span>
<span id="cb16-2">index</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;ragatouille.models.index.PLAIDModelIndex at 0x7d0bd8bb7e80&gt;</code></pre>
</div>
</div>
<p>Inside the source code for <a href="https://github.com/AnswerDotAI/RAGatouille/blob/8183aad64a9a6ba805d4066dcab489d97615d316/ragatouille/models/index.py#L284"><code>PLAIDModelIndex</code></a> the most promising method seemed be the <code>_search</code> method, which contains the following line:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span>.searcher.search(query, k<span class="op" style="color: #5E5E5E;">=</span>k, pids<span class="op" style="color: #5E5E5E;">=</span>pids)</span></code></pre></div>
<p>This contained three things I recognized: the <code>query</code>, the top <code>k</code> value and the passage IDs <code>pids</code>.</p>
<div class="cell" data-outputid="737f4016-6a3e-49a7-ee28-ccfd19dd095e" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">index.searcher</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;colbert.searcher.Searcher at 0x7d0a4cdc6530&gt;</code></pre>
</div>
</div>
</section>
<section id="the-searcher-class" class="level2">
<h2 class="anchored" data-anchor-id="the-searcher-class">The <code>Searcher</code> Class</h2>
<p>I couldn’t find the <code>Searcher</code> in RAGAtouille’s codebase as it was imported from <code>colbert</code>. Thankfully, installing RAGatouille gives you access to this library!</p>
<div class="cell" data-outputid="6abf22d1-2cb2-4a49-a70a-0121cac86de5" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">colbert.Searcher</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.searcher.Searcher</b><br>def __init__(index, checkpoint=None, collection=None, config=None, index_root=None, verbose: int=3)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/searcher.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 22);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<p>The <code>Searcher</code> takes as a required argument an <code>index</code> path—which we have!</p>
<div class="cell" data-outputid="56727311-62b7-45d7-a5bb-58e710870a54" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">searcher <span class="op" style="color: #5E5E5E;">=</span> colbert.Searcher(index<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'toy_example'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Dec 24, 15:59:52] #&gt; Loading codec...
[Dec 24, 15:59:52] #&gt; Loading IVF...
[Dec 24, 15:59:52] #&gt; Loading doclens...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1/1 [00:00&lt;00:00, 4315.13it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Dec 24, 15:59:52] #&gt; Loading codes and residuals...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
100%|██████████| 1/1 [00:00&lt;00:00, 454.67it/s]</code></pre>
</div>
</div>
<p>Notice that it loads the <code>codec</code>, <code>IVF</code> and <code>doclens</code>, all things we’ll look at throughout this notebook. Looking inside the <code>Searcher.search</code> method (which was called in the <code>PLAIDModelIndex._search</code> method) <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/searcher.py#L65">I see the following</a>:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;">def</span> search(<span class="va" style="color: #111111;">self</span>, text: <span class="bu" style="color: null;">str</span>, k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>, filter_fn<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>, full_length_search<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>, pids<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb27-2">    Q <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.encode(text, full_length_search<span class="op" style="color: #5E5E5E;">=</span>full_length_search)</span>
<span id="cb27-3">    <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">self</span>.dense_search(Q, k, filter_fn<span class="op" style="color: #5E5E5E;">=</span>filter_fn, pids<span class="op" style="color: #5E5E5E;">=</span>pids)</span></code></pre></div>
<p>This is encoding the <code>text</code> into <code>Q</code>. Looks promising. I’ll see what that gets me:</p>
<div class="cell" data-outputid="5877b31f-6555-45e1-c697-e47c726a989a" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">Q <span class="op" style="color: #5E5E5E;">=</span> searcher.encode(q)</span>
<span id="cb28-2">Q.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>torch.Size([1, 32, 128])</code></pre>
</div>
</div>
<p>Looks good! It has 32 tokens, each with a 128-dimension encoding.</p>
<p><code>Searcher.search</code> returns the output of <code>Searcher.dense_search</code>, and the <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/searcher.py#L106"><code>Searcher.dense_search</code></a> method looks <em>very</em> promising. It takes queries <code>Q</code> and passages IDs and returns passage IDs and <code>scores</code>.</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">pids, scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.ranker.rank(<span class="va" style="color: #111111;">self</span>.config, Q, filter_fn<span class="op" style="color: #5E5E5E;">=</span>filter_fn, pids<span class="op" style="color: #5E5E5E;">=</span>pids)</span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="cf" style="color: #003B4F;">return</span> pids[:k], <span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">1</span>, k<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)), scores[:k]</span></code></pre></div>
<div class="cell" data-outputid="5dd61d17-137b-40e7-bb37-7fde4118079c" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">searcher.dense_search</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.searcher.Searcher.dense_search</b><br>def dense_search(Q: torch.Tensor, k=10, filter_fn=None, pids=None)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/searcher.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 106);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<div class="cell" data-outputid="abd2a719-2384-47ff-b1e6-0aaa88182c91" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">searcher.dense_search(Q)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>([0], [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], [27.6875])</code></pre>
</div>
</div>
<p>Excellent!! The first value is <code>pids[:k]</code>, which I understand to be the passage IDs corresponding to the top-k results. In this case it’s just 1 passage ID, <code>0</code>, the first passage (<em>“Python is a programming language. It is easy to learn”</em>). The second value is <code>list(range(1,k+1))</code> which is just a list from 1 to <code>k</code>. The final value is <code>scores[:k]</code> which is score corresponding to the top-k values. In this case it’s just one score, but an important one in our journey, as it is the same as RAGatouille for this passage (27.6875) !</p>
<div class="cell" data-outputid="a003d766-cd30-4fbd-c15d-cec4b6b73fee" data-execution_count="19">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">results[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>{'content': 'Python is a programming language. It is easy to learn',
 'score': 27.6875,
 'rank': 1,
 'document_id': '8aa5aade-10d5-4144-b634-c7866578b43c',
 'passage_id': 0}</code></pre>
</div>
</div>
<p>This is incredibly exciting, but I’m only getting 1 score instead of 3. Looking more closely at <code>dense_search</code> I see that the value of <code>k</code> determines the value of <code>config.ncells</code>:</p>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="cf" style="color: #003B4F;">if</span> k <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span>:</span>
<span id="cb36-2">    <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.config.ncells <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb36-3">        <span class="va" style="color: #111111;">self</span>.configure(ncells<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb36-4">    <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.config.centroid_score_threshold <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb36-5">        <span class="va" style="color: #111111;">self</span>.configure(centroid_score_threshold<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.5</span>)</span>
<span id="cb36-6">    <span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.config.ndocs <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb36-7">        <span class="va" style="color: #111111;">self</span>.configure(ndocs<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">256</span>)</span></code></pre></div>
<p>Afterwhich <code>dense_search</code> calls:</p>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">pids, scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.ranker.rank(<span class="va" style="color: #111111;">self</span>.config, Q, filter_fn<span class="op" style="color: #5E5E5E;">=</span>filter_fn, pids<span class="op" style="color: #5E5E5E;">=</span>pids)</span></code></pre></div>
<p>I’ll look at <code>Searcher.ranker.rank</code> next.</p>
</section>
<section id="searcher.ranker.rank" class="level2">
<h2 class="anchored" data-anchor-id="searcher.ranker.rank"><code>Searcher.ranker.rank</code></h2>
<div class="cell" data-outputid="2aeba55e-d7d8-4d4e-8f0e-2b38acdfb5b6" data-execution_count="20">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">searcher.ranker.rank</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.search.index_storage.IndexScorer.rank</b><br>def rank(config, Q, filter_fn=None, pids=None)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/search/index_storage.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 87);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<p>The first parameter, <code>config</code>, <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/searcher.py#L37">is found in the <code>Searcher</code></a>:</p>
<div class="cell" data-outputid="85a314f5-4d5a-4574-8269-d0cca718cf75" data-execution_count="21">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">searcher.config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=1, centroid_score_threshold=0.5, ndocs=256, load_index_with_mmap=False, index_path=None, index_bsize=32, nbits=4, kmeans_niters=20, resume=False, similarity='cosine', bsize=64, accumsteps=1, lr=1e-05, maxsteps=400000, save_every=None, warmup=20000, warmup_bert=None, relu=False, nway=64, use_ib_negatives=True, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name=None, query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=128, doc_maxlen=256, mask_punctuation=True, checkpoint='colbert-ir/colbertv2.0', triples='/future/u/okhattab/root/unit/experiments/2021.10/downstream.distillation.round2.2_score/round2.nway6.cosine.ib/examples.64.json', collection=&lt;colbert.data.collection.Collection object at 0x7d0a4cc052d0&gt;, queries='/future/u/okhattab/data/MSMARCO/queries.train.tsv', index_name='toy_example', overwrite=False, root='.ragatouille/', experiment='colbert', index_root=None, name='2024-12/24/15.52.48', rank=0, nranks=1, amp=True, gpus=1, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<p><code>ncells</code> is <code>1</code>.</p>
<div class="cell" data-outputid="7ed5b79f-e2fa-4aba-d22a-d8e90f6e91ea" data-execution_count="22">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">searcher.config.ncells</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>1</code></pre>
</div>
</div>
<p>From my previous amblings through the codebase, and which will see later on, I learned that <code>ncells</code> is synonymous with the <img src="https://latex.codecogs.com/png.latex?n_%7Bprobe%7D"> parameter in the ColBERTv2 and PLAID ColBERTv2 papers (i.e.&nbsp;the number of centroids closest to each query token). In the papers they use values of 1, 4, and 8. I’ll pick a value of <code>4</code>.</p>
<div class="cell" data-outputid="607b13a5-da93-48ea-d9a0-40885ff730d3" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">searcher.config.configure(ncells<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb43-2">searcher.config.ncells</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>4</code></pre>
</div>
</div>
<p>I’ll now pass <code>config</code> to <code>Searcher.ranker.rank</code> along with my encoded query <code>Q</code>:</p>
<div class="cell" data-outputid="5fde9ef4-3ae5-4553-ad55-4180a9857c55" data-execution_count="24">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">searcher.ranker.rank(config<span class="op" style="color: #5E5E5E;">=</span>searcher.config, Q<span class="op" style="color: #5E5E5E;">=</span>Q)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>([0, 2, 1], [27.6875, 22.28125, 13.953125])</code></pre>
</div>
</div>
<p>Major success!! I now see three passage IDs and their corresponding scores, an exact match with RAGatouille’s results.</p>
<div class="cell" data-outputid="d8e74f8d-3f01-4cd0-aedc-bca25c620d83" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">results</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>[{'content': 'Python is a programming language. It is easy to learn',
  'score': 27.6875,
  'rank': 1,
  'document_id': '8aa5aade-10d5-4144-b634-c7866578b43c',
  'passage_id': 0},
 {'content': 'Python was created by Guido van Rossum in 1991',
  'score': 22.28125,
  'rank': 2,
  'document_id': '12352328-9bb1-4a51-896e-a002d3548adc',
  'passage_id': 2},
 {'content': 'Java is a popular coding language used in many applications',
  'score': 13.953125,
  'rank': 3,
  'document_id': '1fe9788e-ccec-4b9e-a004-14acc657915e',
  'passage_id': 1}]</code></pre>
</div>
</div>
<p>At this point I felt confident in the threads I was pulling and could now dig deeper and start recreating each stage of the PLAID scoring pipeline, starting with Stage 1.</p>
</section>
<section id="stage-1-initial-candidate-generation" class="level2">
<h2 class="anchored" data-anchor-id="stage-1-initial-candidate-generation">Stage 1: Initial Candidate Generation</h2>
<p>In Stage 1, we retrieve the passage IDs corresponding to the <code>ncells</code> centroid IDs neareest to each of the query tokens. I have set <code>ncells</code> to 4 and have 32 query tokens so we’re dealing with a maximum of 4 x 32 = 128 centroid IDs.</p>
<p>The first promising line in <code>Searcher.ranker.rank</code> is <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/search/index_storage.py#L90">the call to <code>retrieve</code></a>:</p>
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="cf" style="color: #003B4F;">if</span> pids <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb49-2">    pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.retrieve(config, Q)</span></code></pre></div>
<section id="searcher.ranker.retrieve" class="level3">
<h3 class="anchored" data-anchor-id="searcher.ranker.retrieve"><code>Searcher.ranker.retrieve</code></h3>
<div class="cell" data-outputid="68dbbf65-0afc-4456-de7e-481aa0e4faae" data-execution_count="26">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">searcher.ranker.retrieve</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.search.index_storage.IndexScorer.retrieve</b><br>def retrieve(config, Q)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/search/index_storage.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 77);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<div class="cell" data-outputid="48688f7e-6996-4f2c-e991-be956644b074" data-execution_count="27">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.retrieve(searcher.config, Q)</span>
<span id="cb51-2">pids, centroid_scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(tensor([0, 1, 2], device='cuda:0', dtype=torch.int32), torch.Size([64, 32]))</code></pre>
</div>
</div>
<p>This is where I start to get really excited. I’m seeing abstract concepts in a research paper come to life! <code>pids</code> is now familiar—the three indexes <code>0</code>, <code>1</code>, and <code>2</code>. What’s more interesting is <code>centroid_scores</code> which has 64 rows and 32 columns. We know from the PLAID paper that the MaxSim scores between centroids and query tokens is matrix with number of rows being the number of centroids and the number of columns being the number of tokens.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="2.png" class="lightbox" title="Section 4.1 from the PLAID ColBERTv2 Paper" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/2.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Section 4.1 from the PLAID ColBERTv2 Paper</figcaption><p></p>
</figure>
</div>
<p>Looking <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/search/index_storage.py#L77">inside of <code>Searcher.ranker.retrieve</code></a> we see that it calls <code>Searcher.ranker.generate_candidates</code>:</p>
<div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.generate_candidates(config, Q)</span></code></pre></div>
</section>
<section id="generate_candidates" class="level3">
<h3 class="anchored" data-anchor-id="generate_candidates"><code>generate_candidates</code></h3>
<div class="cell" data-outputid="95fba38b-fef8-4847-b8b3-94a3b47abccb" data-execution_count="28">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">searcher.ranker.generate_candidates</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.search.candidate_generation.CandidateGeneration.generate_candidates</b><br>def generate_candidates(config, Q)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/search/candidate_generation.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 45);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<p>This will only be a brief pit stop. There are three lines of interest:</p>
<div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">Q <span class="op" style="color: #5E5E5E;">=</span> Q.squeeze(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb55-2">Q <span class="op" style="color: #5E5E5E;">=</span> Q.cuda().half()</span>
<span id="cb55-3"></span>
<span id="cb55-4">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.generate_candidate_pids(Q, ncells)</span></code></pre></div>
<div class="cell" data-outputid="0418b741-08b0-45ba-8cc4-984c312cd429" data-execution_count="29">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">Q <span class="op" style="color: #5E5E5E;">=</span> Q.squeeze(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb56-2">Q.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>torch.Size([32, 128])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">Q <span class="op" style="color: #5E5E5E;">=</span> Q.cuda().half()</span></code></pre></div>
</div>
<div class="cell" data-outputid="2ef50c3e-9288-449e-a656-836d4361d88c" data-execution_count="31">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">searcher.ranker.generate_candidates</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.search.candidate_generation.CandidateGeneration.generate_candidates</b><br>def generate_candidates(config, Q)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/search/candidate_generation.py&lt;no docstring&gt;</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 45);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<div class="cell" data-outputid="f333e2c3-12b7-4ae9-885d-3af5c98dde09" data-execution_count="32">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">cells, scores <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.generate_candidates(searcher.config, Q)</span>
<span id="cb60-2">cells.shape, scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(torch.Size([3]), torch.Size([64, 32]))</code></pre>
</div>
</div>
<p>There’s that 64 x 32 shape again.</p>
<div class="cell" data-outputid="09e75872-fded-4321-e776-ac1c3e172bae" data-execution_count="33">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">cells</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>tensor([0, 1, 2], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<p>I’m not entirely sure what <code>cells</code> is (I’m tempted to say it’s our passage IDs based on the values). Let’s look at <code>get_candidate_pids</code> first:</p>
</section>
<section id="generate_candidate_pids" class="level3">
<h3 class="anchored" data-anchor-id="generate_candidate_pids"><code>generate_candidate_pids</code></h3>
<p>Another quick stop, we see the following two very interesting line:</p>
<div class="sourceCode" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">cells, scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.get_cells(Q, ncells)</span>
<span id="cb64-2"></span>
<span id="cb64-3">pids, cell_lengths <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.ivf.lookup(cells)</span></code></pre></div>
<p>From reading the paper, I know that in Stage 1 we get the centroid IDs that are close to the query tokens, which I think is what <code>get_cells</code> does. I also know that the PLAID index stores a mapping between passage IDs and centroid IDs, which is what I think <code>ivf.lookup</code> is looking up!</p>
</section>
<section id="get_cells" class="level3">
<h3 class="anchored" data-anchor-id="get_cells"><code>get_cells</code></h3>
<div class="sourceCode" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="kw" style="color: #003B4F;">def</span> get_cells(<span class="va" style="color: #111111;">self</span>, Q, ncells):</span>
<span id="cb65-2">    scores <span class="op" style="color: #5E5E5E;">=</span> (<span class="va" style="color: #111111;">self</span>.codec.centroids <span class="op" style="color: #5E5E5E;">@</span> Q.T)</span>
<span id="cb65-3">    <span class="cf" style="color: #003B4F;">if</span> ncells <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb65-4">        cells <span class="op" style="color: #5E5E5E;">=</span> scores.argmax(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>).permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb65-5">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb65-6">        cells <span class="op" style="color: #5E5E5E;">=</span> scores.topk(ncells, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, <span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>).indices.permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>)  <span class="co" style="color: #5E5E5E;"># (32, ncells)</span></span>
<span id="cb65-7">    cells <span class="op" style="color: #5E5E5E;">=</span> cells.flatten().contiguous()  <span class="co" style="color: #5E5E5E;"># (32 * ncells,)</span></span>
<span id="cb65-8">    cells <span class="op" style="color: #5E5E5E;">=</span> cells.unique(<span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb65-9">    <span class="cf" style="color: #003B4F;">return</span> cells, scores</span></code></pre></div>
<p>The first line is critical: <code>self.codec.centroids @ Q.T</code> is almost verbatim the matrix multiplication formula in the paper. This confirms that the 64 x 32 shape of <code>scores</code> is number of centroids x number of query tokens!</p>
<div class="cell" data-outputid="001e0d17-a842-48fa-f583-866aac965eea" data-execution_count="34">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1">searcher.ranker.codec.centroids.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>torch.Size([64, 128])</code></pre>
</div>
</div>
<p>There are indeed 64 centroids, each of them with 128 dimensions. So cool to see!!</p>
<div class="cell" data-outputid="e6692878-b07b-4c2f-863c-569c90ad2d50" data-execution_count="35">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">_scores <span class="op" style="color: #5E5E5E;">=</span> (searcher.ranker.codec.centroids <span class="op" style="color: #5E5E5E;">@</span> Q.T)</span>
<span id="cb68-2">_scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>torch.Size([64, 32])</code></pre>
</div>
</div>
<div class="cell" data-outputid="a724de6c-e23d-4609-fc1a-f1ab9010ab6b" data-execution_count="36">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">(scores <span class="op" style="color: #5E5E5E;">==</span> _scores).<span class="bu" style="color: null;">float</span>().mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>tensor(1., device='cuda:0')</code></pre>
</div>
</div>
<p>The next line of interest is:</p>
<div class="sourceCode" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">cells <span class="op" style="color: #5E5E5E;">=</span> scores.topk(ncells, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, <span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>).indices.permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>)  <span class="co" style="color: #5E5E5E;"># (32, ncells)</span></span></code></pre></div>
<div class="cell" data-outputid="3894ec15-d048-4d18-81a2-3e72a7028a14" data-execution_count="37">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1">scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>torch.Size([64, 32])</code></pre>
</div>
</div>
<div class="cell" data-outputid="c0ea0697-8c08-4dcd-fe54-b63d4c460e64" data-execution_count="38">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1">scores</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>tensor([[ 0.0879,  0.0498,  0.0136,  ...,  0.0586,  0.0564,  0.0699],
        [ 0.0798, -0.0043,  0.0223,  ..., -0.0271, -0.0166, -0.0172],
        [ 0.2053,  0.0300,  0.1144,  ...,  0.0100,  0.0226,  0.0177],
        ...,
        [ 0.4587,  0.9458,  0.1954,  ...,  0.9507,  0.9482,  0.9482],
        [ 0.0000,  0.0000,  0.0000,  ...,  0.0000,  0.0000,  0.0000],
        [ 0.0000,  0.0000,  0.0000,  ...,  0.0000,  0.0000,  0.0000]],
       device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p><code>scores.topk</code> seems to return the scores corresponding to the top-4 cosine similarities (between centroids and query tokens) for each token.</p>
<div class="cell" data-outputid="7f5c02f1-2af0-4466-c5df-dd08277d50c0" data-execution_count="39">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1">scores.topk(<span class="dv" style="color: #AD0000;">4</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, <span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>).values</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>tensor([[0.5786, 0.9521, 0.7397, 0.7510, 0.9395, 0.5850, 0.5859, 0.9131, 0.6782,
         0.5186, 0.6353, 0.7104, 0.9209, 0.9014, 0.9443, 0.9473, 0.9434, 0.9497,
         0.9468, 0.9331, 0.9355, 0.9233, 0.9370, 0.9336, 0.7026, 0.9468, 0.9131,
         0.7529, 0.9517, 0.9482, 0.9448, 0.9429],
        [0.5361, 0.8901, 0.6255, 0.6245, 0.9097, 0.5220, 0.7354, 0.8682, 0.6260,
         0.4663, 0.5654, 0.6030, 0.8486, 0.8306, 0.9429, 0.8979, 0.8950, 0.8960,
         0.8965, 0.8799, 0.8892, 0.8770, 0.8794, 0.8774, 0.5869, 0.8921, 0.8418,
         0.6328, 0.8931, 0.9009, 0.8970, 0.8994],
        [0.7129, 0.9458, 0.4612, 0.4766, 0.9658, 0.4229, 0.5332, 0.9219, 0.7002,
         0.4092, 0.4729, 0.5034, 0.9111, 0.8955, 0.8872, 0.9487, 0.9458, 0.9497,
         0.9492, 0.9375, 0.9419, 0.9312, 0.9380, 0.9365, 0.4958, 0.9453, 0.9048,
         0.4829, 0.9482, 0.9507, 0.9482, 0.9482],
        [0.4753, 0.8882, 0.3442, 0.3616, 0.8799, 0.3958, 0.5195, 0.8589, 0.6108,
         0.4077, 0.4324, 0.4333, 0.8438, 0.8281, 0.8872, 0.8945, 0.8901, 0.8955,
         0.8926, 0.8745, 0.8813, 0.8687, 0.8774, 0.8745, 0.4360, 0.8911, 0.8394,
         0.3711, 0.8911, 0.8955, 0.8911, 0.8916]], device='cuda:0',
       dtype=torch.float16)</code></pre>
</div>
</div>
<p>The first value, <code>0.5786</code> represents the cosine similarity (dot product) between a centroid and the first query token.</p>
<div class="cell" data-outputid="48eeef66-91b6-4242-dee7-f6108e7acd93" data-execution_count="40">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">cells <span class="op" style="color: #5E5E5E;">=</span> scores.topk(<span class="dv" style="color: #AD0000;">4</span>, dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, <span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>).indices.permute(<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb79-2">cells.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>torch.Size([32, 4])</code></pre>
</div>
</div>
<p>The following line flattens out the 32 x 4 matrix into a 128-value 1D tensor.</p>
<div class="cell" data-outputid="7f891a56-005a-4266-efab-077890ecf51c" data-execution_count="41">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">cells <span class="op" style="color: #5E5E5E;">=</span> cells.flatten().contiguous()  <span class="co" style="color: #5E5E5E;"># (32 * ncells,)</span></span>
<span id="cb81-2">cells.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>torch.Size([128])</code></pre>
</div>
</div>
<p>The following gets the unique centroid IDs. In this case there are 10 unique centroids that give the top-4 cosine similarity with all 32 tokens.</p>
<div class="cell" data-outputid="b58ea42b-8e86-4b90-9b5a-f0575f063cca" data-execution_count="42">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1">cells <span class="op" style="color: #5E5E5E;">=</span> cells.unique(<span class="bu" style="color: null;">sorted</span><span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb83-2">cells.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>torch.Size([10])</code></pre>
</div>
</div>
<div class="cell" data-outputid="e2f9020b-881b-4884-e315-c923918daca5" data-execution_count="43">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">cells</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>tensor([ 7,  8, 14, 19, 24, 29, 31, 38, 41, 61], device='cuda:0')</code></pre>
</div>
</div>
<p>Confirming that we can recreate the cosine similarity (0.5768) betweeen the first centroid (with ID = 7) and the first query token:</p>
<div class="cell" data-outputid="6d4924ca-6e71-4936-b6b8-14254db44352" data-execution_count="44">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">(searcher.ranker.codec.centroids[<span class="dv" style="color: #AD0000;">7</span>] <span class="op" style="color: #5E5E5E;">*</span> Q[<span class="dv" style="color: #AD0000;">0</span>].T).<span class="bu" style="color: null;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>UserWarning: The use of `x.T` on tensors of dimension other than 2 to reverse their shape is deprecated and it will throw an error in a future release. Consider `x.mT` to transpose batches of matrices or `x.permute(*torch.arange(x.ndim - 1, -1, -1))` to reverse the dimensions of a tensor. (Triggered internally at ../aten/src/ATen/native/TensorShape.cpp:3683.)
  (searcher.ranker.codec.centroids[7] * Q[0].T).sum()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>tensor(0.5786, device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
</section>
<section id="ivf" class="level3">
<h3 class="anchored" data-anchor-id="ivf"><code>ivf</code></h3>
<p>The next line in <code>generate_candidate_pids</code> gets to the core of PLAID: the mapping between centroid IDs and passage IDs:</p>
<div class="sourceCode" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1">pids, cell_lengths <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.ivf.lookup(cells)</span></code></pre></div>
<div class="cell" data-outputid="1391cb5b-fe7d-4229-a6bd-0da84227bd8f" data-execution_count="45">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1">searcher.ranker.ivf</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>&lt;colbert.search.strided_tensor.StridedTensor at 0x7d0a4f48e350&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="b02815c1-029b-4413-839e-f6160abd4a70" data-execution_count="46">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1">pids, cell_lengths <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.ivf.lookup(cells)</span>
<span id="cb93-2">pids.shape, cell_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>(torch.Size([10]), torch.Size([10]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="fb9ce7c4-eaba-413a-af3b-b6b1037b6721" data-execution_count="47">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1">cells</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>tensor([ 7,  8, 14, 19, 24, 29, 31, 38, 41, 61], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="3d77e596-24d6-4c5a-aed5-27b918bf45ed" data-execution_count="48">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1">pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>tensor([0, 0, 1, 0, 1, 2, 2, 2, 0, 0], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<div class="cell" data-outputid="90bc17a1-5de4-471b-a870-0503153a166a" data-execution_count="49">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">cell_lengths</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1])</code></pre>
</div>
</div>
<p>How I interpret this: we have 10 centroid IDs (<code>cells</code>) and each are mapped to 1 passage ID. Now, given that we only have 3 passages to work with, there are some repeats (passage ID <code>0</code> corresponds to both centroid IDs <code>7</code> and <code>8</code>).</p>
<p>I’ll leave my full exploration of how <code>ivf</code> is constructed for a future video/blog post, but as an aside, I do want to highlight some things I learned, starting with the fact that our <code>index_path</code> contains a lot of interesting files!</p>
<div class="cell" data-outputid="00e35cd1-afb1-4adb-899b-d408ed08f36d" data-execution_count="50">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1">path <span class="op" style="color: #5E5E5E;">=</span> Path(index_path)</span>
<span id="cb101-2">path.ls()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(#12) [Path('.ragatouille/colbert/indexes/toy_example/0.residuals.pt'),Path('.ragatouille/colbert/indexes/toy_example/collection.json'),Path('.ragatouille/colbert/indexes/toy_example/pid_docid_map.json'),Path('.ragatouille/colbert/indexes/toy_example/metadata.json'),Path('.ragatouille/colbert/indexes/toy_example/buckets.pt'),Path('.ragatouille/colbert/indexes/toy_example/doclens.0.json'),Path('.ragatouille/colbert/indexes/toy_example/centroids.pt'),Path('.ragatouille/colbert/indexes/toy_example/0.codes.pt'),Path('.ragatouille/colbert/indexes/toy_example/avg_residual.pt'),Path('.ragatouille/colbert/indexes/toy_example/plan.json'),Path('.ragatouille/colbert/indexes/toy_example/0.metadata.json'),Path('.ragatouille/colbert/indexes/toy_example/ivf.pid.pt')]</code></pre>
</div>
</div>
<p>Each passage contains 13 tokens:</p>
<div class="cell" data-outputid="dd501c7a-e88c-47e3-976e-ba35ab16ea64" data-execution_count="51">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">json.load(<span class="bu" style="color: null;">open</span>(path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'doclens.0.json'</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>[13, 13, 13]</code></pre>
</div>
</div>
<p>For a total of 39 token embeddings:</p>
<div class="cell" data-outputid="581f9d8a-5883-4c48-ac05-a3d596ee86ae" data-execution_count="52">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1">metadata <span class="op" style="color: #5E5E5E;">=</span> json.load(<span class="bu" style="color: null;">open</span>(path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'0.metadata.json'</span>))</span>
<span id="cb105-2">metadata</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>{'passage_offset': 0,
 'num_passages': 3,
 'num_embeddings': 39,
 'embedding_offset': 0}</code></pre>
</div>
</div>
<p>There are indeed 64 centroids.</p>
<div class="cell" data-outputid="445ac68c-7e3b-47bb-f634-02b363076e03" data-execution_count="53">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">centroids <span class="op" style="color: #5E5E5E;">=</span> torch.load(path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'centroids.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb107-2">centroids.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>torch.Size([64, 128])</code></pre>
</div>
</div>
<p>There exists a mapping between the 64 centroid IDs and the 39 passage token embeddings</p>
<div class="cell" data-outputid="ab6ba143-47c3-4137-ad8e-fe8dd91c59fa" data-execution_count="54">
<div class="sourceCode cell-code" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1">codes <span class="op" style="color: #5E5E5E;">=</span> torch.load(path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'0.codes.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb109-2">codes.shape, codes.<span class="bu" style="color: null;">min</span>(), codes.<span class="bu" style="color: null;">max</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>(torch.Size([39]), tensor(0, dtype=torch.int32), tensor(61, dtype=torch.int32))</code></pre>
</div>
</div>
<p>There exists 39 residuals, one for each passage token! I’m not sure why there are only 64 dimensions.</p>
<div class="cell" data-outputid="0d13cdc5-103e-46d0-cc2f-e7f7fa85f828" data-execution_count="55">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1">residuals <span class="op" style="color: #5E5E5E;">=</span> torch.load(path<span class="op" style="color: #5E5E5E;">/</span><span class="st" style="color: #20794D;">'0.residuals.pt'</span>, weights_only<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb111-2">residuals.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>torch.Size([39, 64])</code></pre>
</div>
</div>
<p>The values of the residuals are integers!</p>
<div class="cell" data-outputid="96d44ade-01ab-4d05-8e91-1034be9b86ec" data-execution_count="56">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1">residuals[<span class="dv" style="color: #AD0000;">0</span>][:<span class="dv" style="color: #AD0000;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>tensor([191, 183,  50,  66, 203], dtype=torch.uint8)</code></pre>
</div>
</div>
<p>Okay, that’s enough of an aside. The final piece of interest in <code>generate_candidates</code> are the lines</p>
<div class="sourceCode" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.generate_candidate_pids(Q, ncells)</span>
<span id="cb115-2">sorter <span class="op" style="color: #5E5E5E;">=</span> pids.sort()</span>
<span id="cb115-3">pids <span class="op" style="color: #5E5E5E;">=</span> sorter.values</span>
<span id="cb115-4"></span>
<span id="cb115-5">pids, pids_counts <span class="op" style="color: #5E5E5E;">=</span> torch.unique_consecutive(pids, return_counts<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
<div class="cell" data-outputid="7442a075-ac5a-4cb5-965d-c9b26ea9fda5" data-execution_count="57">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.generate_candidate_pids(Q, ncells<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb116-2">pids.shape, centroid_scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(torch.Size([10]), torch.Size([64, 32]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="b831553f-f3f6-4821-8a5b-e60781ed0d9b" data-execution_count="58">
<div class="sourceCode cell-code" id="cb118" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1">sorter <span class="op" style="color: #5E5E5E;">=</span> pids.sort()</span>
<span id="cb118-2">sorter</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>torch.return_types.sort(
values=tensor([0, 0, 0, 0, 0, 1, 1, 2, 2, 2], device='cuda:0', dtype=torch.int32),
indices=tensor([1, 0, 8, 3, 9, 4, 2, 7, 5, 6], device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-outputid="c5e52d1e-077f-4b94-99df-2dda31dec572" data-execution_count="59">
<div class="sourceCode cell-code" id="cb120" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1">pids <span class="op" style="color: #5E5E5E;">=</span> sorter.values</span>
<span id="cb120-2">pids, pids_counts <span class="op" style="color: #5E5E5E;">=</span> torch.unique_consecutive(pids, return_counts<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb120-3">pids.shape, pids_counts.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>(torch.Size([3]), torch.Size([3]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="4970859c-2f07-4c1d-9572-b7d29ddc2c12" data-execution_count="60">
<div class="sourceCode cell-code" id="cb122" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1">pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>tensor([0, 1, 2], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<div class="cell" data-outputid="23f5ecd1-471f-4b75-8bb4-f3a86670b0e5" data-execution_count="61">
<div class="sourceCode cell-code" id="cb124" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1">pids_counts</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>tensor([5, 2, 3], device='cuda:0')</code></pre>
</div>
</div>
<p>Let’s recap what we’ve done:</p>
<ul>
<li>We picked a number of centroid IDs nearest to each query token that we’re interested in (<code>ncells = 4</code>)</li>
<li>We calculated the cosine similarity between centroids and query tokens (<code>searcher.ranker.codec.centroids @ Q.T</code>)</li>
<li>We picked the top-4 scores per query token (<code>scores.topk</code>) and grabbed their indices along dim=0 (rows).</li>
<li>We then reduced those 32 x 4 = 128 centroid IDs down to the 10 unique ones.</li>
<li>And looked them up in our index to get the corresponding 10 passage IDs.</li>
<li>We reduced those to the 3 unique passage IDs.</li>
</ul>
<p>These are our candidate passages at the end of Stage 1!</p>
</section>
</section>
<section id="stage-2-centroid-interaction-with-pruning" class="level2">
<h2 class="anchored" data-anchor-id="stage-2-centroid-interaction-with-pruning">Stage 2: Centroid Interaction with Pruning</h2>
<p>We now want to keep PIDs corresponding to centroids that exceed a minimum threshold cosine similarity with query tokens.</p>
<p>Now that we’ve gotten the initial candidate <code>pids</code>, the next line of interest in <code>rank</code> is:</p>
<div class="sourceCode" id="cb126" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1">scores, pids <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.score_pids(config, Q, pids, centroid_scores)</span></code></pre></div>
<div class="cell" data-outputid="36c10cbe-9555-4eac-b579-36c06a2c0c0e" data-execution_count="62">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1">searcher.ranker.score_pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<div style="max-width:800px; border: 1px solid var(--colab-border-color);"><style>
      pre.function-repr-contents {
        overflow-x: auto;
        padding: 8px 12px;
        max-height: 500px;
      }

      pre.function-repr-contents.function-repr-contents-collapsed {
        cursor: pointer;
        max-height: 100px;
      }
    </style>
    <pre style="white-space: initial; background:
         var(--colab-secondary-surface-color); padding: 8px 12px;
         border-bottom: 1px solid var(--colab-border-color);"><b>colbert.search.index_storage.IndexScorer.score_pids</b><br>def score_pids(config, Q, pids, centroid_scores)</pre><pre class="function-repr-contents function-repr-contents-collapsed" style="">/usr/local/lib/python3.10/dist-packages/colbert/search/index_storage.pyAlways supply a flat list or tensor for `pids`.

Supply sizes Q = (1 | num_docs, *, dim) and D = (num_docs, *, dim).
If Q.size(0) is 1, the matrix will be compared with all passages.
Otherwise, each query matrix will be compared against the *aligned* passage.</pre>
      <script>
      if (google.colab.kernel.accessAllowed && google.colab.files && google.colab.files.view) {
        for (const element of document.querySelectorAll('.filepath')) {
          element.style.display = 'block'
          element.onclick = (event) => {
            event.preventDefault();
            event.stopPropagation();
            google.colab.files.view(element.textContent, 111);
          };
        }
      }
      for (const element of document.querySelectorAll('.function-repr-contents')) {
        element.onclick = (event) => {
          event.preventDefault();
          event.stopPropagation();
          element.classList.toggle('function-repr-contents-collapsed');
        };
      }
      </script>
      </div>
</div>
</div>
<p><code>score_pids</code> will handle both Stage 2 and Stage 3.</p>
<section id="picking-centroids-with-scores-above-threshold" class="level3">
<h3 class="anchored" data-anchor-id="picking-centroids-with-scores-above-threshold">Picking centroids with scores above threshold</h3>
<p>The first important line in <code>score_pids</code> is the following:</p>
<div class="sourceCode" id="cb128" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1">idx <span class="op" style="color: #5E5E5E;">=</span> centroid_scores.<span class="bu" style="color: null;">max</span>(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>).values <span class="op" style="color: #5E5E5E;">&gt;=</span> config.centroid_score_threshold</span></code></pre></div>
<p>I’ll refresh our <code>pids</code> and <code>centroid_scores</code> to the values they would have inside of <code>rank</code>:</p>
<div class="cell" data-outputid="e93cd71f-ead6-48e4-b76a-ec375004c1bc" data-execution_count="63">
<div class="sourceCode cell-code" id="cb129" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1">Q <span class="op" style="color: #5E5E5E;">=</span> searcher.encode(q)</span>
<span id="cb129-2">Q.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>torch.Size([1, 32, 128])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ff882296-ba0b-45b1-df87-35db539b4e39" data-execution_count="64">
<div class="sourceCode cell-code" id="cb131" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1">pids, centroid_scores <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.retrieve(searcher.config, Q)</span>
<span id="cb131-2">pids.shape, centroid_scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>(torch.Size([3]), torch.Size([64, 32]))</code></pre>
</div>
</div>
<p>The centroid score threshold is set in the <code>config</code></p>
<div class="cell" data-outputid="f2890fb8-bd7a-4155-c710-3abfb0f0ec03" data-execution_count="65">
<div class="sourceCode cell-code" id="cb133" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1">searcher.config.centroid_score_threshold</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>0.5</code></pre>
</div>
</div>
<div class="cell" data-outputid="0d115378-2cd9-4389-d419-c47f0280cb22" data-execution_count="66">
<div class="sourceCode cell-code" id="cb135" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1">idx <span class="op" style="color: #5E5E5E;">=</span> centroid_scores.<span class="bu" style="color: null;">max</span>(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>).values <span class="op" style="color: #5E5E5E;">&gt;=</span> searcher.config.centroid_score_threshold</span>
<span id="cb135-2">idx.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>torch.Size([64])</code></pre>
</div>
</div>
<p><code>idx</code> is a boolean tensor, <code>True</code> for rows where the maximum cosine similarity is at or above the threshold and <code>False</code> for where it’s under it.</p>
<div class="cell" data-outputid="3a5dec17-f8a6-493e-b362-f7cb0b97cae7" data-execution_count="67">
<div class="sourceCode cell-code" id="cb137" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1">idx</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>tensor([False, False, False, False, False, False, False,  True,  True, False,
        False, False, False, False,  True, False, False, False, False,  True,
        False, False, False, False, False, False, False, False, False,  True,
        False,  True, False, False, False, False, False, False,  True, False,
        False,  True, False, False, False, False, False, False, False, False,
        False, False, False, False, False, False, False, False, False, False,
        False,  True, False, False], device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="looking-up-codes-centroid-ids-corresponding-to-passage-tokens" class="level3">
<h3 class="anchored" data-anchor-id="looking-up-codes-centroid-ids-corresponding-to-passage-tokens">Looking up codes (centroid IDs corresponding to passage tokens)</h3>
<p>The next line of interest in <code>score_pids</code> is:</p>
<div class="sourceCode" id="cb139" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1">codes_packed, codes_lengths <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.embeddings_strided.lookup_codes(pids_)</span></code></pre></div>
<div class="cell" data-outputid="fb70d130-b532-48be-93d0-4a2012ccf387" data-execution_count="68">
<div class="sourceCode cell-code" id="cb140" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1">searcher.ranker.embeddings_strided</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>&lt;colbert.indexing.codecs.residual_embeddings_strided.ResidualEmbeddingsStrided at 0x7d0a4f48d180&gt;</code></pre>
</div>
</div>
<p>A key point here, which aligns with what I understood from the paper: we are looking up centroid IDs corresponding to the <em>passage tokens</em> in our passage IDs. Note that there are 39 values in <code>codes_packed</code> which correspond to the 39 passage token embeddings. I’ll leave me exploration for how I got this conclusion for a future video/blog post.</p>
<div class="cell" data-outputid="86ada23f-a306-472a-b667-f51d4d7e5e77" data-execution_count="69">
<div class="sourceCode cell-code" id="cb142" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1">codes_packed, codes_lengths <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.embeddings_strided.lookup_codes(pids)</span>
<span id="cb142-2">codes_packed.shape, codes_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>(torch.Size([39]), torch.Size([3]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="24fd298d-dcc6-4f3b-ac0f-8fbda9d8d59f" data-execution_count="70">
<div class="sourceCode cell-code" id="cb144" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1">codes_packed</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>tensor([41,  8, 61,  7,  7, 47, 60, 19, 19,  1, 42, 46, 41, 24, 58, 58, 14, 14,
         2,  3, 60, 23, 12,  2, 16, 48, 29, 38, 31, 37,  9,  6, 57,  5, 17, 13,
         0,  0, 29], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<p>Note that <code>codes_lengths</code> tells us how many tokens there are in each passage.</p>
<div class="cell" data-outputid="da17ddfb-81c5-46f1-ea56-5ac4aeaaa7a8" data-execution_count="71">
<div class="sourceCode cell-code" id="cb146" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1">codes_lengths</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>tensor([13, 13, 13])</code></pre>
</div>
</div>
<p>From the PLAID paper (emphasis mine):</p>
<blockquote class="blockquote">
<p>The procedure works as follows. Recall that <img src="https://latex.codecogs.com/png.latex?S_%7Bc,q%7D"> from Equation 2 stores the relevance scores for each centroid with respect to the query tokens. Suppose <img src="https://latex.codecogs.com/png.latex?I"> is <strong>the list of the centroid indices mapped to each of the tokens in the candidate set</strong>. Furthermore, let <img src="https://latex.codecogs.com/png.latex?S_%7Bc,q%7D"> denote the i-th row of <img src="https://latex.codecogs.com/png.latex?S_%7Bc,q%7D">. Then PLAID constructs the centroid-based approximate scores <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7BD%7D"> as:</p>
</blockquote>
</section>
<section id="picking-scores-for-centroid-ids-corresponding-to-passage-tokens" class="level3">
<h3 class="anchored" data-anchor-id="picking-scores-for-centroid-ids-corresponding-to-passage-tokens">Picking scores for centroid IDs corresponding to passage tokens</h3>
<p>The next line in <code>score_pids</code> does just that: pick the centroid IDs that correspond to the passage tokens of interest:</p>
<div class="cell" data-outputid="b258b905-4606-4f9f-828a-763f100965ae" data-execution_count="72">
<div class="sourceCode cell-code" id="cb148" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1">idx_ <span class="op" style="color: #5E5E5E;">=</span> idx[codes_packed.<span class="bu" style="color: null;">long</span>()]</span>
<span id="cb148-2">idx_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>torch.Size([39])</code></pre>
</div>
</div>
<div class="cell" data-outputid="621559b8-2af6-4694-8f74-2216dc066afa" data-execution_count="73">
<div class="sourceCode cell-code" id="cb150" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1">idx_</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>tensor([ True,  True,  True,  True,  True, False, False,  True,  True, False,
        False, False,  True, False, False, False,  True,  True, False, False,
        False, False, False, False, False, False,  True,  True,  True, False,
        False, False, False, False, False, False, False, False,  True],
       device='cuda:0')</code></pre>
</div>
</div>
<p>We then use this to index back into <code>codes_packed</code> to select the centroid IDs that are at or above the threshold of 0.5. There are 14 such centroid IDs.</p>
<div class="cell" data-outputid="0c38ced6-9d9a-41ad-e7ac-39f31949d246" data-execution_count="74">
<div class="sourceCode cell-code" id="cb152" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1">codes_packed_ <span class="op" style="color: #5E5E5E;">=</span> codes_packed[idx_]</span>
<span id="cb152-2">codes_packed_, codes_packed_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>(tensor([41,  8, 61,  7,  7, 19, 19, 41, 14, 14, 29, 38, 31, 29],
        device='cuda:0', dtype=torch.int32),
 torch.Size([14]))</code></pre>
</div>
</div>
<p>Finally, we can index into our scores and pick out the scores that correspond to these centroid IDs:</p>
<div class="cell" data-outputid="5de36e31-3d15-42ee-fc56-4239f69beeb1" data-execution_count="75">
<div class="sourceCode cell-code" id="cb154" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1">approx_scores_ <span class="op" style="color: #5E5E5E;">=</span> centroid_scores[codes_packed_.<span class="bu" style="color: null;">long</span>()]</span>
<span id="cb154-2">approx_scores_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>torch.Size([14, 32])</code></pre>
</div>
</div>
<p>We now have the scores between 14 centroids that are mapped to our candidate passage ID’s tokens and all 32 query tokens.</p>
</section>
<section id="max-reducing-scores-to-get-1-score-per-passage-id" class="level3">
<h3 class="anchored" data-anchor-id="max-reducing-scores-to-get-1-score-per-passage-id">Max-reducing scores to get 1 score per passage ID</h3>
<p>The last step of Stage 2 is to max-reduce the scores down to 1 per passage. The following lines are of interest:</p>
<div class="sourceCode" id="cb156" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1">pruned_codes_strided <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(idx_, codes_lengths, use_gpu<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.use_gpu)</span>
<span id="cb156-2">pruned_codes_padded, pruned_codes_mask <span class="op" style="color: #5E5E5E;">=</span> pruned_codes_strided.as_padded_tensor()</span>
<span id="cb156-3">pruned_codes_lengths <span class="op" style="color: #5E5E5E;">=</span> (pruned_codes_padded <span class="op" style="color: #5E5E5E;">*</span> pruned_codes_mask).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb156-4"></span>
<span id="cb156-5">...</span>
<span id="cb156-6"></span>
<span id="cb156-7">approx_scores_strided <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(approx_scores_, pruned_codes_lengths, use_gpu<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.use_gpu)</span>
<span id="cb156-8">approx_scores_padded, approx_scores_mask <span class="op" style="color: #5E5E5E;">=</span> approx_scores_strided.as_padded_tensor()</span>
<span id="cb156-9">approx_scores_ <span class="op" style="color: #5E5E5E;">=</span> colbert_score_reduce(approx_scores_padded, approx_scores_mask, config)</span></code></pre></div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb157" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><span class="im" style="color: #00769E;">from</span> colbert.search.strided_tensor <span class="im" style="color: #00769E;">import</span> StridedTensor, StridedTensorCore</span></code></pre></div>
</div>
<div class="cell" data-outputid="b39c3799-5e2c-4f14-845f-8a32abbcf118" data-execution_count="77">
<div class="sourceCode cell-code" id="cb158" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1">idx_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>torch.Size([39])</code></pre>
</div>
</div>
<div class="cell" data-outputid="f1ee182c-bce3-4a39-a0d5-5d4f4d019b00" data-execution_count="78">
<div class="sourceCode cell-code" id="cb160" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1">pruned_codes_strided <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(idx_, codes_lengths)</span>
<span id="cb160-2">pruned_codes_strided</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>&lt;colbert.search.strided_tensor.StridedTensor at 0x7d0a4f688e20&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="996c7d02-fb8c-4a5f-9f21-e2aa7bb21b0c" data-execution_count="79">
<div class="sourceCode cell-code" id="cb162" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1">pruned_codes_padded, pruned_codes_mask <span class="op" style="color: #5E5E5E;">=</span> pruned_codes_strided.as_padded_tensor()</span>
<span id="cb162-2">pruned_codes_padded.shape, pruned_codes_mask.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>(torch.Size([3, 13]), torch.Size([3, 13]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="82517510-0348-43be-8690-523fc6f5ae9c" data-execution_count="80">
<div class="sourceCode cell-code" id="cb164" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1">pruned_codes_padded</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>tensor([[ True,  True,  True,  True,  True, False, False,  True,  True, False,
         False, False,  True],
        [False, False, False,  True,  True, False, False, False, False, False,
         False, False, False],
        [ True,  True,  True, False, False, False, False, False, False, False,
         False, False,  True]], device='cuda:0')</code></pre>
</div>
</div>
<p>My understanding of <code>StridedTensor</code> is still spotty, but from what I can see it allows the reshaping of values from a 1-D 39 to 3 x 13. In this way, we are organizing centroid IDs by both passage ID and by passage token.</p>
<div class="cell" data-outputid="e7433db9-70ab-44af-fa41-18fe6404cf1b" data-execution_count="81">
<div class="sourceCode cell-code" id="cb166" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1">pruned_codes_lengths <span class="op" style="color: #5E5E5E;">=</span> (pruned_codes_padded <span class="op" style="color: #5E5E5E;">*</span> pruned_codes_mask).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb166-2">pruned_codes_lengths</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>tensor([8, 2, 4], device='cuda:0')</code></pre>
</div>
</div>
<p>There are 8 centroids corresponding to tokens in the first passage that cross the score threshold, 2 for the second passage and 4 for the third.</p>
<p>Note that <code>pruned_codes_mask</code> is <code>True</code> everywhere so multiplying <code>pruned_codes_padded</code> by it keeps all of its values intact:</p>
<div class="cell" data-outputid="7e98c61b-266a-4b77-f81e-0299b1ab355b" data-execution_count="82">
<div class="sourceCode cell-code" id="cb168" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1">pruned_codes_mask</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>tensor([[True, True, True, True, True, True, True, True, True, True, True, True,
         True],
        [True, True, True, True, True, True, True, True, True, True, True, True,
         True],
        [True, True, True, True, True, True, True, True, True, True, True, True,
         True]], device='cuda:0')</code></pre>
</div>
</div>
<p>The next lines reshapes our <code>approx_scores_</code> similarly.</p>
<div class="cell" data-outputid="06dba42e-0787-4a39-f9ec-8175c0d480b1" data-execution_count="83">
<div class="sourceCode cell-code" id="cb170" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1">approx_scores_.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>torch.Size([14, 32])</code></pre>
</div>
</div>
<div class="cell" data-outputid="5635151e-8e69-4ff1-ee67-a4ac607766eb" data-execution_count="84">
<div class="sourceCode cell-code" id="cb172" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1">approx_scores_strided <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(approx_scores_, pruned_codes_lengths)</span>
<span id="cb172-2">approx_scores_padded, approx_scores_mask <span class="op" style="color: #5E5E5E;">=</span> approx_scores_strided.as_padded_tensor()</span>
<span id="cb172-3">approx_scores_padded.shape, approx_scores_mask.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>(torch.Size([3, 8, 32]), torch.Size([3, 8, 1]))</code></pre>
</div>
</div>
<p>What’s interesting to note here is <code>approx_scores_mask</code>. We know from <code>pruned_codes_lengths</code> that there are 8 centroid IDs for the first passage, 2 for the second, and 4 for the third. <code>approx_scores_mask</code> flags <code>True</code> for valid values and <code>False</code> for padding values.</p>
<div class="cell" data-outputid="b978dcbb-6664-40e2-80ce-377875829f91" data-execution_count="85">
<div class="sourceCode cell-code" id="cb174" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1">approx_scores_mask</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>tensor([[[ True],
         [ True],
         [ True],
         [ True],
         [ True],
         [ True],
         [ True],
         [ True]],

        [[ True],
         [ True],
         [False],
         [False],
         [False],
         [False],
         [False],
         [False]],

        [[ True],
         [ True],
         [ True],
         [ True],
         [False],
         [False],
         [False],
         [False]]], device='cuda:0')</code></pre>
</div>
</div>
<p>We then pass these padded scores to <code>colbert_reduce</code> which performs the famous MaxSim operation:</p>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb176" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><span class="im" style="color: #00769E;">from</span> colbert.modeling.colbert <span class="im" style="color: #00769E;">import</span> colbert_score, colbert_score_packed, colbert_score_reduce</span></code></pre></div>
</div>
<div class="cell" data-outputid="16c19812-d57a-4acd-fd42-d1a454d35caf" data-execution_count="87">
<div class="sourceCode cell-code" id="cb177" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1">approx_scores_ <span class="op" style="color: #5E5E5E;">=</span> colbert_score_reduce(approx_scores_padded, approx_scores_mask, searcher.config)</span>
<span id="cb177-2">approx_scores_</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>tensor([27.2812, 12.9844, 22.1719], device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>Note that these are not the same values as our RAGatouille results. Instead, these are intermediate scores.</p>
<p>Taking a look at <a href="https://github.com/stanford-futuredata/ColBERT/blob/7067ef598b5011edaa1f4a731a2c269dbac864e4/colbert/modeling/colbert.py#L132"><code>colbert_score_reduce</code></a> there are four main lines of interest in my opinion:</p>
<div class="sourceCode" id="cb179" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1">D_padding <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">~</span>D_mask.view(scores_padded.size(<span class="dv" style="color: #AD0000;">0</span>), scores_padded.size(<span class="dv" style="color: #AD0000;">1</span>)).<span class="bu" style="color: null;">bool</span>()</span>
<span id="cb179-2">scores_padded[D_padding] <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">9999</span></span>
<span id="cb179-3">scores <span class="op" style="color: #5E5E5E;">=</span> scores_padded.<span class="bu" style="color: null;">max</span>(<span class="dv" style="color: #AD0000;">1</span>).values</span>
<span id="cb179-4">scores.<span class="bu" style="color: null;">sum</span>(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell" data-outputid="089876b1-d49d-4115-89a2-a1b1b7f8ae1a" data-execution_count="88">
<div class="sourceCode cell-code" id="cb180" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1">D_padding <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">~</span>approx_scores_mask.view(approx_scores_padded.size(<span class="dv" style="color: #AD0000;">0</span>), approx_scores_padded.size(<span class="dv" style="color: #AD0000;">1</span>)).<span class="bu" style="color: null;">bool</span>()</span>
<span id="cb180-2">approx_scores_padded[D_padding] <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">9999</span></span>
<span id="cb180-3">approx_scores_padded.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>torch.Size([3, 8, 32])</code></pre>
</div>
</div>
<p>We take the max along dim=1, which is the dimension with centroid IDs corresponding to passage tokens. So, in other words, we are finding the maximum score between centroid and query token for each query token per passage.</p>
<div class="cell" data-outputid="a8ad482d-d01d-40e1-f180-eaff91d04c45" data-execution_count="89">
<div class="sourceCode cell-code" id="cb182" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1">scores <span class="op" style="color: #5E5E5E;">=</span> approx_scores_padded.<span class="bu" style="color: null;">max</span>(<span class="dv" style="color: #AD0000;">1</span>).values</span>
<span id="cb182-2">scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>torch.Size([3, 32])</code></pre>
</div>
</div>
<p>Finally, we sum across query tokens per passage ID.</p>
<div class="cell" data-outputid="49fcb173-d810-4288-bc97-5039c5b9622b" data-execution_count="90">
<div class="sourceCode cell-code" id="cb184" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1">scores.<span class="bu" style="color: null;">sum</span>(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor([27.2812, 12.9844, 22.1719], device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
</section>
<section id="picking-the-top-ndocs-passages" class="level3">
<h3 class="anchored" data-anchor-id="picking-the-top-ndocs-passages">Picking the top-ndocs passages</h3>
<p>The last step is to pick the top-<code>ndocs</code> passage IDs.</p>
<div class="cell" data-outputid="230765fc-4cdb-49d7-f107-24b83b2c0756" data-execution_count="91">
<div class="sourceCode cell-code" id="cb186" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1">searcher.config.ndocs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>256</code></pre>
</div>
</div>
<p><code>ndocs</code> is 256, much larger than the number of passages we have, so I’ll rank with <code>k=3</code>:</p>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb188" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><span class="cf" style="color: #003B4F;">if</span> searcher.config.ndocs <span class="op" style="color: #5E5E5E;">//</span> <span class="dv" style="color: #AD0000;">4</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="bu" style="color: null;">len</span>(approx_scores_):</span>
<span id="cb188-2">    pids <span class="op" style="color: #5E5E5E;">=</span> pids[torch.topk(approx_scores_, k<span class="op" style="color: #5E5E5E;">=</span>(searcher.config.ndocs <span class="op" style="color: #5E5E5E;">//</span> <span class="dv" style="color: #AD0000;">4</span>)).indices]</span></code></pre></div>
</div>
<div class="cell" data-outputid="3bff81bf-0e59-49c7-95bf-25d63367f8a4" data-execution_count="93">
<div class="sourceCode cell-code" id="cb189" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1">pids <span class="op" style="color: #5E5E5E;">=</span> pids[torch.topk(approx_scores_, k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>).indices]</span>
<span id="cb189-2">pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>tensor([0, 2, 1], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<p>To recap Stage 2:</p>
<ul>
<li>We select centroid IDs that were both at/above our threshold of 0.5 AND corresponded to passage tokens for the passage IDs in our initial candidate pool from Stage 1.</li>
<li>We then do some reshaping so we can calculate the MaxSim score for each passage ID.</li>
<li>We pick the top-<code>ndocs</code> passages.</li>
</ul>
</section>
</section>
<section id="stage-3-centroid-interaction-wo-pruning" class="level2">
<h2 class="anchored" data-anchor-id="stage-3-centroid-interaction-wo-pruning">Stage 3: Centroid Interaction w/o Pruning</h2>
<p>We now have our candidate set from Stage 2. We lookup the centroid IDs for the passage tokens in these passage IDs:</p>
<div class="cell" data-outputid="a72ebd87-0213-4961-8129-4a8258cfe40d" data-execution_count="94">
<div class="sourceCode cell-code" id="cb191" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1">codes_packed, codes_lengths <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.embeddings_strided.lookup_codes(pids)</span>
<span id="cb191-2">codes_packed.shape, codes_lengths.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(torch.Size([39]), torch.Size([3]))</code></pre>
</div>
</div>
<p>We don’t use the threshold for this step—all centroids, even those who have a maximum cosine similarity with query tokens being less than our threshold:</p>
<div class="cell" data-outputid="b2f5cc5d-b29c-464f-a01f-3b5234f36639" data-execution_count="95">
<div class="sourceCode cell-code" id="cb193" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1">approx_scores <span class="op" style="color: #5E5E5E;">=</span> centroid_scores[codes_packed.<span class="bu" style="color: null;">long</span>()]</span>
<span id="cb193-2">approx_scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>torch.Size([39, 32])</code></pre>
</div>
</div>
<p>Note how we are now dealing with 39 centroids, not 14 like we did in Stage 2.</p>
<p>We do the same reshaping/padding as we did in Stage 2, and use <code>colbert_score_reduce</code> again:</p>
<div class="cell" data-outputid="0718761e-be31-48b6-9ce7-934557b67051" data-execution_count="96">
<div class="sourceCode cell-code" id="cb195" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1">approx_scores_strided <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(approx_scores, codes_lengths)</span>
<span id="cb195-2">approx_scores_padded, approx_scores_mask <span class="op" style="color: #5E5E5E;">=</span> approx_scores_strided.as_padded_tensor()</span>
<span id="cb195-3">approx_scores <span class="op" style="color: #5E5E5E;">=</span> colbert_score_reduce(approx_scores_padded, approx_scores_mask, searcher.config)</span>
<span id="cb195-4">approx_scores</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>tensor([27.2812, 22.1875, 13.7266], device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>We then pick the top-<code>ndocs//4</code> passage IDs, in this case all 3 of our passage IDs.</p>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb197" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><span class="cf" style="color: #003B4F;">if</span> searcher.config.ndocs <span class="op" style="color: #5E5E5E;">//</span> <span class="dv" style="color: #AD0000;">4</span> <span class="op" style="color: #5E5E5E;">&lt;</span> <span class="bu" style="color: null;">len</span>(approx_scores):</span>
<span id="cb197-2">    pids <span class="op" style="color: #5E5E5E;">=</span> pids[torch.topk(approx_scores, k<span class="op" style="color: #5E5E5E;">=</span>(searcher.config.ndocs <span class="op" style="color: #5E5E5E;">//</span> <span class="dv" style="color: #AD0000;">4</span>)).indices]</span></code></pre></div>
</div>
<div class="cell" data-outputid="b688dbdb-376c-49f4-a878-2f43979cf23b" data-execution_count="98">
<div class="sourceCode cell-code" id="cb198" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1">pids <span class="op" style="color: #5E5E5E;">=</span> pids[torch.topk(approx_scores, k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>).indices]</span>
<span id="cb198-2">pids</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>tensor([0, 2, 1], device='cuda:0', dtype=torch.int32)</code></pre>
</div>
</div>
<p>This is the candidate set at the end of Stage 3. Note that the scores are still not quite the same as RAGatouille, as these are intermediate scores.</p>
</section>
<section id="stage-4-final-ranking-with-decompression" class="level2">
<h2 class="anchored" data-anchor-id="stage-4-final-ranking-with-decompression">Stage 4: Final ranking with decompression</h2>
<p>We’re now in the final Stage of the PLAID scoring pipeline. We now get the full 128-dimension vectors for all of our passage ID’s tokens:</p>
<div class="cell" data-outputid="38c13003-3d32-4f12-81f9-dc4155f2e279" data-execution_count="99">
<div class="sourceCode cell-code" id="cb200" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1">D_packed, D_mask <span class="op" style="color: #5E5E5E;">=</span> searcher.ranker.lookup_pids(pids)</span>
<span id="cb200-2">D_packed.shape, D_mask.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>(torch.Size([39, 128]), torch.Size([3]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="64f16da5-3c21-42bb-bae9-f1f0bb4ef83a" data-execution_count="100">
<div class="sourceCode cell-code" id="cb202" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1">D_packed[<span class="dv" style="color: #AD0000;">0</span>][<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor(-0.0102, device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>Since we only have one query:</p>
<div class="cell" data-outputid="2451029d-5f1d-4ed0-cc96-efcad8ac5c6e" data-execution_count="101">
<div class="sourceCode cell-code" id="cb204" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1">Q.size(<span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>1</code></pre>
</div>
</div>
<p>We use the following lines of code:</p>
<div class="cell" data-outputid="5add352b-4bb2-4ef3-ad1b-8a489b2f12c3" data-execution_count="102">
<div class="sourceCode cell-code" id="cb206" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1">colbert_score_packed(Q, D_packed, D_mask, searcher.config)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>tensor([27.6875, 22.2812, 13.9531], device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>Looking into <code>colbert_score_packed</code>, here are the lines of interest:</p>
<div class="cell" data-outputid="c7b81dc9-d4d5-4883-ecc4-a00b06410a07" data-execution_count="103">
<div class="sourceCode cell-code" id="cb208" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1">Q <span class="op" style="color: #5E5E5E;">=</span> Q.squeeze(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb208-2">Q.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>torch.Size([32, 128])</code></pre>
</div>
</div>
<p>We calculate the cosine similarity between each passage token and each query token:</p>
<div class="cell" data-outputid="35cfe4d1-0ff8-4689-9b9a-4fd9641ed38f" data-execution_count="104">
<div class="sourceCode cell-code" id="cb210" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1">scores <span class="op" style="color: #5E5E5E;">=</span> D_packed <span class="op" style="color: #5E5E5E;">@</span> Q.to(dtype<span class="op" style="color: #5E5E5E;">=</span>D_packed.dtype).T</span>
<span id="cb210-2">scores.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>torch.Size([39, 32])</code></pre>
</div>
</div>
<p>Reshape them so we can max-reduce them by passage ID:</p>
<div class="cell" data-outputid="4952176c-4b95-4f3e-92b1-a821d4167301" data-execution_count="105">
<div class="sourceCode cell-code" id="cb212" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1">scores_padded, scores_mask <span class="op" style="color: #5E5E5E;">=</span> StridedTensor(scores, D_mask).as_padded_tensor()</span>
<span id="cb212-2">scores_padded.shape, scores_mask.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>(torch.Size([3, 13, 32]), torch.Size([3, 13, 1]))</code></pre>
</div>
</div>
<p>And max-reduce with <code>colbert_score_reduce</code>:</p>
<div class="cell" data-outputid="a50d137e-4304-4f6a-f858-0eb907400deb" data-execution_count="106">
<div class="sourceCode cell-code" id="cb214" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1">colbert_score_reduce(scores_padded, scores_mask, searcher.config)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>tensor([27.6875, 22.2812, 13.9531], device='cuda:0', dtype=torch.float16)</code></pre>
</div>
</div>
<p>This matches exactly the scores we got using RAGatouille!</p>
<div class="cell" data-outputid="309baa66-6c65-41e0-f89b-6a111e571a5b" data-execution_count="107">
<div class="sourceCode cell-code" id="cb216" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1">results</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>[{'content': 'Python is a programming language. It is easy to learn',
  'score': 27.6875,
  'rank': 1,
  'document_id': '8aa5aade-10d5-4144-b634-c7866578b43c',
  'passage_id': 0},
 {'content': 'Python was created by Guido van Rossum in 1991',
  'score': 22.28125,
  'rank': 2,
  'document_id': '12352328-9bb1-4a51-896e-a002d3548adc',
  'passage_id': 2},
 {'content': 'Java is a popular coding language used in many applications',
  'score': 13.953125,
  'rank': 3,
  'document_id': '1fe9788e-ccec-4b9e-a004-14acc657915e',
  'passage_id': 1}]</code></pre>
</div>
</div>
<p>To recap Stage 4:</p>
<ul>
<li>We lookup the full vectors corresponding to all passage tokens in our passage IDs.</li>
<li>We reshape them to allow for max-reduction by passage ID.</li>
<li>We calculate the MaxSim score for each passage.</li>
</ul>
<p>In this way, we were able to recreate the entire 4-stage PLAID pipeline to match RAGatouille results!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>information retrieval</category>
  <category>machine learning</category>
  <category>deep learning</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/index.html</guid>
  <pubDate>Tue, 24 Dec 2024 08:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2024-12-24-PLAID-ColBERTv2-scoring-pipeline/1.png" medium="image" type="image/png" height="59" width="144"/>
</item>
<item>
  <title>Scoring Full Text and Semantic Search on Chunk Sizes from 100 to 2000 Tokens</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-29-fastbook-benchmark-results/index.html</link>
  <description><![CDATA[ 



<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:35:34.413312Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:35:34.413011Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:35:48.851237Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:35:48.850561Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:35:34.413283Z&quot;}" data-trusted="true">
<details>
<summary>pip installs and imports</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install sentence<span class="op" style="color: #5E5E5E;">-</span>transformers <span class="op" style="color: #5E5E5E;">-</span>Uqq</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq RAGatouille</span>
<span id="cb1-3"><span class="op" style="color: #5E5E5E;">!</span>pip install ftfy <span class="op" style="color: #5E5E5E;">-</span>qq</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> sqlite3</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">import</span> json</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">import</span> re</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd, numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb1-11"><span class="im" style="color: #00769E;">import</span> requests</span>
<span id="cb1-12"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb1-13"><span class="im" style="color: #00769E;">import</span> torch.nn.functional <span class="im" style="color: #00769E;">as</span> F</span>
<span id="cb1-14"><span class="im" style="color: #00769E;">from</span> ftfy <span class="im" style="color: #00769E;">import</span> fix_text</span>
<span id="cb1-15"><span class="im" style="color: #00769E;">from</span> sentence_transformers <span class="im" style="color: #00769E;">import</span> SentenceTransformer</span>
<span id="cb1-16"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb1-17"><span class="im" style="color: #00769E;">from</span> ragatouille.data <span class="im" style="color: #00769E;">import</span> CorpusProcessor</span>
<span id="cb1-18"></span>
<span id="cb1-19">corpus_processor <span class="op" style="color: #5E5E5E;">=</span> CorpusProcessor()</span>
<span id="cb1-20">emb_model <span class="op" style="color: #5E5E5E;">=</span> SentenceTransformer(<span class="st" style="color: #20794D;">"BAAI/bge-small-en-v1.5"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:35:48.852942Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:35:48.852356Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.139480Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.138592Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:35:48.852914Z&quot;}" data-outputid="dfa04737-fb6e-46e3-c46e-a8e0ca6248ad" data-trusted="true" data-execution_count="3">
<details>
<summary>Download chapter ipynb files</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">urls <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb2-2">    <span class="st" style="color: #20794D;">'01_intro.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1mmBjFH_plndPBC4iRZHChfMazgBxKK4_'</span>,</span>
<span id="cb2-3">    <span class="st" style="color: #20794D;">'02_production.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1Cf5QHthHy1z13H0iu3qrzAWgquCfqVHk'</span>,</span>
<span id="cb2-4">    <span class="st" style="color: #20794D;">'04_mnist_basics.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=113909_BNulzyLIKUNJHdya0Hhoqie30I'</span>,</span>
<span id="cb2-5">    <span class="st" style="color: #20794D;">'08_collab.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1BtvStgFjUtvtqbSZNrL7Y2N-ey3seNZU'</span>,</span>
<span id="cb2-6">    <span class="st" style="color: #20794D;">'09_tabular.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1rHFvwl_l-AJLg_auPjBpNrOgG9HDnfqg'</span>,</span>
<span id="cb2-7">    <span class="st" style="color: #20794D;">'10_nlp.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1pg1pH7jMMElzrXS0kBBz14aAuDsi2DEP'</span>,</span>
<span id="cb2-8">    <span class="st" style="color: #20794D;">'13_convolutions.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=19P-eEHpAO3WrOvdxgXckyhHhfv_R-hnS'</span></span>
<span id="cb2-9">}</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="kw" style="color: #003B4F;">def</span> download_file(url, filename):</span>
<span id="cb2-12">    <span class="co" style="color: #5E5E5E;"># Send a GET request to the URL</span></span>
<span id="cb2-13">    response <span class="op" style="color: #5E5E5E;">=</span> requests.get(url)</span>
<span id="cb2-14"></span>
<span id="cb2-15">    <span class="co" style="color: #5E5E5E;"># Check if the request was successful</span></span>
<span id="cb2-16">    <span class="cf" style="color: #003B4F;">if</span> response.status_code <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">200</span>:</span>
<span id="cb2-17">        <span class="co" style="color: #5E5E5E;"># Open the file in write-binary mode</span></span>
<span id="cb2-18">        <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(filename, <span class="st" style="color: #20794D;">'wb'</span>) <span class="im" style="color: #00769E;">as</span> <span class="bu" style="color: null;">file</span>:</span>
<span id="cb2-19">            <span class="co" style="color: #5E5E5E;"># Write the content of the response to the file</span></span>
<span id="cb2-20">            <span class="bu" style="color: null;">file</span>.write(response.content)</span>
<span id="cb2-21">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"File downloaded successfully: </span><span class="sc" style="color: #5E5E5E;">{</span>filename<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb2-22">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb2-23">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Failed to download file. Status code: </span><span class="sc" style="color: #5E5E5E;">{</span>response<span class="sc" style="color: #5E5E5E;">.</span>status_code<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb2-24"></span>
<span id="cb2-25"><span class="cf" style="color: #003B4F;">for</span> fname, url <span class="kw" style="color: #003B4F;">in</span> urls.items():</span>
<span id="cb2-26">  download_file(url, fname)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: 01_intro.ipynb
File downloaded successfully: 02_production.ipynb
File downloaded successfully: 04_mnist_basics.ipynb
File downloaded successfully: 08_collab.ipynb
File downloaded successfully: 09_tabular.ipynb
File downloaded successfully: 10_nlp.ipynb
File downloaded successfully: 13_convolutions.ipynb</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.141537Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.141247Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.145767Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.144919Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.141510Z&quot;}" data-trusted="true">
<details>
<summary><code>nbs</code> dict</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">nbs <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb4-2">    <span class="st" style="color: #20794D;">'1'</span>: <span class="st" style="color: #20794D;">'01_intro.ipynb'</span>,</span>
<span id="cb4-3">    <span class="st" style="color: #20794D;">'2'</span>: <span class="st" style="color: #20794D;">'02_production.ipynb'</span>,</span>
<span id="cb4-4">    <span class="st" style="color: #20794D;">'4'</span>: <span class="st" style="color: #20794D;">'04_mnist_basics.ipynb'</span>,</span>
<span id="cb4-5">    <span class="st" style="color: #20794D;">'8'</span>: <span class="st" style="color: #20794D;">'08_collab.ipynb'</span>,</span>
<span id="cb4-6">    <span class="st" style="color: #20794D;">'9'</span>: <span class="st" style="color: #20794D;">'09_tabular.ipynb'</span>,</span>
<span id="cb4-7">    <span class="st" style="color: #20794D;">'10'</span>: <span class="st" style="color: #20794D;">'10_nlp.ipynb'</span>,</span>
<span id="cb4-8">    <span class="st" style="color: #20794D;">'13'</span>: <span class="st" style="color: #20794D;">'13_convolutions.ipynb'</span></span>
<span id="cb4-9">}</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.146977Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.146769Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.580447Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.579593Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.146956Z&quot;}" data-trusted="true">
<details>
<summary>load questions</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">url <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'https://gist.githubusercontent.com/vishalbakshi/2c22ca69ac7bc4bc845052c1b9d949c8/raw/d498259f2fc75d27c485ddc73933f145987feef3/cs_bm25_baselines.csv'</span></span>
<span id="cb5-2">questions <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(url).query(<span class="st" style="color: #20794D;">"is_answerable == 1"</span>)[[<span class="st" style="color: #20794D;">"chapter"</span>, <span class="st" style="color: #20794D;">"question_number"</span>, <span class="st" style="color: #20794D;">"question_text"</span>, <span class="st" style="color: #20794D;">"answer"</span>, <span class="st" style="color: #20794D;">"keywords"</span>]]</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;"># remove double quotations from the question text</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;"># as these affect embeddings/cosine similarity: https://vishalbakshi.github.io/blog/posts/2024-11-08-punctuation-cosine-similarity/</span></span>
<span id="cb5-6">questions[<span class="st" style="color: #20794D;">'question_text'</span>] <span class="op" style="color: #5E5E5E;">=</span> questions[<span class="st" style="color: #20794D;">'question_text'</span>].<span class="bu" style="color: null;">str</span>.strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>)</span>
<span id="cb5-7"><span class="cf" style="color: #003B4F;">assert</span> questions.shape <span class="op" style="color: #5E5E5E;">==</span> (<span class="dv" style="color: #AD0000;">191</span>,<span class="dv" style="color: #AD0000;">5</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.581926Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.581642Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.791769Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.790918Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.581893Z&quot;}" data-outputid="7530aad2-4d99-4543-d502-ad55c01803f8" data-trusted="true">
<details>
<summary>download fastbook-benchmark</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">download_file(</span>
<span id="cb6-2">    <span class="st" style="color: #20794D;">"https://gist.githubusercontent.com/vishalbakshi/a507b6e9e893475e93a4141e96b8947d/raw/e32835ba1dbf94384943ed5a65404112e1c89df2/fastbook-benchmark.json"</span>,</span>
<span id="cb6-3">    <span class="st" style="color: #20794D;">"fastbook-benchmark.json"</span></span>
<span id="cb6-4">    )</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="kw" style="color: #003B4F;">def</span> load_benchmark():</span>
<span id="cb6-7">    <span class="co" style="color: #5E5E5E;"># Load the benchmark data</span></span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'fastbook-benchmark.json'</span>, <span class="st" style="color: #20794D;">'r'</span>) <span class="im" style="color: #00769E;">as</span> f:</span>
<span id="cb6-9">        benchmark <span class="op" style="color: #5E5E5E;">=</span> json.load(f)</span>
<span id="cb6-10">    <span class="cf" style="color: #003B4F;">return</span> benchmark</span>
<span id="cb6-11"></span>
<span id="cb6-12">benchmark <span class="op" style="color: #5E5E5E;">=</span> load_benchmark()</span>
<span id="cb6-13"><span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(benchmark[<span class="st" style="color: #20794D;">'questions'</span>]) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: fastbook-benchmark.json</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.792998Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.792738Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.798523Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.797592Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.792972Z&quot;}" data-trusted="true">
<details>
<summary><code>calculate_mrr</code> function</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;">def</span> calculate_mrr(question, retrieved_passages, cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb8-2">    retrieved_passages <span class="op" style="color: #5E5E5E;">=</span> retrieved_passages[:cutoff]</span>
<span id="cb8-3">    highest_rank <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb8-4"></span>
<span id="cb8-5">    <span class="cf" style="color: #003B4F;">for</span> ans_comp <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">"answer_context"</span>]:</span>
<span id="cb8-6">        contexts <span class="op" style="color: #5E5E5E;">=</span> ans_comp.get(<span class="st" style="color: #20794D;">"context"</span>, [])</span>
<span id="cb8-7">        component_found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb8-8"></span>
<span id="cb8-9">        <span class="cf" style="color: #003B4F;">for</span> rank, passage <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(retrieved_passages, start<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb8-10">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">any</span>(fix_text(context) <span class="kw" style="color: #003B4F;">in</span> fix_text(passage) <span class="cf" style="color: #003B4F;">for</span> context <span class="kw" style="color: #003B4F;">in</span> contexts):</span>
<span id="cb8-11">                highest_rank <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(highest_rank, rank)</span>
<span id="cb8-12">                component_found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb8-13">                <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb8-14"></span>
<span id="cb8-15">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> component_found:</span>
<span id="cb8-16">            <span class="cf" style="color: #003B4F;">return</span> <span class="fl" style="color: #AD0000;">0.0</span></span>
<span id="cb8-17"></span>
<span id="cb8-18">    <span class="cf" style="color: #003B4F;">return</span> <span class="fl" style="color: #AD0000;">1.0</span><span class="op" style="color: #5E5E5E;">/</span>highest_rank <span class="cf" style="color: #003B4F;">if</span> highest_rank <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span> <span class="cf" style="color: #003B4F;">else</span> <span class="fl" style="color: #AD0000;">0.0</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.799879Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.799496Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.812780Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.812074Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.799852Z&quot;}" data-trusted="true">
<details>
<summary><code>calculate_recall</code> function</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;">def</span> calculate_recall(question, retrieved_passages, cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb9-2">    retrieved_passages <span class="op" style="color: #5E5E5E;">=</span> retrieved_passages[:cutoff]</span>
<span id="cb9-3"></span>
<span id="cb9-4">    <span class="co" style="color: #5E5E5E;"># Track if we've found at least one context for each answer component</span></span>
<span id="cb9-5">    ans_comp_found <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb9-6"></span>
<span id="cb9-7">    <span class="cf" style="color: #003B4F;">for</span> ans_comp <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">"answer_context"</span>]:</span>
<span id="cb9-8">        contexts <span class="op" style="color: #5E5E5E;">=</span> ans_comp.get(<span class="st" style="color: #20794D;">"context"</span>, [])</span>
<span id="cb9-9">        found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb9-10"></span>
<span id="cb9-11">        <span class="co" style="color: #5E5E5E;"># Check if any context for this answer component appears in retrieved passages</span></span>
<span id="cb9-12">        <span class="cf" style="color: #003B4F;">for</span> passage <span class="kw" style="color: #003B4F;">in</span> retrieved_passages:</span>
<span id="cb9-13">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">any</span>(fix_text(context) <span class="kw" style="color: #003B4F;">in</span> fix_text(passage) <span class="cf" style="color: #003B4F;">for</span> context <span class="kw" style="color: #003B4F;">in</span> contexts):</span>
<span id="cb9-14">                found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb9-15">                <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb9-16"></span>
<span id="cb9-17">        ans_comp_found.append(found)</span>
<span id="cb9-18"></span>
<span id="cb9-19">    <span class="co" style="color: #5E5E5E;"># Recall is ratio of answer components with at least one found context</span></span>
<span id="cb9-20">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">sum</span>(ans_comp_found) <span class="op" style="color: #5E5E5E;">/</span> <span class="bu" style="color: null;">len</span>(ans_comp_found)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.814669Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.813922Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.825978Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.825246Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.814632Z&quot;}" data-trusted="true">
<details>
<summary><code>load_data</code> function</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;">def</span> load_data(chunks, db_path, chapter<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb10-2">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb10-3">        <span class="co" style="color: #5E5E5E;"># create virtual table if database doesn't exist</span></span>
<span id="cb10-4">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> os.path.exists(db_path):</span>
<span id="cb10-5">            <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(db_path) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb10-6">              cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb10-7">              cur.execute(<span class="st" style="color: #20794D;">"""</span></span>
<span id="cb10-8"><span class="st" style="color: #20794D;">              CREATE VIRTUAL TABLE fastbook_text</span></span>
<span id="cb10-9"><span class="st" style="color: #20794D;">              USING FTS5(chapter, text);</span></span>
<span id="cb10-10"><span class="st" style="color: #20794D;">              """</span>)</span>
<span id="cb10-11">              conn.commit()</span>
<span id="cb10-12"></span>
<span id="cb10-13">        <span class="co" style="color: #5E5E5E;"># load in the chunks for each chapter</span></span>
<span id="cb10-14">        <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(db_path) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb10-15">            cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb10-16"></span>
<span id="cb10-17">            <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks:</span>
<span id="cb10-18">                cur.execute(<span class="st" style="color: #20794D;">"INSERT INTO fastbook_text(chapter, text) VALUES (?, ?)"</span>, (chapter, chunk))</span>
<span id="cb10-19"></span>
<span id="cb10-20">            conn.commit()</span>
<span id="cb10-21">            res <span class="op" style="color: #5E5E5E;">=</span> cur.execute(<span class="st" style="color: #20794D;">"SELECT * FROM fastbook_text WHERE chapter = ?"</span>, (chapter,)).fetchall()</span>
<span id="cb10-22">        <span class="co" style="color: #5E5E5E;"># make sure all the data was loaded into the database</span></span>
<span id="cb10-23">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">!=</span> <span class="bu" style="color: null;">len</span>(chunks):</span>
<span id="cb10-24">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(<span class="ss" style="color: #20794D;">f"Number of inserted chunks (</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(res)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">) doesn't match input chunks (</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(chunks)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">)"</span>)</span>
<span id="cb10-25"></span>
<span id="cb10-26">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb10-27"></span>
<span id="cb10-28">    <span class="cf" style="color: #003B4F;">except</span> sqlite3.Error <span class="im" style="color: #00769E;">as</span> e:</span>
<span id="cb10-29">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"An error occurred: </span><span class="sc" style="color: #5E5E5E;">{</span>e<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-30">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb10-31">    <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">Exception</span> <span class="im" style="color: #00769E;">as</span> e:</span>
<span id="cb10-32">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"An unexpected error occurred: </span><span class="sc" style="color: #5E5E5E;">{</span>e<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-33">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">False</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.828738Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.828429Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.843414Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.842734Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.828713Z&quot;}" data-trusted="true">
<details>
<summary><code>db_search</code> function</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;">def</span> db_search(df, limit<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb11-2">  results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-3">  <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(<span class="st" style="color: #20794D;">'fastbook.db'</span>) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb11-4">    cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb11-5">    <span class="co" style="color: #5E5E5E;"># concatenate the keywords into a string "keyword1 OR keyword 2 OR keyword3 ..."</span></span>
<span id="cb11-6">    <span class="cf" style="color: #003B4F;">for</span> _, row <span class="kw" style="color: #003B4F;">in</span> df.iterrows():</span>
<span id="cb11-7">      keywords <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">' OR '</span>.join([<span class="ss" style="color: #20794D;">f'"</span><span class="sc" style="color: #5E5E5E;">{</span>keyword<span class="sc" style="color: #5E5E5E;">.</span>strip(<span class="st" style="color: #20794D;">","</span>)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"'</span> <span class="cf" style="color: #003B4F;">for</span> keyword <span class="kw" style="color: #003B4F;">in</span> row[<span class="st" style="color: #20794D;">'keywords'</span>].replace(<span class="st" style="color: #20794D;">'"'</span>, <span class="st" style="color: #20794D;">''</span>).split()])</span>
<span id="cb11-8"></span>
<span id="cb11-9">      q <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"""</span></span>
<span id="cb11-10"><span class="ss" style="color: #20794D;">        SELECT text, rank</span></span>
<span id="cb11-11"><span class="ss" style="color: #20794D;">        FROM fastbook_text</span></span>
<span id="cb11-12"><span class="ss" style="color: #20794D;">        WHERE fastbook_text MATCH ?</span></span>
<span id="cb11-13"><span class="ss" style="color: #20794D;">        AND chapter = ?</span></span>
<span id="cb11-14"><span class="ss" style="color: #20794D;">        ORDER BY rank</span></span>
<span id="cb11-15"><span class="ss" style="color: #20794D;">        LIMIT ?</span></span>
<span id="cb11-16"><span class="ss" style="color: #20794D;">        """</span></span>
<span id="cb11-17">      res <span class="op" style="color: #5E5E5E;">=</span> cur.execute(q, (keywords, <span class="bu" style="color: null;">str</span>(row[<span class="st" style="color: #20794D;">'chapter'</span>]), limit)).fetchall()</span>
<span id="cb11-18">      <span class="co" style="color: #5E5E5E;"># grab the retrieved chunk from the query results</span></span>
<span id="cb11-19">      res <span class="op" style="color: #5E5E5E;">=</span> [item[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> item <span class="kw" style="color: #003B4F;">in</span> res]</span>
<span id="cb11-20"></span>
<span id="cb11-21">      <span class="co" style="color: #5E5E5E;"># if there are multiple chunks retrieved, combine them into a single string</span></span>
<span id="cb11-22">      results.append(res)</span>
<span id="cb11-23"></span>
<span id="cb11-24">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.844600Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.844324Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.857436Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.856702Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.844565Z&quot;}" data-trusted="true">
<details>
<summary><code>fts_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;">def</span> fts_retrieval(data, df, chunk_size):</span>
<span id="cb12-2">    <span class="cf" style="color: #003B4F;">if</span> os.path.exists(<span class="st" style="color: #20794D;">"fastbook.db"</span>):</span>
<span id="cb12-3">        os.remove(<span class="st" style="color: #20794D;">"fastbook.db"</span>)</span>
<span id="cb12-4"></span>
<span id="cb12-5">    <span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb12-6">        documents <span class="op" style="color: #5E5E5E;">=</span> corpus_processor.process_corpus(chunks, chunk_size<span class="op" style="color: #5E5E5E;">=</span>chunk_size)</span>
<span id="cb12-7">        documents <span class="op" style="color: #5E5E5E;">=</span> [doc[<span class="st" style="color: #20794D;">'content'</span>] <span class="cf" style="color: #003B4F;">for</span> doc <span class="kw" style="color: #003B4F;">in</span> documents]</span>
<span id="cb12-8">        <span class="cf" style="color: #003B4F;">assert</span> load_data(documents, <span class="st" style="color: #20794D;">'fastbook.db'</span>, chapter)</span>
<span id="cb12-9"></span>
<span id="cb12-10">    results <span class="op" style="color: #5E5E5E;">=</span> db_search(df, limit<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb12-11">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb12-12"></span>
<span id="cb12-13">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb12-14">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb12-15"></span>
<span id="cb12-16">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.859170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.858590Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.871005Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.870199Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.859133Z&quot;}" data-trusted="true">
<details>
<summary><code>single_vector_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;">def</span> single_vector_retrieval(data, benchmark, chunk_size):</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;"># Group questions by chapter</span></span>
<span id="cb13-3">    questions <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb13-4">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> benchmark[<span class="st" style="color: #20794D;">"questions"</span>]:</span>
<span id="cb13-5">        chapter <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(q[<span class="st" style="color: #20794D;">"chapter"</span>])</span>
<span id="cb13-6">        <span class="cf" style="color: #003B4F;">if</span> chapter <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> questions:</span>
<span id="cb13-7">            questions[chapter] <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb13-8">        questions[chapter].append(q[<span class="st" style="color: #20794D;">'question_text'</span>].strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>))</span>
<span id="cb13-9"></span>
<span id="cb13-10">    q_embs <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb13-11">    <span class="cf" style="color: #003B4F;">for</span> chapter, _ <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb13-12">        qs <span class="op" style="color: #5E5E5E;">=</span> questions[chapter]</span>
<span id="cb13-13">        q_embs[chapter] <span class="op" style="color: #5E5E5E;">=</span> emb_model.encode(qs, convert_to_tensor<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb13-14"></span>
<span id="cb13-15">    results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb13-16">    <span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb13-17">        <span class="co" style="color: #5E5E5E;"># chunk chapter text</span></span>
<span id="cb13-18">        documents <span class="op" style="color: #5E5E5E;">=</span> corpus_processor.process_corpus(chunks, chunk_size<span class="op" style="color: #5E5E5E;">=</span>chunk_size)</span>
<span id="cb13-19">        documents <span class="op" style="color: #5E5E5E;">=</span> [doc[<span class="st" style="color: #20794D;">'content'</span>] <span class="cf" style="color: #003B4F;">for</span> doc <span class="kw" style="color: #003B4F;">in</span> documents]</span>
<span id="cb13-20"></span>
<span id="cb13-21">        <span class="co" style="color: #5E5E5E;"># Embed documents</span></span>
<span id="cb13-22">        data_embs <span class="op" style="color: #5E5E5E;">=</span> emb_model.encode(documents, convert_to_tensor<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb13-23"></span>
<span id="cb13-24">        <span class="co" style="color: #5E5E5E;"># Compute cosine similarity and get top 10 indices for each row</span></span>
<span id="cb13-25">        idxs <span class="op" style="color: #5E5E5E;">=</span> F.cosine_similarity(q_embs[chapter].unsqueeze(<span class="dv" style="color: #AD0000;">1</span>), data_embs.unsqueeze(<span class="dv" style="color: #AD0000;">0</span>), dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>).sort(descending<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb13-26">        top_10_idxs <span class="op" style="color: #5E5E5E;">=</span> idxs[:, :<span class="dv" style="color: #AD0000;">10</span>]  <span class="co" style="color: #5E5E5E;"># Get the top 10 indices for each row</span></span>
<span id="cb13-27"></span>
<span id="cb13-28">        <span class="co" style="color: #5E5E5E;"># Extract top 10 chunks for each row</span></span>
<span id="cb13-29">        top_10_chunks <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb13-30">            [documents[idx.item()] <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> row_idxs]</span>
<span id="cb13-31">            <span class="cf" style="color: #003B4F;">for</span> row_idxs <span class="kw" style="color: #003B4F;">in</span> top_10_idxs</span>
<span id="cb13-32">        ]</span>
<span id="cb13-33">        results.extend(top_10_chunks)</span>
<span id="cb13-34"></span>
<span id="cb13-35">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb13-36"></span>
<span id="cb13-37">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb13-38">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb13-39"></span>
<span id="cb13-40">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.872282Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.872001Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.886865Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.886203Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.872258Z&quot;}" data-trusted="true">
<details>
<summary><code>index_free_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;">def</span> index_free_retrieval(data, model_nm, chunk_size, benchmark):</span>
<span id="cb14-2">    questions_by_chapter <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb14-3">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> benchmark[<span class="st" style="color: #20794D;">"questions"</span>]:</span>
<span id="cb14-4">        chapter <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(q[<span class="st" style="color: #20794D;">"chapter"</span>])</span>
<span id="cb14-5">        <span class="cf" style="color: #003B4F;">if</span> chapter <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> questions_by_chapter:</span>
<span id="cb14-6">            questions_by_chapter[chapter] <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-7">        questions_by_chapter[chapter].append(q)</span>
<span id="cb14-8"></span>
<span id="cb14-9">    <span class="co" style="color: #5E5E5E;"># Dictionary to store results per chapter</span></span>
<span id="cb14-10">    chapter_results <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb14-11"></span>
<span id="cb14-12">    <span class="co" style="color: #5E5E5E;"># Process each chapter separately</span></span>
<span id="cb14-13">    <span class="cf" style="color: #003B4F;">for</span> chapter <span class="kw" style="color: #003B4F;">in</span> nbs.keys():</span>
<span id="cb14-14">        <span class="co" style="color: #5E5E5E;"># instantiate new RAG object</span></span>
<span id="cb14-15">        RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(model_nm)</span>
<span id="cb14-16"></span>
<span id="cb14-17">        <span class="co" style="color: #5E5E5E;"># Get questions for this chapter</span></span>
<span id="cb14-18">        chapter_questions <span class="op" style="color: #5E5E5E;">=</span> questions_by_chapter[chapter]</span>
<span id="cb14-19"></span>
<span id="cb14-20">        <span class="co" style="color: #5E5E5E;"># encode chapter documents</span></span>
<span id="cb14-21">        documents <span class="op" style="color: #5E5E5E;">=</span> corpus_processor.process_corpus(data[chapter], chunk_size<span class="op" style="color: #5E5E5E;">=</span>chunk_size)</span>
<span id="cb14-22">        RAG.encode([x[<span class="st" style="color: #20794D;">'content'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> documents], document_metadatas<span class="op" style="color: #5E5E5E;">=</span>[{<span class="st" style="color: #20794D;">"chapter"</span>: chapter} <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(documents))])</span>
<span id="cb14-23"></span>
<span id="cb14-24">        <span class="co" style="color: #5E5E5E;"># Perform retrieval for each question in this chapter</span></span>
<span id="cb14-25">        results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-26">        <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> chapter_questions:</span>
<span id="cb14-27">            top_k <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(<span class="dv" style="color: #AD0000;">10</span>, <span class="bu" style="color: null;">len</span>(documents))</span>
<span id="cb14-28">            retrieved <span class="op" style="color: #5E5E5E;">=</span> RAG.search_encoded_docs(query <span class="op" style="color: #5E5E5E;">=</span> q[<span class="st" style="color: #20794D;">"question_text"</span>].strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>), k<span class="op" style="color: #5E5E5E;">=</span>top_k)</span>
<span id="cb14-29">            results.append(retrieved)</span>
<span id="cb14-30"></span>
<span id="cb14-31">        <span class="co" style="color: #5E5E5E;"># Store results</span></span>
<span id="cb14-32">        chapter_results[chapter] <span class="op" style="color: #5E5E5E;">=</span> results</span>
<span id="cb14-33"></span>
<span id="cb14-34">    results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-35">    <span class="cf" style="color: #003B4F;">for</span> chapter, res <span class="kw" style="color: #003B4F;">in</span> chapter_results.items():</span>
<span id="cb14-36">        results.extend(res)</span>
<span id="cb14-37"></span>
<span id="cb14-38">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb14-39"></span>
<span id="cb14-40">    final_results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-41">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb14-42">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb14-43">        intermediate_results <span class="op" style="color: #5E5E5E;">=</span> [r[<span class="st" style="color: #20794D;">'content'</span>] <span class="cf" style="color: #003B4F;">for</span> r <span class="kw" style="color: #003B4F;">in</span> res]</span>
<span id="cb14-44">        final_results.append(intermediate_results)</span>
<span id="cb14-45"></span>
<span id="cb14-46">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(final_results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb14-47">    <span class="cf" style="color: #003B4F;">return</span> final_results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.887930Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.887716Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.900132Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.899389Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.887908Z&quot;}" data-trusted="true">
<details>
<summary><code>do_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;">def</span> do_retrieval(method, chunk_size, data, benchmark, questions<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>, benchmark_results<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb15-2">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"bm25"</span>: results <span class="op" style="color: #5E5E5E;">=</span> fts_retrieval(data, questions, chunk_size)</span>
<span id="cb15-3">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"single_vector"</span>: results <span class="op" style="color: #5E5E5E;">=</span> single_vector_retrieval(data, benchmark, chunk_size)</span>
<span id="cb15-4">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"colbertv2"</span>: results <span class="op" style="color: #5E5E5E;">=</span> index_free_retrieval(data<span class="op" style="color: #5E5E5E;">=</span>data, model_nm<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbert-ir/colbertv2.0"</span>, chunk_size<span class="op" style="color: #5E5E5E;">=</span>chunk_size, benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark)</span>
<span id="cb15-5">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"answerai_colbert"</span>: results <span class="op" style="color: #5E5E5E;">=</span> index_free_retrieval(data<span class="op" style="color: #5E5E5E;">=</span>data, model_nm<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerdotai/answerai-colbert-small-v1"</span>, chunk_size<span class="op" style="color: #5E5E5E;">=</span>chunk_size, benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark)</span>
<span id="cb15-6"></span>
<span id="cb15-7">  <span class="co" style="color: #5E5E5E;">#name = f"{method}_{chunking_strategy}"</span></span>
<span id="cb15-8">  q_mrr, q_recall <span class="op" style="color: #5E5E5E;">=</span> score_retrieval(results, benchmark)</span>
<span id="cb15-9">  <span class="co" style="color: #5E5E5E;">#benchmark_results = save_results(results, benchmark_results, q_mrr, q_recall, name=name)</span></span>
<span id="cb15-10"></span>
<span id="cb15-11">  <span class="cf" style="color: #003B4F;">return</span> pd.Series(q_mrr).mean(), pd.Series(q_recall).mean()</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.901370Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.901123Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.913227Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.912491Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.901347Z&quot;}" data-trusted="true">
<details>
<summary><code>score_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;">def</span> score_retrieval(results, benchmark):</span>
<span id="cb16-2">    q_mrr <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb16-3">    q_recall <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb16-4"></span>
<span id="cb16-5">    <span class="cf" style="color: #003B4F;">for</span> i, question <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(benchmark[<span class="st" style="color: #20794D;">"questions"</span>]):</span>
<span id="cb16-6">        mrr <span class="op" style="color: #5E5E5E;">=</span> calculate_mrr(question, results[i], cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb16-7">        recall <span class="op" style="color: #5E5E5E;">=</span> calculate_recall(question, results[i], cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb16-8">        q_mrr.append(mrr)</span>
<span id="cb16-9">        q_recall.append(recall)</span>
<span id="cb16-10"></span>
<span id="cb16-11">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(q_mrr) <span class="op" style="color: #5E5E5E;">==</span> <span class="bu" style="color: null;">len</span>(benchmark[<span class="st" style="color: #20794D;">"questions"</span>])</span>
<span id="cb16-12">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(q_recall) <span class="op" style="color: #5E5E5E;">==</span> <span class="bu" style="color: null;">len</span>(benchmark[<span class="st" style="color: #20794D;">"questions"</span>])</span>
<span id="cb16-13"></span>
<span id="cb16-14">    <span class="cf" style="color: #003B4F;">return</span> q_mrr, q_recall</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.914264Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.914042Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.924181Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.923516Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.914242Z&quot;}" data-trusted="true">
<details>
<summary><code>save_results</code> function</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;">def</span> save_results(results, df, q_mrr, q_recall, name):</span>
<span id="cb17-2">    flat_results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb17-3">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb17-4">        flat_results.append(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">"</span>.join(res))</span>
<span id="cb17-5"></span>
<span id="cb17-6">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(flat_results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb17-7"></span>
<span id="cb17-8">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_retrieval'</span>] <span class="op" style="color: #5E5E5E;">=</span> flat_results</span>
<span id="cb17-9">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_mrr10'</span>] <span class="op" style="color: #5E5E5E;">=</span> q_mrr</span>
<span id="cb17-10">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_recall10'</span>] <span class="op" style="color: #5E5E5E;">=</span> q_recall</span>
<span id="cb17-11"></span>
<span id="cb17-12">    <span class="cf" style="color: #003B4F;">return</span> df</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.925325Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.925090Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.935453Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.934718Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.925302Z&quot;}" data-trusted="true">
<details>
<summary><code>notebook_to_string</code> function</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;">def</span> notebook_to_string(path):</span>
<span id="cb18-2">  <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(path, <span class="st" style="color: #20794D;">'r'</span>, encoding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'utf-8'</span>) <span class="im" style="color: #00769E;">as</span> f:</span>
<span id="cb18-3">    notebook <span class="op" style="color: #5E5E5E;">=</span> json.load(f)</span>
<span id="cb18-4"></span>
<span id="cb18-5">  all_text <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span></span>
<span id="cb18-6">  found_questionnaire <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb18-7"></span>
<span id="cb18-8">  <span class="cf" style="color: #003B4F;">for</span> cell <span class="kw" style="color: #003B4F;">in</span> notebook[<span class="st" style="color: #20794D;">'cells'</span>]:</span>
<span id="cb18-9">    <span class="cf" style="color: #003B4F;">if</span> cell[<span class="st" style="color: #20794D;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'markdown'</span> <span class="kw" style="color: #003B4F;">and</span> <span class="bu" style="color: null;">any</span>(<span class="st" style="color: #20794D;">'## Questionnaire'</span> <span class="kw" style="color: #003B4F;">in</span> line <span class="cf" style="color: #003B4F;">for</span> line <span class="kw" style="color: #003B4F;">in</span> cell[<span class="st" style="color: #20794D;">'source'</span>]):</span>
<span id="cb18-10">      found_questionnaire <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb18-11">      <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb18-12"></span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;">if</span> cell[<span class="st" style="color: #20794D;">'cell_type'</span>] <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'markdown'</span>, <span class="st" style="color: #20794D;">'code'</span>]:</span>
<span id="cb18-14">      all_text <span class="op" style="color: #5E5E5E;">+=</span> <span class="st" style="color: #20794D;">''</span>.join(cell[<span class="st" style="color: #20794D;">'source'</span>]) <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span></span>
<span id="cb18-15">  <span class="cf" style="color: #003B4F;">return</span> all_text</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.937125Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.936441Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.946918Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.946355Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.937089Z&quot;}" data-trusted="true">
<details>
<summary><code>chunk_string</code> function</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;">def</span> chunk_string(text, n):</span>
<span id="cb19-2">    <span class="co" style="color: #5E5E5E;">"""Split text into n chunks."""</span></span>
<span id="cb19-3">    skip <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(<span class="bu" style="color: null;">len</span>(text) <span class="op" style="color: #5E5E5E;">/</span> n)</span>
<span id="cb19-4">    <span class="cf" style="color: #003B4F;">return</span> [text[i:i <span class="op" style="color: #5E5E5E;">+</span> skip] <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="bu" style="color: null;">len</span>(text), skip)]</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.947888Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.947679Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.956866Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.956184Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.947866Z&quot;}" data-trusted="true">
<details>
<summary><code>clean_html</code> function</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;">def</span> clean_html(text):</span>
<span id="cb20-2">    <span class="co" style="color: #5E5E5E;"># Step 1: Temporarily replace double-bracketed content with a placeholder</span></span>
<span id="cb20-3">    <span class="im" style="color: #00769E;">import</span> uuid</span>
<span id="cb20-4">    placeholder <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"PLACEHOLDER_</span><span class="sc" style="color: #5E5E5E;">{</span>uuid<span class="sc" style="color: #5E5E5E;">.</span>uuid4()<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span>
<span id="cb20-5">    double_bracketed <span class="op" style="color: #5E5E5E;">=</span> re.findall(<span class="vs" style="color: #20794D;">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, text)</span>
<span id="cb20-6">    step1 <span class="op" style="color: #5E5E5E;">=</span> re.sub(<span class="vs" style="color: #20794D;">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, placeholder, text)</span>
<span id="cb20-7"></span>
<span id="cb20-8">    <span class="co" style="color: #5E5E5E;"># Step 2: Remove HTML tags</span></span>
<span id="cb20-9">    step2 <span class="op" style="color: #5E5E5E;">=</span> re.sub(<span class="vs" style="color: #20794D;">r'&lt;[/]?[a-zA-Z][^&gt;]*&gt;'</span>, <span class="st" style="color: #20794D;">''</span>, step1)</span>
<span id="cb20-10"></span>
<span id="cb20-11">    <span class="co" style="color: #5E5E5E;"># Step 3: Restore double-bracketed content</span></span>
<span id="cb20-12">    <span class="cf" style="color: #003B4F;">if</span> double_bracketed:</span>
<span id="cb20-13">        step3 <span class="op" style="color: #5E5E5E;">=</span> step2.replace(placeholder, double_bracketed[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb20-14">        <span class="cf" style="color: #003B4F;">return</span> step3</span>
<span id="cb20-15">    <span class="cf" style="color: #003B4F;">return</span> step2</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.958034Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.957806Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.966934Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.966284Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.958012Z&quot;}" data-trusted="true">
<details>
<summary><code>remove_punctuation</code> function</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;">def</span> remove_punctuation(text):</span>
<span id="cb21-2">    <span class="im" style="color: #00769E;">import</span> string</span>
<span id="cb21-3">    <span class="cf" style="color: #003B4F;">return</span> <span class="st" style="color: #20794D;">''</span>.join(char <span class="cf" style="color: #003B4F;">if</span> char.isalnum() <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">' '</span> <span class="cf" style="color: #003B4F;">if</span> char <span class="kw" style="color: #003B4F;">in</span> string.punctuation <span class="cf" style="color: #003B4F;">else</span> char <span class="cf" style="color: #003B4F;">for</span> char <span class="kw" style="color: #003B4F;">in</span> text)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.968107Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.967856Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:07.976869Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:07.976069Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.968083Z&quot;}" data-trusted="true">
<details>
<summary><code>process_contexts</code> function</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;">def</span> process_contexts(data):</span>
<span id="cb22-2">    <span class="co" style="color: #5E5E5E;"># Process questions</span></span>
<span id="cb22-3">    <span class="cf" style="color: #003B4F;">for</span> question <span class="kw" style="color: #003B4F;">in</span> data[<span class="st" style="color: #20794D;">'questions'</span>]:</span>
<span id="cb22-4">        <span class="co" style="color: #5E5E5E;"># Process only answer_context</span></span>
<span id="cb22-5">        <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'answer_context'</span> <span class="kw" style="color: #003B4F;">in</span> question:</span>
<span id="cb22-6">            <span class="cf" style="color: #003B4F;">for</span> context_item <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">'answer_context'</span>]:</span>
<span id="cb22-7">                <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'context'</span> <span class="kw" style="color: #003B4F;">in</span> context_item:</span>
<span id="cb22-8">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(context_item[<span class="st" style="color: #20794D;">'context'</span>], <span class="bu" style="color: null;">list</span>):</span>
<span id="cb22-9">                        <span class="co" style="color: #5E5E5E;"># If context is a list, process each string in the list</span></span>
<span id="cb22-10">                        context_item[<span class="st" style="color: #20794D;">'context'</span>] <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb22-11">                            remove_punctuation(text) <span class="cf" style="color: #003B4F;">if</span> text <span class="cf" style="color: #003B4F;">else</span> text</span>
<span id="cb22-12">                            <span class="cf" style="color: #003B4F;">for</span> text <span class="kw" style="color: #003B4F;">in</span> context_item[<span class="st" style="color: #20794D;">'context'</span>]</span>
<span id="cb22-13">                        ]</span>
<span id="cb22-14">                    <span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(context_item[<span class="st" style="color: #20794D;">'context'</span>], <span class="bu" style="color: null;">str</span>):</span>
<span id="cb22-15">                        <span class="co" style="color: #5E5E5E;"># If context is a single string, process it directly</span></span>
<span id="cb22-16">                        context_item[<span class="st" style="color: #20794D;">'context'</span>] <span class="op" style="color: #5E5E5E;">=</span> remove_punctuation(context_item[<span class="st" style="color: #20794D;">'context'</span>])</span>
<span id="cb22-17"></span>
<span id="cb22-18">    <span class="cf" style="color: #003B4F;">return</span> data</span></code></pre></div>
</details>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook, I evaluate four retrieval methods on my fastbook-benchmark dataset using various chunk sizes:</p>
<ul>
<li>Full text search (using sqlite and Claude-generated keywords).</li>
<li>Single-vector cosine similarity (using <code>SentenceTransformer("BAAI/bge-small-en-v1.5")</code>).</li>
<li>ColBERTv2 (using ragatouille).</li>
<li>answerai-colbert-small-v1 (ragatouille).</li>
</ul>
<p>For each retrieval method, I’m looking to find the best MRR@10 and Recall@10 for three chunk size ranges:</p>
<ul>
<li>Small: 100-500 tokens</li>
<li>Medium: 500-1000 tokens</li>
<li>Large: 1000+ tokens</li>
</ul>
<p>I chose these ranges based on trends I saw during some experiments I ran with ColBERTv2 and answerai-colbert-small-v1 for a chunk size range of 100-3000 tokens.</p>
<p>I’m using <code>corpus_processor.process_corpus</code> for chunking.</p>
</section>
<section id="data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing">Data Preprocessing</h2>
<p>For each retrieval method/chunk size combination, I’ll preprocess my data three ways:</p>
<ul>
<li>No preprocessing.</li>
<li>Remove HTML tags.</li>
<li>Remove punctuation.</li>
</ul>
<p>Note that in each case, I am first converting the <code>.ipynb</code> for each chapter into a single string and splitting them into 2-3 chunks since for full-length texts were causing OOM during ColBERTv2 encoding.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:07.990323Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:07.990007Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:08.029468Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:08.028908Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:07.990288Z&quot;}" data-trusted="true" data-execution_count="23">
<details>
<summary>Prep <code>no preprocessing</code> dataset</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">data_no_pp <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb23-2">n_chars <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb23-3"></span>
<span id="cb23-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb23-5">    data_no_pp[chapter] <span class="op" style="color: #5E5E5E;">=</span> chunk_string(notebook_to_string(nb), <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb23-6">    <span class="cf" style="color: #003B4F;">for</span> c <span class="kw" style="color: #003B4F;">in</span> data_no_pp[chapter]:</span>
<span id="cb23-7">        n_chars <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(c)</span>
<span id="cb23-8"></span>
<span id="cb23-9"><span class="cf" style="color: #003B4F;">assert</span> n_chars <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">503769</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:08.030689Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:08.030342Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:08.039049Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:08.038342Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:08.030653Z&quot;}" data-trusted="true" data-execution_count="24">
<details>
<summary>Prep <code>no HTML</code> dataset</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">data_no_html <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb24-2"></span>
<span id="cb24-3">n_chars <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb24-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb24-5">    data_no_html[chapter] <span class="op" style="color: #5E5E5E;">=</span> chunk_string(notebook_to_string(nb), <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb24-6">    <span class="cf" style="color: #003B4F;">for</span> c <span class="kw" style="color: #003B4F;">in</span> data_no_html[chapter]:</span>
<span id="cb24-7">        n_chars <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(c)</span>
<span id="cb24-8"></span>
<span id="cb24-9"><span class="cf" style="color: #003B4F;">assert</span> n_chars <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">503769</span></span>
<span id="cb24-10"></span>
<span id="cb24-11">n_chars <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb24-12"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data_no_html.items():</span>
<span id="cb24-13">    data_no_html[chapter] <span class="op" style="color: #5E5E5E;">=</span> [clean_html(chunk) <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks]</span>
<span id="cb24-14">    <span class="cf" style="color: #003B4F;">for</span> string <span class="kw" style="color: #003B4F;">in</span> data_no_html[chapter]: n_chars <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(string)</span>
<span id="cb24-15"></span>
<span id="cb24-16"><span class="cf" style="color: #003B4F;">assert</span> n_chars <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">493604</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-28T13:36:08.040141Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-28T13:36:08.039913Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-28T13:36:08.129082Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-28T13:36:08.128486Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-28T13:36:08.040118Z&quot;}" data-trusted="true" data-execution_count="25">
<details>
<summary>Prep <code>no punctuation</code> dataset</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">data_no_punc <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb25-2"></span>
<span id="cb25-3">n_chars <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb25-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb25-5">    data_no_punc[chapter] <span class="op" style="color: #5E5E5E;">=</span> chunk_string(notebook_to_string(nb), <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb25-6">    <span class="cf" style="color: #003B4F;">for</span> c <span class="kw" style="color: #003B4F;">in</span> data_no_punc[chapter]:</span>
<span id="cb25-7">        n_chars <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(c)</span>
<span id="cb25-8"></span>
<span id="cb25-9"><span class="cf" style="color: #003B4F;">assert</span> n_chars <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">503769</span></span>
<span id="cb25-10"></span>
<span id="cb25-11">n_chars <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb25-12"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data_no_punc.items():</span>
<span id="cb25-13">    data_no_punc[chapter] <span class="op" style="color: #5E5E5E;">=</span> [remove_punctuation(chunk) <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks]</span>
<span id="cb25-14">    <span class="cf" style="color: #003B4F;">for</span> string <span class="kw" style="color: #003B4F;">in</span> data_no_punc[chapter]: n_chars <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(string)</span>
<span id="cb25-15"></span>
<span id="cb25-16"><span class="co" style="color: #5E5E5E;"># we are replacing punctuation with single space so n_chars doesn't change</span></span>
<span id="cb25-17"><span class="cf" style="color: #003B4F;">assert</span> n_chars <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">503769</span></span></code></pre></div>
</details>
</div>
</section>
<section id="benchmark-dataset" class="level2">
<h2 class="anchored" data-anchor-id="benchmark-dataset">Benchmark Dataset</h2>
<div class="cell" data-trusted="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">benchmark <span class="op" style="color: #5E5E5E;">=</span> load_benchmark()</span>
<span id="cb26-2"><span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(benchmark[<span class="st" style="color: #20794D;">'questions'</span>]) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb26-3"></span>
<span id="cb26-4">processed_benchmark <span class="op" style="color: #5E5E5E;">=</span> process_contexts(benchmark)</span>
<span id="cb26-5"><span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(processed_benchmark[<span class="st" style="color: #20794D;">'questions'</span>]) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span></code></pre></div>
</div>
</section>
<section id="running-retrieval-100-2000-token-chunks" class="level2">
<h2 class="anchored" data-anchor-id="running-retrieval-100-2000-token-chunks">Running Retrieval (100-2000 token chunks)</h2>
<div class="cell" data-outputid="5cd7551c-7df0-480a-fc61-07f3c155239c" data-execution_count="28">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;">from</span> google.colab <span class="im" style="color: #00769E;">import</span> drive</span>
<span id="cb27-2">drive.mount(<span class="st" style="color: #20794D;">'/content/drive'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive</code></pre>
</div>
</div>
<section id="data-no-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="data-no-preprocessing">Data: No Preprocessing</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="cf" style="color: #003B4F;">for</span> method <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">"bm25"</span>, <span class="st" style="color: #20794D;">"single_vector"</span>, <span class="st" style="color: #20794D;">"colbertv2"</span>, <span class="st" style="color: #20794D;">"answerai_colbert"</span>]:</span>
<span id="cb29-4">  <span class="cf" style="color: #003B4F;">for</span> chunk_size <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">100</span>, <span class="dv" style="color: #AD0000;">2100</span>, <span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb29-5">    mrr, recall <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(method, chunk_size, data_no_pp, load_benchmark(), questions)</span>
<span id="cb29-6">    results.append((<span class="st" style="color: #20794D;">'no preprocessing'</span>, method, chunk_size, mrr, recall))</span>
<span id="cb29-7"></span>
<span id="cb29-8">df <span class="op" style="color: #5E5E5E;">=</span> pd.DataFrame(results, columns<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'data'</span>, <span class="st" style="color: #20794D;">'method'</span>, <span class="st" style="color: #20794D;">'chunk_size'</span>, <span class="st" style="color: #20794D;">'MRR@10'</span>, <span class="st" style="color: #20794D;">'Recall@10'</span>])</span>
<span id="cb29-9">df.to_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no preprocessing.csv"</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="data-no-html-tags" class="level3">
<h3 class="anchored" data-anchor-id="data-no-html-tags">Data: No HTML Tags</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="cf" style="color: #003B4F;">for</span> method <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">"bm25"</span>, <span class="st" style="color: #20794D;">"single_vector"</span>, <span class="st" style="color: #20794D;">"colbertv2"</span>, <span class="st" style="color: #20794D;">"answerai_colbert"</span>]:</span>
<span id="cb30-4">  <span class="cf" style="color: #003B4F;">for</span> chunk_size <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">100</span>, <span class="dv" style="color: #AD0000;">2100</span>, <span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb30-5">    mrr, recall <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(method, chunk_size, data_no_html, load_benchmark(), questions)</span>
<span id="cb30-6">    results.append((<span class="st" style="color: #20794D;">'no HTML'</span>, method, chunk_size, mrr, recall))</span>
<span id="cb30-7"></span>
<span id="cb30-8">df <span class="op" style="color: #5E5E5E;">=</span> pd.DataFrame(results, columns<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'data'</span>, <span class="st" style="color: #20794D;">'method'</span>, <span class="st" style="color: #20794D;">'chunk_size'</span>, <span class="st" style="color: #20794D;">'MRR@10'</span>, <span class="st" style="color: #20794D;">'Recall@10'</span>])</span>
<span id="cb30-9">df.to_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no HTML.csv"</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="data-no-punctuation" class="level3">
<h3 class="anchored" data-anchor-id="data-no-punctuation">Data: No Punctuation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="cf" style="color: #003B4F;">for</span> method <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">"bm25"</span>, <span class="st" style="color: #20794D;">"single_vector"</span>, <span class="st" style="color: #20794D;">"colbertv2"</span>, <span class="st" style="color: #20794D;">"answerai_colbert"</span>]:</span>
<span id="cb31-4">  <span class="cf" style="color: #003B4F;">for</span> chunk_size <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">100</span>, <span class="dv" style="color: #AD0000;">2100</span>, <span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb31-5">    mrr, recall <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(method, chunk_size, data_no_punc, process_contexts(benchmark), questions)</span>
<span id="cb31-6">    results.append((<span class="st" style="color: #20794D;">'no punctuation'</span>, method, chunk_size, mrr, recall))</span>
<span id="cb31-7"></span>
<span id="cb31-8">df <span class="op" style="color: #5E5E5E;">=</span> pd.DataFrame(results, columns<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'data'</span>, <span class="st" style="color: #20794D;">'method'</span>, <span class="st" style="color: #20794D;">'chunk_size'</span>, <span class="st" style="color: #20794D;">'MRR@10'</span>, <span class="st" style="color: #20794D;">'Recall@10'</span>])</span>
<span id="cb31-9">df.to_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no punctuation.csv"</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="analyzing-results" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-results">Analyzing Results</h2>
<div class="cell" data-outputid="3c4780a2-0223-469a-8b56-b2f50ef92949" data-execution_count="195">
<details>
<summary>Load saved results CSVs</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">no_pp <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no preprocessing.csv"</span>)</span>
<span id="cb32-2">no_html <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no HTML.csv"</span>)</span>
<span id="cb32-3">no_punc <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">"/content/drive/MyDrive/2024-11-29-fastbook-benchmark-results_no punctuation.csv"</span>)</span>
<span id="cb32-4">df <span class="op" style="color: #5E5E5E;">=</span> pd.concat([no_pp, no_html, no_punc])</span>
<span id="cb32-5">df.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="195">
<pre><code>(240, 5)</code></pre>
</div>
</div>
<section id="best-overall-mrr10" class="level3">
<h3 class="anchored" data-anchor-id="best-overall-mrr10">Best Overall MRR@10</h3>
<p>Surprisingly, full text search had the highest-overall MRR@10 with 0.67 for 2000-token chunks, for text with punctuation removed.</p>
<div class="cell" data-outputid="966b62a2-8407-45be-8f1e-6ed74042077f" data-execution_count="32">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">df[df[<span class="st" style="color: #20794D;">'MRR@10'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'MRR@10'</span>].<span class="bu" style="color: null;">max</span>()]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">


  <div id="df-ea293031-af15-4fcd-bb00-77b780978cbb" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data</th>
      <th>method</th>
      <th>chunk_size</th>
      <th>MRR@10</th>
      <th>Recall@10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19</th>
      <td>no punctuation</td>
      <td>bm25</td>
      <td>2000</td>
      <td>0.668046</td>
      <td>0.94315</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-ea293031-af15-4fcd-bb00-77b780978cbb')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-ea293031-af15-4fcd-bb00-77b780978cbb button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-ea293031-af15-4fcd-bb00-77b780978cbb');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    </div>
  </div>
</div>
</div>
</section>
<section id="best-overall-recall10" class="level3">
<h3 class="anchored" data-anchor-id="best-overall-recall10">Best Overall Recall@10</h3>
<p>Full text search also yielded the best overall Recall@10 at 95%, also at a chunk size of 2000 tokens, but for text with no preprocessing on it (other than splitting the notebook into 2-3 chunks). Wow!</p>
<div class="cell" data-outputid="52b55409-0b36-4a53-c9f0-8e77a5de3b4f" data-execution_count="33">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">df[df[<span class="st" style="color: #20794D;">'Recall@10'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'Recall@10'</span>].<span class="bu" style="color: null;">max</span>()]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">


  <div id="df-27ff4a6e-ae12-430a-8b49-93dbfd0a6221" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data</th>
      <th>method</th>
      <th>chunk_size</th>
      <th>MRR@10</th>
      <th>Recall@10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19</th>
      <td>no preprocessing</td>
      <td>bm25</td>
      <td>2000</td>
      <td>0.658541</td>
      <td>0.95493</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-27ff4a6e-ae12-430a-8b49-93dbfd0a6221')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-27ff4a6e-ae12-430a-8b49-93dbfd0a6221 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-27ff4a6e-ae12-430a-8b49-93dbfd0a6221');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    </div>
  </div>
</div>
</div>
</section>
<section id="analyzing-metrics-by-chunk-size-range" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-metrics-by-chunk-size-range">Analyzing Metrics by Chunk Size Range</h3>
<p>I care about chunk size because eventually I am going to pass on the retrieved context to an LLM for answer generation and context size will dictate latency and potentially performance.</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">df[<span class="st" style="color: #20794D;">'category'</span>] <span class="op" style="color: #5E5E5E;">=</span> pd.cut(df[<span class="st" style="color: #20794D;">'chunk_size'</span>], bins<span class="op" style="color: #5E5E5E;">=</span>[<span class="dv" style="color: #AD0000;">100</span>, <span class="dv" style="color: #AD0000;">500</span>, <span class="dv" style="color: #AD0000;">1000</span>, <span class="dv" style="color: #AD0000;">2000</span>], labels<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'small'</span>, <span class="st" style="color: #20794D;">'medium'</span>, <span class="st" style="color: #20794D;">'large'</span>], include_lowest<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
</div>
<section id="mrr10" class="level4">
<h4 class="anchored" data-anchor-id="mrr10">MRR@10</h4>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Chunk Size Category</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">MRR@10</th>
<th style="text-align: center;">Chunk Size</th>
<th style="text-align: center;">Dataset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Small (100-500 tokens)</td>
<td style="text-align: center;">answer-colbert-small-v1</td>
<td style="text-align: center;">0.59</td>
<td style="text-align: center;">500 tokens</td>
<td style="text-align: center;">No punctuation</td>
</tr>
<tr class="even">
<td style="text-align: center;">Medium (501-1000 tokens)</td>
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">0.61</td>
<td style="text-align: center;">600 tokens</td>
<td style="text-align: center;">No punctuation</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Large (1001-2000 tokens)</td>
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.67</td>
<td style="text-align: center;">2000 tokens</td>
<td style="text-align: center;">No punctuation</td>
</tr>
</tbody>
</table>
<p>Interesting to note:</p>
<ul>
<li>600 tokens was the best-performing chunk size for medium chunks.</li>
<li>In all three cases, text without punctuation resulted in the best MRR@10.</li>
</ul>
</section>
<section id="recall10" class="level4">
<h4 class="anchored" data-anchor-id="recall10">Recall@10</h4>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Chunk Size Category</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">Recall@10</th>
<th style="text-align: center;">Chunk Size</th>
<th style="text-align: center;">Data</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Small (100-500 tokens)</td>
<td style="text-align: center;">answer-colbert-small-v1</td>
<td style="text-align: center;">0.88</td>
<td style="text-align: center;">500 tokens</td>
<td style="text-align: center;">No punctuation</td>
</tr>
<tr class="even">
<td style="text-align: center;">Medium (501-1000 tokens)</td>
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.92</td>
<td style="text-align: center;">1000 tokens</td>
<td style="text-align: center;">No preprocessing</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Large (1001-2000 tokens)</td>
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.95</td>
<td style="text-align: center;">2000 tokens</td>
<td style="text-align: center;">No preprocessing</td>
</tr>
</tbody>
</table>
<p>Interesting to note:</p>
<ul>
<li>The highest chunk size in each range yielded the best MRR@10.</li>
<li>Text without punctuation worked best for small chunks while unprocessed text worked best for medium and large chunks.</li>
</ul>
</section>
</section>
<section id="visualizing-metrics-by-chunk-size-and-method" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-metrics-by-chunk-size-and-method">Visualizing Metrics by Chunk Size and Method</h3>
<div class="cell" data-execution_count="162">
<details>
<summary>Show <code>plot_metrics</code> function</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;">def</span> plot_metrics(df, metric<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"MRR@10"</span>):</span>
<span id="cb37-2">  plt.style.use(<span class="st" style="color: #20794D;">'seaborn-v0_8-bright'</span>)</span>
<span id="cb37-3">  fig, axs <span class="op" style="color: #5E5E5E;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">3</span>, figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">20</span>, <span class="dv" style="color: #AD0000;">6</span>))</span>
<span id="cb37-4">  colors <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">'#268BD2'</span>, <span class="st" style="color: #20794D;">'#DC322F'</span>, <span class="st" style="color: #20794D;">'#859900'</span>, <span class="st" style="color: #20794D;">'#6C71C4'</span>]</span>
<span id="cb37-5"></span>
<span id="cb37-6">  <span class="cf" style="color: #003B4F;">for</span> i, dataset <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>([<span class="st" style="color: #20794D;">'no preprocessing'</span>, <span class="st" style="color: #20794D;">'no HTML'</span>, <span class="st" style="color: #20794D;">'no punctuation'</span>]):</span>
<span id="cb37-7">    data_df <span class="op" style="color: #5E5E5E;">=</span> df[df[<span class="st" style="color: #20794D;">'data'</span>] <span class="op" style="color: #5E5E5E;">==</span> dataset]</span>
<span id="cb37-8"></span>
<span id="cb37-9">    <span class="cf" style="color: #003B4F;">for</span> j, method <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(<span class="bu" style="color: null;">sorted</span>(data_df[<span class="st" style="color: #20794D;">'method'</span>].unique())):</span>
<span id="cb37-10">      method_data <span class="op" style="color: #5E5E5E;">=</span> data_df[data_df[<span class="st" style="color: #20794D;">'method'</span>] <span class="op" style="color: #5E5E5E;">==</span> method]</span>
<span id="cb37-11">      axs[i].plot(method_data[<span class="st" style="color: #20794D;">'chunk_size'</span>], method_data[metric],</span>
<span id="cb37-12">                        linestyle<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb37-13">                        color<span class="op" style="color: #5E5E5E;">=</span>colors[j],</span>
<span id="cb37-14">                        label<span class="op" style="color: #5E5E5E;">=</span>method)</span>
<span id="cb37-15">      <span class="co" style="color: #5E5E5E;">#axs[i].scatter(method_data['chunk_size'], method_data[metric], color=colors[j], s=25)</span></span>
<span id="cb37-16"></span>
<span id="cb37-17">      axs[i].set_xlabel(<span class="st" style="color: #20794D;">'Chunk Size (Tokens)'</span>, fontsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">14</span>)</span>
<span id="cb37-18">      axs[i].set_ylabel(<span class="st" style="color: #20794D;">'Score'</span> <span class="cf" style="color: #003B4F;">if</span> i <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span> <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">''</span>, fontsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">14</span>)</span>
<span id="cb37-19">      axs[i].set_title(dataset.replace(<span class="st" style="color: #20794D;">'no '</span>, <span class="st" style="color: #20794D;">'No '</span>), fontsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">16</span>, pad<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb37-20">      axs[i].tick_params(axis<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'both'</span>, labelsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">14</span>)</span>
<span id="cb37-21">      axs[i].grid(<span class="va" style="color: #111111;">True</span>, alpha<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.8</span>)</span>
<span id="cb37-22">      axs[i].set_xlim(<span class="dv" style="color: #AD0000;">50</span>, <span class="dv" style="color: #AD0000;">2050</span>)</span>
<span id="cb37-23">      <span class="cf" style="color: #003B4F;">if</span> metric <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'MRR@10'</span>: axs[i].set_ylim(<span class="fl" style="color: #AD0000;">0.15</span>, <span class="fl" style="color: #AD0000;">0.7</span>)</span>
<span id="cb37-24">      <span class="cf" style="color: #003B4F;">else</span>: axs[i].set_ylim(<span class="fl" style="color: #AD0000;">0.4</span>, <span class="fl" style="color: #AD0000;">1.0</span>)</span>
<span id="cb37-25">  handles, labels <span class="op" style="color: #5E5E5E;">=</span> axs[<span class="dv" style="color: #AD0000;">0</span>].get_legend_handles_labels()</span>
<span id="cb37-26">  fig.legend(handles, labels, loc<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'right'</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;">=</span>(<span class="fl" style="color: #AD0000;">1.03</span>, <span class="fl" style="color: #AD0000;">0.5</span>), fontsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>)</span>
<span id="cb37-27"></span>
<span id="cb37-28">  fig.suptitle(<span class="ss" style="color: #20794D;">f"fastbook-benchmark </span><span class="sc" style="color: #5E5E5E;">{</span>metric<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> by Chunk Size"</span>, fontsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">24</span>, y<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1.05</span>)</span>
<span id="cb37-29">  plt.tight_layout()</span>
<span id="cb37-30">  plt.subplots_adjust(right<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.85</span>)</span>
<span id="cb37-31">  plt.show()</span></code></pre></div>
</details>
</div>
<div class="cell" data-outputid="22209e74-d208-4031-8e17-a5444e743802" data-execution_count="163">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">plot_metrics(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-29-fastbook-benchmark-results/index_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Takeaways:</p>
<ul>
<li>All semantic search methods peak at a chunk size of ~500 tokens.</li>
<li>Full text search (BM25) mostly monotonically improves with chunk size.</li>
<li>Single-vector cosine simililarity is the worst-performing method after ~250 tokens.</li>
<li>For semantic search methods, in general, answerai-colbert-small-v1 &gt; ColBERTv2 &gt; Single-vector cosine similarity.</li>
</ul>
<div class="cell" data-outputid="6d5cb540-5d7a-4fd7-8099-79499b94cd2e" data-execution_count="164">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">plot_metrics(df, metric<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"Recall@10"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-36-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-29-fastbook-benchmark-results/index_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Takeaways:</p>
<ul>
<li>When the data is not preprocessed, all semantic search methods’ Recall@10 decreases from ~500 tokens to ~1000 tokens, then increase again to 2000 tokens.</li>
<li>After 500 tokens, full text search (BM25) has the best Recall@10 for most of the way.</li>
</ul>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>This was an incredibly awesome experience. I did a couple iterations of these experiments before this notebook, each time refactoring my approach so that I could relatively concisely run these chunk size experiments. That process was tough at times but really rewarding.</p>
<p>My three main takeaways:</p>
<ul>
<li>For small chunks, answerai-colbert-small-v1 has the best MRR@10 and Recall@10.</li>
<li>For medium chunks, use ColBERTv2 for the best MRR@10 and full text search for the best Recall@10.</li>
<li>For large chunks, full text search has the best MRR@10 and Recall@10.</li>
</ul>
<p>I expect to try out all of these approaches after I integrate an LLM to turn this information retrieval pipeline to a RAG pipeline. My hypothesis is that smaller chunks will yield better responses from the LLM since there will be less “noise” and more “signal” in the context.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>RAG</category>
  <category>information retrieval</category>
  <category>fastbookRAG</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-29-fastbook-benchmark-results/index.html</guid>
  <pubDate>Fri, 29 Nov 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>Implementing Image-to-Image Generation for Stable Diffusion</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index.html</link>
  <description><![CDATA[ 



<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T13:18:05.871852Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T13:18:05.871314Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T13:19:06.856593Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T13:19:06.855831Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T13:18:05.871831Z&quot;}">
<details>
<summary>Show setup</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq diffusers transformers<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">4.46.2</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq pillow<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">11.0.0</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> diffusers <span class="im" style="color: #00769E;">import</span> LMSDiscreteScheduler, AutoencoderKL, UNet2DConditionModel, StableDiffusionPipeline</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> CLIPTextModel, CLIPTokenizer</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> torchvision.transforms <span class="im" style="color: #00769E;">import</span> ToTensor</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> PIL <span class="im" style="color: #00769E;">import</span> Image</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> tqdm.auto <span class="im" style="color: #00769E;">import</span> tqdm</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">from</span> IPython.display <span class="im" style="color: #00769E;">import</span> display</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> torch, math</span>
<span id="cb1-11"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-12"></span>
<span id="cb1-13">tokenizer <span class="op" style="color: #5E5E5E;">=</span> CLIPTokenizer.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16)</span>
<span id="cb1-14">text_encoder <span class="op" style="color: #5E5E5E;">=</span> CLIPTextModel.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-15">vae <span class="op" style="color: #5E5E5E;">=</span> AutoencoderKL.from_pretrained(<span class="st" style="color: #20794D;">"stabilityai/sd-vae-ft-ema"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-16">unet <span class="op" style="color: #5E5E5E;">=</span> UNet2DConditionModel.from_pretrained(<span class="st" style="color: #20794D;">"CompVis/stable-diffusion-v1-4"</span>, subfolder<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"unet"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-17"></span>
<span id="cb1-18">beta_start,beta_end <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.00085</span>,<span class="fl" style="color: #AD0000;">0.012</span></span>
<span id="cb1-19">scheduler <span class="op" style="color: #5E5E5E;">=</span> LMSDiscreteScheduler(beta_start<span class="op" style="color: #5E5E5E;">=</span>beta_start, beta_end<span class="op" style="color: #5E5E5E;">=</span>beta_end, beta_schedule<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"scaled_linear"</span>, num_train_timesteps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21">height <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-22">width <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-23">num_inference_steps <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">70</span></span>
<span id="cb1-24">guidance_scale <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7.5</span></span>
<span id="cb1-25">batch_size <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span></span></code></pre></div>
</details>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In Lesson 10 of the fastai course (Part 2) Jeremy assigns us the following homework assignment:</p>
<blockquote class="blockquote">
<p>try picking one of the extra tricks we learned about like image-to-image, or negative prompts; see if you can implement negative prompt in your version of this; or try doing image-to-image; try adding callbacks</p>
</blockquote>
<p>In this blog post I’ll implement negative prompting using the diffusion loop code provided in the course’s <a href="https://github.com/fastai/diffusion-nbs/blob/master/stable_diffusion.ipynb">Stable Diffusion with Diffusers</a> notebook.</p>
<p>I’ll start by copy/pasting all of the boilerplate code provided in that notebook, and running it to make sure we get the desired images.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T13:28:23.790908Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T13:28:23.790670Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T13:28:23.797107Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T13:28:23.796589Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T13:28:23.790890Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;">def</span> text_enc(prompts, maxlen<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;">if</span> maxlen <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>: maxlen <span class="op" style="color: #5E5E5E;">=</span> tokenizer.model_max_length</span>
<span id="cb2-3">    inp <span class="op" style="color: #5E5E5E;">=</span> tokenizer(prompts, padding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"max_length"</span>, max_length<span class="op" style="color: #5E5E5E;">=</span>maxlen, truncation<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>)</span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;">return</span> text_encoder(inp.input_ids.to(<span class="st" style="color: #20794D;">"cuda"</span>))[<span class="dv" style="color: #AD0000;">0</span>].half()</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;">def</span> mk_img(t):</span>
<span id="cb2-7">    image <span class="op" style="color: #5E5E5E;">=</span> (t<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">+</span><span class="fl" style="color: #AD0000;">0.5</span>).clamp(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>).detach().cpu().permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>).numpy()</span>
<span id="cb2-8">    <span class="cf" style="color: #003B4F;">return</span> Image.fromarray((image<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">255</span>).<span class="bu" style="color: null;">round</span>().astype(<span class="st" style="color: #20794D;">"uint8"</span>))</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb2-11">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb2-12">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb2-13">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb2-14">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb2-15">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb2-16"></span>
<span id="cb2-17">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb2-18">    scheduler.set_timesteps(steps)</span>
<span id="cb2-19">    <span class="co" style="color: #5E5E5E;">#latents = latents.to("cuda").half() * scheduler.init_noise_sigma</span></span>
<span id="cb2-20">    <span class="co" style="color: #5E5E5E;">#latents = latents.to("cuda").half()</span></span>
<span id="cb2-21">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb2-22"></span>
<span id="cb2-23">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb2-24">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb2-25">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb2-26">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb2-27">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb2-28"></span>
<span id="cb2-29">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T13:29:18.641278Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T13:29:18.641043Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T13:29:28.807514Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T13:29:28.806911Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T13:29:18.641261Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'A dancer wearing a colorful dress'</span>])</span>
<span id="cb3-2"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_33/2843554848.py:17: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6a3078084e204a0c9e7447e8581893d4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-4-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index_files/figure-html/cell-4-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="implementing-image-to-image-generation" class="level2">
<h2 class="anchored" data-anchor-id="implementing-image-to-image-generation">Implementing Image-to-Image Generation</h2>
<p>In the default implementation of the stable diffusion loop, we start out with a set of random latents:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb5-2">latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span></code></pre></div>
<p>What we want for image-to-image generation is to start with noisy latents for some initial image. This will involve:</p>
<ul>
<li>Loading an image as a tensor.</li>
<li>Encoding the image into latents.</li>
<li>Adding some noise to the latents.</li>
</ul>
<section id="loading-an-image-as-a-tensor" class="level3">
<h3 class="anchored" data-anchor-id="loading-an-image-as-a-tensor">Loading an image as a tensor</h3>
<p>I’ll use this Macaw from Lesson 10 as the initial image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:11.204851Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:11.204266Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:11.253725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:11.253162Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:11.204828Z&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">init_image_path <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"macaw.jpg"</span></span>
<span id="cb6-2">im <span class="op" style="color: #5E5E5E;">=</span> Image.<span class="bu" style="color: null;">open</span>(init_image_path)</span>
<span id="cb6-3">im</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The original image contains values between <code>0</code> and <code>255</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:11.860720Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:11.860141Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:11.866142Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:11.865593Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:11.860698Z&quot;}" data-execution_count="55">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">np.array(im).<span class="bu" style="color: null;">min</span>(), np.array(im).<span class="bu" style="color: null;">max</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(0, 255)</code></pre>
</div>
</div>
<p>The following lines load the image, resize it to the desired size (512x512) and convert it to a tensor using <code>torchvision.transforms.ToTensor</code>. I also make sure the image is on the GPU and is using <code>half</code>-precision (which is used by the VAE):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:12.600519Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:12.599890Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:12.639371Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:12.638708Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:12.600493Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">transform <span class="op" style="color: #5E5E5E;">=</span> ToTensor()</span>
<span id="cb9-2">init_image <span class="op" style="color: #5E5E5E;">=</span> transform(Image.<span class="bu" style="color: null;">open</span>(init_image_path).convert(<span class="st" style="color: #20794D;">'RGB'</span>).resize((<span class="dv" style="color: #AD0000;">512</span>, <span class="dv" style="color: #AD0000;">512</span>))).to(<span class="st" style="color: #20794D;">"cuda"</span>).half()</span></code></pre></div>
</div>
<p>The transformed image (to tensor) contains values between <code>0</code> and <code>1</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:13.771012Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:13.770450Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:13.776280Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:13.775765Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:13.770989Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">init_image.<span class="bu" style="color: null;">min</span>(), init_image.<span class="bu" style="color: null;">max</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(tensor(0., device='cuda:0', dtype=torch.float16),
 tensor(1., device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
</section>
<section id="encoding-the-image-into-latents" class="level3">
<h3 class="anchored" data-anchor-id="encoding-the-image-into-latents">Encoding the image into latents</h3>
<p>I reference the following line from <code>mk_img</code>:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">image <span class="op" style="color: #5E5E5E;">=</span> (t<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">+</span><span class="fl" style="color: #AD0000;">0.5</span>).clamp(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>).detach().cpu().permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>).numpy()</span></code></pre></div>
<p>and the following line from <code>mk_samples</code>:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
<p>to encode the initial image into latents with the following line:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:14.776602Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:14.775956Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:14.787577Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:14.786938Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:14.776535Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">latents <span class="op" style="color: #5E5E5E;">=</span> vae.encode(init_image.unsqueeze(<span class="dv" style="color: #AD0000;">0</span>)<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>).latent_dist.sample() <span class="op" style="color: #5E5E5E;">*</span> <span class="fl" style="color: #AD0000;">0.18215</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:16.897011Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:16.896425Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:16.900844Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:16.900254Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:16.896988Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">latents.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>torch.Size([1, 4, 64, 64])</code></pre>
</div>
</div>
<p>Note that the VAE encoder expects values between <code>-1</code> and <code>1</code> so we have to transform the image tensor accordingly:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:17.458562Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:17.458134Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:17.465208Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:17.464604Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:17.458539Z&quot;}" data-execution_count="60">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">shifted_im <span class="op" style="color: #5E5E5E;">=</span> init_image.unsqueeze(<span class="dv" style="color: #AD0000;">0</span>)<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb17-2">shifted_im.<span class="bu" style="color: null;">min</span>(), shifted_im.<span class="bu" style="color: null;">max</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>(tensor(-1., device='cuda:0', dtype=torch.float16),
 tensor(1., device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
</section>
<section id="adding-some-noise-to-the-latents" class="level3">
<h3 class="anchored" data-anchor-id="adding-some-noise-to-the-latents">Adding some noise to the latents</h3>
<p>We don’t want to start the diffusion loop with the original image’s latents because the UNet is trained to predict noise on noisy latents. In order to give the UNet it’s expected input (noisy latents) we need to add noise to our initial image’s latents!</p>
<p>We don’t want to literally <em>add</em> (with <code>+</code>) noise to the latents. Instead, we want to simulating the diffusion process as if it were starting from pure random noise. To do this, we need to prep the <code>scheduler</code> with the total number of <code>steps</code> (so it can calculate noise appropriately), pick some initial step for our noise, and add it to our latents with <code>add_noise</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:23.056353Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:23.055659Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:23.062361Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:23.061809Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:23.056333Z&quot;}" data-execution_count="61">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;"># set timesteps</span></span>
<span id="cb19-2">steps <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">70</span></span>
<span id="cb19-3">scheduler.set_timesteps(steps)</span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;"># get start timestep</span></span>
<span id="cb19-6">init_strength <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.15</span> <span class="co" style="color: #5E5E5E;"># can be anything 0-1</span></span>
<span id="cb19-7">init_step <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(init_strength <span class="op" style="color: #5E5E5E;">*</span> steps)</span>
<span id="cb19-8">ts_start <span class="op" style="color: #5E5E5E;">=</span> torch.tensor([scheduler.timesteps[init_step]])</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;"># create noise</span></span>
<span id="cb19-11">bs <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb19-12">noise <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>)).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb19-13"></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;"># add noise</span></span>
<span id="cb19-15">latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.add_noise(latents, noise, ts_start).half()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_33/3549084226.py:12: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  noise = torch.randn((bs, unet.in_channels, height//8, width//8)).to("cuda")</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:23.381289Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:23.380821Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:23.385088Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:23.384548Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:23.381270Z&quot;}" data-execution_count="62">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">latents.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>torch.Size([1, 4, 64, 64])</code></pre>
</div>
</div>
<p>Note that <code>init_step</code> and <code>ts_start</code> are two different values.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T15:49:42.261829Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T15:49:42.261343Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T15:49:42.273193Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T15:49:42.272715Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T15:49:42.261811Z&quot;}" data-execution_count="63">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">init_step, ts_start</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>(10, tensor([854.2174]))</code></pre>
</div>
</div>
</section>
<section id="running-the-diffusion-loop" class="level3">
<h3 class="anchored" data-anchor-id="running-the-diffusion-loop">Running the diffusion loop</h3>
<p>I’ll define some of the related inputs so I can run the diffusion loop with our initial image’s noisy latents. Note that we are not starting the diffusion loop with the first <code>ts</code> but rather starting at the <code>init_step</code> we calculated above:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:31:55.216963Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:31:55.216429Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:31:55.234369Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:31:55.233913Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:31:55.216941Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">prompts<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'A dancer wearing a colorful dress'</span>]</span>
<span id="cb25-2">g <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7.5</span></span>
<span id="cb25-3">seed <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">100</span></span>
<span id="cb25-4"></span>
<span id="cb25-5">bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb25-6">text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb25-7">uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb25-8">emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb25-9"><span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:31:56.032350Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:31:56.031899Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:32:01.445511Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:32:01.445068Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:31:56.032332Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps[init_step:])):</span>
<span id="cb26-2">    inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb26-3"></span>
<span id="cb26-4">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb26-5">    pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb26-6">    latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb26-7"></span>
<span id="cb26-8"><span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): </span>
<span id="cb26-9">    final_image <span class="op" style="color: #5E5E5E;">=</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6b73f194398e422f9974f31d4de427c8","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:32:01.447562Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:32:01.447421Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:32:01.649725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:32:01.649249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:32:01.447548Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">display(mk_img(final_image[<span class="dv" style="color: #AD0000;">0</span>]))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As a reminder, here is the initial image, we can see the similarities in color structure (note the transitions from red –&gt; blue –&gt; green –&gt; yellow).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:30:35.761977Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:30:35.761425Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:30:35.809960Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:30:35.809387Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:30:35.761955Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">Image.<span class="bu" style="color: null;">open</span>(init_image_path)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-18-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="varying-init_strength" class="level2">
<h2 class="anchored" data-anchor-id="varying-init_strength">Varying <code>init_strength</code></h2>
<p>With the core functionality of image-to-image generation working properly, I’ll wrap it all into a function so I can loop through different <code>init_strength</code> values to see how it affects the generated image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:43:46.865913Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:43:46.865471Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:43:46.871618Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:43:46.871129Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:43:46.865893Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, init_image_path, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>, init_strength<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.15</span>):</span>
<span id="cb29-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb29-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb29-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb29-5">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb29-6">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb29-7"></span>
<span id="cb29-8">    <span class="co" style="color: #5E5E5E;"># load image as tensor</span></span>
<span id="cb29-9">    transform <span class="op" style="color: #5E5E5E;">=</span> ToTensor()</span>
<span id="cb29-10">    init_image <span class="op" style="color: #5E5E5E;">=</span> transform(Image.<span class="bu" style="color: null;">open</span>(init_image_path).convert(<span class="st" style="color: #20794D;">'RGB'</span>).resize((<span class="dv" style="color: #AD0000;">512</span>, <span class="dv" style="color: #AD0000;">512</span>))).to(<span class="st" style="color: #20794D;">"cuda"</span>).half()</span>
<span id="cb29-11"></span>
<span id="cb29-12">    <span class="co" style="color: #5E5E5E;"># encode image into latents</span></span>
<span id="cb29-13">    latents <span class="op" style="color: #5E5E5E;">=</span> vae.encode(init_image.unsqueeze(<span class="dv" style="color: #AD0000;">0</span>)<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>).latent_dist.sample() <span class="op" style="color: #5E5E5E;">*</span> <span class="fl" style="color: #AD0000;">0.18215</span></span>
<span id="cb29-14"></span>
<span id="cb29-15">    <span class="co" style="color: #5E5E5E;"># set timesteps</span></span>
<span id="cb29-16">    scheduler.set_timesteps(steps)</span>
<span id="cb29-17"></span>
<span id="cb29-18">    <span class="co" style="color: #5E5E5E;"># get start timestep</span></span>
<span id="cb29-19">    init_step <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(init_strength <span class="op" style="color: #5E5E5E;">*</span> steps)</span>
<span id="cb29-20">    ts_start <span class="op" style="color: #5E5E5E;">=</span> torch.tensor([scheduler.timesteps[init_step]])</span>
<span id="cb29-21"></span>
<span id="cb29-22">    <span class="co" style="color: #5E5E5E;"># create noise</span></span>
<span id="cb29-23">    noise <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>)).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb29-24"></span>
<span id="cb29-25">    <span class="co" style="color: #5E5E5E;"># add noise</span></span>
<span id="cb29-26">    latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.add_noise(latents, noise, ts_start).half()</span>
<span id="cb29-27"></span>
<span id="cb29-28">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps[init_step:])):</span>
<span id="cb29-29">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb29-30"></span>
<span id="cb29-31">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb29-32">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb29-33">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb29-34"></span>
<span id="cb29-35">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span>
<span id="cb29-36">    </span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:44:31.729769Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:44:31.729006Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:50:27.569619Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:50:27.569049Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:44:31.729740Z&quot;}">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">imgs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb30-2"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb30-3">  images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">"A dancer wearing a colorful dress"</span>], init_image_path<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"macaw.jpg"</span>, init_strength<span class="op" style="color: #5E5E5E;">=</span>i<span class="op" style="color: #5E5E5E;">*</span><span class="fl" style="color: #AD0000;">0.01</span>)</span>
<span id="cb30-4">  imgs.append(images[<span class="dv" style="color: #AD0000;">0</span>])</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:51:29.705116Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:51:29.704833Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:51:31.753480Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:51:31.752790Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:51:29.705097Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">imgs <span class="op" style="color: #5E5E5E;">=</span> [mk_img(img.squeeze()) <span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> imgs]</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-27T14:51:37.391596Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-27T14:51:37.391308Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-27T14:51:50.329505Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-27T14:51:50.328829Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-27T14:51:37.391576Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">imgs[<span class="dv" style="color: #AD0000;">0</span>].save(<span class="ss" style="color: #20794D;">f'init_strength.gif'</span>, save_all<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, append_images<span class="op" style="color: #5E5E5E;">=</span>imgs[<span class="dv" style="color: #AD0000;">1</span>:], duration<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, loop<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="init_strength.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="init_strength goes from 0 to 1.0"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/init_strength.gif" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption"><code>init_strength</code> goes from 0 to 1.0</figcaption><p></p>
</figure>
</div>
<p>As <code>init_strength</code> goes from <code>0.0</code> (totally random initial noise) to <code>0.99</code> (very lightly noised initial image) we can see how the prompt conforms to the color and structure of the initial image.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Working through this implementation solidified my understanding of the diffusion loop. A few small but key points that I paid more attention to this time around:</p>
<ul>
<li>The VAE encoder expects latent values between <code>-1</code> and <code>1</code> so we have to transform our image tensor accordingly.</li>
<li>Adding noise to our initial image’s latents requires:
<ul>
<li>Picking a total number of inference steps.</li>
<li>Picking an initial step (at which we will apply the noise) and the corresponding <code>scheduler</code> timestep.</li>
<li>Using <code>scheduler.add_noise</code>.</li>
</ul></li>
<li>The text encoding process remains untouched.</li>
<li>The only change to the diffusion loop is starting at <code>scheduler.timesteps[init_step]</code> instead of the first timestep.</li>
</ul>
<p>The last implementation for this HW assignment will be to implement callbacks, which I’ll do in a future blog post! Thanks for reading!</p>


</section>

 ]]></description>
  <category>python</category>
  <category>stable diffusion</category>
  <category>fastai</category>
  <category>deep learning</category>
  <category>machine learning</category>
  <category>generative AI</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/index.html</guid>
  <pubDate>Wed, 27 Nov 2024 08:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2024-11-27-image-to-image-diffusion/init_strength.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Evaluating 4 Retrieval Methods with 6 Chunking Strategies on my fastbook-benchmark Dataset</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-26-fastbook-benchmark-results/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I re-run my full text search and semantic search retrieval methods for fastbook questions and use my newly curated <a href="https://gist.github.com/vishalbakshi/a507b6e9e893475e93a4141e96b8947d">fastbook-benchmark</a> dataset to calculate Answer Component MRR@10 and Answer Component Recall@10 retrieval metrics. Due to how my benchmark dataset is structured, I had to modify (with Claude’s help) the classic MRR and Recall functions:</p>
<ul>
<li><p>Answer Component MRR@10: Returns the rank of the n-th passage needed to satisfy all <code>answer_component</code>s for the question. So, if a question has 4 <code>answer_component</code>s and their relevant contexts were contained across the first 5 retrieved passages, MRR would be 1/5 = 0.2.</p></li>
<li><p>Answer Component Recall@10: Measures the proportion of answer components for which at least one supporting context was retrieved. Using the same example, if the top-10 passages only contain contexts relevant to 2 <code>answer_component</code>s, Recall would be 2/4 = 0.5</p></li>
</ul>
<p>See the section below to see how my benchmark dataset is structured.</p>
<p>There are four retrieval methods I implement in this notebook:</p>
<ul>
<li>Full text search (using sqlite and Claude-generated keywords)</li>
<li>Single-vector cosine similarity (using BAAI/bge-small-en-v1.5)</li>
<li>ColBERTv2</li>
<li>answerai-colbert-small-v1</li>
</ul>
<p>There are six chunking strategies I implement:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chunking Strategy Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1-paragraph (w/headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">3-paragraph (w/headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1-paragraph (w/o headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">3-paragraph (w/o headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">E</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags)</td>
</tr>
<tr class="even">
<td style="text-align: center;">F</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags, w/o punctuation)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<p><strong>Answer Component MRR@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.44</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.46</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.35</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.41</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">0.48</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>Answer Component Recall@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">83%</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">71%</td>
<td style="text-align: center;">85%</td>
<td style="text-align: center;">72%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">87%</td>
<td style="text-align: center;">86%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">74%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">81%</td>
<td style="text-align: center;">71%</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">77%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">73%</td>
</tr>
</tbody>
</table>
<p>The best-performing retrieval method and chunking strategies:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Metric Name</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">Chunking Strategies</th>
<th style="text-align: center;">Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Answer Component MRR@10</td>
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">B, D, E</td>
<td style="text-align: center;">0.52</td>
</tr>
<tr class="even">
<td style="text-align: center;">Answer Component Recall@10</td>
<td style="text-align: center;">Single-vector cosine similiarty</td>
<td style="text-align: center;">E</td>
<td style="text-align: center;">87%</td>
</tr>
</tbody>
</table>
</section>
<section id="the-fastbook-benchmark-dataset" class="level2">
<h2 class="anchored" data-anchor-id="the-fastbook-benchmark-dataset">The fastbook-benchmark Dataset</h2>
<p>The fastbook-benchmark dataset contains a list of items (questions). Each item looks something like this:</p>
<pre><code>{
            "chapter": 1,
            "question_number": 1,
            "question_text": "Do you need these for deep learning?\n\n- Lots of math..."",
            "answer_context": [
                {
                    "answer_component": "\"Lots of math..."",
                    "scoring_type": "simple",
                    "context": [
                        "...Lots of math..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                }
            ],
            "question_context": []
        },</code></pre>
<p>I have broken down each <code>gold_standard_answer</code> into separate <code>answer_component</code>s, each of which has associated with it one or more <code>context</code>s from the chapter text that address that <code>answer_component</code>. Here’s an example of a question with two <code>answer_component</code>s:</p>
<pre><code>{
            "chapter": 1,
            "question_number": 5,
            "question_text": "What were the two theoretical misunderstandings that held back the field of neural networks?",
            "gold_standard_answer": "\"In 1969..."",
            "answer_context": [
                {
                    "answer_component": "\"In 1969..."",
                    "scoring_type": "simple",
                    "context": [
                        "An MIT professor named..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                },
                {
                    "answer_component": "\"\n\nIn the 1980's..."",
                    "scoring_type": "simple",
                    "context": [
                        "In the 1980's..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                }
            ],
            "question_context": []
        },</code></pre>
<p>Any one of the <code>context</code>s is sufficient to address the associated <code>answer_component</code>. For example, for Chapter 1 Question 12:</p>
<pre><code>{
  "answer_component": "We instead use the term parameters.",
  "scoring_type": "simple",
  "context": [
      "By the way, what Samuel called \"weights\" are most generally referred to as model *parameters* these days",

      "The *weights* are called *parameters*"
  ],
  "explicit_context": "true",
  "extraneous_answer": "false"
}</code></pre>
<p>For some questions’ <code>gold_standard_answer</code> I found that some <code>answer_component</code>s were extraneous to the goal of the question. These have been marked with the flag <code>"extraneous_answer": "false"</code>.</p>
<p>For some <code>answer_component</code>s I found the corresponding <code>context</code> implicitly addressing it. These have been marked with the flag <code>"explicit_context": "false"</code>.</p>
<p>Finally, for some <code>answer_component</code>s I did not find relevant context in the given chapter so the <code>context</code> field is assigned an empty list <code>[]</code>.</p>
<p>All of the design decisions for this fastbook-benchmark dataset have largely been driven by one goal: don’t change the <code>gold_standard_answer</code>. I have been using the fastai Forums’ Wiki solutions page for each chapter as the gold standard answer set (<a href="https://forums.fast.ai/t/fastbook-chapter-1-questionnaire-solutions-wiki/65647">example</a>).</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>::: {.cell _cell_guid=‘b1076dfc-b9ad-4769-8c92-a6c4dae69d19’ _uuid=‘8f2839f25d086af736a60e9eeb907d3b93b6e0e5’ trusted=‘true’}</p>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="op" style="color: #5E5E5E;">!</span>pip install sentence<span class="op" style="color: #5E5E5E;">-</span>transformers <span class="op" style="color: #5E5E5E;">-</span>Uqq</span>
<span id="cb4-2"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq RAGatouille</span>
<span id="cb4-3"><span class="op" style="color: #5E5E5E;">!</span>pip install ftfy <span class="op" style="color: #5E5E5E;">-</span>qq</span></code></pre></div>
<p>:::</p>
<div class="cell" data-trusted="true">
<details>
<summary>Show imports</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;">import</span> sqlite3</span>
<span id="cb5-2"><span class="im" style="color: #00769E;">import</span> json</span>
<span id="cb5-3"><span class="im" style="color: #00769E;">import</span> re</span>
<span id="cb5-4"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb5-5"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd, numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb5-6"><span class="im" style="color: #00769E;">import</span> requests</span>
<span id="cb5-7"><span class="im" style="color: #00769E;">import</span> torch</span>
<span id="cb5-8"><span class="im" style="color: #00769E;">import</span> torch.nn.functional <span class="im" style="color: #00769E;">as</span> F</span>
<span id="cb5-9"><span class="im" style="color: #00769E;">from</span> ftfy <span class="im" style="color: #00769E;">import</span> fix_text</span>
<span id="cb5-10"><span class="im" style="color: #00769E;">from</span> sentence_transformers <span class="im" style="color: #00769E;">import</span> SentenceTransformer</span>
<span id="cb5-11"><span class="im" style="color: #00769E;">from</span> ragatouille <span class="im" style="color: #00769E;">import</span> RAGPretrainedModel</span>
<span id="cb5-12">emb_model <span class="op" style="color: #5E5E5E;">=</span> SentenceTransformer(<span class="st" style="color: #20794D;">"BAAI/bge-small-en-v1.5"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:40:50.025834Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:40:50.025034Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:40:50.036117Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:40:50.035220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:40:50.025798Z&quot;}" data-trusted="true" data-execution_count="3">
<details>
<summary>Show chunking code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;">def</span> get_chunks(notebook_path):</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(notebook_path, <span class="st" style="color: #20794D;">'r'</span>, encoding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'utf-8'</span>) <span class="im" style="color: #00769E;">as</span> <span class="bu" style="color: null;">file</span>:</span>
<span id="cb6-3">        notebook <span class="op" style="color: #5E5E5E;">=</span> json.load(<span class="bu" style="color: null;">file</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5">    chunks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-6">    current_header <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span></span>
<span id="cb6-7"></span>
<span id="cb6-8">    <span class="kw" style="color: #003B4F;">def</span> add_chunk(content):</span>
<span id="cb6-9">        <span class="cf" style="color: #003B4F;">if</span> content.strip():</span>
<span id="cb6-10">            chunks.append(<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>current_header<span class="sc" style="color: #5E5E5E;">}</span><span class="ch" style="color: #20794D;">\n\n</span><span class="sc" style="color: #5E5E5E;">{</span>content<span class="sc" style="color: #5E5E5E;">.</span>strip()<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb6-11"></span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;">for</span> cell <span class="kw" style="color: #003B4F;">in</span> notebook[<span class="st" style="color: #20794D;">'cells'</span>]:</span>
<span id="cb6-13">        <span class="cf" style="color: #003B4F;">if</span> cell[<span class="st" style="color: #20794D;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'markdown'</span>:</span>
<span id="cb6-14">            content <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span>.join(cell[<span class="st" style="color: #20794D;">'source'</span>])</span>
<span id="cb6-15">            <span class="co" style="color: #5E5E5E;"># see if the cell starts with a markdown header</span></span>
<span id="cb6-16">            header_match <span class="op" style="color: #5E5E5E;">=</span> re.match(<span class="vs" style="color: #20794D;">r'^(#+\s+.*?)$'</span>, content, re.MULTILINE)</span>
<span id="cb6-17">            <span class="cf" style="color: #003B4F;">if</span> header_match:</span>
<span id="cb6-18">                <span class="co" style="color: #5E5E5E;"># grab the header</span></span>
<span id="cb6-19">                current_header <span class="op" style="color: #5E5E5E;">=</span> header_match.group(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-20">                <span class="co" style="color: #5E5E5E;"># add any content after the header in the same cell</span></span>
<span id="cb6-21">                remaining_content <span class="op" style="color: #5E5E5E;">=</span> content[<span class="bu" style="color: null;">len</span>(current_header):].strip()</span>
<span id="cb6-22">                <span class="cf" style="color: #003B4F;">if</span> remaining_content:</span>
<span id="cb6-23">                    <span class="co" style="color: #5E5E5E;"># split content into paragraphs</span></span>
<span id="cb6-24">                    paragraphs <span class="op" style="color: #5E5E5E;">=</span> re.split(<span class="vs" style="color: #20794D;">r'\n\s*\n'</span>, remaining_content)</span>
<span id="cb6-25">                    <span class="co" style="color: #5E5E5E;"># append the paragraph to the list of chunks</span></span>
<span id="cb6-26">                    <span class="cf" style="color: #003B4F;">for</span> paragraph <span class="kw" style="color: #003B4F;">in</span> paragraphs:</span>
<span id="cb6-27">                        add_chunk(paragraph)</span>
<span id="cb6-28">            <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb6-29">                <span class="co" style="color: #5E5E5E;"># split content into paragraphs</span></span>
<span id="cb6-30">                paragraphs <span class="op" style="color: #5E5E5E;">=</span> re.split(<span class="vs" style="color: #20794D;">r'\n\s*\n'</span>, content)</span>
<span id="cb6-31">                <span class="co" style="color: #5E5E5E;"># append the paragraph to the list of chunks</span></span>
<span id="cb6-32">                <span class="cf" style="color: #003B4F;">for</span> paragraph <span class="kw" style="color: #003B4F;">in</span> paragraphs:</span>
<span id="cb6-33">                    add_chunk(paragraph)</span>
<span id="cb6-34">        <span class="cf" style="color: #003B4F;">elif</span> cell[<span class="st" style="color: #20794D;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'code'</span>:</span>
<span id="cb6-35">          code_content <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'```python</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">''</span>.join(cell[<span class="st" style="color: #20794D;">'source'</span>]) <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">```'</span></span>
<span id="cb6-36"></span>
<span id="cb6-37">          <span class="co" style="color: #5E5E5E;"># include the output of the code cell</span></span>
<span id="cb6-38">          output_content <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span></span>
<span id="cb6-39">          <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'outputs'</span> <span class="kw" style="color: #003B4F;">in</span> cell <span class="kw" style="color: #003B4F;">and</span> cell[<span class="st" style="color: #20794D;">'outputs'</span>]:</span>
<span id="cb6-40">              <span class="cf" style="color: #003B4F;">for</span> output <span class="kw" style="color: #003B4F;">in</span> cell[<span class="st" style="color: #20794D;">'outputs'</span>]:</span>
<span id="cb6-41">                  <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'text'</span> <span class="kw" style="color: #003B4F;">in</span> output:</span>
<span id="cb6-42">                      output_content <span class="op" style="color: #5E5E5E;">+=</span> <span class="st" style="color: #20794D;">''</span>.join(output[<span class="st" style="color: #20794D;">'text'</span>])</span>
<span id="cb6-43">                  <span class="cf" style="color: #003B4F;">elif</span> <span class="st" style="color: #20794D;">'data'</span> <span class="kw" style="color: #003B4F;">in</span> output <span class="kw" style="color: #003B4F;">and</span> <span class="st" style="color: #20794D;">'text/plain'</span> <span class="kw" style="color: #003B4F;">in</span> output[<span class="st" style="color: #20794D;">'data'</span>]:</span>
<span id="cb6-44">                      output_content <span class="op" style="color: #5E5E5E;">+=</span> <span class="st" style="color: #20794D;">''</span>.join(output[<span class="st" style="color: #20794D;">'data'</span>][<span class="st" style="color: #20794D;">'text/plain'</span>])</span>
<span id="cb6-45"></span>
<span id="cb6-46">          <span class="co" style="color: #5E5E5E;"># combine code and output in the same chunk</span></span>
<span id="cb6-47">          combined_content <span class="op" style="color: #5E5E5E;">=</span> code_content <span class="op" style="color: #5E5E5E;">+</span> <span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">Output:</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span> <span class="op" style="color: #5E5E5E;">+</span> output_content <span class="cf" style="color: #003B4F;">if</span> output_content <span class="cf" style="color: #003B4F;">else</span> code_content</span>
<span id="cb6-48">          add_chunk(combined_content)</span>
<span id="cb6-49"></span>
<span id="cb6-50">    <span class="kw" style="color: #003B4F;">def</span> filter_chunks(chunks, exclude_headers<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">"Questionnaire"</span>, <span class="st" style="color: #20794D;">"Further Research"</span>]):</span>
<span id="cb6-51">      filtered_chunks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-52">      <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks:</span>
<span id="cb6-53">          lines <span class="op" style="color: #5E5E5E;">=</span> chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span>)</span>
<span id="cb6-54">          <span class="co" style="color: #5E5E5E;"># check if the first line (header) is in the exclude list</span></span>
<span id="cb6-55">          <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> <span class="bu" style="color: null;">any</span>(header <span class="kw" style="color: #003B4F;">in</span> lines[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> header <span class="kw" style="color: #003B4F;">in</span> exclude_headers):</span>
<span id="cb6-56">              filtered_chunks.append(chunk)</span>
<span id="cb6-57">      <span class="cf" style="color: #003B4F;">return</span> filtered_chunks</span>
<span id="cb6-58"></span>
<span id="cb6-59">    <span class="cf" style="color: #003B4F;">return</span> filter_chunks(chunks)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:40:57.639923Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:40:57.639543Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:40:57.647438Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:40:57.646406Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:40:57.639889Z&quot;}" data-trusted="true" data-execution_count="59">
<details>
<summary>Show chunking code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;">def</span> combine_chunks(chunks, num_p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>):</span>
<span id="cb7-2">    combined_chunks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb7-3">    current_header <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb7-4">    current_group <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb7-5"></span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks:</span>
<span id="cb7-7">        <span class="co" style="color: #5E5E5E;"># Extract header from chunk</span></span>
<span id="cb7-8">        header <span class="op" style="color: #5E5E5E;">=</span> chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>)[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb7-9"></span>
<span id="cb7-10">        <span class="cf" style="color: #003B4F;">if</span> header <span class="op" style="color: #5E5E5E;">!=</span> current_header:</span>
<span id="cb7-11">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>:  <span class="co" style="color: #5E5E5E;"># Only add if group has content besides header</span></span>
<span id="cb7-12">                <span class="co" style="color: #5E5E5E;"># Add current group to combined chunks if header changes</span></span>
<span id="cb7-13">                combined_chunks.append(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>.join(current_group))</span>
<span id="cb7-14">            <span class="co" style="color: #5E5E5E;"># Update current header</span></span>
<span id="cb7-15">            current_header <span class="op" style="color: #5E5E5E;">=</span> header</span>
<span id="cb7-16">            <span class="co" style="color: #5E5E5E;"># Start new group with header and content of current chunk</span></span>
<span id="cb7-17">            current_group <span class="op" style="color: #5E5E5E;">=</span> [header, chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>, <span class="dv" style="color: #AD0000;">1</span>)[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>)) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span> <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">''</span>]</span>
<span id="cb7-18">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb7-19">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">&lt;</span> num_p <span class="op" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>:  <span class="co" style="color: #5E5E5E;"># +1 to account for header</span></span>
<span id="cb7-20">                <span class="co" style="color: #5E5E5E;"># Add chunk content (without header) to current group</span></span>
<span id="cb7-21">                current_group.append(chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>, <span class="dv" style="color: #AD0000;">1</span>)[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(chunk.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>)) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span> <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">''</span>)</span>
<span id="cb7-22"></span>
<span id="cb7-23">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">==</span> num_p <span class="op" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>:  <span class="co" style="color: #5E5E5E;"># +1 to account for header</span></span>
<span id="cb7-24">                <span class="co" style="color: #5E5E5E;"># Add full group to combined chunks</span></span>
<span id="cb7-25">                combined_chunks.append(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>.join(current_group))</span>
<span id="cb7-26">                <span class="co" style="color: #5E5E5E;"># Reset current group, keeping the header</span></span>
<span id="cb7-27">                current_group <span class="op" style="color: #5E5E5E;">=</span> [current_header]</span>
<span id="cb7-28"></span>
<span id="cb7-29">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>:  <span class="co" style="color: #5E5E5E;"># Only add if group has content besides header</span></span>
<span id="cb7-30">        <span class="co" style="color: #5E5E5E;"># Add any remaining group to combined chunks</span></span>
<span id="cb7-31">        combined_chunks.append(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>.join(current_group))</span>
<span id="cb7-32"></span>
<span id="cb7-33">    <span class="cf" style="color: #003B4F;">return</span> combined_chunks</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:04.360423Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:04.360060Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:04.367195Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:04.366259Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:04.360389Z&quot;}" data-trusted="true" data-execution_count="5">
<details>
<summary>Show the <code>load_data</code> function used for full text search</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;">def</span> load_data(chunks, db_path, chapter<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb8-2">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb8-3">        <span class="co" style="color: #5E5E5E;"># create virtual table if database doesn't exist</span></span>
<span id="cb8-4">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> os.path.exists(db_path):</span>
<span id="cb8-5">            <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(db_path) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb8-6">              cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb8-7">              cur.execute(<span class="st" style="color: #20794D;">"""</span></span>
<span id="cb8-8"><span class="st" style="color: #20794D;">              CREATE VIRTUAL TABLE fastbook_text</span></span>
<span id="cb8-9"><span class="st" style="color: #20794D;">              USING FTS5(chapter, text);</span></span>
<span id="cb8-10"><span class="st" style="color: #20794D;">              """</span>)</span>
<span id="cb8-11">              conn.commit()</span>
<span id="cb8-12"></span>
<span id="cb8-13">        <span class="co" style="color: #5E5E5E;"># load in the chunks for each chapter</span></span>
<span id="cb8-14">        <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(db_path) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb8-15">            cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb8-16"></span>
<span id="cb8-17">            <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks:</span>
<span id="cb8-18">                cur.execute(<span class="st" style="color: #20794D;">"INSERT INTO fastbook_text(chapter, text) VALUES (?, ?)"</span>, (chapter, chunk))</span>
<span id="cb8-19"></span>
<span id="cb8-20">            conn.commit()</span>
<span id="cb8-21">            res <span class="op" style="color: #5E5E5E;">=</span> cur.execute(<span class="st" style="color: #20794D;">"SELECT * FROM fastbook_text WHERE chapter = ?"</span>, (chapter,)).fetchall()</span>
<span id="cb8-22">        <span class="co" style="color: #5E5E5E;"># make sure all the data was loaded into the database</span></span>
<span id="cb8-23">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">!=</span> <span class="bu" style="color: null;">len</span>(chunks):</span>
<span id="cb8-24">            <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(<span class="ss" style="color: #20794D;">f"Number of inserted chunks (</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(res)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">) doesn't match input chunks (</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(chunks)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">)"</span>)</span>
<span id="cb8-25"></span>
<span id="cb8-26">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb8-27"></span>
<span id="cb8-28">    <span class="cf" style="color: #003B4F;">except</span> sqlite3.Error <span class="im" style="color: #00769E;">as</span> e:</span>
<span id="cb8-29">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"An error occurred: </span><span class="sc" style="color: #5E5E5E;">{</span>e<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb8-30">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb8-31">    <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">Exception</span> <span class="im" style="color: #00769E;">as</span> e:</span>
<span id="cb8-32">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"An unexpected error occurred: </span><span class="sc" style="color: #5E5E5E;">{</span>e<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb8-33">        <span class="cf" style="color: #003B4F;">return</span> <span class="va" style="color: #111111;">False</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:10.555260Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:10.554898Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:10.561423Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:10.560523Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:10.555227Z&quot;}" data-trusted="true" data-execution_count="6">
<details>
<summary>Show the <code>db_search</code> function used for full text search</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;">def</span> db_search(df, limit<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb9-2">  results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb9-3">  <span class="cf" style="color: #003B4F;">with</span> sqlite3.<span class="ex" style="color: null;">connect</span>(<span class="st" style="color: #20794D;">'fastbook.db'</span>) <span class="im" style="color: #00769E;">as</span> conn:</span>
<span id="cb9-4">    cur <span class="op" style="color: #5E5E5E;">=</span> conn.cursor()</span>
<span id="cb9-5">    <span class="co" style="color: #5E5E5E;"># concatenate the keywords into a string "keyword1 OR keyword 2 OR keyword3 ..."</span></span>
<span id="cb9-6">    <span class="cf" style="color: #003B4F;">for</span> _, row <span class="kw" style="color: #003B4F;">in</span> df.iterrows():</span>
<span id="cb9-7">      keywords <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">' OR '</span>.join([<span class="ss" style="color: #20794D;">f'"</span><span class="sc" style="color: #5E5E5E;">{</span>keyword<span class="sc" style="color: #5E5E5E;">.</span>strip(<span class="st" style="color: #20794D;">","</span>)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"'</span> <span class="cf" style="color: #003B4F;">for</span> keyword <span class="kw" style="color: #003B4F;">in</span> row[<span class="st" style="color: #20794D;">'keywords'</span>].replace(<span class="st" style="color: #20794D;">'"'</span>, <span class="st" style="color: #20794D;">''</span>).split()])</span>
<span id="cb9-8"></span>
<span id="cb9-9">      q <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"""</span></span>
<span id="cb9-10"><span class="ss" style="color: #20794D;">        SELECT text, rank</span></span>
<span id="cb9-11"><span class="ss" style="color: #20794D;">        FROM fastbook_text</span></span>
<span id="cb9-12"><span class="ss" style="color: #20794D;">        WHERE fastbook_text MATCH ?</span></span>
<span id="cb9-13"><span class="ss" style="color: #20794D;">        AND chapter = ?</span></span>
<span id="cb9-14"><span class="ss" style="color: #20794D;">        ORDER BY rank</span></span>
<span id="cb9-15"><span class="ss" style="color: #20794D;">        LIMIT ?</span></span>
<span id="cb9-16"><span class="ss" style="color: #20794D;">        """</span></span>
<span id="cb9-17">      res <span class="op" style="color: #5E5E5E;">=</span> cur.execute(q, (keywords, <span class="bu" style="color: null;">str</span>(row[<span class="st" style="color: #20794D;">'chapter'</span>]), limit)).fetchall()</span>
<span id="cb9-18">      <span class="co" style="color: #5E5E5E;"># grab the retrieved chunk from the query results</span></span>
<span id="cb9-19">      res <span class="op" style="color: #5E5E5E;">=</span> [item[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> item <span class="kw" style="color: #003B4F;">in</span> res]</span>
<span id="cb9-20"></span>
<span id="cb9-21">      <span class="co" style="color: #5E5E5E;"># if there are multiple chunks retrieved, combine them into a single string</span></span>
<span id="cb9-22">      results.append(res)</span>
<span id="cb9-23"></span>
<span id="cb9-24">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:18.494100Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:18.493681Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:37.633040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:37.632137Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:18.494059Z&quot;}" data-outputid="5ae64c31-c3da-4454-8bda-9378f25d3613" data-trusted="true" data-execution_count="7">
<details>
<summary>Download chapter ipynb files</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">urls <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;">'01_intro.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1mmBjFH_plndPBC4iRZHChfMazgBxKK4_'</span>,</span>
<span id="cb10-3">    <span class="st" style="color: #20794D;">'02_production.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1Cf5QHthHy1z13H0iu3qrzAWgquCfqVHk'</span>,</span>
<span id="cb10-4">    <span class="st" style="color: #20794D;">'04_mnist_basics.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=113909_BNulzyLIKUNJHdya0Hhoqie30I'</span>,</span>
<span id="cb10-5">    <span class="st" style="color: #20794D;">'08_collab.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1BtvStgFjUtvtqbSZNrL7Y2N-ey3seNZU'</span>,</span>
<span id="cb10-6">    <span class="st" style="color: #20794D;">'09_tabular.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1rHFvwl_l-AJLg_auPjBpNrOgG9HDnfqg'</span>,</span>
<span id="cb10-7">    <span class="st" style="color: #20794D;">'10_nlp.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=1pg1pH7jMMElzrXS0kBBz14aAuDsi2DEP'</span>,</span>
<span id="cb10-8">    <span class="st" style="color: #20794D;">'13_convolutions.ipynb'</span>: <span class="st" style="color: #20794D;">'https://drive.google.com/uc?export=view&amp;id=19P-eEHpAO3WrOvdxgXckyhHhfv_R-hnS'</span></span>
<span id="cb10-9">}</span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="kw" style="color: #003B4F;">def</span> download_file(url, filename):</span>
<span id="cb10-12">    <span class="co" style="color: #5E5E5E;"># Send a GET request to the URL</span></span>
<span id="cb10-13">    response <span class="op" style="color: #5E5E5E;">=</span> requests.get(url)</span>
<span id="cb10-14"></span>
<span id="cb10-15">    <span class="co" style="color: #5E5E5E;"># Check if the request was successful</span></span>
<span id="cb10-16">    <span class="cf" style="color: #003B4F;">if</span> response.status_code <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">200</span>:</span>
<span id="cb10-17">        <span class="co" style="color: #5E5E5E;"># Open the file in write-binary mode</span></span>
<span id="cb10-18">        <span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(filename, <span class="st" style="color: #20794D;">'wb'</span>) <span class="im" style="color: #00769E;">as</span> <span class="bu" style="color: null;">file</span>:</span>
<span id="cb10-19">            <span class="co" style="color: #5E5E5E;"># Write the content of the response to the file</span></span>
<span id="cb10-20">            <span class="bu" style="color: null;">file</span>.write(response.content)</span>
<span id="cb10-21">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"File downloaded successfully: </span><span class="sc" style="color: #5E5E5E;">{</span>filename<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-22">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb10-23">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Failed to download file. Status code: </span><span class="sc" style="color: #5E5E5E;">{</span>response<span class="sc" style="color: #5E5E5E;">.</span>status_code<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-24"></span>
<span id="cb10-25"><span class="cf" style="color: #003B4F;">for</span> fname, url <span class="kw" style="color: #003B4F;">in</span> urls.items():</span>
<span id="cb10-26">  download_file(url, fname)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: 01_intro.ipynb
File downloaded successfully: 02_production.ipynb
File downloaded successfully: 04_mnist_basics.ipynb
File downloaded successfully: 08_collab.ipynb
File downloaded successfully: 09_tabular.ipynb
File downloaded successfully: 10_nlp.ipynb
File downloaded successfully: 13_convolutions.ipynb</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:41.213422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:41.213043Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:41.217836Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:41.216877Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:41.213381Z&quot;}" data-trusted="true" data-execution_count="8">
<details>
<summary>Show the dict w/ notebook filenames</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">nbs <span class="op" style="color: #5E5E5E;">=</span> {</span>
<span id="cb12-2">    <span class="st" style="color: #20794D;">'1'</span>: <span class="st" style="color: #20794D;">'01_intro.ipynb'</span>,</span>
<span id="cb12-3">    <span class="st" style="color: #20794D;">'2'</span>: <span class="st" style="color: #20794D;">'02_production.ipynb'</span>,</span>
<span id="cb12-4">    <span class="st" style="color: #20794D;">'4'</span>: <span class="st" style="color: #20794D;">'04_mnist_basics.ipynb'</span>,</span>
<span id="cb12-5">    <span class="st" style="color: #20794D;">'8'</span>: <span class="st" style="color: #20794D;">'08_collab.ipynb'</span>,</span>
<span id="cb12-6">    <span class="st" style="color: #20794D;">'9'</span>: <span class="st" style="color: #20794D;">'09_tabular.ipynb'</span>,</span>
<span id="cb12-7">    <span class="st" style="color: #20794D;">'10'</span>: <span class="st" style="color: #20794D;">'10_nlp.ipynb'</span>,</span>
<span id="cb12-8">    <span class="st" style="color: #20794D;">'13'</span>: <span class="st" style="color: #20794D;">'13_convolutions.ipynb'</span></span>
<span id="cb12-9">}</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:47.840474Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:47.839850Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:48.275128Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:48.274245Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:47.840432Z&quot;}" data-outputid="062365c7-026f-415c-82a8-2487ac087279" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;"># load the question texts</span></span>
<span id="cb13-2">url <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'https://gist.githubusercontent.com/vishalbakshi/2c22ca69ac7bc4bc845052c1b9d949c8/raw/d498259f2fc75d27c485ddc73933f145987feef3/cs_bm25_baselines.csv'</span></span>
<span id="cb13-3">questions <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(url).query(<span class="st" style="color: #20794D;">"is_answerable == 1"</span>)[[<span class="st" style="color: #20794D;">"chapter"</span>, <span class="st" style="color: #20794D;">"question_number"</span>, <span class="st" style="color: #20794D;">"question_text"</span>, <span class="st" style="color: #20794D;">"answer"</span>, <span class="st" style="color: #20794D;">"keywords"</span>]]</span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;"># remove double quotations from the question text</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;"># as these affect embeddings/cosine similarity: https://vishalbakshi.github.io/blog/posts/2024-11-08-punctuation-cosine-similarity/</span></span>
<span id="cb13-7">questions[<span class="st" style="color: #20794D;">'question_text'</span>] <span class="op" style="color: #5E5E5E;">=</span> questions[<span class="st" style="color: #20794D;">'question_text'</span>].<span class="bu" style="color: null;">str</span>.strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>)</span>
<span id="cb13-8">questions.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">


  <div id="df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>keywords</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>Do you need these for deep learning?\n\n- Lots...</td>
      <td>"Lots of math - False\nLots of data - False\nL...</td>
      <td>"deep learning, math, data, computers, PhD"</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>Name five areas where deep learning is now the...</td>
      <td>"Any five of the following:\nNatural Language ...</td>
      <td>deep learning, areas, best, world</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>What was the name of the first device that was...</td>
      <td>"Mark I perceptron built by Frank Rosenblatt"</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>Based on the book of the same name, what are t...</td>
      <td>"A set of processing units\nA state of activat...</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>What were the two theoretical misunderstanding...</td>
      <td>"In 1969, Marvin Minsky and Seymour Papert dem...</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-05c06f37-b463-46c7-b469-35a27b3ccafc">
  <button class="colab-df-quickchart" onclick="quickchart('df-05c06f37-b463-46c7-b469-35a27b3ccafc')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-05c06f37-b463-46c7-b469-35a27b3ccafc button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:55.266890Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:55.265966Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:55.271153Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:55.270326Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:55.266842Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="cf" style="color: #003B4F;">assert</span> questions.shape <span class="op" style="color: #5E5E5E;">==</span> (<span class="dv" style="color: #AD0000;">191</span>,<span class="dv" style="color: #AD0000;">5</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:05.050170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:05.049578Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:05.255531Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:05.254600Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:05.050132Z&quot;}" data-outputid="16dfee82-dbf5-42b4-ef9b-6e7c4954cb08" data-trusted="true" data-execution_count="163">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;"># download fastbook-benchmark</span></span>
<span id="cb15-2">download_file(</span>
<span id="cb15-3">    <span class="st" style="color: #20794D;">"https://gist.githubusercontent.com/vishalbakshi/a507b6e9e893475e93a4141e96b8947d/raw/e32835ba1dbf94384943ed5a65404112e1c89df2/fastbook-benchmark.json"</span>,</span>
<span id="cb15-4">    <span class="st" style="color: #20794D;">"fastbook-benchmark.json"</span></span>
<span id="cb15-5">    )</span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="co" style="color: #5E5E5E;"># Load the benchmark data</span></span>
<span id="cb15-8"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'fastbook-benchmark.json'</span>, <span class="st" style="color: #20794D;">'r'</span>) <span class="im" style="color: #00769E;">as</span> f:</span>
<span id="cb15-9">    benchmark <span class="op" style="color: #5E5E5E;">=</span> json.load(f)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: fastbook-benchmark.json</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:11.224927Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:11.224542Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:11.229055Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:11.228216Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:11.224887Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(benchmark[<span class="st" style="color: #20794D;">'questions'</span>]) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:18.313016Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:18.312453Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:18.318329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:18.317466Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:18.312980Z&quot;}" data-trusted="true" data-execution_count="13">
<details>
<summary>Show <code>calculate_mrr</code> function</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;">def</span> calculate_mrr(question, retrieved_passages, cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb18-2">    retrieved_passages <span class="op" style="color: #5E5E5E;">=</span> retrieved_passages[:cutoff]</span>
<span id="cb18-3">    highest_rank <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb18-4"></span>
<span id="cb18-5">    <span class="cf" style="color: #003B4F;">for</span> ans_comp <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">"answer_context"</span>]:</span>
<span id="cb18-6">        contexts <span class="op" style="color: #5E5E5E;">=</span> ans_comp.get(<span class="st" style="color: #20794D;">"context"</span>, [])</span>
<span id="cb18-7">        component_found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb18-8"></span>
<span id="cb18-9">        <span class="cf" style="color: #003B4F;">for</span> rank, passage <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(retrieved_passages, start<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb18-10">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">any</span>(fix_text(context) <span class="kw" style="color: #003B4F;">in</span> fix_text(passage) <span class="cf" style="color: #003B4F;">for</span> context <span class="kw" style="color: #003B4F;">in</span> contexts):</span>
<span id="cb18-11">                highest_rank <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(highest_rank, rank)</span>
<span id="cb18-12">                component_found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb18-13">                <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb18-14"></span>
<span id="cb18-15">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> component_found:</span>
<span id="cb18-16">            <span class="cf" style="color: #003B4F;">return</span> <span class="fl" style="color: #AD0000;">0.0</span></span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="cf" style="color: #003B4F;">return</span> <span class="fl" style="color: #AD0000;">1.0</span><span class="op" style="color: #5E5E5E;">/</span>highest_rank <span class="cf" style="color: #003B4F;">if</span> highest_rank <span class="op" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span> <span class="cf" style="color: #003B4F;">else</span> <span class="fl" style="color: #AD0000;">0.0</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:24.358734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:24.358394Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:24.364432Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:24.363549Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:24.358702Z&quot;}" data-trusted="true" data-execution_count="14">
<details>
<summary>Show <code>calculate_recall</code> function</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;">def</span> calculate_recall(question, retrieved_passages, cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb19-2">    retrieved_passages <span class="op" style="color: #5E5E5E;">=</span> retrieved_passages[:cutoff]</span>
<span id="cb19-3"></span>
<span id="cb19-4">    <span class="co" style="color: #5E5E5E;"># Track if we've found at least one context for each answer component</span></span>
<span id="cb19-5">    ans_comp_found <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb19-6"></span>
<span id="cb19-7">    <span class="cf" style="color: #003B4F;">for</span> ans_comp <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">"answer_context"</span>]:</span>
<span id="cb19-8">        contexts <span class="op" style="color: #5E5E5E;">=</span> ans_comp.get(<span class="st" style="color: #20794D;">"context"</span>, [])</span>
<span id="cb19-9">        found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb19-10"></span>
<span id="cb19-11">        <span class="co" style="color: #5E5E5E;"># Check if any context for this answer component appears in retrieved passages</span></span>
<span id="cb19-12">        <span class="cf" style="color: #003B4F;">for</span> passage <span class="kw" style="color: #003B4F;">in</span> retrieved_passages:</span>
<span id="cb19-13">            <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">any</span>(fix_text(context) <span class="kw" style="color: #003B4F;">in</span> fix_text(passage) <span class="cf" style="color: #003B4F;">for</span> context <span class="kw" style="color: #003B4F;">in</span> contexts):</span>
<span id="cb19-14">                found <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb19-15">                <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb19-16"></span>
<span id="cb19-17">        ans_comp_found.append(found)</span>
<span id="cb19-18"></span>
<span id="cb19-19">    <span class="co" style="color: #5E5E5E;"># Recall is ratio of answer components with at least one found context</span></span>
<span id="cb19-20">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">sum</span>(ans_comp_found) <span class="op" style="color: #5E5E5E;">/</span> <span class="bu" style="color: null;">len</span>(ans_comp_found)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:31.976734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:31.976386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:31.982038Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:31.981238Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:31.976705Z&quot;}" data-trusted="true" data-execution_count="15">
<details>
<summary>Show <code>fts_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;">def</span> fts_retrieval(data, questions):</span>
<span id="cb20-2">    <span class="cf" style="color: #003B4F;">if</span> os.path.exists(<span class="st" style="color: #20794D;">"fastbook.db"</span>):</span>
<span id="cb20-3">        os.remove(<span class="st" style="color: #20794D;">"fastbook.db"</span>)</span>
<span id="cb20-4"></span>
<span id="cb20-5">    <span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb20-6">      <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Chapter </span><span class="sc" style="color: #5E5E5E;">{</span>chapter<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">:"</span>, load_data(chunks, <span class="st" style="color: #20794D;">'fastbook.db'</span>, chapter))</span>
<span id="cb20-7"></span>
<span id="cb20-8">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Retrieving passages..."</span>)</span>
<span id="cb20-9">    results <span class="op" style="color: #5E5E5E;">=</span> db_search(questions, limit<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb20-10"></span>
<span id="cb20-11">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb20-12">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb20-13">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb20-14"></span>
<span id="cb20-15">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Retrieval complete."</span>)</span>
<span id="cb20-16">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:40.213339Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:40.212942Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:40.221922Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:40.221014Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:40.213297Z&quot;}" data-trusted="true" data-execution_count="16">
<details>
<summary>Show <code>single_vector_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;">def</span> single_vector_retrieval(data, benchmark):</span>
<span id="cb21-2">    <span class="co" style="color: #5E5E5E;"># Group questions by chapter</span></span>
<span id="cb21-3">    questions <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb21-4">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> benchmark[<span class="st" style="color: #20794D;">"questions"</span>]:</span>
<span id="cb21-5">        chapter <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(q[<span class="st" style="color: #20794D;">"chapter"</span>])</span>
<span id="cb21-6">        <span class="cf" style="color: #003B4F;">if</span> chapter <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> questions:</span>
<span id="cb21-7">            questions[chapter] <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb21-8">        questions[chapter].append(q[<span class="st" style="color: #20794D;">'question_text'</span>].strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>))</span>
<span id="cb21-9"></span>
<span id="cb21-10">    q_embs <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb21-11">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Encoding Questions..."</span>)</span>
<span id="cb21-12">    <span class="cf" style="color: #003B4F;">for</span> chapter, _ <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb21-13">        qs <span class="op" style="color: #5E5E5E;">=</span> questions[chapter]</span>
<span id="cb21-14">        q_embs[chapter] <span class="op" style="color: #5E5E5E;">=</span> emb_model.encode(qs, convert_to_tensor<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb21-15"></span>
<span id="cb21-16">    data_embs <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb21-17">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Encoding Data..."</span>)</span>
<span id="cb21-18">    <span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb21-19">        data_embs[chapter] <span class="op" style="color: #5E5E5E;">=</span> emb_model.encode(chunks, convert_to_tensor<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb21-20"></span>
<span id="cb21-21">    results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb21-22">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Retrieving passages..."</span>)</span>
<span id="cb21-23">    <span class="cf" style="color: #003B4F;">for</span> chapter <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'1'</span>, <span class="st" style="color: #20794D;">'2'</span>, <span class="st" style="color: #20794D;">'4'</span>, <span class="st" style="color: #20794D;">'8'</span>, <span class="st" style="color: #20794D;">'9'</span>, <span class="st" style="color: #20794D;">'10'</span>, <span class="st" style="color: #20794D;">'13'</span>]:</span>
<span id="cb21-24">        <span class="co" style="color: #5E5E5E;"># Compute cosine similarity and get top 10 indices for each row</span></span>
<span id="cb21-25">        idxs <span class="op" style="color: #5E5E5E;">=</span> F.cosine_similarity(q_embs[chapter].unsqueeze(<span class="dv" style="color: #AD0000;">1</span>), data_embs[chapter].unsqueeze(<span class="dv" style="color: #AD0000;">0</span>), dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>).sort(descending<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb21-26">        top_10_idxs <span class="op" style="color: #5E5E5E;">=</span> idxs[:, :<span class="dv" style="color: #AD0000;">10</span>]  <span class="co" style="color: #5E5E5E;"># Get the top 10 indices for each row</span></span>
<span id="cb21-27"></span>
<span id="cb21-28">        <span class="co" style="color: #5E5E5E;"># Extract top 10 chunks for each row</span></span>
<span id="cb21-29">        top_10_chunks <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb21-30">            [data[chapter][idx.item()] <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> row_idxs]</span>
<span id="cb21-31">            <span class="cf" style="color: #003B4F;">for</span> row_idxs <span class="kw" style="color: #003B4F;">in</span> top_10_idxs</span>
<span id="cb21-32">        ]</span>
<span id="cb21-33">        results.extend(top_10_chunks)</span>
<span id="cb21-34"></span>
<span id="cb21-35">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb21-36"></span>
<span id="cb21-37">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb21-38">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb21-39"></span>
<span id="cb21-40">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Retrieval complete."</span>)</span>
<span id="cb21-41">    <span class="cf" style="color: #003B4F;">return</span> results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:06:39.877391Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:06:39.877005Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:06:39.885940Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:06:39.885048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:06:39.877357Z&quot;}" data-trusted="true" data-execution_count="17">
<details>
<summary>Show <code>ragetouille_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;">def</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbert-ir/colbertv2.0"</span>):</span>
<span id="cb22-2">    <span class="co" style="color: #5E5E5E;"># Group questions by chapter</span></span>
<span id="cb22-3">    questions_by_chapter <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb22-4">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> benchmark[<span class="st" style="color: #20794D;">"questions"</span>]:</span>
<span id="cb22-5">        chapter <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">str</span>(q[<span class="st" style="color: #20794D;">"chapter"</span>])</span>
<span id="cb22-6">        <span class="cf" style="color: #003B4F;">if</span> chapter <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> questions_by_chapter:</span>
<span id="cb22-7">            questions_by_chapter[chapter] <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb22-8">        questions_by_chapter[chapter].append(q)</span>
<span id="cb22-9"></span>
<span id="cb22-10">    <span class="co" style="color: #5E5E5E;"># Dictionary to store results per chapter</span></span>
<span id="cb22-11">    chapter_results <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb22-12">    chapter_metrics <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb22-13"></span>
<span id="cb22-14">    <span class="co" style="color: #5E5E5E;"># Initialize ColBERTv2</span></span>
<span id="cb22-15">    RAG <span class="op" style="color: #5E5E5E;">=</span> RAGPretrainedModel.from_pretrained(model_nm)</span>
<span id="cb22-16"></span>
<span id="cb22-17">    <span class="co" style="color: #5E5E5E;"># Process each chapter separately</span></span>
<span id="cb22-18">    <span class="cf" style="color: #003B4F;">for</span> chapter <span class="kw" style="color: #003B4F;">in</span> nbs.keys():</span>
<span id="cb22-19">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"</span><span class="ch" style="color: #20794D;">\n</span><span class="ss" style="color: #20794D;">Processing Chapter </span><span class="sc" style="color: #5E5E5E;">{</span>chapter<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb22-20"></span>
<span id="cb22-21">        <span class="co" style="color: #5E5E5E;"># Create chapter-specific index</span></span>
<span id="cb22-22">        index_path <span class="op" style="color: #5E5E5E;">=</span> RAG.index(</span>
<span id="cb22-23">            index_name<span class="op" style="color: #5E5E5E;">=</span><span class="ss" style="color: #20794D;">f"chapter_</span><span class="sc" style="color: #5E5E5E;">{</span>chapter<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_index"</span>,</span>
<span id="cb22-24">            collection<span class="op" style="color: #5E5E5E;">=</span>data[chapter],</span>
<span id="cb22-25">            document_ids<span class="op" style="color: #5E5E5E;">=</span>[<span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>chapter<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_</span><span class="sc" style="color: #5E5E5E;">{</span>i<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span> <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(data[chapter]))]</span>
<span id="cb22-26">        )</span>
<span id="cb22-27"></span>
<span id="cb22-28">        <span class="co" style="color: #5E5E5E;"># Get questions for this chapter</span></span>
<span id="cb22-29">        chapter_questions <span class="op" style="color: #5E5E5E;">=</span> questions_by_chapter[chapter]</span>
<span id="cb22-30"></span>
<span id="cb22-31">        <span class="co" style="color: #5E5E5E;"># Perform retrieval for each question in this chapter</span></span>
<span id="cb22-32">        results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb22-33">        <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> chapter_questions:</span>
<span id="cb22-34">            retrieved <span class="op" style="color: #5E5E5E;">=</span> RAG.search(q[<span class="st" style="color: #20794D;">"question_text"</span>].strip(<span class="st" style="color: #20794D;">'"</span><span class="ch" style="color: #20794D;">\'</span><span class="st" style="color: #20794D;">'</span>), k<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb22-35">            results.append(retrieved)</span>
<span id="cb22-36"></span>
<span id="cb22-37">        <span class="co" style="color: #5E5E5E;"># Store results</span></span>
<span id="cb22-38">        chapter_results[chapter] <span class="op" style="color: #5E5E5E;">=</span> results</span>
<span id="cb22-39"></span>
<span id="cb22-40">    results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb22-41">    <span class="cf" style="color: #003B4F;">for</span> chapter, res <span class="kw" style="color: #003B4F;">in</span> chapter_results.items():</span>
<span id="cb22-42">        results.extend(res)</span>
<span id="cb22-43"></span>
<span id="cb22-44">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb22-45"></span>
<span id="cb22-46">    final_results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb22-47">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb22-48">        <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(res) <span class="op" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb22-49">        intermediate_results <span class="op" style="color: #5E5E5E;">=</span> [r[<span class="st" style="color: #20794D;">'content'</span>] <span class="cf" style="color: #003B4F;">for</span> r <span class="kw" style="color: #003B4F;">in</span> res]</span>
<span id="cb22-50">        final_results.append(intermediate_results)</span>
<span id="cb22-51"></span>
<span id="cb22-52">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Retrieval complete."</span>)</span>
<span id="cb22-53">    <span class="cf" style="color: #003B4F;">return</span> final_results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:06:51.651038Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:06:51.650684Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:06:51.656817Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:06:51.655754Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:06:51.651007Z&quot;}" data-trusted="true" data-execution_count="18">
<details>
<summary>Show <code>do_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;">def</span> do_retrieval(method, chunking_strategy, data, benchmark, benchmark_results, questions<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb23-2">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"bm25"</span>: results <span class="op" style="color: #5E5E5E;">=</span> fts_retrieval(data, questions)</span>
<span id="cb23-3">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"single_vector"</span>: results <span class="op" style="color: #5E5E5E;">=</span> single_vector_retrieval(data, benchmark)</span>
<span id="cb23-4">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"colbertv2"</span>: results <span class="op" style="color: #5E5E5E;">=</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbert-ir/colbertv2.0"</span>)</span>
<span id="cb23-5">  <span class="cf" style="color: #003B4F;">if</span> method <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"answerai_colbert"</span>: results <span class="op" style="color: #5E5E5E;">=</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerdotai/answerai-colbert-small-v1"</span>)</span>
<span id="cb23-6"></span>
<span id="cb23-7">  name <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"</span><span class="sc" style="color: #5E5E5E;">{</span>method<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_</span><span class="sc" style="color: #5E5E5E;">{</span>chunking_strategy<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span>
<span id="cb23-8">  q_mrr, q_recall <span class="op" style="color: #5E5E5E;">=</span> score_retrieval(results, benchmark)</span>
<span id="cb23-9">  benchmark_results <span class="op" style="color: #5E5E5E;">=</span> save_results(results, benchmark_results, q_mrr, q_recall, name<span class="op" style="color: #5E5E5E;">=</span>name)</span>
<span id="cb23-10"></span>
<span id="cb23-11">  <span class="cf" style="color: #003B4F;">return</span> benchmark_results</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:43:03.484422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:43:03.483575Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:43:03.491562Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:43:03.490588Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:43:03.484360Z&quot;}" data-trusted="true" data-execution_count="19">
<details>
<summary>Show <code>score_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;">def</span> score_retrieval(results, benchmark):</span>
<span id="cb24-2">    q_mrr <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb24-3">    q_recall <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb24-4"></span>
<span id="cb24-5">    <span class="cf" style="color: #003B4F;">for</span> i, question <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(benchmark[<span class="st" style="color: #20794D;">"questions"</span>]):</span>
<span id="cb24-6">        mrr <span class="op" style="color: #5E5E5E;">=</span> calculate_mrr(question, results[i], cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb24-7">        recall <span class="op" style="color: #5E5E5E;">=</span> calculate_recall(question, results[i], cutoff<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb24-8">        q_mrr.append(mrr)</span>
<span id="cb24-9">        q_recall.append(recall)</span>
<span id="cb24-10"></span>
<span id="cb24-11">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(q_mrr) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb24-12">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(q_recall) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb24-13"></span>
<span id="cb24-14">    <span class="cf" style="color: #003B4F;">return</span> q_mrr, q_recall</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:43:09.476964Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:43:09.476628Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:43:09.481771Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:43:09.480823Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:43:09.476931Z&quot;}" data-trusted="true" data-execution_count="20">
<details>
<summary>Show <code>save_results</code> function</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;">def</span> save_results(results, df, q_mrr, q_recall, name):</span>
<span id="cb25-2">    flat_results <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb25-3">    <span class="cf" style="color: #003B4F;">for</span> res <span class="kw" style="color: #003B4F;">in</span> results:</span>
<span id="cb25-4">        flat_results.append(<span class="st" style="color: #20794D;">"</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">"</span>.join(res))</span>
<span id="cb25-5"></span>
<span id="cb25-6">    <span class="cf" style="color: #003B4F;">assert</span> <span class="bu" style="color: null;">len</span>(flat_results) <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">191</span></span>
<span id="cb25-7"></span>
<span id="cb25-8">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_retrieval'</span>] <span class="op" style="color: #5E5E5E;">=</span> flat_results</span>
<span id="cb25-9">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_mrr10'</span>] <span class="op" style="color: #5E5E5E;">=</span> q_mrr</span>
<span id="cb25-10">    df[<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>name<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_recall10'</span>] <span class="op" style="color: #5E5E5E;">=</span> q_recall</span>
<span id="cb25-11"></span>
<span id="cb25-12">    <span class="cf" style="color: #003B4F;">return</span> df</span></code></pre></div>
</details>
</div>
</section>
<section id="chunking-strategy-a-1-paragraph-with-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-a-1-paragraph-with-headers">Chunking Strategy A: 1-Paragraph (with headers)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:51:29.646506Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:51:29.645668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:51:29.685541Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:51:29.684729Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:51:29.646468Z&quot;}" data-outputid="a60b9b2b-05fd-4a7b-db14-bf2e9beb44e3" data-trusted="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;"># chunking each notebook</span></span>
<span id="cb26-2">data <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb26-3"></span>
<span id="cb26-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb26-5">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> get_chunks(nb)</span>
<span id="cb26-6"></span>
<span id="cb26-7">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb26-8"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb26-9">  <span class="bu" style="color: null;">print</span>(chapter, <span class="bu" style="color: null;">len</span>(chunks))</span>
<span id="cb26-10">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb26-11"></span>
<span id="cb26-12"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1967</span> <span class="co" style="color: #5E5E5E;"># 1-paragraph chunks</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 307
2 227
4 433
8 157
9 387
10 190
13 266</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:52:53.273359Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:52:53.272986Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:52:54.283069Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:52:54.282328Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:52:53.273326Z&quot;}" data-outputid="3f99d796-b24e-438f-90a8-ff2eb672f1de" data-trusted="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb28-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb28-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"A"</span>,</span>
<span id="cb28-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb28-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb28-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>questions.copy(),</span>
<span id="cb28-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:52:59.673041Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:52:59.672738Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:52:59.679368Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:52:59.678484Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:52:59.673016Z&quot;}" data-outputid="e864e397-6c5c-448a-a695-d44dc34f075c" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_A_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_A_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(0.3, 0.65)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:53:13.136073Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:53:13.135765Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:53:19.206390Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:53:19.205660Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:53:13.136046Z&quot;}" data-outputid="fb291378-abfe-47e5-f8a4-2a798a99979e" data-trusted="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb32-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb32-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"A"</span>,</span>
<span id="cb32-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb32-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb32-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:53:22.883480Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:53:22.883045Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:53:22.890175Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:53:22.889157Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:53:22.883444Z&quot;}" data-outputid="d1507f36-f5b7-4c92-e298-4767378245b3" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_A_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_A_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(0.38, 0.71)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb36-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb36-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"A"</span>,</span>
<span id="cb36-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb36-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb36-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:10:44.232174Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:10:44.231884Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:10:44.238858Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:10:44.238107Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:10:44.232146Z&quot;}" data-outputid="c0cee31e-9fe6-4d72-a579-90d37f48cf5e" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_A_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_A_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(0.46, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb39-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb39-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"A"</span>,</span>
<span id="cb39-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb39-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb39-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:14:41.402607Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:14:41.401908Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:14:41.408764Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:14:41.407873Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:14:41.402570Z&quot;}" data-outputid="411aee2a-727b-424b-bc14-16097044747e" data-trusted="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_A_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_A_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>(0.48, 0.82)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-b-3-paragraph-with-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-b-3-paragraph-with-headers">Chunking Strategy B: 3-Paragraph (with headers)</h2>
<p>Next, I’ll expand the chunks to include 3-paragraphs at a time. I’m still keeping the headers.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:15:08.474995Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:15:08.474668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:15:08.484289Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:15:08.483444Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:15:08.474963Z&quot;}" data-outputid="427c0da0-a586-486b-9613-ef5d171172be" data-trusted="true" data-execution_count="30">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb42-2">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> combine_chunks(chunks, num_p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb42-3"></span>
<span id="cb42-4">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb42-5"></span>
<span id="cb42-6"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb42-7">  <span class="bu" style="color: null;">print</span>(chapter, <span class="bu" style="color: null;">len</span>(chunks))</span>
<span id="cb42-8">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb42-9"></span>
<span id="cb42-10"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">713</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 112
2 84
4 152
8 58
9 141
10 70
13 96</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-1">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:21:42.900175Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:21:42.899823Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:21:44.142204Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:21:44.141542Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:21:42.900141Z&quot;}" data-outputid="abd4dc29-24af-4ab6-d031-567c7a8497f9" data-trusted="true" data-execution_count="31">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb44-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb44-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"B"</span>,</span>
<span id="cb44-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb44-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb44-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results,</span>
<span id="cb44-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:21:44.731440Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:21:44.731076Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:21:44.737976Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:21:44.737048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:21:44.731406Z&quot;}" data-outputid="b886106b-7d30-48c1-f78c-9a97bd1e5b34" data-trusted="true" data-execution_count="32">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_B_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_B_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-1">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:22:23.269973Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:22:23.269748Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:22:29.060680Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:22:29.059996Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:22:23.269948Z&quot;}" data-outputid="ee004991-ee4f-4778-c6b7-72d459ac81c1" data-trusted="true" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb48-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb48-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"B"</span>,</span>
<span id="cb48-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb48-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb48-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:22:32.334662Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:22:32.333867Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:22:32.340872Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:22:32.339937Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:22:32.334624Z&quot;}" data-outputid="5484102d-1158-48c2-cb2e-f67d7751953b" data-trusted="true" data-execution_count="34">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_B_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_B_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(0.5, 0.85)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-1">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb52-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb52-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"B"</span>,</span>
<span id="cb52-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb52-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb52-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:26:40.994007Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:26:40.993740Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:26:41.000087Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:26:40.999259Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:26:40.993980Z&quot;}" data-outputid="7f153334-7712-4b1f-8277-54d93cf9ddcb" data-trusted="true" data-execution_count="36">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_B_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_B_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>(0.49, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-1">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb55-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb55-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"B"</span>,</span>
<span id="cb55-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb55-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb55-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:30:18.190218Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:30:18.189864Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:30:18.197158Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:30:18.196203Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:30:18.190179Z&quot;}" data-outputid="0fbaa6c4-f6e8-4fd3-a9dd-41fffe8a5eef" data-trusted="true" data-execution_count="38">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_B_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_B_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(0.52, 0.84)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-c-1-paragraph-wo-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-c-1-paragraph-wo-headers">Chunking Strategy C: 1-Paragraph (w/o headers)</h2>
<p>Next, I’ll remove markdown headers from each chunk.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:18:36.662925Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:18:36.662593Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:18:36.710061Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:18:36.709141Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:18:36.662894Z&quot;}" data-outputid="812b1cfa-de14-43a9-90f0-244bdfd34eb2" data-trusted="true" data-execution_count="39">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;"># chunking each notebook</span></span>
<span id="cb58-2">data <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb58-3"></span>
<span id="cb58-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb58-5">    data[chapter] <span class="op" style="color: #5E5E5E;">=</span> get_chunks(nb)</span>
<span id="cb58-6"></span>
<span id="cb58-7"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb58-8">    data[chapter] <span class="op" style="color: #5E5E5E;">=</span> [re.sub(<span class="vs" style="color: #20794D;">r'^#+\s+[^\n]+\n*'</span>, <span class="st" style="color: #20794D;">''</span>, c) <span class="cf" style="color: #003B4F;">for</span> c <span class="kw" style="color: #003B4F;">in</span> data[chapter]]</span>
<span id="cb58-9"></span>
<span id="cb58-10">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb58-11"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb58-12">    <span class="bu" style="color: null;">print</span>(chapter, <span class="bu" style="color: null;">len</span>(chunks))</span>
<span id="cb58-13">    total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb58-14"></span>
<span id="cb58-15"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1967</span> <span class="co" style="color: #5E5E5E;"># 1-paragraph chunks</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 307
2 227
4 433
8 157
9 387
10 190
13 266</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-2">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:50:28.409613Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:50:28.408983Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:50:29.306803Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:50:29.306115Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:50:28.409574Z&quot;}" data-outputid="2a763f15-020f-4031-e770-0115470e8698" data-trusted="true" data-execution_count="40">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb60-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb60-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"C"</span>,</span>
<span id="cb60-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb60-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb60-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results,</span>
<span id="cb60-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:50:29.977570Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:50:29.977247Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:50:29.983900Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:50:29.983041Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:50:29.977541Z&quot;}" data-outputid="7202028e-894e-4629-9d7c-a424626b1cfb" data-trusted="true" data-execution_count="41">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_C_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_C_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>(0.29, 0.65)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-2">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:51:05.345206Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:51:05.344866Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:51:10.910854Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:51:10.909942Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:51:05.345173Z&quot;}" data-outputid="8bb433d4-333f-4fe5-b908-480a0ecd232e" data-trusted="true" data-execution_count="42">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb64-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb64-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"C"</span>,</span>
<span id="cb64-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb64-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb64-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:51:19.644687Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:51:19.644254Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:51:19.651422Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:51:19.650429Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:51:19.644651Z&quot;}" data-outputid="e16721c1-080b-415d-898b-4bb81587c524" data-trusted="true" data-execution_count="43">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_C_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_C_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>(0.35, 0.72)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-2">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb68-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb68-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"C"</span>,</span>
<span id="cb68-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb68-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb68-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:55:36.156991Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:55:36.156709Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:55:36.163281Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:55:36.162427Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:55:36.156963Z&quot;}" data-outputid="00f173f8-10af-4ba9-f683-4445ac7b762e" data-trusted="true" data-execution_count="45">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_C_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_C_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>(0.41, 0.74)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-2">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb71-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb71-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"C"</span>,</span>
<span id="cb71-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb71-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb71-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:59:13.167358Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:59:13.166923Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:59:13.174970Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:59:13.174299Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:59:13.167298Z&quot;}" data-outputid="b4d69dc6-1001-4e86-f231-9f7d7e5c26ba" data-trusted="true" data-execution_count="47">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_C_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_C_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(0.45, 0.77)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-d-3-paragraph-wo-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-d-3-paragraph-wo-headers">Chunking Strategy D: 3-Paragraph (w/o headers)</h2>
<p>Expanding header-less chunks to 3-paragraphs.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:18:59.619716Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:18:59.618912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:18:59.624729Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:18:59.623786Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:18:59.619681Z&quot;}" data-trusted="true" data-execution_count="48">
<details>
<summary>Show modified <code>combine_chunks</code> function</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="kw" style="color: #003B4F;">def</span> combine_chunks2(chunks, num_p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>):</span>
<span id="cb74-2">    <span class="co" style="color: #5E5E5E;">"""</span></span>
<span id="cb74-3"><span class="co" style="color: #5E5E5E;">    Combines text chunks into groups of specified size (num_p).</span></span>
<span id="cb74-4"><span class="co" style="color: #5E5E5E;">    If chunks have no headers, treats them as standalone content.</span></span>
<span id="cb74-5"><span class="co" style="color: #5E5E5E;">    """</span></span>
<span id="cb74-6">    combined_chunks <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb74-7">    current_group <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb74-8"></span>
<span id="cb74-9">    <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks:</span>
<span id="cb74-10">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">&lt;</span> num_p:</span>
<span id="cb74-11">            current_group.append(chunk)</span>
<span id="cb74-12"></span>
<span id="cb74-13">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(current_group) <span class="op" style="color: #5E5E5E;">==</span> num_p:</span>
<span id="cb74-14">            combined_chunks.append(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>.join(current_group))</span>
<span id="cb74-15">            current_group <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb74-16"></span>
<span id="cb74-17">    <span class="co" style="color: #5E5E5E;"># Add any remaining chunks</span></span>
<span id="cb74-18">    <span class="cf" style="color: #003B4F;">if</span> current_group:</span>
<span id="cb74-19">        combined_chunks.append(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>.join(current_group))</span>
<span id="cb74-20"></span>
<span id="cb74-21">    <span class="cf" style="color: #003B4F;">return</span> combined_chunks</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:01.221431Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:01.221066Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:01.227953Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:01.227032Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:01.221397Z&quot;}" data-outputid="1a99dfba-0541-44f6-b31e-0e1f3cb0d4d0" data-trusted="true" data-execution_count="49">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb75-2">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> combine_chunks2(chunks, num_p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb75-3"></span>
<span id="cb75-4">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb75-5"></span>
<span id="cb75-6"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb75-7">  <span class="bu" style="color: null;">print</span>(chapter, <span class="bu" style="color: null;">len</span>(chunks))</span>
<span id="cb75-8">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb75-9"></span>
<span id="cb75-10"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">659</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 103
2 76
4 145
8 53
9 129
10 64
13 89</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-3">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:08.187884Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:08.187252Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:09.404320Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:09.403632Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:08.187848Z&quot;}" data-outputid="c829e29b-5397-49a6-c798-2ee73ab94753" data-trusted="true" data-execution_count="50">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb77-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb77-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"D"</span>,</span>
<span id="cb77-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb77-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb77-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results,</span>
<span id="cb77-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:11.000307Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:10.999957Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:11.006879Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:11.005978Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:11.000258Z&quot;}" data-outputid="8bb81432-28e6-4472-d2e1-05e14e0c1e0f" data-trusted="true" data-execution_count="51">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_D_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_D_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(0.44, 0.82)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-3">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:26.213399Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:26.212708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:31.639801Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:31.639098Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:26.213361Z&quot;}" data-outputid="8feac0c6-3779-4b47-90ad-e4ed75fa12aa" data-trusted="true" data-execution_count="52">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb81-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb81-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"D"</span>,</span>
<span id="cb81-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb81-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb81-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:31.860104Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:31.859901Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:31.866516Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:31.865665Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:31.860081Z&quot;}" data-outputid="6a21ac81-4f08-4ead-fffc-08ddccf49f01" data-trusted="true" data-execution_count="53">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_D_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_D_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(0.46, 0.82)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-3">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb85-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb85-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"D"</span>,</span>
<span id="cb85-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb85-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb85-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:25:00.952874Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:25:00.952598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:25:00.959190Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:25:00.958249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:25:00.952846Z&quot;}" data-outputid="db7e3b68-f54e-49f9-dada-53f746fe9d34" data-trusted="true" data-execution_count="55">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_D_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_D_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(0.5, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-3">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb88-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb88-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"D"</span>,</span>
<span id="cb88-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb88-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb88-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:28:36.873734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:28:36.873458Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:28:36.880094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:28:36.879220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:28:36.873707Z&quot;}" data-outputid="713135f7-7b6e-47f3-add7-5b3db7dbdbce" data-trusted="true" data-execution_count="57">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_D_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_D_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(0.52, 0.82)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-e-3-paragraph-wheaders-wo-html-tags" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-e-3-paragraph-wheaders-wo-html-tags">Chunking Strategy E: (3-paragraph w/headers, w/o HTML tags)</h2>
<p>I’ll add headers back, but will remove HTML tags.</p>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><span class="co" style="color: #5E5E5E;"># chunking each notebook</span></span>
<span id="cb91-2">data <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb91-3"></span>
<span id="cb91-4"><span class="cf" style="color: #003B4F;">for</span> chapter, nb <span class="kw" style="color: #003B4F;">in</span> nbs.items():</span>
<span id="cb91-5">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> get_chunks(nb)</span>
<span id="cb91-6"></span>
<span id="cb91-7">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb91-8"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb91-9">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb91-10"></span>
<span id="cb91-11"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1967</span> <span class="co" style="color: #5E5E5E;"># 1-paragraph chunks</span></span>
<span id="cb91-12"></span>
<span id="cb91-13"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb91-14">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> combine_chunks(chunks, num_p<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb91-15"></span>
<span id="cb91-16">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb91-17"></span>
<span id="cb91-18"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb91-19">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb91-20"></span>
<span id="cb91-21"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">713</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="9f240ac1-b0ec-49c2-a440-fd29ac67be70" data-execution_count="138">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1">chunks[<span class="dv" style="color: #AD0000;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n&lt;img src="images/chapter9_conv_basic.png" id="basic_conv" caption="Applying a kernel to one location" alt="Applying a kernel to one location" width="700"&gt;'</code></pre>
</div>
</div>
<div class="cell" data-outputid="20111447-31ee-48b8-9d01-a40bdd0c12d6" data-execution_count="139">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="kw" style="color: #003B4F;">def</span> clean_html(text):</span>
<span id="cb94-2">    <span class="co" style="color: #5E5E5E;"># Step 1: Temporarily replace double-bracketed content with a placeholder</span></span>
<span id="cb94-3">    <span class="im" style="color: #00769E;">import</span> uuid</span>
<span id="cb94-4">    placeholder <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"PLACEHOLDER_</span><span class="sc" style="color: #5E5E5E;">{</span>uuid<span class="sc" style="color: #5E5E5E;">.</span>uuid4()<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span>
<span id="cb94-5">    double_bracketed <span class="op" style="color: #5E5E5E;">=</span> re.findall(<span class="vs" style="color: #20794D;">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, text)</span>
<span id="cb94-6">    step1 <span class="op" style="color: #5E5E5E;">=</span> re.sub(<span class="vs" style="color: #20794D;">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, placeholder, text)</span>
<span id="cb94-7"></span>
<span id="cb94-8">    <span class="co" style="color: #5E5E5E;"># Step 2: Remove HTML tags</span></span>
<span id="cb94-9">    step2 <span class="op" style="color: #5E5E5E;">=</span> re.sub(<span class="vs" style="color: #20794D;">r'&lt;[/]?[a-zA-Z][^&gt;]*&gt;'</span>, <span class="st" style="color: #20794D;">''</span>, step1)</span>
<span id="cb94-10"></span>
<span id="cb94-11">    <span class="co" style="color: #5E5E5E;"># Step 3: Restore double-bracketed content</span></span>
<span id="cb94-12">    <span class="cf" style="color: #003B4F;">if</span> double_bracketed:</span>
<span id="cb94-13">        step3 <span class="op" style="color: #5E5E5E;">=</span> step2.replace(placeholder, double_bracketed[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb94-14">        <span class="cf" style="color: #003B4F;">return</span> step3</span>
<span id="cb94-15">    <span class="cf" style="color: #003B4F;">return</span> step2</span>
<span id="cb94-16"></span>
<span id="cb94-17">clean_html(<span class="st" style="color: #20794D;">'The &lt;a href="#"&gt;text&lt;/a&gt; is &lt;&lt;untouched&gt;&gt;.'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>'The text is &lt;&lt;untouched&gt;&gt;.'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb96-2">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> [clean_html(chunk) <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks]</span>
<span id="cb96-3"></span>
<span id="cb96-4">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb96-5"></span>
<span id="cb96-6"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb96-7">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb96-8"></span>
<span id="cb96-9"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">713</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="f0271933-ae7b-482e-cca5-32542a8e5130" data-execution_count="141">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1">chunks[<span class="dv" style="color: #AD0000;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n'</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-4">Retrieval Method: Full Text Search</h3>
<div class="cell" data-outputid="af2da950-e989-4a3a-f7aa-2036de7e493b" data-execution_count="113">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb99-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb99-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"E"</span>,</span>
<span id="cb99-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb99-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb99-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results,</span>
<span id="cb99-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="83446096-6429-453b-a860-31a9cdcdfa82" data-execution_count="114">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_E_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_E_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-4">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-outputid="831fe930-bc8a-4e64-9f5e-b709703860ba" data-execution_count="115">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb103-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb103-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"E"</span>,</span>
<span id="cb103-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb103-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb103-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="abadbb46-d641-4003-a353-5da32f447cbb" data-execution_count="116">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_E_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_E_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>(0.5, 0.87)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-4">Retrieval Method: ColBERTv2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb107-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb107-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"E"</span>,</span>
<span id="cb107-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb107-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb107-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-outputid="4108adcd-495a-4c42-c56b-5e5dc685cef5" data-execution_count="118">
<div class="sourceCode cell-code" id="cb108" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_E_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_E_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>(0.49, 0.81)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-4">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb110" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb110-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb110-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"E"</span>,</span>
<span id="cb110-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb110-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>benchmark,</span>
<span id="cb110-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-outputid="e723ecd0-7550-488b-a202-2b20b378a599" data-execution_count="120">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_E_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_E_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>(0.52, 0.84)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation">Chunking Strategy F: (w/headers, w/o HTML tags, w/o punctuation)</h2>
<p>Finally, I’ll keep headers, remove HTML tags and remove all punctuation.</p>
<div class="cell" data-outputid="ce7661e8-c5ee-44f5-950e-d01dd944b7f1" data-execution_count="142">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1">chunks[<span class="dv" style="color: #AD0000;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n'</code></pre>
</div>
</div>
<div class="cell" data-outputid="cf3eb589-4d15-4760-82ab-c02317c613a2" data-execution_count="145">
<div class="sourceCode cell-code" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><span class="kw" style="color: #003B4F;">def</span> remove_punctuation(text):</span>
<span id="cb115-2">  <span class="im" style="color: #00769E;">import</span> string</span>
<span id="cb115-3">  <span class="cf" style="color: #003B4F;">return</span> <span class="st" style="color: #20794D;">''</span>.join(char <span class="cf" style="color: #003B4F;">if</span> char.isalnum() <span class="kw" style="color: #003B4F;">or</span> char <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'#'</span> <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">' '</span> <span class="cf" style="color: #003B4F;">if</span> char <span class="kw" style="color: #003B4F;">in</span> string.punctuation <span class="cf" style="color: #003B4F;">else</span> char <span class="cf" style="color: #003B4F;">for</span> char <span class="kw" style="color: #003B4F;">in</span> text)</span>
<span id="cb115-4"></span>
<span id="cb115-5">remove_punctuation(chunks[<span class="dv" style="color: #AD0000;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision  and is surprisingly straightforward  To do it  we use something called a  convolution   A convolution requires nothing more than multiplication  and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book \n\nA convolution applies a  kernel  across an image  A kernel is a little matrix  such as the 3×3 matrix in the top right of   basic conv   \n\n'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb117-2">  data[chapter] <span class="op" style="color: #5E5E5E;">=</span> [remove_punctuation(chunk) <span class="cf" style="color: #003B4F;">for</span> chunk <span class="kw" style="color: #003B4F;">in</span> chunks]</span>
<span id="cb117-3"></span>
<span id="cb117-4">total_chunks <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb117-5"></span>
<span id="cb117-6"><span class="cf" style="color: #003B4F;">for</span> chapter, chunks <span class="kw" style="color: #003B4F;">in</span> data.items():</span>
<span id="cb117-7">  total_chunks <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">len</span>(chunks)</span>
<span id="cb117-8"></span>
<span id="cb117-9"><span class="cf" style="color: #003B4F;">assert</span> total_chunks <span class="op" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">713</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="421a9221-8070-419a-e330-f5382c9dee54" data-execution_count="147">
<div class="sourceCode cell-code" id="cb118" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1">chunks[<span class="dv" style="color: #AD0000;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision  and is surprisingly straightforward  To do it  we use something called a  convolution   A convolution requires nothing more than multiplication  and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book \n\nA convolution applies a  kernel  across an image  A kernel is a little matrix  such as the 3×3 matrix in the top right of   basic conv   \n\n'</code></pre>
</div>
</div>
<p>Since I’m removing punctuation from the contexts, I need to do the same for the benchmark dataset. I think a better solution would be to modify the scoring functions by removing the punctuation there, but I’m saving some time and space by just copying the benchmark dataset and removing punctuation from each context string in it:</p>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb120" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><span class="kw" style="color: #003B4F;">def</span> process_contexts(data):</span>
<span id="cb120-2">    <span class="co" style="color: #5E5E5E;"># Process questions</span></span>
<span id="cb120-3">    <span class="cf" style="color: #003B4F;">for</span> question <span class="kw" style="color: #003B4F;">in</span> data[<span class="st" style="color: #20794D;">'questions'</span>]:</span>
<span id="cb120-4">        <span class="co" style="color: #5E5E5E;"># Process only answer_context</span></span>
<span id="cb120-5">        <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'answer_context'</span> <span class="kw" style="color: #003B4F;">in</span> question:</span>
<span id="cb120-6">            <span class="cf" style="color: #003B4F;">for</span> context_item <span class="kw" style="color: #003B4F;">in</span> question[<span class="st" style="color: #20794D;">'answer_context'</span>]:</span>
<span id="cb120-7">                <span class="cf" style="color: #003B4F;">if</span> <span class="st" style="color: #20794D;">'context'</span> <span class="kw" style="color: #003B4F;">in</span> context_item:</span>
<span id="cb120-8">                    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">isinstance</span>(context_item[<span class="st" style="color: #20794D;">'context'</span>], <span class="bu" style="color: null;">list</span>):</span>
<span id="cb120-9">                        <span class="co" style="color: #5E5E5E;"># If context is a list, process each string in the list</span></span>
<span id="cb120-10">                        context_item[<span class="st" style="color: #20794D;">'context'</span>] <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb120-11">                            remove_punctuation(text) <span class="cf" style="color: #003B4F;">if</span> text <span class="cf" style="color: #003B4F;">else</span> text</span>
<span id="cb120-12">                            <span class="cf" style="color: #003B4F;">for</span> text <span class="kw" style="color: #003B4F;">in</span> context_item[<span class="st" style="color: #20794D;">'context'</span>]</span>
<span id="cb120-13">                        ]</span>
<span id="cb120-14">                    <span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(context_item[<span class="st" style="color: #20794D;">'context'</span>], <span class="bu" style="color: null;">str</span>):</span>
<span id="cb120-15">                        <span class="co" style="color: #5E5E5E;"># If context is a single string, process it directly</span></span>
<span id="cb120-16">                        context_item[<span class="st" style="color: #20794D;">'context'</span>] <span class="op" style="color: #5E5E5E;">=</span> remove_punctuation(context_item[<span class="st" style="color: #20794D;">'context'</span>])</span>
<span id="cb120-17"></span>
<span id="cb120-18">    <span class="cf" style="color: #003B4F;">return</span> data</span>
<span id="cb120-19"></span>
<span id="cb120-20">modified_benchmark <span class="op" style="color: #5E5E5E;">=</span> process_contexts(benchmark)</span></code></pre></div>
</div>
<div class="cell" data-outputid="7d2c1a5b-5162-481f-eb62-b5a1789e29f5" data-execution_count="165">
<div class="sourceCode cell-code" id="cb121" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1">modified_benchmark[<span class="st" style="color: #20794D;">'questions'</span>][<span class="dv" style="color: #AD0000;">4</span>][<span class="st" style="color: #20794D;">'answer_context'</span>][<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'context'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre><code>['An MIT professor named Marvin Minsky  who was a grade behind Rosenblatt at the same high school    along with Seymour Papert  wrote a book called  Perceptrons   MIT Press   about Rosenblatt s invention  They showed that a single layer of these devices was unable to learn some simple but critical mathematical functions  such as XOR   In the same book  they also showed that using multiple layers of the devices would allow these limitations to be addressed  Unfortunately  only the first of these insights was widely recognized  As a result  the global academic community nearly entirely gave up on neural networks for the next two decades ']</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-5">Retrieval Method: Full Text Search</h3>
<div class="cell" data-outputid="13b24ca1-582e-416d-bbbf-eafaf4e4732f" data-execution_count="166">
<div class="sourceCode cell-code" id="cb123" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb123-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"bm25"</span>,</span>
<span id="cb123-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"F"</span>,</span>
<span id="cb123-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb123-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>modified_benchmark,</span>
<span id="cb123-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results,</span>
<span id="cb123-7">    questions<span class="op" style="color: #5E5E5E;">=</span>questions)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="4f94af84-57fa-4326-ddf9-c65f4c6d1251" data-execution_count="167">
<div class="sourceCode cell-code" id="cb125" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_F_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'bm25_F_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="167">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-5">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-outputid="ec40a8af-9cc9-4051-c89c-760d8e374fff" data-execution_count="168">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb127-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"single_vector"</span>,</span>
<span id="cb127-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"F"</span>,</span>
<span id="cb127-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb127-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>modified_benchmark,</span>
<span id="cb127-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="15ad5b99-d7b2-4560-b4ae-2be1280375a0" data-execution_count="169">
<div class="sourceCode cell-code" id="cb129" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_F_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'single_vector_F_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="169">
<pre><code>(0.49, 0.86)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-5">Retrieval Method: ColBERTv2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb131" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb131-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"colbertv2"</span>,</span>
<span id="cb131-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"F"</span>,</span>
<span id="cb131-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb131-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>modified_benchmark,</span>
<span id="cb131-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-outputid="2a96fd76-8b57-486d-947b-e049cb8be797" data-execution_count="171">
<div class="sourceCode cell-code" id="cb132" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_F_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'colbertv2_F_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="171">
<pre><code>(0.44, 0.71)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-5">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb134" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1">benchmark_results <span class="op" style="color: #5E5E5E;">=</span> do_retrieval(</span>
<span id="cb134-2">    method<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"answerai_colbert"</span>,</span>
<span id="cb134-3">    chunking_strategy<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"F"</span>,</span>
<span id="cb134-4">    data<span class="op" style="color: #5E5E5E;">=</span>data,</span>
<span id="cb134-5">    benchmark<span class="op" style="color: #5E5E5E;">=</span>modified_benchmark,</span>
<span id="cb134-6">    benchmark_results<span class="op" style="color: #5E5E5E;">=</span>benchmark_results)</span></code></pre></div>
</div>
<div class="cell" data-outputid="f72ca3d9-cfda-43ec-8548-14c4d124db5a" data-execution_count="173">
<div class="sourceCode cell-code" id="cb135" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_F_mrr10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>), <span class="bu" style="color: null;">round</span>(benchmark_results[<span class="st" style="color: #20794D;">'answerai_colbert_F_recall10'</span>].mean(),<span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="173">
<pre><code>(0.45, 0.73)</code></pre>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Here are the definitions of the metrics, retrieval methods and chunking strategies that I am using in this benchmark evaluation:</p>
<p><strong>Metrics</strong></p>
<ul>
<li><p>Answer Component MRR@10: Returns the rank of the n-th passage needed to satisfy all <code>answer_component</code>s for the question. So, if a question has 4 <code>answer_component</code>s and their relevant contexts were contained across the first 5 retrieved passages, MRR would be 1/5 = 0.2.</p></li>
<li><p>Answer Component Recall@10: Measures the proportion of answer components for which at least one supporting context was retrieved. Using the same example, if the top-10 passages only contain contexts relevant to 2 <code>answer_component</code>s, Recall would be 2/4 = 0.5</p></li>
</ul>
<p><strong>Retrieval Methods</strong></p>
<ul>
<li>Full text search (using sqlite and Claude-generated keywords)</li>
<li>Single-vector cosine similarity (using BAAI/bge-small-en-v1.5)</li>
<li>ColBERTv2</li>
<li>answerai-colbert-small-v1</li>
</ul>
<p><strong>Chunking Strategies</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chunking Strategy Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1-paragraph (w/headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">3-paragraph (w/headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1-paragraph (w/o headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">3-paragraph (w/o headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">E</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags)</td>
</tr>
<tr class="even">
<td style="text-align: center;">F</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags, w/o punctuation)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<p><strong>Answer Component MRR@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.44</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.46</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.35</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.41</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">0.48</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
</tr>
</tbody>
</table>
<p><strong>Answer Component Recall@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">83%</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">71%</td>
<td style="text-align: center;">85%</td>
<td style="text-align: center;">72%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">87%</td>
<td style="text-align: center;">86%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">74%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">81%</td>
<td style="text-align: center;">71%</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">77%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">73%</td>
</tr>
</tbody>
</table>
<p>The best-performing retrieval method and chunking strategies:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Metric Name</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">Chunking Strategies</th>
<th style="text-align: center;">Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Answer Component MRR@10</td>
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">B, D, E</td>
<td style="text-align: center;">0.52</td>
</tr>
<tr class="even">
<td style="text-align: center;">Answer Component Recall@10</td>
<td style="text-align: center;">Single-vector cosine similiarty</td>
<td style="text-align: center;">E</td>
<td style="text-align: center;">87%</td>
</tr>
</tbody>
</table>
<p>I was quite surprised that single-vector cosine similarity yielded the best Recall. I was less surprised that answerai-colbert-small-v1 had the best MRR@10 since it was better than the other retrieval methods for 5 out of 6 chunking strategies. Other noteworthy observations:</p>
<ul>
<li>ColBERTv2 and answerai-colbert-small-v1 both experienced a considerable performance drop when punctuation was removed from the documents.</li>
<li>Full text search was very competitive after the chunk size was increased to 3-paragraphs (B, D, E, F). It yielded the second-highest MRR@10 for Chunking Strategy F (3-paragraph, w/headers, w/o HTMl tags, w/o punctuation).</li>
<li>Removing HTML tags (Chunking Strategy E) improved the performance of all four retrieval methods than when they were included (Chunking Strategy D). The biggest beneficiary of removing them was single-vector cosine similarity (82% –&gt; 87%).</li>
</ul>
<p>A couple of notes about my process:</p>
<ul>
<li>Having a benchmark dataset saved me about 15-20 hours of manual evaluation.</li>
<li>Refactoring the code (into a <code>do_retrieval</code> function) made it easier for me to iterate quickly different chunking strategies.</li>
</ul>
<p>Before I move on to experimenting with hybrid approaches (full text search + semantic search) I want to research and apply chunking strategies that are particularly suited to ColBERTv2 and answerai-colbert-small-v1 to see if I can improve on the overall-best Recall@10 of 87% and MRR@10 of 0.52.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>fastbookRAG</category>
  <category>information retrieval</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-26-fastbook-benchmark-results/index.html</guid>
  <pubDate>Tue, 26 Nov 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>Implementing Negative Prompting for Stable Diffusion</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index.html</link>
  <description><![CDATA[ 



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In Lesson 10 of the fastai course (Part 2) Jeremy assigns us the following homework assignment:</p>
<blockquote class="blockquote">
<p>try picking one of the extra tricks we learned about like image-to-image, or negative prompts; see if you can implement negative prompt in your version of this; or try doing image-to-image; try adding callbacks</p>
</blockquote>
<p>In this blog post I’ll implement negative prompting using the diffusion loop code provided in the course’s <a href="https://github.com/fastai/diffusion-nbs/blob/master/stable_diffusion.ipynb">Stable Diffusion with Diffusers</a> notebook.</p>
<p>I’ll start by copy/pasting all of the boilerplate code provided in that notebook, and running it to make sure we get the desired images.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:14:20.374652Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:14:20.373985Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:14:36.112519Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:14:36.111792Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:14:20.374573Z&quot;}" data-execution_count="1">
<details>
<summary>Show setup</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq diffusers transformers<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">4.46.2</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq pillow<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">11.0.0</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> diffusers <span class="im" style="color: #00769E;">import</span> LMSDiscreteScheduler, AutoencoderKL, UNet2DConditionModel, StableDiffusionPipeline</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> CLIPTextModel, CLIPTokenizer</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> PIL <span class="im" style="color: #00769E;">import</span> Image</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> tqdm.auto <span class="im" style="color: #00769E;">import</span> tqdm</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> IPython.display <span class="im" style="color: #00769E;">import</span> display</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> torch, math</span>
<span id="cb1-10"></span>
<span id="cb1-11">tokenizer <span class="op" style="color: #5E5E5E;">=</span> CLIPTokenizer.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16)</span>
<span id="cb1-12">text_encoder <span class="op" style="color: #5E5E5E;">=</span> CLIPTextModel.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-13">vae <span class="op" style="color: #5E5E5E;">=</span> AutoencoderKL.from_pretrained(<span class="st" style="color: #20794D;">"stabilityai/sd-vae-ft-ema"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-14">unet <span class="op" style="color: #5E5E5E;">=</span> UNet2DConditionModel.from_pretrained(<span class="st" style="color: #20794D;">"CompVis/stable-diffusion-v1-4"</span>, subfolder<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"unet"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-15"></span>
<span id="cb1-16">beta_start,beta_end <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.00085</span>,<span class="fl" style="color: #AD0000;">0.012</span></span>
<span id="cb1-17">scheduler <span class="op" style="color: #5E5E5E;">=</span> LMSDiscreteScheduler(beta_start<span class="op" style="color: #5E5E5E;">=</span>beta_start, beta_end<span class="op" style="color: #5E5E5E;">=</span>beta_end, beta_schedule<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"scaled_linear"</span>, num_train_timesteps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb1-18"></span>
<span id="cb1-19">height <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-20">width <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-21">num_inference_steps <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">70</span></span>
<span id="cb1-22">guidance_scale <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7.5</span></span>
<span id="cb1-23">batch_size <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span></span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:15:35.161888Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:15:35.161676Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:15:35.166774Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:15:35.166240Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:15:35.161868Z&quot;}" data-execution_count="6">
<details>
<summary>Show stable diffusion implementation functions</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;">def</span> text_enc(prompts, maxlen<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;">if</span> maxlen <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>: maxlen <span class="op" style="color: #5E5E5E;">=</span> tokenizer.model_max_length</span>
<span id="cb2-3">    inp <span class="op" style="color: #5E5E5E;">=</span> tokenizer(prompts, padding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"max_length"</span>, max_length<span class="op" style="color: #5E5E5E;">=</span>maxlen, truncation<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>)</span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;">return</span> text_encoder(inp.input_ids.to(<span class="st" style="color: #20794D;">"cuda"</span>))[<span class="dv" style="color: #AD0000;">0</span>].half()</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;">def</span> mk_img(t):</span>
<span id="cb2-7">    image <span class="op" style="color: #5E5E5E;">=</span> (t<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">+</span><span class="fl" style="color: #AD0000;">0.5</span>).clamp(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>).detach().cpu().permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>).numpy()</span>
<span id="cb2-8">    <span class="cf" style="color: #003B4F;">return</span> Image.fromarray((image<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">255</span>).<span class="bu" style="color: null;">round</span>().astype(<span class="st" style="color: #20794D;">"uint8"</span>))</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb2-11">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb2-12">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb2-13">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb2-14">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb2-15">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb2-16"></span>
<span id="cb2-17">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb2-18">    scheduler.set_timesteps(steps)</span>
<span id="cb2-19">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb2-20"></span>
<span id="cb2-21">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb2-22">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb2-23">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb2-24">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb2-25">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb2-26"></span>
<span id="cb2-27">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:15:35.284336Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:15:35.283889Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:15:35.286531Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:15:35.286084Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:15:35.284317Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb3-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span>,</span>
<span id="cb3-3">    <span class="st" style="color: #20794D;">'an oil painting of an astronaut riding a horse in the style of grant wood'</span></span>
<span id="cb3-4">]</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-19T12:34:39.165916Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-19T12:34:39.165708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-19T12:34:39.658773Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-19T12:34:39.657968Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-19T12:34:39.165900Z&quot;}" data-outputid="860be359-1360-4bd1-d749-eb0c7e2d560e" data-execution_count="11">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb4-2"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looks good! These are the same two images generated in the course notebook.</p>
</section>
<section id="negative-prompting" class="level2">
<h2 class="anchored" data-anchor-id="negative-prompting">Negative Prompting</h2>
<p>What is negative prompting? I’ll illustrate an example using a stable diffusion pipeline:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:18:38.116844Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:18:38.116258Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:18:54.478222Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:18:54.477498Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:18:38.116822Z&quot;}" data-outputid="aa3bdd84-0d51-4564-e822-b8773ea00a8c">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">pipe <span class="op" style="color: #5E5E5E;">=</span> StableDiffusionPipeline.from_pretrained(<span class="st" style="color: #20794D;">"CompVis/stable-diffusion-v1-4"</span>, variant<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"fp16"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span></code></pre></div>
</div>
<p>Here is the generated image for the prompt “Labrador in the style of Vermeer”.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:19:15.442983Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:19:15.442422Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:19:24.962680Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:19:24.961826Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:19:15.442962Z&quot;}" data-outputid="938c2d81-ecf7-4107-f608-05c88a2bacc5" data-execution_count="14">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">torch.manual_seed(<span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb6-2">prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span></span>
<span id="cb6-3">pipe(prompt).images[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7089c967c16241ecab32c9bfdcdffa4e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-7-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>And here’s the result after passing a negative prompt: “blue”</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-19T17:03:58.822479Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-19T17:03:58.822214Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-19T17:04:03.745114Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-19T17:04:03.744354Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-19T17:03:58.822462Z&quot;}" data-outputid="c8b56e58-436f-4284-b79f-bba36d2dcc93" data-execution_count="247">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">torch.manual_seed(<span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb7-2">pipe(prompt, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>).images[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"040efa5a85944f77b5b56cd8c9f0217c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="247">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-8-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looking at these images side-by-side, without the negative prompt (left) and with the negative prompt (right) we see that with negative prompting, the blue hat and scarf are replaced with black ones. Additionally, the labrador’s eyes, snout, nose, ears and other features have also slightly changed.</p>
<p>It’s important to note that not all seeds return such desired results. For example, here is another lab in the style of Vermeer, notice the blue head scarf.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:19:30.585836Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:19:30.585153Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:19:35.465990Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:19:35.465321Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:19:30.585812Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">torch.manual_seed(<span class="dv" style="color: #AD0000;">100</span>)</span>
<span id="cb8-2">pipe(prompt).images[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"64b2bb959946478a8d3edc51ab2884d8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-9-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The negative prompt result does remove the blue from the image, but it also considerably changes other features of the image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:21:03.285468Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:21:03.284801Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:21:08.145216Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:21:08.144417Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:21:03.285444Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">torch.manual_seed(<span class="dv" style="color: #AD0000;">100</span>)</span>
<span id="cb9-2">pipe(prompt, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>).images[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b959add04fd2484284ae01b7de41ea43","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-10-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<section id="original-image" class="level3">
<h3 class="anchored" data-anchor-id="original-image">Original Image</h3>
<p>I’ll choose the following generated image as the baseline image, using the same prompt and number of steps as the stable diffusion <code>pipe</code> generation, but now using the code from Lesson 10:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-19T12:35:44.474000Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-19T12:35:44.473813Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-19T12:35:51.093056Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-19T12:35:51.092293Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-19T12:35:44.473985Z&quot;}" data-outputid="5e0e1e59-e350-41b5-aeeb-761f7123d87d" data-execution_count="15">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb10-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb10-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_75/2343166050.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"410eca32d3a24bd8b803bb0b0b08d99d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-11-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-11-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="working-implementation-replace-u-with-n" class="level2">
<h2 class="anchored" data-anchor-id="working-implementation-replace-u-with-n">Working Implementation: Replace <code>u</code> with <code>n</code></h2>
<p>I tried out four different implementations of negative prompting. Three of them did not succeed but I did learn a lot from implementing them. I’ll go into detail into those approaches later on in this post. The working solution I came up with was relatively simpler than the first two implementations I attempted.</p>
<p>In the diffusion loop, the following line of code is key:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span></code></pre></div>
<p><code>u</code> is the “starting point” or “reference point” for our predicted noise. It represents some general noisy-image features. <code>t</code> is our desired direction, and <code>g</code> is the <em>guidance scale</em>, amplifying the difference between <code>t</code> and <code>u</code>. Overall, we are moving <em>away</em> from <code>u</code> and <em>towards</em> <code>t</code>.</p>
<p>In this case, <code>u</code> is the UNet noise prediction given the unconditioned (empty string) prompt, and <code>t</code> is the UNet noise prediction given the desired prompt. Moving away from one prompt and moving towards another prompt sounded to me exactly like the goal of negative prompting. We want to move away from our negative prompt and towards our desired prompt. To implement this, I simply added a <code>negative_prompt</code> that defaults to an empty string (our unconditioned prompt scenario), passed this string to <code>text_enc</code> in the following line:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span></code></pre></div>
<p>And otherwise kept the <code>mk_samples</code> code unchanged.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:42:35.080250Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:42:35.079703Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:42:35.085893Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:42:35.085160Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:42:35.080226Z&quot;}" data-execution_count="17">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb14-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb14-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb14-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb14-5">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb14-6">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb14-7"></span>
<span id="cb14-8">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb14-9">    scheduler.set_timesteps(steps)</span>
<span id="cb14-10">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb14-11"></span>
<span id="cb14-12">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb14-13">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb14-14">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb14-15">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb14-16">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb14-17"></span>
<span id="cb14-18">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<p>Here is the output of <code>mk_samples</code> with no <code>negative_prompt</code> specific, this is essentially our normal classifier-free guidance implementation:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:43:15.206765Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:43:15.205853Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:43:21.724905Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:43:21.724396Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:43:15.206740Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb15-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3351458932.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"990740786383407cb2ab19c9a2788214","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>And here is the output with a <code>negative_prompt</code> provided:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:43:56.250945Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:43:56.250058Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:44:02.787863Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:44:02.787057Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:43:56.250913Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb17-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb17-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3351458932.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ce08e817060046e2b88e3964f1f71f73","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-14-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>This results in a (somewhat) desired image: ✅ the blue clothing has been removed (and changed to black) but ❌ the image structure and composition has <em>considerably</em> changed.</p>
<p>I found a seed (<code>20</code>) which performs better. Here is the original unconditioned prompt result:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:48:00.375698Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:48:00.375138Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:48:06.924758Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:48:06.924141Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:48:00.375676Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb19-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb19-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3351458932.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5a8d452064ff456fafbb283f050f10af","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-15-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-15-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>And here is the result after replacing the unconditioned prompt with the negative prompt <code>"blue"</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T13:48:23.732941Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T13:48:23.732206Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T13:48:30.352189Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T13:48:30.350608Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T13:48:23.732910Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb21-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb21-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3351458932.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"133d776d198f424cb8a2b93a73128c89","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-16-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>That’s much better! The dog does have a different pose (though a similar perspective), but the blue has been removed from the image.</p>
<p>As a sanity check, I wanted to see how Huggingface implements negative prompting in the <code>diffusers</code> library. I was thrilled (and relieved) to see that they implement it similarly! In the <a href="https://github.com/huggingface/diffusers/blob/89e4d6219805975bd7d253a267e1951badc9f1c0/src/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py#L454"><code>StableDiffusionPipeline.encode_prompt</code> method</a> they simply assign the negative prompt tokens to the <code>uncond_tokens</code> variable:</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="cf" style="color: #003B4F;">elif</span> <span class="bu" style="color: null;">isinstance</span>(negative_prompt, <span class="bu" style="color: null;">str</span>):</span>
<span id="cb23-2">                uncond_tokens <span class="op" style="color: #5E5E5E;">=</span> [negative_prompt]</span></code></pre></div>
<p>then they embed these tokens:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"></span>
<span id="cb24-2">negative_prompt_embeds <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.text_encoder(</span>
<span id="cb24-3">                uncond_input.input_ids.to(device),</span>
<span id="cb24-4">                attention_mask<span class="op" style="color: #5E5E5E;">=</span>attention_mask,</span>
<span id="cb24-5">            )</span></code></pre></div>
<p>And return them along with the desired prompt embeddings:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="cf" style="color: #003B4F;">return</span> prompt_embeds, negative_prompt_embeds</span></code></pre></div>
<p>They then concatenate the desired and negative prompt embeddings:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">prompt_embeds <span class="op" style="color: #5E5E5E;">=</span> torch.cat([negative_prompt_embeds, prompt_embeds])</span></code></pre></div>
<p>And in the diffusion loop they get the UNet predictions:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">noise_pred <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">self</span>.unet(</span>
<span id="cb27-2">    latent_model_input,</span>
<span id="cb27-3">    t,</span>
<span id="cb27-4">    encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>prompt_embeds,</span>
<span id="cb27-5">    timestep_cond<span class="op" style="color: #5E5E5E;">=</span>timestep_cond,</span>
<span id="cb27-6">    cross_attention_kwargs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">self</span>.cross_attention_kwargs,</span>
<span id="cb27-7">    added_cond_kwargs<span class="op" style="color: #5E5E5E;">=</span>added_cond_kwargs,</span>
<span id="cb27-8">    return_dict<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb27-9">)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<p>and perform classifier-free guidance (where <code>noise_pred_uncond</code> are the UNet predictions for the negative prompt):</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="cf" style="color: #003B4F;">if</span> <span class="va" style="color: #111111;">self</span>.do_classifier_free_guidance:</span>
<span id="cb28-2">    noise_pred_uncond, noise_pred_text <span class="op" style="color: #5E5E5E;">=</span> noise_pred.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb28-3">    noise_pred <span class="op" style="color: #5E5E5E;">=</span> noise_pred_uncond <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">self</span>.guidance_scale <span class="op" style="color: #5E5E5E;">*</span> (noise_pred_text <span class="op" style="color: #5E5E5E;">-</span> noise_pred_uncond)</span></code></pre></div>
</section>
<section id="implementation-1-pred-u-gt-u-n" class="level2">
<h2 class="anchored" data-anchor-id="implementation-1-pred-u-gt-u-n">Implementation 1: <code>pred = u + g*(t-u-n)</code></h2>
<p>The first approach I tried was to modify the classifier-free guidance code from this:</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span></code></pre></div>
<p>to this:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u<span class="op" style="color: #5E5E5E;">-</span>n)</span></code></pre></div>
<p>My motivation for this was that this subtraction was analogous to “moving away from <code>n</code>”. In hindsight, this was a good first attempt and eventually led to (somewhat accidentally) implementing the correct solution as I was throwing things at the wall to see if they stuck.</p>
<p>I modified <code>mk_samples</code> with the following changes:</p>
<ul>
<li>Create a separate text embeddings (<code>n_embs</code>) for the negative prompt.</li>
<li>Concatenate <code>n_embs</code> to <code>uncond</code> and <code>text</code>.</li>
<li>Multiply <code>[latents]</code> by <code>3</code> when passing it to the <code>scheduler</code> as we now have three embeddings.</li>
<li><code>chunk</code> the UNet predictions into <code>3</code> instead of <code>2</code>.</li>
<li>Replace <code>pred = u + g*(t-u-n)</code> with <code>pred = u + g*(t-u-n)</code>.</li>
</ul>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:08:42.623455Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:08:42.623180Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:08:42.629180Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:08:42.628407Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:08:42.623435Z&quot;}" data-execution_count="23">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb31-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb31-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb31-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb31-5">    n_embs <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb31-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, n_embs])</span>
<span id="cb31-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb31-8"></span>
<span id="cb31-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb31-10">    scheduler.set_timesteps(steps)</span>
<span id="cb31-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb31-12"></span>
<span id="cb31-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb31-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb31-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,n <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb31-16">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u<span class="op" style="color: #5E5E5E;">-</span>n)</span>
<span id="cb31-17">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb31-18"></span>
<span id="cb31-19">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<p>Unfortunately, this resulted in garbled noise!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:09:00.507997Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:09:00.507348Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:09:09.754026Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:09:09.753560Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:09:00.507973Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb32-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb32-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3564900662.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0a4c68f366f54538ba2786ffccc57d61","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-18-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-18-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="implementation-2-pred-u-g2t-u-n" class="level2">
<h2 class="anchored" data-anchor-id="implementation-2-pred-u-g2t-u-n">Implementation 2: <code>pred = u + g*(2*t-u-n)</code></h2>
<p>As I was experimenting with the above <code>mk_samples</code> implementation, I found some success multiplying <code>t</code> by a scalar factor.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T15:26:17.491283Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T15:26:17.490462Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T15:26:17.499121Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T15:26:17.498409Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T15:26:17.491246Z&quot;}" data-execution_count="72">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb34-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb34-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb34-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb34-5">    n_embs <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb34-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, n_embs])</span>
<span id="cb34-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb34-8"></span>
<span id="cb34-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb34-10">    scheduler.set_timesteps(steps)</span>
<span id="cb34-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb34-12"></span>
<span id="cb34-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb34-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb34-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,n <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb34-16">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(<span class="dv" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">*</span>t<span class="op" style="color: #5E5E5E;">-</span>u<span class="op" style="color: #5E5E5E;">-</span>n)</span>
<span id="cb34-17">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb34-18"></span>
<span id="cb34-19">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<p>The resulting image, for both seeds <code>20</code> and <code>18</code>, are not bad! For <code>seed=20</code> the generated image looks coherent and similar to the structure and composition of the original image though the background still contains blue-ish tones,</p>
<p>The result for <code>seed=18</code> in my opinion is actually better than the <code>pred = n + g*(t-n)</code> implementation! Although the dog’s pose has changed, the dog is no longer wearing a blue sweater (instead it’s black) and more importantly, this approach has not generated a woman standing next to him.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:12:14.040162Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:12:14.039683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:12:23.273373Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:12:23.272871Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:12:14.040142Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb35-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb35-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/4112522131.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dbb973e3579a4e2bb828cc786c3685e1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-20-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:13:55.203241Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:13:55.202416Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:14:04.419841Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:14:04.419357Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:13:55.203217Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb37-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb37-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/4112522131.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6db8899be6ae4b6e83ca269342c09207","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-21-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-21-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I don’t understand the intuition behind why, but it seems like <code>2</code> is the magical factor for this implementation (in terms of generating somewhat stable images). Here’s a slightly different prompt:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T15:26:47.093243Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T15:26:47.092698Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T15:26:56.342350Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T15:26:56.341606Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T15:26:47.093222Z&quot;}" data-execution_count="74">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Cat in the style of Vermeer"</span>]</span>
<span id="cb39-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>)</span>
<span id="cb39-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/4112522131.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"62dfa61a9ebc4a8d810c38abb77c42e7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-22-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-22-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I was curious to see how the result changed given different values of the factor multiplying <code>t</code>. I tried 100 different factors, incrementing from <code>1</code> to <code>3</code>, for <code>seed=18</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:19:24.940422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:19:24.939716Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:19:24.945747Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:19:24.945123Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:19:24.940399Z&quot;}" data-execution_count="28">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>, t_factor<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>):</span>
<span id="cb41-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb41-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb41-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb41-5">    n_embs <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb41-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, n_embs])</span>
<span id="cb41-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb41-8"></span>
<span id="cb41-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb41-10">    scheduler.set_timesteps(steps)</span>
<span id="cb41-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb41-12"></span>
<span id="cb41-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb41-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb41-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,n <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb41-16">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t_factor<span class="op" style="color: #5E5E5E;">*</span>t<span class="op" style="color: #5E5E5E;">-</span>u<span class="op" style="color: #5E5E5E;">-</span>n)</span>
<span id="cb41-17">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb41-18"></span>
<span id="cb41-19">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:20:22.377413Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:20:22.376502Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:36:59.198215Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:36:59.197350Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:20:22.377387Z&quot;}">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">images <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb42-2">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb42-3"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">100</span>):</span>
<span id="cb42-4">  img <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, t_factor<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">+</span> (i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">50</span>)</span>
<span id="cb42-5">  images.append(img)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:40:58.390472Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:40:58.389392Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:40:58.490761Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:40:58.490012Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:40:58.390435Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="im" style="color: #00769E;">from</span> PIL <span class="im" style="color: #00769E;">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb43-2">imgs <span class="op" style="color: #5E5E5E;">=</span> [mk_img(im.squeeze()) <span class="cf" style="color: #003B4F;">for</span> im <span class="kw" style="color: #003B4F;">in</span> images]</span>
<span id="cb43-3"></span>
<span id="cb43-4"><span class="cf" style="color: #003B4F;">for</span> i, image <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(imgs):</span>
<span id="cb43-5">  font <span class="op" style="color: #5E5E5E;">=</span> ImageFont.load_default().font_variant(size<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">24</span>)</span>
<span id="cb43-6">  draw <span class="op" style="color: #5E5E5E;">=</span> ImageDraw.Draw(image)</span>
<span id="cb43-7">  text <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f"t_factor = </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">round</span>(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">+</span> (i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">50</span>, <span class="dv" style="color: #AD0000;">2</span>)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span></span>
<span id="cb43-8">  bbox <span class="op" style="color: #5E5E5E;">=</span> draw.textbbox((<span class="dv" style="color: #AD0000;">10</span>, <span class="dv" style="color: #AD0000;">10</span>), text, font<span class="op" style="color: #5E5E5E;">=</span>font)  <span class="co" style="color: #5E5E5E;"># Get text boundaries</span></span>
<span id="cb43-9">  draw.rectangle(bbox, fill<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'black'</span>)  <span class="co" style="color: #5E5E5E;"># Draw black background</span></span>
<span id="cb43-10">  ImageDraw.Draw(image).text((<span class="dv" style="color: #AD0000;">10</span>, <span class="dv" style="color: #AD0000;">10</span>), text, font<span class="op" style="color: #5E5E5E;">=</span>font, fill<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"white"</span>)</span>
<span id="cb43-11">    </span>
<span id="cb43-12">imgs[<span class="dv" style="color: #AD0000;">0</span>].save(<span class="ss" style="color: #20794D;">f't_factor_18.gif'</span>, save_all<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, append_images<span class="op" style="color: #5E5E5E;">=</span>imgs[<span class="dv" style="color: #AD0000;">1</span>:], duration<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, loop<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="t_factor_18.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-16" title="t_factor GIF"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/t_factor_18.gif" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">t_factor GIF</figcaption><p></p>
</figure>
</div>
<p>We can see that for a only a very small range of <code>t_factor</code> values (around 2.00) do we get a coherent image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:46:30.057115Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:46:30.056426Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:46:30.061561Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:46:30.060836Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:46:30.057084Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="kw" style="color: #003B4F;">def</span> image_grid(imgs, rows, cols):</span>
<span id="cb44-2">    w,h <span class="op" style="color: #5E5E5E;">=</span> imgs[<span class="dv" style="color: #AD0000;">0</span>].size</span>
<span id="cb44-3">    grid <span class="op" style="color: #5E5E5E;">=</span> Image.new(<span class="st" style="color: #20794D;">'RGB'</span>, size<span class="op" style="color: #5E5E5E;">=</span>(cols<span class="op" style="color: #5E5E5E;">*</span>w, rows<span class="op" style="color: #5E5E5E;">*</span>h))</span>
<span id="cb44-4">    <span class="cf" style="color: #003B4F;">for</span> i, img <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(imgs): grid.paste(img, box<span class="op" style="color: #5E5E5E;">=</span>(i<span class="op" style="color: #5E5E5E;">%</span>cols<span class="op" style="color: #5E5E5E;">*</span>w, i<span class="op" style="color: #5E5E5E;">//</span>cols<span class="op" style="color: #5E5E5E;">*</span>h))</span>
<span id="cb44-5">    <span class="cf" style="color: #003B4F;">return</span> grid</span></code></pre></div>
</div>
<p>In fact for only three <code>t_factor</code> values out 100 (2.00, 2.02, 2.04) does the diffusion loop generate coherent images, and only in one of those (2.00) does the composition and style match the desired prompt (“in the style of Vermeer”).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:47:56.006600Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:47:56.005699Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:47:56.209978Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:47:56.209084Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:47:56.006567Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">image_grid([imgs[i] <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> [<span class="dv" style="color: #AD0000;">48</span>, <span class="dv" style="color: #AD0000;">49</span>, <span class="dv" style="color: #AD0000;">50</span>, <span class="dv" style="color: #AD0000;">51</span>, <span class="dv" style="color: #AD0000;">52</span>, <span class="dv" style="color: #AD0000;">53</span>]], <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-27-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="implementation-2-pred-u-gt-u-n_factorn" class="level2">
<h2 class="anchored" data-anchor-id="implementation-2-pred-u-gt-u-n_factorn">Implementation 2: <code>pred = u + g*(t-u-n_factor*n)</code></h2>
<p>With some success achieved with that implementation, I decided to try a variant: scaling <code>n</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:52:10.435472Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:52:10.435105Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:52:10.442466Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:52:10.441411Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:52:10.435443Z&quot;}" data-execution_count="51">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>, n_factor<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.5</span>):</span>
<span id="cb46-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb46-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb46-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb46-5">    n_embs <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb46-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, n_embs])</span>
<span id="cb46-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb46-8"></span>
<span id="cb46-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb46-10">    scheduler.set_timesteps(steps)</span>
<span id="cb46-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb46-12"></span>
<span id="cb46-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb46-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb46-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,n <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb46-16">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u<span class="op" style="color: #5E5E5E;">-</span>n_factor<span class="op" style="color: #5E5E5E;">*</span>n)</span>
<span id="cb46-17">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb46-18"></span>
<span id="cb46-19">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<p>However, with this approach, I found that only negligible values of <code>n_factor</code> produced coherent images, and <code>n</code>’s impact was so small that it did not remove any “blue” elements from the image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:55:27.534266Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:55:27.534009Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:55:37.032108Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:55:37.031410Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:55:27.534248Z&quot;}" data-execution_count="60">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb47-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, n_factor<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.005</span>)</span>
<span id="cb47-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/989121822.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4c5965cfc7044202badac4525473aeb6","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-29-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-29-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T14:55:41.183193Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T14:55:41.182598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T14:55:50.782631Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T14:55:50.781841Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T14:55:41.183160Z&quot;}" data-execution_count="61">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb49-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, n_factor<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.05</span>)</span>
<span id="cb49-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/989121822.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"04664d9b0d4749f9b5f31a26d81f28ed","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-30-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-30-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="implementation-3-using-rejection-of-t-on-n" class="level2">
<h2 class="anchored" data-anchor-id="implementation-3-using-rejection-of-t-on-n">Implementation 3: Using Rejection of <code>t</code> on <code>n</code></h2>
<p>My final implementation was the result of a lengthy conversation with Claude where I explicitly asked it <em>not</em> to provide me with fully fleshed solutions to my prompts but to respond with probing questions based on first principles. This led me to a very engaging and interesting conversation where we explored and developed my intuition of vector geometry.</p>
<p>The implementation I came up with was based on the concept of <em>rejection</em>. In the image from Wikipedia below, <img src="https://latex.codecogs.com/png.latex?a_2"> is the rejection of <img src="https://latex.codecogs.com/png.latex?a"> onto <img src="https://latex.codecogs.com/png.latex?b">. In other words, it’s the component of vector <img src="https://latex.codecogs.com/png.latex?a"> that is perpendicular to vector <img src="https://latex.codecogs.com/png.latex?b">. We want to move our noise predictions away from <code>n</code>—adding the component of <code>t</code> that is perpendicular to <code>n</code> seemed an intuitive implementation.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="Vector rejection"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Vector rejection</figcaption><p></p>
</figure>
</div>
<p>In my sketch below, I visualize in a simplified 2-D space how adding to <code>t</code> a vector <code>p</code> perpendicular to <code>n</code> moves it away from it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21" title="Moving t away from n with p"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/2.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Moving <code>t</code> away from <code>n</code> with <code>p</code></figcaption><p></p>
</figure>
</div>
<p>The implementation of rejection between two vectors <code>t</code> and <code>n</code> (thanks Claude) is:</p>
<div class="sourceCode" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">p <span class="op" style="color: #5E5E5E;">=</span> t <span class="op" style="color: #5E5E5E;">-</span> (t <span class="op" style="color: #5E5E5E;">*</span> n).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="op" style="color: #5E5E5E;">*</span> n</span></code></pre></div>
<p>Here’s a trivial example showing that the full vector <code>a</code> is the perpendicular component to the orthogonal <code>b</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T15:15:00.669025Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T15:15:00.668760Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T15:15:00.676422Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T15:15:00.675610Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T15:15:00.669007Z&quot;}" data-execution_count="64">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">a <span class="op" style="color: #5E5E5E;">=</span> torch.tensor([[<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>]])</span>
<span id="cb52-2">b <span class="op" style="color: #5E5E5E;">=</span> torch.tensor([[<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>]])</span>
<span id="cb52-3">a <span class="op" style="color: #5E5E5E;">-</span> (a <span class="op" style="color: #5E5E5E;">*</span> b).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="op" style="color: #5E5E5E;">*</span> b</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>tensor([[0, 0, 0]])</code></pre>
</div>
</div>
<p>Here’s the modifications I made to <code>mk_samples</code>:</p>
<ul>
<li>Calculate the rejection of <code>t</code> onto <code>n</code>: <code>p = t - (t * n).sum(dim=1, keepdim=True) * n</code>.</li>
<li>Add this vector (scaled) to the noise prediction: <code>pred = u + g*(t-u) + g2*p</code>.</li>
</ul>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T15:18:26.908117Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T15:18:26.907527Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T15:18:26.914087Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T15:18:26.913402Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T15:18:26.908096Z&quot;}" data-execution_count="68">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, negative_prompt <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">""</span>, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>, g2<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb54-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb54-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb54-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb54-5">    n_embs <span class="op" style="color: #5E5E5E;">=</span> text_enc([negative_prompt] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb54-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, n_embs])</span>
<span id="cb54-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb54-8"></span>
<span id="cb54-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb54-10">    scheduler.set_timesteps(steps)</span>
<span id="cb54-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb54-12"></span>
<span id="cb54-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb54-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb54-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,n <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb54-16">        </span>
<span id="cb54-17">        p <span class="op" style="color: #5E5E5E;">=</span> t <span class="op" style="color: #5E5E5E;">-</span> (t <span class="op" style="color: #5E5E5E;">*</span> n).<span class="bu" style="color: null;">sum</span>(dim<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span>, keepdim<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="op" style="color: #5E5E5E;">*</span> n</span>
<span id="cb54-18">        </span>
<span id="cb54-19">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u) <span class="op" style="color: #5E5E5E;">+</span> g2<span class="op" style="color: #5E5E5E;">*</span>p</span>
<span id="cb54-20">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb54-21"></span>
<span id="cb54-22">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</details>
</div>
<p>On paper this seemed like an interesting approach but I found that only small values of <code>g2</code> allowed for coherent image generation, and even then, it did not remove any “blue” components.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T15:19:01.506812Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T15:19:01.506042Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T15:19:10.789727Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T15:19:10.789014Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T15:19:01.506787Z&quot;}" data-execution_count="71">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">"Labrador in the style of Vermeer"</span>]</span>
<span id="cb55-2">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts, negative_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"blue"</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">18</span>, g2<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.001</span>)</span>
<span id="cb55-3"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_52/3545698243.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5d147460f31c4e08a92070a5fe5e7114","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-33-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index_files/figure-html/cell-33-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Working on these small, relatively contained stable diffusion experiments has been really fun and informative. On one hand, it’s broken some of the “mystique” around diffusion, as I’m able to change and somewhat control image generation with a few lines of code. On the other hand, it’s given a deeper insight into how mercurial and sensitive, and sometimes counterintuitive, the diffusion loop can be.</p>
<p>For negative prompting, the simplest implementation was the most stable one. Swapping the unconditioned prompt with the negative prompt allows for seemingly guaranteed coherent image generation (although I’m sure there will be prompts that would break it!). That being said, I found that <code>pred = u+g*(2*t-u-n)</code> yielded a better image generation for <code>seed=18</code> at the cost of a high level of difficulty (or chance in my case) of finding the right factor to multiply <code>t</code> with.</p>
<p>In the coming blog posts, I’ll be implementing other diffusion tricks, such as image-to-image generation and callbacks.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>stable diffusion</category>
  <category>fastai</category>
  <category>deep learning</category>
  <category>machine learning</category>
  <category>generative AI</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/index.html</guid>
  <pubDate>Wed, 20 Nov 2024 08:00:00 GMT</pubDate>
  <media:content url="https://vishalbakshi.github.io/blog/posts/2024-11-20-negative-prompting/t_factor_18.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Exploring Cosine Similarity in Stable Diffusion’s Latent Space</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index.html</link>
  <description><![CDATA[ 



<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:12:32.655053Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:12:32.654499Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:13:33.272143Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:13:33.271300Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:12:32.654986Z&quot;}">
<details>
<summary>Show setup code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq diffusers transformers<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">4.46.2</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;">!</span>pip install <span class="op" style="color: #5E5E5E;">-</span>qq pillow<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">11.0.0</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> diffusers <span class="im" style="color: #00769E;">import</span> LMSDiscreteScheduler, AutoencoderKL, UNet2DConditionModel, StableDiffusionPipeline</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> CLIPTextModel, CLIPTokenizer</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> PIL <span class="im" style="color: #00769E;">import</span> Image</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> tqdm.auto <span class="im" style="color: #00769E;">import</span> tqdm</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> IPython.display <span class="im" style="color: #00769E;">import</span> display</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb1-11"><span class="im" style="color: #00769E;">import</span> torch, math</span>
<span id="cb1-12"></span>
<span id="cb1-13">tokenizer <span class="op" style="color: #5E5E5E;">=</span> CLIPTokenizer.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16)</span>
<span id="cb1-14">text_encoder <span class="op" style="color: #5E5E5E;">=</span> CLIPTextModel.from_pretrained(<span class="st" style="color: #20794D;">"openai/clip-vit-large-patch14"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-15">vae <span class="op" style="color: #5E5E5E;">=</span> AutoencoderKL.from_pretrained(<span class="st" style="color: #20794D;">"stabilityai/sd-vae-ft-ema"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-16">unet <span class="op" style="color: #5E5E5E;">=</span> UNet2DConditionModel.from_pretrained(<span class="st" style="color: #20794D;">"CompVis/stable-diffusion-v1-4"</span>, subfolder<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"unet"</span>, torch_dtype<span class="op" style="color: #5E5E5E;">=</span>torch.float16).to(<span class="st" style="color: #20794D;">"cuda"</span>)</span>
<span id="cb1-17"></span>
<span id="cb1-18">beta_start,beta_end <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.00085</span>,<span class="fl" style="color: #AD0000;">0.012</span></span>
<span id="cb1-19">scheduler <span class="op" style="color: #5E5E5E;">=</span> LMSDiscreteScheduler(beta_start<span class="op" style="color: #5E5E5E;">=</span>beta_start, beta_end<span class="op" style="color: #5E5E5E;">=</span>beta_end, beta_schedule<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"scaled_linear"</span>, num_train_timesteps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21">height <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-22">width <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">512</span></span>
<span id="cb1-23">num_inference_steps <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">70</span></span>
<span id="cb1-24">guidance_scale <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">7.5</span></span>
<span id="cb1-25">batch_size <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span></span></code></pre></div>
</details>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook, I’ll explore the question: how different are UNet predictions (in latent space) for the conditioned and unconditioned (empty) prompts? The code used in this notebook comes from the <a href="https://github.com/fastai/diffusion-nbs/blob/master/stable_diffusion.ipynb">“Stable Diffusion with Diffusers”</a> from part 2 of the fastai course.</p>
</section>
<section id="generating-images" class="level2">
<h2 class="anchored" data-anchor-id="generating-images">Generating Images</h2>
<p>I’ll start by running the code below to generate an image using stable diffusion:</p>
<ul>
<li><code>text_enc</code> tokenizes the given prompt and converts it to text embeddings using the <code>text_encoder</code>(“openai/clip-vit-large-patch14”).</li>
<li><code>mk_img</code> converts a Tensor to a PIL Image.</li>
<li><code>mk_samples</code> takes the prompt, guidance scale, seed, and number of inference steps to run the diffusion loop and generate a image using the <code>scheduler</code> (<code>LMSDiscreteScheduler</code>), UNet (<code>"CompVis/stable-diffusion-v1-4"</code>) and VAE (<code>"stabilityai/sd-vae-ft-ema"</code>).</li>
</ul>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:20:33.918929Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:20:33.918110Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:20:33.923266Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:20:33.922680Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:20:33.918904Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;">def</span> text_enc(prompts, maxlen<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;">if</span> maxlen <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>: maxlen <span class="op" style="color: #5E5E5E;">=</span> tokenizer.model_max_length</span>
<span id="cb2-3">    inp <span class="op" style="color: #5E5E5E;">=</span> tokenizer(prompts, padding<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"max_length"</span>, max_length<span class="op" style="color: #5E5E5E;">=</span>maxlen, truncation<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>)</span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;">return</span> text_encoder(inp.input_ids.to(<span class="st" style="color: #20794D;">"cuda"</span>))[<span class="dv" style="color: #AD0000;">0</span>].half()</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;">def</span> mk_img(t):</span>
<span id="cb2-7">    image <span class="op" style="color: #5E5E5E;">=</span> (t<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">+</span><span class="fl" style="color: #AD0000;">0.5</span>).clamp(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>).detach().cpu().permute(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>).numpy()</span>
<span id="cb2-8">    <span class="cf" style="color: #003B4F;">return</span> Image.fromarray((image<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">255</span>).<span class="bu" style="color: null;">round</span>().astype(<span class="st" style="color: #20794D;">"uint8"</span>))</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:20:35.090161Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:20:35.089669Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:20:35.161702Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:20:35.161085Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:20:35.090140Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb3-2">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb3-3">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb3-4">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb3-5">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb3-6">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb3-7"></span>
<span id="cb3-8">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb3-9">    scheduler.set_timesteps(steps)</span>
<span id="cb3-10">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb3-11"></span>
<span id="cb3-12">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb3-13">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb3-14">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb3-15">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb3-16">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb3-17"></span>
<span id="cb3-18">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:21:14.748393Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:21:14.747871Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:21:31.511294Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:21:31.510669Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:21:14.748372Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb4-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span>,</span>
<span id="cb4-3">    <span class="st" style="color: #20794D;">'an oil painting of an astronaut riding a horse in the style of grant wood'</span></span>
<span id="cb4-4">]</span>
<span id="cb4-5"></span>
<span id="cb4-6">images <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb4-7"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/2926544816.py:8: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d2512caa5d4d487492325fd186bb4ee7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-5-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-5-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The two images are generated as expected!</p>
</section>
<section id="classifier-free-guidance" class="level2">
<h2 class="anchored" data-anchor-id="classifier-free-guidance">Classifier-Free Guidance</h2>
<p>The lines of code I’m most interested in for this notebook are:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb6-2">pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span></code></pre></div>
<p>In the first line, the <code>unet</code> takes the noisy input latents <code>inp</code>, timestep <code>ts</code> and text embeddings <code>emb</code> to predict the noise in the noisy latent. In the second line, the “final” prediction is taken as <code>u + g*(t-u)</code> where <code>t</code> and <code>u</code> are both predictions form the same UNet:</p>
<ul>
<li><code>u</code> is the predicted noise corresponding to the unconditioned prompt (<code>""</code>).</li>
<li><code>t</code> is the predicted noise corresponding to the conditioned prompt (e.g., <code>'a photograph of an astronaut riding a horse'</code>),</li>
<li><code>g</code> is the <em>guidance scale</em> which is the amount we want to weight the prediction towards <code>t</code> and away from <code>u</code>.</li>
</ul>
<p>Expanding this equation we get: <code>pred = u + gt - gu = gt - (g-1)u</code>. We amplify <code>t</code> by <code>g</code> and then subtract <code>(g-1)</code> times <code>u</code>. Conceptually, we are moving away from the empty prompt and toward the desired prompt. My understanding of why we need <code>u</code> is that we need a baseline or reference point to which we compare <code>t</code> so that we can guide the generation process to learn specific features of <code>t</code> in comparison to general noisy features of of <code>u</code>. This “comparison” is done with the <code>t-u</code> term.</p>
</section>
<section id="cosine-similarity-between-u-and-t" class="level2">
<h2 class="anchored" data-anchor-id="cosine-similarity-between-u-and-t">Cosine Similarity Between <code>u</code> and <code>t</code></h2>
<p>I’m going to modify <code>mk_samples</code> so that at each timestep, it calculates and stores the cosine similarity betwern <code>t</code> and <code>u</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:35:41.642698Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:35:41.642141Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:35:41.648612Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:35:41.647843Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:35:41.642675Z&quot;}" data-execution_count="6">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb7-2">    cs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb7-3">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb7-4">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb7-5">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb7-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb7-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb7-8"></span>
<span id="cb7-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb7-10">    scheduler.set_timesteps(steps)</span>
<span id="cb7-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb7-12"></span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb7-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb7-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb7-16">       </span>
<span id="cb7-17">        cs.append(torch.nn.functional.cosine_similarity(t, u).mean().item())</span>
<span id="cb7-18">        </span>
<span id="cb7-19">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb7-20">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb7-21"></span>
<span id="cb7-22">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): </span>
<span id="cb7-23">        <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample, cs</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:36:05.207475Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:36:05.206940Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:36:12.111986Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:36:12.111308Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:36:05.207453Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb8-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span></span>
<span id="cb8-3">]</span>
<span id="cb8-4"></span>
<span id="cb8-5">images, cs <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb8-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/1126956742.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e500b98a0014449caa9ae37f28d0706b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-7-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-7-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I was shocked to find that the cosine similarity between the unconditioned and the conditioned UNet predictions is so high! Essentially 1.0!!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:36:36.840095Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:36:36.839390Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:36:36.861610Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:36:36.860857Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:36:36.840066Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">pd.Series(cs).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>count    70.000000
mean      0.999616
std       0.000261
min       0.998535
25%       0.999512
50%       0.999512
75%       0.999878
max       1.000000
dtype: float64</code></pre>
</div>
</div>
<p>The two predictions start out basically exactly the same (cosine similarity = 1) and diverge as the diffusion process goes on, reaching the lowest cosine similarity at the 70 inference steps.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:37:53.376327Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:37:53.375586Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:37:53.483031Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:37:53.482459Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:37:53.376298Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">plt.scatter(<span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(cs)),cs)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>This trend of high mean similarity between <code>t</code> and <code>u</code> overall and decreasing cosine similarity over time holds for other prompts as well:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:40:26.602907Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:40:26.602237Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:40:33.501365Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:40:33.500908Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:40:26.602885Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb13-2">    <span class="st" style="color: #20794D;">'a painting of a dog in the style of Picasso'</span></span>
<span id="cb13-3">]</span>
<span id="cb13-4"></span>
<span id="cb13-5">images, cs <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb13-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/1126956742.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4143e33405e242c4b5f50b2d893176e9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-10-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-10-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:40:39.007007Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:40:39.006346Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:40:39.013248Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:40:39.012819Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:40:39.006983Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">pd.Series(cs).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>count    70.000000
mean      0.999923
std       0.000197
min       0.999023
25%       1.000000
50%       1.000000
75%       1.000000
max       1.000000
dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:40:41.651568Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:40:41.651118Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:40:41.723498Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:40:41.723084Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:40:41.651543Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">plt.scatter(<span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(cs)),cs)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-12-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:41:38.173642Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:41:38.172961Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:41:45.086500Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:41:45.085913Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:41:38.173618Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb18-2">    <span class="st" style="color: #20794D;">'a drawing of a woman sitting on a park bench'</span></span>
<span id="cb18-3">]</span>
<span id="cb18-4"></span>
<span id="cb18-5">images, cs <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb18-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/1126956742.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3f0969eaf26e484ca8635aa5d3ac201e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:41:51.700463Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:41:51.700200Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:41:51.707822Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:41:51.706892Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:41:51.700444Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">pd.Series(cs).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>count    70.000000
mean      0.999679
std       0.000233
min       0.999512
25%       0.999512
50%       0.999512
75%       1.000000
max       1.000000
dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T00:41:59.939540Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T00:41:59.939271Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T00:42:00.016233Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T00:42:00.015750Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T00:41:59.939522Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">plt.scatter(<span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(cs)),cs)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="perturbations-in-pred" class="level2">
<h2 class="anchored" data-anchor-id="perturbations-in-pred">Perturbations in <code>pred</code></h2>
<p>My takeaway from the high cosine similarity between conditioned and unconditioned predictions is that the diffusion process is sensitive to small perturbations. However, I found that this wasn’t <em>always</em> the case. To illustrate, I’ll first add a large amount of noise to <code>pred</code> at each timestep and see how that impacts the resulting image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:00:31.574085Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:00:31.573468Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:00:31.579689Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:00:31.579216Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:00:31.574062Z&quot;}" data-execution_count="63">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb23-2">    cs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-3">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb23-4">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb23-5">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb23-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb23-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb23-8"></span>
<span id="cb23-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb23-10">    scheduler.set_timesteps(steps)</span>
<span id="cb23-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb23-12"></span>
<span id="cb23-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb23-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb23-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb23-16">       </span>
<span id="cb23-17">        cs.append(torch.nn.functional.cosine_similarity(t, u).mean().item())</span>
<span id="cb23-18">        </span>
<span id="cb23-19">        r <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.1</span><span class="op" style="color: #5E5E5E;">*</span>torch.randn_like(t)</span>
<span id="cb23-20">        orig_pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb23-21">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u) <span class="op" style="color: #5E5E5E;">+</span> r</span>
<span id="cb23-22">        </span>
<span id="cb23-23">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb23-24"></span>
<span id="cb23-25">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): </span>
<span id="cb23-26">        <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample, cs, orig_pred, r</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:00:32.023341Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:00:32.022722Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:00:38.989202Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:00:38.988575Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:00:32.023319Z&quot;}" data-execution_count="64">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb24-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span></span>
<span id="cb24-3">]</span>
<span id="cb24-4"></span>
<span id="cb24-5">images, cs, orig_pred, r <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb24-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/2326634756.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a6f29010668b409ba26b9da46c9595f4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-17-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:00:42.604558Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:00:42.604291Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:00:42.609986Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:00:42.609483Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:00:42.604540Z&quot;}" data-execution_count="65">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">orig_pred.norm(), r.norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>(tensor(27.3281, device='cuda:0', dtype=torch.float16),
 tensor(12.6328, device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
<p>Adding a noise tensor with about half of the magnitude as the full noise prediction did not prevent the diffusion loop from generating a high quality image! At what point does random noise impact generation?</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:17:59.512567Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:17:59.512304Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:17:59.518575Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:17:59.518021Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:17:59.512548Z&quot;}" data-execution_count="81">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb28-2">    cs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb28-3">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb28-4">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb28-5">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb28-6">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text])</span>
<span id="cb28-7">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb28-8"></span>
<span id="cb28-9">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb28-10">    scheduler.set_timesteps(steps)</span>
<span id="cb28-11">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb28-12"></span>
<span id="cb28-13">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb28-14">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>), ts)</span>
<span id="cb28-15">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t <span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb28-16">       </span>
<span id="cb28-17">        cs.append(torch.nn.functional.cosine_similarity(t, u).mean().item())</span>
<span id="cb28-18">        </span>
<span id="cb28-19">        r <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span><span class="op" style="color: #5E5E5E;">*</span>torch.randn_like(t)</span>
<span id="cb28-20">        orig_pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb28-21">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u) <span class="op" style="color: #5E5E5E;">+</span> r</span>
<span id="cb28-22">        </span>
<span id="cb28-23">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb28-24"></span>
<span id="cb28-25">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): </span>
<span id="cb28-26">        <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample, cs, orig_pred, r</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:18:00.929515Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:18:00.928822Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:18:07.809671Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:18:07.809194Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:18:00.929490Z&quot;}" data-execution_count="82">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb29-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span></span>
<span id="cb29-3">]</span>
<span id="cb29-4"></span>
<span id="cb29-5">images, cs, orig_pred, r <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb29-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/2882368180.py:9: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a149fb4c97b84b9aa738bb080babf4a2","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-20-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:18:10.238779Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:18:10.238107Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:18:10.243530Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:18:10.243177Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:18:10.238730Z&quot;}" data-execution_count="83">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">orig_pred.norm(), r.norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>(tensor(26.2188, device='cuda:0', dtype=torch.float16),
 tensor(25.2656, device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
<p>Adding random noise equal in magnitude to the guided prediction does visibly affect the quality of the generated image, though it still maintains its main structural components (earth, astronaut, horse).</p>
<p>What happens if instead of random noise, I add a UNet prediction based on some other unrelated prompt?</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:06:40.034353Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:06:40.033717Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:06:40.039798Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:06:40.039293Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:06:40.034330Z&quot;}" data-execution_count="73">
<details>
<summary>Show modified <code>mk_samples</code> function</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="kw" style="color: #003B4F;">def</span> mk_samples(prompts, g<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">7.5</span>, seed<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">100</span>, steps<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">70</span>):</span>
<span id="cb33-2">    cs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb33-3">    bs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(prompts)</span>
<span id="cb33-4">    text <span class="op" style="color: #5E5E5E;">=</span> text_enc(prompts)</span>
<span id="cb33-5">    uncond <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">""</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb33-6">    other <span class="op" style="color: #5E5E5E;">=</span> text_enc([<span class="st" style="color: #20794D;">"a toad riding a bicycle"</span>] <span class="op" style="color: #5E5E5E;">*</span> bs, text.shape[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb33-7">    </span>
<span id="cb33-8">    emb <span class="op" style="color: #5E5E5E;">=</span> torch.cat([uncond, text, other])</span>
<span id="cb33-9">    <span class="cf" style="color: #003B4F;">if</span> seed: torch.manual_seed(seed)</span>
<span id="cb33-10"></span>
<span id="cb33-11">    latents <span class="op" style="color: #5E5E5E;">=</span> torch.randn((bs, unet.in_channels, height<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>, width<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb33-12">    scheduler.set_timesteps(steps)</span>
<span id="cb33-13">    latents <span class="op" style="color: #5E5E5E;">=</span> latents.to(<span class="st" style="color: #20794D;">"cuda"</span>).half() <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">15</span></span>
<span id="cb33-14"></span>
<span id="cb33-15">    <span class="cf" style="color: #003B4F;">for</span> i,ts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tqdm(scheduler.timesteps)):</span>
<span id="cb33-16">        inp <span class="op" style="color: #5E5E5E;">=</span> scheduler.scale_model_input(torch.cat([latents] <span class="op" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">3</span>), ts)</span>
<span id="cb33-17">        <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): u,t,o<span class="op" style="color: #5E5E5E;">=</span> unet(inp, ts, encoder_hidden_states<span class="op" style="color: #5E5E5E;">=</span>emb).sample.chunk(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb33-18">       </span>
<span id="cb33-19">        cs.append(torch.nn.functional.cosine_similarity(t, u).mean().item())</span>
<span id="cb33-20">        </span>
<span id="cb33-21">        orig_pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u)</span>
<span id="cb33-22">        pred <span class="op" style="color: #5E5E5E;">=</span> u <span class="op" style="color: #5E5E5E;">+</span> g<span class="op" style="color: #5E5E5E;">*</span>(t<span class="op" style="color: #5E5E5E;">-</span>u) <span class="op" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">0.2</span><span class="op" style="color: #5E5E5E;">*</span>o</span>
<span id="cb33-23">        </span>
<span id="cb33-24">        latents <span class="op" style="color: #5E5E5E;">=</span> scheduler.step(pred, ts, latents).prev_sample</span>
<span id="cb33-25"></span>
<span id="cb33-26">    <span class="cf" style="color: #003B4F;">with</span> torch.no_grad(): </span>
<span id="cb33-27">        <span class="cf" style="color: #003B4F;">return</span> vae.decode(<span class="dv" style="color: #AD0000;">1</span> <span class="op" style="color: #5E5E5E;">/</span> <span class="fl" style="color: #AD0000;">0.18215</span> <span class="op" style="color: #5E5E5E;">*</span> latents).sample, cs, orig_pred, o</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:06:40.697288Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:06:40.696550Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:06:50.405769Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:06:50.405209Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:06:40.697264Z&quot;}" data-execution_count="74">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb34-2">    <span class="st" style="color: #20794D;">'a photograph of an astronaut riding a horse'</span></span>
<span id="cb34-3">]</span>
<span id="cb34-4"></span>
<span id="cb34-5">images, cs, orig_pred, o <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb34-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/70226676.py:11: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b5ea457b2b5e4de1b0920c602d2c1f0c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-23-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-23-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:09:38.686134Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:09:38.685604Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:09:38.697326Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:09:38.696874Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:09:38.686112Z&quot;}" data-execution_count="77">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">orig_pred.norm(), (<span class="fl" style="color: #AD0000;">0.2</span><span class="op" style="color: #5E5E5E;">*</span>o).norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>(tensor(98.5625, device='cuda:0', dtype=torch.float16),
 tensor(19.9688, device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
<p>Now that I’ve introduced text embeddings related to a real prompt with a similar magnitude as the random noise, it’s significantly impacting the image generation result! Which by the way looks super cool.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:11:32.752244Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:11:32.751970Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:11:42.393102Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:11:42.392538Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:11:32.752224Z&quot;}" data-execution_count="78">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">prompts <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb38-2">    <span class="st" style="color: #20794D;">'a drawing of a woman sitting on a park bench'</span></span>
<span id="cb38-3">]</span>
<span id="cb38-4"></span>
<span id="cb38-5">images, cs, orig_pred, o <span class="op" style="color: #5E5E5E;">=</span> mk_samples(prompts)</span>
<span id="cb38-6"><span class="cf" style="color: #003B4F;">for</span> img <span class="kw" style="color: #003B4F;">in</span> images: display(mk_img(img))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_34/70226676.py:11: FutureWarning: Accessing config attribute `in_channels` directly via 'UNet2DConditionModel' object attribute is deprecated. Please access 'in_channels' over 'UNet2DConditionModel's config object instead, e.g. 'unet.config.in_channels'.
  latents = torch.randn((bs, unet.in_channels, height//8, width//8))</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"21adc3fa9c3945539e06f12484ec10c4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-25-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index_files/figure-html/cell-25-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-20T01:11:42.396726Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-20T01:11:42.396427Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-20T01:11:42.403700Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-20T01:11:42.402900Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-20T01:11:42.396701Z&quot;}" data-execution_count="79">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">orig_pred.norm(), (<span class="fl" style="color: #AD0000;">0.2</span><span class="op" style="color: #5E5E5E;">*</span>o).norm()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>(tensor(110.1250, device='cuda:0', dtype=torch.float16),
 tensor(22.0625, device='cuda:0', dtype=torch.float16))</code></pre>
</div>
</div>
<p>I get a similar result using a different prompt.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I hesitate to make any strong conclusions about the diffusion process as I’ve spent only a couple dozen hours experimenting with stable diffusion, but do want to summarize my observations from these experiments:</p>
<ul>
<li><strong>Unconditioned and conditioned prompt UNet predictions are similar</strong>: this was seen by the (very) high cosine similarity between the two at each time step, with cosine similarity decreasing as the time step increased.</li>
<li><strong>Small amounts of random noise doesn’t impact image generation</strong>: while the term “small” is relative, adding random noise that was 50% of the original guided prediction’s norm did not visibly alter the image. Even after adding random noise with the same magnitude as the original guided prediction, the generated image still maintained its core composition and structure.</li>
<li><strong>Adding another prompt’s UNet predictions drastically changes the generated image</strong>: while random noise of the same magnitude did not impact the output image, adding UNet predictions for an unrelated prompt completely changes the color, features and structure of the image (while still maintaining some thematic elements).</li>
</ul>
<p>These observations make me wonder the following questions, that I’ll keep in mind throughout part 2 of the fastai course:</p>
<ul>
<li>Is the small difference in direction between <code>t</code> and <code>u</code> the reason we need relatively large guidance scale values? Is it also the reason why if the guidance scale is too large, we start losing structural features of the desired prompt/image?</li>
<li>Does the fact that structured UNet predictions (as opposed to random noise) impact image generation significantly mean that UNet’s are not sensitive to random noise but are generally susceptible to structured data in the latent space? Why is that?</li>
</ul>
<p>I hope you enjoyed this blog post!</p>


</section>

 ]]></description>
  <category>stable diffusion</category>
  <category>generative AI</category>
  <category>python</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-19-diffusion-cosine-similarity/index.html</guid>
  <pubDate>Tue, 19 Nov 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>Sentiment Classification with Qwen2-0.5B-Instruct</title>
  <dc:creator>Vishal Bakshi</dc:creator>
  <link>https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index.html</link>
  <description><![CDATA[ 



<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:16:28.469994Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:16:28.469349Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:18:25.503200Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:18:25.502427Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:16:28.469918Z&quot;}">
<details>
<summary>Show <code>pip install</code>s</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;">!</span>pip install transformers <span class="op" style="color: #5E5E5E;">-</span>Uqq</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;">!</span>pip install accelerate <span class="op" style="color: #5E5E5E;">-</span>qq</span>
<span id="cb1-3"><span class="op" style="color: #5E5E5E;">!</span>pip install torch<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">2.2.2</span> <span class="op" style="color: #5E5E5E;">-</span>qq</span>
<span id="cb1-4"><span class="op" style="color: #5E5E5E;">!</span>pip install datasets<span class="op" style="color: #5E5E5E;">~=</span><span class="fl" style="color: #AD0000;">2.16.1</span> <span class="op" style="color: #5E5E5E;">-</span>qq</span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;">!</span>pip install scikit<span class="op" style="color: #5E5E5E;">-</span>learn<span class="op" style="color: #5E5E5E;">==</span><span class="fl" style="color: #AD0000;">1.2</span> <span class="op" style="color: #5E5E5E;">-</span>qq</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:15.898137Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:15.897579Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:16.634963Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:16.634205Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:15.898114Z&quot;}" data-execution_count="5">
<details>
<summary>Show imports</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;">from</span> datasets <span class="im" style="color: #00769E;">import</span> load_dataset, Dataset</span>
<span id="cb2-2"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd, numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb2-3"><span class="im" style="color: #00769E;">from</span> sklearn.metrics <span class="im" style="color: #00769E;">import</span> confusion_matrix, ConfusionMatrixDisplay</span>
<span id="cb2-4"><span class="im" style="color: #00769E;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb2-5"><span class="im" style="color: #00769E;">from</span> pandas.api.types <span class="im" style="color: #00769E;">import</span> CategoricalDtype</span>
<span id="cb2-6"><span class="im" style="color: #00769E;">import</span> random</span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="im" style="color: #00769E;">from</span> transformers <span class="im" style="color: #00769E;">import</span> AutoModelForCausalLM, AutoTokenizer</span>
<span id="cb2-9">device <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"cuda"</span> <span class="co" style="color: #5E5E5E;"># the device to load the model onto</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">model <span class="op" style="color: #5E5E5E;">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb2-12">    <span class="st" style="color: #20794D;">"Qwen/Qwen2-0.5B-Instruct"</span>,</span>
<span id="cb2-13">    torch_dtype<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"auto"</span>,</span>
<span id="cb2-14">    device_map<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"auto"</span></span>
<span id="cb2-15">)</span>
<span id="cb2-16">tokenizer <span class="op" style="color: #5E5E5E;">=</span> AutoTokenizer.from_pretrained(<span class="st" style="color: #20794D;">"Qwen/Qwen2-0.5B-Instruct"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:46.679431Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:46.679029Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.352741Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.351913Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:46.679413Z&quot;}">
<details>
<summary>Show dataset loading functions</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;"># load dataset</span></span>
<span id="cb3-2">dataset <span class="op" style="color: #5E5E5E;">=</span> load_dataset(</span>
<span id="cb3-3">    <span class="st" style="color: #20794D;">"financial_phrasebank"</span>, <span class="st" style="color: #20794D;">"sentences_allagree"</span>, </span>
<span id="cb3-4">    split<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"train"</span>  <span class="co" style="color: #5E5E5E;"># note that the dataset does not have a default test split</span></span>
<span id="cb3-5">)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;"># create a new column with the numeric label verbalised as label_text (e.g. "positive" instead of "0")</span></span>
<span id="cb3-8">label_map <span class="op" style="color: #5E5E5E;">=</span> {i: label_text <span class="cf" style="color: #003B4F;">for</span> i, label_text <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(dataset.features[<span class="st" style="color: #20794D;">"label"</span>].names)}</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="kw" style="color: #003B4F;">def</span> add_label_text(example):</span>
<span id="cb3-11">    example[<span class="st" style="color: #20794D;">"label_text"</span>] <span class="op" style="color: #5E5E5E;">=</span> label_map[example[<span class="st" style="color: #20794D;">"label"</span>]]</span>
<span id="cb3-12">    <span class="cf" style="color: #003B4F;">return</span> example</span>
<span id="cb3-13"></span>
<span id="cb3-14">dataset <span class="op" style="color: #5E5E5E;">=</span> dataset.<span class="bu" style="color: null;">map</span>(add_label_text)</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="bu" style="color: null;">print</span>(dataset)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.356381Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.356209Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.361805Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.360968Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.356363Z&quot;}" data-execution_count="8">
<details>
<summary>Show <code>generate_response</code> function</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;">def</span> generate_response(prompt):</span>
<span id="cb4-2">    messages <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb4-3">        {<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"system"</span>, <span class="st" style="color: #20794D;">"content"</span>: <span class="st" style="color: #20794D;">"You are a helpful assistant."</span>},</span>
<span id="cb4-4">        {<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: prompt}</span>
<span id="cb4-5">    ]</span>
<span id="cb4-6">    text <span class="op" style="color: #5E5E5E;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb4-7">        messages,</span>
<span id="cb4-8">        tokenize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb4-9">        add_generation_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb4-10">    )</span>
<span id="cb4-11">    model_inputs <span class="op" style="color: #5E5E5E;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>).to(device)</span>
<span id="cb4-12"></span>
<span id="cb4-13">    generated_ids <span class="op" style="color: #5E5E5E;">=</span> model.generate(</span>
<span id="cb4-14">        model_inputs.input_ids,</span>
<span id="cb4-15">        max_new_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb4-16">    )</span>
<span id="cb4-17">    generated_ids <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb4-18">        output_ids[<span class="bu" style="color: null;">len</span>(input_ids):] <span class="cf" style="color: #003B4F;">for</span> input_ids, output_ids <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(model_inputs.input_ids, generated_ids)</span>
<span id="cb4-19">    ]</span>
<span id="cb4-20"></span>
<span id="cb4-21">    response <span class="op" style="color: #5E5E5E;">=</span> tokenizer.batch_decode(generated_ids, skip_special_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb4-22">    <span class="cf" style="color: #003B4F;">return</span> response</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.365096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.364922Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.371487Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.370703Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.365079Z&quot;}" data-execution_count="9">
<details>
<summary>Show <code>add_prompt</code> and <code>generate_responses</code> functions</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;">def</span> add_prompt(item, prompt):</span>
<span id="cb5-2">        item[<span class="st" style="color: #20794D;">'prompt'</span>] <span class="op" style="color: #5E5E5E;">=</span> prompt.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>item[<span class="st" style="color: #20794D;">'sentence'</span>])</span>
<span id="cb5-3">        <span class="cf" style="color: #003B4F;">return</span> item</span>
<span id="cb5-4">    </span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;">def</span> generate_responses(dataset, prompt):</span>
<span id="cb5-6">    responses <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb5-7">    dataset <span class="op" style="color: #5E5E5E;">=</span> dataset.<span class="bu" style="color: null;">map</span>(add_prompt, fn_kwargs<span class="op" style="color: #5E5E5E;">=</span>{<span class="st" style="color: #20794D;">"prompt"</span>: prompt})</span>
<span id="cb5-8">    <span class="bu" style="color: null;">print</span>(dataset[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'prompt'</span>])</span>
<span id="cb5-9">    </span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;">for</span> row <span class="kw" style="color: #003B4F;">in</span> dataset:</span>
<span id="cb5-11">        messages <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb5-12">            {<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: row[<span class="st" style="color: #20794D;">'prompt'</span>]}</span>
<span id="cb5-13">        ]</span>
<span id="cb5-14">        </span>
<span id="cb5-15">        text <span class="op" style="color: #5E5E5E;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb5-16">            messages,</span>
<span id="cb5-17">            tokenize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb5-18">            add_generation_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb5-19">        )</span>
<span id="cb5-20">        model_inputs <span class="op" style="color: #5E5E5E;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>).to(device)</span>
<span id="cb5-21"></span>
<span id="cb5-22">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> model.generate(</span>
<span id="cb5-23">            model_inputs.input_ids,</span>
<span id="cb5-24">            max_new_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb5-25">        )</span>
<span id="cb5-26">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb5-27">            output_ids[<span class="bu" style="color: null;">len</span>(input_ids):] <span class="cf" style="color: #003B4F;">for</span> input_ids, output_ids <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(model_inputs.input_ids, generated_ids)</span>
<span id="cb5-28">        ]</span>
<span id="cb5-29"></span>
<span id="cb5-30">        response <span class="op" style="color: #5E5E5E;">=</span> tokenizer.batch_decode(generated_ids, skip_special_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">0</span>].strip().lower()</span>
<span id="cb5-31">        responses.append(response)</span>
<span id="cb5-32">        </span>
<span id="cb5-33">    <span class="co" style="color: #5E5E5E;"># calculate accuracy</span></span>
<span id="cb5-34">    df <span class="op" style="color: #5E5E5E;">=</span> dataset.to_pandas()</span>
<span id="cb5-35">    df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> pd.Series(responses)</span>
<span id="cb5-36">    <span class="co" style="color: #5E5E5E;">#df['responses'] = df['responses'].apply(lambda x: x if x in ['negative', 'positive', 'neutral'] else "other")</span></span>
<span id="cb5-37">    df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb5-38">    acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb5-39">    </span>
<span id="cb5-40">    <span class="cf" style="color: #003B4F;">return</span> df, acc</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.374652Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.374497Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.378945Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.378534Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.374638Z&quot;}" data-execution_count="10">
<details>
<summary>Show <code>make_cm</code> function</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;">def</span> make_cm(df):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;">"""Create confusion matrix for true vs predicted sentiment classes"""</span></span>
<span id="cb6-3">    </span>
<span id="cb6-4">    cm <span class="op" style="color: #5E5E5E;">=</span> confusion_matrix(y_true<span class="op" style="color: #5E5E5E;">=</span>df[<span class="st" style="color: #20794D;">'label_text'</span>], y_pred<span class="op" style="color: #5E5E5E;">=</span>df[<span class="st" style="color: #20794D;">'responses'</span>], labels<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'neutral'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'other'</span>])</span>
<span id="cb6-5">    disp <span class="op" style="color: #5E5E5E;">=</span> ConfusionMatrixDisplay(cm, display_labels<span class="op" style="color: #5E5E5E;">=</span>[<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'neutral'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'other'</span>])</span>
<span id="cb6-6">    </span>
<span id="cb6-7">    <span class="co" style="color: #5E5E5E;"># I chose 8x8 so it fits on one screen but still is large</span></span>
<span id="cb6-8">    fig, ax <span class="op" style="color: #5E5E5E;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">8</span>,<span class="dv" style="color: #AD0000;">8</span>))</span>
<span id="cb6-9">    disp.plot(ax<span class="op" style="color: #5E5E5E;">=</span>ax,text_kw<span class="op" style="color: #5E5E5E;">=</span>{<span class="st" style="color: #20794D;">'fontsize'</span>: <span class="dv" style="color: #AD0000;">16</span>}, cmap<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Blues'</span>, colorbar<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb6-10">    </span>
<span id="cb6-11">    <span class="co" style="color: #5E5E5E;"># change label font size without changing label text</span></span>
<span id="cb6-12">    ax.xaxis.label.set_fontsize(<span class="dv" style="color: #AD0000;">18</span>)</span>
<span id="cb6-13">    ax.yaxis.label.set_fontsize(<span class="dv" style="color: #AD0000;">18</span>)</span>
<span id="cb6-14">    </span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;"># make tick labels larger</span></span>
<span id="cb6-16">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'y'</span>, labelsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">16</span>)</span>
<span id="cb6-17">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'x'</span>, labelsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">16</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.381494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.381332Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.385060Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.384497Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.381479Z&quot;}" data-execution_count="11">
<details>
<summary>Show <code>ds_subset</code> function</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;">def</span> ds_subset(dataset, exclude_idxs, columns<span class="op" style="color: #5E5E5E;">=</span>[<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>]):</span>
<span id="cb7-2">    idxs <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(dataset)))</span>
<span id="cb7-3">    idxs <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> idxs <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> exclude_idxs]</span>
<span id="cb7-4">    ddf <span class="op" style="color: #5E5E5E;">=</span> dataset.to_pandas()</span>
<span id="cb7-5">    new_ds <span class="op" style="color: #5E5E5E;">=</span> Dataset.from_pandas(ddf.iloc[idxs, columns])</span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;">return</span> new_ds</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.387400Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.387210Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.393552Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.393013Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.387380Z&quot;}" data-execution_count="12">
<details>
<summary>Show <code>few_shot_responses</code>function</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb8-2">    responses <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb8-3">    dataset <span class="op" style="color: #5E5E5E;">=</span> dataset.<span class="bu" style="color: null;">map</span>(add_prompt, fn_kwargs<span class="op" style="color: #5E5E5E;">=</span>{<span class="st" style="color: #20794D;">"prompt"</span>: prompt})</span>
<span id="cb8-4">    <span class="bu" style="color: null;">print</span>(dataset[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'prompt'</span>])</span>
<span id="cb8-5">    </span>
<span id="cb8-6">    few_shot_examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb8-7">    </span>
<span id="cb8-8">    <span class="cf" style="color: #003B4F;">for</span> example <span class="kw" style="color: #003B4F;">in</span> examples:</span>
<span id="cb8-9">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: prompt.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>example[<span class="dv" style="color: #AD0000;">0</span>])})</span>
<span id="cb8-10">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"assistant"</span>, <span class="st" style="color: #20794D;">"content"</span>: example[<span class="dv" style="color: #AD0000;">1</span>]})</span>
<span id="cb8-11">    </span>
<span id="cb8-12">    <span class="cf" style="color: #003B4F;">for</span> row <span class="kw" style="color: #003B4F;">in</span> dataset:</span>
<span id="cb8-13">        messages <span class="op" style="color: #5E5E5E;">=</span> few_shot_examples <span class="op" style="color: #5E5E5E;">+</span> [{<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: row[<span class="st" style="color: #20794D;">'prompt'</span>]}]</span>
<span id="cb8-14">        </span>
<span id="cb8-15">        text <span class="op" style="color: #5E5E5E;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb8-16">            messages,</span>
<span id="cb8-17">            tokenize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb8-18">            add_generation_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb8-19">        )</span>
<span id="cb8-20">        model_inputs <span class="op" style="color: #5E5E5E;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>).to(device)</span>
<span id="cb8-21"></span>
<span id="cb8-22">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> model.generate(</span>
<span id="cb8-23">            model_inputs.input_ids,</span>
<span id="cb8-24">            max_new_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb8-25">        )</span>
<span id="cb8-26">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb8-27">            output_ids[<span class="bu" style="color: null;">len</span>(input_ids):] <span class="cf" style="color: #003B4F;">for</span> input_ids, output_ids <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(model_inputs.input_ids, generated_ids)</span>
<span id="cb8-28">        ]</span>
<span id="cb8-29"></span>
<span id="cb8-30">        response <span class="op" style="color: #5E5E5E;">=</span> tokenizer.batch_decode(generated_ids, skip_special_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">0</span>].strip().lower()</span>
<span id="cb8-31">        responses.append(response)</span>
<span id="cb8-32">        </span>
<span id="cb8-33">    df <span class="op" style="color: #5E5E5E;">=</span> dataset.to_pandas()</span>
<span id="cb8-34">    df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> pd.Series(responses)</span>
<span id="cb8-35">    </span>
<span id="cb8-36">    <span class="cf" style="color: #003B4F;">return</span> df</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.395840Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.395695Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.399478Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.398810Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.395827Z&quot;}" data-execution_count="13">
<details>
<summary>Show <code>get_acc</code> function</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;">def</span> get_acc(df):</span>
<span id="cb9-2">    df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb9-3">    df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb9-4">    acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb9-5">    <span class="cf" style="color: #003B4F;">return</span> acc</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:19:48.403462Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:19:48.403147Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:19:48.407433Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:19:48.406773Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:19:48.403445Z&quot;}" data-execution_count="14">
<details>
<summary>Show <code>get_ds</code> function</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;">def</span> get_ds(n):</span>
<span id="cb10-2">    exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(n)]</span>
<span id="cb10-3">    prompt_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb10-4"></span>
<span id="cb10-5">    examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb10-7">        examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb10-8">        </span>
<span id="cb10-9">    <span class="bu" style="color: null;">print</span>(prompt_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples[:<span class="dv" style="color: #AD0000;">10</span>]])</span>
<span id="cb10-10">    </span>
<span id="cb10-11">    <span class="cf" style="color: #003B4F;">return</span> prompt_ds, examples</span></code></pre></div>
</details>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I’ll use <a href="https://huggingface.co/Qwen/Qwen2-0.5B-Instruct">Qwen2-0.5B-Instruct</a> to classify sentiment in the <a href="https://huggingface.co/datasets/financial_phrasebank"><code>financial_phrasebank</code> dataset</a>. In previous notebooks I have performed <a href="https://vishalbakshi.github.io/blog/posts/2024-09-23-tinysentiment-Qwen2-1.5B-sentiment-classification/">sentiment classification with Qwen2-1.5B-Instruct</a>, <a href="https://vishalbakshi.github.io/blog/posts/2024-08-31-tinysentiment-phi-2-sentiment-classification/">phi-2</a>, <a href="https://vishalbakshi.github.io/blog/posts/2024-09-12-tinysentiment-phi-3-sentiment-classification/">phi-3</a>, <a href="https://vishalbakshi.github.io/blog/posts/2024-09-12-tinysentiment-phi-3-5-sentiment-classification/">phi-3.5</a>, and <a href="https://vishalbakshi.github.io/blog/posts/2024-08-29-tinysentiment-claude-experiments/">the Claude series</a>.</p>
<p>This notebook is part of <a href="https://vishalbakshi.github.io/blog/#category=TinySentiment">a series of blog posts</a> for a project I’m working called TinySentiment where I’m experimenting with tiny models to improve their ability to classify sentiment in the <code>financial_phrasebank dataset</code>. I was inspired to do so after reading <a href="https://huggingface.co/blog/synthetic-data-save-costs">this blog post</a> and <a href="https://github.com/MoritzLaurer/synthetic-data-blog/blob/main/notebooks/synthetic_data_creation.ipynb">this corresponding notebook</a> by Moritz Laurer as part of a fastai study group last year.</p>
<p>Here are the results from my experiments so far (**the best-performing prompt from this notebook):</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Qwen2-1.5B</td>
<td style="text-align: center;">27-Shot</td>
<td style="text-align: center;">86.10%</td>
<td style="text-align: center;">90% (264/294)</td>
<td style="text-align: center;">96% (1320/1382)</td>
<td style="text-align: center;">61% (342/561)</td>
</tr>
<tr class="even">
<td style="text-align: center;">**Qwen2-0.5B</td>
<td style="text-align: center;">17-Shot</td>
<td style="text-align: center;">79.48%</td>
<td style="text-align: center;">69% (206/300)</td>
<td style="text-align: center;">86% (1180/1380)</td>
<td style="text-align: center;">71% (400/567)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<table class="table">
<thead>
<tr class="header">
<th>Prompt</th>
<th>Strategy</th>
<th>Accuracy</th>
<th>Negative</th>
<th>Neutral</th>
<th>Positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>0-Shot</td>
<td>62.41%</td>
<td>91% (276/303)</td>
<td>53% (735/1391)</td>
<td>71% (402/570)</td>
</tr>
<tr class="even">
<td>B</td>
<td>0-Shot</td>
<td>47.84%</td>
<td>90% (274/303)</td>
<td>57% (789/1391)</td>
<td>4% (20/570)</td>
</tr>
<tr class="odd">
<td>C</td>
<td>0-Shot</td>
<td>40.46%</td>
<td>91% (276/303)</td>
<td>43% (594/1391)</td>
<td>8% (46/570)</td>
</tr>
<tr class="even">
<td>D</td>
<td>0-Shot</td>
<td>68.29%</td>
<td>79% (240/303)</td>
<td>61% (851/1391)</td>
<td>80% (455/570)</td>
</tr>
<tr class="odd">
<td>E</td>
<td>0-Shot</td>
<td>51.19%</td>
<td>97% (293/303)</td>
<td>28% (396/1391)</td>
<td>82% (470/570)</td>
</tr>
<tr class="even">
<td>F</td>
<td>0-Shot</td>
<td>48.19%</td>
<td>94% (286/303)</td>
<td>21% (287/1391)</td>
<td>91% (518/570)</td>
</tr>
<tr class="odd">
<td>G</td>
<td>0-Shot</td>
<td>61.09%</td>
<td>93% (282/303)</td>
<td>46% (646/1391)</td>
<td>80% (455/570)</td>
</tr>
<tr class="even">
<td>H</td>
<td>0-Shot</td>
<td>65.42%</td>
<td>85% (257/303)</td>
<td>57% (798/1391)</td>
<td>75% (426/570)</td>
</tr>
<tr class="odd">
<td>I</td>
<td>0-Shot</td>
<td>66.12%</td>
<td>81% (245/303)</td>
<td>58% (800/1391)</td>
<td>79% (452/570)</td>
</tr>
<tr class="even">
<td>J</td>
<td>3-Shot</td>
<td>70.94%</td>
<td>43% (131/302)</td>
<td>75% (1042/1390)</td>
<td>76% (431/569)</td>
</tr>
<tr class="odd">
<td>K</td>
<td>3-Shot</td>
<td>74.88%</td>
<td>67% (201/302)</td>
<td>75% (1043/1390)</td>
<td>79% (449/569)</td>
</tr>
<tr class="even">
<td>L</td>
<td>3-Shot</td>
<td>68.11%</td>
<td>49% (149/302)</td>
<td>65% (900/1390)</td>
<td>86% (491/569)</td>
</tr>
<tr class="odd">
<td>M</td>
<td>3-Shot</td>
<td>56.97%</td>
<td>49% (149/302)</td>
<td>45% (625/1390)</td>
<td>90% (514/569)</td>
</tr>
<tr class="even">
<td>N</td>
<td>3-Shot</td>
<td>73.95%</td>
<td>62% (188/302)</td>
<td>75% (1038/1390)</td>
<td>78% (446/569)</td>
</tr>
<tr class="odd">
<td>O</td>
<td>3-Shot</td>
<td>59.97%</td>
<td>65% (196/302)</td>
<td>46% (635/1390)</td>
<td>92% (525/569)</td>
</tr>
<tr class="even">
<td>P</td>
<td>6-Shot</td>
<td>63.91%</td>
<td>95% (289/303)</td>
<td>49% (678/1389)</td>
<td>84% (476/566)</td>
</tr>
<tr class="odd">
<td>Q</td>
<td>6-Shot</td>
<td>65.72%</td>
<td>69% (207/302)</td>
<td>55% (765/1389)</td>
<td>90% (512/567)</td>
</tr>
<tr class="even">
<td>R</td>
<td>6-Shot</td>
<td>64.84%</td>
<td>94% (285/303)</td>
<td>49% (686/1387)</td>
<td>87% (493/568)</td>
</tr>
<tr class="odd">
<td>S</td>
<td>6-Shot</td>
<td>62.98%</td>
<td>96% (292/303)</td>
<td>47% (656/1387)</td>
<td>83% (474/568)</td>
</tr>
<tr class="even">
<td>T</td>
<td>6-Shot</td>
<td>68.87%</td>
<td>51% (155/302)</td>
<td>70% (966/1387)</td>
<td>76% (434/569)</td>
</tr>
<tr class="odd">
<td>U</td>
<td>12-Shot</td>
<td>65.50%</td>
<td>53% (159/302)</td>
<td>59% (820/1386)</td>
<td>88% (496/564)</td>
</tr>
<tr class="even">
<td>V</td>
<td>12-Shot</td>
<td>73.22%</td>
<td>70% (209/300)</td>
<td>80% (1103/1386)</td>
<td>60% (337/566)</td>
</tr>
<tr class="odd">
<td>W</td>
<td>12-Shot</td>
<td>70.43%</td>
<td>82% (246/301)</td>
<td>66% (912/1384)</td>
<td>75% (428/567)</td>
</tr>
<tr class="even">
<td>X</td>
<td>12-Shot</td>
<td>76.60%</td>
<td>91% (270/298)</td>
<td>72% (1000/1386)</td>
<td>80% (455/568)</td>
</tr>
<tr class="odd">
<td>Y</td>
<td>12-Shot</td>
<td>72.56%</td>
<td>80% (243/303)</td>
<td>77% (1069/1381)</td>
<td>57% (322/568)</td>
</tr>
<tr class="even">
<td>Z</td>
<td>18-Shot</td>
<td>71.33%</td>
<td>50% (150/301)</td>
<td>75% (1036/1382)</td>
<td>74% (416/563)</td>
</tr>
<tr class="odd">
<td><strong>AA</strong></td>
<td><strong>17-Shot</strong></td>
<td><strong>79.48%</strong></td>
<td>69% (206/300)</td>
<td>86% (1180/1380)</td>
<td>71% (400/567)</td>
</tr>
<tr class="even">
<td>AB</td>
<td>18-Shot</td>
<td>74.22%</td>
<td>77% (229/299)</td>
<td>76% (1054/1381)</td>
<td>68% (384/566)</td>
</tr>
<tr class="odd">
<td>AC</td>
<td>18-Shot</td>
<td>68.57%</td>
<td>49% (148/302)</td>
<td>73% (1013/1380)</td>
<td>67% (379/564)</td>
</tr>
<tr class="even">
<td>AD</td>
<td>18-Shot</td>
<td>74.98%</td>
<td>89% (271/303)</td>
<td>76% (1052/1379)</td>
<td>64% (361/564)</td>
</tr>
<tr class="odd">
<td>AE</td>
<td>24-Shot</td>
<td>74.91%</td>
<td>61% (181/299)</td>
<td>92% (1267/1375)</td>
<td>41% (230/566)</td>
</tr>
<tr class="even">
<td>AF</td>
<td>24-Shot</td>
<td>73.08%</td>
<td>37% (112/302)</td>
<td>91% (1246/1375)</td>
<td>50% (279/563)</td>
</tr>
<tr class="odd">
<td>AG</td>
<td>24-Shot</td>
<td>75.00%</td>
<td>58% (173/300)</td>
<td>92% (1265/1375)</td>
<td>43% (242/565)</td>
</tr>
<tr class="even">
<td>AH</td>
<td>24-Shot</td>
<td>77.46%</td>
<td>78% (233/299)</td>
<td>84% (1153/1375)</td>
<td>62% (349/566)</td>
</tr>
<tr class="odd">
<td>AI</td>
<td>23-Shot</td>
<td>75.37%</td>
<td>48% (143/301)</td>
<td>92% (1266/1375)</td>
<td>50% (280/565)</td>
</tr>
<tr class="even">
<td>AJ</td>
<td>30-Shot</td>
<td>77.39%</td>
<td>58% (172/298)</td>
<td>94% (1284/1370)</td>
<td>48% (273/566)</td>
</tr>
<tr class="odd">
<td>AK</td>
<td>30-Shot</td>
<td>67.78%</td>
<td>63% (187/299)</td>
<td>61% (844/1375)</td>
<td>86% (483/560)</td>
</tr>
<tr class="even">
<td>AL</td>
<td>30-Shot</td>
<td>76.54%</td>
<td>58% (173/299)</td>
<td>86% (1185/1372)</td>
<td>63% (352/563)</td>
</tr>
<tr class="odd">
<td>AM</td>
<td>30-Shot</td>
<td>74.84%</td>
<td>82% (242/296)</td>
<td>72% (984/1376)</td>
<td>79% (446/562)</td>
</tr>
<tr class="even">
<td>AN</td>
<td>30-Shot</td>
<td>73.81%</td>
<td>51% (154/300)</td>
<td>77% (1052/1372)</td>
<td>79% (443/562)</td>
</tr>
<tr class="odd">
<td>AO</td>
<td>45-Shot</td>
<td>74.18%</td>
<td>54% (159/297)</td>
<td>76% (1034/1366)</td>
<td>81% (453/556)</td>
</tr>
<tr class="even">
<td>AP</td>
<td>45-Shot</td>
<td>78.73%</td>
<td>63% (186/296)</td>
<td>87% (1192/1365)</td>
<td>66% (369/558)</td>
</tr>
<tr class="odd">
<td>AQ</td>
<td>45-Shot</td>
<td>72.01%</td>
<td>17% (51/301)</td>
<td>89% (1210/1359)</td>
<td>60% (337/559)</td>
</tr>
<tr class="even">
<td>AR</td>
<td>45-Shot</td>
<td>73.86%</td>
<td>53% (157/297)</td>
<td>80% (1094/1364)</td>
<td>70% (388/558)</td>
</tr>
<tr class="odd">
<td>AS</td>
<td>45-Shot</td>
<td>74.94%</td>
<td>42% (125/297)</td>
<td>89% (1219/1363)</td>
<td>57% (319/559)</td>
</tr>
<tr class="even">
<td>AT</td>
<td>60-Shot</td>
<td>72.19%</td>
<td>47% (138/292)</td>
<td>78% (1055/1356)</td>
<td>72% (398/556)</td>
</tr>
<tr class="odd">
<td>AU</td>
<td>60-Shot</td>
<td>76.86%</td>
<td>43% (127/296)</td>
<td>91% (1237/1356)</td>
<td>60% (330/552)</td>
</tr>
<tr class="even">
<td>AV</td>
<td>60-Shot</td>
<td>75.45%</td>
<td>26% (79/299)</td>
<td>89% (1206/1352)</td>
<td>68% (378/553)</td>
</tr>
<tr class="odd">
<td>AW</td>
<td>60-Shot</td>
<td>74.46%</td>
<td>29% (88/299)</td>
<td>86% (1157/1349)</td>
<td>71% (396/556)</td>
</tr>
<tr class="even">
<td><strong>AX</strong></td>
<td><strong>60-Shot</strong></td>
<td><strong>79.63%</strong></td>
<td>62% (179/290)</td>
<td>94% (1275/1352)</td>
<td>54% (301/562)</td>
</tr>
</tbody>
</table>
</section>
<section id="prompt-a" class="level2">
<h2 class="anchored" data-anchor-id="prompt-a">Prompt A</h2>
<p>I’ll start out with a simple instruction.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:06:57.416392Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:06:57.416240Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:06:57.419066Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:06:57.418576Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:06:57.416379Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">promptA <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb11-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="bu" style="color: null;">print</span>(promptA)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: {text}</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:06:57.419951Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:06:57.419805Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:06:57.423086Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:06:57.422602Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:06:57.419938Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">formatted_prompt <span class="op" style="color: #5E5E5E;">=</span> promptA.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>dataset[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'sentence'</span>])</span>
<span id="cb13-2"><span class="bu" style="color: null;">print</span>(formatted_prompt)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:06:28.885140Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:06:28.884477Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:06:29.963491Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:06:29.963030Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:06:28.885121Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">generate_response(formatted_prompt)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>'Negative.'</code></pre>
</div>
</div>
<p>Good—at least it’s responding with a sensible answer, although it’s not formatted how I’d like to be, so I expect to need more data cleaning than Qwen2-1.5B-Instruct’s responses.</p>
<p>At ~35ms per prompt it will take about 80 seconds to run inference on the full 2264 item dataset.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:07:52.246526Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:07:52.245923Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:07:54.728288Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:07:54.727624Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:07:52.246506Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">10</span> generate_response(formatted_prompt)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>35.4 ms ± 472 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:06:57.423920Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:06:57.423771Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:08:21.273658Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:08:21.273041Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:06:57.423907Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptA)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5c7d5f99af714ca5bc16ef82cd36598c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<p>0.5B yields messier responses. Note the period at the end of some of the strings. For now I’ll manually check each set of responses and clean them accordingly.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:09:42.449650Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:09:42.449408Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:09:42.453694Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:09:42.453268Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:09:42.449632Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array(['neutral.', 'positive', 'neutral', 'negative', 'positive.',
       'negative.', 'negot', 'negative profit', 'net interest', 'teleste',
       'neglig'], dtype=object)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:09:44.550987Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:09:44.550744Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:09:44.555325Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:09:44.554824Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:09:44.550970Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:09:45.888176Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:09:45.887936Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:09:45.891803Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:09:45.891351Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:09:45.888158Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span></code></pre></div>
</div>
<p>0.5B doesn’t do terribly on this simple prompt (62.4% accuracy) but it’s almost 20% less accurate than 1.5B (~82% accuracy).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:09:48.659229Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:09:48.658952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:09:48.664254Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:09:48.663806Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:09:48.659210Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb27-2">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb27-3">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.6241166077738516</code></pre>
</div>
</div>
<p>0.5B does a great job at classifying <code>negative</code> sentiment, does quite well at <code>positive</code> sentences, and has very few <code>other</code> responses overall.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:09:55.592179Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:09:55.591912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:09:55.710721Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:09:55.710240Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:09:55.592158Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-21-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:10:46.788934Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:10:46.788562Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:10:46.824757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:10:46.823462Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:10:46.788911Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_A.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-b" class="level2">
<h2 class="anchored" data-anchor-id="prompt-b">Prompt B</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:19:52.401923Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:19:52.401380Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:19:52.404779Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:19:52.404267Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:19:52.401903Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">promptB <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb31-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span></span>
<span id="cb31-3"><span class="st" style="color: #20794D;">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:19:58.268457Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:19:58.267907Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:21:21.446669Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:21:21.446147Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:19:58.268457Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptB)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2400d2564ed7448bb9a62f7c661b3850","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral</code></pre>
</div>
</div>
<p>With this prompt (where the instruction is repeated after the dataset text) 0.5B responds much more cleanly.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:22:42.185977Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:22:42.185222Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:22:42.190027Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:22:42.189485Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:22:42.185957Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>array(['negative', 'neutral', 'positive'], dtype=object)</code></pre>
</div>
</div>
<p>However, it performs almost 20% worse!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:23:24.094096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:23:24.093590Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:23:24.098934Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:23:24.098407Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:23:24.094077Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb36-2">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb36-3">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0.47835689045936397</code></pre>
</div>
</div>
<p>While it’s quite good still with <code>negative</code> sentiment, it performs significantly worse on <code>positive</code> sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:23:52.963662Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:23:52.962935Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:23:53.042260Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:23:53.041708Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:23:52.963642Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-27-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T02:24:46.629787Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T02:24:46.629542Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T02:24:46.652705Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T02:24:46.652177Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T02:24:46.629772Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_B.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-c" class="level2">
<h2 class="anchored" data-anchor-id="prompt-c">Prompt C</h2>
<p>I’ll use the same Prompt C as the 1.5B model: a reword of Prompt A (which performed well for 0.5B).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:11:42.451637Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:11:42.451364Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:11:42.454661Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:11:42.454054Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:11:42.451618Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">promptC <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Respond with a single word: negative, positive, or neutral</span></span>
<span id="cb40-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:11:50.438572Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:11:50.438227Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:13:13.073197Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:13:13.072496Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:11:50.438549Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptC)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1850d4d1251f4c6f96c147dc47c65bf0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Respond with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:15:21.567381Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:15:21.567036Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:15:21.572013Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:15:21.571626Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:15:21.567357Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array(['negative.', 'negative', 'neutral', 'neutral.', 'positive',
       'positive.', 'negative loss'], dtype=object)</code></pre>
</div>
</div>
<p>The change in prompt language significantly deteriorates 0.5B’s accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:15:59.334134Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:15:59.333858Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:15:59.341454Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:15:59.340898Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:15:59.334115Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb45-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb45-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb45-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb45-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0.4045936395759717</code></pre>
</div>
</div>
<p>0.5B still does really well on <code>negative</code> sentiment, but does horribly on <code>positive</code> and underwhelming for <code>neutral</code> sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:16:09.428930Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:16:09.428567Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:16:09.541818Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:16:09.540818Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:16:09.428906Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-33-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:21:20.952890Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:21:20.952259Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:21:20.969868Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:21:20.969377Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:21:20.952887Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_C.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-d" class="level2">
<h2 class="anchored" data-anchor-id="prompt-d">Prompt D</h2>
<p>I’ll change the order of sentiment listed in Prompt A by putting <code>positive</code> first:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:27:37.315441Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:27:37.314994Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:27:37.317890Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:27:37.317465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:27:37.315417Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">promptD <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: positive, negative, or neutral</span></span>
<span id="cb49-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:27:54.359838Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:27:54.359529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:29:18.187786Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:29:18.187151Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:27:54.359817Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptD)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"56f606b29d494edfa07c6c699f58ed31","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:40:51.283108Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:40:51.282770Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:40:51.289653Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:40:51.288635Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:40:51.283085Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array(['neutral.', 'positive', 'positive.', 'neutral', 'net income',
       'the text', 'negative', 'negative.', 'negative net', 'negot',
       'subscription'], dtype=object)</code></pre>
</div>
</div>
<p>Changing the order of sentiment (putting <code>positive</code> first) increases the overall accuracy by ~6%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:41:17.193956Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:41:17.193527Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:41:17.201748Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:41:17.201048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:41:17.193933Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb54-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb54-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb54-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb54-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.6828621908127208</code></pre>
</div>
</div>
<p>0.5B’s performance on <code>negative</code> sentiment dips a bit (36 fewer correct) but that is more than compensated by the increase in correctly classified <code>positive</code> (+53) and <code>neutral</code> (+166) sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:41:50.466425Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:41:50.466145Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:41:50.550640Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:41:50.550069Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:41:50.466403Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-39-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:43:48.221661Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:43:48.220978Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:43:48.240803Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:43:48.240315Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:43:48.221633Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_D.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-e" class="level2">
<h2 class="anchored" data-anchor-id="prompt-e">Prompt E</h2>
<p>I’ll try another combination:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:57:10.476268Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:57:10.475999Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:57:10.479112Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:57:10.478662Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:57:10.476244Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">promptE <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: negative, neutral, or positive</span></span>
<span id="cb58-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T15:57:11.899422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T15:57:11.898626Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T15:58:34.403468Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T15:58:34.402934Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T15:57:11.899395Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptE)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a18fc62aaeaa4f1dbb934e3ced3673dc","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, neutral, or positive
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:10:02.399949Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:10:02.399307Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:10:02.408731Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:10:02.407068Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:10:02.399915Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>array(['negative.', 'positive', 'negative', 'positive.', 'neutral.',
       'neutral', 'negative profit', 'negot', 'teleste'], dtype=object)</code></pre>
</div>
</div>
<p>This ordering of sentiment worsens the accuracy by 10 points.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:10:14.729900Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:10:14.729337Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:10:14.738751Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:10:14.738157Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:10:14.729876Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb63-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb63-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb63-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb63-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.5119257950530035</code></pre>
</div>
</div>
<p>0.5B is nearly perfect for <code>negative</code> sentiment, and quite good with <code>positive</code> sentences, but abysmal for <code>neutral</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:13:42.609575Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:13:42.609047Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:13:42.699838Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:13:42.699210Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:13:42.609551Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-45-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:16:55.010380Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:16:55.009793Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:16:55.027764Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:16:55.027177Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:16:55.010357Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_E.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-f" class="level2">
<h2 class="anchored" data-anchor-id="prompt-f">Prompt F</h2>
<p>Trying the next permutation of sentiments:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:18:27.966340Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:18:27.965774Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:18:27.969015Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:18:27.968560Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:18:27.966319Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1">promptF <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: positive, neutral, or negative</span></span>
<span id="cb67-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:18:38.888221Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:18:38.887609Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:20:00.199752Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:20:00.199224Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:18:38.888192Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptF)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9289395352be4e30a137504a14a920b1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, neutral, or negative
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:20:03.801905Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:20:03.801662Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:20:03.806739Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:20:03.806163Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:20:03.801889Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>array(['neutral.', 'positive', 'positive.', 'negative', 'negative.',
       'neutral', 'positive net', 'negativ', 'negot', 'subscription'],
      dtype=object)</code></pre>
</div>
</div>
<p>This ordering of sentiments further worsens the overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:20:05.977351Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:20:05.976777Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:20:05.985406Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:20:05.984899Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:20:05.977331Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb72-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb72-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb72-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb72-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>0.4818904593639576</code></pre>
</div>
</div>
<p><code>positive</code> sentences are classified correctly at the highest rate so far, and <code>negative</code> sentiment accuracy is very good, but the model does terribly on <code>neutral</code> sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:32:37.359476Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:32:37.359228Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:32:37.441342Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:32:37.440585Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:32:37.359458Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-51-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:32:40.186530Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:32:40.186271Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:32:40.204090Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:32:40.203521Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:32:40.186510Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_F.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-g" class="level2">
<h2 class="anchored" data-anchor-id="prompt-g">Prompt G</h2>
<p>The next ordering of sentiments:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:44:27.274119Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:44:27.273834Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:44:27.277400Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:44:27.276812Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:44:27.274099Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">promptG <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: neutral, negative, or positive</span></span>
<span id="cb76-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:44:39.176959Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:44:39.176388Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:46:05.987881Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:46:05.987283Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:44:39.176935Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptG)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ed291cc5383142fbaa9e89602fe9cb93","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: neutral, negative, or positive
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:47:35.254527Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:47:35.254223Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:47:35.260071Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:47:35.259184Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:47:35.254505Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>array(['neutral.', 'positive', 'positive.', 'neutral', 'negative',
       'negative.', 'positive profit', 'negot'], dtype=object)</code></pre>
</div>
</div>
<p>The accuracy of 61% is worse than the best-performing Prompt D (68%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:47:44.853309Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:47:44.853065Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:47:44.860139Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:47:44.859592Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:47:44.853291Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb81-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb81-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb81-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb81-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>0.6108657243816255</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:48:42.650613Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:48:42.650331Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:48:42.736844Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:48:42.736238Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:48:42.650593Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-57-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:49:18.201295Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:49:18.201015Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:49:18.219357Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:49:18.218733Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:49:18.201276Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_G.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-h" class="level2">
<h2 class="anchored" data-anchor-id="prompt-h">Prompt H</h2>
<p>The last ordering of sentiment:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:50:02.620945Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:50:02.620686Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:50:02.624335Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:50:02.623735Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:50:02.620926Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">promptH <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: neutral, positive, or negative</span></span>
<span id="cb85-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:50:13.987873Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:50:13.987344Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:51:36.797131Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:51:36.796546Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:50:13.987848Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptH)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a74227e8b18940dbbe9b163108a1dbd1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: neutral, positive, or negative
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:51:48.590402Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:51:48.589784Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:51:48.595347Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:51:48.594512Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:51:48.590374Z&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>array(['positive', 'neutral.', 'positive.', 'neutral', 'negative',
       'negative.', 'positive profit', 'negot'], dtype=object)</code></pre>
</div>
</div>
<p>This yields a 65% accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:51:50.330667Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:51:50.330087Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:51:50.338298Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:51:50.337747Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:51:50.330642Z&quot;}" data-execution_count="55">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb90-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb90-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb90-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb90-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>0.6541519434628975</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:52:04.746828Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:52:04.746140Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:52:04.834796Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:52:04.834229Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:52:04.746805Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-63-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-63-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-15T16:52:19.718116Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-15T16:52:19.717293Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-15T16:52:19.735506Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-15T16:52:19.734996Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-15T16:52:19.718056Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_H.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-i" class="level2">
<h2 class="anchored" data-anchor-id="prompt-i">Prompt I</h2>
<p>I’ll make a small change to my best-performing prompt by adding a period at the end of the instruction.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:08:04.010399Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:08:04.009720Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:08:04.013065Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:08:04.012470Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:08:04.010377Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1">promptI <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: positive, negative, or neutral.</span></span>
<span id="cb94-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:08:06.298948Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:08:06.298427Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:09:30.860558Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:09:30.859947Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:08:06.298919Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1">df, acc <span class="op" style="color: #5E5E5E;">=</span> generate_responses(dataset, promptI)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f7b45463350241638856bab9db483ea5","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:09:30.862173Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:09:30.861908Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:09:30.867177Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:09:30.866590Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:09:30.862147Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array(['neutral.', 'positive', 'positive.', 'neutral', 'net income',
       'negative', 'negative.', 'negative profit', 'nord', 'negot',
       'the text', 'negation', 'neglig', 'subscription'], dtype=object)</code></pre>
</div>
</div>
<p>Adding a period to the end of the instruction worsens the accuracy a bit.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:09:30.868315Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:09:30.868080Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:09:30.875277Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:09:30.874630Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:09:30.868315Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">str</span>.replace(<span class="st" style="color: #20794D;">'.'</span>, <span class="st" style="color: #20794D;">''</span>, regex<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) </span>
<span id="cb99-2">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb99-3">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb99-4">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb99-5">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.6612190812720848</code></pre>
</div>
</div>
<p>Adding a period worsens the performance on <code>neutral</code> by 51 sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:10:54.250514Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:10:54.250220Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:10:54.366578Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:10:54.365989Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:10:54.250495Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-69-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-69-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:12:28.511166Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:12:28.510931Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:12:28.531074Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:12:28.530572Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:12:28.511149Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_I.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-j" class="level2">
<h2 class="anchored" data-anchor-id="prompt-j">Prompt J</h2>
<p>I’ll now shift my attention to few-shot prompts, starting with 3-Shot.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T17:56:36.227336Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T17:56:36.227079Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T17:56:36.232314Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T17:56:36.231086Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T17:56:36.227313Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">292</span>]</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T17:56:40.143384Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T17:56:40.142984Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T17:56:40.190847Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T17:56:40.190145Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T17:56:40.143353Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1">promptJ_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs)</span>
<span id="cb104-2">promptJ_ds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:04:48.021046Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:04:48.020879Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:04:48.023404Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:04:48.022991Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:04:48.021034Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1">promptJ <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"""Label the following TEXT with a single word: positive, negative, or neutral</span></span>
<span id="cb106-2"><span class="st" style="color: #20794D;">TEXT: </span><span class="sc" style="color: #5E5E5E;">{text}</span><span class="st" style="color: #20794D;">"""</span></span></code></pre></div>
</div>
<p>Since ordering seems to matter, I’ll start with a <code>neutral</code> example, <code>positive</code> example and <code>negative</code> example.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:35:39.911727Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:35:39.911071Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:35:39.917007Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:35:39.916420Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:35:39.911703Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb107-2"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb107-3">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb107-4"></span>
<span id="cb107-5">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:37:46.111876Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:37:46.110986Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:39:09.396371Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:39:09.395798Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:37:46.111853Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"606d1d4849b9409287d6f50ddfaae41f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:42:25.182570Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:42:25.182329Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:42:25.187267Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:42:25.186715Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:42:25.182553Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>3-Shot prompting resulted in the best accuracy so far! ~71%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:42:58.519436Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:42:58.518626Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:42:58.526054Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:42:58.525310Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:42:58.519417Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb113-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb113-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb113-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.709420610349403</code></pre>
</div>
</div>
<p>Compared to my best 0-Shot Prompt D (68%) this prompt results in the model significantly underperforming on <code>negative</code> sentences, (131 &lt; 240), but more than making up for it on <code>neutral</code> sentences (1042 &gt; 851).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:43:24.577313Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:43:24.577079Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:43:24.668210Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:43:24.667424Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:43:24.577296Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-78-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:44:51.201093Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:44:51.200511Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:44:51.219628Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:44:51.218946Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:44:51.201067Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_J.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-k" class="level2">
<h2 class="anchored" data-anchor-id="prompt-k">Prompt K</h2>
<p>I’ll re-order the examples and use the same Prompt J.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:55:14.095479Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:55:14.095018Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:55:14.098424Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:55:14.097751Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:55:14.095460Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">292</span>, <span class="dv" style="color: #AD0000;">1</span>]</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:55:15.660698Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:55:15.660098Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:55:15.666226Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:55:15.665556Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:55:15.660673Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb118" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb118-2"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb118-3">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb118-4"></span>
<span id="cb118-5">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T15:55:27.086016Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T15:55:27.085551Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T15:56:55.766250Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T15:56:55.765608Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T15:55:27.085998Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb120" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6a5334d1277c433e9f1b22b417a02168","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:00:00.781085Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:00:00.780829Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:00:00.788849Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:00:00.788246Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:00:00.781066Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb122" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Changing the order of examples to <code>neutral</code>, <code>negative</code>, <code>positive</code> increases the overall accuracy to almost 75%!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:00:09.582843Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:00:09.582549Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:00:09.590055Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:00:09.589330Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:00:09.582823Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb124" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb124-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb124-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb124-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>0.7487837240159222</code></pre>
</div>
</div>
<p>The model improves on all three sentiments compared to Prompt J.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:00:52.046846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:00:52.046570Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:00:52.130637Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:00:52.129935Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:00:52.046828Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb126" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-85-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-85-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:01:31.422192Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:01:31.421912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:01:31.442329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:01:31.441771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:01:31.422173Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb127" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_K.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-l" class="level2">
<h2 class="anchored" data-anchor-id="prompt-l">Prompt L</h2>
<p>I’ll re-order the examples and use the same Prompt J.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:53:09.091102Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:53:09.090421Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:53:09.096950Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:53:09.096179Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:53:09.091091Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb128" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">292</span>]</span>
<span id="cb128-2"></span>
<span id="cb128-3">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb128-4"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb128-5">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb128-6"></span>
<span id="cb128-7">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>[("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:53:12.405932Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:53:12.405679Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:54:36.095190Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:54:36.094453Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:53:12.405914Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb130" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"01f57c52645d46cf814aa725a96f7747","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:55:43.750775Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:55:43.750186Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:55:43.755677Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:55:43.755190Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:55:43.750747Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb132" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This ordering of examples drops the accuracy to 68%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:55:46.251303Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:55:46.250749Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:55:46.258519Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:55:46.258031Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:55:46.251276Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb134" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb134-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb134-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb134-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>0.6811145510835913</code></pre>
</div>
</div>
<p>Compared to the best-performing Prompt K, this prompt yields a better accuracy for <code>positive</code> sentences (491 &gt; 449).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T16:56:07.120059Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T16:56:07.119530Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T16:56:07.207893Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T16:56:07.207391Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T16:56:07.120035Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb136" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-91-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:05:45.878112Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:05:45.877189Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:05:45.897256Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:05:45.896724Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:05:45.878077Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb137" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_L.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-m" class="level2">
<h2 class="anchored" data-anchor-id="prompt-m">Prompt M</h2>
<p>I’ll re-order the examples and use the same Prompt J.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:06:51.120531Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:06:51.120029Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:06:51.125610Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:06:51.124972Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:06:51.120513Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb138" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">292</span>, <span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb138-2"></span>
<span id="cb138-3">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb138-4"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb138-5">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb138-6"></span>
<span id="cb138-7">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>[("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative'),
 ('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:06:53.547086Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:06:53.546549Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:08:17.036467Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:08:17.035964Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:06:53.547062Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb140" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4302906e714349518fd574ec4dfae09d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:10:49.074858Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:10:49.074300Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:10:49.080201Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:10:49.079465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:10:49.074829Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb142" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This ordering of examples worsens the accuracy, dropping it down to 57%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:10:52.645476Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:10:52.645171Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:10:52.654850Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:10:52.654233Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:10:52.645457Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb144" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb144-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb144-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb144-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>0.5696594427244582</code></pre>
</div>
</div>
<p>This prompt yields better results for <code>positive</code> sentiment (514 &gt; 449) than the best overall performing Prompt J.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:11:18.521032Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:11:18.520386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:11:18.603547Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:11:18.603050Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:11:18.521003Z&quot;}" data-execution_count="60">
<div class="sourceCode cell-code" id="cb146" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-97-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-97-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-16T17:12:09.626877Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-16T17:12:09.626335Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-16T17:12:09.647834Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-16T17:12:09.647298Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-16T17:12:09.626854Z&quot;}" data-execution_count="61">
<div class="sourceCode cell-code" id="cb147" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_M.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-n" class="level2">
<h2 class="anchored" data-anchor-id="prompt-n">Prompt N</h2>
<p>Trying the next ordering of sentiments:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T17:58:07.580523Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T17:58:07.579935Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T17:58:07.586872Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T17:58:07.585920Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T17:58:07.580500Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb148" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">292</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb148-2"></span>
<span id="cb148-3">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb148-4"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb148-5">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb148-6"></span>
<span id="cb148-7">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative'),
 ('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:02:03.166870Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:02:03.166144Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:03:36.992645Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:02:03.166828Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb150" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6973944f4a2d45c3b97fadcaa02fa27e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:04:01.271855Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:04:01.270888Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:04:01.279344Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:04:01.278502Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:04:01.271815Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb152" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This ordering results in the second-highest overall accuracy at 74%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:04:14.277567Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:04:14.276719Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:04:14.285341Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:04:14.284486Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:04:14.277543Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb154" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb154-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb154-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb154-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>0.7394957983193278</code></pre>
</div>
</div>
<p>This prompt performs slightly worse for all three sentiments than the so far best-overall performing Prompt K.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:04:55.798501Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:04:55.798190Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:04:55.968689Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:04:55.967973Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:04:55.798482Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb156" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-103-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-103-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:12:51.868774Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:12:51.867994Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:12:51.893470Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:12:51.892649Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:12:51.868738Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb157" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_N.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-o" class="level2">
<h2 class="anchored" data-anchor-id="prompt-o">Prompt O</h2>
<p>Here’s the final 3-sentiment ordering:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:13:32.130448Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:13:32.129456Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:13:32.137291Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:13:32.136442Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:13:32.130411Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb158" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">292</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb158-2"></span>
<span id="cb158-3">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb158-4"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb158-5">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb158-6"></span>
<span id="cb158-7">examples</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>[('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:13:34.944128Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:13:34.943306Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:15:08.938495Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:15:08.937842Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:13:34.944102Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb160" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8ac7113793924d79b01f81366fc539fe","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:15:20.865480Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:15:20.865180Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:15:20.870528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:15:20.869869Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:15:20.865480Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb162" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This ordering of sentiment does not beat my so far best-performing accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:15:31.139347Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:15:31.138569Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:15:31.147849Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:15:31.146964Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:15:31.139324Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb164" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1">df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb164-2">df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb164-3">acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb164-4">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.599734630694383</code></pre>
</div>
</div>
<p>This prompt yields a much better performance on <code>positive</code> sentiment than my best performing Prompt K (525 &gt; 449).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:16:03.893883Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:16:03.893078Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:16:03.983496Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:16:03.982776Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:16:03.893858Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb166" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-109-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-109-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:17:12.074844Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:17:12.074555Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:17:12.094606Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:17:12.093593Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:17:12.074824Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb167" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_O.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-p" class="level2">
<h2 class="anchored" data-anchor-id="prompt-p">Prompt P</h2>
<p>Next, I’ll increase the number of examples to 6. Note that I won’t be trying all permutations but a few random ones.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:22:45.506763Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:22:45.506309Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:22:45.525999Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:22:45.524985Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:22:45.506732Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb168" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">6</span>)]</span>
<span id="cb168-2">promptP_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb168-3">promptP_ds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2258
})</code></pre>
</div>
</div>
<p>The random examples I have picked don’t include a <code>negative</code> sentence. I’m curious to see how the model performs on this.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:24:39.883851Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:24:39.883147Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:24:39.890833Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:24:39.890089Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:24:39.883825Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb170" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb170-2"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb170-3">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb170-4"></span>
<span id="cb170-5">[el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>['positive', 'neutral', 'positive', 'neutral', 'positive', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:24:57.870957Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:24:57.870066Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:26:31.250443Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:26:31.249890Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:24:57.870923Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb172" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptP_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"183fab0bb79a4002a45e4128f4e9b018","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:27:31.129703Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:27:31.129012Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:27:31.134404Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:27:31.133817Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:27:31.129678Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb174" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt results in a worse performance in overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:27:36.542414Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:27:36.542094Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:27:36.549272Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:27:36.548595Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:27:36.542392Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb176" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>0.6390611160318866</code></pre>
</div>
</div>
<p>Even though no <code>negative</code> examples were given, this prompt yields considerably more correct <code>negative</code> sentences (289) than the best-performing Prompt K (201).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:27:59.202779Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:27:59.202423Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:27:59.294910Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:27:59.294212Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:27:59.202767Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb178" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-116-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-116-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:29:35.155708Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:29:35.155156Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:29:35.174855Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:29:35.174110Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:29:35.155686Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb179" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_P.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-q" class="level2">
<h2 class="anchored" data-anchor-id="prompt-q">Prompt Q</h2>
<p>I’ll try another random set of 6 examples, this time making sure there’s at least one of each sentiment.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:30:44.091284Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:30:44.090544Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:30:44.107078Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:30:44.106408Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:30:44.091247Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb180" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">6</span>)]</span>
<span id="cb180-2">promptQ_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb180-3"></span>
<span id="cb180-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb180-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb180-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb180-7">    </span>
<span id="cb180-8">promptQ_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2258
 }),
 ['positive', 'positive', 'positive', 'neutral', 'negative', 'neutral'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:31:15.054828Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:31:15.054035Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:32:49.495380Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:32:49.494839Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:31:15.054803Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb182" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptQ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2b79208198b44f0db1c1a2939d3b12aa","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:34:57.682289Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:34:57.681391Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:34:57.689128Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:34:57.688168Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:34:57.682289Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb184" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>array(['neutral', 'positive', 'negative', 'live'], dtype=object)</code></pre>
</div>
</div>
<p>This set of 6 examples does not improve upon the best-overall accuracy of 75%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:35:03.426521Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:35:03.425759Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:35:03.432401Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:35:03.431896Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:35:03.426499Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb186" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>0.6572187776793623</code></pre>
</div>
</div>
<p>Something we haven’t seen in awhile, an <code>other</code> response.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:35:25.827435Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:35:25.826893Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:35:25.910215Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:35:25.909664Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:35:25.827414Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb188" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-122-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-122-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:35:48.026906Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:35:48.026189Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:35:48.047101Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:35:48.046564Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:35:48.026877Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb189" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_Q.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-r" class="level2">
<h2 class="anchored" data-anchor-id="prompt-r">Prompt R</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:36:39.272463Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:36:39.271784Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:36:39.287884Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:36:39.287385Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:36:39.272439Z&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb190" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">6</span>)]</span>
<span id="cb190-2">promptR_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb190-3"></span>
<span id="cb190-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb190-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb190-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb190-7">    </span>
<span id="cb190-8">promptR_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2258
 }),
 ['neutral', 'neutral', 'positive', 'positive', 'neutral', 'neutral'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:37:26.507209Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:37:26.506807Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:39:01.601663Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:39:01.600997Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:37:26.507184Z&quot;}" data-execution_count="55">
<div class="sourceCode cell-code" id="cb192" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptR_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bb5acb86c42b4da9b40cb5ac0f82eb78","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:41:08.319693Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:41:08.319128Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:41:08.325689Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:41:08.324935Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:41:08.319672Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb194" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>No improvements on accuracy with this prompt.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:41:14.089085Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:41:14.088319Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:41:14.095020Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:41:14.094465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:41:14.089059Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb196" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0.6483613817537643</code></pre>
</div>
</div>
<p>Compared to the best-performing Prompt K, this prompt yields considerably more correct <code>negative</code> (285 &gt; 201) and <code>positive</code> (493 &gt; 449) sentences but underperforms on <code>neutral</code> sentences (686 &lt; 1043).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:41:33.506474Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:41:33.506122Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:41:33.595267Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:41:33.594577Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:41:33.506441Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb198" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-128-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-128-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-17T18:42:48.974479Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-17T18:42:48.973801Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-17T18:42:48.994080Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-17T18:42:48.993159Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-17T18:42:48.974454Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb199" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_R.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-s" class="level2">
<h2 class="anchored" data-anchor-id="prompt-s">Prompt S</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:30:02.213626Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:30:02.213480Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:30:02.241444Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:30:02.240909Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:30:02.213613Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb200" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">6</span>)]</span>
<span id="cb200-2">promptS_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb200-3"></span>
<span id="cb200-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb200-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb200-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb200-7">    </span>
<span id="cb200-8">promptS_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2258
 }),
 ['neutral', 'neutral', 'positive', 'neutral', 'positive', 'neutral'])</code></pre>
</div>
</div>
<p>This set of examples has no <code>negative</code> sentences and a majority of <code>neutral</code> sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:31:16.314738Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:31:16.314444Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:32:45.706853Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:32:45.706328Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:31:16.314703Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb202" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptS_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"875914eead224148b8ba4912d15c8193","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:34:20.439835Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:34:20.439100Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:34:20.445031Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:34:20.444594Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:34:20.439809Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb205" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array(['negative', 'positive', 'neutral'], dtype=object)</code></pre>
</div>
</div>
<p>This set of examples does not improve on the best-overall accuracy of 75% (Prompt K).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:35:14.049197Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:35:14.048458Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:35:14.054289Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:35:14.053903Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:35:14.049173Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb207" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.6297608503100088</code></pre>
</div>
</div>
<p>It does, however, have a considerably larger number of correctly labeled <code>negative</code> sentences (292 &gt; 201).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:35:36.495935Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:35:36.494967Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:35:36.645012Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:35:36.644433Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:35:36.495909Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb209" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-134-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-134-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:36:24.089195Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:36:24.088355Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:36:24.117161Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:36:24.116540Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:36:24.089136Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb210" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_S.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>I’ll try one more 6-shot prompt before I increase the number of examples.</p>
</section>
<section id="prompt-t" class="level2">
<h2 class="anchored" data-anchor-id="prompt-t">Prompt T</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:55:34.309276Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:55:34.308778Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:55:34.323574Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:55:34.323142Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:55:34.309253Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb211" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">6</span>)]</span>
<span id="cb211-2">promptT_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb211-3"></span>
<span id="cb211-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb211-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb211-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb211-7">    </span>
<span id="cb211-8">promptT_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2258
 }),
 ['neutral', 'neutral', 'positive', 'neutral', 'negative', 'neutral'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:55:59.942812Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:55:59.942122Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:57:28.430965Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:57:28.430449Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:55:59.942789Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb213" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptT_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"141b6967bf0b4e5fa4b2c7974c023240","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:58:38.230184Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:58:38.229435Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:58:38.233870Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:58:38.233517Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:58:38.230184Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb215" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Similar to the other 6-Shot examples, this set of examples does not improve on the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:58:45.243422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:58:45.242933Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:58:45.249270Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:58:45.248866Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:58:45.243401Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb217" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0.6886625332152347</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:59:13.946858Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:59:13.946325Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:59:14.027807Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:59:14.027364Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:59:13.946845Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb219" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-140-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-140-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T13:59:32.786118Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T13:59:32.785380Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T13:59:32.806137Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T13:59:32.805471Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T13:59:32.786088Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb220" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_T.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-u" class="level2">
<h2 class="anchored" data-anchor-id="prompt-u">Prompt U</h2>
<p>I’ll now increase the number of examples in the prompt to 12, and try out 5 random sets of 12 examples.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:00:28.621634Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:00:28.620848Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:00:28.635296Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:00:28.634901Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:00:28.621601Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb221" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">12</span>)]</span>
<span id="cb221-2">promptU_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb221-3"></span>
<span id="cb221-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb221-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb221-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb221-7">    </span>
<span id="cb221-8">promptU_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2252
 }),
 ['positive',
  'negative',
  'positive',
  'neutral',
  'positive',
  'positive',
  'neutral',
  'positive',
  'neutral',
  'neutral',
  'positive',
  'neutral'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:01:38.389458Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:01:38.388825Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:03:23.033402Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:03:23.032762Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:01:38.389435Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb223" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptU_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5a98d72cfc14621ad9798b3f5123995","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:06:51.541051Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:06:51.540185Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:06:51.545332Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:06:51.544741Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:06:51.541004Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb225" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Increasing the number of examples to 12, at least the 12 I chose here, doesn’t improve on the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:06:53.560404Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:06:53.559764Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:06:53.565967Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:06:53.565398Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:06:53.560384Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb227" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>0.6549733570159858</code></pre>
</div>
</div>
<p>The number of correct <code>positive</code> sentences is considerably higher than Prompt K (496 &gt; 449).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:07:27.529572Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:07:27.528960Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:07:27.615080Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:07:27.614550Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:07:27.529553Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb229" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-146-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-146-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:08:05.244580Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:08:05.243880Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:08:05.267617Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:08:05.267057Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:08:05.244559Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb230" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_U.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-v" class="level2">
<h2 class="anchored" data-anchor-id="prompt-v">Prompt V</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:08:41.538713Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:08:41.538231Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:08:41.555768Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:08:41.555300Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:08:41.538611Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb231" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">12</span>)]</span>
<span id="cb231-2">promptV_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb231-3"></span>
<span id="cb231-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb231-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb231-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb231-7">    </span>
<span id="cb231-8">promptV_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2252
 }),
 ['neutral',
  'positive',
  'positive',
  'neutral',
  'neutral',
  'negative',
  'negative',
  'neutral',
  'positive',
  'neutral',
  'positive',
  'negative'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:09:32.506121Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:09:32.505853Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:11:13.447020Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:11:13.446226Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:09:32.506103Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb233" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptV_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5f651aff3c8c441292594026344e8679","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:16:12.063113Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:16:12.062440Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:16:12.067632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:16:12.067082Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:16:12.063088Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb235" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt performs well, and competes with but doesn’t improve upon the best overall accuracy of 75%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:16:16.461759Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:16:16.461499Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:16:16.467509Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:16:16.466967Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:16:16.461741Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb237" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>0.7322380106571936</code></pre>
</div>
</div>
<p>This prompt performs considerably better on <code>neutral</code> sentences than Prompt K (1103 &gt; 1043).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:17:55.890782Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:17:55.890082Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:17:55.976293Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:17:55.975697Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:17:55.890759Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb239" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-152-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-152-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:19:21.061429Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:19:21.060771Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:19:21.081270Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:19:21.080651Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:19:21.061407Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb240" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_V.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-w" class="level2">
<h2 class="anchored" data-anchor-id="prompt-w">Prompt W</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:19:45.810925Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:19:45.810659Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:19:45.827633Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:19:45.827027Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:19:45.810906Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb241" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1">exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">12</span>)]</span>
<span id="cb241-2">promptW_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb241-3"></span>
<span id="cb241-4">examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb241-5"><span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb241-6">    examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb241-7">    </span>
<span id="cb241-8">promptW_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2252
 }),
 ['neutral',
  'negative',
  'neutral',
  'positive',
  'neutral',
  'neutral',
  'positive',
  'neutral',
  'neutral',
  'negative',
  'positive',
  'neutral'])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:20:39.997678Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:20:39.996777Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:22:18.186953Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:22:18.186272Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:20:39.997642Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb243" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptW_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2fadb92efc1e4563bc3453b858f70373","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:28:46.745409Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:28:46.744894Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:28:46.750316Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:28:46.749521Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:28:46.745388Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb245" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The accuracy worsens with this set of 12 examples.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:28:59.755112Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:28:59.754567Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:28:59.760524Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:28:59.759989Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:28:59.755092Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb247" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>0.7042628774422736</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:29:15.903542Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:29:15.903018Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:29:15.990840Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:29:15.990293Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:29:15.903523Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb249" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-158-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-158-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-18T14:29:30.630260Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-18T14:29:30.629977Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-18T14:29:30.651992Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-18T14:29:30.651278Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-18T14:29:30.630241Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb250" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_W.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-x" class="level2">
<h2 class="anchored" data-anchor-id="prompt-x">Prompt X</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:34:05.787845Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:34:05.787245Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:34:05.791899Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:34:05.791285Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:34:05.787816Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb251" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><span class="kw" style="color: #003B4F;">def</span> get_ds(n):</span>
<span id="cb251-2">    exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(n)]</span>
<span id="cb251-3">    prompt_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb251-4"></span>
<span id="cb251-5">    examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb251-6">    <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb251-7">        examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb251-8">        </span>
<span id="cb251-9">    <span class="bu" style="color: null;">print</span>(prompt_ds, [el[<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> el <span class="kw" style="color: #003B4F;">in</span> examples])</span>
<span id="cb251-10">    </span>
<span id="cb251-11">    <span class="cf" style="color: #003B4F;">return</span> prompt_ds, examples</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:34:07.213255Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:34:07.212988Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:34:07.243011Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:34:07.242173Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:34:07.213236Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb252" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1">promptX_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">12</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2252
}) ['positive', 'neutral', 'negative', 'neutral', 'positive', 'negative', 'neutral', 'negative', 'negative', 'neutral', 'neutral', 'negative']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:35:04.463653Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:35:04.462984Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:36:51.883836Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:36:51.883265Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:35:04.463577Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb254" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptX_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ffff562f2f0a468798337b4b011c064b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:36:51.885391Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:36:51.885031Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:36:51.893822Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:36:51.893300Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:36:51.885371Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb257" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Aha! This prompt improves upon the best overall accuracy, reaching about 77%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:36:51.894774Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:36:51.894597Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:36:51.900833Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:36:51.900265Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:36:51.894759Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb259" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.7659857904085258</code></pre>
</div>
</div>
<p>Compared to Prompt K (75%) this prompt performs worse on <code>neutral</code> sentences (1000 &lt; 1043) but more than makes up for it on <code>negative</code> (270 &gt; 201) and <code>positive</code> (455 &gt; 449) sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:36:51.902337Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:36:51.901979Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:36:52.019059Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:36:52.018219Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:36:51.902320Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb261" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-165-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-165-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:36:52.020433Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:36:52.019881Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:36:52.039493Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:36:52.039040Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:36:52.020413Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb262" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_X.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-y" class="level2">
<h2 class="anchored" data-anchor-id="prompt-y">Prompt Y</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:52:58.064059Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:52:58.063333Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:52:58.077867Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:52:58.077316Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:52:58.064034Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb263" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1">promptY_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">12</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2252
}) ['neutral', 'neutral', 'neutral', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'neutral', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:53:40.014078Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:53:40.013266Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:55:19.769152Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:55:19.768418Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:53:40.014049Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb265" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptY_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7508b1005ef745398a214941f9314d67","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:55:19.772363Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:55:19.772166Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:55:19.777752Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:55:19.776977Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:55:19.772339Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb267" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>array(['negative', 'positive', 'neutral'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve on the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:55:19.781903Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:55:19.781666Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:55:19.788921Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:55:19.788213Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:55:19.781880Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb269" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>0.7255772646536413</code></pre>
</div>
</div>
<p>This prompt performs well on <code>negative</code> and <code>neutral</code> sentences but its worse performance on <code>positive</code> sentences brings down the overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:55:19.792298Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:55:19.792068Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:55:19.877641Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:55:19.876956Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:55:19.792277Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb271" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-171-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-171-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T12:55:19.881782Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T12:55:19.881592Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T12:55:19.901251Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T12:55:19.900761Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T12:55:19.881763Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb272" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_Y.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Next, I’ll try 5 prompts with 18 examples.</p>
</section>
<section id="prompt-z" class="level2">
<h2 class="anchored" data-anchor-id="prompt-z">Prompt Z</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:04:14.959665Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:04:14.959345Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:04:14.977149Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:04:14.976517Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:04:14.959640Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb273" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1">promptZ_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2246
}) ['neutral', 'neutral', 'neutral', 'positive', 'neutral', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'positive', 'positive', 'neutral', 'positive', 'negative', 'negative', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:04:52.757586Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:04:52.756975Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:07:00.822631Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:07:00.821877Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:04:52.757562Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb275" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptZ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f4d3fde5dc124a87b54dc92ad68555e1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:07:00.825784Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:07:00.825632Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:07:00.830913Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:07:00.830190Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:07:00.825770Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb277" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:07:00.833757Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:07:00.833569Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:07:00.840036Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:07:00.839316Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:07:00.833738Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb279" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0.7132680320569902</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:07:00.842376Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:07:00.842238Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:07:00.928534Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:07:00.927958Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:07:00.842363Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb281" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-177-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-177-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:07:00.932023Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:07:00.931549Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:07:00.949250Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:07:00.948855Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:07:00.932004Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb282" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_Z.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-aa" class="level2">
<h2 class="anchored" data-anchor-id="prompt-aa">Prompt AA</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:10:00.027553Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:10:00.026691Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:10:00.043156Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:10:00.041761Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:10:00.027520Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb283" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1">promptAA_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2247
}) ['neutral', 'negative', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'negative', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:10:18.080573Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:10:18.079668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:12:26.095893Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:12:26.095119Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:10:18.080541Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb285" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAA_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9eee93c8dafb42fab936d0e4163ab7c9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:13:20.214039Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:13:20.213511Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:13:20.218763Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:13:20.218133Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:13:20.214019Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb287" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This set of 18 examples increases the best overall accuraacy to almost 80%!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:13:44.139042Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:13:44.138134Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:13:44.144734Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:13:44.144065Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:13:44.139011Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb289" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>0.7948375611927013</code></pre>
</div>
</div>
<p>Compared to Prompt X, this prompt performs worse on <code>negative</code> (206 &lt; 270) and <code>positive</code> (400 &lt; 455) but more than makes up for it on <code>neutral</code> sentences (1180 &gt; 1000).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:14:55.630928Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:14:55.630280Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:14:55.712690Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:14:55.712227Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:14:55.630904Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb291" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-183-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-183-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:17:38.622646Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:17:38.621923Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:17:38.640908Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:17:38.640426Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:17:38.622618Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb292" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AA.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ab" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ab">Prompt AB</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:18:39.310382Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:18:39.309951Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:18:39.324078Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:18:39.323492Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:18:39.310361Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb293" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1">promptAB_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2246
}) ['neutral', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'negative', 'neutral', 'negative', 'neutral', 'negative', 'neutral', 'positive', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:18:55.502725Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:18:55.502144Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:20:59.052763Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:20:59.051867Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:18:55.502702Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb295" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAB_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4971be2d1b2b4bb781db14c1184fbe1d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:20:59.056101Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:20:59.055877Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:20:59.060932Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:20:59.060110Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:20:59.056101Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb297" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:20:59.064202Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:20:59.063708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:20:59.069116Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:20:59.068587Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:20:59.064190Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb299" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>0.7422083704363313</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:20:59.070877Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:20:59.070782Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:20:59.155477Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:20:59.154892Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:20:59.070864Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb301" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-189-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-189-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-19T13:20:59.160025Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-19T13:20:59.159859Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-19T13:20:59.179450Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-19T13:20:59.178919Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-19T13:20:59.160005Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb302" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AB.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ac" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ac">Prompt AC</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:11:36.105141Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:11:36.104525Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:11:36.127962Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:11:36.127482Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:11:36.105121Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb303" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1">promptAC_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2246
}) ['neutral', 'neutral', 'positive', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'neutral', 'positive', 'positive', 'positive', 'neutral', 'positive', 'neutral', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:12:13.238961Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:12:13.238364Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:14:20.573255Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:14:20.572804Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:12:13.238937Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb305" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAC_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"eef1dc7c1eba4872b16dbad716045260","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:14:20.574833Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:14:20.574189Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:14:20.582637Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:14:20.582294Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:14:20.574812Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb308" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:14:27.886786Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:14:27.886255Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:14:27.892243Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:14:27.891855Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:14:27.886766Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb310" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.6856634016028496</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:16:01.039671Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:16:01.038874Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:16:01.157578Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:16:01.157042Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:16:01.039647Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb312" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-195-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-195-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:16:12.545411Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:16:12.545167Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:16:12.566224Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:16:12.565714Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:16:12.545395Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb313" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AC.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ad" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ad">Prompt AD</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:17:01.824377Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:17:01.823863Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:17:01.837729Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:17:01.837160Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:17:01.824354Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb314" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1">promptAD_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2246
}) ['neutral', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'neutral', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:17:31.376114Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:17:31.375623Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:19:32.081242Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:19:32.080760Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:17:31.376094Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb316" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAD_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"25f501e61aa44a089dff31dc0297bb6c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:19:51.564249Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:19:51.563537Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:19:51.569318Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:19:51.568689Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:19:51.564221Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb318" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:19:57.467901Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:19:57.467630Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:19:57.473771Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:19:57.473193Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:19:57.467883Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb320" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0.7497773820124666</code></pre>
</div>
</div>
<p>This prompt yields considerably more correct <code>negative</code> sentences (271 &gt; 206) than the best-performing Prompt AA.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:20:13.407239Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:20:13.406655Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:20:13.486939Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:20:13.486458Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:20:13.407218Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb322" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-201-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-201-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T13:21:15.836880Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T13:21:15.836244Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T13:21:15.853934Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T13:21:15.853482Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T13:21:15.836858Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb323" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AD.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Next, I’ll try 5 prompts with 24 examples each.</p>
</section>
<section id="prompt-ae" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ae">Prompt AE</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:06:34.990200Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:06:34.989685Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:06:35.004289Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:06:35.003730Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:06:34.990178Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb324" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1">promptAE_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">24</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2240
}) ['neutral', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'negative']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:07:01.009283Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:07:01.008551Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:09:29.947789Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:09:29.947126Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:07:01.009268Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb326" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAE_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b55f037fa913455d8f84840fc1a300bc","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:09:29.949424Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:09:29.948965Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:09:29.953744Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:09:29.953114Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:09:29.949405Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb328" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Increasing the number of examples to 24 (at least for these 24 examples) does not improve upon the overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:10:44.164112Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:10:44.163348Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:10:44.170178Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:10:44.169377Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:10:44.164089Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb330" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.7491071428571429</code></pre>
</div>
</div>
<p>Compared to the best performing Prompt AA, this prompt yields considerably more correct <code>neutral</code> sentences (1267 &gt; 1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:11:10.167126Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:11:10.166543Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:11:10.252463Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:11:10.251831Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:11:10.167105Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb332" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-207-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-207-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:11:48.264076Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:11:48.263561Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:11:48.281581Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:11:48.281073Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:11:48.264055Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb333" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AE.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-af" class="level2">
<h2 class="anchored" data-anchor-id="prompt-af">Prompt AF</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:12:27.100068Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:12:27.099320Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:12:27.113613Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:12:27.113006Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:12:27.100047Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb334" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1">promptAF_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">24</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2240
}) ['positive', 'neutral', 'positive', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:12:51.846335Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:12:51.845791Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:15:15.133578Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:15:15.133044Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:12:51.846312Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb336" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAF_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"47c697ea14a7462d8fb0096424b59e55","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:15:22.017216Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:15:22.016516Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:15:22.021413Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:15:22.020806Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:15:22.017196Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb338" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt doesn’t improve upon the best overall accuracy, and performs better than Prompt AA on <code>neutral</code> sentences.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:15:25.450234Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:15:25.449355Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:15:25.457089Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:15:25.456414Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:15:25.450198Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb340" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>0.7308035714285714</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:15:29.809353Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:15:29.809059Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:15:29.891756Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:15:29.891270Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:15:29.809333Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb342" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-213-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-213-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:16:06.954846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:16:06.954476Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:16:06.973681Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:16:06.973130Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:16:06.954818Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb343" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AF.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ag" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ag">Prompt AG</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:16:24.639488Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:16:24.638961Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:16:24.654808Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:16:24.654039Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:16:24.639467Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb344" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1">promptAG_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">24</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2240
}) ['neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'positive', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:16:47.211752Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:16:47.211493Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:19:09.464632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:19:09.463995Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:16:47.211731Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb346" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAG_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c18ad9c4ac9e4dd6a42ba51aeab75a83","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:19:09.467806Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:19:09.467666Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:19:09.472974Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:19:09.472433Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:19:09.467792Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb348" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The same trend continues for this set of 24 examples.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:20:00.038425Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:20:00.038168Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:20:00.044319Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:20:00.043761Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:20:00.038407Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb350" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>0.75</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:20:08.005110Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:20:08.004271Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:20:08.091111Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:20:08.090399Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:20:08.005086Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb352" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-219-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-219-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-20T14:20:33.937771Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-20T14:20:33.937013Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-20T14:20:33.955295Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-20T14:20:33.954706Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-20T14:20:33.937749Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb353" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AG.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Two more 24-Shot prompts to go.</p>
</section>
<section id="prompt-ah" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ah">Prompt AH</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:04:48.024066Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:04:48.023934Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:04:48.050141Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:04:48.049676Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:04:48.024055Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb354" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1">promptAH_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">24</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2240
}) ['positive', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'negative', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:05:45.187470Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:05:45.186846Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:08:14.556903Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:08:14.556057Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:05:45.187445Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb356" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAH_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7f7fe740de8a47c291bcbdbb0193d2aa","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:08:14.558910Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:08:14.558490Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:08:14.569192Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:08:14.568319Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:08:14.558889Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb359" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon the best overall accuracy (though it comes close).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:08:14.570159Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:08:14.569979Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:08:14.578541Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:08:14.575950Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:08:14.570139Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb361" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.7745535714285714</code></pre>
</div>
</div>
<p>This prompt yields more correct <code>negative</code> sentences than Prompt AA (233 &gt; 206).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:08:14.579757Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:08:14.579586Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:08:14.727926Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:08:14.727196Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:08:14.579743Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb363" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-225-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-225-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:09:22.708743Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:09:22.708213Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:09:22.742293Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:09:22.741676Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:09:22.708723Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb364" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AH.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ai" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ai">Prompt AI</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:09:43.126015Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:09:43.125529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:09:43.141079Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:09:43.140531Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:09:43.125994Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb365" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1">promptAI_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">24</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2241
}) ['neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:10:12.415205Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:10:12.414529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:12:36.825534Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:12:36.824801Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:10:12.415185Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb367" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAI_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"228125d0dfd248e79d375a95c3766411","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:12:36.827176Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:12:36.826743Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:12:36.831317Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:12:36.830718Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:12:36.827158Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb369" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:12:36.832467Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:12:36.832083Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:12:36.837421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:12:36.836954Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:12:36.832453Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb371" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>0.7536813922356091</code></pre>
</div>
</div>
<p>This prompt yields considerably more correct <code>neutral</code> sentences than the best performing Prompt AA (1266 &gt; 1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:12:36.838479Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:12:36.838332Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:12:36.921047Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:12:36.920195Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:12:36.838467Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb373" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-231-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-231-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:14:00.234285Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:14:00.233667Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:14:00.257756Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:14:00.257214Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:14:00.234263Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb374" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb374-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AI.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Next, I’ll try 5 different 30-Shot prompts.</p>
</section>
<section id="prompt-aj" class="level2">
<h2 class="anchored" data-anchor-id="prompt-aj">Prompt AJ</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:14:58.308775Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:14:58.308394Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:14:58.324902Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:14:58.324385Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:14:58.308746Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb375" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1">promptAJ_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
}) ['neutral', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'neutral', 'negative', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:15:33.793768Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:15:33.792810Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:18:26.300816Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:18:26.300275Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:15:33.793736Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb377" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAJ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"388a9a32dcd244488c6d29376f7e02e1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:18:26.302079Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:18:26.301894Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:18:26.313439Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:18:26.312950Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:18:26.302064Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb379" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb379-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt doesn’t improve the best overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:18:26.314278Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:18:26.314106Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:18:26.326790Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:18:26.326222Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:18:26.314258Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb381" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.7739480752014324</code></pre>
</div>
</div>
<p>As seems to be the trend, this prompt results in more correct <code>neutral</code> responses (1284) than Prompt AA (1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:18:26.328350Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:18:26.327918Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:18:26.428491Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:18:26.425775Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:18:26.328333Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb383" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb383-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-237-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-36"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-237-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:19:36.528018Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:19:36.527409Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:19:36.549860Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:19:36.549306Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:19:36.527996Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb384" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AJ.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ak" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ak">Prompt AK</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:20:20.954124Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:20:20.953339Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:20:20.968321Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:20:20.967835Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:20:20.954099Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb385" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb385-1">promptAK_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
}) ['neutral', 'neutral', 'neutral', 'negative', 'negative', 'positive', 'neutral', 'neutral', 'positive', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:20:43.738610Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:20:43.737832Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:23:39.346675Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:23:39.346094Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:20:43.738587Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb387" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb387-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAK_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"752ad28690584f4388f4874bed05f404","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:24:30.273053Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:24:30.272431Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:24:30.278835Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:24:30.278072Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:24:30.273010Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb389" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The model performs considerably worse with these 30 examples.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:24:35.408336Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:24:35.407467Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:24:35.414228Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:24:35.413554Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:24:35.408310Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb391" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb391-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>0.6777081468218442</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:24:58.777713Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:24:58.777114Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:24:58.860097Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:24:58.859621Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:24:58.777692Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb393" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb393-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-243-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-37"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-243-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-21T13:25:17.588606Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-21T13:25:17.588328Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-21T13:25:17.608148Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-21T13:25:17.607538Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-21T13:25:17.588591Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb394" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb394-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AK.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-al" class="level2">
<h2 class="anchored" data-anchor-id="prompt-al">Prompt AL</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:44:03.234919Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:44:03.234661Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:44:03.249997Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:44:03.249509Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:44:03.234901Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb395" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb395-1">promptAL_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
}) ['positive', 'neutral', 'positive', 'positive', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:44:07.149376Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:44:07.149110Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:46:52.918686Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:46:52.918132Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:44:07.149358Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb397" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb397-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAL_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"47d1acf2e84b46cda653d6ad786a3c11","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:46:52.921542Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:46:52.921362Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:46:52.926032Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:46:52.925554Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:46:52.921524Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb399" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb399-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The trend continues: the overall accuracy doesn’t improve but the model’s performance on <code>neutral</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:46:52.928711Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:46:52.928567Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:46:52.934045Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:46:52.933549Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:46:52.928697Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb401" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb401-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>0.76544315129812</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:46:52.936119Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:46:52.935908Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:46:53.020152Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:46:53.019625Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:46:52.936101Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb403" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb403-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-249-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-249-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:46:53.022868Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:46:53.022717Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:46:53.042615Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:46:53.042137Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:46:53.022852Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb404" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb404-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AL.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Two more 30-Shot prompts to go.</p>
</section>
<section id="prompt-am" class="level2">
<h2 class="anchored" data-anchor-id="prompt-am">Prompt AM</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:48:02.571312Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:48:02.570969Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:48:02.588766Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:48:02.588223Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:48:02.571287Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb405" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb405-1">promptAM_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
}) ['negative', 'neutral', 'positive', 'negative', 'neutral', 'neutral', 'positive', 'negative', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:48:05.587942Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:48:05.587162Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:50:56.616413Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:50:56.615827Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:48:05.587921Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb407" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb407-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAM_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0ce200d71898459580ee93e9041dd68a","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:50:56.618963Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:50:56.618658Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:50:56.622701Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:50:56.622370Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:50:56.618946Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb409" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb409-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The overall accuracy doesn’t improve but the model’s performance on <code>negative</code> and <code>positive</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:50:56.625106Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:50:56.624784Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:50:56.629640Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:50:56.629305Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:50:56.625090Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb411" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb411-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.7484333034914951</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:50:56.631734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:50:56.631376Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:50:56.711129Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:50:56.710722Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:50:56.631718Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb413" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb413-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-255-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-39"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-255-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:54:29.225555Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:54:29.224897Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:54:29.304296Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:54:29.303631Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:54:29.225526Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb414" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb414-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AM.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-an" class="level2">
<h2 class="anchored" data-anchor-id="prompt-an">Prompt AN</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:56:32.752141Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:56:32.751348Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:56:32.766574Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:56:32.765928Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:56:32.752117Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb415" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb415-1">promptAN_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
}) ['positive', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:56:48.089634Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:56:48.088913Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:59:44.860049Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:59:44.859324Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:56:48.089611Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb417" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb417-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAN_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"798beda697a54ce18f225ae0ba7e2375","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:59:44.863119Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:59:44.862967Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:59:44.868108Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:59:44.867323Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:59:44.863104Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb419" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb419-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The overall accuracy doesn’t improve but the model’s performance on <code>positive</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:59:44.870915Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:59:44.870764Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:59:44.876373Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:59:44.875818Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:59:44.870895Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb421" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb421-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>0.7381378692927484</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T14:59:44.878437Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T14:59:44.878290Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T14:59:44.966813Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T14:59:44.966381Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T14:59:44.878424Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb423" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb423-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-261-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-40"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-261-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:06:23.636494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:06:23.635730Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:06:23.654901Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:06:23.654453Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:06:23.636468Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb424" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb424-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AN.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Next, I’ll increase the number of examples to 45.</p>
</section>
<section id="prompt-ao" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ao">Prompt AO</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:10:29.131009Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:10:29.130591Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:10:29.146418Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:10:29.146009Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:10:29.130987Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb425" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb425-1">promptAO_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">45</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2219
}) ['neutral', 'neutral', 'positive', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:10:47.464170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:10:47.463358Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:14:32.928491Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:14:32.928034Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:10:47.464145Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb427" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb427-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAO_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cec3262f3d434b96a9d723031d1b520c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:20:13.460268Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:20:13.459781Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:20:13.464427Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:20:13.463966Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:20:13.460246Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb429" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb429-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The overall accuracy doesn’t improve but the model’s performance on <code>positive</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:20:19.637107Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:20:19.636507Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:20:19.643040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:20:19.642342Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:20:19.637085Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb431" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb431-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>0.7417755745831456</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:20:30.733104Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:20:30.732593Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:20:30.814586Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:20:30.814022Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:20:30.733085Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb433" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb433-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-267-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-41"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-267-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:23:03.728708Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:23:03.727797Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:23:03.752066Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:23:03.751438Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:23:03.728676Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb434" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb434-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AO.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ap" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ap">Prompt AP</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:23:30.705033Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:23:30.704766Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:23:30.722006Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:23:30.721399Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:23:30.705014Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb435" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb435-1">promptAP_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">45</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2219
}) ['neutral', 'positive', 'negative', 'neutral', 'positive', 'neutral', 'positive', 'positive', 'neutral', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:23:45.039933Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:23:45.039424Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:27:44.733850Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:27:44.733258Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:23:45.039914Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb437" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb437-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAP_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f5de94812e424e0e8f0d7fc342077431","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:27:44.736642Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:27:44.736500Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:27:44.740547Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:27:44.740171Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:27:44.736628Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb439" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb439-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The overall accuracy doesn’t improve but the model’s performance on <code>neutral</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:27:44.742814Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:27:44.742678Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:27:44.748093Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:27:44.747612Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:27:44.742800Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb441" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb441-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>0.7872915727805317</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:27:44.750078Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:27:44.749944Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:27:44.832577Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:27:44.831788Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:27:44.750065Z&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb443" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb443-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-273-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-42"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-273-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:29:45.605092Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:29:45.604749Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:29:45.625955Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:29:45.625388Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:29:45.605065Z&quot;}" data-execution_count="55">
<div class="sourceCode cell-code" id="cb444" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb444-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AP.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-aq" class="level2">
<h2 class="anchored" data-anchor-id="prompt-aq">Prompt AQ</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:30:17.896877Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:30:17.896340Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:30:17.912057Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:30:17.911549Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:30:17.896857Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb445" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb445-1">promptAQ_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">45</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2219
}) ['neutral', 'neutral', 'negative', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:30:36.925551Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:30:36.924795Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:34:20.670491Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:34:20.669841Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:30:36.925529Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb447" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb447-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAQ_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ecfe97cde26f4fb78d9d05000ee42c75","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:34:20.673221Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:34:20.673061Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:34:20.677376Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:34:20.676909Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:34:20.673221Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb449" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb449-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>The overall accuracy doesn’t improve but the model’s performance on <code>neutral</code> sentences does.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:34:20.679817Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:34:20.679694Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:34:20.684781Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:34:20.684289Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:34:20.679805Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb451" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb451-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>0.7201442091031997</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:34:20.686695Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:34:20.686550Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:34:20.767211Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:34:20.766771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:34:20.686681Z&quot;}" data-execution_count="60">
<div class="sourceCode cell-code" id="cb453" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb453-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-279-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-43"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-279-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-22T15:43:32.655535Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-22T15:43:32.654958Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-22T15:43:32.673359Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-22T15:43:32.672722Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-22T15:43:32.655513Z&quot;}" data-execution_count="61">
<div class="sourceCode cell-code" id="cb454" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb454-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AQ.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ar" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ar">Prompt AR</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T16:56:39.257012Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T16:56:39.256490Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T16:56:39.273011Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T16:56:39.272393Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T16:56:39.256991Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb455" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb455-1">promptAR_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">45</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2219
}) ['neutral', 'negative', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'positive']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T16:56:44.444439Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T16:56:44.443754Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T17:00:37.805708Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T17:00:37.804769Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T16:56:44.444409Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb457" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb457-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAR_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f9583e14f7ec41f1b4bf77273e41cd69","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T17:00:37.807490Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T17:00:37.807133Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T17:00:37.816551Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T17:00:37.815884Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T17:00:37.807470Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb460" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb460-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt performs worse than the best overall Prompt AA.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T17:00:37.817666Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T17:00:37.817496Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T17:00:37.823581Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T17:00:37.823044Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T17:00:37.817651Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb462" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb462-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.7386210004506535</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T17:00:37.824794Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T17:00:37.824588Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T17:00:37.945184Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T17:00:37.944615Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T17:00:37.824776Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb464" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb464-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-285-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-44"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-285-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T17:01:32.220917Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T17:01:32.220256Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T17:01:32.259102Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T17:01:32.258494Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T17:01:32.220891Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb465" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb465-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AR.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-as" class="level2">
<h2 class="anchored" data-anchor-id="prompt-as">Prompt AS</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:14:49.541363Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:14:49.540820Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:14:49.585211Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:14:49.584745Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:14:49.541340Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb466" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb466-1">promptAS_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">45</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2219
}) ['neutral', 'negative', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:15:06.640204Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:15:06.639932Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:18:59.912588Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:18:59.911836Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:15:06.640183Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb468" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb468-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAS_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"82770a240e5d4098ae3ac2480be17e24","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:24:17.995156Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:24:17.994844Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:24:18.007158Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:24:18.006425Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:24:17.995147Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb471" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb471-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array(['positive', 'neutral', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Compared to Prompt AA, this prompt yields a worse overall accuracy but improves on <code>neutral</code> sentences (1291 &gt; 1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:24:22.940661Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:24:22.940381Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:24:22.946895Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:24:22.946352Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:24:22.940642Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb473" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb473-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>0.7494366831906264</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:24:26.444460Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:24:26.443760Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:24:26.642284Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:24:26.641395Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:24:26.444432Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb475" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb475-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-291-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-45"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-291-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:25:07.495770Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:25:07.495464Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:25:07.524451Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:25:07.523689Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:25:07.495750Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb476" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb476-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AS.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
<p>Next, I’ll move on to the final number of examples: 60.</p>
</section>
<section id="prompt-at" class="level2">
<h2 class="anchored" data-anchor-id="prompt-at">Prompt AT</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:25:58.954202Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:25:58.953826Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:25:58.974165Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:25:58.973415Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:25:58.954180Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb477" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb477-1">promptAT_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2204
}) ['positive', 'neutral', 'neutral', 'negative', 'negative', 'neutral', 'neutral', 'neutral', 'negative', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:26:15.186418Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:26:15.185600Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:31:02.017286Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:31:02.016812Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:26:15.186383Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb479" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb479-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAT_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d8237fa0d9834380b2a6431c28ec8acd","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:31:02.020144Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:31:02.019706Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:31:02.023681Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:31:02.023310Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:31:02.020125Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb481" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb481-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Upping the number of examples to 60 does not improve results.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:31:02.026276Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:31:02.025844Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:31:02.030749Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:31:02.030388Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:31:02.026258Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb483" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb483-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>0.7218693284936479</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:31:02.033012Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:31:02.032591Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:31:02.116057Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:31:02.115626Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:31:02.032995Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb485" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb485-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-297-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-46"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-297-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:32:08.073543Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:32:08.072695Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:32:08.094514Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:32:08.094080Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:32:08.073513Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb486" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb486-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AT.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-au" class="level2">
<h2 class="anchored" data-anchor-id="prompt-au">Prompt AU</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:32:40.591396Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:32:40.590317Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:32:40.609182Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:32:40.608772Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:32:40.591364Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb487" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb487-1">promptAU_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2204
}) ['neutral', 'positive', 'neutral', 'positive', 'negative', 'positive', 'positive', 'negative', 'positive', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:33:12.337099Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:33:12.336373Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:38:08.955608Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:38:08.954859Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:33:12.337074Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb489" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb489-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAU_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e0fc36010b744635995c2e97cc11e04c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:38:08.958564Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:38:08.958394Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:38:08.962971Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:38:08.962483Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:38:08.958557Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb491" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb491-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Compared to Prompt AA, this prompt yields a worse overall accuracy but improves on <code>neutral</code> sentences (1237 &gt; 1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:38:08.965851Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:38:08.965750Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:38:08.971395Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:38:08.970892Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:38:08.965845Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb493" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb493-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>0.7686025408348457</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:38:08.973429Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:38:08.973268Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:38:09.057795Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:38:09.057194Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:38:08.973378Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb495" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb495-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-303-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-303-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:41:33.155895Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:41:33.155120Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:41:33.175706Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:41:33.174993Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:41:33.155895Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb496" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb496-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AU.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-av" class="level2">
<h2 class="anchored" data-anchor-id="prompt-av">Prompt AV</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:42:03.776289Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:42:03.775695Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:42:03.796742Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:42:03.796107Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:42:03.776261Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb497" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb497-1">promptAV_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2204
}) ['positive', 'neutral', 'neutral', 'neutral', 'positive', 'positive', 'neutral', 'positive', 'negative', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:42:18.680778Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:42:18.680411Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:47:26.825007Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:47:26.824353Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:42:18.680749Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb499" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb499-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAV_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6023c7bb4f574d22a1ff430de9860e53","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:47:26.827734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:47:26.827580Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:47:26.832589Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:47:26.832103Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:47:26.827719Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb501" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb501-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Compared to Prompt AA, this prompt yields a worse overall accuracy but improves on <code>neutral</code> sentences (1206 &gt; 1180).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:47:26.835430Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:47:26.835276Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:47:26.840976Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:47:26.840418Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:47:26.835412Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb503" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb503-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>0.7545372050816697</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:47:26.843270Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:47:26.843127Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:47:26.932167Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:47:26.931725Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:47:26.843256Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb505" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb505-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-309-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-309-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-23T22:57:19.777810Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-23T22:57:19.777386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-23T22:57:19.800638Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-23T22:57:19.800091Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-23T22:57:19.777778Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb506" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb506-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AV.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-aw" class="level2">
<h2 class="anchored" data-anchor-id="prompt-aw">Prompt AW</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:13:46.901252Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:13:46.899978Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:13:46.938335Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:13:46.937696Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:13:46.901210Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb507" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb507-1">promptAW_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2204
}) ['neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'negative', 'neutral', 'neutral', 'neutral']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:14:02.402419Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:14:02.401711Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:19:18.840331Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:19:18.839550Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:14:02.402390Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb509" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb509-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAW_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d8ff0d468c5c4a0580de6ef51f041e92","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:19:18.843142Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:19:18.841987Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:19:18.850895Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:19:18.850220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:19:18.843105Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb512" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb512-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>This prompt does not improve upon Prompt AA results.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:19:18.852817Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:19:18.851860Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:19:18.859471Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:19:18.858980Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:19:18.852786Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb514" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb514-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.7445553539019963</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:19:18.861731Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:19:18.860891Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:19:18.991387Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:19:18.990545Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:19:18.861699Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb516" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb516-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-315-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-49"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-315-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:19:45.108199Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:19:45.107485Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:19:45.133530Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:19:45.132925Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:19:45.108173Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb517" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb517-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AW.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="prompt-ax" class="level2">
<h2 class="anchored" data-anchor-id="prompt-ax">Prompt AX</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:20:04.507414Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:20:04.506716Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:20:04.527938Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:20:04.527340Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:20:04.507385Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb518" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb518-1">promptAX_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">60</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2204
}) ['neutral', 'neutral', 'negative', 'negative', 'neutral', 'negative', 'positive', 'neutral', 'positive', 'negative']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:20:10.091462Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:20:10.090750Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:25:27.191285Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:25:27.190228Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:20:10.091436Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb520" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb520-1">df <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(promptAX_ds, promptJ, examples)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4d221d9d4d0c4600a68af9640def59c3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: positive, negative, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:25:27.198454Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:25:27.198174Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:25:27.204421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:25:27.203540Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:25:27.198390Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb522" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb522-1">df[<span class="st" style="color: #20794D;">'responses'</span>].unique()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>array(['neutral', 'positive', 'negative'], dtype=object)</code></pre>
</div>
</div>
<p>Aha! We finally improve on the overall accuracy of Prompt AA. This prompt yields a slightly higher accuracy that still rounds off to 80%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:25:27.209328Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:25:27.208741Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:25:27.217153Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:25:27.216291Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:25:27.209302Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb524" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb524-1">get_acc(df)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.7962794918330308</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T14:25:17.853772Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T14:25:17.853150Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T14:25:18.029861Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T14:25:18.029273Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T14:25:17.853750Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb526" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb526-1">make_cm(df)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-321-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-50"><img src="https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index_files/figure-html/cell-321-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-10-24T23:28:23.698804Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-10-24T23:28:23.697946Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-10-24T23:28:23.720236Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-10-24T23:28:23.719380Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-10-24T23:28:23.698764Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb527" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb527-1">df.to_csv(<span class="st" style="color: #20794D;">'/notebooks/Qwen2-0.5B-Instruct_AX.csv'</span>, index<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span></code></pre></div>
</div>
</section>
<section id="running-inference-10-times-using-the-best-prompt" class="level2">
<h2 class="anchored" data-anchor-id="running-inference-10-times-using-the-best-prompt">Running Inference 10 Times Using the Best Prompt</h2>
<p>While 60-shot Prompt AX had a slightly higher accuracy (79.63%) I am going to pick the 16-Shot Prompt AA as my best prompt (79.48%) since it has less than a third of the examples, which translates to about a third of the tokens, thus leading to quicker response generation.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:24:58.367864Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:24:58.367297Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:24:58.373172Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:24:58.372462Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:24:58.367838Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb528" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb528-1"><span class="kw" style="color: #003B4F;">def</span> test_gen(examples):</span>
<span id="cb528-2">    few_shot_examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb528-3">    </span>
<span id="cb528-4">    <span class="cf" style="color: #003B4F;">for</span> example <span class="kw" style="color: #003B4F;">in</span> examples:</span>
<span id="cb528-5">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: promptJ.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>example[<span class="dv" style="color: #AD0000;">0</span>])})</span>
<span id="cb528-6">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"assistant"</span>, <span class="st" style="color: #20794D;">"content"</span>: example[<span class="dv" style="color: #AD0000;">1</span>]})</span>
<span id="cb528-7">    </span>
<span id="cb528-8">    messages <span class="op" style="color: #5E5E5E;">=</span> few_shot_examples <span class="op" style="color: #5E5E5E;">+</span> [{<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: promptJ.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>dataset[<span class="dv" style="color: #AD0000;">0</span>][<span class="st" style="color: #20794D;">'sentence'</span>])}]</span>
<span id="cb528-9">        </span>
<span id="cb528-10">    text <span class="op" style="color: #5E5E5E;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb528-11">        messages,</span>
<span id="cb528-12">        tokenize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb528-13">        add_generation_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb528-14">    )</span>
<span id="cb528-15">    </span>
<span id="cb528-16">    model_inputs <span class="op" style="color: #5E5E5E;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>).to(device)</span>
<span id="cb528-17"></span>
<span id="cb528-18">    generated_ids <span class="op" style="color: #5E5E5E;">=</span> model.generate(</span>
<span id="cb528-19">        model_inputs.input_ids,</span>
<span id="cb528-20">        max_new_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb528-21">    )</span>
<span id="cb528-22">    generated_ids <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb528-23">        output_ids[<span class="bu" style="color: null;">len</span>(input_ids):] <span class="cf" style="color: #003B4F;">for</span> input_ids, output_ids <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(model_inputs.input_ids, generated_ids)</span>
<span id="cb528-24">    ]</span>
<span id="cb528-25"></span>
<span id="cb528-26">    response <span class="op" style="color: #5E5E5E;">=</span> tokenizer.batch_decode(generated_ids, skip_special_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">0</span>].strip().lower()</span>
<span id="cb528-27">    <span class="cf" style="color: #003B4F;">return</span> response</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:26:57.789368Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:26:57.788817Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:26:57.817121Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:26:57.816520Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:26:57.789348Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb529" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb529-1">promptAA_ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(<span class="dv" style="color: #AD0000;">18</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2246
}) ['negative', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'neutral', 'neutral', 'positive', 'positive']</code></pre>
</div>
</div>
<p>1 response generation takes 72ms. Running full dataset inference 10 times will take about 30 minutes.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T13:27:11.898558Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T13:27:11.897846Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T13:27:16.975223Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T13:27:16.974612Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T13:27:11.898534Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb531" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb531-1"><span class="op" style="color: #5E5E5E;">%</span>timeit <span class="op" style="color: #5E5E5E;">-</span>n <span class="dv" style="color: #AD0000;">10</span> test_gen(examples)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The attention mask is not set and cannot be inferred from input because pad token is same as eos token. As a consequence, you may observe unexpected behavior. Please pass your input's `attention_mask` to obtain reliable results.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>72 ms ± 42.9 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T14:25:07.586952Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T14:25:07.586414Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T14:25:07.592898Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T14:25:07.592294Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T14:25:07.586932Z&quot;}" data-execution_count="35">
<details>
<summary>Show updated <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb534" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb534-1"><span class="kw" style="color: #003B4F;">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb534-2">    responses <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb534-3">    dataset <span class="op" style="color: #5E5E5E;">=</span> dataset.<span class="bu" style="color: null;">map</span>(add_prompt, fn_kwargs<span class="op" style="color: #5E5E5E;">=</span>{<span class="st" style="color: #20794D;">"prompt"</span>: prompt})</span>
<span id="cb534-4">    </span>
<span id="cb534-5">    few_shot_examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb534-6">    </span>
<span id="cb534-7">    <span class="cf" style="color: #003B4F;">for</span> example <span class="kw" style="color: #003B4F;">in</span> examples:</span>
<span id="cb534-8">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: prompt.<span class="bu" style="color: null;">format</span>(text<span class="op" style="color: #5E5E5E;">=</span>example[<span class="dv" style="color: #AD0000;">0</span>])})</span>
<span id="cb534-9">        few_shot_examples.append({<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"assistant"</span>, <span class="st" style="color: #20794D;">"content"</span>: example[<span class="dv" style="color: #AD0000;">1</span>]})</span>
<span id="cb534-10">    </span>
<span id="cb534-11">    <span class="cf" style="color: #003B4F;">for</span> row <span class="kw" style="color: #003B4F;">in</span> dataset:</span>
<span id="cb534-12">        messages <span class="op" style="color: #5E5E5E;">=</span> few_shot_examples <span class="op" style="color: #5E5E5E;">+</span> [{<span class="st" style="color: #20794D;">"role"</span>: <span class="st" style="color: #20794D;">"user"</span>, <span class="st" style="color: #20794D;">"content"</span>: row[<span class="st" style="color: #20794D;">'prompt'</span>]}]</span>
<span id="cb534-13">        </span>
<span id="cb534-14">        text <span class="op" style="color: #5E5E5E;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb534-15">            messages,</span>
<span id="cb534-16">            tokenize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,</span>
<span id="cb534-17">            add_generation_prompt<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb534-18">        )</span>
<span id="cb534-19">        model_inputs <span class="op" style="color: #5E5E5E;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"pt"</span>).to(device)</span>
<span id="cb534-20"></span>
<span id="cb534-21">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> model.generate(</span>
<span id="cb534-22">            model_inputs.input_ids,</span>
<span id="cb534-23">            max_new_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb534-24">        )</span>
<span id="cb534-25">        generated_ids <span class="op" style="color: #5E5E5E;">=</span> [</span>
<span id="cb534-26">            output_ids[<span class="bu" style="color: null;">len</span>(input_ids):] <span class="cf" style="color: #003B4F;">for</span> input_ids, output_ids <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(model_inputs.input_ids, generated_ids)</span>
<span id="cb534-27">        ]</span>
<span id="cb534-28"></span>
<span id="cb534-29">        response <span class="op" style="color: #5E5E5E;">=</span> tokenizer.batch_decode(generated_ids, skip_special_tokens<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)[<span class="dv" style="color: #AD0000;">0</span>].strip().lower()</span>
<span id="cb534-30">        responses.append(response)</span>
<span id="cb534-31">        </span>
<span id="cb534-32">    <span class="co" style="color: #5E5E5E;"># calculate accuracy</span></span>
<span id="cb534-33">    df <span class="op" style="color: #5E5E5E;">=</span> dataset.to_pandas()</span>
<span id="cb534-34">    df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> pd.Series(responses)</span>
<span id="cb534-35">    df[<span class="st" style="color: #20794D;">'responses'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'responses'</span>].<span class="bu" style="color: null;">apply</span>(<span class="kw" style="color: #003B4F;">lambda</span> x: x <span class="cf" style="color: #003B4F;">if</span> x <span class="kw" style="color: #003B4F;">in</span> [<span class="st" style="color: #20794D;">'negative'</span>, <span class="st" style="color: #20794D;">'positive'</span>, <span class="st" style="color: #20794D;">'neutral'</span>] <span class="cf" style="color: #003B4F;">else</span> <span class="st" style="color: #20794D;">"other"</span>)</span>
<span id="cb534-36">    df[<span class="st" style="color: #20794D;">'lm_match'</span>] <span class="op" style="color: #5E5E5E;">=</span> df[<span class="st" style="color: #20794D;">'label_text'</span>] <span class="op" style="color: #5E5E5E;">==</span> df[<span class="st" style="color: #20794D;">'responses'</span>]</span>
<span id="cb534-37">    acc <span class="op" style="color: #5E5E5E;">=</span> df.lm_match.mean()</span>
<span id="cb534-38">    </span>
<span id="cb534-39">    <span class="cf" style="color: #003B4F;">return</span> df, acc</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T14:30:35.214749Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T14:30:35.214075Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T14:30:35.218795Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T14:30:35.217941Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T14:30:35.214728Z&quot;}" data-execution_count="38">
<details>
<summary>Show updated <code>get_ds</code> function</summary>
<div class="sourceCode cell-code" id="cb535" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb535-1"><span class="kw" style="color: #003B4F;">def</span> get_ds(n):</span>
<span id="cb535-2">    exclude_idxs <span class="op" style="color: #5E5E5E;">=</span> [random.randint(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2263</span>) <span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(n)]</span>
<span id="cb535-3">    prompt_ds <span class="op" style="color: #5E5E5E;">=</span> ds_subset(dataset, exclude_idxs<span class="op" style="color: #5E5E5E;">=</span>exclude_idxs)</span>
<span id="cb535-4"></span>
<span id="cb535-5">    examples <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb535-6">    <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> exclude_idxs:</span>
<span id="cb535-7">        examples.append((dataset[idx][<span class="st" style="color: #20794D;">'sentence'</span>], dataset[idx][<span class="st" style="color: #20794D;">'label_text'</span>]))</span>
<span id="cb535-8">    </span>
<span id="cb535-9">    <span class="cf" style="color: #003B4F;">return</span> prompt_ds, examples</span></code></pre></div>
</details>
</div>
<p>I didn’t store the exact 18 examples that I used the first time for Prompt AA, so I had to try different 18-Shot examples until I achieved an accuracy close to 79.48%. It took me about 20 tries, but I finally found a set of examples that broke the 79% threshold.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T14:54:34.566913Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T14:54:34.566209Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T14:56:40.474028Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T14:56:40.473384Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T14:54:34.566886Z&quot;}">
<div class="sourceCode cell-code" id="cb536" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb536-1"><span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">20</span>):</span>
<span id="cb536-2">    n <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">18</span></span>
<span id="cb536-3">    ds, examples <span class="op" style="color: #5E5E5E;">=</span> get_ds(n)</span>
<span id="cb536-4">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(ds) <span class="op" style="color: #5E5E5E;">!=</span> <span class="dv" style="color: #AD0000;">2264</span> <span class="op" style="color: #5E5E5E;">-</span> n: <span class="cf" style="color: #003B4F;">pass</span></span>
<span id="cb536-5">    df, acc <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(ds, promptJ, examples)</span>
<span id="cb536-6">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">round</span>(acc, <span class="dv" style="color: #AD0000;">2</span>) <span class="op" style="color: #5E5E5E;">&gt;=</span> <span class="fl" style="color: #AD0000;">0.79</span>: <span class="cf" style="color: #003B4F;">break</span></span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T15:00:29.979940Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T15:00:29.979419Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T15:00:29.983830Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T15:00:29.983227Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T15:00:29.979918Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb537" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb537-1">acc</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>0.815227070347284</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T15:02:22.448916Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T15:02:22.448661Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T15:02:22.453161Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T15:02:22.452663Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T15:02:22.448900Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb539" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb539-1">ds, <span class="bu" style="color: null;">len</span>(examples)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>(Dataset({
     features: ['sentence', 'label', 'label_text', '__index_level_0__'],
     num_rows: 2246
 }),
 18)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T15:02:31.195144Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T15:02:31.194651Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T15:23:40.781808Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T15:23:40.781140Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T15:02:31.195123Z&quot;}">
<div class="sourceCode cell-code" id="cb541" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb541-1">accs <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb541-2"><span class="cf" style="color: #003B4F;">for</span> _ <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">10</span>):</span>
<span id="cb541-3">    df, acc <span class="op" style="color: #5E5E5E;">=</span> few_shot_responses(ds, promptJ, examples)</span>
<span id="cb541-4">    accs.append(acc)</span></code></pre></div>
</div>
<p>For this prompt, the overall accuracy ranges from 80.8% to 82.4%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-18T15:23:40.784481Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-18T15:23:40.784344Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-18T15:23:40.792597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-18T15:23:40.792074Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-18T15:23:40.784466Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb542" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb542-1">pd.Series(accs).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>count    10.000000
mean      0.816830
std       0.005397
min       0.807658
25%       0.814003
50%       0.817453
75%       0.819791
max       0.824577
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Takeaways from my Qwen2-0.5B experiments:</p>
<ul>
<li><strong>Example order matters</strong>: Testing 6 prompts with the same 3 examples in different orders yielded accuracies from 57% to 75%.<br>
</li>
<li><strong>Example selection matters</strong>: Recreating the performance of one of my best prompts (79.48% accuracy) took ~20 attempts, proving not all sets of examples perform equally.<br>
</li>
<li><strong>Result variance exists</strong>: Running a prompt 10 times produced accuracies ranging from 80.8% to 82.4%.</li>
</ul>
<p>Here are the results of Qwen2-0.5B in the context of the other models that I have experimented with:</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Qwen2-1.5B</td>
<td style="text-align: center;">27-Shot</td>
<td style="text-align: center;">86.10%</td>
<td style="text-align: center;">90% (264/294)</td>
<td style="text-align: center;">96% (1320/1382)</td>
<td style="text-align: center;">61% (342/561)</td>
</tr>
<tr class="even">
<td style="text-align: center;">**Qwen2-0.5B</td>
<td style="text-align: center;">17-Shot</td>
<td style="text-align: center;">79.48%</td>
<td style="text-align: center;">69% (206/300)</td>
<td style="text-align: center;">86% (1180/1380)</td>
<td style="text-align: center;">71% (400/567)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<table class="table">
<thead>
<tr class="header">
<th>Prompt</th>
<th>Strategy</th>
<th>Accuracy</th>
<th>Negative</th>
<th>Neutral</th>
<th>Positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>0-Shot</td>
<td>62.41%</td>
<td>91% (276/303)</td>
<td>53% (735/1391)</td>
<td>71% (402/570)</td>
</tr>
<tr class="even">
<td>B</td>
<td>0-Shot</td>
<td>47.84%</td>
<td>90% (274/303)</td>
<td>57% (789/1391)</td>
<td>4% (20/570)</td>
</tr>
<tr class="odd">
<td>C</td>
<td>0-Shot</td>
<td>40.46%</td>
<td>91% (276/303)</td>
<td>43% (594/1391)</td>
<td>8% (46/570)</td>
</tr>
<tr class="even">
<td>D</td>
<td>0-Shot</td>
<td>68.29%</td>
<td>79% (240/303)</td>
<td>61% (851/1391)</td>
<td>80% (455/570)</td>
</tr>
<tr class="odd">
<td>E</td>
<td>0-Shot</td>
<td>51.19%</td>
<td>97% (293/303)</td>
<td>28% (396/1391)</td>
<td>82% (470/570)</td>
</tr>
<tr class="even">
<td>F</td>
<td>0-Shot</td>
<td>48.19%</td>
<td>94% (286/303)</td>
<td>21% (287/1391)</td>
<td>91% (518/570)</td>
</tr>
<tr class="odd">
<td>G</td>
<td>0-Shot</td>
<td>61.09%</td>
<td>93% (282/303)</td>
<td>46% (646/1391)</td>
<td>80% (455/570)</td>
</tr>
<tr class="even">
<td>H</td>
<td>0-Shot</td>
<td>65.42%</td>
<td>85% (257/303)</td>
<td>57% (798/1391)</td>
<td>75% (426/570)</td>
</tr>
<tr class="odd">
<td>I</td>
<td>0-Shot</td>
<td>66.12%</td>
<td>81% (245/303)</td>
<td>58% (800/1391)</td>
<td>79% (452/570)</td>
</tr>
<tr class="even">
<td>J</td>
<td>3-Shot</td>
<td>70.94%</td>
<td>43% (131/302)</td>
<td>75% (1042/1390)</td>
<td>76% (431/569)</td>
</tr>
<tr class="odd">
<td>K</td>
<td>3-Shot</td>
<td>74.88%</td>
<td>67% (201/302)</td>
<td>75% (1043/1390)</td>
<td>79% (449/569)</td>
</tr>
<tr class="even">
<td>L</td>
<td>3-Shot</td>
<td>68.11%</td>
<td>49% (149/302)</td>
<td>65% (900/1390)</td>
<td>86% (491/569)</td>
</tr>
<tr class="odd">
<td>M</td>
<td>3-Shot</td>
<td>56.97%</td>
<td>49% (149/302)</td>
<td>45% (625/1390)</td>
<td>90% (514/569)</td>
</tr>
<tr class="even">
<td>N</td>
<td>3-Shot</td>
<td>73.95%</td>
<td>62% (188/302)</td>
<td>75% (1038/1390)</td>
<td>78% (446/569)</td>
</tr>
<tr class="odd">
<td>O</td>
<td>3-Shot</td>
<td>59.97%</td>
<td>65% (196/302)</td>
<td>46% (635/1390)</td>
<td>92% (525/569)</td>
</tr>
<tr class="even">
<td>P</td>
<td>6-Shot</td>
<td>63.91%</td>
<td>95% (289/303)</td>
<td>49% (678/1389)</td>
<td>84% (476/566)</td>
</tr>
<tr class="odd">
<td>Q</td>
<td>6-Shot</td>
<td>65.72%</td>
<td>69% (207/302)</td>
<td>55% (765/1389)</td>
<td>90% (512/567)</td>
</tr>
<tr class="even">
<td>R</td>
<td>6-Shot</td>
<td>64.84%</td>
<td>94% (285/303)</td>
<td>49% (686/1387)</td>
<td>87% (493/568)</td>
</tr>
<tr class="odd">
<td>S</td>
<td>6-Shot</td>
<td>62.98%</td>
<td>96% (292/303)</td>
<td>47% (656/1387)</td>
<td>83% (474/568)</td>
</tr>
<tr class="even">
<td>T</td>
<td>6-Shot</td>
<td>68.87%</td>
<td>51% (155/302)</td>
<td>70% (966/1387)</td>
<td>76% (434/569)</td>
</tr>
<tr class="odd">
<td>U</td>
<td>12-Shot</td>
<td>65.50%</td>
<td>53% (159/302)</td>
<td>59% (820/1386)</td>
<td>88% (496/564)</td>
</tr>
<tr class="even">
<td>V</td>
<td>12-Shot</td>
<td>73.22%</td>
<td>70% (209/300)</td>
<td>80% (1103/1386)</td>
<td>60% (337/566)</td>
</tr>
<tr class="odd">
<td>W</td>
<td>12-Shot</td>
<td>70.43%</td>
<td>82% (246/301)</td>
<td>66% (912/1384)</td>
<td>75% (428/567)</td>
</tr>
<tr class="even">
<td>X</td>
<td>12-Shot</td>
<td>76.60%</td>
<td>91% (270/298)</td>
<td>72% (1000/1386)</td>
<td>80% (455/568)</td>
</tr>
<tr class="odd">
<td>Y</td>
<td>12-Shot</td>
<td>72.56%</td>
<td>80% (243/303)</td>
<td>77% (1069/1381)</td>
<td>57% (322/568)</td>
</tr>
<tr class="even">
<td>Z</td>
<td>18-Shot</td>
<td>71.33%</td>
<td>50% (150/301)</td>
<td>75% (1036/1382)</td>
<td>74% (416/563)</td>
</tr>
<tr class="odd">
<td><strong>AA</strong></td>
<td><strong>17-Shot</strong></td>
<td><strong>79.48%</strong></td>
<td>69% (206/300)</td>
<td>86% (1180/1380)</td>
<td>71% (400/567)</td>
</tr>
<tr class="even">
<td>AB</td>
<td>18-Shot</td>
<td>74.22%</td>
<td>77% (229/299)</td>
<td>76% (1054/1381)</td>
<td>68% (384/566)</td>
</tr>
<tr class="odd">
<td>AC</td>
<td>18-Shot</td>
<td>68.57%</td>
<td>49% (148/302)</td>
<td>73% (1013/1380)</td>
<td>67% (379/564)</td>
</tr>
<tr class="even">
<td>AD</td>
<td>18-Shot</td>
<td>74.98%</td>
<td>89% (271/303)</td>
<td>76% (1052/1379)</td>
<td>64% (361/564)</td>
</tr>
<tr class="odd">
<td>AE</td>
<td>24-Shot</td>
<td>74.91%</td>
<td>61% (181/299)</td>
<td>92% (1267/1375)</td>
<td>41% (230/566)</td>
</tr>
<tr class="even">
<td>AF</td>
<td>24-Shot</td>
<td>73.08%</td>
<td>37% (112/302)</td>
<td>91% (1246/1375)</td>
<td>50% (279/563)</td>
</tr>
<tr class="odd">
<td>AG</td>
<td>24-Shot</td>
<td>75.00%</td>
<td>58% (173/300)</td>
<td>92% (1265/1375)</td>
<td>43% (242/565)</td>
</tr>
<tr class="even">
<td>AH</td>
<td>24-Shot</td>
<td>77.46%</td>
<td>78% (233/299)</td>
<td>84% (1153/1375)</td>
<td>62% (349/566)</td>
</tr>
<tr class="odd">
<td>AI</td>
<td>23-Shot</td>
<td>75.37%</td>
<td>48% (143/301)</td>
<td>92% (1266/1375)</td>
<td>50% (280/565)</td>
</tr>
<tr class="even">
<td>AJ</td>
<td>30-Shot</td>
<td>77.39%</td>
<td>58% (172/298)</td>
<td>94% (1284/1370)</td>
<td>48% (273/566)</td>
</tr>
<tr class="odd">
<td>AK</td>
<td>30-Shot</td>
<td>67.78%</td>
<td>63% (187/299)</td>
<td>61% (844/1375)</td>
<td>86% (483/560)</td>
</tr>
<tr class="even">
<td>AL</td>
<td>30-Shot</td>
<td>76.54%</td>
<td>58% (173/299)</td>
<td>86% (1185/1372)</td>
<td>63% (352/563)</td>
</tr>
<tr class="odd">
<td>AM</td>
<td>30-Shot</td>
<td>74.84%</td>
<td>82% (242/296)</td>
<td>72% (984/1376)</td>
<td>79% (446/562)</td>
</tr>
<tr class="even">
<td>AN</td>
<td>30-Shot</td>
<td>73.81%</td>
<td>51% (154/300)</td>
<td>77% (1052/1372)</td>
<td>79% (443/562)</td>
</tr>
<tr class="odd">
<td>AO</td>
<td>45-Shot</td>
<td>74.18%</td>
<td>54% (159/297)</td>
<td>76% (1034/1366)</td>
<td>81% (453/556)</td>
</tr>
<tr class="even">
<td>AP</td>
<td>45-Shot</td>
<td>78.73%</td>
<td>63% (186/296)</td>
<td>87% (1192/1365)</td>
<td>66% (369/558)</td>
</tr>
<tr class="odd">
<td>AQ</td>
<td>45-Shot</td>
<td>72.01%</td>
<td>17% (51/301)</td>
<td>89% (1210/1359)</td>
<td>60% (337/559)</td>
</tr>
<tr class="even">
<td>AR</td>
<td>45-Shot</td>
<td>73.86%</td>
<td>53% (157/297)</td>
<td>80% (1094/1364)</td>
<td>70% (388/558)</td>
</tr>
<tr class="odd">
<td>AS</td>
<td>45-Shot</td>
<td>74.94%</td>
<td>42% (125/297)</td>
<td>89% (1219/1363)</td>
<td>57% (319/559)</td>
</tr>
<tr class="even">
<td>AT</td>
<td>60-Shot</td>
<td>72.19%</td>
<td>47% (138/292)</td>
<td>78% (1055/1356)</td>
<td>72% (398/556)</td>
</tr>
<tr class="odd">
<td>AU</td>
<td>60-Shot</td>
<td>76.86%</td>
<td>43% (127/296)</td>
<td>91% (1237/1356)</td>
<td>60% (330/552)</td>
</tr>
<tr class="even">
<td>AV</td>
<td>60-Shot</td>
<td>75.45%</td>
<td>26% (79/299)</td>
<td>89% (1206/1352)</td>
<td>68% (378/553)</td>
</tr>
<tr class="odd">
<td>AW</td>
<td>60-Shot</td>
<td>74.46%</td>
<td>29% (88/299)</td>
<td>86% (1157/1349)</td>
<td>71% (396/556)</td>
</tr>
<tr class="even">
<td><strong>AX</strong></td>
<td><strong>60-Shot</strong></td>
<td><strong>79.63%</strong></td>
<td>62% (179/290)</td>
<td>94% (1275/1352)</td>
<td>54% (301/562)</td>
</tr>
</tbody>
</table>


</section>

 ]]></description>
  <category>python</category>
  <category>LLM</category>
  <category>TinySentiment</category>
  <guid>https://vishalbakshi.github.io/blog/posts/2024-11-18-tinysentiment-Qwen2-0.5B-SC/index.html</guid>
  <pubDate>Mon, 18 Nov 2024 08:00:00 GMT</pubDate>
</item>
</channel>
</rss>
