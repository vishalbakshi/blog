<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-02-05">
<meta name="description" content="In this notebook I work through Jeremy Howard’s Live Coding 13 video in which he finishes working on the Paddy Doctor Disease Classification Kaggle Competition.">

<title>Vishal Bakshi’s Blog - Paddy Doctor Kaggle Competition - Part 6</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the Data</a></li>
  <li><a href="#multi-task-classification" id="toc-multi-task-classification" class="nav-link" data-scroll-target="#multi-task-classification">Multi-Task Classification</a></li>
  <li><a href="#converting-imagedataloaders-to-datablock" id="toc-converting-imagedataloaders-to-datablock" class="nav-link" data-scroll-target="#converting-imagedataloaders-to-datablock">Converting <code>ImageDataLoaders</code> to <code>DataBlock</code></a></li>
  <li><a href="#make-datablock-spit-out-three-things" id="toc-make-datablock-spit-out-three-things" class="nav-link" data-scroll-target="#make-datablock-spit-out-three-things">Make <code>DataBlock</code> Spit Out Three Things</a></li>
  <li><a href="#how-does-transformblock-and-imageblock-work" id="toc-how-does-transformblock-and-imageblock-work" class="nav-link" data-scroll-target="#how-does-transformblock-and-imageblock-work">How does <code>TransformBlock</code> and <code>ImageBlock</code> work</a></li>
  <li><a href="#defining-datablock-for-multi-classification-notebook" id="toc-defining-datablock-for-multi-classification-notebook" class="nav-link" data-scroll-target="#defining-datablock-for-multi-classification-notebook">Defining <code>DataBlock</code> for multi-classification notebook</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Paddy Doctor Kaggle Competition - Part 6</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I work through Jeremy Howard’s Live Coding 13 video in which he finishes working on the Paddy Doctor Disease Classification Kaggle Competition.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the fastai course Part 1 <a href="https://youtu.be/AdhG64NF76E?feature=shared&amp;t=3117">Lesson 6 video</a> Jeremy Howard walked through the notebooks <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2">Small models: Road to the Top, Part 2</a> where he builds increasingly accurate solutions to the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> Kaggle Competition. In the video, Jeremy referenced a series of walkthrough videos that he made while working through the four-notebook series for this competition. I’m excited to watch these walkthroughs to better understand how to approach a Kaggle competition from the perspective of a former #1 Kaggle grandmaster.</p>
<p>In this blog post series, I’ll walk through the code Jeremy shared in each of the 6 Live Coding videos focused on this competition, submitting predictions to Kaggle along the way. My last two blog posts in this series reference Jeremy’s <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a> notebook to improve my large model ensemble predictions. Here are the links to each of the blog posts in this series:</p>
<ul>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-1/">Part 1: Live Coding 8</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-2/">Part 2: Live Coding 9</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">Part 3: Live Coding 10</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-4/">Part 4: Live Coding 11</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-5/">Part 5: Live Coding 12</a></li>
<li>Part 6: Live Coding 13 (You are here)</li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-7/">Part 7: Improving My Large Ensemble, Part 1</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-8/">Part 8: Improving My Large Ensemble, Part 2</a></li>
</ul>
<p><a href="https://www.youtube.com/watch?v=INrkhUGCXHg">Link to Live Coding 13</a></p>
<section id="loading-the-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-data">Loading the Data</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:54:58.910234Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:54:58.909875Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:55:18.635401Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:55:18.634444Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:54:58.910205Z&quot;}" data-trusted="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq timm<span class="op">==</span><span class="fl">0.6.13</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>timm.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>'0.6.13'</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:55:22.253977Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:55:22.253052Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:55:50.363528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:55:50.361132Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:55:22.253941Z&quot;}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install fastkaggle if not available</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="im">import</span> fastkaggle</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> ModuleNotFoundError:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>Uq fastkaggle</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastkaggle <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>comp <span class="op">=</span> <span class="st">'paddy-disease-classification'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> setup_comp(comp, install<span class="op">=</span><span class="st">'fastai'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.16.5 and &lt;1.23.0 is required for this version of SciPy (detected version 1.24.3
  warnings.warn(f"A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}"</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:55:50.367725Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:55:50.366993Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:55:50.382521Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:55:50.380635Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:55:50.367671Z&quot;}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>(#4) [Path('../input/paddy-disease-classification/sample_submission.csv'),Path('../input/paddy-disease-classification/train_images'),Path('../input/paddy-disease-classification/train.csv'),Path('../input/paddy-disease-classification/test_images')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:55:50.387534Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:55:50.383968Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:55:50.396069Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:55:50.394542Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:55:50.387484Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="multi-task-classification" class="level3">
<h3 class="anchored" data-anchor-id="multi-task-classification">Multi-Task Classification</h3>
<p>Jeremy re-did his approach to the multi-head (multi-task) classification that we started in the last live coding session. Spoiler alert: it didn’t turn out to help our final score, the score was about the same. As soon as Jeremy turned off Zoom and went for a walk, he realized how he should approach this problem. We can make this much much simpler.</p>
<p>We are going to try to predict two things: the disease and the variety for each image. The first thing is to create a pair of <code>DataLoaders</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:55:50.399544Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:55:50.398871Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:55:50.448028Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:55:50.446848Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:55:50.399506Z&quot;}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'train.csv'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image_id</th>
      <th>label</th>
      <th>variety</th>
      <th>age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>100330.jpg</td>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100365.jpg</td>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100382.jpg</td>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>3</th>
      <td>100632.jpg</td>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>4</th>
      <td>101918.jpg</td>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="converting-imagedataloaders-to-datablock" class="level3">
<h3 class="anchored" data-anchor-id="converting-imagedataloaders-to-datablock">Converting <code>ImageDataLoaders</code> to <code>DataBlock</code></h3>
<p>Recreate what we had starting from the small models where Jeremy used <code>ImageDataLoaders</code> which is the highest-level, least-flexible function where you can do all of the data processing in a single line of code but only if we want to do something really standard. Trying to predict two things is not standard enough for it.</p>
<p>We need to go one layer down. All of the work in <code>ImageDataLoaders</code> is being done by <code>DataBlock</code>, which is still high-level API but very flexible.</p>
<p>Here’s how to setup a <code>DataBlock</code> for disease classification:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T01:54:35.214532Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T01:54:35.213772Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T01:54:43.565327Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T01:54:43.564266Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T01:54:35.214498Z&quot;}" data-trusted="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> parent_label,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(trn_path)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Here’s the source code of <code>ImageBlock</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ImageBlock(cls:PILBase<span class="op">=</span>PILImage):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A `TransformBlock` for images of `cls`"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TransformBlock(type_tfms<span class="op">=</span>cls.create, batch_tfms<span class="op">=</span>IntToFloatTensor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which calls <code>PILImage.create</code>, which returns an Image from a filename:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T01:59:50.253913Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T01:59:50.253573Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T01:59:50.263771Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T01:59:50.262826Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T01:59:50.253888Z&quot;}" data-trusted="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>PILImage.create?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
PILImage<span class="ansi-blue-fg">.</span>create<span class="ansi-blue-fg">(</span>
    fn<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'Path | str | Tensor | ndarray | bytes | Image.Image'</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Return an Image from `fn`
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.10/site-packages/fastai/vision/core.py
<span class="ansi-red-fg">Type:</span>      method</pre>
</div>
</div>
</div>
<p><code>get_image_files</code> will return a list of <code>Path</code>s:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T02:01:11.276931Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T02:01:11.276530Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T02:01:12.145161Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T02:01:12.144020Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T02:01:11.276899Z&quot;}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>get_image_files(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(#10407) [Path('../input/paddy-disease-classification/train_images/tungro/109629.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/104765.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/109706.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/100098.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/102734.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/106433.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/108930.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/102019.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/102416.jpg'),Path('../input/paddy-disease-classification/train_images/tungro/101046.jpg')...]</code></pre>
</div>
</div>
<p>These <code>Path</code>s are passed into <code>PILImage.create</code> to create an image:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T02:08:49.308290Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T02:08:49.307908Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T02:08:50.461319Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T02:08:50.460341Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T02:08:49.308259Z&quot;}" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>PILImage.create(get_image_files(trn_path)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We have now just replicated what is happening in the code with <code>ImageBlock</code> (which also converts the <code>PILImage</code> object into a tensor with <code>IntToFloatTensor</code>).</p>
<p>Jeremy then made sure that the <code>DataBlock</code> approach to create the <code>DataLoaders</code> resulted in a successful training run, making sure to use a very small model and small image size to make it run quickly (as all we’re testing is that it trains it correctly).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T02:24:42.348427Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T02:24:42.347323Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T02:24:47.574632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T02:24:47.573659Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T02:24:42.348389Z&quot;}" data-trusted="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> parent_label,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(trn_path)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T02:24:53.194698Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T02:24:53.194311Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T02:26:03.564783Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T02:26:03.563670Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T02:24:53.194666Z&quot;}" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet18-f37072fd.pth" to /root/.cache/torch/hub/checkpoints/resnet18-f37072fd.pth

100%|██████████| 44.7M/44.7M [00:00&lt;00:00, 52.0MB/s]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.510234</td>
      <td>0.961617</td>
      <td>0.334455</td>
      <td>01:08</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>You want something that works this quickly so that you can test that end-to-end things are working.</p>
<p>Note: fastai will shuffle the training dataset before each epoch to ensure the model is trained on a different order of images each epoch.</p>
<p>Then, Jeremy ran the training run on the same architecture and number of epochs as before to make sure he got the same error rate:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T03:27:29.023158Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T03:27:29.022841Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T03:27:39.012032Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T03:27:39.010882Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T03:27:29.023133Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    get_items <span class="op">=</span> get_image_files,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> parent_label,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(trn_path)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T03:49:17.306692Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T03:49:17.306289Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T04:08:10.956719Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T04:08:10.955814Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T03:49:17.306654Z&quot;}" data-trusted="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, <span class="st">'convnext_small_in22k'</span>, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.064408</td>
      <td>0.718689</td>
      <td>0.213359</td>
      <td>01:10</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.498714</td>
      <td>0.272892</td>
      <td>0.093224</td>
      <td>01:27</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.373369</td>
      <td>0.210002</td>
      <td>0.066314</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.325415</td>
      <td>0.251021</td>
      <td>0.081211</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.272691</td>
      <td>0.230358</td>
      <td>0.067756</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.238369</td>
      <td>0.232206</td>
      <td>0.068236</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.169128</td>
      <td>0.104292</td>
      <td>0.031235</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.132344</td>
      <td>0.132922</td>
      <td>0.036521</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.081303</td>
      <td>0.105022</td>
      <td>0.027871</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.065025</td>
      <td>0.095855</td>
      <td>0.024988</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.050113</td>
      <td>0.093793</td>
      <td>0.023066</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.043371</td>
      <td>0.094051</td>
      <td>0.023066</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.034400</td>
      <td>0.093678</td>
      <td>0.022585</td>
      <td>01:28</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>The final error rate (~0.02) is similar to the original training done using the <code>DataLoaders</code> made from <code>ImageDataLoaders</code>.</p>
</section>
<section id="make-datablock-spit-out-three-things" class="level3">
<h3 class="anchored" data-anchor-id="make-datablock-spit-out-three-things">Make <code>DataBlock</code> Spit Out Three Things</h3>
<p>One image and two categories (disease and variety). To get it to spit out two categories, you add another <code>CategoryBlock</code>.</p>
<p>Given an image id we need a way of getting its <code>variety</code>. Originally Jeremy handled it with “an ugly way” of doing it. Instead create a <code>dict</code> which maps from <code>image_id</code> to <code>variety</code>, and our function will be to just look that up.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:56:15.981538Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:56:15.981124Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:56:16.822802Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:56:16.821892Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:56:15.981506Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>img2variety <span class="op">=</span> { r.image_id: r.variety <span class="cf">for</span> _, r <span class="kw">in</span> df.iterrows() }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:30:12.659656Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:30:12.658740Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:30:12.668547Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:30:12.667599Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:30:12.659613Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">dict</span>(<span class="bu">list</span>(img2variety.items())[<span class="dv">0</span>:<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>{'100330.jpg': 'ADT45',
 '100365.jpg': 'ADT45',
 '100382.jpg': 'ADT45',
 '100632.jpg': 'ADT45',
 '101918.jpg': 'ADT45',
 '102353.jpg': 'ADT45',
 '102848.jpg': 'ADT45',
 '103051.jpg': 'ADT45',
 '103702.jpg': 'ADT45',
 '103920.jpg': 'ADT45'}</code></pre>
</div>
</div>
<p>When you access a <code>dict</code> item, like <code>img2variety['100330.jpg']</code>, behind the scenes it’s making a function call <code>img2variety.__getitem__('100330.jpg')</code></p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:51:13.106662Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:51:13.105704Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:51:13.113251Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:51:13.112140Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:51:13.106617Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>img2variety.<span class="fu">__getitem__</span>(<span class="st">'100330.jpg'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>'ADT45'</code></pre>
</div>
</div>
<p>However, in the <code>DataBlock</code>, <code>get_image_files</code> returns a bunch of <code>Path</code> objects which get passed to the <code>get_y</code> function to get the dependent variables. Since <code>img2variety</code> keys are filename strings, we need to wrap it in a function to handle <code>Path</code> object inputs:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:56:21.743456Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:56:21.743041Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:56:21.752141Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:56:21.750920Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:56:21.743424Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_variety(p): <span class="cf">return</span> img2variety[p.name]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to tell the <code>DataBlock</code> how many of the <code>blocks</code> are independent variables with <code>n_inp</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:51:57.430662Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:51:57.429708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:51:57.441170Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:51:57.440132Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:51:57.430613Z&quot;}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock, CategoryBlock),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [parent_label, get_variety],</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before creating <code>DataLoaders</code>, test with <code>Datasets</code> as they are easier to debug (can access one image at a time instead of a batch).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:51:58.899131Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:51:58.898663Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:52:02.451325Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:52:02.450315Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:51:58.899093Z&quot;}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:53:07.357513Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:53:07.357116Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:53:07.386140Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:53:07.385184Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:53:07.357473Z&quot;}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>img, y1, y2 <span class="op">=</span> dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:53:09.141494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:53:09.141132Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:53:09.272056Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:53:09.271268Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:53:09.141464Z&quot;}" data-trusted="true" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>img</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<p><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:53:56.322754Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:53:56.322334Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:53:56.384316Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:53:56.383068Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:53:56.322721Z&quot;}" data-trusted="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>y1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>TensorCategory(3)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:53:59.530333Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:53:59.529984Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:53:59.537136Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:53:59.536098Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:53:59.530306Z&quot;}" data-trusted="true" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>y2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>TensorCategory(0)</code></pre>
</div>
</div>
<p>Let’s recreate the pipeline of going from filename to these three outputs:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:54:37.877616Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:54:37.876667Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:54:40.282745Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:54:40.281748Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:54:37.877579Z&quot;}" data-trusted="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> get_image_files(trn_path)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:56:44.272952Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:56:44.272584Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:56:44.279330Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:56:44.278147Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:56:44.272923Z&quot;}" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fn, fn.name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(Path('../input/paddy-disease-classification/train_images/tungro/109629.jpg'),
 '109629.jpg')</code></pre>
</div>
</div>
<p>Recreating what the <code>ImageBlock</code> does:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:55:04.892529Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:55:04.891956Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:55:05.012421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:55:05.011525Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:55:04.892496Z&quot;}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>PILImage.create(fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Recreating what <code>get_y</code> does:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-24T06:56:15.229043Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T06:56:15.228653Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T06:56:15.235118Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T06:56:15.234233Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T06:56:15.229012Z&quot;}" data-trusted="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>[parent_label(fn), get_variety(fn)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>['tungro', 'ADT45']</code></pre>
</div>
</div>
<p>Would it make sense to have multiple <code>get_items</code>? No, <code>get_items</code> returns a single thing, but it could be whatever you like (<code>tuple</code>, <code>list</code>, <code>dict</code>, etc.). Then <code>get_y</code> and <code>get_x</code> are responsible for pulling out the bit that you need to pass to your <code>blocks</code>. We don’t need <code>get_x</code> in this case because <code>ImageBlock</code>s just take <code>Path</code>s as inputs directly.</p>
<p>Here is the “hacky” method Jeremy tried originally:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock, CategoryBlock),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    get_x <span class="op">=</span> <span class="kw">lambda</span> x: trn_path<span class="op">/</span>x[<span class="dv">1</span>]<span class="op">/</span>x[<span class="dv">0</span>],</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [ColReader(<span class="dv">1</span>), ColReader(<span class="dv">2</span>)],</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="how-does-transformblock-and-imageblock-work" class="level3">
<h3 class="anchored" data-anchor-id="how-does-transformblock-and-imageblock-work">How does <code>TransformBlock</code> and <code>ImageBlock</code> work</h3>
<p>Now we’ll go into the weeds.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:26:44.952618Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:26:44.952193Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:26:45.039546Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:26:45.038674Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:26:44.952584Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>TransformBlock??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
TransformBlock<span class="ansi-blue-fg">(</span>
    type_tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    item_tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    batch_tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dl_type<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'TfmdDL'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dls_kwargs<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'dict'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> TransformBlock<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"A basic wrapper that links defaults transforms for the data block API"</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        type_tfms<span class="ansi-blue-fg">:</span>list<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># One or more `Transform`s</span>
        item_tfms<span class="ansi-blue-fg">:</span>list<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># `ItemTransform`s, applied on an item</span>
        batch_tfms<span class="ansi-blue-fg">:</span>list<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># `Transform`s or `RandTransform`s, applied by batch</span>
        dl_type<span class="ansi-blue-fg">:</span>TfmdDL<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Task specific `TfmdDL`, defaults to `TfmdDL`</span>
        dls_kwargs<span class="ansi-blue-fg">:</span>dict<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Additional arguments to be passed to `DataLoaders`</span>
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>type_tfms  <span class="ansi-blue-fg">=</span>            L<span class="ansi-blue-fg">(</span>type_tfms<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>item_tfms  <span class="ansi-blue-fg">=</span> ToTensor <span class="ansi-blue-fg">+</span> L<span class="ansi-blue-fg">(</span>item_tfms<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>batch_tfms <span class="ansi-blue-fg">=</span>            L<span class="ansi-blue-fg">(</span>batch_tfms<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>dl_type<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>dls_kwargs <span class="ansi-blue-fg">=</span> dl_type<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">}</span> <span class="ansi-green-fg">if</span> dls_kwargs <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">else</span> dls_kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.10/site-packages/fastai/data/block.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div>
<p>A <code>TransformBlock</code> stores a bunch of things you pass in, like type transforms, item transforms, batch transforms, it always adds <code>ToTensor</code> since PyTorch works with tensors. Remember that an <code>ImageBlock</code> is a <code>TransformBlock</code> where the type transform is specified as <code>PILImage.create</code> and the batch transform is <code>IntToTensor</code>.</p>
<p>If you pass <code>TransformBlock</code> to the <code>DataBlock.blocks</code>, it wont do anything.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:30:35.941418Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:30:35.940444Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:30:35.946754Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:30:35.945659Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:30:35.941380Z&quot;}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:31:11.185875Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:31:11.184670Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:31:20.664022Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:31:20.663053Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:31:11.185831Z&quot;}" data-trusted="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:38:52.974265Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:38:52.973822Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:38:52.986698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:38:52.985689Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:38:52.974232Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>(Path('../input/paddy-disease-classification/train_images/blast/105663.jpg'),)</code></pre>
</div>
</div>
<p>All this does is take the output of <code>get_image_files[0]</code> and turns it into a tuple containing one thing, which is the thing itself. If we have two transform blocks, it returns a tuple with two things in it:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:41:40.551892Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:41:40.551539Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:41:41.469215Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:41:41.468200Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:41:40.551863Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock, TransformBlock),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(Path('../input/paddy-disease-classification/train_images/blast/105663.jpg'),
 Path('../input/paddy-disease-classification/train_images/blast/105663.jpg'))</code></pre>
</div>
</div>
<p>It’s returning tuples because that’s what we want: we want batches of tuples that contain inputs and outputs (potentially multiple inputs and outputs).</p>
<p>We can do stuff to the first thing in the tuple with <code>get_x</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:44:23.509533Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:44:23.508565Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:44:24.405632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:44:24.404610Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:44:23.509495Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock, TransformBlock),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span><span class="kw">lambda</span> o: o.name,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>('105663.jpg',
 Path('../input/paddy-disease-classification/train_images/blast/105663.jpg'))</code></pre>
</div>
</div>
<p><code>o.name</code> for each <code>get_image_files</code> output is the filename. We can do stuff to the second thing in the tuple with <code>get_y</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:53:50.264616Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:53:50.264243Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:53:51.807763Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:53:51.806853Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:53:50.264586Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock, TransformBlock),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span><span class="kw">lambda</span> o: o.name,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span><span class="kw">lambda</span> o: o.parent,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>('105663.jpg',
 Path('../input/paddy-disease-classification/train_images/blast'))</code></pre>
</div>
</div>
<p><code>TransformBlock</code>s don’t do anything but the number of them you have is the number of pipelines it’s going to create. Suppose we had three <code>TransformBlock</code>s assigned to <code>DataBlock.blocks</code>—this will require a total of three functions between <code>get_x</code> and <code>get_y</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:56:42.834005Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:56:42.832979Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:56:44.557108Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:56:44.556122Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:56:42.833960Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock, TransformBlock, TransformBlock),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>[<span class="kw">lambda</span> o: o.name, <span class="kw">lambda</span> o: o.name],</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span><span class="kw">lambda</span> o: o.parent,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>('105663.jpg',
 '105663.jpg',
 Path('../input/paddy-disease-classification/train_images/blast'))</code></pre>
</div>
</div>
<p>By default, the last one in the tuple is the <code>y</code> and the first two are the <code>x</code>, unless we specify <code>n_inp</code> as <code>1</code>, provide 1 function for <code>get_x</code> and then two functions for <code>get_y</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T18:58:43.580471Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T18:58:43.579888Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T18:58:43.726700Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T18:58:43.725661Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T18:58:43.580433Z&quot;}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock, TransformBlock, TransformBlock),</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span><span class="kw">lambda</span> o: o.name,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>[<span class="kw">lambda</span> o: o.parent, <span class="kw">lambda</span> o: o.parent],</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>('105663.jpg',
 Path('../input/paddy-disease-classification/train_images/blast'),
 Path('../input/paddy-disease-classification/train_images/blast'))</code></pre>
</div>
</div>
<p>You can also pass the functions to <code>TransformBlock.type_tfms</code> instead:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T19:01:23.423020Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T19:01:23.422660Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T19:01:24.479350Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T19:01:24.478447Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T19:01:23.422993Z&quot;}" data-trusted="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock(type_tfms<span class="op">=</span>[<span class="kw">lambda</span> o: o.name]), TransformBlock, TransformBlock),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>[<span class="kw">lambda</span> o: o.parent, <span class="kw">lambda</span> o: o.parent],</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>('105663.jpg',
 Path('../input/paddy-disease-classification/train_images/blast'),
 Path('../input/paddy-disease-classification/train_images/blast'))</code></pre>
</div>
</div>
<p>Let’s create an <code>ImageBlock</code> manually:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T19:03:31.510292Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T19:03:31.509901Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T19:03:32.578334Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T19:03:32.577229Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T19:03:31.510256Z&quot;}" data-trusted="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(TransformBlock(type_tfms<span class="op">=</span>PILImage.create, batch_tfms<span class="op">=</span>IntToFloatTensor), TransformBlock, TransformBlock),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>[<span class="kw">lambda</span> o: o.parent, <span class="kw">lambda</span> o: o.parent],</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(PILImage mode=RGB size=480x640,
 Path('../input/paddy-disease-classification/train_images/blast'),
 Path('../input/paddy-disease-classification/train_images/blast'))</code></pre>
</div>
</div>
<p><code>TransformBlock</code>s don’t do anything at all, they only store things. There’s no <code>__call__</code>, there’s no <code>__forward__</code>, etc. The <code>DataBlock</code> is going to go through and say okay for each thing (from <code>get_image_files</code>) call each of the <code>type_tfms</code> and <code>ToTensor</code> and then each of the <code>item_tfms</code> and for batches call each of the <code>batch_tfms</code> of each <code>TransformBlock</code>.</p>
<p><code>get_x</code> and <code>get_y</code> get called first and then <code>type_tfms</code> of <code>TransformBlock</code>s get called on their outputs.</p>
<p>When you call <code>DataBlock.datasets</code> it creates a <code>Datasets</code> object and passes in all of the type, item and batch transforms to it. The item transform gets done by the <code>DataLoaders</code> and not the <code>Datasets</code>.</p>
<p>The only reason there’s a lot of code defining the <code>DataBlock</code> is to make sure that if two different things have the same type transforms, we merge them together in a sensible way. Type transforms are happening before <code>DataLoaders</code> time. <code>DataLoaders</code> are the things that are going to take tensors or at least things that can be converted into tensors. Type transforms are going to create your <code>Datasets</code> for you and spit out things which need to be convertible into tensors. And then <code>DataLoaders</code> has item transforms which are things like <code>Resize</code> and batch transforms which are things like data augmentation.</p>
<p>Item transforms are not going to run on GPU because the items aren’t a batch yet. You need things in a batch before the GPU can be optimized effectively.</p>
<p>There is a callback which sticks things on the GPU. It just depends on whether things done are before or after that callback.</p>
<p>The fastai implementation of <code>DataLoaders</code> is a superset of PyTorch’s implementation.</p>
<p>PyTorch’s <code>Dataset</code> is an abstract class and doesn’t do anything at all. A <code>Dataset</code> is something you can index into and it returns a single tuple with independent and dependent variables. That’s how it’s defined by PyTorch and that’s what fastai does as well.</p>
<p>You can’t index into a <code>DataLoader</code>, you can only iterate through it, you can grab the next one and it gives you a mini-batch which is a tensor.</p>
<p>You need something that converts the output of <code>get_image_files</code> into a <code>Dataset</code> and that’s what <code>type_tfms</code> do.</p>
<p>This is not the only way you could do this, but it’s our way that’s really nice because we now have this thing that you can see the 14th image and its label. If we didn’t have type transforms it would be just one more step in item transforms—your <code>Datasets</code> would return two things (outputs of <code>get_x</code> and <code>get_y</code>) and then the <code>DataLoader</code> would have to do more work which would be a perfectly okay way to do things.</p>
<p>The rule is that you need something that can be turned into a tensor. That’s the way fastai does it. You need to make sure that your type transform returns something that is a tensor or can be turned into a tensor (which a PILImage can be).</p>
</section>
<section id="defining-datablock-for-multi-classification-notebook" class="level3">
<h3 class="anchored" data-anchor-id="defining-datablock-for-multi-classification-notebook">Defining <code>DataBlock</code> for multi-classification notebook</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T19:52:04.059748Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T19:52:04.059345Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T19:52:07.576678Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T19:52:07.575541Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T19:52:04.059714Z&quot;}" data-trusted="true" data-execution_count="30">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, TransformBlock, TransformBlock),</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>[<span class="kw">lambda</span> o: o.parent.name, get_variety],</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(PILImage mode=RGB size=480x640, 'blast', 'ADT45')</code></pre>
</div>
</div>
<p>This breaks our rule because the last two things can’t be turned into a tensor (they are strings). What do we do with that? W replace strings with integers that are a lookup into the vocabulary. If we change the last two <code>TransformBlock</code>s into <code>CategoryBlock</code>s, that is exactly what <code>CategoryBlock</code> will do.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T20:08:34.716482Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T20:08:34.716059Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T20:08:39.136690Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T20:08:39.135563Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T20:08:34.716451Z&quot;}" data-trusted="true" data-execution_count="31">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock, CategoryBlock),</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>[<span class="kw">lambda</span> o: o.parent.name, get_variety],</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>dss <span class="op">=</span> dblock.datasets(trn_path)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>dss.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>(PILImage mode=RGB size=480x640, TensorCategory(3), TensorCategory(0))</code></pre>
</div>
</div>
<p><code>CategoryBlock</code> has a type transform called <code>Categorize</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T20:08:56.684356Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T20:08:56.683632Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T20:08:56.694741Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T20:08:56.693916Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T20:08:56.684323Z&quot;}" data-trusted="true" data-execution_count="32">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>CategoryBlock??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">

<pre><span class="ansi-red-fg">Signature:</span>
CategoryBlock<span class="ansi-blue-fg">(</span>
    vocab<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'MutableSequence | pd.Series'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    sort<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    add_na<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> CategoryBlock<span class="ansi-blue-fg">(</span>
    vocab<span class="ansi-blue-fg">:</span>MutableSequence<span class="ansi-blue-fg">|</span>pd<span class="ansi-blue-fg">.</span>Series<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># List of unique class names</span>
    sort<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Sort the classes alphabetically</span>
    add_na<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Add `#na#` to `vocab`</span>
<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"`TransformBlock` for single-label categorical targets"</span>
    <span class="ansi-green-fg">return</span> TransformBlock<span class="ansi-blue-fg">(</span>type_tfms<span class="ansi-blue-fg">=</span>Categorize<span class="ansi-blue-fg">(</span>vocab<span class="ansi-blue-fg">=</span>vocab<span class="ansi-blue-fg">,</span> sort<span class="ansi-blue-fg">=</span>sort<span class="ansi-blue-fg">,</span> add_na<span class="ansi-blue-fg">=</span>add_na<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.10/site-packages/fastai/data/block.py
<span class="ansi-red-fg">Type:</span>      function</pre>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T20:10:39.491142Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T20:10:39.490226Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T20:10:39.497381Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T20:10:39.496348Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T20:10:39.491108Z&quot;}" data-trusted="true" data-execution_count="34">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dss.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(#2) [['bacterial_leaf_blight', 'bacterial_leaf_streak', 'bacterial_panicle_blight', 'blast', 'brown_spot', 'dead_heart', 'downy_mildew', 'hispa', 'normal', 'tungro'],['ADT45', 'AndraPonni', 'AtchayaPonni', 'IR20', 'KarnatakaPonni', 'Onthanel', 'Ponni', 'RR', 'Surya', 'Zonal']]</code></pre>
</div>
</div>
<p>To summarize: <code>get_items</code> gets us the rows or the examples, then we use <code>get_y</code> or <code>get_x</code> to transform it somehow so that we can pass it into the <code>type_tfms</code> of those <code>blocks</code>. The <code>blocks</code> are very general things, so Jeremy didn’t want us to have to write our own every time—<code>ImageBlock</code> will work if you pass it an image path, <code>CategoryBlock</code> will work if you pass it a string. So <code>get_x</code> and <code>get_y</code> then are responsible for ensuring that you pass <code>ImageBlock</code> a <code>Path</code> and <code>CategoryBlock</code> a string. Note that <code>get_image_files</code> is already returning a path so we don’t need a <code>get_x</code>, but it’s not returning strings so we do need a <code>get_y</code>.</p>
<p>Let’s return to the full <code>DataBlock</code> for multi-classification. Some other time Jeremy will talk about how <code>item_tfms</code> are not applies to the categories but only to the images. The secret is using fastcore’s type dispatch functionality. If we had an image for the <code>y</code>, the <code>item_tfms</code> would apply (see the siamese tutorial on the fastai docs, because that has two images). If you think about it, anytime we do segmentation, that’s what’s happening—data augmentation is happening to x and y. This is really unusual, Jeremy doesn’t know if any other libraries that have this kind of totally transparent ability to do bounding boxes, segmentation, point clouds, whatever as dependent variables and have it all happen in unison very automatically (or at least there didn’t use to be—maybe there is now).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:56:33.770494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:56:33.770073Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:56:33.782553Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:56:33.781533Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:56:33.770459Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock, CategoryBlock),</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [parent_label, get_variety],</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:56:36.039541Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:56:36.038525Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:56:43.989503Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:56:43.988454Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:56:36.039496Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>fastai does a lot of things automatically because of type dispatch.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:56:48.278365Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:56:48.277886Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:56:50.785521Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:56:50.784344Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:56:48.278329Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-46-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>All the stuff we did last time about messing around with multiple different heads and all that is actually totally unecessary. All we need to do when we create our <code>vision_learner</code> is tell it we don’t want 10 outputs but we want 20 outputs.</p>
<p>Then you need to tell it what loss function to use:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:57:35.265565Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:57:35.265132Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:57:35.273881Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:57:35.272705Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:57:35.265530Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>orig_lf <span class="op">=</span> CrossEntropyLossFlat()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_err(inp, disease, variety): <span class="cf">return</span> error_rate(inp[:,:<span class="dv">10</span>], disease)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> variety_err(inp, disease, variety): <span class="cf">return</span> error_rate(inp[:,<span class="dv">10</span>:], variety)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_loss(inp, disease, variety): <span class="cf">return</span> orig_lf(inp[:,:<span class="dv">10</span>], disease)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> variety_loss(inp, disease, variety): <span class="cf">return</span> orig_lf(inp[:,<span class="dv">10</span>:], variety)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loss(pred, disease, variety): <span class="cf">return</span> orig_lf(pred[:,:<span class="dv">10</span>], disease)<span class="op">+</span>orig_lf(pred[:,<span class="dv">10</span>:],variety)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:57:36.769906Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:57:36.769553Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:57:36.774927Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:57:36.773627Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:57:36.769875Z&quot;}" data-trusted="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>err_metrics <span class="op">=</span> (disease_err, variety_err)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="op">=</span> err_metrics<span class="op">+</span>(disease_loss, variety_loss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:57:41.004776Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:57:41.003970Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:57:41.009066Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:57:41.008026Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:57:41.004742Z&quot;}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'convnext_small_in22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:57:42.027823Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:57:42.026788Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T21:57:50.553903Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T21:57:50.552955Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:57:42.027779Z&quot;}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, loss_func<span class="op">=</span>loss, metrics<span class="op">=</span>all_metrics, n_out<span class="op">=</span><span class="dv">20</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_small_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_small_22k_224.pth</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-26T21:57:53.430774Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-26T21:57:53.429965Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-26T22:17:58.022951Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-26T22:17:58.021881Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-26T21:57:53.430741Z&quot;}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">0.01</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.029203</td>
      <td>1.043733</td>
      <td>0.209515</td>
      <td>0.130226</td>
      <td>0.610881</td>
      <td>0.432852</td>
      <td>01:24</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.859452</td>
      <td>0.475814</td>
      <td>0.102355</td>
      <td>0.057665</td>
      <td>0.314314</td>
      <td>0.161500</td>
      <td>01:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.581024</td>
      <td>0.325289</td>
      <td>0.077847</td>
      <td>0.029313</td>
      <td>0.224519</td>
      <td>0.100770</td>
      <td>01:37</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.540563</td>
      <td>0.316766</td>
      <td>0.068717</td>
      <td>0.036040</td>
      <td>0.212697</td>
      <td>0.104069</td>
      <td>01:38</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.452651</td>
      <td>0.236399</td>
      <td>0.060548</td>
      <td>0.016338</td>
      <td>0.188092</td>
      <td>0.048306</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.336122</td>
      <td>0.212508</td>
      <td>0.044210</td>
      <td>0.014416</td>
      <td>0.167000</td>
      <td>0.045508</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.237758</td>
      <td>0.175937</td>
      <td>0.040365</td>
      <td>0.011533</td>
      <td>0.137471</td>
      <td>0.038466</td>
      <td>01:31</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.188718</td>
      <td>0.135600</td>
      <td>0.023546</td>
      <td>0.008169</td>
      <td>0.099861</td>
      <td>0.035739</td>
      <td>01:31</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.144555</td>
      <td>0.124381</td>
      <td>0.021144</td>
      <td>0.008650</td>
      <td>0.089832</td>
      <td>0.034549</td>
      <td>01:31</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.118053</td>
      <td>0.110137</td>
      <td>0.021624</td>
      <td>0.006728</td>
      <td>0.081897</td>
      <td>0.028240</td>
      <td>01:31</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.085133</td>
      <td>0.105757</td>
      <td>0.021144</td>
      <td>0.005766</td>
      <td>0.080176</td>
      <td>0.025581</td>
      <td>01:31</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.063399</td>
      <td>0.100818</td>
      <td>0.022105</td>
      <td>0.004805</td>
      <td>0.075001</td>
      <td>0.025817</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.060191</td>
      <td>0.098222</td>
      <td>0.020183</td>
      <td>0.006247</td>
      <td>0.073829</td>
      <td>0.024393</td>
      <td>01:31</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>The final error rate for disease classification (~0.02) is similar to what I got with single-classification.</p>
<p>The fastai inference functions have options to decode the predictions, or to use the activation function. But since Jeremy defined a new loss function, you would need to add a softmax to the 20 outputs. You actually don’t need to because for the Kaggle competition, we just needed which disease had the highest prediction, and whether it’s softmax or not, it’s going to be the same because that’s a monotonic function. So it depends whether you actually needs probabilities or not.</p>
<p>But you only want to be looking at the first 10 for disease predictions:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>avg_pr <span class="op">=</span> t_tta.mean(<span class="dv">0</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>avg_pr[:,:<span class="dv">10</span>].shape</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> avg_pr[:,:<span class="dv">10</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All the resnets and convnexts handle any input image size, it’s only the transformer models that don’t.</p>
<p>In my <a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-7/">next blog post</a> I work on improving my large ensemble predictions based on how Jeremy created his large ensemble.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>