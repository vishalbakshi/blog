<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-02-05">
<meta name="description" content="In this notebook I apply to my large ensemble Jeremy Howard’s approach in the “Scaling Up - Road to the Top, Part 3” notebook.">

<title>Paddy Doctor Kaggle Competition - Part 8 – Vishal Bakshi’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9c1ae87ad5063dce4f793ccd314a7566.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#comparing-jeremys-approach-to-mine" id="toc-comparing-jeremys-approach-to-mine" class="nav-link" data-scroll-target="#comparing-jeremys-approach-to-mine">Comparing Jeremy’s Approach to Mine</a></li>
  <li><a href="#replicating-jeremys-approach" id="toc-replicating-jeremys-approach" class="nav-link" data-scroll-target="#replicating-jeremys-approach">Replicating Jeremy’s Approach</a></li>
  <li><a href="#using-jeremys-approach-for-my-ensemble" id="toc-using-jeremys-approach-for-my-ensemble" class="nav-link" data-scroll-target="#using-jeremys-approach-for-my-ensemble">Using Jeremy’s Approach for My Ensemble</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Paddy Doctor Kaggle Competition - Part 8</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I apply to my large ensemble Jeremy Howard’s approach in the “Scaling Up - Road to the Top, Part 3” notebook.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the fastai course Part 1 <a href="https://youtu.be/AdhG64NF76E?feature=shared&amp;t=3117">Lesson 6 video</a> Jeremy Howard walked through the notebooks <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2">Small models: Road to the Top, Part 2</a> where he builds increasingly accurate solutions to the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> Kaggle Competition. In the video, Jeremy referenced a series of walkthrough videos that he made while working through the four-notebook series for this competition. I’m excited to watch these walkthroughs to better understand how to approach a Kaggle competition from the perspective of a former #1 Kaggle grandmaster.</p>
<p>In this blog post series, I’ll walk through the code Jeremy shared in each of the 6 Live Coding videos focused on this competition, submitting predictions to Kaggle along the way. My last two blog posts in this series reference Jeremy’s <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a> notebook to improve my large model ensemble predictions. Here are the links to each of the blog posts in this series:</p>
<ul>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-1/">Part 1: Live Coding 8</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-2/">Part 2: Live Coding 9</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">Part 3: Live Coding 10</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-4/">Part 4: Live Coding 11</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-5/">Part 5: Live Coding 12</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-6/">Part 6: Live Coding 13</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-7/">Part 7: Improving My Large Ensemble, Part 1</a></li>
<li>Part 8: Improving My Large Ensemble, Part 2 (You are here)</li>
</ul>
</section>
<section id="comparing-jeremys-approach-to-mine" class="level2">
<h2 class="anchored" data-anchor-id="comparing-jeremys-approach-to-mine">Comparing Jeremy’s Approach to Mine</h2>
<p>Obviously, “my” last approach is largely taken from Jeremy’s own live coding videos, but there are a few differences between our ensemble training:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Item</th>
<th style="text-align: center;">Jeremy</th>
<th style="text-align: center;">Vishal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Learning Rate</td>
<td style="text-align: center;">0.01 for all architectures</td>
<td style="text-align: center;">0.005 or 0.015 depending on the architecture</td>
</tr>
<tr class="even">
<td style="text-align: center;"># Epochs</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">24</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Architectures</td>
<td style="text-align: center;">convnext_large_in22k<br>vit_large_patch16_224<br>swinv2_large_window12_192_22k<br>swin_large_patch4_window7_224</td>
<td style="text-align: center;">convnext_large_in22k<br>vit_large_patch16_224<br>swinv2_large_window12_192_22k</td>
</tr>
<tr class="even">
<td style="text-align: center;">Gradient Accumulation</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">Yes</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Batch Size</td>
<td style="text-align: center;">32</td>
<td style="text-align: center;">16</td>
</tr>
<tr class="even">
<td style="text-align: center;">Private score</td>
<td style="text-align: center;">0.98732</td>
<td style="text-align: center;">0.98617</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Public score</td>
<td style="text-align: center;">0.98846</td>
<td style="text-align: center;">0.98654</td>
</tr>
</tbody>
</table>
<p>Jeremy’s approach resulted in a Private score with an ~10% smaller error rate. In terms of rankings, Jeremy’s Private score ranks #8, while mine is tied from #27 to #58 on the leaderboard.</p>
</section>
<section id="replicating-jeremys-approach" class="level2">
<h2 class="anchored" data-anchor-id="replicating-jeremys-approach">Replicating Jeremy’s Approach</h2>
<p>I’ll first replicate Jeremy’s approach, including architectures, learning rates, # of epochs, <code>set_seed(42)</code>, and <code>train</code> function to see if I get the same score. I would expect to do so. Once that’s confirmed, I will use his approach for the three architectures I chose and re-submit the predictions to see how that scores. If there’s still a difference, I can attribute it to Jeremy including the swin_large_patch4_window7_224 architecture (and multiple transforms for some of the models) in his ensemble.</p>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:16:08.367291Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:16:08.366826Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:16:20.285767Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:16:20.284807Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:16:08.367196Z&quot;}}" data-outputid="cb3512af-e410-420a-8c14-ea4d49943a5f" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq timm<span class="op">==</span><span class="fl">0.6.13</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install kaggle <span class="op">-</span>qq</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>timm.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>'0.6.13'</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:16:36.285309Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:16:36.284419Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:16:39.367314Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:16:39.366073Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:16:36.285277Z&quot;}}" data-outputid="8c502194-7088-46de-ca6e-7759bfdd9b27" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>cred_path <span class="op">=</span> Path(<span class="st">"~/.kaggle/kaggle.json"</span>).expanduser()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> cred_path.exists():</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  cred_path.parent.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  cred_path.write_text(creds)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  cred_path.chmod(<span class="bn">0o600</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile,kaggle</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'paddy-disease-classification'</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> path.exists():</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  kaggle.api.competition_download_cli(<span class="bu">str</span>(path))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  zipfile.ZipFile(<span class="ss">f'</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">.zip'</span>).extractall(path)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:16:45.528516Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:16:45.528003Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:16:45.533704Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:16:45.532642Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:16:45.528490Z&quot;}}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:16:47.162422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:16:47.161338Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:16:47.257060Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:16:47.255951Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:16:47.162380Z&quot;}}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>).<span class="bu">sorted</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T18:53:48.216191Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T18:53:48.215737Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T18:53:48.220759Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T18:53:48.219851Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T18:53:48.216155Z&quot;}}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="dv">640</span>,<span class="dv">480</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T09:27:07.168859Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T09:27:07.167451Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T09:27:07.173917Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T09:27:07.173229Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T09:27:07.168807Z&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'convnext_large_in22k'</span>: {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        (Resize(res), (<span class="dv">320</span>,<span class="dv">224</span>)),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    }, <span class="st">'vit_large_patch16_224'</span>: {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        (Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>), <span class="dv">224</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        (Resize(res), <span class="dv">224</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    }, <span class="st">'swinv2_large_window12_192_22k'</span>: {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        (Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>), <span class="dv">192</span>),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        (Resize(res), <span class="dv">192</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    }, <span class="st">'swin_large_patch4_window7_224'</span>: {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        (Resize(res), <span class="dv">224</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-13" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T18:53:50.443029Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T18:53:50.442350Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T18:53:50.448728Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T18:53:50.447862Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T18:53:50.442998Z&quot;}}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(arch, size, item<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>), accum<span class="op">=</span><span class="dv">1</span>, finetune<span class="op">=</span><span class="va">True</span>, epochs<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>item,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span>size, min_scale<span class="op">=</span><span class="fl">0.75</span>), bs<span class="op">=</span><span class="dv">64</span><span class="op">//</span>accum)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    cbs <span class="op">=</span> GradientAccumulation(<span class="dv">64</span>) <span class="cf">if</span> accum <span class="cf">else</span> []</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> finetune:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        learn.fine_tune(epochs, <span class="fl">0.01</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> learn.tta(dl<span class="op">=</span>dls.test_dl(tst_files))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        learn.unfreeze()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        learn.fit_one_cycle(epochs, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T09:27:59.964387Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T09:27:59.963504Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T12:41:23.398651Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T12:41:23.396318Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T09:27:59.964336Z&quot;}}" data-outputid="41d83393-6bd9-4017-a4ac-d2c04e105d42" data-execution_count="14">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> []</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> arch,details <span class="kw">in</span> models.items():</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item,size <span class="kw">in</span> details:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'---'</span>,arch)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(size)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(item.name)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        tta_res.append(train(arch, size, item<span class="op">=</span>item, accum<span class="op">=</span><span class="dv">2</span>)) <span class="co">#, epochs=1))</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        torch.cuda.empty_cache()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- convnext_large_in22k
(320, 224)
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_large_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_large_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.887948</td>
<td>0.558075</td>
<td>0.171072</td>
<td>01:50</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.355805</td>
<td>0.198265</td>
<td>0.062951</td>
<td>02:19</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.294646</td>
<td>0.232236</td>
<td>0.064392</td>
<td>02:19</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.279926</td>
<td>0.246197</td>
<td>0.068236</td>
<td>02:18</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.255699</td>
<td>0.214052</td>
<td>0.054781</td>
<td>02:18</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.185353</td>
<td>0.169206</td>
<td>0.050937</td>
<td>02:18</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.186070</td>
<td>0.143183</td>
<td>0.035560</td>
<td>02:18</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.085736</td>
<td>0.121303</td>
<td>0.030754</td>
<td>02:18</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.057243</td>
<td>0.090094</td>
<td>0.023546</td>
<td>02:18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.055047</td>
<td>0.102438</td>
<td>0.024027</td>
<td>02:17</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.037102</td>
<td>0.081514</td>
<td>0.017780</td>
<td>02:18</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.031336</td>
<td>0.076584</td>
<td>0.019222</td>
<td>02:18</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.026582</td>
<td>0.077788</td>
<td>0.020183</td>
<td>02:17</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- vit_large_patch16_224
224
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.025479</td>
<td>0.599246</td>
<td>0.190293</td>
<td>01:56</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.372387</td>
<td>0.254584</td>
<td>0.078808</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.363945</td>
<td>0.267997</td>
<td>0.084575</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.337558</td>
<td>0.416980</td>
<td>0.118693</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.305778</td>
<td>0.237352</td>
<td>0.068717</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.205868</td>
<td>0.220364</td>
<td>0.052859</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.155062</td>
<td>0.132949</td>
<td>0.037001</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.131659</td>
<td>0.115785</td>
<td>0.029793</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.084275</td>
<td>0.113429</td>
<td>0.028352</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.054473</td>
<td>0.126284</td>
<td>0.028352</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.040826</td>
<td>0.095426</td>
<td>0.023066</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.030117</td>
<td>0.101836</td>
<td>0.022105</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.032172</td>
<td>0.097483</td>
<td>0.021624</td>
<td>02:26</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- vit_large_patch16_224
224
Resize -- {'size': (480, 480), 'method': 'squish', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.977947</td>
<td>0.495749</td>
<td>0.167227</td>
<td>01:53</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.445487</td>
<td>0.227239</td>
<td>0.076886</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.310319</td>
<td>0.217010</td>
<td>0.065353</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.346164</td>
<td>0.222110</td>
<td>0.071120</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.316973</td>
<td>0.220043</td>
<td>0.066314</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.201981</td>
<td>0.209637</td>
<td>0.057184</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.130500</td>
<td>0.139665</td>
<td>0.036521</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.142111</td>
<td>0.127187</td>
<td>0.030754</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.071605</td>
<td>0.089311</td>
<td>0.022105</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.048045</td>
<td>0.083216</td>
<td>0.020183</td>
<td>02:23</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.046874</td>
<td>0.084979</td>
<td>0.018260</td>
<td>02:23</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.024261</td>
<td>0.086005</td>
<td>0.019702</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.021223</td>
<td>0.083154</td>
<td>0.016819</td>
<td>02:23</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- swinv2_large_window12_192_22k
192
Resize -- {'size': (480, 480), 'method': 'squish', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.9/dist-packages/torch/functional.py:478: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2894.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
Downloading: "https://github.com/SwinTransformer/storage/releases/download/v2.0.0/swinv2_large_patch4_window12_192_22k.pth" to /root/.cache/torch/hub/checkpoints/swinv2_large_patch4_window12_192_22k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.929301</td>
<td>0.633476</td>
<td>0.173955</td>
<td>02:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.397221</td>
<td>0.207330</td>
<td>0.060548</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.349008</td>
<td>0.227384</td>
<td>0.068236</td>
<td>02:27</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.321012</td>
<td>0.355698</td>
<td>0.104277</td>
<td>02:27</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.280713</td>
<td>0.199645</td>
<td>0.058145</td>
<td>02:27</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.228984</td>
<td>0.219441</td>
<td>0.061028</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.154743</td>
<td>0.159890</td>
<td>0.039885</td>
<td>02:28</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.133811</td>
<td>0.156821</td>
<td>0.040365</td>
<td>02:27</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.082750</td>
<td>0.137658</td>
<td>0.032196</td>
<td>02:27</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.069910</td>
<td>0.132426</td>
<td>0.029793</td>
<td>02:27</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.052760</td>
<td>0.111611</td>
<td>0.022585</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.039415</td>
<td>0.115199</td>
<td>0.022585</td>
<td>02:27</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.027980</td>
<td>0.115816</td>
<td>0.023066</td>
<td>02:26</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- swinv2_large_window12_192_22k
192
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.937894</td>
<td>0.522241</td>
<td>0.169630</td>
<td>02:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.460170</td>
<td>0.213483</td>
<td>0.073042</td>
<td>02:29</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.352201</td>
<td>0.178675</td>
<td>0.054301</td>
<td>02:29</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.386350</td>
<td>0.334553</td>
<td>0.097549</td>
<td>02:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.299634</td>
<td>0.164248</td>
<td>0.046612</td>
<td>02:29</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.228867</td>
<td>0.126158</td>
<td>0.035079</td>
<td>02:29</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.178476</td>
<td>0.138584</td>
<td>0.042768</td>
<td>02:29</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.154566</td>
<td>0.148524</td>
<td>0.039885</td>
<td>02:28</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.094369</td>
<td>0.078149</td>
<td>0.020663</td>
<td>02:29</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.066650</td>
<td>0.069993</td>
<td>0.019222</td>
<td>02:29</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.049904</td>
<td>0.061477</td>
<td>0.017299</td>
<td>02:29</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.037704</td>
<td>0.060764</td>
<td>0.016338</td>
<td>02:29</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.033226</td>
<td>0.061885</td>
<td>0.015858</td>
<td>02:29</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- swin_large_patch4_window7_224
224
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_large_patch4_window7_224_22kto1k.pth" to /root/.cache/torch/hub/checkpoints/swin_large_patch4_window7_224_22kto1k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.930659</td>
<td>0.492810</td>
<td>0.154253</td>
<td>01:41</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.422924</td>
<td>0.213063</td>
<td>0.072561</td>
<td>02:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.369444</td>
<td>0.222754</td>
<td>0.066795</td>
<td>02:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.338899</td>
<td>0.212781</td>
<td>0.057665</td>
<td>02:03</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.308362</td>
<td>0.159222</td>
<td>0.046612</td>
<td>02:03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.214941</td>
<td>0.142208</td>
<td>0.037001</td>
<td>02:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.155058</td>
<td>0.139699</td>
<td>0.032196</td>
<td>02:02</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.161482</td>
<td>0.116061</td>
<td>0.030754</td>
<td>02:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.098805</td>
<td>0.080427</td>
<td>0.022105</td>
<td>02:03</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.071636</td>
<td>0.073006</td>
<td>0.020183</td>
<td>02:02</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.056668</td>
<td>0.073751</td>
<td>0.018260</td>
<td>02:02</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.044765</td>
<td>0.064573</td>
<td>0.015858</td>
<td>02:02</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.040009</td>
<td>0.063520</td>
<td>0.015858</td>
<td>02:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-15" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:05:14.192241Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:05:14.191402Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:05:14.201769Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:05:14.200910Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:05:14.192207Z&quot;}}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save_pickle('tta_res.pkl', tta_res)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> load_pickle(<span class="st">"tta_res.pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:05:46.611419Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:05:46.610922Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:05:46.618558Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:05:46.617304Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:05:46.611384Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tta_res)):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">len</span>(tta_res[i][<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3469
3469
3469
3469
3469
3469</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:06:50.538843Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:06:50.538331Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:06:50.545216Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:06:50.543805Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:06:50.538800Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tta_prs <span class="op">=</span> first(<span class="bu">zip</span>(<span class="op">*</span>tta_res))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:06:53.032212Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:06:53.031184Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:06:53.036431Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:06:53.035480Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:06:53.032160Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># double weight the vit predictions</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>tta_prs <span class="op">+=</span> tta_prs[<span class="dv">1</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:06:54.864242Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:06:54.863839Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:06:54.919668Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:06:54.918713Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:06:54.864215Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>avg_pr <span class="op">=</span> torch.stack(tta_prs).mean(<span class="dv">0</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>avg_pr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>torch.Size([3469, 10])</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:06:57.398828Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:06:57.397868Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:07:05.480116Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:07:05.479199Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:06:57.398783Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:07:07.967193Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:07:07.966164Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:07:08.047979Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:07:08.046657Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:07:07.967143Z&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> avg_pr.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(dls.vocab)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> vocab[idxs]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T17:09:52.143529Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T17:09:52.142408Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T17:09:53.137680Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T17:09:53.136721Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T17:09:52.143493Z&quot;}}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>This submission resulted in the following Kaggle score:</p>
<ul>
<li>Private score: 0.98617</li>
<li>Public score: 0.98923 (new best)</li>
</ul>
<p>My Public score error rate decreased by 20%, but my Private score did not budge.</p>
</section>
<section id="using-jeremys-approach-for-my-ensemble" class="level2">
<h2 class="anchored" data-anchor-id="using-jeremys-approach-for-my-ensemble">Using Jeremy’s Approach for My Ensemble</h2>
<p>Now that I have successfully recreated Jeremy’s submission (in the sense that the models ran without error and the submission gave a reasonable score in Kaggle), I’ll now apply the same hyperparameters and functions he used for his architectures and transforms to the ones I chose for my large ensemble. The goal is to see if using his code results in a better score than when I used my code.</p>
<div id="cell-26" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T18:54:01.582412Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T18:54:01.581706Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T18:54:01.587225Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T18:54:01.586223Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T18:54:01.582383Z&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'convnext_large_in22k'</span>: {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        (Resize(res), (<span class="dv">288</span>,<span class="dv">224</span>)),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    }, <span class="st">'vit_large_patch16_224'</span>: {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        (Resize(<span class="dv">480</span>), <span class="dv">224</span>),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    }, <span class="st">'swinv2_large_window12_192_22k'</span>: {</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        (Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>), <span class="dv">192</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-02T18:54:03.670331Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-02T18:54:03.669993Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-02T20:29:24.233655Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-02T20:29:24.232535Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-02T18:54:03.670292Z&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> []</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> arch,details <span class="kw">in</span> models.items():</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item,size <span class="kw">in</span> details:</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'---'</span>,arch)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(size)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(item.name)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        tta_res.append(train(arch, size, item<span class="op">=</span>item, accum<span class="op">=</span><span class="dv">2</span>)) <span class="co">#, epochs=1))</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        torch.cuda.empty_cache()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- convnext_large_in22k
(288, 224)
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.856573</td>
<td>0.475021</td>
<td>0.147525</td>
<td>01:39</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.383883</td>
<td>0.193702</td>
<td>0.055262</td>
<td>02:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.291577</td>
<td>0.189317</td>
<td>0.055262</td>
<td>02:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.265584</td>
<td>0.190596</td>
<td>0.051898</td>
<td>02:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.260673</td>
<td>0.216098</td>
<td>0.059106</td>
<td>02:07</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.188353</td>
<td>0.159554</td>
<td>0.047093</td>
<td>02:06</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.159173</td>
<td>0.157409</td>
<td>0.039404</td>
<td>02:07</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.100692</td>
<td>0.130478</td>
<td>0.029793</td>
<td>02:06</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.060365</td>
<td>0.107081</td>
<td>0.025469</td>
<td>02:07</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.050812</td>
<td>0.080841</td>
<td>0.023066</td>
<td>02:07</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.035694</td>
<td>0.084650</td>
<td>0.022105</td>
<td>02:07</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.032912</td>
<td>0.075940</td>
<td>0.016819</td>
<td>02:06</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.024196</td>
<td>0.081224</td>
<td>0.018741</td>
<td>02:07</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- vit_large_patch16_224
224
Resize -- {'size': (480, 480), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.040115</td>
<td>0.719582</td>
<td>0.226814</td>
<td>01:53</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.390209</td>
<td>0.215410</td>
<td>0.070159</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.400067</td>
<td>0.283184</td>
<td>0.092744</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.341151</td>
<td>0.359277</td>
<td>0.098030</td>
<td>02:25</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.357469</td>
<td>0.291627</td>
<td>0.096588</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.237050</td>
<td>0.233321</td>
<td>0.064873</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.162601</td>
<td>0.153232</td>
<td>0.039885</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.116374</td>
<td>0.129873</td>
<td>0.034599</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.097705</td>
<td>0.106423</td>
<td>0.024507</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.062052</td>
<td>0.120935</td>
<td>0.026430</td>
<td>02:24</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.044538</td>
<td>0.098947</td>
<td>0.023066</td>
<td>02:24</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.029300</td>
<td>0.100037</td>
<td>0.020663</td>
<td>02:23</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.026877</td>
<td>0.097046</td>
<td>0.020663</td>
<td>02:24</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>--- swinv2_large_window12_192_22k
192
Resize -- {'size': (480, 480), 'method': 'squish', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.9/dist-packages/torch/functional.py:478: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2894.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
Downloading: "https://github.com/SwinTransformer/storage/releases/download/v2.0.0/swinv2_large_patch4_window12_192_22k.pth" to /root/.cache/torch/hub/checkpoints/swinv2_large_patch4_window12_192_22k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.900081</td>
<td>0.538801</td>
<td>0.184527</td>
<td>02:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.462490</td>
<td>0.211737</td>
<td>0.063912</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.331918</td>
<td>0.281848</td>
<td>0.090822</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.376580</td>
<td>0.291321</td>
<td>0.093705</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.255427</td>
<td>0.163525</td>
<td>0.045651</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.237116</td>
<td>0.193330</td>
<td>0.056223</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.153437</td>
<td>0.123250</td>
<td>0.040365</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.115951</td>
<td>0.133760</td>
<td>0.034118</td>
<td>02:25</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.080223</td>
<td>0.078580</td>
<td>0.023066</td>
<td>02:25</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.060698</td>
<td>0.083489</td>
<td>0.020663</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.056002</td>
<td>0.078566</td>
<td>0.018260</td>
<td>02:26</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.035586</td>
<td>0.075723</td>
<td>0.017299</td>
<td>02:26</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.033601</td>
<td>0.074444</td>
<td>0.016819</td>
<td>02:26</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-28" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:20:15.576877Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:20:15.575855Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:20:15.584511Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:20:15.583714Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:20:15.576836Z&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">1</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">2</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(3, 3469, 3469, 3469)</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:20:14.484240Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:20:14.483250Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:20:14.491086Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:20:14.489934Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:20:14.484202Z&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save_pickle('tta_res2.pkl', tta_res)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> load_pickle(<span class="st">'tta_res2.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll do three more Kaggle submissions:</p>
<ul>
<li>All three model predictions weighted equally.</li>
<li>convnext model weighted more (because it had the lowest final training epoch validation error rate)</li>
<li>vit model weighted more (because the smaller version previously had the best TTA error rate, and it’s also the one Jeremy weighted more)</li>
</ul>
<div id="cell-31" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:20:48.534064Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:20:48.533136Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:20:48.540156Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:20:48.539439Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:20:48.534036Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>tta_prs <span class="op">=</span> first(<span class="bu">zip</span>(<span class="op">*</span>tta_res))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>avg_pr <span class="op">=</span> torch.stack(tta_prs).mean(<span class="dv">0</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>avg_pr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>torch.Size([3469, 10])</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:20:51.797609Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:20:51.796598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:20:57.911898Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:20:57.910968Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:20:51.797558Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> avg_pr.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(dls.vocab)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> vocab[idxs]</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:21:03.914608Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:21:03.914206Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:21:04.483724Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:21:04.482301Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:21:03.914527Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:25:22.659924Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:25:22.659517Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:25:22.665457Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:25:22.663858Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:25:22.659873Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># weigh the convnext preds more</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">+=</span> <span class="dv">2</span> <span class="op">*</span> [tta_res[<span class="dv">0</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:25:28.645935Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:25:28.645495Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:25:28.650976Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:25:28.650111Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:25:28.645908Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tta_res)):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">len</span>(tta_res[i][<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3469
3469
3469
3469
3469</code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:25:52.109369Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:25:52.109019Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:25:52.846298Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:25:52.845322Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:25:52.109341Z&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>tta_prs <span class="op">=</span> first(<span class="bu">zip</span>(<span class="op">*</span>tta_res))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>avg_pr <span class="op">=</span> torch.stack(tta_prs).mean(<span class="dv">0</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> avg_pr.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(dls.vocab)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> vocab[idxs]</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-37" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:26:02.072587Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:26:02.072153Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:26:02.604059Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:26:02.602771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:26:02.072559Z&quot;}}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:28:22.142903Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:28:22.141912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:28:22.150421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:28:22.149392Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:28:22.142860Z&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># weigh the vit preds more</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> load_pickle(<span class="st">'tta_res2.pkl'</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">+=</span> <span class="dv">2</span> <span class="op">*</span> [tta_res[<span class="dv">1</span>]]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tta_res)):</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">len</span>(tta_res[i][<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3469
3469
3469
3469
3469</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-02-03T00:28:49.901022Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-02-03T00:28:49.900703Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-02-03T00:28:51.201751Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-02-03T00:28:51.200036Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-02-03T00:28:49.900996Z&quot;}}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>tta_prs <span class="op">=</span> first(<span class="bu">zip</span>(<span class="op">*</span>tta_res))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>avg_pr <span class="op">=</span> torch.stack(tta_prs).mean(<span class="dv">0</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> avg_pr.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(dls.vocab)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> vocab[idxs]</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>Here are the Kaggle scores for those three submissions:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Private score</th>
<th style="text-align: center;">Public score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">All three model predictions weighted equally</td>
<td style="text-align: center;">0.98617</td>
<td style="text-align: center;">0.98769</td>
</tr>
<tr class="even">
<td style="text-align: center;">convnext weighted more</td>
<td style="text-align: center;">0.98617</td>
<td style="text-align: center;">0.98539</td>
</tr>
<tr class="odd">
<td style="text-align: center;">vit weighted more</td>
<td style="text-align: center;">0.98502</td>
<td style="text-align: center;">0.98654</td>
</tr>
</tbody>
</table>
<p>The best Private score amongst these three submissions was tied with the previous best of 0.98617.</p>
<p>The best Public score still belongs to the submission replicating Jeremy’s approach directly (0.98923).</p>
<p>Here are the comprehensive Kaggle scoring results for this competition:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 18%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Submission</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Private Score</th>
<th style="text-align: center;">Public Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: left;">initial submission file after creating a quick small model following Jeremy Howard’s walkthrough video.</td>
<td style="text-align: center;">0.13709</td>
<td style="text-align: center;">0.12418</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: left;">initial submission using convnext small 2 epochs fine-tuned sorted file list</td>
<td style="text-align: center;">0.94124</td>
<td style="text-align: center;">0.92541</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: left;">squish convnext small 12 epoch ft tta</td>
<td style="text-align: center;">0.98156</td>
<td style="text-align: center;">0.98308</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: left;">ensemble small 12 epoch ft tta</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98423</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: left;">swinv2 convnext vit large ensemble 12 epoch ft tta</td>
<td style="text-align: center;">0.97811</td>
<td style="text-align: center;">0.98039</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: left;">swinv2 convnext vit large ensemble 24 epoch ft tta</td>
<td style="text-align: center;">0.98502</td>
<td style="text-align: center;">0.98539</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: left;">swinv2 (3x convnext) vit large ensemble 24 epoch ft tta</td>
<td style="text-align: center;">0.98387</td>
<td style="text-align: center;">0.98423</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: left;">(3x swinv2) convnext vit large ensemble 24 epoch ft tta</td>
<td style="text-align: center;">0.98156</td>
<td style="text-align: center;">0.985</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: left;">swinv2 convnext (3x vit) large ensemble 24 epoch ft tta</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98462</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: left;">swinv2 large 24 epoch ft tta</td>
<td style="text-align: center;">0.98271</td>
<td style="text-align: center;">0.98269</td>
</tr>
<tr class="odd">
<td style="text-align: center;">11</td>
<td style="text-align: left;">convnext large 24 epoch ft tta</td>
<td style="text-align: center;">0.98502</td>
<td style="text-align: center;">0.98269</td>
</tr>
<tr class="even">
<td style="text-align: center;">12</td>
<td style="text-align: left;">vit large 24 epoch ft tta</td>
<td style="text-align: center;">0.97811</td>
<td style="text-align: center;">0.98231</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: left;">swinv2 convnext vit large ensemble 24 epoch ft tta lr_find</td>
<td style="text-align: center;">0.98387</td>
<td style="text-align: center;">0.98577</td>
</tr>
<tr class="even">
<td style="text-align: center;">14</td>
<td style="text-align: left;">swinv2 convnext (3x vit) large ensemble 24 epoch ft tta lr_find</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98654</td>
</tr>
<tr class="odd">
<td style="text-align: center;">15</td>
<td style="text-align: left;">Following Jeremy Howard’s “Scaling Up: Road to the Top, Part 3” Notebook</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98923**</td>
</tr>
<tr class="even">
<td style="text-align: center;">16</td>
<td style="text-align: left;">convnext swinv2 vit large ft 12 epoch tta road to the top</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98769</td>
</tr>
<tr class="odd">
<td style="text-align: center;">17</td>
<td style="text-align: left;">(3 x convnext) swinv2 vit large ft 12 epoch tta road to the top</td>
<td style="text-align: center;">0.98617*</td>
<td style="text-align: center;">0.98539</td>
</tr>
</tbody>
</table>
<p>* largest private score (0.98617)</p>
<p>** largest public score (0.98923)</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I really <em>really</em> enjoyed working through the 6-part live coding series which resulted in this 8-part blog post mini-series. I learned so much across a wide variety of topics. It was also required a lot of patience and tenacity. I ran into endless errors or issues using Kaggle and Google Colab running the trainings for the first 7 blog posts. For some unknown reason, when I was using Kaggle (whether it was in Chrome or Firefox, Incognito/Private Window and otherwise) the tab kept crashing with an “Aw, snap” error (Chrome) or “Gah” error (Firefox). Each time, I lost progress and had to re-run the model training, sometimes losing 4-5 hours of progress because of this. In Google Colab, initially it was smooth sailing until I ran out of compute units (which always show 0 anyways in the free tier). I was debating whether to purchase 100 Google Colab compute units for 10 dollars. I decided instead to upgrade my Paperspace subscription to Pro for 8 dollars/month and thus got access to faster GPUs for “free”. However, that didn’t come without a catch! You can only run free tier GPUs for 6 hours before Paperspace automatically shuts it down. Fortunately, my model training runs in this notebook only took about 4-ish hours, so I escaped unscathed.</p>
<p>A few takeaways:</p>
<ul>
<li>I now understand what Jeremy meant when he said that you don’t really need to use <code>lr_find</code> because common problems in vision all require a similar learning rate. It didn’t matter whether I was using large or small versions of convnext, swinv2 or vit architectures, for 12 or 24 epochs. A learning rate of 0.01 for all scenarios performed the best.</li>
<li>All three of the architectures I used are pretty stable. There is variance in the final epoch validation error rate, but even after 15 different submissions, with different combinations of architectures, epochs and learning rates, the Kaggle maximum score didn’t break 0.98617.</li>
<li>Kaggle competitions are thrilling even when I submit scores after the competition is closed. I enjoyed trying to beat my previous score (and attempting to beat Jeremy’s score—with his own code and approach). Each time I submitted a CSV, I was excited to see the results. I can imagine the thrill when the competition is live. It must be so stressful as well! I am looking forward to competing in a live competition in 2024.</li>
<li>It’s important to both pace myself and be consistent. There were days where I couldn’t get nything accomplished on this project. There were also days where I watched and took notes on an entire live coding video from start to finish, and there were days in between. That’s fine. It happens! What’s important is to not give up just because one particular week (or month) is not producing much output. I also found that my persistence was bolstered by simply logging into Kaggle everyday, and keeping my streak going. Even if all I did was login to Kaggle. I heard someone say on a podcast or Instagram/TikTok video that before they got in shape, all they did was go to the gym and stay there for 5 minutes every day then come back home for 6 weeks. Just that practice solidified their consistency. I’m proud to say that as part of this project, I am on a 70 day Kaggle login streak! Here’s to continuing that streak throughout 2024.</li>
</ul>
<p><img src="kaggle_login_streak.png" alt="A screenshot showing my 70-day login streak in Kaggle" width="50%"></p>
<p>As always, I hope you enjoyed reading this blog post series!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vishalbakshi\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>