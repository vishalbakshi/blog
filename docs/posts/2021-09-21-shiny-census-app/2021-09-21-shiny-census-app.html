<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2021-09-21">
<meta name="description" content="An explanation of my development process for a census data shiny app">

<title>vishal bakshi - R Shiny Census App</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">vishal bakshi</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#table-of-contents" id="toc-table-of-contents" class="nav-link active" data-scroll-target="#table-of-contents">Table of Contents</a></li>
  <li><a href="#backstory" id="toc-backstory" class="nav-link" data-scroll-target="#backstory"></a><a name="#backstory" class="nav-link" data-scroll-target="undefined"></a>Backstory</li>
  <li><a href="#codebase" id="toc-codebase" class="nav-link" data-scroll-target="#codebase"></a><a name="#codebase" class="nav-link" data-scroll-target="undefined"></a>Codebase</li>
  <li><a href="#app.r" id="toc-app.r" class="nav-link" data-scroll-target="#app.r"></a><a name="#app-r" class="nav-link" data-scroll-target="undefined"></a><code>app.R</code>
  <ul class="collapse">
  <li><a href="#whats-in-my-ui" id="toc-whats-in-my-ui" class="nav-link" data-scroll-target="#whats-in-my-ui"></a><a name="whats-in-my-ui" class="nav-link" data-scroll-target="undefined"></a>What’s in my <code>ui</code>?</li>
  <li><a href="#what-does-my-server-do" id="toc-what-does-my-server-do" class="nav-link" data-scroll-target="#what-does-my-server-do"></a><a name="what-does-my-server-do" class="nav-link" data-scroll-target="undefined"></a>What does my <code>server</code> do?</li>
  </ul></li>
  <li><a href="#prep_db.r" id="toc-prep_db.r" class="nav-link" data-scroll-target="#prep_db.r"></a><a name="prep-db-r" class="nav-link" data-scroll-target="undefined"></a><code>prep_db.R</code>
  <ul class="collapse">
  <li><a href="#database-tables" id="toc-database-tables" class="nav-link" data-scroll-target="#database-tables"></a><a name="database-tables" class="nav-link" data-scroll-target="undefined"></a>Database Tables</li>
  <li><a href="#b20005" id="toc-b20005" class="nav-link" data-scroll-target="#b20005"></a><a name="b20005" class="nav-link" data-scroll-target="undefined"></a>b20005</li>
  <li><a href="#b20005_vars" id="toc-b20005_vars" class="nav-link" data-scroll-target="#b20005_vars"></a><a name="b20005-vars" class="nav-link" data-scroll-target="undefined"></a>b20005_vars</li>
  <li><a href="#codes" id="toc-codes" class="nav-link" data-scroll-target="#codes"></a><a name="codes" class="nav-link" data-scroll-target="undefined"></a>codes</li>
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data"></a><a name="load-the-data" class="nav-link" data-scroll-target="undefined"></a>Load the Data</li>
  <li><a href="#create-tables" id="toc-create-tables" class="nav-link" data-scroll-target="#create-tables"></a><a name="create-tables" class="nav-link" data-scroll-target="undefined"></a>Create Tables</li>
  <li><a href="#write-to-tables" id="toc-write-to-tables" class="nav-link" data-scroll-target="#write-to-tables"></a><a name="write-to-tables" class="nav-link" data-scroll-target="undefined"></a>Write to Tables</li>
  </ul></li>
  <li><a href="#get_b20005_ruca_aggregate_earnings.r" id="toc-get_b20005_ruca_aggregate_earnings.r" class="nav-link" data-scroll-target="#get_b20005_ruca_aggregate_earnings.r"></a><a name="get-b20005-ruca-aggregate-earnings-r" class="nav-link" data-scroll-target="undefined"></a><code>get_b20005_ruca_aggregate_earnings.R</code>
  <ul class="collapse">
  <li><a href="#get-variable-names" id="toc-get-variable-names" class="nav-link" data-scroll-target="#get-variable-names"></a><a name="get-variable-names" class="nav-link" data-scroll-target="undefined"></a>Get Variable Names</li>
  <li><a href="#derive-ruca-level-estimates-and-moe" id="toc-derive-ruca-level-estimates-and-moe" class="nav-link" data-scroll-target="#derive-ruca-level-estimates-and-moe"></a><a name="derive-ruca-level-estimates-and-moe" class="nav-link" data-scroll-target="undefined"></a>Derive RUCA Level Estimates and MOE</li>
  </ul></li>
  <li><a href="#calculate_median.r" id="toc-calculate_median.r" class="nav-link" data-scroll-target="#calculate_median.r"></a><a name="calculate-median-r" class="nav-link" data-scroll-target="undefined"></a><code>calculate_median.R</code>
  <ul class="collapse">
  <li><a href="#create-frequency-distribution" id="toc-create-frequency-distribution" class="nav-link" data-scroll-target="#create-frequency-distribution"></a><a name="create-frequency-distribution" class="nav-link" data-scroll-target="undefined"></a>Create Frequency Distribution</li>
  <li><a href="#calculate-weighted-total" id="toc-calculate-weighted-total" class="nav-link" data-scroll-target="#calculate-weighted-total"></a><a name="calculated-weighted-total" class="nav-link" data-scroll-target="undefined"></a>Calculate Weighted Total</li>
  <li><a href="#approximate-standard-error" id="toc-approximate-standard-error" class="nav-link" data-scroll-target="#approximate-standard-error"></a><a name="approximate-standard-error" class="nav-link" data-scroll-target="undefined"></a>Approximate Standard Error</li>
  <li><a href="#calculate-median-estimate-bounds" id="toc-calculate-median-estimate-bounds" class="nav-link" data-scroll-target="#calculate-median-estimate-bounds"></a><a name="calculate-median-estimate-bounds" class="nav-link" data-scroll-target="undefined"></a>Calculate Median Estimate Bounds</li>
  <li><a href="#reshape-the-data" id="toc-reshape-the-data" class="nav-link" data-scroll-target="#reshape-the-data"></a><a name="reshape-the-data" class="nav-link" data-scroll-target="undefined"></a>Reshape the Data</li>
  </ul></li>
  <li><a href="#format_query_result.r" id="toc-format_query_result.r" class="nav-link" data-scroll-target="#format_query_result.r"></a><a name="format-query-result-r" class="nav-link" data-scroll-target="undefined"></a><code>format_query_result.R</code>
  <ul class="collapse">
  <li><a href="#extract-data.frame-objects-from-list" id="toc-extract-data.frame-objects-from-list" class="nav-link" data-scroll-target="#extract-data.frame-objects-from-list"></a><a name="extract-data-frame-objects-from-list" class="nav-link" data-scroll-target="undefined"></a>Extract <code>data.frame</code> Objects from List</li>
  <li><a href="#reshape-data.frame-objects" id="toc-reshape-data.frame-objects" class="nav-link" data-scroll-target="#reshape-data.frame-objects"></a><a name="reshape-data-frame-objects" class="nav-link" data-scroll-target="undefined"></a>Reshape data.frame Objects</li>
  <li><a href="#add-descriptive-labels" id="toc-add-descriptive-labels" class="nav-link" data-scroll-target="#add-descriptive-labels"></a><a name="add-descriptive-labels" class="nav-link" data-scroll-target="undefined"></a>Add Descriptive Labels</li>
  </ul></li>
  <li><a href="#get_b20005_labels.r" id="toc-get_b20005_labels.r" class="nav-link" data-scroll-target="#get_b20005_labels.r"></a><a name="get-b20005-labels-r" class="nav-link" data-scroll-target="undefined"></a><code>get_b20005_labels.R</code>
  <ul class="collapse">
  <li><a href="#get-earnings-population-estimate-labels" id="toc-get-earnings-population-estimate-labels" class="nav-link" data-scroll-target="#get-earnings-population-estimate-labels"></a><a name="get-earnings-population-estimate-labels" class="nav-link" data-scroll-target="undefined"></a>Get Earnings Population Estimate Labels</li>
  <li><a href="#get-all-labels" id="toc-get-all-labels" class="nav-link" data-scroll-target="#get-all-labels"></a><a name="get-all-labels" class="nav-link" data-scroll-target="undefined"></a>Get All Labels</li>
  </ul></li>
  <li><a href="#get_b20005_tract_earnings.r" id="toc-get_b20005_tract_earnings.r" class="nav-link" data-scroll-target="#get_b20005_tract_earnings.r"></a><a name="get-b20005-tract-earnings-r" class="nav-link" data-scroll-target="undefined"></a><code>get_b20005_tract_earnings.R</code>
  <ul class="collapse">
  <li><a href="#get-variable-names-1" id="toc-get-variable-names-1" class="nav-link" data-scroll-target="#get-variable-names-1"></a><a name="get-variable-names-tract" class="nav-link" data-scroll-target="undefined"></a>Get Variable Names</li>
  <li><a href="#join-tables" id="toc-join-tables" class="nav-link" data-scroll-target="#join-tables"></a><a name="#join-tables" class="nav-link" data-scroll-target="undefined"></a>Join Tables</li>
  </ul></li>
  <li><a href="#get_b20005_states.r" id="toc-get_b20005_states.r" class="nav-link" data-scroll-target="#get_b20005_states.r"></a><a name="get-b20005-states-r" class="nav-link" data-scroll-target="undefined"></a><code>get_b20005_states.R</code></li>
  <li><a href="#get_design_factor.r" id="toc-get_design_factor.r" class="nav-link" data-scroll-target="#get_design_factor.r"></a><a name="get-design-factor-r" class="nav-link" data-scroll-target="undefined"></a><code>get_design_factor.R</code></li>
  <li><a href="#make_plot.r" id="toc-make_plot.r" class="nav-link" data-scroll-target="#make_plot.r"></a><a name="make-plot-r" class="nav-link" data-scroll-target="undefined"></a><code>make_plot.R</code></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">R Shiny Census App</h1>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">data analysis</div>
    <div class="quarto-category">SQL</div>
  </div>
  </div>

<div>
  <div class="description">
    An explanation of my development process for a census data shiny app
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 21, 2021</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">February 20, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>In this blog post, I’ll walk through my development process for a U.S. Census data visualization web app I created using the Shiny package in R.</p>
<p>You can access the app at <a href="http://vbakshi.shinyapps.io/census-app">vbakshi.shinyapps.io/census-app</a>.</p>
<section id="table-of-contents" class="level2">
<h2 class="anchored" data-anchor-id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#backstory">Backstory</a></li>
<li><a href="#codebase">Codebase</a>
<ul>
<li><a href="#app.r"><code>app.R</code></a>
<ul>
<li><a href="#whats-in-my-ui">What’s in my <code>ui</code>?</a>
<ul>
<li><a href="#dropdowns">Dropdowns</a></li>
<li><a href="#tables">Tables</a></li>
<li><a href="#plot">Plot</a></li>
<li><a href="#download-buttons">Download buttons</a></li>
</ul></li>
<li><a href="#what-does-my-server-do">What does my <code>server</code> do?</a>
<ul>
<li><a href="#get-data">Get Data</a></li>
<li><a href="#render-outputs">Render Outputs</a></li>
<li><a href="#prepare-dynamic-text">Prepare Dynamic Text</a></li>
<li><a href="#handle-downloads">Handle Downloads</a></li>
</ul></li>
</ul></li>
<li><a href="#prep_db.r"><code>prep_db.R</code></a>
<ul>
<li><a href="#database-tables">Database Tables</a>
<ul>
<li><a href="#b20005">b20005</a></li>
<li><a href="#b20005_vars">b20005_vars</a></li>
<li><a href="#codes">codes</a></li>
</ul></li>
<li><a href="#create-tables">Create Tables</a></li>
<li><a href="#write-to-tables">Write to Tables</a></li>
<li><a href="#load-the-data">Load the Data</a></li>
</ul></li>
<li><a href="#get_b20005_ruca_aggregate_earnings.r"><code>get_b20005_ruca_aggregate_earnings.R</code></a>
<ul>
<li><a href="#get-variable-names">Get Variable Names</a></li>
<li><a href="#derive-ruca-level-estimates-and-moe">Derive RUCA Level Estimates and MOE</a></li>
</ul></li>
<li><a href="#calculate_median.r"><code>calculate_median.R</code></a>
<ul>
<li><a href="#create-frequency-distribution">Create Frequency Distribution</a></li>
<li><a href="#calculate-weighted-total">Calculate Weighted Total</a></li>
<li><a href="#approximate-standard-error">Approximate Standard Error</a></li>
<li><a href="#calculate-median-estimate-bounds">Calculate Median Estimate Bounds</a></li>
<li><a href="#reshape-the-data">Reshape the Data</a></li>
</ul></li>
<li><a href="#format_query_result.r"><code>format_query_result.R</code></a>
<ul>
<li><a href="#extract-data.frame-objects-from-list">Extract <code>data.frame</code> Objects from List</a></li>
<li><a href="#reshape-data.frame-objects">Reshape data.frame Objects</a></li>
<li><a href="#add-descriptive-labels">Add Descriptive Labels</a></li>
</ul></li>
<li><a href="#get_b20005_labels.r"><code>get_b20005_labels.R</code></a>
<ul>
<li><a href="#get-earnings-population-estimate-labels">Get Earnings Population Estimate Labels</a></li>
<li><a href="#get-all-labels">Get All Labels</a></li>
</ul></li>
<li><a href="#get_b20005_tract_earnings.r"><code>get_b20005_tract_earnings.R</code></a>
<ul>
<li><a href="#get-variable-names-1">Get Variable Names</a></li>
<li><a href="#join-tables">Join Tables</a></li>
</ul></li>
<li><a href="#get_b20005_states.r"><code>get_b20005_states.R</code></a></li>
<li><a href="#get_design_factor.r"><code>get_design_factor.R</code></a></li>
<li><a href="#make_plot.r"><code>make_plot.R</code></a></li>
</ul></li>
</ul>
</section>
<section id="backstory" class="level2">
<h2 class="anchored" data-anchor-id="backstory"><a name="#backstory"></a>Backstory</h2>
<p>I started this project by reading the handbook <a href="https://www.census.gov/content/dam/Census/library/publications/2020/acs/acs_state_local_handbook_2020.pdf">Understanding and Using American Community Survey Data: What State and Local Government Users Need to Know</a> published by the U.S. Census Bureau. I recreated the handbook’s first case study in R, in which they make comparisons across geographic areas, create custom geographic areas from census tracts and calculate margins of error for derived estimates for Minnesota Census Tract 5-year earnings estimates.</p>
<p>During the process of recreating the derived median earnings estimate calculations, I was unable to recreate a key value from the handbook (the Standard Error for the 50% proportion, calculated to be 0.599) because I was unable to deduce the values used in the following formula referenced from page 17 of the <a href="https://www2.census.gov/programs-surveys/acs/tech_docs/pums/accuracy/2015_2019AccuracyPUMS.pdf">PUMS Accuracy of the Data documentation</a>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="se_formula_original.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Standard Error equals Design Factor times square root of the product of 95 over 5B and 50 squared</figcaption><p></p>
</figure>
</div>
<p>The documentation defines B as the <em>base</em>, which is the <em>calculated weighted total</em>. I chose the value of 1.3 for the design factor DF since it corresponds to STATE = Minnesota, CHARTYP = Population, CHARACTERISTIC = Person Earnings/Income in the <a href="https://www2.census.gov/programs-surveys/acs/tech_docs/pums/accuracy/2019_PUMS_5yr_Design_Factors.csv">Design Factors CSV published by the Census Bureau</a>.</p>
<p>I called the <a href="https://www.census.gov/programs-surveys/acs/contact.html">Census Bureau Customer Help Center</a> for assistance and was transferred to a member of the ACS Data User Support team with whom I discussed my woes. He was unable to confirm the values of the design factor DF or B, and was unable to pull up the contact information for the statistical methodology team, so I emailed him my questions. After a few email exchanges, the statistical methodology team provided the following:</p>
<ul>
<li>DF = 1.3</li>
<li>B = the total population estimate for which the median is being calculated, which is 82488 for the case study calculation (Minnesota Rural Male Full Time Workers)</li>
<li>The term 95/5 is associated with the finite population correction factor (100 - f) divided by the sample fraction (f), where f = 5% (later on I note in the documentation that this 95/5 term is based on a 68% confidence interval). The data used in the handbook case study is from 5-year estimates. 1-year estimates sample 2.5% of the population, so the 5-year estimates represent a 5 * 2.5 = 12.5% sample. Instead of 95/5, the ratio becomes (100 - 12.5)/12.5 = 87.5/12.5</li>
</ul>
<p>The updated formula is then:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="se_formula_modified.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Standard Error equals Design Factor times square root of the product of 87.5 over 12.5B and 50 squared</figcaption><p></p>
</figure>
</div>
<p>I was able to calculate the median earnings estimate (and associated standard error and margin of error) within a few percent of the values given in the handbook. This provided me with confirmation that I was ready to expand my code to calculate median earnings estimates for other subgroups.</p>
</section>
<section id="codebase" class="level2">
<h2 class="anchored" data-anchor-id="codebase"><a name="#codebase"></a>Codebase</h2>
<p>I built this app using the R package <a href="https://shiny.rstudio.com/reference/shiny/latest/"><code>Shiny</code></a> which handles both the UI and the server. I store the data in a <code>sqlite</code> database and access it with queries written using the <a href="https://cran.r-project.org/web/packages/RSQLite/RSQLite.pdf"><code>RSQLite</code></a> package which uses the <a href="https://dbi.r-dbi.org/reference/">DBI</a> API. The following sections break down the R scripts based on functionality. Click on the script name to navigate to that section.</p>
<ul>
<li><a href="#app.r"><code>app.R</code></a>
<ul>
<li>UI and server functions to handle people inputs and plot/table/text outputs</li>
</ul></li>
<li><a href="#prep-db-r"><code>prep_db.R</code></a>
<ul>
<li>Import, clean, combine and then load data into the <code>census_app_db.sqlite</code> database</li>
</ul></li>
<li><a href="#get-b20005-ruca-aggregate-earnings-r"><code>get_b20005_ruca_aggregate_earnings.R</code></a>
<ul>
<li>Queries the database for earnings and associated margins of error for RUCA levels derived from Census Tracts</li>
</ul></li>
<li><a href="#calculate-median-r"><code>calculate_median.R</code></a>
<ul>
<li>Derives estimate, standard of error and margin of error of median earnings for RUCA levels</li>
</ul></li>
<li><a href="#format-query-result-r"><code>format_query_result.R</code></a>
<ul>
<li>Formats <code>calculate_median</code> query results</li>
</ul></li>
<li><a href="#get-b20005-labels-r"><code>get_b20005_labels.R</code></a>
<ul>
<li>Queries the database for descriptive labels of B20005 table variables</li>
</ul></li>
<li><a href="#get-b20005-tract-earnings"><code>get_b20005_tract_earnings.R</code></a>
<ul>
<li>Queries the database for Census Tract-level earnings and associated margins of error</li>
</ul></li>
<li><a href="#get-b20005-states-r"><code>get_b20005_states.R</code></a>
<ul>
<li>Queries the SQLite database for a list of U.S. states</li>
</ul></li>
<li><a href="#get-design-factor-r"><code>get_design_factor.R</code></a>
<ul>
<li>Queries database for the design factor used for the median earnings estimation calculation</li>
</ul></li>
<li><a href="#make-plot-r"><code>make_plot.R</code></a>
<ul>
<li>Creates a bar plot object</li>
</ul></li>
</ul>
</section>
<section id="app.r" class="level2">
<h2 class="anchored" data-anchor-id="app.r"><a name="#app-r"></a><code>app.R</code></h2>
<p>A shiny app has three fundamental components:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> (...)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> (...)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server,...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>ui</code> object holds all UI layout, input and output objects which define the front-end of your app. The <code>server</code> object holds all rendering functions which are assigned to outputs that appear on the UI. The <code>shinyApp</code> function takes a <code>ui</code> and <code>server</code> object (along with other arguments) and creates a shiny app object which can be run in a browser by passing it to the <code>runApp</code> function. Person inputs (such as selections in a dropdown) are assigned to a global <code>input</code> object.</p>
<section id="whats-in-my-ui" class="level3">
<h3 class="anchored" data-anchor-id="whats-in-my-ui"><a name="whats-in-my-ui"></a>What’s in my <code>ui</code>?</h3>
<p>All of my UI objects are wrapped within a <code>fluidPage</code> call which returns a page layout which “consists of rows which in turn include columns” (from the <a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">docs</a>).</p>
<p>My app’s UI has four sections:</p>
<ol type="1">
<li>Dropdowns to select state, sex and work status for which the person using the app wants ACS 5-year earnings estimates</li>
</ol>
<p><img src="ui_dropdowns.png" alt="Dropdowns to select state, sex and work status for which the person using the app wants ACS 5-year earnings estimates" width="30%"></p>
<ol start="2" type="1">
<li>A table with the estimate, standard error and margin of error for median earnings</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="median_table.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">A table with the estimate, standard error and margin of error for median earnings</figcaption><p></p>
</figure>
</div>
<ol start="3" type="1">
<li>A bar plot of population estimates for earnings levels for the selected state, sex, work status and RUCA (Rural-Urban Commuting Areas) level</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="bar_plot.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">A bar plot of population estimates for earnings levels for the selected state, sex, work status and RUCA (Rural-Urban Commuting Areas) level</figcaption><p></p>
</figure>
</div>
<ol start="4" type="1">
<li>A table with population estimates for earnings levels for each RUCA level for the selected state, sex and work status</li>
</ol>
<p>Each section has a download button so that people can get the CSV files or plot image for their own analysis and reporting. Each section is separated with <code>markdown('---')</code> which renders an HTML horizontal rule (<code>&lt;hr&gt;</code>).</p>
<section id="dropdowns" class="level4">
<h4 class="anchored" data-anchor-id="dropdowns"><a href="dropdowns"></a>Dropdowns</h4>
<p>Dropdowns (the HTML <code>&lt;select&gt;</code> element) are a type of UI Input. I define each with an <code>inputId</code> which is a <code>character</code> object for reference on the server-side, a label <code>character</code> object which is rendered above the dropdown, and a <code>list</code> object which defines the dropdown options.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">selectInput</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputId =</span> <span class="st">"..."</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"..."</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">choices =</span> <span class="fu">list</span>(...)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In some cases, I want the person to see a <code>character</code> object in the dropdown that is more human-readable (e.g.&nbsp;<code>"Large Town"</code>) but use a corresponding input value in the server which is more computer-readable (e.g.&nbsp;<code>"Large_Town</code>). To achieve this, I use a named <code>character</code> vector where the names are displayed in the dropdown, and the assigned values are assigned to the global <code>input</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">selectInput</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">inputId =</span> <span class="st">"ruca_level"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">label =</span> <span class="st">"Select RUCA Level"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">choices =</span> <span class="fu">list</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">"RUCA LEVEL"</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Urban"</span> <span class="ot">=</span> <span class="st">"Urban"</span>, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Large Town"</span> <span class="ot">=</span> <span class="st">"Large_Town"</span>, </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Small Town"</span> <span class="ot">=</span> <span class="st">"Small_Town"</span>, </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Rural"</span> <span class="ot">=</span> <span class="st">"Rural"</span>))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, if the person selects <code>"Large Town"</code> the value assigned to <code>input$ruca_level</code> is <code>"Large_Town"</code>.</p>
</section>
<section id="tables" class="level4">
<h4 class="anchored" data-anchor-id="tables"><a name="tables"></a>Tables</h4>
<p>Tables (the HTML <code>&lt;table&gt;</code> element) are a type of UI Output. I define each with an <code>outputId</code> for reference in the server.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tableOutput</span>(<span class="at">outputId =</span> <span class="st">"..."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="plot" class="level4">
<h4 class="anchored" data-anchor-id="plot"><a name="plot"></a>Plot</h4>
<p>Similarly, a plot (which is rendered as an HTML <code>&lt;img&gt;</code> element) is a type of UI Output. I define each with an <code>outputId</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotOutput</span>(<span class="at">outputId =</span> <span class="st">"..."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="download-buttons" class="level4">
<h4 class="anchored" data-anchor-id="download-buttons"><a name="download-buttons"></a>Download Buttons</h4>
<p>The download button (an HTML <code>&lt;a&gt;</code> element) is also a type of UI Output. I define each with an <code>outputId</code> and <code>label</code> (which is displayed as the HTML <code>textContent</code> attribute of the <code>&lt;a&gt;</code> element).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">downloadButton</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">outputId =</span> <span class="st">"..."</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"..."</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="what-does-my-server-do" class="level3">
<h3 class="anchored" data-anchor-id="what-does-my-server-do"><a name="what-does-my-server-do"></a>What does my <code>server</code> do?</h3>
<p>The server function has three parameters: <code>input</code>, <code>output</code> and <code>session</code>. The <code>input</code> object is a <code>ReactiveValues</code> object which stores all UI Input values, which are accessed with <code>input$inputId</code>. The <code>output</code> object similarly holds UI Output values at <code>output$outputId</code>. I do not use the <code>session</code> object in my app (yet).</p>
<p>My app’s server has four sections:</p>
<ol type="1">
<li>Get data from the SQLite database</li>
<li>Render table and plot outputs</li>
<li>Prepare dynamic text (for filenames and the plot title)</li>
<li>Handle data.frame and plot downloads</li>
</ol>
<section id="get-data" class="level4">
<h4 class="anchored" data-anchor-id="get-data"><a name="get-data"></a>Get Data</h4>
<p>There are three high-level functions which call query/format/calculation functions to return the data in the format necessary to produce table, text, download and plot outputs:</p>
<ul>
<li>The <code>earnings_data</code> function passes the person-selected dropdown options <code>input$sex</code>, <code>input$work_status</code> and <code>input$state</code> to the <code>get_b20005_ruca_aggregate_earnings</code> function to get a query result from the SQLite database. That function call is passed to <code>format_earnings</code>, which in turn is passed to the <code>reactive</code> function to make it a reactive expression. Only reactive expressions (and reactive endpoints in the <code>output</code> object) are allowed to access the <code>input</code> object which is a reactive source. You can read more about Shiny’s “reactive programming model” in this <a href="https://shiny.rstudio.com/articles/reactivity-overview.html">excellent article</a>.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>earnings_data <span class="ot">&lt;-</span> <span class="fu">reactive</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format_earnings</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_b20005_ruca_aggregate_earnings</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      input<span class="sc">$</span>sex, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      input<span class="sc">$</span>work_status, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      input<span class="sc">$</span>state)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The <code>design_factor</code> function passes the <code>input$state</code> selection to the <code>get_design_factor</code> function which in turn is passed to the <code>reactive</code> function.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>design_factor <span class="ot">&lt;-</span> <span class="fu">reactive</span>(<span class="fu">get_design_factor</span>(input<span class="sc">$</span>state))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The <code>median_data</code> function passes the return values from <code>earnings_data()</code> and <code>design_factor()</code> to the <code>calculate_median</code> function which in turn is passed to the <code>reactive</code> function.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>median_data <span class="ot">&lt;-</span> <span class="fu">reactive</span>(<span class="fu">calculate_median</span>(<span class="fu">earnings_data</span>(), <span class="fu">design_factor</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="render-outputs" class="level4">
<h4 class="anchored" data-anchor-id="render-outputs"><a name="render-outputs"></a>Render Outputs</h4>
<p>I have two reactive endpoints for table outputs, and one endpoint for a plot. The table outputs use <code>renderTable</code> (with row names displayed) with the <code>data.frame</code> coming from <code>median_data()</code> and <code>earnings_data()</code>. The plot output uses <code>renderPlot</code>, and a helper function <code>make_plot</code> to create a bar plot of <code>earnings_data()</code> for a person-selected <code>input$ruca_level</code> with a title created with the helper function <code>earnings_plot_title()</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>median_data <span class="ot">&lt;-</span> <span class="fu">renderTable</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> <span class="fu">median_data</span>(), </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>earnings_data <span class="ot">&lt;-</span> <span class="fu">renderTable</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> <span class="fu">earnings_data</span>(), </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>earnings_histogram <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> <span class="fu">make_plot</span>(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">earnings_data</span>(), </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">ruca_level=</span>input<span class="sc">$</span>ruca_level, </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot_title=</span><span class="fu">earnings_plot_title</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prepare-dynamic-text" class="level4">
<h4 class="anchored" data-anchor-id="prepare-dynamic-text"><a name="prepare-dynamic-text"></a>Prepare Dynamic Text</h4>
<p>I created four functions that generate filenames for the <code>downloadHandler</code> call when the corresponding <code>downloadButton</code> gets clicked, one function that generates the title used to generate the bar plot, and one function which takes computer-readable <code>character</code> objects (e.g.&nbsp;<code>"Large_Town"</code>) and maps it to and returns a more human-readable <code>character</code> object (e.g.&nbsp;<code>"Large Town"</code>). I chose to keep filenames more computer-readable (to avoid spaces) and the plot title more human-readable.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>get_pretty_text <span class="ot">&lt;-</span> <span class="cf">function</span>(raw_text){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  text_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"M"</span> <span class="ot">=</span> <span class="st">"Male"</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"F"</span> <span class="ot">=</span> <span class="st">"Female"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"FT"</span> <span class="ot">=</span> <span class="st">"Full Time"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OTHER"</span> <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Urban"</span> <span class="ot">=</span> <span class="st">"Urban"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Large_Town"</span> <span class="ot">=</span> <span class="st">"Large Town"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Small_Town"</span> <span class="ot">=</span> <span class="st">"Small Town"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rural"</span> <span class="ot">=</span> <span class="st">"Rural"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(text_map[raw_text])</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>earnings_plot_title <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">paste</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>state,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>sex),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>work_status),</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>ruca_level,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Workers"</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep=</span><span class="st">" "</span>))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>b20005_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">paste</span>(</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>      input<span class="sc">$</span>state,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>sex),</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>      input<span class="sc">$</span>work_status,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">"earnings.csv"</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">sep=</span><span class="st">"_"</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>median_summary_filename <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>state,  </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>sex), </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>work_status, </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'estimated_median_earnings_summary.csv'</span>,  </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>ruca_earnings_filename <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>state,  </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>sex),  </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>work_status, </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'estimated_median_earnings_by_ruca_level.csv'</span>,  </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>earnings_plot_filename <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">paste</span>(</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>state,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_pretty_text</span>(input<span class="sc">$</span>sex),</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>work_status,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>ruca_level,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Workers.png"</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep=</span><span class="st">"_"</span>))</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="handle-downloads" class="level4">
<h4 class="anchored" data-anchor-id="handle-downloads"><a name="handle-downloads"></a>Handle downloads</h4>
<p>I have five download buttons in my app: two which trigger a download of a zip file with two CSVs, two that downloads a single CSV, and one that downloads a single PNG. The <code>downloadHandler</code> function takes a <code>filename</code> and a <code>content</code> function to write data to a file.</p>
<p>In order to create a zip file, I use the <code>zip</code> base package function and pass it a vector with two filepaths (to which data is written using the base package’s <code>write.csv</code> function) and a filename. I also specify the <code>contentType</code> as <code>"application/zip"</code>. In the zip file, one of the CSVs contains a query result from the <code>b20005</code> SQLite database table with earnings data, and the other file, <code>"b20005_variables.csv"</code> contains B20005 table variable names and descriptions. In order to avoid the files being written locally before download, I create a temporary directory with <code>tempdir</code> and prepend it to the filename to create the filepath.</p>
<p>For the bar plot image download, I use the <code>ggplot2</code> package’s <code>ggsave</code> function, which takes a filename, a plot object (returned from the <code>make_plot</code> helper function) and the <code>character</code> object <code>"png"</code> (for the <code>device</code> parameter).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>download_selected_b20005_data <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"b20005_data.zip"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="cf">function</span>(fname) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a temporary directory to prevent local storage of new files</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      temp_dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create two filepath character objects and store them in a list</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># which will later on be passed to the `zip` function</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      path1 <span class="ot">&lt;-</span> <span class="fu">paste</span>(temp_dir, <span class="st">'/'</span>, <span class="fu">b20005_filename</span>(), <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      path2 <span class="ot">&lt;-</span> <span class="fu">paste</span>(temp_dir, <span class="st">"/b20005_variables.csv"</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      fs <span class="ot">&lt;-</span> <span class="fu">c</span>(path1, path2)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a CSV with person-selection input values and do not add a column</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># with row names</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_b20005_earnings</span>(input<span class="sc">$</span>state, input<span class="sc">$</span>sex, input<span class="sc">$</span>work_status), </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        path1,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a CSV for table B20005 variable names and labels for reference</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_b20005_ALL_labels</span>(),</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        path2,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Zip together the files and add flags to maximize compression</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">zip</span>(<span class="at">zipfile =</span> fname, <span class="at">files=</span>fs, <span class="at">flags =</span> <span class="st">"-r9Xj"</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">contentType =</span> <span class="st">"application/zip"</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>download_all_b20005_data <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"ALL_B20005_data.zip"</span>,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">content =</span> <span class="cf">function</span>(fname){</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    path1 <span class="ot">&lt;-</span> <span class="st">"ALL_B20005_data.csv"</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    path2 <span class="ot">&lt;-</span> <span class="st">"b20005_variables.csv"</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    fs <span class="ot">&lt;-</span> <span class="fu">c</span>(path1, path2)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_b20005_earnings</span>(<span class="st">'ALL'</span>, <span class="st">'ALL'</span>, <span class="st">'ALL'</span>),</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      path1,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_b20005_ALL_labels</span>(),</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>      path2,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">zip</span>(<span class="at">zipfile =</span> fname, <span class="at">files=</span>fs, <span class="at">flags =</span> <span class="st">"-r9Xj"</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">contentType =</span> <span class="st">"application/zip"</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>download_median_summary <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">median_summary_filename</span>(),</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">content =</span> <span class="cf">function</span>(file) {</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="fu">median_data</span>(), file)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>download_earnings_plot <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">earnings_plot_filename</span>(),</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">content =</span> <span class="cf">function</span>(file) {</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>      file, </span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="fu">make_plot</span>(</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">data=</span><span class="fu">earnings_data</span>(), </span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">ruca_level=</span>input<span class="sc">$</span>ruca_level, </span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot_title=</span><span class="fu">earnings_plot_title</span>()), </span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">device =</span> <span class="st">"png"</span>)</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>download_ruca_earnings <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">ruca_earnings_filename</span>(),</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">content =</span> <span class="cf">function</span>(file) {</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(<span class="fu">earnings_data</span>(), file)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
</section>
<section id="prep_db.r" class="level2">
<h2 class="anchored" data-anchor-id="prep_db.r"><a name="prep-db-r"></a><code>prep_db.R</code></h2>
<p>This script is meant to be run locally, and is not deployed, as doing so would create a long delay to load the app.</p>
<section id="database-tables" class="level3">
<h3 class="anchored" data-anchor-id="database-tables"><a name="database-tables"></a>Database Tables</h3>
<p>The database diagram is shown below (created using <a href="https://dbdiagram.io">dbdiagram.io</a>):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="census-app-db.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Database diagram showing the database table schemas and their relationships</figcaption><p></p>
</figure>
</div>
<p>I have five tables in my database:</p>
</section>
<section id="b20005" class="level3">
<h3 class="anchored" data-anchor-id="b20005"><a name="b20005"></a>b20005</h3>
<p>Holds the data from the ACS 2015-2019 5-year detailed table B20005 (Sex By Work Experience In The Past 12 Months By Earnings In The Past 12 Months). This includes earnings estimates and margins of errors for Male and Female, Full Time and Other workers, for earning ranges (No earnings, $1 - $2499, $2500 - $4999, …, $100000 or more). The following table summarizes the groupings of the (non-zero earnings) variables relevant to this app:</p>
<p><br></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Variable</th>
<th style="text-align: center;">Demographic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">B20005_003 to B20005_025</td>
<td style="text-align: center;">Male Full Time Workers</td>
</tr>
<tr class="even">
<td style="text-align: center;">B20005_029 to B20005_048</td>
<td style="text-align: center;">Male Other Workers</td>
</tr>
<tr class="odd">
<td style="text-align: center;">B20005_050 to B20005_072</td>
<td style="text-align: center;">Female Full Time Workers</td>
</tr>
<tr class="even">
<td style="text-align: center;">B20005_076 to B20005_095</td>
<td style="text-align: center;">Female Other Workers</td>
</tr>
</tbody>
</table>
<p><br></p>
</section>
<section id="b20005_vars" class="level3">
<h3 class="anchored" data-anchor-id="b20005_vars"><a name="b20005-vars"></a>b20005_vars</h3>
<p>Has the name (e.g.&nbsp;B20005_003E) and label (e.g.&nbsp;“Estimate!!Total!!Male!!Worked full-time, year-round in the past 12 months”) for all B20005 variables. Variable names ending with an <code>E</code> are estimates, and those ending with <code>M</code> are margins of error. - <code>ruca</code> contains RUCA (Rural-Urban Commuting Area) codes published by the <a href="https://www.ers.usda.gov/data-products/rural-urban-commuting-area-codes.aspx">U.S. Department of Agriculture Economic Research Service</a> which classify U.S. census tracts using measures of population density. The following table shows the code ranges relevant to this app:</p>
<p><br></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">RUCA Code</th>
<th style="text-align: center;">RUCA Level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1-3</td>
<td style="text-align: center;">Urban</td>
</tr>
<tr class="even">
<td style="text-align: center;">4-6</td>
<td style="text-align: center;">Large Town</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7-9</td>
<td style="text-align: center;">Small Town</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">Rural</td>
</tr>
<tr class="odd">
<td style="text-align: center;">99</td>
<td style="text-align: center;">Zero Population</td>
</tr>
</tbody>
</table>
<p><br></p>
</section>
<section id="codes" class="level3">
<h3 class="anchored" data-anchor-id="codes"><a name="codes"></a>codes</h3>
<p>olds state FIPS (Federal Information Processing Standards) codes and RUCA levels - <code>design_factors</code> contains Design Factors for different characteristics (e.g.&nbsp;Person Earnings/Income) which are used to determine “the standard error of total and percentage sample estimates”, and “reflect the effects of the actual sample design and estimation procedures used for the ACS.” (<a href="https://www2.census.gov/programs-surveys/acs/tech_docs/pums/accuracy/2015_2019AccuracyPUMS.pdf">2015-2019 PUMS 5-Year Accuracy of the Data</a>).</p>
<p>In <code>prep_db.R</code>, I use the <code>DBI</code> package, <code>censusapi</code> and <code>base</code> R functions to perform the following protocol for each table:</p>
</section>
<section id="load-the-data" class="level3">
<h3 class="anchored" data-anchor-id="load-the-data"><a name="load-the-data"></a>Load the Data</h3>
<ul>
<li>For tables <code>b20005</code> and <code>b20005_vars</code>, I use the <code>censusapi::getCensus</code> and <code>censusapi::listCensusMetadata</code> repsectively to get the data</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TABLE b20005_vars ------------------------------</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>b20005_vars <span class="ot">&lt;-</span> <span class="fu">listCensusMetadata</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">'acs/acs5'</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2015</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">'variables'</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">'B20005'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a> <span class="co"># TABLE b20005 ----------------------------------</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a> b20005 <span class="ot">&lt;-</span> <span class="fu">getCensus</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">'acs/acs5'</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="st">"tract:*"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">regionin =</span> regionin_value,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">vintage =</span> <span class="dv">2015</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> b20005_vars<span class="sc">$</span>name,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">key=</span><span class="st">"..."</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>For tables <code>codes</code>, <code>ruca</code>, and <code>design_factors</code> I load the data from CSVs that I either obtained (in the case of the <a href="https://www2.census.gov/programs-surveys/acs/tech_docs/pums/accuracy/2019_PUMS_5yr_Design_Factors.csv">Design Factors</a>) or created (in the case of the codes and RUCA levels)</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># TABLE codes ----------------------------------</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>state_codes <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/state_codes.csv"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>ruca_levels <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/ruca_levels.csv"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"character"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-tables" class="level3">
<h3 class="anchored" data-anchor-id="create-tables"><a name="create-tables"></a>Create Tables</h3>
<p>Once the data is ready, I use <code>DBI::dbExecute</code> to run a SQLite command to create each table. The relationships shown in the image above dictate which fields create the primary key (in some cases, a compound primary key) as listed below:</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Table</th>
<th style="text-align: center;">Primary Key</th>
<th style="text-align: center;">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>b20005</code></td>
<td style="text-align: center;"><code>(state, county, tract)</code>)</td>
<td style="text-align: center;">Foreign key for table <code>ruca</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>b20005_vars</code></td>
<td style="text-align: center;"><code>name</code></td>
<td style="text-align: center;">e.g.&nbsp;<code>B20005_001E</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>ruca</code></td>
<td style="text-align: center;"><code>TRACTFIPS</code></td>
<td style="text-align: center;">Foreign key for table <code>b20005</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>codes</code></td>
<td style="text-align: center;"><code>(CODE, DESCRIPTION)</code></td>
<td style="text-align: center;">e.g.&nbsp;<code>(1, "Urban")</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>design_factors</code></td>
<td style="text-align: center;"><code>(ST, CHARACTERISTIC)</code></td>
<td style="text-align: center;">e.g.&nbsp;<code>("27", "Person Earnings/Income")</code></td>
</tr>
</tbody>
</table>
</section>
<section id="write-to-tables" class="level3">
<h3 class="anchored" data-anchor-id="write-to-tables"><a name="write-to-tables"></a>Write to Tables</h3>
<p>Once the table has been created in the database, I write the <code>data.frame</code> to the corresponding table with the following call:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(census_app_db, <span class="st">"&lt;table name&gt;"</span>, <span class="sc">&lt;</span>data.frame<span class="sc">&gt;</span>, <span class="at">append =</span> <span class="cn">TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="get_b20005_ruca_aggregate_earnings.r" class="level2">
<h2 class="anchored" data-anchor-id="get_b20005_ruca_aggregate_earnings.r"><a name="get-b20005-ruca-aggregate-earnings-r"></a><code>get_b20005_ruca_aggregate_earnings.R</code></h2>
<p>The function inside this script (with the same name), receives inputs from the server, sends queries to the database and returns the results. This process involves two steps:</p>
<section id="get-variable-names" class="level3">
<h3 class="anchored" data-anchor-id="get-variable-names"><a name="get-variable-names"></a>Get Variable Names</h3>
<p>The person using the app selects Sex (M or F), Work Status (Full Time or Other) and State (50 states + D.C. + Puerto Rico) for which they want to view and analyze earnings data. As shown above, different variables in table <code>b20005</code> correspond to different sexes and work statuses, and each tract for which there is all that earnings data resides in a given state.</p>
<p>I first query <code>b20005_vars</code> to get the relevent variables names which will be used in the query to <code>b20005</code>, as shown below. <code>name</code>s that end with “M” (queried with the wilcard <code>'%M'</code>) are for margins of error and those that end with “E” (wildcard <code>'%E'</code>) are for estimates.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    census_app_db, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT name FROM b20005_vars </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE label LIKE $label_wildcard </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">    AND name LIKE '%M'"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">params=</span><span class="fu">list</span>(<span class="at">label_wildcard=</span>label_wildcard))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>b20005_vars.label</code> column holds long string labels (which follow a consistent pattern, which is captured by the <code>$label_wildcard</code>) that describe the variable’s contents. Here are a couple of examples: <br></p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>b20005_vars.name</code></th>
<th style="text-align: center;"><code>b20005_vars.label</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>B20005_053E</code></td>
<td style="text-align: center;"><code>"Estimate!!Total!!Female!!Worked full-time, year-round in the past 12 months!!With earnings"</code>)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>B20005_076M</code></td>
<td style="text-align: center;"><code>"Margin of Error!!Total!!Female!!Other!!With earnings!!$1 to $2,499 or loss"</code></td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Since the <code>label</code> string contains the sex and work status, I assign a <code>label_wildcard</code> based on the person inputs from the sex and work status UI dropdowns.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare wildcard for query parameter `label_wildcard`</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sex <span class="sc">==</span> <span class="st">'M'</span>) {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (work_status <span class="sc">==</span> <span class="st">'FT'</span>) { label_wildcard <span class="ot">&lt;-</span> <span class="st">"%!!Male!!Worked%"</span> }</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (work_status <span class="sc">==</span> <span class="st">'OTHER'</span>) { label_wildcard <span class="ot">&lt;-</span> <span class="st">"%!!Male!!Other%"</span> }</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sex <span class="sc">==</span> <span class="st">'F'</span>) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (work_status <span class="sc">==</span> <span class="st">'FT'</span>) { label_wildcard <span class="ot">&lt;-</span> <span class="st">"%!!Female!!Worked%"</span> }</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (work_status <span class="sc">==</span> <span class="st">'OTHER'</span>) { label_wildcard <span class="ot">&lt;-</span> <span class="st">"%!!Female!!Other%"</span> }</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="derive-ruca-level-estimates-and-moe" class="level3">
<h3 class="anchored" data-anchor-id="derive-ruca-level-estimates-and-moe"><a name="derive-ruca-level-estimates-and-moe"></a>Derive RUCA Level Estimates and MOE</h3>
<p>Once the variables are returned, the actual values are queried from <code>b20005</code>, grouped by RUCA level. The ACS handbook <a href="https://www.census.gov/content/dam/Census/library/publications/2020/acs/acs_general_handbook_2020.pdf">Understanding and Using American Community Survey Data: What All Data Users Need to Know</a> shows how to calculate that margin of error for derived estimates. In our case, the margin of error for a RUCA level such as “Urban” for a given state is derived from the margin of error of individual Census Tracts using the formula below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="moe_formula.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">The MOE for a sum of estimates is the square root of the sum of MOEs squared</figcaption><p></p>
</figure>
</div>
<p>Translating this to a SQLite query:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct query string to square root of the sum of margins of error squared grouped by ruca level</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>query_string <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SQRT(SUM(POWER(b20005."</span>, vars<span class="sc">$</span>name, <span class="st">", 2))) AS "</span>, vars<span class="sc">$</span>name, <span class="at">collapse=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where <code>vars$name</code> is a list of variable names, and the <code>collapse</code> parameter converts a list or vector to a string. The beginning of that <code>query_string</code> looks like:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="st">"SQRT(SUM(POWER(b20005.B20005_001M, 2))) AS B20005_001M, SQRT(..."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The query is further built by adding the rest of the SQL statements:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>query_string <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT ruca.DESCRIPTION,"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    query_string,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FROM 'b20005' </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">    INNER JOIN ruca </span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">    ON b20005.state || b20005.county || b20005.tract = ruca.TRACTFIPS</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE </span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">    b20005.state = $state</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY ruca.DESCRIPTION"</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>ruca.DESCRIPTION</code> column, which contains RUCA levels (e.g.&nbsp;<code>"Urban"</code>) is joined onto <code>b20005</code> from the <code>ruca</code> table using the foreign keys representing the Census Tract FIPS code (<code>TRACTFIPS</code> for the <code>ruca</code> table and the concatenated field <code>state || county || tract</code> for <code>b20005</code>). The <code>$state</code> parameter is assigned the person-selected <code>state</code> input, and the columns are aggreaggated by RUCA levels (i.e.&nbsp;<code>GROUP BY ruca.DESCRIPTION</code>). Finally, the RUCA level and square root of the sum of MOEs squared are <code>SELECT</code>ed from the joined tables.</p>
<p>The query for estimates is simpler than MOEs, because estimates only need to be summed over RUCA levels:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a query to sum estimates grouped by ruca level</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  query_string <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"SUM(b20005."</span>,vars<span class="sc">$</span>name, <span class="st">") AS "</span>, vars<span class="sc">$</span>name, <span class="at">collapse=</span><span class="st">","</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>get_b20005_ruca_aggregate_earnings</code> returns the query result <code>data.frame</code>s in a named <code>list</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"estimate"</span> <span class="ot">=</span> estimate_rs, <span class="st">"moe"</span> <span class="ot">=</span> moe_rs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="calculate_median.r" class="level2">
<h2 class="anchored" data-anchor-id="calculate_median.r"><a name="calculate-median-r"></a><code>calculate_median.R</code></h2>
<p>The procedure for calculating a median earnings data estimate is shown starting on page 17 of the Accuracy of PUMS documentation. This script follows it closely:</p>
<section id="create-frequency-distribution" class="level3">
<h3 class="anchored" data-anchor-id="create-frequency-distribution"><a name="create-frequency-distribution"></a>Create Frequency Distribution</h3>
<ol type="1">
<li><em>Obtain the weighted frequency distribution for the selected variable.</em> <code>data</code> is a <code>data.frame</code> with earning estimate values. The rows are the earning ranges and the columns are <code>ruca_level</code>s:</li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cum_percent <span class="ot">&lt;-</span> <span class="fl">100.0</span> <span class="sc">*</span> <span class="fu">cumsum</span>(data[ruca_level]) <span class="sc">/</span> <span class="fu">sum</span>(data[ruca_level])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calculate-weighted-total" class="level3">
<h3 class="anchored" data-anchor-id="calculate-weighted-total"><a name="calculated-weighted-total"></a>Calculate Weighted Total</h3>
<ol start="2" type="1">
<li><em>Calculate the weighted total to yield the base, B.</em></li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">colSums</span>(data[ruca_level])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="approximate-standard-error" class="level3">
<h3 class="anchored" data-anchor-id="approximate-standard-error"><a name="approximate-standard-error"></a>Approximate Standard Error</h3>
<ol start="3" type="1">
<li><em>Approximate the standard error of a 50 percent proportion using the formula in Standard Errors for Totals and Percentages</em>. The <code>design_factor</code> is passed to this function by the server who uses the <code>get_design_factor</code> function explained below to query the <code>design_factors</code> table.</li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>se_50_percent <span class="ot">&lt;-</span> design_factor <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fl">87.5</span><span class="sc">/</span>(<span class="fl">12.5</span><span class="sc">*</span>B) <span class="sc">*</span> <span class="dv">50</span><span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calculate-median-estimate-bounds" class="level3">
<h3 class="anchored" data-anchor-id="calculate-median-estimate-bounds"><a name="calculate-median-estimate-bounds"></a>Calculate Median Estimate Bounds</h3>
<ol start="4" type="1">
<li><em>Create the variable p_lower by subtracting the SE from 50 percent. Create p_upper by adding the SE to 50 percent.</em></li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>p_lower <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">-</span> se_50_percent</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>p_upper <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> se_50_percent</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li><em>Determine the categories in the distribution that contain p_lower and p_upper</em>…</li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the indexes of the cumulative percent data.frame corresponding  </span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to the upper and lower bounds of the 50% proportion estimate</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>cum_percent_idx_lower <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(cum_percent <span class="sc">&gt;</span> p_lower))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>cum_percent_idx_upper <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">which</span>(cum_percent <span class="sc">&gt;</span> p_upper))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>.._If p_lower and p_upper fall in the same category, follow step 6. If p_lower and p_upper fall in different categories, go to step 7…_</p>
<p><br></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The median estimation calculation is handled differently based on </span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># whether the upper and lower bound indexes are equal</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cum_percent_idx_lower <span class="sc">==</span> cum_percent_idx_upper) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="6" type="1">
<li><em>If p_lower and p_upper fall in the same category, do the following:</em></li>
</ol>
<ul>
<li><em>Define A1 as the smallest value in that category.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A1 is the minimum earnings value (e.g. 30000) of the earning range </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. 30000 to 34999) corresponding to the lower bound cumulative percent</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> earnings[cum_percent_idx_lower, <span class="st">"min_earnings"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>Define A2 as the smallest value in the next (higher) category.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A2 is the minimum earnings value of the earning range above the </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># earning range corresponding to the upper bound cumulative percent</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> earnings[cum_percent_idx_lower <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"min_earnings"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>Define C1 as the cumulative percent of units strictly less than A1.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># C1 is the cumulative percentage of earnings one row below the </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lower bound cumulative percent</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>C1 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_lower <span class="sc">-</span> <span class="dv">1</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>Define C2 as the cumulative percent of units strictly less than A2.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># C2 is the cumulative percentage of the earnings below the </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lower bound cumulative percent</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>C2 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_lower, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>Use the following formulas to approximate the lower and upper bounds for a confidence interval about the median</em>:</li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the lower bound of the median </span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lower_bound <span class="ot">&lt;-</span> (p_lower <span class="sc">-</span> C1) <span class="sc">/</span> (C2 <span class="sc">-</span> C1) <span class="sc">*</span> (A2 <span class="sc">-</span> A1) <span class="sc">+</span> A1</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the upper bound of the median</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>upper_bound <span class="ot">&lt;-</span> (p_upper <span class="sc">-</span> C1) <span class="sc">/</span> (C2 <span class="sc">-</span> C1) <span class="sc">*</span> (A2 <span class="sc">-</span> A1) <span class="sc">+</span> A1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="7" type="1">
<li><em>If p_lower and p_upper fall in different categories, do the following</em>:</li>
</ol>
<ul>
<li><em>For the category containing p_lower: Define A1, A2, C1, and C2 as described in step 6. Use these values and the formula in step 6 to obtain the lower bound.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A1, A2, C1 and C2 are calculated using the lower bound cumulative percent</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to calculate the lower bound of the median estimate</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> earnings[cum_percent_idx_lower, <span class="st">"min_earnings"</span>]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> earnings[cum_percent_idx_lower <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"min_earnings"</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>C1 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_lower <span class="sc">-</span> <span class="dv">1</span>, ]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>C2 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_lower, ]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>lower_bound <span class="ot">&lt;-</span> (p_lower <span class="sc">-</span> C1) <span class="sc">/</span> (C2 <span class="sc">-</span> C1) <span class="sc">*</span> (A2 <span class="sc">-</span> A1) <span class="sc">+</span> A1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>For the category containing p_upper: Define new values for A1, A2, C1, and C2 as described in step 6. Use these values and the formula in step 6 to obtain the upper bound.</em></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A1, A2, C1 and C2 are calculated using the upper bound cumulative percent</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to calculate the upper bound of the median estimate</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> earnings[cum_percent_idx_upper, <span class="st">"min_earnings"</span>]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> earnings[cum_percent_idx_upper <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"min_earnings"</span>]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>C1 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_upper <span class="sc">-</span> <span class="dv">1</span>,]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>C2 <span class="ot">&lt;-</span> cum_percent[cum_percent_idx_upper,]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>upper_bound <span class="ot">&lt;-</span> (p_upper <span class="sc">-</span> C1) <span class="sc">/</span> (C2 <span class="sc">-</span> C1) <span class="sc">*</span> (A2 <span class="sc">-</span> A1) <span class="sc">+</span> A1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="8" type="1">
<li><em>Use the lower and upper bounds approximated in steps 6 or 7 to approximate the standard error of the median. SE(median) = 1/2 X (Upper Bound – Lower Bound)</em></li>
</ol>
<p><br></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The median earning estimate is the average of the upper and lower bounds</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># of the median estimates calculated above in the if-else block</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>median_earnings <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> (lower_bound <span class="sc">+</span> upper_bound)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The median SE is half the distance between the upper and lower bounds</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># of the median estimate</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>median_se <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> (upper_bound <span class="sc">-</span> lower_bound)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The 90% confidence interval critical z-score is used to calculate </span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># the margin of error</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>median_90_moe <span class="ot">&lt;-</span> <span class="fl">1.645</span> <span class="sc">*</span> median_se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reshape-the-data" class="level3">
<h3 class="anchored" data-anchor-id="reshape-the-data"><a name="reshape-the-data"></a>Reshape the Data</h3>
<p>Finally, a <code>data.frame</code> is returned, which will be displayed in a <code>tableOutput</code> element.</p>
<p><br></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A data.frame will be displayed in the UI</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>median_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Estimate"</span> <span class="ot">=</span> median_earnings,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SE"</span> <span class="ot">=</span> median_se,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MOE"</span> <span class="ot">=</span> median_90_moe</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="format_query_result.r" class="level2">
<h2 class="anchored" data-anchor-id="format_query_result.r"><a name="format-query-result-r"></a><code>format_query_result.R</code></h2>
<p>The purpose of this function is to receive two <code>data.frame</code> objects, one for earnings <code>estimate</code> values, and one for the corresponding <code>moe</code> values, and return a single <code>data.frame</code> which is ready to be displayed in a <code>tableOutput</code>.</p>
<section id="extract-data.frame-objects-from-list" class="level3">
<h3 class="anchored" data-anchor-id="extract-data.frame-objects-from-list"><a name="extract-data-frame-objects-from-list"></a>Extract <code>data.frame</code> Objects from List</h3>
<p>Since <code>get_b20005_ruca_aggregate_earnings</code> returns a named list, I first pull out the <code>estimate</code> and <code>moe</code> <code>data.frame</code> objects:</p>
<p><br></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull out query result data.frames from the list</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> rs[[<span class="st">"estimate"</span>]]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>moe <span class="ot">&lt;-</span> rs[[<span class="st">"moe"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reshape-data.frame-objects" class="level3">
<h3 class="anchored" data-anchor-id="reshape-data.frame-objects"><a name="reshape-data-frame-objects"></a>Reshape data.frame Objects</h3>
<p>These <code>data.frame</code> objects have RUCA levels in the column <code>DESCRIPTION</code> and one column for each population estimate. For example, the <code>estimate</code> for Alabama Full Time Female workers looks like this:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;"><code>DESCRIPTION</code></th>
<th style="text-align: center;">…</th>
<th style="text-align: center;"><code>B20005_053E</code></th>
<th style="text-align: center;"><code>B20005_054E</code></th>
<th style="text-align: center;"><code>B20005_055E</code></th>
<th style="text-align: center;">…</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;"><code>Large Town</code></td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">149</td>
<td style="text-align: center;">257</td>
<td style="text-align: center;">546</td>
<td style="text-align: center;">…</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;"><code>Rural</code></td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">75</td>
<td style="text-align: center;">66</td>
<td style="text-align: center;">351</td>
<td style="text-align: center;">…</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;"><code>Small Town</code></td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">28</td>
<td style="text-align: center;">162</td>
<td style="text-align: center;">634</td>
<td style="text-align: center;">…</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;"><code>Urban</code></td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">468</td>
<td style="text-align: center;">1061</td>
<td style="text-align: center;">4732</td>
<td style="text-align: center;">…</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;"><code>Zero Population</code></td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">…</td>
</tr>
</tbody>
</table>
<p>The <code>moe</code> <code>data.frame</code> has a similar layout.</p>
<p>However, in the UI, I want the table to look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="alabama_ft_female_earnings_table.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Population estimates for earnings levels from $1 to $2499 up to $100000 and more for Alabama Full Time Female Workers</figcaption><p></p>
</figure>
</div>
<p>To achieve this, I first <code>t</code>ranspose the <code>estimate</code> and <code>moe</code> <code>data.frame</code>s…</p>
<p><br></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transpose the query results</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> estimate[,<span class="st">"DESCRIPTION"</span>]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">t</span>(estimate[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(estimate) <span class="ot">&lt;-</span> col_names</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> moe[,<span class="st">"DESCRIPTION"</span>]</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>moe <span class="ot">&lt;-</span> <span class="fu">t</span>(moe[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(moe) <span class="ot">&lt;-</span> col_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>…then zip them together, keeping in mind that not all states have tracts designated with all RUCA levels:</p>
<p><br></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping to make column names more computer-readable</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>format_ruca_level <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Urban"</span> <span class="ot">=</span> <span class="st">"Urban"</span>, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Large Town"</span> <span class="ot">=</span> <span class="st">"Large_Town"</span>, </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Small Town"</span> <span class="ot">=</span> <span class="st">"Small_Town"</span>, </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rural"</span> <span class="ot">=</span> <span class="st">"Rural"</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Zero Population"</span> <span class="ot">=</span> <span class="st">"Zero_Population"</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># bind together estimate and corresponding moe columns</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co"># some states do not have all RUCA levels</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co"># for example, Connecticut does not have "Small Town" tracts</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty objects</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>output_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">temp =</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(estimate), <span class="at">ncol =</span> <span class="dv">0</span>))</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ruca_level <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Urban"</span>, <span class="st">"Large Town"</span>, <span class="st">"Small Town"</span>, <span class="st">"Rural"</span>)) {</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ruca_level <span class="sc">%in%</span> <span class="fu">colnames</span>(estimate)) {</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    output_table <span class="ot">&lt;-</span> <span class="fu">cbind</span>(output_table, estimate[,ruca_level], moe[,ruca_level])</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># paste "_MOE" suffix for MOE columns</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>      col_names,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>      format_ruca_level[[ruca_level]],</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(format_ruca_level[[ruca_level]], <span class="st">"_MOE"</span>))</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace old names with more computer-readable names</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(output_table) <span class="ot">&lt;-</span> col_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
</section>
<section id="add-descriptive-labels" class="level3">
<h3 class="anchored" data-anchor-id="add-descriptive-labels"><a name="add-descriptive-labels"></a>Add Descriptive Labels</h3>
<p>Finally, <code>merge</code> the <code>output_table</code> <code>data.frame</code> with <code>labels</code> (long form description of the B20005 variables) which are retrieved from the database using the <code>get_b20005_labels</code> function explained later on in this post. Remember that the <code>label</code> is delimited with <code>"!!"</code> and the last substring contains earnings ranges (e.g.&nbsp;“$30,000 to $34,999”):</p>
<p><br></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name rows as long-form labels, by splitting them by '!!' and </span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># grabbing the last chunk which has dollar ranges e.g. </span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># $30000 to $34999</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>output_table <span class="ot">&lt;-</span> <span class="fu">merge</span>(output_table, labels, <span class="at">by.x =</span> <span class="dv">0</span>, <span class="at">by.y =</span> <span class="st">"name"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>split_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rbind'</span>, </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">strsplit</span>(<span class="fu">as.character</span>(output_table<span class="sc">$</span>label),<span class="st">'!!'</span>,<span class="at">fixed=</span><span class="cn">TRUE</span>)))</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(output_table) <span class="ot">&lt;-</span> split_label<span class="sc">$</span>X6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
</section>
</section>
<section id="get_b20005_labels.r" class="level2">
<h2 class="anchored" data-anchor-id="get_b20005_labels.r"><a name="get-b20005-labels-r"></a><code>get_b20005_labels.R</code></h2>
<p>This script contains two helper functions to retrieve the <code>label</code> column from the <code>b20005_vars</code> table.</p>
<section id="get-earnings-population-estimate-labels" class="level3">
<h3 class="anchored" data-anchor-id="get-earnings-population-estimate-labels"><a name="get-earnings-population-estimate-labels"></a>Get Earnings Population Estimate Labels</h3>
<p>The first one, <code>get_b20005_labels</code> retrieves the variable <code>name</code> and <code>label</code> for earning range strings (e.g.&nbsp;“$30,000 to $34,999”):</p>
<p><br></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>get_b20005_labels <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  census_app_db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"census_app_db.sqlite"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  rs <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    census_app_db, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT </span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="st">      name, label</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM 'b20005_vars' </span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE </span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="st">      label LIKE '%$%'</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="st">    ORDER BY name"</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(census_app_db)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rs)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
</section>
<section id="get-all-labels" class="level3">
<h3 class="anchored" data-anchor-id="get-all-labels"><a name="get-all-labels"></a>Get All Labels</h3>
<p>The second function, <code>get_b20005_ALL_labels</code> returns the whole table:</p>
<p><br></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>get_b20005_ALL_labels <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  census_app_db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"census_app_db.sqlite"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  rs <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    census_app_db, </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT </span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="st">      name, label</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM 'b20005_vars' </span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="st">    ORDER BY name"</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(census_app_db)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rs)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
</section>
</section>
<section id="get_b20005_tract_earnings.r" class="level2">
<h2 class="anchored" data-anchor-id="get_b20005_tract_earnings.r"><a name="get-b20005-tract-earnings-r"></a><code>get_b20005_tract_earnings.R</code></h2>
<p>This function is similar to <code>get_b20005_ruca_aggregate_earnings</code> but does not aggregate by RUCA level, and also includes Census Tracts that are not designated a RUCA level. The <code>label_wildcard</code> is constructed the same way as before.</p>
<section id="get-variable-names-1" class="level3">
<h3 class="anchored" data-anchor-id="get-variable-names-1"><a name="get-variable-names-tract"></a>Get Variable Names</h3>
<p>The variable <code>name</code>s are obtained for both margin of error and estimates in the same query:</p>
<p><br></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># Get b20005 variable names (estimates and moe)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  census_app_db, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT name FROM b20005_vars </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE label LIKE $label_wildcard"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">params=</span><span class="fu">list</span>(<span class="at">label_wildcard=</span>label_wildcard)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
</section>
<section id="join-tables" class="level3">
<h3 class="anchored" data-anchor-id="join-tables"><a name="#join-tables"></a>Join Tables</h3>
<p>The tract-level earnings are queried with the following, using a <code>LEFT JOIN</code> between <code>b20005</code> and <code>ruca</code> tables to include tracts that do not have a RUCA level.</p>
<p><br></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct query to get tract-level earnings data</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>query_string <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT ruca.DESCRIPTION,</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="st">  b20005.state || b20005.county || b20005.tract AS TRACTFIPS,"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(vars<span class="sc">$</span>name, <span class="at">collapse=</span><span class="st">","</span>),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"FROM b20005 </span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN ruca </span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="st">  ON b20005.state || b20005.county || b20005.tract = ruca.TRACTFIPS</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE </span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="st">  b20005.state LIKE $state"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
</section>
</section>
<section id="get_b20005_states.r" class="level2">
<h2 class="anchored" data-anchor-id="get_b20005_states.r"><a name="get-b20005-states-r"></a><code>get_b20005_states.R</code></h2>
<p>This function retrieves state codes and names from the <code>codes</code> table, and is used to assign <code>choices</code> to <code>selectInput</code> dropdowns. <code>"United States"</code> which has a FIPS code of <code>"00"</code> is excluded because the <code>b20005</code> table contains state-level data only. The query result is sorted by the state name so that the dropdown menu <code>choices</code> are in ascending alphabetical order.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  census_app_db, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT DESCRIPTION, CODE</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM codes </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE CATEGORY = 'state'</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="st">  AND CODE &lt;&gt; '00'</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY DESCRIPTION"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
</section>
<section id="get_design_factor.r" class="level2">
<h2 class="anchored" data-anchor-id="get_design_factor.r"><a name="get-design-factor-r"></a><code>get_design_factor.R</code></h2>
<p>This function retrieves a single numeric Design Factor for the “Person Earnings/Income” characteristic from the <code>design_factors</code> table for a given <code>state</code> parameter:</p>
<p><br></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  census_app_db, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT DESIGN_FACTOR FROM design_factors</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE ST = $state</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="st">  AND CHARACTERISTIC = 'Person Earnings/Income'"</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(<span class="at">state=</span>state))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(rs[<span class="dv">1</span>, <span class="st">"DESIGN_FACTOR"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
</section>
<section id="make_plot.r" class="level2">
<h2 class="anchored" data-anchor-id="make_plot.r"><a name="make-plot-r"></a><code>make_plot.R</code></h2>
<p>This is function creates a <code>ggplot.bar_plot</code> object using a given data, RUCA level, and title. The x-axis labels are rotated, both axis labels are resized, and plot title and subtitle are formatted.</p>
<p><br></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>make_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ruca_level, plot_title){</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare x-axis factor for `aes` parameter</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  xs <span class="ot">&lt;-</span> <span class="fu">rownames</span>(data)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  xs <span class="ot">&lt;-</span> <span class="fu">factor</span>(xs, xs)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  bar_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>data,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x=</span>xs, <span class="at">y=</span><span class="fu">get</span>(ruca_level))) <span class="sc">+</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">'identity'</span>) <span class="sc">+</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Rotate x-axis labels</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x=</span><span class="fu">element_text</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">angle =</span> <span class="sc">-</span><span class="dv">90</span>, </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust=</span><span class="dv">1</span>, </span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Resize x-axis labels and move them away from axis</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.x=</span><span class="fu">element_text</span>(<span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.75</span>,<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Resize y-axis labels</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Set plot title and subtitle font and placement</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">'bold'</span>),</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust=</span><span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Earnings"</span>, <span class="at">y=</span><span class="st">"Population Estimate"</span>) <span class="sc">+</span> </span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(plot_title, <span class="at">subtitle=</span><span class="st">"Population Estimate by Earnings Level"</span>)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (bar_plot)</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<hr>
<p><br></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>