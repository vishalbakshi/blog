<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-09-03">
<meta name="description" content="In this blog post, I experiment with 6 chunking/retrieval strategies to retrieve context from a sqlite database sufficient to answer 76.7% of the 202 fastbook end-of-chapter questions from Part 1 of the course.">

<title>Vishal Bakshi’s Blog - Establishing a Full Text Search (BM25) Baseline for My fastbookRAG Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#summary-of-results" id="toc-summary-of-results" class="nav-link" data-scroll-target="#summary-of-results">Summary of Results</a></li>
  <li><a href="#experimental-setup" id="toc-experimental-setup" class="nav-link" data-scroll-target="#experimental-setup">Experimental Setup</a>
  <ul class="collapse">
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data Sources</a></li>
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing">Data Preprocessing</a></li>
  <li><a href="#database" id="toc-database" class="nav-link" data-scroll-target="#database">Database</a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#why-bm25" id="toc-why-bm25" class="nav-link" data-scroll-target="#why-bm25">Why BM25?</a></li>
  <li><a href="#evaluation-set" id="toc-evaluation-set" class="nav-link" data-scroll-target="#evaluation-set">Evaluation Set</a></li>
  <li><a href="#evaluation-metrics" id="toc-evaluation-metrics" class="nav-link" data-scroll-target="#evaluation-metrics">Evaluation Metrics</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#best-approach-per-chapter" id="toc-best-approach-per-chapter" class="nav-link" data-scroll-target="#best-approach-per-chapter">Best Approach per Chapter</a></li>
  <li><a href="#all-approaches-for-all-chapters" id="toc-all-approaches-for-all-chapters" class="nav-link" data-scroll-target="#all-approaches-for-all-chapters">All Approaches for All Chapters</a></li>
  <li><a href="#question-level-analysis" id="toc-question-level-analysis" class="nav-link" data-scroll-target="#question-level-analysis">Question-Level Analysis</a></li>
  <li><a href="#results-csv" id="toc-results-csv" class="nav-link" data-scroll-target="#results-csv">Results CSV</a></li>
  </ul></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#future-work" id="toc-future-work" class="nav-link" data-scroll-target="#future-work">Future Work</a></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments</a>
  <ul class="collapse">
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions">Helper Functions</a></li>
  <li><a href="#data-preprocessing-1" id="toc-data-preprocessing-1" class="nav-link" data-scroll-target="#data-preprocessing-1">Data Preprocessing</a></li>
  <li><a href="#loading-the-chunks-into-the-database" id="toc-loading-the-chunks-into-the-database" class="nav-link" data-scroll-target="#loading-the-chunks-into-the-database">Loading the Chunks into the Database</a></li>
  <li><a href="#load-the-question-data" id="toc-load-the-question-data" class="nav-link" data-scroll-target="#load-the-question-data">Load the Question Data</a></li>
  <li><a href="#bm25_a-top-1-1-paragraph-chunks" id="toc-bm25_a-top-1-1-paragraph-chunks" class="nav-link" data-scroll-target="#bm25_a-top-1-1-paragraph-chunks">BM25_A: Top-1 1-Paragraph Chunks</a></li>
  <li><a href="#bm25_b-top-3-1-paragraph-chunks" id="toc-bm25_b-top-3-1-paragraph-chunks" class="nav-link" data-scroll-target="#bm25_b-top-3-1-paragraph-chunks">BM25_B: Top-3 1-Paragraph Chunks</a></li>
  <li><a href="#bm25_c-top-5-1-paragraph-chunks" id="toc-bm25_c-top-5-1-paragraph-chunks" class="nav-link" data-scroll-target="#bm25_c-top-5-1-paragraph-chunks">BM25_C: Top-5 1-Paragraph Chunks</a></li>
  <li><a href="#bm25_d-top-1-3-paragraph-chunks" id="toc-bm25_d-top-1-3-paragraph-chunks" class="nav-link" data-scroll-target="#bm25_d-top-1-3-paragraph-chunks">BM25_D: Top-1 3-Paragraph Chunks</a></li>
  <li><a href="#bm_25e-top-3-3-paragraph-chunks" id="toc-bm_25e-top-3-3-paragraph-chunks" class="nav-link" data-scroll-target="#bm_25e-top-3-3-paragraph-chunks">BM_25E: Top-3 3-Paragraph Chunks</a></li>
  <li><a href="#bm25_f-top-5-3-paragraph-chunks" id="toc-bm25_f-top-5-3-paragraph-chunks" class="nav-link" data-scroll-target="#bm25_f-top-5-3-paragraph-chunks">BM25_F: Top-5 3-Paragraph Chunks</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Establishing a Full Text Search (BM25) Baseline for My fastbookRAG Project</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">RAG</div>
    <div class="quarto-category">information retrieval</div>
    <div class="quarto-category">fastbookRAG</div>
  </div>
  </div>

<div>
  <div class="description">
    In this blog post, I experiment with 6 chunking/retrieval strategies to retrieve context from a sqlite database sufficient to answer 76.7% of the 202 fastbook end-of-chapter questions from Part 1 of the course.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 3, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This notebook is a part of <a href="https://vishalbakshi.github.io/blog/#category=fastbookRAG">series of blog posts</a> for a project I’m calling <strong>fastbookRAG</strong> where I’m trying to answer questions from the <a href="https://github.com/fastai/fastbook/tree/master">fastbook</a> end-of-chapter Questionnaires using the following pipeline:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" title="fastbookRAG diagram" data-gallery="quarto-lightbox-gallery-1"><img src="1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">fastbookRAG diagram</figcaption><p></p>
</figure>
</div>
<p>This notebook establishes a baseline using BM25 for keyword-based retrieval on chunks of the fastbook chapters covered in <a href="https://course.fast.ai/">Part 1 of the fastai course</a> (1, 2, 4, 8, 9, 10, and 13). I generate keywords (for full text search) for each question <a href="https://vishalbakshi.github.io/blog/posts/2024-08-27-fastbookRAG-claude-keywords/">using the Claude-3.5-Sonnet API (using the Answer.AI library <code>claudette</code>)</a>.</p>
<p>The evaluation metric for each question, that I’m simply calling <strong>score</strong>, is binary: can the retrieved context answer the question (<code>1</code>) or not (<code>0</code>)? The evaluation metric across a set of questions, which I’m calling the <strong>Answer Rate</strong>, is the mean score for those questions.</p>
<p>The goal is to retrieve the context necessary to answer all questions. Currently, I manually assess answers. Eventually I’ll integrate an LLM into this pipeline to generate (and evaluate) answers based on the retrieved context.</p>
</section>
<section id="summary-of-results" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-results">Summary of Results</h2>
<p>Here are the results from my experiments in this notebook—in general, the best performing full text search method (76.7% Answer Rate overall) was retrieving the top-5 (BM25 score) 3-paragraph chunks based on the given set of keywords using FTS5 in sqlite:</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">BM25_A (Top-1 1p)</th>
<th style="text-align: center;">BM25_B (Top-3 1p)</th>
<th style="text-align: center;">BM25_C (Top-5 1p)</th>
<th style="text-align: center;">BM25_D (Top-1 3p)</th>
<th style="text-align: center;">BM25_E (Top-3 3p)</th>
<th style="text-align: center;">BM25_F (Top-5 3p)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">40% (12/30)</td>
<td style="text-align: center;">56.7% (17/30)</td>
<td style="text-align: center;">60% (18/30)</td>
<td style="text-align: center;">63.3% (19/30)</td>
<td style="text-align: center;">83.3% (25/30)</td>
<td style="text-align: center;">90% (27/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">38.5% (10/26)</td>
<td style="text-align: center;">65.4% (17/26)</td>
<td style="text-align: center;">69.2% (18/26)</td>
<td style="text-align: center;">46.2% (12.26)</td>
<td style="text-align: center;">80.8% (21/26)</td>
<td style="text-align: center;">80.8% (21/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">25% (8/32)</td>
<td style="text-align: center;">68.8% (22/32)</td>
<td style="text-align: center;">71.9% (23/32)</td>
<td style="text-align: center;">31.3% (10/32)</td>
<td style="text-align: center;">71.9% (23/32)</td>
<td style="text-align: center;">75% (24/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">13.8% (4/29)</td>
<td style="text-align: center;">34.5% (10/29)</td>
<td style="text-align: center;">44.8% (13/29)</td>
<td style="text-align: center;">31% (9/29)</td>
<td style="text-align: center;">55.2% (16/29)</td>
<td style="text-align: center;">65.5% (19/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">13.8% (4/29)</td>
<td style="text-align: center;">48.3% (14/29)</td>
<td style="text-align: center;">58.6% (17/29)</td>
<td style="text-align: center;">34.5% (10/29)</td>
<td style="text-align: center;">72.4% (21/29)</td>
<td style="text-align: center;">79.3% (23/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">47.6% (12/21)</td>
<td style="text-align: center;">42.9% (9/21)</td>
<td style="text-align: center;">61.9% (13/21)</td>
<td style="text-align: center;">38% (8/21)</td>
<td style="text-align: center;">57.1% (12/21)</td>
<td style="text-align: center;">61.9% (13/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">37.1% (13/35)</td>
<td style="text-align: center;">54.3% (19/35)</td>
<td style="text-align: center;">60% (21/35)</td>
<td style="text-align: center;">42.9% (15/35)</td>
<td style="text-align: center;">68.6% (24/35)</td>
<td style="text-align: center;">80% (28/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>30.2% (61/202)</strong></td>
<td style="text-align: center;"><strong>53.5% (108/202)</strong></td>
<td style="text-align: center;"><strong>60.9% (123/202)</strong></td>
<td style="text-align: center;"><strong>41.1% (83/202)</strong></td>
<td style="text-align: center;"><strong>70.3% (142/202)</strong></td>
<td style="text-align: center;"><strong>76.7% (155/202)</strong></td>
</tr>
</tbody>
</table>
</section>
<section id="experimental-setup" class="level2">
<h2 class="anchored" data-anchor-id="experimental-setup">Experimental Setup</h2>
<section id="data-sources" class="level3">
<h3 class="anchored" data-anchor-id="data-sources">Data Sources</h3>
<ul>
<li>The freely available Jupyter Notebook-written <a href="https://github.com/fastai/fastbook/">fastbook</a>.</li>
</ul>
</section>
<section id="data-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="data-preprocessing">Data Preprocessing</h3>
<ul>
<li>Chunking strategy: Single or multiple paragraphs with corresponding headers.</li>
<li>Rationale: Balances granular content with high-level context.</li>
<li>Goal: Maintain lean, informative chunks for efficient retrieval.</li>
</ul>
</section>
<section id="database" class="level3">
<h3 class="anchored" data-anchor-id="database">Database</h3>
<p>I am using sqlite for chunk storage as it’s built-in to the python standard library and contains a built-in full text search (FTS5). My database has a single table <code>fastbook</code> with a column <code>text</code> that has FTS5 enabled.</p>
<p>A typical query looks like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> fastbook</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> fastbook MATCH <span class="st">'keyword1 OR keyword2'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">rank</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">3</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<section id="why-bm25" class="level3">
<h3 class="anchored" data-anchor-id="why-bm25">Why BM25?</h3>
<p>Key inspirations for why I chose to establish a BM25 baseline:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="eugeneyan_bm25.png" class="lightbox" title="Eugene Yan Tweet" data-gallery="quarto-lightbox-gallery-2"><img src="eugeneyan_bm25.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Eugene Yan Tweet</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="simonw_bm25.png" class="lightbox" title="Simon Willison Tweet" data-gallery="quarto-lightbox-gallery-3"><img src="simonw_bm25.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Simon Willison Tweet</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="sh_reya_bm25.png" class="lightbox" title="Shreya Shankar Tweet" data-gallery="quarto-lightbox-gallery-4"><img src="sh_reya_bm25.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Shreya Shankar Tweet</figcaption><p></p>
</figure>
</div>
<p><br></p>
<blockquote class="blockquote">
<p>Humans love to use keywords. We have very strong tendencies to notice and use certain acronyms, domain-specific words, etc. To capture all this signal, you should ensure your pipeline uses Keyword search. An ongoing joke is that information retrieval has progressed slowly because BM25 is too strong a baseline. <em>(<a href="https://parlance-labs.com/education/rag/ben.html">Beyond the Basics of RAG by Benjamin Clavié</a>)</em>.</p>
</blockquote>
</section>
<section id="evaluation-set" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-set">Evaluation Set</h3>
<p>My evaluation set consists of:</p>
<ul>
<li>202 Questionnaire questions.</li>
<li>“Gold standard” solutions to the Questionnaire <a href="https://forums.fast.ai/t/fastbook-chapter-1-questionnaire-solutions-wiki/65647">published by fast.ai Leader Tanishq Abraham</a> who says:</li>
</ul>
<blockquote class="blockquote">
<p>my responses are based on what is supported by the chapter text</p>
</blockquote>
<p>(Which is perfect for my retrieval task.)</p>
</section>
<section id="evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-metrics">Evaluation Metrics</h3>
<p>Metrics: <strong>Score</strong> and <strong>Answer Rate</strong></p>
<p>The evaluation metric for each question, that I’m simply calling <strong>score</strong>, is binary: can the retrieved context answer the question (<code>1</code>) or not (<code>0</code>)? The evaluation metric across a set of questions, which I’m calling the <strong>Answer Rate</strong>, is the mean score for those questions.</p>
<p>While this is a straightforward pair of metrics, they do involve some judgment. After reading the retrieved context, I decide if it’s enough to answer the question. A capable LLM should be able to make the same kind of judgment about whether the context is helpful or not.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>Here are the names and descriptions of each full text search approach explored in this notebook. Top-n means the chunk(s) with the n-highest BM25 score(s).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-Paragraph Chunks</td>
</tr>
<tr class="even">
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-Paragraph Chunks</td>
</tr>
<tr class="odd">
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-Paragraph Chunks</td>
</tr>
<tr class="even">
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-Paragraph Chunks</td>
</tr>
<tr class="odd">
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-Paragraph Chunks</td>
</tr>
<tr class="even">
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-Paragraph Chunks</td>
</tr>
</tbody>
</table>
<section id="best-approach-per-chapter" class="level3">
<h3 class="anchored" data-anchor-id="best-approach-per-chapter">Best Approach per Chapter</h3>
<p>The following table shows name, description and <strong>Answer Rate</strong> for the best BM25 approach for each Chapter. BM25_F (Top-5 3-paragraph Chunks) was the best performing approach for each chapter and overall. For Chapter 2, BM25_E (Top-3 3-paragraph Chunks) had the same Answer Rate as BM25_F. For Chapter 10, BM25_C (Top-5 1-paragraph Chunks) had the same Answer Rate as BM25_F.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">90%</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_E/BM25_F</td>
<td style="text-align: center;">Top-3/Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">80.8%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">75%</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">65.5%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">79.3%</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_C/BM25_F</td>
<td style="text-align: center;">Top-5 1-paragraph/3-paragraph Chunks</td>
<td style="text-align: center;">61.9%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph Chunks</td>
<td style="text-align: center;">80%</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_F</strong></td>
<td style="text-align: center;"><strong>Top-5 3-paragraph Chunks</strong></td>
<td style="text-align: center;"><strong>76.7%</strong></td>
</tr>
</tbody>
</table>
</section>
<section id="all-approaches-for-all-chapters" class="level3">
<h3 class="anchored" data-anchor-id="all-approaches-for-all-chapters">All Approaches for All Chapters</h3>
<p>The following table shows the <strong>Answer Rate</strong> for all BM25 approaches for each chapter (where in the header, 1p = 1-paragraph chunks and 3p = 3-paragraph chunks).</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">BM25_A (Top-1 1p)</th>
<th style="text-align: center;">BM25_B (Top-3 1p)</th>
<th style="text-align: center;">BM25_C (Top-5 1p)</th>
<th style="text-align: center;">BM25_D (Top-1 3p)</th>
<th style="text-align: center;">BM25_E (Top-3 3p)</th>
<th style="text-align: center;">BM25_F (Top-5 3p)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">40% (12/30)</td>
<td style="text-align: center;">56.7% (17/30)</td>
<td style="text-align: center;">60% (18/30)</td>
<td style="text-align: center;">63.3% (19/30)</td>
<td style="text-align: center;">83.3% (25/30)</td>
<td style="text-align: center;">90% (27/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">38.5% (10/26)</td>
<td style="text-align: center;">65.4% (17/26)</td>
<td style="text-align: center;">69.2% (18/26)</td>
<td style="text-align: center;">46.2% (12.26)</td>
<td style="text-align: center;">80.8% (21/26)</td>
<td style="text-align: center;">80.8% (21/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">25% (8/32)</td>
<td style="text-align: center;">68.8% (22/32)</td>
<td style="text-align: center;">71.9% (23/32)</td>
<td style="text-align: center;">31.3% (10/32)</td>
<td style="text-align: center;">71.9% (23/32)</td>
<td style="text-align: center;">75% (24/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">13.8% (4/29)</td>
<td style="text-align: center;">34.5% (10/29)</td>
<td style="text-align: center;">44.8% (13/29)</td>
<td style="text-align: center;">31% (9/29)</td>
<td style="text-align: center;">55.2% (16/29)</td>
<td style="text-align: center;">65.5% (19/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">13.8% (4/29)</td>
<td style="text-align: center;">48.3% (14/29)</td>
<td style="text-align: center;">58.6% (17/29)</td>
<td style="text-align: center;">34.5% (10/29)</td>
<td style="text-align: center;">72.4% (21/29)</td>
<td style="text-align: center;">79.3% (23/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">47.6% (12/21)</td>
<td style="text-align: center;">42.9% (9/21)</td>
<td style="text-align: center;">61.9% (13/21)</td>
<td style="text-align: center;">38% (8/21)</td>
<td style="text-align: center;">57.1% (12/21)</td>
<td style="text-align: center;">61.9% (13/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">37.1% (13/35)</td>
<td style="text-align: center;">54.3% (19/35)</td>
<td style="text-align: center;">60% (21/35)</td>
<td style="text-align: center;">42.9% (15/35)</td>
<td style="text-align: center;">68.6% (24/35)</td>
<td style="text-align: center;">80% (28/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>30.2% (61/202)</strong></td>
<td style="text-align: center;"><strong>53.5% (108/202)</strong></td>
<td style="text-align: center;"><strong>60.9% (123/202)</strong></td>
<td style="text-align: center;"><strong>41.1% (83/202)</strong></td>
<td style="text-align: center;"><strong>70.3% (142/202)</strong></td>
<td style="text-align: center;"><strong>76.7% (155/202)</strong></td>
</tr>
</tbody>
</table>
<p>A few observations when looking at the <strong>Answer Rate</strong> for each approach for each chapter:</p>
<ul>
<li><p><strong>Increasing the number of chunks retrieved generally improves the quality of information retrieved</strong>:</p>
<ul>
<li>1-paragraph chunks
<ul>
<li>For all but Chapter 10, the Answer Rate improves: BM25_C &gt; BM25_B &gt; BM25_A.</li>
</ul></li>
<li>3-paragraph chunks
<ul>
<li>For all chapters the Answer Rate improves or stays the same (Chapter 2): BM25_F &gt;= BM25_E &gt; BM25_D</li>
</ul></li>
</ul></li>
<li><p><strong>Increasing the chunk size generally improves the quality of information retrieved</strong>: For 6 out of 7 chapters (all but Chapter 10), the 3-paragraph chunk Answer Rate (BM25_D, BM25_E, BM25_F) is greater than the corresponding 1-paragraph chunk Answer Rate (BM25A, BM25_B, BM25_C).</p></li>
<li><p><strong>Not all chapters behave the same</strong>: The Chapter 1 Questionnaire has a higher Answer Rate after increasing chunk size to 3-paragraphs (BM25_C: 60%, BM25_D: 63.3%). On the other extreme, for Chapter 10, increasing the chunk size to 3-paragraphs (BM25_D, 38%) performs worse than the worst-performing 1-paragraph approach (BM25_B, 42.9%). Chapter 10 is also an anomaly within 1-paragraph results: the Answer Rate for Top-3 (BM25_B, 42.9%) is less than Top-1 (BM25_A, 47.6%) while for every other chapter, BM25_A &gt; BM25_B. For 3-paragraph chunks, Chapter 2’s Answer Rate doesn’t improve like the other chapters from Top-3 (BM25_E: 80.8%) to Top-5 (BM25_F: 80.8%).</p></li>
<li><p><strong>Changing the data in the database changes the corpus-wide statistics</strong>: In sqlite, BM25 is calculated using corpus-wide statistics. If the data changes, the calculation changes. I noticed a significant improvement in the quality of context retrieved for 3-paragraph chunks when compared to 1-paragraph chunks (sometimes even the first chunk was different for the same question).</p></li>
</ul>
<p>Performance varied across chapters due to differences in content and question types:</p>
<ul>
<li>Chapter 1 (best performer, 90% with BM25_F) is introductory, defining many terms well-suited for keyword search.</li>
<li>Chapter 10 (worst performer, 61.9% with BM25_F)
<ul>
<li>Had the fewest questions (21), which are less granular than other chapters. Each missed question was a ~5% Answer Rate hit.</li>
<li>Retrieved contexts often contained relevant keywords but lacked direct answers.</li>
</ul></li>
<li>Chapter 8 (second-worst) faced challenges with:
<ul>
<li>Ambiguous questions (e.g., “How does it solve it?”).</li>
<li>Technical terms (e.g., function names) rare in explanatory text but common in code chunks.</li>
<li>Overuse of certain terms (e.g., “latent factor”) diluting relevance.</li>
</ul></li>
</ul>
</section>
<section id="question-level-analysis" class="level3">
<h3 class="anchored" data-anchor-id="question-level-analysis">Question-Level Analysis</h3>
<p>Looking at the question-level data offers some additional insights.</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://gist.githubusercontent.com/vishalbakshi/4379c92665695b8bd9ab83a1f3ab6b55/raw/97a22f0736b5e179efb8c9d70e5ec80a5b8f4817/fastbookRAG_bm25_all.csv'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>score_columns <span class="op">=</span> df.<span class="bu">filter</span>(regex<span class="op">=</span><span class="st">'_score$'</span>).columns</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'total_score'</span>] <span class="op">=</span> df[score_columns].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="distribution-of-scores" class="level4">
<h4 class="anchored" data-anchor-id="distribution-of-scores">Distribution of Scores</h4>
<p>Here are my takeaways from the distribution of scores:</p>
<ul>
<li>Bimodal Distribution
<ul>
<li>Approximately 50 questions (about 25% of the total) were successfully answered by all six full text search methods (a total score of <code>6</code>).</li>
<li>On the other hand, around 40 questions (about 20%) couldn’t be answered by any method, resulting in a total score of <code>0</code>.</li>
</ul></li>
<li>Uniform Mid-Range Performance
<ul>
<li>Questions answered by 2, 3, 4, or 5 methods each accounted for 20-30 instances, showing a relatively even distribution in this middle range.</li>
</ul></li>
<li>Least Common Outcome
<ul>
<li>Only 10 questions were answered by just one method, making this the least frequent result.</li>
</ul></li>
</ul>
<div class="cell" data-outputid="9d61fa57-78d5-4df6-d248-7ff810898ef5" data-execution_count="58">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'total_score'</span>].hist(bins<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">8</span>), align<span class="op">=</span><span class="st">'left'</span>, rwidth<span class="op">=</span><span class="fl">0.8</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of Total Scores'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Total Score'</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Questions'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-3-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="average-score-per-question" class="level4">
<h4 class="anchored" data-anchor-id="average-score-per-question">Average Score Per Question</h4>
<p>On average, each question was answered by 3 to 4 full text search methods.</p>
<div class="cell" data-outputid="2b7739eb-e4bb-45ee-e0bb-757e3137b1fe" data-execution_count="9">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'total_score'</span>].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>total_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>202.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>3.326733</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.190476</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>5.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>6.000000</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> float64</label>
</div>
</div>
</section>
<section id="unanswered-questions" class="level4">
<h4 class="anchored" data-anchor-id="unanswered-questions">Unanswered Questions</h4>
<p>There were 39 questions for which none of the full text search approaches retrieved the context needed to answer them:</p>
<div class="cell" data-outputid="36a199d9-451d-46a2-b1c9-22300d5109f1" data-execution_count="83">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>no_answer <span class="op">=</span> df.query(<span class="st">"total_score == 0"</span>)[[<span class="st">'chapter'</span>, <span class="st">'question_number'</span>, <span class="st">'question_text'</span>, <span class="st">'answer'</span>, <span class="st">'keywords'</span>]].drop_duplicates()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>no_answer.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>(39, 5)</code></pre>
</div>
</div>
<p>For example, the following question never was fully answered by any of the contexts retrieved by the full text search methods.</p>
<div class="cell" data-outputid="22ec53ce-8206-4feb-fb44-f6bbf7544425" data-execution_count="84">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">0</span>][<span class="st">'question_text'</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">0</span>][<span class="st">'answer'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>""What were the two theoretical misunderstandings that held back the field of neural networks?""
""In 1969, Marvin Minsky and Seymour Papert demonstrated in their book, "Perceptrons", that a single layer of artificial neurons cannot learn simple, critical mathematical functions like XOR logic gate. While they subsequently demonstrated in the same book that additional layers can solve this problem, only the first insight was recognized, leading to the start of the first AI winter.
In the 1980's, models with two layers were being explored. Theoretically, it is possible to approximate any mathematical function using two layers of artificial neurons. However, in practices, these networks were too big and too slow. While it was demonstrated that adding additional layers improved performance, this insight was not acknowledged, and the second AI winter began. In this past decade, with increased data availability, and improvements in computer hardware (both in CPU performance but more importantly in GPU performance), neural networks are finally living up to its potential.""</code></pre>
</div>
</div>
<p>There were two paragraphs from Chapter 1 that answered this question (emphasis mine). None of the full text search methods retrieved both of these paragraphs (some included 1 of the 2 needed paragraphs):</p>
<blockquote class="blockquote">
<p>An MIT professor named Marvin Minsky (who was a grade behind Rosenblatt at the same high school!), along with Seymour Papert, wrote a book called Perceptrons (MIT Press), about Rosenblatt’s invention. They showed that a single layer of these devices was unable to learn some simple but critical mathematical functions (such as XOR). In the same book, they also showed that using multiple layers of the devices would allow these limitations to be addressed. <strong>Unfortunately, only the first of these insights was widely recognized. As a result, the global academic community nearly entirely gave up on neural networks for the next two decades.</strong></p>
</blockquote>
<blockquote class="blockquote">
<p>In the 1980’s most models were built with a second layer of neurons, thus avoiding the problem that had been identified by Minsky and Papert (this was their “pattern of connectivity among units,” to use the framework above). And indeed, neural networks were widely used during the ’80s and ’90s for real, practical projects. <strong>However, again a misunderstanding of the theoretical issues held back the field. In theory, adding just one extra layer of neurons was enough to allow any mathematical function to be approximated with these neural networks, but in practice such networks were often too big and too slow to be useful.</strong></p>
</blockquote>
<p>Some questions were not so straightforward to answer. For example, the following question:</p>
<div class="cell" data-outputid="1fa38eee-e985-4f75-ab6d-329aceddefe4" data-execution_count="81">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'question_text'</span>])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'answer'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>""What are the three statistics plotted by plot_layer_stats? What does the x-axis represent?""
""The mean and standard deviation of the activations, as well as the percentage of activation near zero. The x-axis represents the progress of training (batch number).""</code></pre>
</div>
</div>
<p>The first part of this question is answerable by the following context from the fastbook (emphasis mine), which some of the full text search methods successfully retrieved:</p>
<blockquote class="blockquote">
<p><code>ActivationStats</code> includes some handy utilities for plotting the activations during training. <strong><code>plot_layer_stats(idx)</code> plots the mean and standard deviation of the activations of layer number <code>idx</code>, along with the percentage of activations near zero.</strong> Here’s the first layer’s plot:</p>
</blockquote>
<p>The second part of the question (<em>What does the x-axis represent?</em>) is not explicitly answered in the fastbook. I will consider removing this question from my evals.</p>
<p>For some questions the full text search methods simply did not retrieve the necessary paragraph. For example:</p>
<div class="cell" data-outputid="b9a65bda-253c-4267-f564-29dcdcc59803" data-execution_count="80">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">10</span>][<span class="st">'question_text'</span>])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">10</span>][<span class="st">'answer'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>""What is the function to calculate new weights using a learning rate?""
""The optimizer step function""</code></pre>
</div>
</div>
<p>This question is answered by the following paragraphs which none of the methods retrieved for this question (emphasis mine):</p>
<blockquote class="blockquote">
<p>Deciding how to change our parameters based on the values of the gradients is an important part of the deep learning process. Nearly all approaches start with the basic idea of multiplying the gradient by some small number, called the learning rate (LR). The learning rate is often a number between 0.001 and 0.1, although it could be anything. Often, people select a learning rate just by trying a few, and finding which results in the best model after training (we’ll show you a better approach later in this book, called the learning rate finder). Once you’ve picked a learning rate, you can adjust your parameters using this simple function:</p>
<p><code>w -= gradient(w) * lr</code></p>
<p><strong>This is known as stepping your parameters, using an optimizer step.</strong></p>
</blockquote>
<p>For some of the questions, I’m not quite sure why the associated keywords didn’t allow the correct chunk retrieval. I would assume the reason is that other chunks had a higher frequency of those keywords than these chunks. Something I’ll look into when I do a deeper dive into error analysis in my next notebook.</p>
<div class="cell" data-outputid="af90a9eb-d899-4941-e35b-21780f4b757c" data-execution_count="85">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">5</span>][<span class="st">'question_text'</span>])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">5</span>][<span class="st">'answer'</span>])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(no_answer.iloc[<span class="dv">5</span>][<span class="st">'keywords'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>""What are the three steps in the deployment process?""
""Manual process - the model is run in parallel and not directly driving any actions, with humans still checking the model outputs.
Limited scope deployment - The model's scope is limited and carefully supervised. For example, doing a geographically and time-constrained trial of model deployment, that is carefully supervised.
Gradual expansion - The model scope is gradually increased, while good reporting systems are implemented in order to check for any significant changes to the actions taken compared to the manual process (i.e. the models should perform similarly to the humans, unless it is already anticipated to be better).""
"deployment, process, steps"</code></pre>
</div>
</div>
<p>Here’s the correct chunks (emphasis mine) that none of the methods retrieved:</p>
<blockquote class="blockquote">
<p>Where possible, the first step is to use an entirely <strong>manual process</strong>, with your deep learning model approach running in parallel but not being used directly to drive any actions. The humans involved in the manual process should look at the deep learning outputs and check whether they make sense. For instance, with our bear classifier a park ranger could have a screen displaying video feeds from all the cameras, with any possible bear sightings simply highlighted in red. The park ranger would still be expected to be just as alert as before the model was deployed; the model is simply helping to check for problems at this point.</p>
<p>The second step is to try to <strong>limit the scope of the model</strong>, and have it carefully supervised by people. For instance, do a small geographically and time-constrained trial of the model-driven approach. Rather than rolling our bear classifier out in every national park throughout the country, we could pick a single observation post, for a one-week period, and have a park ranger check each alert before it goes out.</p>
<p>Then, <strong>gradually increase the scope of your rollout</strong>. As you do so, ensure that you have really good reporting systems in place, to make sure that you are aware of any significant changes to the actions being taken compared to your manual process. For instance, if the number of bear alerts doubles or halves after rollout of the new system in some location, we should be very concerned. Try to think about all the ways in which your system could go wrong, and then think about what measure or report or picture could reflect that problem, and ensure that your regular reporting includes that information.</p>
</blockquote>
</section>
<section id="questions-with-100-answer-rate" class="level4">
<h4 class="anchored" data-anchor-id="questions-with-100-answer-rate">Questions with 100% Answer Rate</h4>
<p>There were 49 questions that were answered by all 6 full text search methods.</p>
<div class="cell" data-outputid="1b3c732e-4740-437c-a08a-7bb2a4106fdf" data-execution_count="51">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>all_answer <span class="op">=</span> df.query(<span class="st">"total_score == 6"</span>)[[<span class="st">'chapter'</span>, <span class="st">'question_number'</span>, <span class="st">'question_text'</span>, <span class="st">'keywords'</span>]].drop_duplicates()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>all_answer.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(49, 4)</code></pre>
</div>
</div>
<p>Many of these questions involved a keyword or its definition—a perfect use case for full text search:</p>
<div class="cell" data-outputid="d995b9b8-f974-4784-bd38-a5f0ab62564c" data-execution_count="52">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">1</span>][<span class="st">'question_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>'""What is a GPU?""'</code></pre>
</div>
</div>
<div class="cell" data-outputid="fc21368f-da92-4e88-d7cd-42001691a7f2" data-execution_count="30">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">2</span>][<span class="st">'question_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>'""What term do we normally use in deep learning for what Samuel called ""weights""?""'</code></pre>
</div>
</div>
<div class="cell" data-outputid="e0cb882e-1a8b-4b86-f997-73817cc3d0bd" data-execution_count="32">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">15</span>][<span class="st">'question_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>'""What are IPython widgets?""'</code></pre>
</div>
</div>
<div class="cell" data-outputid="a868b7e0-de6e-432a-88fd-af22c5739567" data-execution_count="41">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">3</span>][<span class="st">'question_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>'""What is the name of the theorem that shows that a neural network can solve any mathematical problem to any level of accuracy?""'</code></pre>
</div>
</div>
<div class="cell" data-outputid="fc3739af-0c1b-4e34-dd04-2e80b81a0fab" data-execution_count="49">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">9</span>][<span class="st">'question_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>'""What is y_range used for? When do we need it?""'</code></pre>
</div>
</div>
<p>Some of these questions were more open-ended, but involved certain keywords that were used verbatim in the fastbook chunk that answered the question, such as “AI”, “organizations” and “failures”:</p>
<div class="cell" data-outputid="1e166dc5-56d1-4882-f5c6-c58d6f1e582c" data-execution_count="53">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="dv">10</span>][<span class="st">'question_text'</span>], all_answer.iloc[<span class="dv">10</span>][<span class="st">'keywords'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>('""What\'s the best way to avoid failures when using AI in an organization?""',
 '"AI, failures, avoid, organization, organizations"')</code></pre>
</div>
</div>
<p>Here is the context that answered this question (emphasis mine):</p>
<blockquote class="blockquote">

</blockquote>
<blockquote class="blockquote">
<p>To put it bluntly, if you’re a senior decision maker in your <strong>organization</strong> (or you’re advising senior decision makers), the most important takeaway is this: if you ensure that you really understand what test and validation sets are and why they’re important, then you’ll avoid the single biggest source of <strong>failures</strong> we’ve seen when <strong>organizations</strong> decide to use <strong>AI</strong>. For instance, if you’re considering bringing in an external vendor or service, make sure that you hold out some test data that the vendor never gets to see. Then you check their model on your test data, using a metric that you choose based on what actually matters to you in practice, and you decide what level of performance is adequate. (It’s also a good idea for you to try out some simple baseline yourself, so you know what a really simple model can achieve. Often it’ll turn out that your simple model performs just as well as one produced by an external “expert”!)</p>
</blockquote>
<p>The following question has the terms “batch”, “normalization”, “layers” and “generalize”:</p>
<div class="cell" data-outputid="558b4479-fa96-47e5-99d4-d1c32e595ca1" data-execution_count="54">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'question_text'</span>], all_answer.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'keywords'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>('""Why do models with batch normalization layers generalize better?""',
 '"models, batch, normalization, layers, generalization, generalize"')</code></pre>
</div>
</div>
<p>The corresponding context (emphasis mine) contains those keywords verbatim:</p>
<blockquote class="blockquote">
<p>An interesting observation about models containing <strong>batch normalization layers</strong> is that they tend to <strong>generalize</strong> better than models that don’t contain them. Although we haven’t as yet seen a rigorous analysis of what’s going on here, most researchers believe that the reason for this is that batch normalization adds some extra randomness to the training process.</p>
</blockquote>
<p>The following question has the keywords “statistics”, “normalize”, “batch”, “training” and “validation” that are all contained in the corresponding fastbook chunk, some multiple times:</p>
<div class="cell" data-outputid="aeb8f7d1-b9ce-4850-b9bd-55bedb6cc394" data-execution_count="55">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>all_answer.iloc[<span class="op">-</span><span class="dv">2</span>][<span class="st">'question_text'</span>], all_answer.iloc[<span class="op">-</span><span class="dv">2</span>][<span class="st">'keywords'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>('""What statistics are used to normalize in batch normalization during training? How about during validation?""',
 '"statistics, normalize, batch, normalization, training, validation"')</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>That’s why our activations can have any mean or variance, independent from the mean and standard deviation of the results of the previous layer. Those <strong>statistics</strong> are learned separately, making <strong>training</strong> easier on our model. The behavior is different during training and <strong>validation</strong>: during <strong>training</strong>, we use the mean and standard deviation of the <strong>batch</strong> to <strong>normalize</strong> the data, while during <strong>validation</strong> we instead use a running mean of the <strong>statistics</strong> calculated during <strong>training</strong>.</p>
</blockquote>
</section>
</section>
<section id="results-csv" class="level3">
<h3 class="anchored" data-anchor-id="results-csv">Results CSV</h3>
<p>The retrieved contexts and my manually assigned scores for each question and baseline are available in <a href="https://gist.githubusercontent.com/vishalbakshi/4379c92665695b8bd9ab83a1f3ab6b55/raw/97a22f0736b5e179efb8c9d70e5ec80a5b8f4817/fastbookRAG_bm25_all.csv">this public gist</a>.</p>
</section>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>There are a number of limitations that I want to highlight in this work:</p>
<ul>
<li><strong>Limited methods:</strong> There are inumerable combinations of chunk strategies and top-n retrieval choices. I chose the six (1-paragraph/3-paragraph and Top-1/Top-3/Top-5) that seemed easy to implement, reasonable to accomplish in my desired timeline and reasonably provided me with a diverse set of results.</li>
<li><strong>Limited scope</strong>: I’m only considering the 202 questions in the end-of-chapter Questionnaires whose answer was explicitly in the fastbook text. There are endless questions about the topics covered in the fastbook. I only focused on the 7 chapters covered in Part 1 of the fastai course (as I am still in progress with Part 2). A more general-purpose QA task for deep learning and machine learning would likely require a different set of evals.</li>
<li><strong>I only used sqlite</strong>: There are other databases and BM25 implementations that may provide different results.</li>
<li><strong>Limited keyword iterations</strong>: I used <a href="https://vishalbakshi.github.io/blog/posts/2024-08-27-fastbookRAG-claude-keywords/">five different prompts</a> to generate keywords for each question using the <code>claude-3-5-sonnet-20240620</code> model. After achieving a comparable Answer Rate with my manually written keywords for Chapter 1 (40%) I stopped iterating. Keywords are a critical component to full text search, so improving on them further would likely improve my results.</li>
<li><strong>I used my own judgment</strong>: I had to use my judgment to determine whether the retrieved context was sufficient for answering the given question. This is a fuzzy evaluation method.</li>
<li><strong>I used the official Questionnaire solutions</strong>: There is room for interpretation when answering open-ended questions. I chose to strictly follow the “gold standard” answers provided in the course Forums.</li>
</ul>
</section>
<section id="future-work" class="level2">
<h2 class="anchored" data-anchor-id="future-work">Future Work</h2>
<p>Each of the limitations provides an opportunity for future work:</p>
<ul>
<li>Experiment with different chunking strategies and observe their impact on retrieval performance.</li>
<li>Expanding the eval set to include more chapters and question types.</li>
<li>Experiment with different database and BM25 implementations to observe any noticeable differences in performance.</li>
<li>Iterating on keyword generation using different LLMs and prompts to further improve the Answer Rate.</li>
<li><strong>Integrate an LLM to replace my own judgment in the pipeline</strong> (something that I’ll be doing as part of the broader fastbookRAG project).</li>
<li><strong>Conducting a deep dive into error analysis</strong> to understand why certain questions weren’t answerable (something I’ll do before I conduct any further experiments).</li>
<li><strong>Removing questions from my evals that do not have explicit answers</strong> in the chapter text (something I’ll do before I conduct any further experiments).</li>
<li>Developing my own set of standardized answers (with the use of an LLM) for each question to ensure consistency.</li>
</ul>
</section>
<section id="experiments" class="level2">
<h2 class="anchored" data-anchor-id="experiments">Experiments</h2>
<p>Expand the following cells to view the code used for each experiment.</p>
<section id="helper-functions" class="level3">
<h3 class="anchored" data-anchor-id="helper-functions">Helper Functions</h3>
<div class="cell" data-execution_count="69">
<details>
<summary>Show imports</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="70">
<details>
<summary>Show chunking code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_chunks(notebook_path):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(notebook_path, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        notebook <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> []</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    current_header <span class="op">=</span> <span class="st">""</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_chunk(content):</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content.strip():</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            chunks.append(<span class="ss">f"</span><span class="sc">{</span>current_header<span class="sc">}</span><span class="ch">\n\n</span><span class="sc">{</span>content<span class="sc">.</span>strip()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cell <span class="kw">in</span> notebook[<span class="st">'cells'</span>]:</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cell[<span class="st">'cell_type'</span>] <span class="op">==</span> <span class="st">'markdown'</span>:</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> <span class="st">''</span>.join(cell[<span class="st">'source'</span>])</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># see if the cell starts with a markdown header</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>            header_match <span class="op">=</span> re.match(<span class="vs">r'^(#+\s+.*?)$'</span>, content, re.MULTILINE)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> header_match:</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># grab the header</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>                current_header <span class="op">=</span> header_match.group(<span class="dv">1</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># add any content after the header in the same cell</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                remaining_content <span class="op">=</span> content[<span class="bu">len</span>(current_header):].strip()</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> remaining_content:</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># split content into paragraphs</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                    paragraphs <span class="op">=</span> re.split(<span class="vs">r'\n\s*\n'</span>, remaining_content)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># append the paragraph to the list of chunks</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> paragraph <span class="kw">in</span> paragraphs:</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                        add_chunk(paragraph)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                <span class="co"># split content into paragraphs</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                paragraphs <span class="op">=</span> re.split(<span class="vs">r'\n\s*\n'</span>, content)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>                <span class="co"># append the paragraph to the list of chunks</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> paragraph <span class="kw">in</span> paragraphs:</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                    add_chunk(paragraph)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> cell[<span class="st">'cell_type'</span>] <span class="op">==</span> <span class="st">'code'</span>:</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>          code_content <span class="op">=</span> <span class="st">'```python</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> <span class="st">''</span>.join(cell[<span class="st">'source'</span>]) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">```'</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>          <span class="co"># include the output of the code cell</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>          output_content <span class="op">=</span> <span class="st">''</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'outputs'</span> <span class="kw">in</span> cell <span class="kw">and</span> cell[<span class="st">'outputs'</span>]:</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> output <span class="kw">in</span> cell[<span class="st">'outputs'</span>]:</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> <span class="st">'text'</span> <span class="kw">in</span> output:</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>                      output_content <span class="op">+=</span> <span class="st">''</span>.join(output[<span class="st">'text'</span>])</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">elif</span> <span class="st">'data'</span> <span class="kw">in</span> output <span class="kw">and</span> <span class="st">'text/plain'</span> <span class="kw">in</span> output[<span class="st">'data'</span>]:</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>                      output_content <span class="op">+=</span> <span class="st">''</span>.join(output[<span class="st">'data'</span>][<span class="st">'text/plain'</span>])</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>          <span class="co"># combine code and output in the same chunk</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>          combined_content <span class="op">=</span> code_content <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">Output:</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> output_content <span class="cf">if</span> output_content <span class="cf">else</span> code_content</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>          add_chunk(combined_content)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> filter_chunks(chunks, exclude_headers<span class="op">=</span>[<span class="st">"Questionnaire"</span>, <span class="st">"Further Research"</span>]):</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>      filtered_chunks <span class="op">=</span> []</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>          lines <span class="op">=</span> chunk.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>          <span class="co"># check if the first line (header) is in the exclude list</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(header <span class="kw">in</span> lines[<span class="dv">0</span>] <span class="cf">for</span> header <span class="kw">in</span> exclude_headers):</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>              filtered_chunks.append(chunk)</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> filtered_chunks</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filter_chunks(chunks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="71">
<details>
<summary>Show the <code>load_data</code> function</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(chunks, db_path, chapter<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create virtual table if database doesn't exist</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(db_path):</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(db_path) <span class="im">as</span> conn:</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>              cur <span class="op">=</span> conn.cursor()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>              cur.execute(<span class="st">"""</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="st">              CREATE VIRTUAL TABLE fastbook_text</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="st">              USING FTS5(chapter, text);</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="st">              """</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>              conn.commit()</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># load in the chunks for each chapter</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(db_path) <span class="im">as</span> conn:</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            cur <span class="op">=</span> conn.cursor()</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                cur.execute(<span class="st">"INSERT INTO fastbook_text(chapter, text) VALUES (?, ?)"</span>, (chapter, chunk))</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            conn.commit()</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            res <span class="op">=</span> cur.execute(<span class="st">"SELECT * FROM fastbook_text WHERE chapter = ?"</span>, (chapter,)).fetchall()</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make sure all the data was loaded into the database</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(res) <span class="op">!=</span> <span class="bu">len</span>(chunks):</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Number of inserted chunks (</span><span class="sc">{</span><span class="bu">len</span>(res)<span class="sc">}</span><span class="ss">) doesn't match input chunks (</span><span class="sc">{</span><span class="bu">len</span>(chunks)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> sqlite3.Error <span class="im">as</span> e:</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="72">
<details>
<summary>Show the <code>db_search</code> function</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> db_search(df, limit<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  results <span class="op">=</span> []</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(<span class="st">'fastbook.db'</span>) <span class="im">as</span> conn:</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> conn.cursor()</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># concatenate the keywords into a string "keyword1 OR keyword 2 OR keyword3 ..."</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      keywords <span class="op">=</span> <span class="st">' OR '</span>.join([<span class="ss">f'"</span><span class="sc">{</span>keyword<span class="sc">.</span>strip(<span class="st">","</span>)<span class="sc">}</span><span class="ss">"'</span> <span class="cf">for</span> keyword <span class="kw">in</span> row[<span class="st">'keywords'</span>].replace(<span class="st">'"'</span>, <span class="st">''</span>).split()])</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>      q <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT text, rank</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM fastbook_text</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        WHERE fastbook_text MATCH ?</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        AND chapter = ?</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="ss">        ORDER BY rank</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="ss">        LIMIT ?</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> cur.execute(q, (keywords, <span class="bu">str</span>(row[<span class="st">'chapter'</span>]), limit)).fetchall()</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># grab the retrieved chunk from the query results</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> [item[<span class="dv">0</span>] <span class="cf">for</span> item <span class="kw">in</span> res]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if there are multiple chunks retrieved, combine them into a single string</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> limit <span class="op">==</span> <span class="dv">1</span>: results.extend(res)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>: results.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(res))</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-preprocessing-1" class="level3">
<h3 class="anchored" data-anchor-id="data-preprocessing-1">Data Preprocessing</h3>
<p>You can download the notebooks from the <a href="https://github.com/fastai/fastbook/tree/master">fastbook repo</a> or run the following cell to download them.</p>
<div class="cell">
<details>
<summary>Show the file download</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>urls <span class="op">=</span> {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'01_intro.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1mmBjFH_plndPBC4iRZHChfMazgBxKK4_'</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'02_production.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1Cf5QHthHy1z13H0iu3qrzAWgquCfqVHk'</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'04_mnist_basics.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=113909_BNulzyLIKUNJHdya0Hhoqie30I'</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'08_collab.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1BtvStgFjUtvtqbSZNrL7Y2N-ey3seNZU'</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'09_tabular.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1rHFvwl_l-AJLg_auPjBpNrOgG9HDnfqg'</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10_nlp.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1pg1pH7jMMElzrXS0kBBz14aAuDsi2DEP'</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'13_convolutions.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=19P-eEHpAO3WrOvdxgXckyhHhfv_R-hnS'</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_file(url, filename):</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send a GET request to the URL</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the request was successful</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the file in write-binary mode</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">'wb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the content of the response to the file</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(response.content)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File downloaded successfully: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to download file. Status code: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fname, url <span class="kw">in</span> urls.items():</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  download_file(url, fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I have seven notebooks in total. I’ll start by using <code>get_chunks</code> to split the notebook content into paragraphs (with the corresponding header).</p>
<div class="cell" data-execution_count="67">
<details>
<summary>Show the dict w/ notebook filenames</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>nbs <span class="op">=</span> {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'1'</span>: <span class="st">'01_intro.ipynb'</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2'</span>: <span class="st">'02_production.ipynb'</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'4'</span>: <span class="st">'04_mnist_basics.ipynb'</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'8'</span>: <span class="st">'08_collab.ipynb'</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'9'</span>: <span class="st">'09_tabular.ipynb'</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10'</span>: <span class="st">'10_nlp.ipynb'</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'13'</span>: <span class="st">'13_convolutions.ipynb'</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chunking each notebook</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, nb <span class="kw">in</span> nbs.items():</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> get_chunks(nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll print out the length of the total chunks so I get a sense of how many unique chunks there are:</p>
<div class="cell" data-outputid="21a0c802-fd54-47b4-e21b-bc7793c1b685" data-execution_count="74">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">==</span> <span class="dv">1967</span> <span class="co"># 1-paragraph chunks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 307
2 227
4 433
8 157
9 387
10 190
13 266</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>True</code></pre>
</div>
</div>
<p>Since my entire pipeline depends on the content of these chunks, I’ll save each notebook’s chunks into a text file and compared it with the original <a href="https://github.com/fastai/fastbook/tree/master">fastbook repo</a> and made sure that all of the headers were captured.</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_chunks(chunks, filename):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(chunk <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  save_chunks(chunks, <span class="ss">f'</span><span class="sc">{</span>nbs[chapter]<span class="sc">}</span><span class="ss">.txt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-the-chunks-into-the-database" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-chunks-into-the-database">Loading the Chunks into the Database</h3>
<div class="cell" data-outputid="223a1038-ad23-46ab-fc41-f4b3066323e1" data-execution_count="13">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"Chapter </span><span class="sc">{</span>chapter<span class="sc">}</span><span class="ss">:"</span>, load_data(chunks, <span class="st">'fastbook.db'</span>, chapter))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True</code></pre>
</div>
</div>
<p>Just to be sure, I’ll query the database to get each chapter’s chunks, export them to text files and review them once more.</p>
<div class="cell" data-outputid="a3a8618b-532b-455e-b39b-af8a782ee566" data-execution_count="14">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter <span class="kw">in</span> data.keys():</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(<span class="st">'fastbook.db'</span>) <span class="im">as</span> conn:</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> conn.cursor()</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> cur.execute(<span class="st">"SELECT text FROM fastbook_text WHERE chapter = ?"</span>, (chapter,)).fetchall()</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> [item[<span class="dv">0</span>] <span class="cf">for</span> item <span class="kw">in</span> res]</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save_chunks(chunks, f'{chapter}.txt')</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">==</span> <span class="dv">1967</span> <span class="co"># 1-paragraph chunks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>True</code></pre>
</div>
</div>
</section>
<section id="load-the-question-data" class="level3">
<h3 class="anchored" data-anchor-id="load-the-question-data">Load the Question Data</h3>
<p>I have saved each chapter’s questions, answer, and Claude-3.5-Sonnet-generated keywords in <a href="https://gist.github.com/vishalbakshi/309fb3abb222d32446b2c4e29db753fe">this gist</a>.</p>
<div class="cell" data-outputid="d8e73526-4a16-43c0-f12b-72931f46223e" data-execution_count="9">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://gist.githubusercontent.com/vishalbakshi/309fb3abb222d32446b2c4e29db753fe/raw/11aab9462df445705b643be361b7c4d7d54ef77b/fastbookRAG_evals.csv'</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>questions <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>questions.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">


  <div id="df-fa022481-d34c-4cf8-af70-3c8df1479e1f" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-fa022481-d34c-4cf8-af70-3c8df1479e1f')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-fa022481-d34c-4cf8-af70-3c8df1479e1f button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-fa022481-d34c-4cf8-af70-3c8df1479e1f');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-87550523-f157-4a11-9042-fc9b371fd4a5">
  <button class="colab-df-quickchart" onclick="quickchart('df-87550523-f157-4a11-9042-fc9b371fd4a5')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-87550523-f157-4a11-9042-fc9b371fd4a5 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="a8f6488f-1cf4-43aa-a0e3-a892a2b5b4c3" data-execution_count="10">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>questions.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(202, 6)</code></pre>
</div>
</div>
<p>With the preprocessing steps complete, I can run my experiments!</p>
</section>
<section id="bm25_a-top-1-1-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm25_a-top-1-1-paragraph-chunks">BM25_A: Top-1 1-Paragraph Chunks</h3>
<p>In this approach, I’ll select the top-1 retrieved context (1-paragraph chunk) for each question’s keywords and calculate the <strong>Answer Rate</strong>. As a reminder, the evaluation metric for each question, that I’m simply calling <strong>score</strong>, is binary: can the retrieved context answer the question (<code>1</code>) or not (<code>0</code>)? The evaluation metric across a set of questions, which I’m calling the <strong>Answer Rate</strong>, is the mean score for those questions.</p>
<p>It’s pretty awesome that is takes about a fifth of a second to retrieve chunks for 202 keyword searches.</p>
<div class="cell" data-outputid="78bc1622-3b64-4d71-df67-33c351ca1496">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 242 ms, sys: 3.7 ms, total: 246 ms
Wall time: 249 ms</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="9774bc0c-65a5-4e65-e459-688580008938">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>202</code></pre>
</div>
</div>
<div class="cell" data-outputid="c2131dba-a497-4469-efae-e5c18c8d931f">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>bm25_a <span class="op">=</span> questions.copy()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>bm25_a[<span class="st">'bm25_a_context'</span>] <span class="op">=</span> results</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>bm25_a.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">


  <div id="df-70fbd68d-0d40-4275-b1c1-39d8c668609f" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_a_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\n```asciido...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nHere's a l...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-70fbd68d-0d40-4275-b1c1-39d8c668609f')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-70fbd68d-0d40-4275-b1c1-39d8c668609f button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-70fbd68d-0d40-4275-b1c1-39d8c668609f');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-5629178b-0a21-4e12-bf32-58d69472f0d7">
  <button class="colab-df-quickchart" onclick="quickchart('df-5629178b-0a21-4e12-bf32-58d69472f0d7')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-5629178b-0a21-4e12-bf32-58d69472f0d7 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>bm25_a.to_csv(<span class="st">'bm25_a.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-1" class="level4">
<h4 class="anchored" data-anchor-id="results-1">Results</h4>
<p>Here is the <strong>Answer Rate</strong> (by chapter and overall).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">40% (12/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">38.5% (10/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">25% (8/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">13.8% (4/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">13.8% (4/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">47.6% (12/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_A</td>
<td style="text-align: center;">Top-1 1-paragraph chunks</td>
<td style="text-align: center;">37.1% (13/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_A</strong></td>
<td style="text-align: center;"><strong>Top-1 1-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>30.2% (61/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="bm25_b-top-3-1-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm25_b-top-3-1-paragraph-chunks">BM25_B: Top-3 1-Paragraph Chunks</h3>
<p>In this approach, I’ll select the top-3 retrieved context (1-paragraph chunks) for each question’s keywords and calculate the <strong>Answer Rate</strong>. As a reminder, the evaluation metric for each question, that I’m simply calling <strong>score</strong>, is binary: can the retrieved context answer the question (<code>1</code>) or not (<code>0</code>)? The evaluation metric across a set of questions, which I’m calling the <strong>Answer Rate</strong>, is the mean score for those questions.</p>
<p>I select the top-3 chunks by setting <code>LIMIT 3</code> in the sqlite query.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="93e28636-e07b-4a8a-d0da-222cdba1749f" data-execution_count="21">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">202</span> <span class="co"># top-3 chunks for all 202 questions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-outputid="092fc1a6-4f17-4e67-e9b6-b7a406fd960d" data-execution_count="26">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>bm25_b <span class="op">=</span> questions.copy()</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>bm25_b[<span class="st">'bm25_b_context'</span>] <span class="op">=</span> results</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>bm25_b.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">


  <div id="df-cb36a759-c03e-4699-936d-5b5c63f33d4d" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_b_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\n```asciido...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nHere's a l...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-cb36a759-c03e-4699-936d-5b5c63f33d4d')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-cb36a759-c03e-4699-936d-5b5c63f33d4d button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-cb36a759-c03e-4699-936d-5b5c63f33d4d');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-1177d9c9-41df-4e60-acb9-3162a7fa6282">
  <button class="colab-df-quickchart" onclick="quickchart('df-1177d9c9-41df-4e60-acb9-3162a7fa6282')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-1177d9c9-41df-4e60-acb9-3162a7fa6282 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>bm25_b.to_csv(<span class="st">'bm25_b.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-2" class="level4">
<h4 class="anchored" data-anchor-id="results-2">Results</h4>
<p>Here is the <strong>Answer Rate</strong> (by chapter and overall).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">56.7% (17/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">65.4% (17/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">68.8% (22/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">34.5% (10/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">41.4% (12/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">42.9% (9/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_B</td>
<td style="text-align: center;">Top-3 1-paragraph chunks</td>
<td style="text-align: center;">54.3% (19/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_B</strong></td>
<td style="text-align: center;"><strong>Top-3 1-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>53.5%(108/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="bm25_c-top-5-1-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm25_c-top-5-1-paragraph-chunks">BM25_C: Top-5 1-Paragraph Chunks</h3>
<p>In this approach, I’ll select the top-5 retrieved context (1-paragraph chunks) for each question’s keywords and calculate the <strong>Answer Rate</strong>. As a reminder, the evaluation metric for each question, that I’m simply calling <strong>score</strong>, is binary: can the retrieved context answer the question (<code>1</code>) or not (<code>0</code>)? The evaluation metric across a set of questions, which I’m calling the <strong>Answer Rate</strong>, is the mean score for those questions.</p>
<p>I select the top-5 chunks by setting <code>LIMIT 5</code> in the sqlite query.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="4be1527e-2bef-4343-eed3-a3ec794aeeca" data-execution_count="16">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">202</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-outputid="555d5e94-f39f-4bf3-d7db-d8cb97e65bc5" data-execution_count="18">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>bm25_c <span class="op">=</span> questions.copy()</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>bm25_c[<span class="st">'bm25_c_context'</span>] <span class="op">=</span> results</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>bm25_c.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">


  <div id="df-9a99e068-6408-452b-9264-b89d58b9521d" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_c_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\n```asciido...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nHere's a l...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-9a99e068-6408-452b-9264-b89d58b9521d')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-9a99e068-6408-452b-9264-b89d58b9521d button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-9a99e068-6408-452b-9264-b89d58b9521d');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-5560fe65-d7b7-4935-b828-0f2a2b216338">
  <button class="colab-df-quickchart" onclick="quickchart('df-5560fe65-d7b7-4935-b828-0f2a2b216338')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-5560fe65-d7b7-4935-b828-0f2a2b216338 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>bm25_c.to_csv(<span class="st">'bm25_c.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-3" class="level4">
<h4 class="anchored" data-anchor-id="results-3">Results</h4>
<p>Here is the <strong>Answer Rate</strong> (by chapter and overall).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">60% (18/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">69.2% (18/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">71.9% (23/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">44.8% (13/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">58.6% (17/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">61.9% (13/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_C</td>
<td style="text-align: center;">Top-5 1-paragraph chunks</td>
<td style="text-align: center;">60% (21/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_C</strong></td>
<td style="text-align: center;"><strong>Top-5 1-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>60.9% (123/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="bm25_d-top-1-3-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm25_d-top-1-3-paragraph-chunks">BM25_D: Top-1 3-Paragraph Chunks</h3>
<p>I now want to increase the chunk size (to 3 paragraphs per chunk) before loading them into the database. I do this by iterating over the 1-paragraph chunks in groups of three, removing the header from the 2nd and 3rd chunk in each triplet (to avoid littering the text with additional keyword matches) and then concatenating the three chunks into new 3-paragraph chunks.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_chunks(chunks, num_p<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    combined_chunks <span class="op">=</span> []</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    current_header <span class="op">=</span> <span class="va">None</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    current_group <span class="op">=</span> []</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract header from chunk</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        header <span class="op">=</span> chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)[<span class="dv">0</span>]</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> header <span class="op">!=</span> current_header:</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&gt;</span> <span class="dv">1</span>:  <span class="co"># Only add if group has content besides header</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add current group to combined chunks if header changes</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>                combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update current header</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>            current_header <span class="op">=</span> header</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Start new group with header and content of current chunk</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>            current_group <span class="op">=</span> [header, chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span>]</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&lt;</span> num_p <span class="op">+</span> <span class="dv">1</span>:  <span class="co"># +1 to account for header</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add chunk content (without header) to current group</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>                current_group.append(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span>)</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">==</span> num_p <span class="op">+</span> <span class="dv">1</span>:  <span class="co"># +1 to account for header</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add full group to combined chunks</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>                combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Reset current group, keeping the header</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>                current_group <span class="op">=</span> [current_header]</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&gt;</span> <span class="dv">1</span>:  <span class="co"># Only add if group has content besides header</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add any remaining group to combined chunks</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>        combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>data_3p <span class="op">=</span> {}</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  data_3p[chapter] <span class="op">=</span> combine_chunks(chunks, num_p<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of total chunks has gone down from <code>1967</code> to <code>713</code>, approximately a 3x decrease.</p>
<div class="cell" data-outputid="56d9da3e-983d-47d2-bd63-f8e346913d25" data-execution_count="13">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data_3p.items():</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>total_chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 112
2 84
4 152
8 58
9 141
10 70
13 96</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>713</code></pre>
</div>
</div>
<div class="cell" data-outputid="310c2bec-6ed3-40d4-b269-d7f5b5c2c940" data-execution_count="271">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1967</span><span class="op">/</span><span class="dv">713</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="271">
<pre><code>2.758765778401122</code></pre>
</div>
</div>
<p>I’ll iterate through one of the chapter’s chunks and view them one-by-one, comparing them with the original notebook to ensure they are chunked correctly.</p>
<div class="cell" data-execution_count="363">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>ch2_iter <span class="op">=</span> <span class="bu">iter</span>(data_3p[<span class="st">'2'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>::: {.cell outputId=‘e6ae6acd-1439-4df5-bfb3-eaffdd4b5ef3’ execution_count=364}</p>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">next</span>(ch2_iter))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

```python
#hide
! [ -e /content ] &amp;&amp; pip install -Uqq fastbook
import fastbook
fastbook.setup_book()</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hide</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastbook <span class="im">import</span> <span class="op">*</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.widgets <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>:::
:::


With the data reviewed and looking good, I'll load it into the database.

::: {.cell outputId='0769d4ba-92dc-4ffb-bd58-64986d47dc22' execution_count=14}
``` {.python .cell-code}
for chapter, chunks in data_3p.items():
  print(f"Chapter {chapter}:", load_data(chunks, 'fastbook.db', chapter))</code></pre>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True</code></pre>
</div>
</div>
<p>Now, I can the full text search, returning the top-1 3-paragraph chunk for each question:</p>
<div class="cell" data-execution_count="366">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="6de0fc93-37c0-4925-a044-cb878cc08337" data-execution_count="367">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">202</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="367">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-outputid="608ddb20-476d-47bc-d66e-5859888a65d6" data-execution_count="368">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>bm25_d <span class="op">=</span> questions.copy()</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>bm25_d[<span class="st">'bm25_d_context'</span>] <span class="op">=</span> results</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>bm25_d.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="368">


  <div id="df-280b69b4-78ea-48d3-ba5e-c44267c6a0ea" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_d_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\nA lot of p...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nDeep learn...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-280b69b4-78ea-48d3-ba5e-c44267c6a0ea')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-280b69b4-78ea-48d3-ba5e-c44267c6a0ea button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-280b69b4-78ea-48d3-ba5e-c44267c6a0ea');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-b1b827c6-776a-4527-8b25-1860778c8675">
  <button class="colab-df-quickchart" onclick="quickchart('df-b1b827c6-776a-4527-8b25-1860778c8675')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-b1b827c6-776a-4527-8b25-1860778c8675 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="369">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>bm25_d.to_csv(<span class="st">'bm25_d.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-4" class="level4">
<h4 class="anchored" data-anchor-id="results-4">Results</h4>
<p>Here is the <strong>Answer Rate</strong> (by chapter and overall).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">63.3% (19/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">46.2% (12/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">31.3% (10/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">31% (9/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">34.5% (10/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">38% (8/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_D</td>
<td style="text-align: center;">Top-1 3-paragraph chunks</td>
<td style="text-align: center;">42.9% (15/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_D</strong></td>
<td style="text-align: center;"><strong>Top-1 3-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>41.1% (83/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="bm_25e-top-3-3-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm_25e-top-3-3-paragraph-chunks">BM_25E: Top-3 3-Paragraph Chunks</h3>
<p>I’ll use the same loaded database (3-paragraph chunks) and full text search it with my keywords, setting <code>LIMIT = 3</code> to get the top-3 chunks.</p>
<div class="cell" data-outputid="78ba29f3-24dd-40da-a8a8-bd4577b583c6" data-execution_count="28">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">202</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-outputid="3adec362-2257-4f0b-f82e-4abf1d6b0a7d" data-execution_count="30">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>bm25_e <span class="op">=</span> questions.copy()</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>bm25_e[<span class="st">'bm25_e_context'</span>] <span class="op">=</span> results</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>bm25_e.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">


  <div id="df-a4c95da4-2946-4786-babe-d0bfaebf81bd" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_e_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\nA lot of p...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nDeep learn...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-a4c95da4-2946-4786-babe-d0bfaebf81bd')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-a4c95da4-2946-4786-babe-d0bfaebf81bd button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-a4c95da4-2946-4786-babe-d0bfaebf81bd');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-c725005f-6627-4f2b-9e18-8a4f137b15e9">
  <button class="colab-df-quickchart" onclick="quickchart('df-c725005f-6627-4f2b-9e18-8a4f137b15e9')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-c725005f-6627-4f2b-9e18-8a4f137b15e9 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>bm25_e.to_csv(<span class="st">'bm25_e.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-5" class="level4">
<h4 class="anchored" data-anchor-id="results-5">Results</h4>
<p>Here is the <strong>Answer Rate</strong> (by chapter and overall).</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">83.3% (25/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">80.8% (21/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">71.9% (23/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">55.2% (16/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">72.4% (21/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">57.1% (12/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_E</td>
<td style="text-align: center;">Top-3 3-paragraph chunks</td>
<td style="text-align: center;">68.6% (24/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_E</strong></td>
<td style="text-align: center;"><strong>Top-3 3-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>70.3% (142/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="bm25_f-top-5-3-paragraph-chunks" class="level3">
<h3 class="anchored" data-anchor-id="bm25_f-top-5-3-paragraph-chunks">BM25_F: Top-5 3-Paragraph Chunks</h3>
<p>I’ll use the same loaded database (3-paragraph chunks) and full text search it with my keywords, setting <code>LIMIT 5</code> to get the top-5 chunks.</p>
<div class="cell" data-outputid="af1d46ed-4d58-431f-b981-7b48af5ec4dc" data-execution_count="32">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">202</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-outputid="a65b4ced-1fd3-4a01-a971-93bf081eea62" data-execution_count="33">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>bm25_f <span class="op">=</span> questions.copy()</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>bm25_f[<span class="st">'bm25_f_context'</span>] <span class="op">=</span> results</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>bm25_f.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">


  <div id="df-19d8f002-b06f-40e3-acdb-79839d74ddb0" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>is_answerable</th>
      <th>keywords</th>
      <th>bm25_f_context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>""Do you need these for deep learning?nn- Lots...</td>
      <td>""Lots of math - False\nLots of data - False\n...</td>
      <td>1</td>
      <td>"deep learning, math, data, computers, PhD"</td>
      <td>## Deep Learning Is for Everyone\n\nA lot of p...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>""Name five areas where deep learning is now t...</td>
      <td>""Any five of the following:\nNatural Language...</td>
      <td>1</td>
      <td>deep learning, areas, best, world</td>
      <td>## Deep Learning Is for Everyone\n\nDeep learn...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>""What was the name of the first device that w...</td>
      <td>""Mark I perceptron built by Frank Rosenblatt""</td>
      <td>1</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
      <td>## Neural Networks: A Brief History\n\n&lt;img al...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>""Based on the book of the same name, what are...</td>
      <td>""A set of processing units\nA state of activa...</td>
      <td>1</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
      <td>## Neural Networks: A Brief History\n\nIn fact...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>""What were the two theoretical misunderstandi...</td>
      <td>""In 1969, Marvin Minsky and Seymour Papert de...</td>
      <td>1</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
      <td>## Neural Networks: A Brief History\n\nIn the ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-19d8f002-b06f-40e3-acdb-79839d74ddb0')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-19d8f002-b06f-40e3-acdb-79839d74ddb0 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-19d8f002-b06f-40e3-acdb-79839d74ddb0');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-38def157-2bf0-4733-b1af-27296758080a">
  <button class="colab-df-quickchart" onclick="quickchart('df-38def157-2bf0-4733-b1af-27296758080a')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-38def157-2bf0-4733-b1af-27296758080a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>bm25_f.to_csv(<span class="st">'bm25_f.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results-6" class="level4">
<h4 class="anchored" data-anchor-id="results-6">Results</h4>
<p>Here is the <strong>Answer Rate</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chapter</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Answer Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">90% (27/30)</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">80.8% (21/26)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">75% (24/32)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">65.5% (19/29)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">79.3% (23/29)</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">61.9% (13/21)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">BM25_F</td>
<td style="text-align: center;">Top-5 3-paragraph chunks</td>
<td style="text-align: center;">80% (28/35)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>BM25_F</strong></td>
<td style="text-align: center;"><strong>Top-5 3-paragraph chunks</strong></td>
<td style="text-align: center;"><strong>76.7% (155/202)</strong></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I’m happy with the performance of my full text search experiments. I see why BM25 is such a strong baseline! I’m able to answer 76.7% of the questions using a keyword-based search, which is pretty impressive.</p>
<p>Here’s what the next few notebooks will contain:</p>
<ul>
<li>A deep dive into error analysis for the results from this notebook.</li>
<li>Experimenting with different Cosine Similarity (semantic search) methods.</li>
<li>Experimenting with different hybrid search (full text search + semantic search) methods.</li>
<li>Integrating an LLM into this pipeline to generate answers based on the retrieved context.</li>
</ul>
<p>I hope to finish this by the end of September and then publish a repo and corresponding documentation page with all my experiments, results and analysis.</p>
<p>I hope you enjoyed this blog post! Follow me on Twitter <a href="https://twitter.com/vishal_learner"><span class="citation" data-cites="vishal_learner">@vishal_learner</span></a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","descPosition":"bottom","loop":true,"closeEffect":"zoom","openEffect":"zoom"});</script>



</body></html>