<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="description" content="In this blog post, I write a MNISTLearner class which trains a neural net to classify the full MNIST dataset of 10 handwritten digits.">

<title>vishal bakshi - Implementing an MNIST Classifier From Scratch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">vishal bakshi</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#plan-of-attack" id="toc-plan-of-attack" class="nav-link" data-scroll-target="#plan-of-attack">Plan of Attack</a>
  <ul class="collapse">
  <li><a href="#load-and-prep-data" id="toc-load-and-prep-data" class="nav-link" data-scroll-target="#load-and-prep-data">Load and Prep Data</a></li>
  <li><a href="#create-our-model" id="toc-create-our-model" class="nav-link" data-scroll-target="#create-our-model">Create Our Model</a></li>
  <li><a href="#create-a-loss-function" id="toc-create-a-loss-function" class="nav-link" data-scroll-target="#create-a-loss-function">Create a Loss Function</a></li>
  <li><a href="#create-a-function-to-calculate-predictions-loss-and-gradients" id="toc-create-a-function-to-calculate-predictions-loss-and-gradients" class="nav-link" data-scroll-target="#create-a-function-to-calculate-predictions-loss-and-gradients">Create a Function to Calculate Predictions, Loss and Gradients</a></li>
  <li><a href="#create-an-optimizer" id="toc-create-an-optimizer" class="nav-link" data-scroll-target="#create-an-optimizer">Create an Optimizer</a></li>
  <li><a href="#create-a-function-to-train-one-epoch" id="toc-create-a-function-to-train-one-epoch" class="nav-link" data-scroll-target="#create-a-function-to-train-one-epoch">Create a Function to Train One Epoch</a></li>
  <li><a href="#create-a-function-to-calculate-a-metric-for-one-batch" id="toc-create-a-function-to-calculate-a-metric-for-one-batch" class="nav-link" data-scroll-target="#create-a-function-to-calculate-a-metric-for-one-batch">Create a Function to Calculate a Metric for One Batch</a></li>
  <li><a href="#create-a-function-to-calculate-the-metric-for-one-epoch" id="toc-create-a-function-to-calculate-the-metric-for-one-epoch" class="nav-link" data-scroll-target="#create-a-function-to-calculate-the-metric-for-one-epoch">Create a Function to Calculate the Metric for One Epoch</a></li>
  <li><a href="#create-a-function-for-the-training-loop" id="toc-create-a-function-for-the-training-loop" class="nav-link" data-scroll-target="#create-a-function-for-the-training-loop">Create a Function for the Training Loop</a></li>
  </ul></li>
  <li><a href="#mnist-training-loop" id="toc-mnist-training-loop" class="nav-link" data-scroll-target="#mnist-training-loop"><code>MNIST</code> Training Loop</a>
  <ul class="collapse">
  <li><a href="#load-and-prep-data-1" id="toc-load-and-prep-data-1" class="nav-link" data-scroll-target="#load-and-prep-data-1">Load and Prep Data</a></li>
  <li><a href="#create-our-model-1" id="toc-create-our-model-1" class="nav-link" data-scroll-target="#create-our-model-1">Create Our Model</a></li>
  <li><a href="#create-a-loss-function-1" id="toc-create-a-loss-function-1" class="nav-link" data-scroll-target="#create-a-loss-function-1">Create a Loss Function</a></li>
  <li><a href="#create-a-function-to-calculate-predictions-loss-and-gradients-1" id="toc-create-a-function-to-calculate-predictions-loss-and-gradients-1" class="nav-link" data-scroll-target="#create-a-function-to-calculate-predictions-loss-and-gradients-1">Create a function to Calculate Predictions, Loss and Gradients</a></li>
  <li><a href="#create-an-optimizer-1" id="toc-create-an-optimizer-1" class="nav-link" data-scroll-target="#create-an-optimizer-1">Create an Optimizer</a></li>
  <li><a href="#create-a-function-to-train-one-epoch-1" id="toc-create-a-function-to-train-one-epoch-1" class="nav-link" data-scroll-target="#create-a-function-to-train-one-epoch-1">Create a Function to Train One Epoch</a></li>
  <li><a href="#create-a-function-to-calculate-a-metric-for-one-batch-1" id="toc-create-a-function-to-calculate-a-metric-for-one-batch-1" class="nav-link" data-scroll-target="#create-a-function-to-calculate-a-metric-for-one-batch-1">Create a Function to Calculate a Metric for One Batch</a></li>
  <li><a href="#create-a-function-to-calculate-the-metric-for-one-epoch-1" id="toc-create-a-function-to-calculate-the-metric-for-one-epoch-1" class="nav-link" data-scroll-target="#create-a-function-to-calculate-the-metric-for-one-epoch-1">Create a Function to Calculate the Metric for One Epoch</a></li>
  <li><a href="#train-the-model-for-one-epoch" id="toc-train-the-model-for-one-epoch" class="nav-link" data-scroll-target="#train-the-model-for-one-epoch">Train the Model for One Epoch</a></li>
  <li><a href="#create-a-function-for-the-training-loop-1" id="toc-create-a-function-for-the-training-loop-1" class="nav-link" data-scroll-target="#create-a-function-for-the-training-loop-1">Create a Function for the Training Loop</a></li>
  </ul></li>
  <li><a href="#mnistlearner-class" id="toc-mnistlearner-class" class="nav-link" data-scroll-target="#mnistlearner-class"><code>MNISTLearner</code> Class</a></li>
  <li><a href="#improving-the-model" id="toc-improving-the-model" class="nav-link" data-scroll-target="#improving-the-model">Improving the Model</a></li>
  <li><a href="#further-improvements" id="toc-further-improvements" class="nav-link" data-scroll-target="#further-improvements">Further Improvements</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Implementing an MNIST Classifier From Scratch</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this blog post, I write a <code>MNISTLearner</code> class which trains a neural net to classify the full MNIST dataset of 10 handwritten digits.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook, I’ll work through the <strong>second</strong> “Further Research” exercise at the end of <a href="https://github.com/fastai/fastbook/blob/master/04_mnist_basics.ipynb">Chapter 4 of the Practical Deep Learning for Coders textbook</a>:</p>
<blockquote class="blockquote">
<p>Complete all the steps in this chapter using the full MNIST datasets (for all digits, not just 3s and 7s). This is a significant project and will take you quite a bit of time to complete! You’ll need to do some of your own research to figure out how to overcome obstacles you’ll meet on the way.</p>
</blockquote>
</section>
<section id="plan-of-attack" class="level2">
<h2 class="anchored" data-anchor-id="plan-of-attack">Plan of Attack</h2>
<p>I’ll start by reviewing each step of the training loop covered in this chapter (for 3s and 7s) and identify what elements need to change, why, and an a brief outline of how, in order to accommodate for all 10 digits.</p>
<section id="load-and-prep-data" class="level3">
<h3 class="anchored" data-anchor-id="load-and-prep-data">Load and Prep Data</h3>
<p>In the chapter, we stacked tensor images of each digit to create <code>n</code> x <code>28</code> x <code>28</code> tensors (where <code>n</code> is the number of images in the training or validation folder) and then converted them to <code>n</code> x <code>784</code> tensors so that each pixel was in a one-dimensional row (corresponding to 784 parameters in the neural net in a one-dimensional row).</p>
<p>To handle all 10 digits, I’ll need to expand this logic without too much hard-coding—I don’t want to create 10 tensors individually (<code>stacked_zeros</code>, <code>stacked_ones</code>, …, <code>stacked_tens</code>) for training and validation data.</p>
<p>Instead, I’ll use list comprehension. First, let’s look at how to access all the subfolders in the <code>train</code> and <code>valid</code> parent folders:</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="216f9b9c-2899-44b2-dbf1-e197e9ca57eb" data-execution_count="33">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.MNIST)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="15687680" class="" max="15683414" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.03% [15687680/15683414 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-outputid="efd9488a-b06d-4afe-a304-c3150f8afc12" data-execution_count="34">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(#2) [Path('/root/.fastai/data/mnist_png/training'),Path('/root/.fastai/data/mnist_png/testing')]</code></pre>
</div>
</div>
<section id="independent-variable-images" class="level4">
<h4 class="anchored" data-anchor-id="independent-variable-images">Independent Variable: Images</h4>
<p>I can iterate through <code>(path/'training').ls()</code> to see the 10 digit subfolders containing training images for the digits:</p>
<div class="cell" data-outputid="015fbd09-fc3c-4d41-ee14-b96e88157033" data-execution_count="35">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>[path <span class="cf">for</span> path <span class="kw">in</span> (path<span class="op">/</span><span class="st">'training'</span>).ls()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>[Path('/root/.fastai/data/mnist_png/training/8'),
 Path('/root/.fastai/data/mnist_png/training/6'),
 Path('/root/.fastai/data/mnist_png/training/3'),
 Path('/root/.fastai/data/mnist_png/training/1'),
 Path('/root/.fastai/data/mnist_png/training/9'),
 Path('/root/.fastai/data/mnist_png/training/2'),
 Path('/root/.fastai/data/mnist_png/training/0'),
 Path('/root/.fastai/data/mnist_png/training/4'),
 Path('/root/.fastai/data/mnist_png/training/7'),
 Path('/root/.fastai/data/mnist_png/training/5')]</code></pre>
</div>
</div>
<p>Taking it one layer deeper, I can nest a second list comprehension which collects individual file paths from each of the digit’s folders:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>training_files <span class="op">=</span> [[<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> path.ls()] <span class="cf">for</span> path <span class="kw">in</span> (path<span class="op">/</span><span class="st">'training'</span>).ls().<span class="bu">sorted</span>()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the paths to the first 5 images in the first folder, which corresponds to the digit <code>0</code>:</p>
<div class="cell" data-outputid="4c977fea-e754-4efb-96d9-3293101ce0ab" data-execution_count="37">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>training_files[<span class="dv">0</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>[Path('/root/.fastai/data/mnist_png/training/0/35012.png'),
 Path('/root/.fastai/data/mnist_png/training/0/2009.png'),
 Path('/root/.fastai/data/mnist_png/training/0/14472.png'),
 Path('/root/.fastai/data/mnist_png/training/0/7589.png'),
 Path('/root/.fastai/data/mnist_png/training/0/53401.png')]</code></pre>
</div>
</div>
<p>And the paths to the first 5 images in the second folder, which corresponds to the digit <code>1</code>:</p>
<div class="cell" data-outputid="510b9e94-172f-45dc-f99f-7b3a906eb181" data-execution_count="38">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>training_files[<span class="dv">1</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>[Path('/root/.fastai/data/mnist_png/training/1/47434.png'),
 Path('/root/.fastai/data/mnist_png/training/1/27790.png'),
 Path('/root/.fastai/data/mnist_png/training/1/42000.png'),
 Path('/root/.fastai/data/mnist_png/training/1/15633.png'),
 Path('/root/.fastai/data/mnist_png/training/1/21958.png')]</code></pre>
</div>
</div>
<p>And so on for all 10 digits</p>
<div class="cell" data-outputid="063e34c4-6bf2-49f1-f423-d27ca2345d83" data-execution_count="39">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>training_files[<span class="dv">9</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>[Path('/root/.fastai/data/mnist_png/training/9/57008.png'),
 Path('/root/.fastai/data/mnist_png/training/9/28984.png'),
 Path('/root/.fastai/data/mnist_png/training/9/36162.png'),
 Path('/root/.fastai/data/mnist_png/training/9/42013.png'),
 Path('/root/.fastai/data/mnist_png/training/9/18296.png')]</code></pre>
</div>
</div>
<div class="cell" data-outputid="8f4c1af1-0d47-435b-c3ad-01b912e650ef" data-execution_count="40">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(training_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>10</code></pre>
</div>
</div>
<p>I’ll illustrate the same for the validation set:</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>validation_files <span class="op">=</span> [[<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> path.ls()] <span class="cf">for</span> path <span class="kw">in</span> (path<span class="op">/</span><span class="st">'testing'</span>).ls().<span class="bu">sorted</span>()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="3331fb7e-1d20-43fd-b9b7-b72017bbd000" data-execution_count="42">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>validation_files[<span class="dv">0</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>[Path('/root/.fastai/data/mnist_png/testing/0/9095.png'),
 Path('/root/.fastai/data/mnist_png/testing/0/5990.png'),
 Path('/root/.fastai/data/mnist_png/testing/0/7505.png'),
 Path('/root/.fastai/data/mnist_png/testing/0/157.png'),
 Path('/root/.fastai/data/mnist_png/testing/0/5838.png')]</code></pre>
</div>
</div>
<div class="cell" data-outputid="7a32e886-0e23-42ca-cc11-0f0cda1ebd92" data-execution_count="43">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>validation_files[<span class="dv">9</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>[Path('/root/.fastai/data/mnist_png/testing/9/2009.png'),
 Path('/root/.fastai/data/mnist_png/testing/9/7298.png'),
 Path('/root/.fastai/data/mnist_png/testing/9/5565.png'),
 Path('/root/.fastai/data/mnist_png/testing/9/9483.png'),
 Path('/root/.fastai/data/mnist_png/testing/9/5705.png')]</code></pre>
</div>
</div>
<div class="cell" data-outputid="d7fdb9a3-8787-4790-bd27-5b082a6d525c" data-execution_count="44">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(validation_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>10</code></pre>
</div>
</div>
<p>Next, I’ll flatten the list of training and validation files, convert each to a stacked tensor, convert the pixel values to floating point values, and divide by 255 so the pixel values are between 0 and 1. I referenced <a href="https://stackoverflow.com/a/952952">this Stack Overflow post</a> for flattening a nested list.</p>
<p>To understand how it works, I find it easier to read left-to-right, broken up into two separate parts:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span> <span class="cf">for</span> (sublist <span class="kw">in</span> training_files) <span class="cf">for</span> (<span class="bu">file</span> <span class="kw">in</span> sublist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In pseudocode:</p>
<pre><code>populate this list with each file in each sublist in `training_files`</code></pre>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>training_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> sublist <span class="kw">in</span> training_files <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> sublist]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>validation_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> sublist <span class="kw">in</span> validation_files <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> sublist]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dataset’s <a href="https://en.wikipedia.org/wiki/MNIST_database">Wikimedia page</a> says that it has 60,000 training images and 10,000 testing images. This matches the counts here:</p>
<div class="cell" data-outputid="f7e37d9d-2365-45a5-9fdd-01c24b7e7a05" data-execution_count="46">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(training_files), <span class="bu">len</span>(validation_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<p>I’ll open a couple of the files and make sure I can view the images as expected:</p>
<div class="cell" data-outputid="d1c3596b-33de-46f0-d971-5c45071dcc8e" data-execution_count="47">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be an image of a handwritten zero</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>show_image(tensor(Image.<span class="bu">open</span>(training_files[<span class="dv">0</span>])))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="c2a11631-f263-454c-b472-55f2b647845b" data-execution_count="48">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be an image of a handwritten nine</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>show_image(tensor(Image.<span class="bu">open</span>(training_files[<span class="op">-</span><span class="dv">1</span>])))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="4be292fc-e975-4b94-f781-6378f32b2ce2" data-execution_count="49">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be an image of a handwritten zero</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>show_image(tensor(Image.<span class="bu">open</span>(validation_files[<span class="dv">0</span>])))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="e6a25951-6f15-4769-f5d8-7d233cef451a" data-execution_count="50">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be an image of a handwritten nine</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>show_image(tensor(Image.<span class="bu">open</span>(validation_files[<span class="op">-</span><span class="dv">1</span>])))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Looks good! The images are as expected. I can now move on to creating stacked floating point tensors of the training and validation images:</p>
<div class="cell" data-outputid="8c67452f-c11d-4f4f-a214-46312fcf6549" data-execution_count="51">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> training_files]).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>train_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>torch.Size([60000, 28, 28])</code></pre>
</div>
</div>
<div class="cell" data-outputid="7bd19cc2-17ed-4eaa-cc80-14466871b5b3" data-execution_count="52">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> validation_files]).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>valid_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>torch.Size([10000, 28, 28])</code></pre>
</div>
</div>
<p>I’ll view my data one more time before changing its shape:</p>
<div class="cell" data-outputid="732fe987-9018-4660-aedf-6328bdc07820" data-execution_count="53">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a zero</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>show_image(train_x[<span class="dv">0</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="28abc2c3-85e8-4954-bb37-ba461345a7f2" data-execution_count="54">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a nine</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>show_image(train_x[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7d8a1692-2ecd-4e7a-8f11-e9c06d852d27" data-execution_count="55">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a zero</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>show_image(valid_x[<span class="dv">0</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="406c8c3a-2b93-4651-c370-eb8ac93ff034" data-execution_count="56">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a nine</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>show_image(valid_x[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Great! I’ll flatten the images so that they are 784 pixels long, instead of a 28 x 28 matrix.</p>
<div class="cell" data-outputid="3d4164a1-97ae-4793-d6df-f087124553c1" data-execution_count="57">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> train_x.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>train_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>torch.Size([60000, 784])</code></pre>
</div>
</div>
<div class="cell" data-outputid="49c5e058-c379-4e01-c69b-03fb9f464b99" data-execution_count="58">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> valid_x.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>valid_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>torch.Size([10000, 784])</code></pre>
</div>
</div>
</section>
<section id="dependent-variable-labels" class="level4">
<h4 class="anchored" data-anchor-id="dependent-variable-labels">Dependent Variable: Labels</h4>
<p>Now that I have the <code>x</code> (independent) variable data prepared, I’ll do the same for the <code>y</code> (dependent) variable data—the labels for the images.</p>
<p>I’ll reuse my <code>training_files</code> and <code>validation_files</code> lists as they already contain the paths to each image file, from which I’ll extract the label. <code>path.parts</code> splits the path into a tuple of its individual parts (split by “/”). The parent folder (the second-to-last part of the path) of the path is the label of the image.</p>
<div class="cell" data-outputid="59ef421f-72ed-45b8-f615-076c10d3b871" data-execution_count="59">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>training_labels <span class="op">=</span> [<span class="bu">int</span>(path.parts[<span class="op">-</span><span class="dv">2</span>]) <span class="cf">for</span> path <span class="kw">in</span> training_files]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>training_labels[<span class="dv">0</span>], training_labels[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>(0, 9)</code></pre>
</div>
</div>
<div class="cell" data-outputid="ff8acbfe-f3fb-4d3e-8000-addc226bf08a" data-execution_count="60">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>validation_labels <span class="op">=</span> [<span class="bu">int</span>(path.parts[<span class="op">-</span><span class="dv">2</span>]) <span class="cf">for</span> path <span class="kw">in</span> validation_files]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>validation_labels[<span class="dv">0</span>], validation_labels[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>(0, 9)</code></pre>
</div>
</div>
<div class="cell" data-outputid="00b853da-6e9e-4b55-92fa-78a7f2495096" data-execution_count="61">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>train_y <span class="op">=</span> tensor(training_labels).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>train_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>torch.Size([60000, 1])</code></pre>
</div>
</div>
<div class="cell" data-outputid="1ca1ea71-5e54-44e6-a298-0b24db1475af" data-execution_count="62">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>valid_y <span class="op">=</span> tensor(validation_labels).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>valid_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>torch.Size([10000, 1])</code></pre>
</div>
</div>
<p>Excellent! Now with the data in the right structure, I’ll create a <code>DataLoaders</code> object that will be fed to the learner during training:</p>
<div class="cell" data-outputid="9293cd8c-4d44-456b-bd3a-8a3709ef9b30" data-execution_count="63">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dset <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(train_x, train_y))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dset[<span class="dv">0</span>]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>x.shape, y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>(torch.Size([784]), tensor([0]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="fdb354f8-be0c-41d4-9b6d-b75ce6f7fa92" data-execution_count="64">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>valid_dset <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(valid_x, valid_y))</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> valid_dset[<span class="dv">0</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>x.shape, y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>(torch.Size([784]), tensor([0]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="b646abb7-c7ea-4402-fd47-12cd3738f24e" data-execution_count="65">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> DataLoader(dset, batch_size<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>xb,yb <span class="op">=</span> first(dl)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="31d4b043-9956-4c56-9036-3291821dc1cf" data-execution_count="66">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="op">=</span> DataLoader(valid_dset, batch_size<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>valid_xb, valid_yb <span class="op">=</span> first(valid_dl)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>valid_xb.shape, valid_yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<p>I combine the two <code>DataLoader</code>s into a single <code>DataLoaders</code> object:</p>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(dl, valid_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And check that they contain the right amount of data:</p>
<div class="cell" data-outputid="ae08e567-8242-4e6a-b402-d78350cb0303" data-execution_count="68">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls.train.dataset), <span class="bu">len</span>(dls.valid.dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<p>Great! With my <code>DataLoaders</code> prepared, I can move on to other aspects of the training loop that will need to be modified to handle 10 digits instead of 2.</p>
</section>
</section>
<section id="create-our-model" class="level3">
<h3 class="anchored" data-anchor-id="create-our-model">Create Our Model</h3>
<p>Here is the existing model that we’re using to classify two digits:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>, <span class="dv">1</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It has 784 inputs and 1 output. For 10 digits, I need to adjust th number of outputs to 10:</p>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>,<span class="dv">10</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I assume that since we have more final activations, we would also need to increase the intermediate activations from 30 to a larger number, but I’ll keep it at 30 for now and then make improvements once I’ve actually got a successful training loop.</p>
</section>
<section id="create-a-loss-function" class="level3">
<h3 class="anchored" data-anchor-id="create-a-loss-function">Create a Loss Function</h3>
<p>This is the main change that will take place in our training loop: using a loss function that can handle 10 digits instead of 2. In the exercise prompt, they said that we would need to:</p>
<blockquote class="blockquote">
<p>do some of your own research to figure out how to overcome obstacles you’ll meet on the way</p>
</blockquote>
<p>And I think this is probably the main obstacle to overcome. In the textbook chapter, when they trained the dataset using the built-in <code>Learner</code>, they passed it <code>F.cross_entropy</code> as the loss function:</p>
<pre><code>learn = vision_learner(dls, resnet18, pretrained=False, loss_func=F.cross_entropy, metrics=accuracy)
</code></pre>
<p>In the text, they introduce Cross-Entropy Loss in Chapter 5, so I’ll take a detour through that chapter’s relevant sections to inform me on how to create a loss function for a 10-digit classifier.</p>
<section id="cross-entropy-loss" class="level4">
<h4 class="anchored" data-anchor-id="cross-entropy-loss">Cross-Entropy Loss</h4>
<ul>
<li>Works even when our dependent variable has more than two categories.</li>
<li>Results in faster and more reliable training.</li>
</ul>
<p>As is done in the book example, I’ll view one batch of our data:</p>
<div class="cell" data-outputid="3422fe8d-c8d6-49dc-91fc-1ba7081a0405" data-execution_count="70">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dls.one_batch()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>y[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>tensor([[0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0],
        [0]])</code></pre>
</div>
</div>
<p>Currently, my data is not shuffled, so all the 0s are first, then all the 1s, 2s, …, and 9s. This doesn’t seem like a great way to train the model since it will learn only 1 digit’s features in each batch. I’ll recreate the <code>DataLoader</code>s and pass the parameter value <code>shuffle=True</code>:</p>
<div class="cell" data-outputid="2c3a08c9-2412-4534-d337-1d64148a86ba" data-execution_count="71">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> DataLoader(dset, batch_size<span class="op">=</span><span class="dv">256</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>xb,yb <span class="op">=</span> first(dl)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>yb[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>tensor([[5],
        [4],
        [1],
        [3],
        [0],
        [3],
        [7],
        [2],
        [3],
        [0]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="e7e6b096-b1b7-4c72-d33b-a574faa625a4" data-execution_count="72">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="op">=</span> DataLoader(valid_dset, batch_size<span class="op">=</span><span class="dv">256</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>valid_xb, valid_yb <span class="op">=</span> first(valid_dl)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>valid_yb[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>tensor([[4],
        [7],
        [9],
        [6],
        [1],
        [8],
        [9],
        [5],
        [3],
        [0]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(dl, valid_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="8cb67c0a-8d31-490e-f624-21167c359e62" data-execution_count="74">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls.train.dataset), <span class="bu">len</span>(dls.valid.dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<p>Now, when I look at one batch, I can see a variety of labels:</p>
<div class="cell" data-outputid="8c4bd129-d10f-4fe9-eedf-1bf40b4c21ca" data-execution_count="75">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dls.one_batch()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>y[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor([[8],
        [3],
        [2],
        [7],
        [3],
        [9],
        [1],
        [6],
        [0],
        [7]])</code></pre>
</div>
</div>
<p>The output predictions of the model will contain 10 predictions (one for each digit) that add up to 1. According to Chapter 5, we need to use the <em>softmax</em> function to achieve a result like this.</p>
<section id="softmax" class="level5">
<h5 class="anchored" data-anchor-id="softmax">Softmax</h5>
<p>Assume we have a scenario with 6 images and 2 possible categories (<code>3</code> and <code>7</code>):</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>torch.random.manual_seed(<span class="dv">42</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="3d281a35-c81b-4847-9ec4-ae21b5d4e405" data-execution_count="77">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>acts <span class="op">=</span> torch.randn((<span class="dv">6</span>,<span class="dv">2</span>))<span class="op">*</span><span class="dv">2</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>tensor([[ 0.6734,  0.2576],
        [ 0.4689,  0.4607],
        [-2.2457, -0.3727],
        [ 4.4164, -1.2760],
        [ 0.9233,  0.5347],
        [ 1.0698,  1.6187]])</code></pre>
</div>
</div>
<p>We can’t just take the <code>sigmoid</code> of this directly since we want rows to add up to 1.0 (i.e., we want the probability of being a 3 plus the probability of being a 7 to add up to 1).</p>
<div class="cell" data-outputid="99030ee4-e14c-489e-cbbc-55938f8ae9c5" data-execution_count="78">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>acts.sigmoid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>tensor([[0.6623, 0.5641],
        [0.6151, 0.6132],
        [0.0957, 0.4079],
        [0.9881, 0.2182],
        [0.7157, 0.6306],
        [0.7446, 0.8346]])</code></pre>
</div>
</div>
<p>In the binary case, a single pair of activations simply indicates the <em>relative</em> confidence of the input being a <code>3</code> versus being a <code>7</code>. The overall values, whether they are both high or both low, don’t matter—all that matters is which is higher and by how much.</p>
<p>We can take the <em>difference</em> between the neural net activations because that reflects how much more sure we are of the input being a <code>3</code> than a <code>7</code>, and then take the <code>sigmoid</code> of that:</p>
<div class="cell" data-outputid="5e639f52-8eb4-407d-e7f1-3cdeae894389" data-execution_count="79">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>(acts[:,<span class="dv">0</span>] <span class="op">-</span> acts[:,<span class="dv">1</span>]).sigmoid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>tensor([0.6025, 0.5021, 0.1332, 0.9966, 0.5959, 0.3661])</code></pre>
</div>
</div>
<p>The second column (the probability of it being a <code>7</code>) will then just be that value subtracted from 1. The function <code>softmax</code> does this for any number of columns:</p>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> softmax(x): <span class="cf">return</span> torch.exp(x) <span class="op">/</span> torch.exp(x).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="70beaa02-3799-4a4d-eae9-4f6443bb1ac5" data-execution_count="81">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>sm_acts <span class="op">=</span> softmax(acts)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>sm_acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>tensor([[0.6025, 0.3975],
        [0.5021, 0.4979],
        [0.1332, 0.8668],
        [0.9966, 0.0034],
        [0.5959, 0.4041],
        [0.3661, 0.6339]])</code></pre>
</div>
</div>
<p><code>softmax</code> is the multi-category equivalent of <code>sigmoid</code>. We have to use it any time we have more than two categories and the probabilities of the categories must add up to 1. Taking the exponential ensures all of our numbers are positive, and then dividing by the sum ensures that we are going to have a bunch of numbers that add up to 1.</p>
<p><code>softmax</code> is the first part of the cross-entropy loss, the second part is log likelihood.</p>
</section>
<section id="log-likelihood" class="level5">
<h5 class="anchored" data-anchor-id="log-likelihood">Log Likelihood</h5>
<p>When we calculated the loss for our MNIST example, we used:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_loss(inputs, targets):</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  inputs <span class="op">=</span> inputs.sigmoid()</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> torch.where(targets<span class="op">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="op">-</span>inputs, inputs).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We need to extend the loss function to work with more than just binary classification.</p>
<p>Our activations after <code>softmax</code> are between 0 and 1, and sum to 1 for each row in the batch of predictions, our targets are integers between 0 and 9.</p>
<p>Let’s say these are our labels:</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>targ <span class="op">=</span> tensor([<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And these are the softmax activations:</p>
<div class="cell" data-outputid="8d83102e-53d4-41dd-e971-867a920fe7dc" data-execution_count="83">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>sm_acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>tensor([[0.6025, 0.3975],
        [0.5021, 0.4979],
        [0.1332, 0.8668],
        [0.9966, 0.0034],
        [0.5959, 0.4041],
        [0.3661, 0.6339]])</code></pre>
</div>
</div>
<p>Then for each item of <code>targ</code>, we can use that to select the appropriate column of <code>sm_acts</code> using tensor indexing like this:</p>
<div class="cell" data-outputid="19de5cd5-20bc-4357-caad-abef3f3e47e2" data-execution_count="84">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="bu">range</span>(<span class="dv">6</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>sm_acts[idx, targ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>tensor([0.6025, 0.4979, 0.1332, 0.0034, 0.4041, 0.3661])</code></pre>
</div>
</div>
<p>As long as the activation columns sum to 1 (as they will if we use softmax), we’ll have a loss function that shows how well we’re predicting each digit.</p>
<p>Making the activation for the correct label as high as possible must mean we’re also decreasing the activations of the remaining columns.</p>
<p>PyTorch provides <code>nll_loss</code> which does the same thing as <code>sm_acts[range(n), targ]</code> except it takes the negative because when applying log afterwards we want negative numbers:</p>
<div class="cell" data-outputid="b2d3aa1d-3f8f-42a6-95e6-9bce966a2538" data-execution_count="85">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>sm_acts[idx, targ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>tensor([-0.6025, -0.4979, -0.1332, -0.0034, -0.4041, -0.3661])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ab662671-c2c0-4906-9642-4af22b6117f0" data-execution_count="86">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>F.nll_loss(sm_acts, targ, reduction<span class="op">=</span><span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>tensor([-0.6025, -0.4979, -0.1332, -0.0034, -0.4041, -0.3661])</code></pre>
</div>
</div>
</section>
<section id="taking-the-log" class="level5">
<h5 class="anchored" data-anchor-id="taking-the-log">Taking the log</h5>
<p>Here’s a plot of the log function</p>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_function(f, title<span class="op">=</span><span class="va">None</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">2.1</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">2.1</span>, color<span class="op">=</span><span class="st">'r'</span>, ylim<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> torch.linspace(<span class="bu">min</span>,<span class="bu">max</span>, <span class="dv">100</span>)[:,<span class="va">None</span>]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ylim: plt.ylim(ylim)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    plt.plot(x, f(x), color)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: plt.title(title)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="b424637b-30bd-47d7-ffdd-b295239f698d" data-execution_count="88">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>plot_function(torch.log, <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>, <span class="bu">max</span><span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-58-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We want to transform our probabilities to larger values so we can perform mathematical operations on them. We also want our model to learn the difference between 0.99 and 0.999 (the latter is 10 times more confident). We can use the logarithm function to transform our numbers between 0 and 1 to instead be between negative infinity and positive infinity.</p>
<p>Applying negative log to the softmax output:</p>
<div class="cell" data-outputid="3f01aeb0-e692-45a9-8397-55c674e19009" data-execution_count="89">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>targ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>tensor([0, 1, 0, 1, 1, 0])</code></pre>
</div>
</div>
<div class="cell" data-outputid="6deea2fa-266c-41cd-bbb7-9f766ba0da36" data-execution_count="90">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>sm_acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor([[0.6025, 0.3975],
        [0.5021, 0.4979],
        [0.1332, 0.8668],
        [0.9966, 0.0034],
        [0.5959, 0.4041],
        [0.3661, 0.6339]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="58c93aa4-cbec-4188-a143-1f2a8eb657f3" data-execution_count="91">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>sm_acts[idx, targ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>tensor([0.6025, 0.4979, 0.1332, 0.0034, 0.4041, 0.3661])</code></pre>
</div>
</div>
<div class="cell" data-outputid="67a4f1fb-6457-49fa-9678-c8a34dcb8b50" data-execution_count="92">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>torch.log(sm_acts[idx, targ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>tensor([0.5067, 0.6973, 2.0160, 5.6958, 0.9062, 1.0048])</code></pre>
</div>
</div>
<p>The loss is larger for incorrect predictions (<code>2.0160</code> for the third image with activations of <code>0.1332</code> for <code>3</code>—the target value—and <code>0.8668</code> for <code>7</code>) and for unconfident correct predictions (<code>5.6958</code> for the fourth image with activations of <code>0.9966</code> for <code>3</code> and <code>0.0034</code> for <code>7</code>—the target value).</p>
<p>PyTorch provides the <code>nn.CrossEntropyLoss</code> class and the <code>F.cross_entropy</code> function:</p>
<div class="cell" data-outputid="e71b053f-906b-462f-ca1c-1bbb0e93539b" data-execution_count="93">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>F.cross_entropy(acts, targ, reduction<span class="op">=</span><span class="st">'none'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>tensor([0.5067, 0.6973, 2.0160, 5.6958, 0.9062, 1.0048])</code></pre>
</div>
</div>
<div class="cell" data-outputid="2b487228-3c4a-4c55-f63d-f701183b171a" data-execution_count="94">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>nn.CrossEntropyLoss(reduction<span class="op">=</span><span class="st">'none'</span>)(acts, targ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>tensor([0.5067, 0.6973, 2.0160, 5.6958, 0.9062, 1.0048])</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="create-a-function-to-calculate-predictions-loss-and-gradients" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-predictions-loss-and-gradients">Create a Function to Calculate Predictions, Loss and Gradients</h3>
<p>In this section, the text has the following function to calculate predictions, loss and gradients:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_grad(xb, yb, model):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> model(xb)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  loss <span class="op">=</span> mnist_loss(preds, yb)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I don’t think anything needs to be changed here. In my <a href="http://vishalbakshi.com/blog/posts/2023-07-24-basiclearner/2023_07_23_basiclearner.html">implementation of a <code>BasicLearner</code></a> I have generalized that function as:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_grad(<span class="va">self</span>, xb, yb, model):</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> <span class="va">self</span>.model(xb)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="va">self</span>.loss_func(preds, yb)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I believe that should work fine with <code>nn.CrossEntropyLoss()</code> as the function assigned to my <code>self.loss_func</code> parameter.</p>
</section>
<section id="create-an-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="create-an-optimizer">Create an Optimizer</h3>
<p>The optimizer’s functionality (stepping the parameters and setting the gradients to zero) will not need to be changed to handle 10 digits.</p>
</section>
<section id="create-a-function-to-train-one-epoch" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-train-one-epoch">Create a Function to Train One Epoch</h3>
<p>The steps needed to train an epoch will not need to be changed to handle 10 digits:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_epoch(model):</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> xb,yb <span class="kw">in</span> dl:</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    calc_grad(xb, yb, model)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    opt.step()</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    opt.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-a-function-to-calculate-a-metric-for-one-batch" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-a-metric-for-one-batch">Create a Function to Calculate a Metric for One Batch</h3>
<p>Along with the loss function, this is the second big change when dealing with 10 digits instead of 2. Currently, in text, we use a <code>batch_accuracy</code> function as the metric during training:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_accuracy(xb, yb):</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> xb.sigmoid()</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  correct <span class="op">=</span> (preds<span class="op">&gt;</span><span class="fl">0.5</span>) <span class="op">==</span> yb</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> correct.<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For each batch the following steps take place in calculating accuracy:</p>
<ul>
<li>Calculate the sigmoid value of the predictions.</li>
<li>Determine which predictions are greater than 0.5 and if they are, whether they are correctly labeled as <code>3</code>s.</li>
<li>Return the mean value of the previous tensor, which will calculate as number of correct predictions / number of total predictions.</li>
</ul>
<p>To understand how to calculate accuracy for a dataset with 10 digits, I’ll create an example calculation similar to what they did in chapter 5 for illustrating the softmax/log likelihood example. Suppose we have 6 images with 10 possible categories (<code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code>, <code>5</code>, <code>6</code>, <code>7</code>, <code>8</code>, <code>9</code>) and 6 labels:</p>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>torch.random.manual_seed(<span class="dv">42</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="417a0b0a-df9d-463b-8a93-1c1e9946951e" data-execution_count="96">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>acts <span class="op">=</span> torch.randn((<span class="dv">6</span>,<span class="dv">10</span>))<span class="op">*</span><span class="dv">2</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>tensor([[ 3.8538,  2.9746,  1.8014, -4.2110,  1.3568, -2.4691, -0.0861, -3.2093,
         -1.5043,  3.2974],
        [-0.7850, -2.8072, -1.4558, -1.1189, -1.5377,  1.5249,  3.2846, -0.3192,
         -0.9948,  0.8792],
        [-1.5163,  2.1566,  1.6016,  3.3612,  2.5582,  2.5928,  1.2209,  2.6695,
         -0.4632,  0.0835],
        [-0.5032,  1.7197, -2.7693, -1.7425, -0.4467,  3.4347,  0.6378, -0.8490,
          0.6114, -1.5492],
        [-3.1151,  1.9913, -1.7596, -1.2023,  0.7345,  0.3508,  2.7703, -0.8917,
          2.8903,  1.7128],
        [ 4.4362,  1.0463,  2.3507,  1.1223, -0.9055, -1.5436, -0.3444,  1.0476,
          0.1132,  0.8526]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>targ <span class="op">=</span> tensor([<span class="dv">1</span>,<span class="dv">6</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">8</span>,<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We take the <code>softmax</code> of the activations so that each row sums to <code>1</code>:</p>
<div class="cell" data-outputid="0910ee92-b05b-4a33-ea35-fe72240993ed" data-execution_count="98">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>sm_acts <span class="op">=</span> torch.softmax(acts, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>sm_acts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>tensor([[4.4919e-01, 1.8645e-01, 5.7688e-02, 1.4122e-04, 3.6982e-02, 8.0615e-04,
         8.7362e-03, 3.8453e-04, 2.1156e-03, 2.5751e-01],
        [1.2639e-02, 1.6728e-03, 6.4621e-03, 9.0509e-03, 5.9539e-03, 1.2731e-01,
         7.3978e-01, 2.0136e-02, 1.0246e-02, 6.6747e-02],
        [2.4815e-03, 9.7686e-02, 5.6077e-02, 3.2583e-01, 1.4597e-01, 1.5110e-01,
         3.8323e-02, 1.6314e-01, 7.1126e-03, 1.2288e-02],
        [1.4239e-02, 1.3148e-01, 1.4766e-03, 4.1232e-03, 1.5065e-02, 7.3058e-01,
         4.4562e-02, 1.0075e-02, 4.3404e-02, 5.0024e-03],
        [8.6558e-04, 1.4289e-01, 3.3576e-03, 5.8621e-03, 4.0662e-02, 2.7705e-02,
         3.1141e-01, 7.9971e-03, 3.5109e-01, 1.0816e-01],
        [7.7830e-01, 2.6240e-02, 9.6708e-02, 2.8313e-02, 3.7265e-03, 1.9688e-03,
         6.5311e-03, 2.6273e-02, 1.0321e-02, 2.1619e-02]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="8047efc3-b514-4f75-9021-f3d8296bf12c" data-execution_count="99">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>sm_acts.<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>tensor([1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000])</code></pre>
</div>
</div>
<p>The model’s prediction is the digit (index) with the largest probability.</p>
<div class="cell" data-outputid="5825194a-6c0f-46f4-bf96-dfd46d133632" data-execution_count="100">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>sm_acts.<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>).indices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor([0, 6, 3, 5, 8, 0])</code></pre>
</div>
</div>
<p>The accuracy is the average of the following boolean tensor (the number of correct predictions / the number of total predictions):</p>
<div class="cell" data-outputid="849d0c05-a513-415d-8601-9185ea35022a" data-execution_count="101">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>sm_acts.<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>).indices <span class="op">==</span> targ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>tensor([False,  True, False,  True,  True,  True])</code></pre>
</div>
</div>
<div class="cell" data-outputid="1c340a67-cf43-4bce-c541-e7c920f3aad0" data-execution_count="102">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>(sm_acts.<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>).indices <span class="op">==</span> targ).<span class="bu">float</span>().mean().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>0.6666666865348816</code></pre>
</div>
</div>
<p>As a function, this is what <code>batch_accuracy</code> would look like for the 10-digit classifier:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_accuracy(xb, yb):</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> torch.softmax(xb, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> preds.<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>).indices</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (preds <span class="op">==</span> yb).<span class="bu">float</span>().mean().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-a-function-to-calculate-the-metric-for-one-epoch" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-the-metric-for-one-epoch">Create a Function to Calculate the Metric for One Epoch</h3>
<p>This function will be the same for the 10-digit classifier as it was for the 2-digit classifier:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_epoch(model):</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  accs <span class="op">=</span> [batch_accuracy(model(xb), yb) <span class="cf">for</span> xb,yb <span class="kw">in</span> valid_dl]</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">round</span>(torch.stack(accs).mean().item(), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-a-function-for-the-training-loop" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-for-the-training-loop">Create a Function for the Training Loop</h3>
<p>This function will be the same for the 10-digit classifier as it was for the 2-digit classifier:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, epochs):</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    train_epoch(model)</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(validate_epoch(model), end<span class="op">=</span><span class="st">' '</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="mnist-training-loop" class="level2">
<h2 class="anchored" data-anchor-id="mnist-training-loop"><code>MNIST</code> Training Loop</h2>
<p>With that overview under my belt, I’ll walk through the training loop with real code and data.</p>
<section id="load-and-prep-data-1" class="level3">
<h3 class="anchored" data-anchor-id="load-and-prep-data-1">Load and Prep Data</h3>
<p>I’ve already loaded and prepared a shuffled <code>DataLoaders</code> object, so in this step all I need to do is check it’s size and shape:</p>
<div class="cell" data-outputid="08148c72-0c7a-4c70-b46b-2a74d8e0afe5" data-execution_count="228">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls.train.dataset), <span class="bu">len</span>(dls.valid.dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="228">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<div class="cell" data-outputid="4f80abca-d3a3-43ac-f737-6811b4ddcc7c" data-execution_count="229">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> first(dls.train)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>x.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="229">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="65bb3c72-a359-4f52-e8e1-7fd6a09f77c2" data-execution_count="230">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> first(dls.valid)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>x.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="230">
<pre><code>(torch.Size([256, 784]), torch.Size([256, 1]))</code></pre>
</div>
</div>
<div class="cell" data-outputid="c15f6efd-8707-4ce7-e653-9ef27fb62ad1" data-execution_count="231">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the digits are shuffled</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>y[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">
<pre><code>tensor([[6],
        [8],
        [2],
        [0],
        [6]])</code></pre>
</div>
</div>
</section>
<section id="create-our-model-1" class="level3">
<h3 class="anchored" data-anchor-id="create-our-model-1">Create Our Model</h3>
<p>For the first iteration of the training loop, I’ll use a similarly structured model as before:</p>
<div class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>, <span class="dv">10</span>)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-loss-function-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-loss-function-1">Create a Loss Function</h3>
<p>The loss function that I will use is <code>nn.CrossEntropyLoss</code>:</p>
<div class="cell" data-execution_count="262">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>mnist_loss <span class="op">=</span> nn.CrossEntropyLoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-function-to-calculate-predictions-loss-and-gradients-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-predictions-loss-and-gradients-1">Create a function to Calculate Predictions, Loss and Gradients</h3>
<p>This function is the same as before:</p>
<div class="cell" data-execution_count="273">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_grad(xb, yb, model):</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> model(xb)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yb has to be a 0- or 1-D tensor</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  loss <span class="op">=</span> mnist_loss(preds, yb.squeeze())</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-an-optimizer-1" class="level3">
<h3 class="anchored" data-anchor-id="create-an-optimizer-1">Create an Optimizer</h3>
<p>I’ll use the <code>BasicOptim</code> optimizer defined in chapter 4:</p>
<div class="cell" data-execution_count="235">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicOptim:</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,params,lr): <span class="va">self</span>.params,<span class="va">self</span>.lr <span class="op">=</span> <span class="bu">list</span>(params),lr</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> step(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p.data <span class="op">-=</span> p.grad.data <span class="op">*</span> <span class="va">self</span>.lr</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> zero_grad(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p.grad <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> BasicOptim(simple_net.parameters(), lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-function-to-train-one-epoch-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-train-one-epoch-1">Create a Function to Train One Epoch</h3>
<p>Same as before:</p>
<div class="cell" data-execution_count="274">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_epoch(model):</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> xb,yb <span class="kw">in</span> dls.train:</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    calc_grad(xb, yb, model)</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    opt.step()</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    opt.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-function-to-calculate-a-metric-for-one-batch-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-a-metric-for-one-batch-1">Create a Function to Calculate a Metric for One Batch</h3>
<p>The metric of interest is accuracy, and I’ll define a new <code>batch_accuracy</code> function to handle 10-digits instead of 2:</p>
<div class="cell" data-execution_count="275">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_accuracy(xb, yb):</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> torch.softmax(xb, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  preds <span class="op">=</span> preds.<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>).indices</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># squeeze yb so it's the same shape as preds</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (preds <span class="op">==</span> yb.squeeze()).<span class="bu">float</span>().mean().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-function-to-calculate-the-metric-for-one-epoch-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-to-calculate-the-metric-for-one-epoch-1">Create a Function to Calculate the Metric for One Epoch</h3>
<p>Same as before, but iterating through <code>dls.valid</code> instead of a <code>valid_dl</code> <code>DataLoader</code>:</p>
<div class="cell" data-execution_count="276">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_epoch(model):</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  accs <span class="op">=</span> [batch_accuracy(model(xb), yb) <span class="cf">for</span> xb,yb <span class="kw">in</span> dls.valid]</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">round</span>(torch.tensor(accs).mean().item(), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-the-model-for-one-epoch" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model-for-one-epoch">Train the Model for One Epoch</h3>
<p>Since I have a new loss function and accuracy function, I’ll train the model for one batch manually and then use a loop for multiple epochs.</p>
<div class="cell" data-execution_count="288">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh model</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>, <span class="dv">10</span>)</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="289">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh optimizer</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> BasicOptim(simple_net.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="290">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get one batch of the training data</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> first(dls.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="291">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate predictions</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> simple_net(xb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="4fdd6180-6f97-4255-8155-15705480e9b4" data-execution_count="292">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="292">
<pre><code>torch.Size([256, 10])</code></pre>
</div>
</div>
<p><code>nn.CrossEntropyLoss()</code> expects a 0- or 1-dimensional tensor for the labels (targets) so I have to <code>squeeze</code> the label tensor.</p>
<div class="cell" data-execution_count="293">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate loss</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mnist_loss(preds, yb.squeeze())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="b24168ca-8241-4483-e329-fe9af093bd7a" data-execution_count="294">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="294">
<pre><code>tensor(2.3140, grad_fn=&lt;NllLossBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="295">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate gradients</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="296">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># step the weights</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>opt.step()</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>opt.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="f3e9a91c-56e8-45cf-b11d-d25240e738d9" data-execution_count="297">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate accuracy using validation set</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>validate_epoch(simple_net)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="297">
<pre><code>0.1239</code></pre>
</div>
</div>
</section>
<section id="create-a-function-for-the-training-loop-1" class="level3">
<h3 class="anchored" data-anchor-id="create-a-function-for-the-training-loop-1">Create a Function for the Training Loop</h3>
<p>Now that I’ve tested my loss and accuracy function for one epoch, I can loop through the training process for multiple epochs:</p>
<div class="cell" data-execution_count="302">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, epochs):</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    train_epoch(model)</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(validate_epoch(model), end<span class="op">=</span><span class="st">' '</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="303">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh model</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>, <span class="dv">10</span>)</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="304">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh optimizer</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> BasicOptim(simple_net.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="5ac34fd4-330a-417a-a836-af566dc656ac" data-execution_count="305">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>train_model(simple_net, <span class="dv">40</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.2094 0.2522 0.3821 0.5208 0.6083 0.6399 0.6674 0.6776 0.6828 0.6894 0.701 0.7071 0.7221 0.7418 0.7549 0.7735 0.7852 0.7896 0.8061 0.8089 0.8212 0.8188 0.8264 0.8309 0.8313 0.8336 0.8378 0.8397 0.8462 0.8487 0.8511 0.8546 0.8545 0.8545 0.8597 0.8604 0.8618 0.8609 0.8612 0.8662 </code></pre>
</div>
</div>
<p>After training the model for 40 epochs with a learning rate of <code>0.001</code>, I achieve an accuracy of about 86%.</p>
<p>I’ll now test my model and see if it predicts digits correctly:</p>
<div class="cell" data-outputid="f577ba57-d198-436e-964e-7b7f12c52375" data-execution_count="342">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-100-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7f6aff3f-abac-4c98-8a0a-cfcbb05f289f" data-execution_count="343">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> simple_net(test_x)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> torch.softmax(preds, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 0</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>preds.argmax().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="343">
<pre><code>0</code></pre>
</div>
</div>
<div class="cell" data-outputid="c414b199-b3b0-4de2-feb8-cfe950557ba6" data-execution_count="344">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-102-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="bc1e1599-7793-4df4-ac4d-0c8e3852cf54" data-execution_count="346">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> simple_net(test_x)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> torch.softmax(preds, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 9</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>preds.argmax().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="346">
<pre><code>9</code></pre>
</div>
</div>
<div class="cell" data-outputid="6eddd4c7-6369-409a-d9d3-aae29d9225bc" data-execution_count="349">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">5000</span>][<span class="dv">0</span>]</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-104-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="38bc6587-1734-491c-a559-6e6c1dc9b6bf" data-execution_count="350">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> simple_net(test_x)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> torch.softmax(preds, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 4</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>preds.argmax().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="350">
<pre><code>4</code></pre>
</div>
</div>
<p>Look good! The model is correctly predicting images.</p>
<p>Next, I’ll modify my <code>BasicLearner</code> class (and call it <code>MNISTLearner</code>) so that it can handle training the full MNIST dataset.</p>
</section>
</section>
<section id="mnistlearner-class" class="level2">
<h2 class="anchored" data-anchor-id="mnistlearner-class"><code>MNISTLearner</code> Class</h2>
<p>I’ll build off my <a href="http://vishalbakshi.com/blog/posts/2023-07-24-basiclearner/2023_07_23_basiclearner.html"><code>BasicLearner</code> class</a> by incorporating some changes (mainly, changing <code>yb</code> to <code>yb.squeeze()</code> when calculating loss).</p>
<p>I’ll also add a <code>Time</code> column which displays how much time it took to train each epoch.</p>
<div class="cell" data-execution_count="441">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="446">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MNISTLearner:</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dls, model, opt_func, loss_func, metric):</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.dls <span class="op">=</span> dls</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.opt_func <span class="op">=</span> opt_func</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.loss_func <span class="op">=</span> loss_func</span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.metric <span class="op">=</span> metric</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> calc_grad(<span class="va">self</span>, xb, yb, model):</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculates loss and gradients</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> <span class="va">self</span>.model(xb)</span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="va">self</span>.loss_func(preds, yb.squeeze())</span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store the loss of each batch</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># later to be averaged across the epoch</span></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.loss <span class="op">=</span> torch.cat((<span class="va">self</span>.loss, tensor([loss])))</span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> train_epoch(<span class="va">self</span>):</span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> xb,yb <span class="kw">in</span> <span class="va">self</span>.dls.train:</span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.calc_grad(xb, yb, <span class="va">self</span>.model)</span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>      <span class="co"># steps the weights</span></span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.opt.step()</span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># resets gradient to zero</span></span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.opt.zero_grad()</span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> validate_epoch(<span class="va">self</span>):</span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a>    accs <span class="op">=</span> [<span class="va">self</span>.metric(<span class="va">self</span>.model(xb), yb) <span class="cf">for</span> xb,yb <span class="kw">in</span> <span class="va">self</span>.dls.valid]</span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculates mean accuracy across validation set</span></span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">round</span>(torch.tensor(accs).mean().item(), <span class="dv">4</span>)</span>
<span id="cb177-30"><a href="#cb177-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-31"><a href="#cb177-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> train_model(<span class="va">self</span>, model, epochs):</span>
<span id="cb177-32"><a href="#cb177-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Epoch'</span><span class="sc">:&lt;8}{</span><span class="st">'Train Loss'</span><span class="sc">:&lt;14}{</span><span class="va">self</span><span class="sc">.</span>metric<span class="sc">.</span><span class="va">__name__</span><span class="sc">:&lt;16}{</span><span class="st">'Time (s)'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb177-33"><a href="#cb177-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.epochs):</span>
<span id="cb177-34"><a href="#cb177-34" aria-hidden="true" tabindex="-1"></a>      start_time <span class="op">=</span> time.time()</span>
<span id="cb177-35"><a href="#cb177-35" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.loss <span class="op">=</span> tensor([])</span>
<span id="cb177-36"><a href="#cb177-36" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.train_epoch()</span>
<span id="cb177-37"><a href="#cb177-37" aria-hidden="true" tabindex="-1"></a>      end_time <span class="op">=</span> <span class="bu">round</span>(time.time() <span class="op">-</span> start_time,<span class="dv">4</span>)</span>
<span id="cb177-38"><a href="#cb177-38" aria-hidden="true" tabindex="-1"></a>      mean_loss <span class="op">=</span> <span class="bu">round</span>(<span class="va">self</span>.loss.mean().item(), <span class="dv">4</span>)</span>
<span id="cb177-39"><a href="#cb177-39" aria-hidden="true" tabindex="-1"></a>      mean_metric <span class="op">=</span> <span class="va">self</span>.validate_epoch()</span>
<span id="cb177-40"><a href="#cb177-40" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:&lt;8}{</span>mean_loss<span class="sc">:&lt;14}{</span>mean_metric<span class="sc">:&lt;16}{</span>end_time<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb177-41"><a href="#cb177-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-42"><a href="#cb177-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fit(<span class="va">self</span>, epochs, lr):</span>
<span id="cb177-43"><a href="#cb177-43" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.lr <span class="op">=</span> lr</span>
<span id="cb177-44"><a href="#cb177-44" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.epochs <span class="op">=</span> epochs</span>
<span id="cb177-45"><a href="#cb177-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># instantiate optimizer</span></span>
<span id="cb177-46"><a href="#cb177-46" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.opt <span class="op">=</span> <span class="va">self</span>.opt_func(<span class="va">self</span>.model.parameters(), <span class="va">self</span>.lr)</span>
<span id="cb177-47"><a href="#cb177-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># run training loop</span></span>
<span id="cb177-48"><a href="#cb177-48" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.train_model(<span class="va">self</span>.model, <span class="va">self</span>.epochs)</span>
<span id="cb177-49"><a href="#cb177-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-50"><a href="#cb177-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb177-51"><a href="#cb177-51" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="va">self</span>.model(x)</span>
<span id="cb177-52"><a href="#cb177-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># predictions should add up to 1.</span></span>
<span id="cb177-53"><a href="#cb177-53" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> torch.softmax(prediction, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb177-54"><a href="#cb177-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return probability and label</span></span>
<span id="cb177-55"><a href="#cb177-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prediction.<span class="bu">max</span>(), prediction.argmax().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="447">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh model</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">30</span>),</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>, <span class="dv">10</span>)</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="448">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate MNISTLearner</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>learner <span class="op">=</span> MNISTLearner(dls<span class="op">=</span>dls,</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>                       model<span class="op">=</span>simple_net,</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>                       opt_func<span class="op">=</span>BasicOptim,</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>                       loss_func<span class="op">=</span>nn.CrossEntropyLoss(),</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>                       metric<span class="op">=</span>batch_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="cbcd4af1-1024-41fa-a0dd-05039c342faa" data-execution_count="449">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run training loop for 40 epochs</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>learner.fit(epochs<span class="op">=</span><span class="dv">40</span>, lr<span class="op">=</span><span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch   Train Loss    batch_accuracy  Time (s)
0       2.3025        0.1194          0.7052
1       2.2658        0.1836          0.6548
2       2.2273        0.2968          0.6137
3       2.1825        0.3777          0.5981
4       2.1311        0.4608          0.6194
5       2.0769        0.5362          0.6074
6       2.0208        0.5938          0.7253
7       1.9622        0.6406          0.7677
8       1.9025        0.6746          0.6411
9       1.8408        0.6964          0.6073
10      1.7774        0.7209          0.6361
11      1.7121        0.7318          0.5707
12      1.6454        0.7428          0.886
13      1.5776        0.7583          1.0406
14      1.5094        0.7699          0.5713
15      1.4416        0.7759          0.5628
16      1.3759        0.7796          0.5508
17      1.3118        0.7882          0.5552
18      1.2518        0.7876          0.6065
19      1.1946        0.7981          0.5996
20      1.1411        0.801           0.5771
21      1.0918        0.8123          0.5345
22      1.0467        0.8177          0.5996
23      1.0042        0.8211          0.7218
24      0.966         0.8229          0.7094
25      0.9305        0.8261          0.5933
26      0.8984        0.8311          0.5768
27      0.8686        0.8356          0.5928
28      0.8416        0.8342          0.5969
29      0.8167        0.8418          0.5945
30      0.7935        0.8438          0.5933
31      0.7716        0.8449          0.5819
32      0.7519        0.8489          0.5428
33      0.7337        0.8498          0.6047
34      0.7166        0.8525          0.6062
35      0.7011        0.8511          0.5831
36      0.6862        0.8552          0.5418
37      0.6725        0.86            0.5483
38      0.6592        0.8539          0.5721
39      0.6471        0.856           0.5682</code></pre>
</div>
</div>
<p>Great! Next, I’ll test predictions of this model, one image per digit, to see how it performs. Ideally, I would have a test dataset set aside for this part, but I’ll use the validation set instead:</p>
<div class="cell" data-outputid="f8f7a417-1507-408c-d040-5a4a636625dd" data-execution_count="450">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-111-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="494c6d6b-5a61-4712-b49c-5311e006989f" data-execution_count="451">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 0</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="451">
<pre><code>(tensor(0.9909, grad_fn=&lt;MaxBackward1&gt;), 0)</code></pre>
</div>
</div>
<div class="cell" data-outputid="055f0038-afbe-47b0-9f3c-d002b64e028f" data-execution_count="452">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">1000</span>][<span class="dv">0</span>]</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-113-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="56c9f9f7-5984-4281-c694-1dfe4ea51a98" data-execution_count="453">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 1</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="453">
<pre><code>(tensor(0.7081, grad_fn=&lt;MaxBackward1&gt;), 1)</code></pre>
</div>
</div>
<div class="cell" data-outputid="1b684ccd-aee6-4e15-949a-46296214c1fe" data-execution_count="454">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">2600</span>][<span class="dv">0</span>]</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-115-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3fe0fb62-be62-45a1-ead1-858cb8a9b4ce" data-execution_count="455">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 2</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="455">
<pre><code>(tensor(0.5737, grad_fn=&lt;MaxBackward1&gt;), 4)</code></pre>
</div>
</div>
<div class="cell" data-outputid="0b024f88-d13e-4be7-f58e-9f0bd4a9c05e" data-execution_count="456">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">3600</span>][<span class="dv">0</span>]</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-117-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7d085dc6-d6f5-4fe4-cccc-ee610e17f92a" data-execution_count="457">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 3</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="457">
<pre><code>(tensor(0.7091, grad_fn=&lt;MaxBackward1&gt;), 3)</code></pre>
</div>
</div>
<div class="cell" data-outputid="ed6eb6ff-7c73-4285-c2fd-fc1fe7b6aa8e" data-execution_count="458">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">4600</span>][<span class="dv">0</span>]</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-119-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="c7931036-251b-4419-8e18-2a2551f7efe0" data-execution_count="459">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 4</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="459">
<pre><code>(tensor(0.8390, grad_fn=&lt;MaxBackward1&gt;), 4)</code></pre>
</div>
</div>
<div class="cell" data-outputid="bcd1fb83-ab6d-4cc6-d2e6-721d82721b70" data-execution_count="460">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">5600</span>][<span class="dv">0</span>]</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-121-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7d767cfe-7ff9-4adf-80e2-78138d3997fc" data-execution_count="461">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 5</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="461">
<pre><code>(tensor(0.4645, grad_fn=&lt;MaxBackward1&gt;), 5)</code></pre>
</div>
</div>
<div class="cell" data-outputid="0751af00-1b0e-4046-eada-050debc19d29" data-execution_count="462">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">6600</span>][<span class="dv">0</span>]</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-123-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="dea007a6-f283-41bc-cc0f-a4fe0ddaa94c" data-execution_count="463">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 6</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="463">
<pre><code>(tensor(0.9363, grad_fn=&lt;MaxBackward1&gt;), 6)</code></pre>
</div>
</div>
<div class="cell" data-outputid="a873acb7-6cd9-4e7c-a46d-ad95427aeb9a" data-execution_count="464">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">7100</span>][<span class="dv">0</span>]</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-125-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="0b4cc444-57ec-459f-beae-3633b4b499aa" data-execution_count="465">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 7</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="465">
<pre><code>(tensor(0.4163, grad_fn=&lt;MaxBackward1&gt;), 1)</code></pre>
</div>
</div>
<div class="cell" data-outputid="2a2d7572-0e7b-4c31-8c94-80c48d52c946" data-execution_count="466">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="dv">8500</span>][<span class="dv">0</span>]</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-127-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="6a8f26cc-e877-4706-98e3-b316b6f6223b" data-execution_count="467">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 8</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="467">
<pre><code>(tensor(0.8225, grad_fn=&lt;MaxBackward1&gt;), 8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="2481b3df-8a84-4ae2-e157-e4f5f72677f9" data-execution_count="468">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> dls.valid.dataset[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>show_image(test_x.view(<span class="op">-</span><span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07-24-full-mnist-classifier_files/figure-html/cell-129-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3ee5ca73-7d18-4fe6-f129-0bc694bc9750" data-execution_count="469">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be 9</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>learner.predict(test_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="469">
<pre><code>(tensor(0.5962, grad_fn=&lt;MaxBackward1&gt;), 9)</code></pre>
</div>
</div>
<p>Manually testing the model, it accurately predicted 80% of the digits, which makes sense given the model accuracy was 85% at the end of training.</p>
</section>
<section id="improving-the-model" class="level2">
<h2 class="anchored" data-anchor-id="improving-the-model">Improving the Model</h2>
<p>I wonder if adding another layer to my neural net will improve the model’s accuracy. I’ll arbitrarily choose an intermediate number of activations as 784/2:</p>
<div class="cell" data-execution_count="476">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a fresh model</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>simple_net <span class="op">=</span> nn.Sequential(</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">392</span>),</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">392</span>, <span class="dv">30</span>),</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">30</span>,<span class="dv">10</span>)</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="477">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate MNISTLearner</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>learner <span class="op">=</span> MNISTLearner(dls<span class="op">=</span>dls,</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>                       model<span class="op">=</span>simple_net,</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>                       opt_func<span class="op">=</span>BasicOptim,</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>                       loss_func<span class="op">=</span>nn.CrossEntropyLoss(),</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>                       metric<span class="op">=</span>batch_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="ac97f6d1-ca0d-4b9a-806a-894f9d35b355" data-execution_count="478">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run training loop for 40 epochs</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>learner.fit(epochs<span class="op">=</span><span class="dv">40</span>, lr<span class="op">=</span><span class="fl">0.005</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch   Train Loss    batch_accuracy  Time (s)
0       2.2885        0.2899          1.771
1       2.2213        0.3874          2.2249
2       2.1157        0.5674          1.6725
3       1.9426        0.6493          1.7144
4       1.6701        0.708           1.5923
5       1.3271        0.7588          1.6464
6       1.0312        0.7899          1.7139
7       0.8426        0.8186          1.9155
8       0.726         0.8276          1.8586
9       0.6467        0.8443          1.6758
10      0.5893        0.8518          1.6447
11      0.5452        0.8624          1.6898
12      0.5098        0.8768          1.653
13      0.482         0.8792          1.7703
14      0.4598        0.8817          2.0231
15      0.4412        0.8829          1.6538
16      0.4255        0.8902          1.6392
17      0.4125        0.8919          1.6541
18      0.4017        0.8894          1.6532
19      0.3917        0.8951          1.6696
20      0.3834        0.8965          2.1116
21      0.3754        0.8963          1.6413
22      0.3687        0.8975          1.6831
23      0.3623        0.8994          1.6442
24      0.3567        0.9065          1.7872
25      0.3515        0.9039          1.7696
26      0.3464        0.9052          2.1025
27      0.3415        0.9075          1.7063
28      0.3372        0.9098          1.7005
29      0.3333        0.9116          1.6846
30      0.3293        0.9107          1.6581
31      0.3258        0.9117          1.7834
32      0.3214        0.9113          1.9949
33      0.3181        0.9121          1.7621
34      0.3146        0.9122          1.7287
35      0.3113        0.9147          1.7505
36      0.3078        0.9134          1.7595
37      0.3052        0.9176          1.7835
38      0.3017        0.9174          1.966
39      0.2993        0.9183          1.9536</code></pre>
</div>
</div>
<p>Cool! I ended up with a significant improvement in accuracy, although the training took about 3 times as long to finish.</p>
<p>I’ll again test all 10 digits to see how well it predicts them:</p>
<div class="cell" data-outputid="7a3e372b-3f8c-4e51-be12-bf005679b2dd" data-execution_count="494">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>actuals <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">10</span>))</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, val <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">2600</span>, <span class="dv">3600</span>, <span class="dv">4600</span>, <span class="dv">5600</span>, <span class="dv">6600</span>, <span class="dv">7100</span>, <span class="dv">8500</span>, <span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>  test_x <span class="op">=</span> dls.valid.dataset[val][<span class="dv">0</span>]</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Actual:'</span><span class="sc">:&lt;8}{</span>actuals[idx]<span class="sc">:&lt;4}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Prediction: '</span><span class="sc">:&lt;12}{</span>learner<span class="sc">.</span>predict(test_x)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Actual: 0    Prediction: (tensor(0.9990, grad_fn=&lt;MaxBackward1&gt;), 0)
Actual: 1    Prediction: (tensor(0.9758, grad_fn=&lt;MaxBackward1&gt;), 1)
Actual: 2    Prediction: (tensor(0.8626, grad_fn=&lt;MaxBackward1&gt;), 4)
Actual: 3    Prediction: (tensor(0.9606, grad_fn=&lt;MaxBackward1&gt;), 3)
Actual: 4    Prediction: (tensor(0.9981, grad_fn=&lt;MaxBackward1&gt;), 4)
Actual: 5    Prediction: (tensor(0.9614, grad_fn=&lt;MaxBackward1&gt;), 5)
Actual: 6    Prediction: (tensor(0.9982, grad_fn=&lt;MaxBackward1&gt;), 6)
Actual: 7    Prediction: (tensor(0.8736, grad_fn=&lt;MaxBackward1&gt;), 7)
Actual: 8    Prediction: (tensor(0.9901, grad_fn=&lt;MaxBackward1&gt;), 8)
Actual: 9    Prediction: (tensor(0.9784, grad_fn=&lt;MaxBackward1&gt;), 9)</code></pre>
</div>
</div>
<p>My manual testing resulted in the model predicting 90% of the digits correctly, which makes sense given the increase in accuracy of the model.</p>
</section>
<section id="further-improvements" class="level2">
<h2 class="anchored" data-anchor-id="further-improvements">Further Improvements</h2>
<p>There are of course unlimited improvements when it comes to trying out different models. I could vary the number of intermediate activations, number of layers, and overall architecture.</p>
<p>I could also add a validation loss to understand when the model is overfitting.</p>
<p>Overall, I am thrilled that this exercise was successful, and had a really fun time working through it. I hope you enjoyed this blog post!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>