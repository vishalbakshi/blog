<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Vishal Bakshi's Blog – index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#the-fastbook-benchmark-dataset" id="toc-the-fastbook-benchmark-dataset" class="nav-link" data-scroll-target="#the-fastbook-benchmark-dataset">The fastbook-benchmark Dataset</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#chunking-strategy-a-1-paragraph-with-headers" id="toc-chunking-strategy-a-1-paragraph-with-headers" class="nav-link" data-scroll-target="#chunking-strategy-a-1-paragraph-with-headers">Chunking Strategy A: 1-Paragraph (with headers)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search" id="toc-retrieval-method-full-text-search" class="nav-link" data-scroll-target="#retrieval-method-full-text-search">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity" id="toc-retrieval-method-single-vector-cosine-similarity" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2" id="toc-retrieval-method-colbertv2" class="nav-link" data-scroll-target="#retrieval-method-colbertv2">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1" id="toc-retrieval-method-answerai-colbert-small-v1" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#chunking-strategy-b-3-paragraph-with-headers" id="toc-chunking-strategy-b-3-paragraph-with-headers" class="nav-link" data-scroll-target="#chunking-strategy-b-3-paragraph-with-headers">Chunking Strategy B: 3-Paragraph (with headers)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search-1" id="toc-retrieval-method-full-text-search-1" class="nav-link" data-scroll-target="#retrieval-method-full-text-search-1">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity-1" id="toc-retrieval-method-single-vector-cosine-similarity-1" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity-1">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2-1" id="toc-retrieval-method-colbertv2-1" class="nav-link" data-scroll-target="#retrieval-method-colbertv2-1">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1-1" id="toc-retrieval-method-answerai-colbert-small-v1-1" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1-1">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#chunking-strategy-c-1-paragraph-wo-headers" id="toc-chunking-strategy-c-1-paragraph-wo-headers" class="nav-link" data-scroll-target="#chunking-strategy-c-1-paragraph-wo-headers">Chunking Strategy C: 1-Paragraph (w/o headers)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search-2" id="toc-retrieval-method-full-text-search-2" class="nav-link" data-scroll-target="#retrieval-method-full-text-search-2">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity-2" id="toc-retrieval-method-single-vector-cosine-similarity-2" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity-2">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2-2" id="toc-retrieval-method-colbertv2-2" class="nav-link" data-scroll-target="#retrieval-method-colbertv2-2">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1-2" id="toc-retrieval-method-answerai-colbert-small-v1-2" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1-2">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#chunking-strategy-d-3-paragraph-wo-headers" id="toc-chunking-strategy-d-3-paragraph-wo-headers" class="nav-link" data-scroll-target="#chunking-strategy-d-3-paragraph-wo-headers">Chunking Strategy D: 3-Paragraph (w/o headers)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search-3" id="toc-retrieval-method-full-text-search-3" class="nav-link" data-scroll-target="#retrieval-method-full-text-search-3">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity-3" id="toc-retrieval-method-single-vector-cosine-similarity-3" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity-3">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2-3" id="toc-retrieval-method-colbertv2-3" class="nav-link" data-scroll-target="#retrieval-method-colbertv2-3">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1-3" id="toc-retrieval-method-answerai-colbert-small-v1-3" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1-3">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#chunking-strategy-e-3-paragraph-wheaders-wo-html-tags" id="toc-chunking-strategy-e-3-paragraph-wheaders-wo-html-tags" class="nav-link" data-scroll-target="#chunking-strategy-e-3-paragraph-wheaders-wo-html-tags">Chunking Strategy E: (3-paragraph w/headers, w/o HTML tags)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search-4" id="toc-retrieval-method-full-text-search-4" class="nav-link" data-scroll-target="#retrieval-method-full-text-search-4">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity-4" id="toc-retrieval-method-single-vector-cosine-similarity-4" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity-4">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2-4" id="toc-retrieval-method-colbertv2-4" class="nav-link" data-scroll-target="#retrieval-method-colbertv2-4">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1-4" id="toc-retrieval-method-answerai-colbert-small-v1-4" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1-4">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation" id="toc-chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation" class="nav-link" data-scroll-target="#chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation">Chunking Strategy F: (w/headers, w/o HTML tags, w/o punctuation)</a>
  <ul class="collapse">
  <li><a href="#retrieval-method-full-text-search-5" id="toc-retrieval-method-full-text-search-5" class="nav-link" data-scroll-target="#retrieval-method-full-text-search-5">Retrieval Method: Full Text Search</a></li>
  <li><a href="#retrieval-method-single-vector-cosine-similarity-5" id="toc-retrieval-method-single-vector-cosine-similarity-5" class="nav-link" data-scroll-target="#retrieval-method-single-vector-cosine-similarity-5">Retrieval Method: Single-Vector Cosine Similarity</a></li>
  <li><a href="#retrieval-method-colbertv2-5" id="toc-retrieval-method-colbertv2-5" class="nav-link" data-scroll-target="#retrieval-method-colbertv2-5">Retrieval Method: ColBERTv2</a></li>
  <li><a href="#retrieval-method-answerai-colbert-small-v1-5" id="toc-retrieval-method-answerai-colbert-small-v1-5" class="nav-link" data-scroll-target="#retrieval-method-answerai-colbert-small-v1-5">Retrieval Method: answerai-colbert-small-v1</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I re-run my full text search and semantic search retrieval methods for fastbook questions and use my newly curated <a href="https://gist.github.com/vishalbakshi/a507b6e9e893475e93a4141e96b8947d">fastbook-benchmark</a> dataset to calculate Answer Component MRR@10 and Answer Component Recall@10 retrieval metrics. Due to how my benchmark dataset is structured, I had to modify (with Claude’s help) the classic MRR and Recall functions:</p>
<ul>
<li><p>Answer Component MRR@10: Returns the rank of the n-th passage needed to satisfy all <code>answer_component</code>s for the question. So, if a question has 4 <code>answer_component</code>s and their relevant contexts were contained across the first 5 retrieved passages, MRR would be 1/5 = 0.2.</p></li>
<li><p>Answer Component Recall@10: Measures the proportion of answer components for which at least one supporting context was retrieved. Using the same example, if the top-10 passages only contain contexts relevant to 2 <code>answer_component</code>s, Recall would be 2/4 = 0.5</p></li>
</ul>
<p>See the section below to see how my benchmark dataset is structured.</p>
<p>There are four retrieval methods I implement in this notebook:</p>
<ul>
<li>Full text search (using sqlite and Claude-generated keywords)</li>
<li>Single-vector cosine similarity (using BAAI/bge-small-en-v1.5)</li>
<li>ColBERTv2</li>
<li>answerai-colbert-small-v1</li>
</ul>
<p>There are six chunking strategies I implement:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chunking Strategy Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1-paragraph (w/headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">3-paragraph (w/headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1-paragraph (w/o headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">3-paragraph (w/o headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">E</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags)</td>
</tr>
<tr class="even">
<td style="text-align: center;">F</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags, w/o punctuation)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<p><strong>Answer Component MRR@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.44</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.46</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.35</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.41</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">0.48</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>Answer Component Recall@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">83%</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">71%</td>
<td style="text-align: center;">85%</td>
<td style="text-align: center;">72%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">87%</td>
<td style="text-align: center;">86%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">74%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">81%</td>
<td style="text-align: center;">71%</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">77%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">73%</td>
</tr>
</tbody>
</table>
<p>The best-performing retrieval method and chunking strategies:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Metric Name</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">Chunking Strategies</th>
<th style="text-align: center;">Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Answer Component MRR@10</td>
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">B, D, E</td>
<td style="text-align: center;">0.52</td>
</tr>
<tr class="even">
<td style="text-align: center;">Answer Component Recall@10</td>
<td style="text-align: center;">Single-vector cosine similiarty</td>
<td style="text-align: center;">E</td>
<td style="text-align: center;">87%</td>
</tr>
</tbody>
</table>
</section>
<section id="the-fastbook-benchmark-dataset" class="level2">
<h2 class="anchored" data-anchor-id="the-fastbook-benchmark-dataset">The fastbook-benchmark Dataset</h2>
<p>The fastbook-benchmark dataset contains a list of items (questions). Each item looks something like this:</p>
<pre><code>{
            "chapter": 1,
            "question_number": 1,
            "question_text": "Do you need these for deep learning?\n\n- Lots of math..."",
            "answer_context": [
                {
                    "answer_component": "\"Lots of math..."",
                    "scoring_type": "simple",
                    "context": [
                        "...Lots of math..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                }
            ],
            "question_context": []
        },</code></pre>
<p>I have broken down each <code>gold_standard_answer</code> into separate <code>answer_component</code>s, each of which has associated with it one or more <code>context</code>s from the chapter text that address that <code>answer_component</code>. Here’s an example of a question with two <code>answer_component</code>s:</p>
<pre><code>{
            "chapter": 1,
            "question_number": 5,
            "question_text": "What were the two theoretical misunderstandings that held back the field of neural networks?",
            "gold_standard_answer": "\"In 1969..."",
            "answer_context": [
                {
                    "answer_component": "\"In 1969..."",
                    "scoring_type": "simple",
                    "context": [
                        "An MIT professor named..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                },
                {
                    "answer_component": "\"\n\nIn the 1980's..."",
                    "scoring_type": "simple",
                    "context": [
                        "In the 1980's..."
                    ],
                    "explicit_context": "true",
                    "extraneous_answer": "false"
                }
            ],
            "question_context": []
        },</code></pre>
<p>Any one of the <code>context</code>s is sufficient to address the associated <code>answer_component</code>. For example, for Chapter 1 Question 12:</p>
<pre><code>{
  "answer_component": "We instead use the term parameters.",
  "scoring_type": "simple",
  "context": [
      "By the way, what Samuel called \"weights\" are most generally referred to as model *parameters* these days",

      "The *weights* are called *parameters*"
  ],
  "explicit_context": "true",
  "extraneous_answer": "false"
}</code></pre>
<p>For some questions’ <code>gold_standard_answer</code> I found that some <code>answer_component</code>s were extraneous to the goal of the question. These have been marked with the flag <code>"extraneous_answer": "false"</code>.</p>
<p>For some <code>answer_component</code>s I found the corresponding <code>context</code> implicitly addressing it. These have been marked with the flag <code>"explicit_context": "false"</code>.</p>
<p>Finally, for some <code>answer_component</code>s I did not find relevant context in the given chapter so the <code>context</code> field is assigned an empty list <code>[]</code>.</p>
<p>All of the design decisions for this fastbook-benchmark dataset have largely been driven by one goal: don’t change the <code>gold_standard_answer</code>. I have been using the fastai Forums’ Wiki solutions page for each chapter as the gold standard answer set (<a href="https://forums.fast.ai/t/fastbook-chapter-1-questionnaire-solutions-wiki/65647">example</a>).</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>::: {.cell _cell_guid=‘b1076dfc-b9ad-4769-8c92-a6c4dae69d19’ _uuid=‘8f2839f25d086af736a60e9eeb907d3b93b6e0e5’ trusted=‘true’}</p>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install sentence<span class="op">-</span>transformers <span class="op">-</span>Uqq</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq RAGatouille</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install ftfy <span class="op">-</span>qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<div class="cell" data-trusted="true">
<details>
<summary>Show imports</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ftfy <span class="im">import</span> fix_text</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ragatouille <span class="im">import</span> RAGPretrainedModel</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>emb_model <span class="op">=</span> SentenceTransformer(<span class="st">"BAAI/bge-small-en-v1.5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:40:50.025834Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:40:50.025034Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:40:50.036117Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:40:50.035220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:40:50.025798Z&quot;}" data-trusted="true" data-execution_count="3">
<details>
<summary>Show chunking code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_chunks(notebook_path):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(notebook_path, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        notebook <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> []</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    current_header <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_chunk(content):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content.strip():</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            chunks.append(<span class="ss">f"</span><span class="sc">{</span>current_header<span class="sc">}</span><span class="ch">\n\n</span><span class="sc">{</span>content<span class="sc">.</span>strip()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cell <span class="kw">in</span> notebook[<span class="st">'cells'</span>]:</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cell[<span class="st">'cell_type'</span>] <span class="op">==</span> <span class="st">'markdown'</span>:</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> <span class="st">''</span>.join(cell[<span class="st">'source'</span>])</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># see if the cell starts with a markdown header</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            header_match <span class="op">=</span> re.match(<span class="vs">r'^(#+\s+.*?)$'</span>, content, re.MULTILINE)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> header_match:</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># grab the header</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                current_header <span class="op">=</span> header_match.group(<span class="dv">1</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># add any content after the header in the same cell</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                remaining_content <span class="op">=</span> content[<span class="bu">len</span>(current_header):].strip()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> remaining_content:</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># split content into paragraphs</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>                    paragraphs <span class="op">=</span> re.split(<span class="vs">r'\n\s*\n'</span>, remaining_content)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># append the paragraph to the list of chunks</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> paragraph <span class="kw">in</span> paragraphs:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                        add_chunk(paragraph)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                <span class="co"># split content into paragraphs</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                paragraphs <span class="op">=</span> re.split(<span class="vs">r'\n\s*\n'</span>, content)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                <span class="co"># append the paragraph to the list of chunks</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> paragraph <span class="kw">in</span> paragraphs:</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                    add_chunk(paragraph)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> cell[<span class="st">'cell_type'</span>] <span class="op">==</span> <span class="st">'code'</span>:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>          code_content <span class="op">=</span> <span class="st">'```python</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> <span class="st">''</span>.join(cell[<span class="st">'source'</span>]) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">```'</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>          <span class="co"># include the output of the code cell</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>          output_content <span class="op">=</span> <span class="st">''</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">'outputs'</span> <span class="kw">in</span> cell <span class="kw">and</span> cell[<span class="st">'outputs'</span>]:</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> output <span class="kw">in</span> cell[<span class="st">'outputs'</span>]:</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> <span class="st">'text'</span> <span class="kw">in</span> output:</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                      output_content <span class="op">+=</span> <span class="st">''</span>.join(output[<span class="st">'text'</span>])</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">elif</span> <span class="st">'data'</span> <span class="kw">in</span> output <span class="kw">and</span> <span class="st">'text/plain'</span> <span class="kw">in</span> output[<span class="st">'data'</span>]:</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                      output_content <span class="op">+=</span> <span class="st">''</span>.join(output[<span class="st">'data'</span>][<span class="st">'text/plain'</span>])</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>          <span class="co"># combine code and output in the same chunk</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>          combined_content <span class="op">=</span> code_content <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">Output:</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> output_content <span class="cf">if</span> output_content <span class="cf">else</span> code_content</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>          add_chunk(combined_content)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> filter_chunks(chunks, exclude_headers<span class="op">=</span>[<span class="st">"Questionnaire"</span>, <span class="st">"Further Research"</span>]):</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>      filtered_chunks <span class="op">=</span> []</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>          lines <span class="op">=</span> chunk.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>          <span class="co"># check if the first line (header) is in the exclude list</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(header <span class="kw">in</span> lines[<span class="dv">0</span>] <span class="cf">for</span> header <span class="kw">in</span> exclude_headers):</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>              filtered_chunks.append(chunk)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> filtered_chunks</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filter_chunks(chunks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:40:57.639923Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:40:57.639543Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:40:57.647438Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:40:57.646406Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:40:57.639889Z&quot;}" data-trusted="true" data-execution_count="59">
<details>
<summary>Show chunking code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_chunks(chunks, num_p<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    combined_chunks <span class="op">=</span> []</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    current_header <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    current_group <span class="op">=</span> []</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract header from chunk</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        header <span class="op">=</span> chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)[<span class="dv">0</span>]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> header <span class="op">!=</span> current_header:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&gt;</span> <span class="dv">1</span>:  <span class="co"># Only add if group has content besides header</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add current group to combined chunks if header changes</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update current header</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            current_header <span class="op">=</span> header</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Start new group with header and content of current chunk</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            current_group <span class="op">=</span> [header, chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span>]</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&lt;</span> num_p <span class="op">+</span> <span class="dv">1</span>:  <span class="co"># +1 to account for header</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add chunk content (without header) to current group</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>                current_group.append(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(chunk.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">==</span> num_p <span class="op">+</span> <span class="dv">1</span>:  <span class="co"># +1 to account for header</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add full group to combined chunks</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Reset current group, keeping the header</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                current_group <span class="op">=</span> [current_header]</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&gt;</span> <span class="dv">1</span>:  <span class="co"># Only add if group has content besides header</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add any remaining group to combined chunks</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:04.360423Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:04.360060Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:04.367195Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:04.366259Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:04.360389Z&quot;}" data-trusted="true" data-execution_count="5">
<details>
<summary>Show the <code>load_data</code> function used for full text search</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(chunks, db_path, chapter<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create virtual table if database doesn't exist</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(db_path):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(db_path) <span class="im">as</span> conn:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>              cur <span class="op">=</span> conn.cursor()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>              cur.execute(<span class="st">"""</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">              CREATE VIRTUAL TABLE fastbook_text</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">              USING FTS5(chapter, text);</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">              """</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>              conn.commit()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># load in the chunks for each chapter</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(db_path) <span class="im">as</span> conn:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            cur <span class="op">=</span> conn.cursor()</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                cur.execute(<span class="st">"INSERT INTO fastbook_text(chapter, text) VALUES (?, ?)"</span>, (chapter, chunk))</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            conn.commit()</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            res <span class="op">=</span> cur.execute(<span class="st">"SELECT * FROM fastbook_text WHERE chapter = ?"</span>, (chapter,)).fetchall()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make sure all the data was loaded into the database</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(res) <span class="op">!=</span> <span class="bu">len</span>(chunks):</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Number of inserted chunks (</span><span class="sc">{</span><span class="bu">len</span>(res)<span class="sc">}</span><span class="ss">) doesn't match input chunks (</span><span class="sc">{</span><span class="bu">len</span>(chunks)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> sqlite3.Error <span class="im">as</span> e:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:10.555260Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:10.554898Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:10.561423Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:10.560523Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:10.555227Z&quot;}" data-trusted="true" data-execution_count="6">
<details>
<summary>Show the <code>db_search</code> function used for full text search</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> db_search(df, limit<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  results <span class="op">=</span> []</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> sqlite3.<span class="ex">connect</span>(<span class="st">'fastbook.db'</span>) <span class="im">as</span> conn:</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> conn.cursor()</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># concatenate the keywords into a string "keyword1 OR keyword 2 OR keyword3 ..."</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      keywords <span class="op">=</span> <span class="st">' OR '</span>.join([<span class="ss">f'"</span><span class="sc">{</span>keyword<span class="sc">.</span>strip(<span class="st">","</span>)<span class="sc">}</span><span class="ss">"'</span> <span class="cf">for</span> keyword <span class="kw">in</span> row[<span class="st">'keywords'</span>].replace(<span class="st">'"'</span>, <span class="st">''</span>).split()])</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      q <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT text, rank</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM fastbook_text</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        WHERE fastbook_text MATCH ?</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        AND chapter = ?</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="ss">        ORDER BY rank</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="ss">        LIMIT ?</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> cur.execute(q, (keywords, <span class="bu">str</span>(row[<span class="st">'chapter'</span>]), limit)).fetchall()</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># grab the retrieved chunk from the query results</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> [item[<span class="dv">0</span>] <span class="cf">for</span> item <span class="kw">in</span> res]</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if there are multiple chunks retrieved, combine them into a single string</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      results.append(res)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:18.494100Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:18.493681Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:37.633040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:37.632137Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:18.494059Z&quot;}" data-outputid="5ae64c31-c3da-4454-8bda-9378f25d3613" data-trusted="true" data-execution_count="7">
<details>
<summary>Download chapter ipynb files</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>urls <span class="op">=</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'01_intro.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1mmBjFH_plndPBC4iRZHChfMazgBxKK4_'</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'02_production.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1Cf5QHthHy1z13H0iu3qrzAWgquCfqVHk'</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'04_mnist_basics.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=113909_BNulzyLIKUNJHdya0Hhoqie30I'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'08_collab.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1BtvStgFjUtvtqbSZNrL7Y2N-ey3seNZU'</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'09_tabular.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1rHFvwl_l-AJLg_auPjBpNrOgG9HDnfqg'</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10_nlp.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=1pg1pH7jMMElzrXS0kBBz14aAuDsi2DEP'</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'13_convolutions.ipynb'</span>: <span class="st">'https://drive.google.com/uc?export=view&amp;id=19P-eEHpAO3WrOvdxgXckyhHhfv_R-hnS'</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_file(url, filename):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send a GET request to the URL</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the request was successful</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the file in write-binary mode</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">'wb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the content of the response to the file</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(response.content)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File downloaded successfully: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to download file. Status code: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fname, url <span class="kw">in</span> urls.items():</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  download_file(url, fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: 01_intro.ipynb
File downloaded successfully: 02_production.ipynb
File downloaded successfully: 04_mnist_basics.ipynb
File downloaded successfully: 08_collab.ipynb
File downloaded successfully: 09_tabular.ipynb
File downloaded successfully: 10_nlp.ipynb
File downloaded successfully: 13_convolutions.ipynb</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:41.213422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:41.213043Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:41.217836Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:41.216877Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:41.213381Z&quot;}" data-trusted="true" data-execution_count="8">
<details>
<summary>Show the dict w/ notebook filenames</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>nbs <span class="op">=</span> {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'1'</span>: <span class="st">'01_intro.ipynb'</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2'</span>: <span class="st">'02_production.ipynb'</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'4'</span>: <span class="st">'04_mnist_basics.ipynb'</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'8'</span>: <span class="st">'08_collab.ipynb'</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'9'</span>: <span class="st">'09_tabular.ipynb'</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10'</span>: <span class="st">'10_nlp.ipynb'</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'13'</span>: <span class="st">'13_convolutions.ipynb'</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:47.840474Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:47.839850Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:48.275128Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:48.274245Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:47.840432Z&quot;}" data-outputid="062365c7-026f-415c-82a8-2487ac087279" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the question texts</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://gist.githubusercontent.com/vishalbakshi/2c22ca69ac7bc4bc845052c1b9d949c8/raw/d498259f2fc75d27c485ddc73933f145987feef3/cs_bm25_baselines.csv'</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>questions <span class="op">=</span> pd.read_csv(url).query(<span class="st">"is_answerable == 1"</span>)[[<span class="st">"chapter"</span>, <span class="st">"question_number"</span>, <span class="st">"question_text"</span>, <span class="st">"answer"</span>, <span class="st">"keywords"</span>]]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># remove double quotations from the question text</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># as these affect embeddings/cosine similarity: https://vishalbakshi.github.io/blog/posts/2024-11-08-punctuation-cosine-similarity/</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>questions[<span class="st">'question_text'</span>] <span class="op">=</span> questions[<span class="st">'question_text'</span>].<span class="bu">str</span>.strip(<span class="st">'"</span><span class="ch">\'</span><span class="st">'</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>questions.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">


  <div id="df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>chapter</th>
      <th>question_number</th>
      <th>question_text</th>
      <th>answer</th>
      <th>keywords</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>Do you need these for deep learning?\n\n- Lots...</td>
      <td>"Lots of math - False\nLots of data - False\nL...</td>
      <td>"deep learning, math, data, computers, PhD"</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>Name five areas where deep learning is now the...</td>
      <td>"Any five of the following:\nNatural Language ...</td>
      <td>deep learning, areas, best, world</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>What was the name of the first device that was...</td>
      <td>"Mark I perceptron built by Frank Rosenblatt"</td>
      <td>"neuron, neurons, device, artificial, principle"</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>Based on the book of the same name, what are t...</td>
      <td>"A set of processing units\nA state of activat...</td>
      <td>"parallel, distributed, processing, PDP, requi...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>What were the two theoretical misunderstanding...</td>
      <td>"In 1969, Marvin Minsky and Seymour Papert dem...</td>
      <td>"neural, networks, theoretical, misunderstandi...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-3e6b4ae2-1a9d-4308-bcbd-b26864aa22b3');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-05c06f37-b463-46c7-b469-35a27b3ccafc">
  <button class="colab-df-quickchart" onclick="quickchart('df-05c06f37-b463-46c7-b469-35a27b3ccafc')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-05c06f37-b463-46c7-b469-35a27b3ccafc button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:41:55.266890Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:41:55.265966Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:41:55.271153Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:41:55.270326Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:41:55.266842Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> questions.shape <span class="op">==</span> (<span class="dv">191</span>,<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:05.050170Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:05.049578Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:05.255531Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:05.254600Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:05.050132Z&quot;}" data-outputid="16dfee82-dbf5-42b4-ef9b-6e7c4954cb08" data-trusted="true" data-execution_count="163">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download fastbook-benchmark</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>download_file(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://gist.githubusercontent.com/vishalbakshi/a507b6e9e893475e93a4141e96b8947d/raw/e32835ba1dbf94384943ed5a65404112e1c89df2/fastbook-benchmark.json"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fastbook-benchmark.json"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the benchmark data</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'fastbook-benchmark.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    benchmark <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File downloaded successfully: fastbook-benchmark.json</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:11.224927Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:11.224542Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:11.229055Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:11.228216Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:11.224887Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(benchmark[<span class="st">'questions'</span>]) <span class="op">==</span> <span class="dv">191</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:18.313016Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:18.312453Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:18.318329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:18.317466Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:18.312980Z&quot;}" data-trusted="true" data-execution_count="13">
<details>
<summary>Show <code>calculate_mrr</code> function</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_mrr(question, retrieved_passages, cutoff<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    retrieved_passages <span class="op">=</span> retrieved_passages[:cutoff]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    highest_rank <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ans_comp <span class="kw">in</span> question[<span class="st">"answer_context"</span>]:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        contexts <span class="op">=</span> ans_comp.get(<span class="st">"context"</span>, [])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        component_found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rank, passage <span class="kw">in</span> <span class="bu">enumerate</span>(retrieved_passages, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(fix_text(context) <span class="kw">in</span> fix_text(passage) <span class="cf">for</span> context <span class="kw">in</span> contexts):</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                highest_rank <span class="op">=</span> <span class="bu">max</span>(highest_rank, rank)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                component_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> component_found:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1.0</span><span class="op">/</span>highest_rank <span class="cf">if</span> highest_rank <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:24.358734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:24.358394Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:24.364432Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:24.363549Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:24.358702Z&quot;}" data-trusted="true" data-execution_count="14">
<details>
<summary>Show <code>calculate_recall</code> function</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_recall(question, retrieved_passages, cutoff<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    retrieved_passages <span class="op">=</span> retrieved_passages[:cutoff]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track if we've found at least one context for each answer component</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    ans_comp_found <span class="op">=</span> []</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ans_comp <span class="kw">in</span> question[<span class="st">"answer_context"</span>]:</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        contexts <span class="op">=</span> ans_comp.get(<span class="st">"context"</span>, [])</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if any context for this answer component appears in retrieved passages</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> passage <span class="kw">in</span> retrieved_passages:</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(fix_text(context) <span class="kw">in</span> fix_text(passage) <span class="cf">for</span> context <span class="kw">in</span> contexts):</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>                found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        ans_comp_found.append(found)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recall is ratio of answer components with at least one found context</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(ans_comp_found) <span class="op">/</span> <span class="bu">len</span>(ans_comp_found)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:31.976734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:31.976386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:31.982038Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:31.981238Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:31.976705Z&quot;}" data-trusted="true" data-execution_count="15">
<details>
<summary>Show <code>fts_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fts_retrieval(data, questions):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(<span class="st">"fastbook.db"</span>):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        os.remove(<span class="st">"fastbook.db"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f"Chapter </span><span class="sc">{</span>chapter<span class="sc">}</span><span class="ss">:"</span>, load_data(chunks, <span class="st">'fastbook.db'</span>, chapter))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Retrieving passages..."</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> db_search(questions, limit<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> results:</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(res) <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Retrieval complete."</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:42:40.213339Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:42:40.212942Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:42:40.221922Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:42:40.221014Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:42:40.213297Z&quot;}" data-trusted="true" data-execution_count="16">
<details>
<summary>Show <code>single_vector_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> single_vector_retrieval(data, benchmark):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group questions by chapter</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    questions <span class="op">=</span> {}</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> benchmark[<span class="st">"questions"</span>]:</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        chapter <span class="op">=</span> <span class="bu">str</span>(q[<span class="st">"chapter"</span>])</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chapter <span class="kw">not</span> <span class="kw">in</span> questions:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>            questions[chapter] <span class="op">=</span> []</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        questions[chapter].append(q[<span class="st">'question_text'</span>].strip(<span class="st">'"</span><span class="ch">\'</span><span class="st">'</span>))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    q_embs <span class="op">=</span> {}</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Encoding Questions..."</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter, _ <span class="kw">in</span> data.items():</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        qs <span class="op">=</span> questions[chapter]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        q_embs[chapter] <span class="op">=</span> emb_model.encode(qs, convert_to_tensor<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    data_embs <span class="op">=</span> {}</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Encoding Data..."</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        data_embs[chapter] <span class="op">=</span> emb_model.encode(chunks, convert_to_tensor<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Retrieving passages..."</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter <span class="kw">in</span> [<span class="st">'1'</span>, <span class="st">'2'</span>, <span class="st">'4'</span>, <span class="st">'8'</span>, <span class="st">'9'</span>, <span class="st">'10'</span>, <span class="st">'13'</span>]:</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute cosine similarity and get top 10 indices for each row</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        idxs <span class="op">=</span> F.cosine_similarity(q_embs[chapter].unsqueeze(<span class="dv">1</span>), data_embs[chapter].unsqueeze(<span class="dv">0</span>), dim<span class="op">=</span><span class="dv">2</span>).sort(descending<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        top_10_idxs <span class="op">=</span> idxs[:, :<span class="dv">10</span>]  <span class="co"># Get the top 10 indices for each row</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract top 10 chunks for each row</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        top_10_chunks <span class="op">=</span> [</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>            [data[chapter][idx.item()] <span class="cf">for</span> idx <span class="kw">in</span> row_idxs]</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row_idxs <span class="kw">in</span> top_10_idxs</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        results.extend(top_10_chunks)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> results:</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(res) <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Retrieval complete."</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:06:39.877391Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:06:39.877005Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:06:39.885940Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:06:39.885048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:06:39.877357Z&quot;}" data-trusted="true" data-execution_count="17">
<details>
<summary>Show <code>ragetouille_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op">=</span><span class="st">"colbert-ir/colbertv2.0"</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group questions by chapter</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    questions_by_chapter <span class="op">=</span> {}</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> benchmark[<span class="st">"questions"</span>]:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        chapter <span class="op">=</span> <span class="bu">str</span>(q[<span class="st">"chapter"</span>])</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chapter <span class="kw">not</span> <span class="kw">in</span> questions_by_chapter:</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>            questions_by_chapter[chapter] <span class="op">=</span> []</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        questions_by_chapter[chapter].append(q)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dictionary to store results per chapter</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    chapter_results <span class="op">=</span> {}</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    chapter_metrics <span class="op">=</span> {}</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize ColBERTv2</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    RAG <span class="op">=</span> RAGPretrainedModel.from_pretrained(model_nm)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each chapter separately</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter <span class="kw">in</span> nbs.keys():</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing Chapter </span><span class="sc">{</span>chapter<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create chapter-specific index</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        index_path <span class="op">=</span> RAG.index(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            index_name<span class="op">=</span><span class="ss">f"chapter_</span><span class="sc">{</span>chapter<span class="sc">}</span><span class="ss">_index"</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            collection<span class="op">=</span>data[chapter],</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            document_ids<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>chapter<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[chapter]))]</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get questions for this chapter</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        chapter_questions <span class="op">=</span> questions_by_chapter[chapter]</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Perform retrieval for each question in this chapter</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> q <span class="kw">in</span> chapter_questions:</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            retrieved <span class="op">=</span> RAG.search(q[<span class="st">"question_text"</span>].strip(<span class="st">'"</span><span class="ch">\'</span><span class="st">'</span>), k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>            results.append(retrieved)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store results</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        chapter_results[chapter] <span class="op">=</span> results</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chapter, res <span class="kw">in</span> chapter_results.items():</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        results.extend(res)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(results) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    final_results <span class="op">=</span> []</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> results:</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(res) <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        intermediate_results <span class="op">=</span> [r[<span class="st">'content'</span>] <span class="cf">for</span> r <span class="kw">in</span> res]</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        final_results.append(intermediate_results)</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Retrieval complete."</span>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:06:51.651038Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:06:51.650684Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:06:51.656817Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:06:51.655754Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:06:51.651007Z&quot;}" data-trusted="true" data-execution_count="18">
<details>
<summary>Show <code>do_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> do_retrieval(method, chunking_strategy, data, benchmark, benchmark_results, questions<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> method <span class="op">==</span> <span class="st">"bm25"</span>: results <span class="op">=</span> fts_retrieval(data, questions)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> method <span class="op">==</span> <span class="st">"single_vector"</span>: results <span class="op">=</span> single_vector_retrieval(data, benchmark)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> method <span class="op">==</span> <span class="st">"colbertv2"</span>: results <span class="op">=</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op">=</span><span class="st">"colbert-ir/colbertv2.0"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> method <span class="op">==</span> <span class="st">"answerai_colbert"</span>: results <span class="op">=</span> ragatouille_retrieval(data, benchmark, model_nm<span class="op">=</span><span class="st">"answerdotai/answerai-colbert-small-v1"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>method<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>chunking_strategy<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  q_mrr, q_recall <span class="op">=</span> score_retrieval(results, benchmark)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  benchmark_results <span class="op">=</span> save_results(results, benchmark_results, q_mrr, q_recall, name<span class="op">=</span>name)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> benchmark_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:43:03.484422Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:43:03.483575Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:43:03.491562Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:43:03.490588Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:43:03.484360Z&quot;}" data-trusted="true" data-execution_count="19">
<details>
<summary>Show <code>score_retrieval</code> function</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_retrieval(results, benchmark):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    q_mrr <span class="op">=</span> []</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    q_recall <span class="op">=</span> []</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, question <span class="kw">in</span> <span class="bu">enumerate</span>(benchmark[<span class="st">"questions"</span>]):</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        mrr <span class="op">=</span> calculate_mrr(question, results[i], cutoff<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        recall <span class="op">=</span> calculate_recall(question, results[i], cutoff<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        q_mrr.append(mrr)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        q_recall.append(recall)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(q_mrr) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(q_recall) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q_mrr, q_recall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:43:09.476964Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:43:09.476628Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:43:09.481771Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:43:09.480823Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:43:09.476931Z&quot;}" data-trusted="true" data-execution_count="20">
<details>
<summary>Show <code>save_results</code> function</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_results(results, df, q_mrr, q_recall, name):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    flat_results <span class="op">=</span> []</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> res <span class="kw">in</span> results:</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        flat_results.append(<span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(res))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(flat_results) <span class="op">==</span> <span class="dv">191</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_retrieval'</span>] <span class="op">=</span> flat_results</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_mrr10'</span>] <span class="op">=</span> q_mrr</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_recall10'</span>] <span class="op">=</span> q_recall</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="chunking-strategy-a-1-paragraph-with-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-a-1-paragraph-with-headers">Chunking Strategy A: 1-Paragraph (with headers)</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:51:29.646506Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:51:29.645668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:51:29.685541Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:51:29.684729Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:51:29.646468Z&quot;}" data-outputid="a60b9b2b-05fd-4a7b-db14-bf2e9beb44e3" data-trusted="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chunking each notebook</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, nb <span class="kw">in</span> nbs.items():</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> get_chunks(nb)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">1967</span> <span class="co"># 1-paragraph chunks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 307
2 227
4 433
8 157
9 387
10 190
13 266</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:52:53.273359Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:52:53.272986Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:52:54.283069Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:52:54.282328Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:52:53.273326Z&quot;}" data-outputid="3f99d796-b24e-438f-90a8-ff2eb672f1de" data-trusted="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"A"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>questions.copy(),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:52:59.673041Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:52:59.672738Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:52:59.679368Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:52:59.678484Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:52:59.673016Z&quot;}" data-outputid="e864e397-6c5c-448a-a695-d44dc34f075c" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_A_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_A_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(0.3, 0.65)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:53:13.136073Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:53:13.135765Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:53:19.206390Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:53:19.205660Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:53:13.136046Z&quot;}" data-outputid="fb291378-abfe-47e5-f8a4-2a798a99979e" data-trusted="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"A"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T00:53:22.883480Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T00:53:22.883045Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T00:53:22.890175Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T00:53:22.889157Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T00:53:22.883444Z&quot;}" data-outputid="d1507f36-f5b7-4c92-e298-4767378245b3" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_A_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_A_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(0.38, 0.71)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"A"</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:10:44.232174Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:10:44.231884Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:10:44.238858Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:10:44.238107Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:10:44.232146Z&quot;}" data-outputid="c0cee31e-9fe6-4d72-a579-90d37f48cf5e" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_A_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_A_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(0.46, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"A"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:14:41.402607Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:14:41.401908Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:14:41.408764Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:14:41.407873Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:14:41.402570Z&quot;}" data-outputid="411aee2a-727b-424b-bc14-16097044747e" data-trusted="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_A_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_A_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>(0.48, 0.82)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-b-3-paragraph-with-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-b-3-paragraph-with-headers">Chunking Strategy B: 3-Paragraph (with headers)</h2>
<p>Next, I’ll expand the chunks to include 3-paragraphs at a time. I’m still keeping the headers.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:15:08.474995Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:15:08.474668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:15:08.484289Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:15:08.483444Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:15:08.474963Z&quot;}" data-outputid="427c0da0-a586-486b-9613-ef5d171172be" data-trusted="true" data-execution_count="30">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> combine_chunks(chunks, num_p<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">713</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 112
2 84
4 152
8 58
9 141
10 70
13 96</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-1">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:21:42.900175Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:21:42.899823Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:21:44.142204Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:21:44.141542Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:21:42.900141Z&quot;}" data-outputid="abd4dc29-24af-4ab6-d031-567c7a8497f9" data-trusted="true" data-execution_count="31">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:21:44.731440Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:21:44.731076Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:21:44.737976Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:21:44.737048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:21:44.731406Z&quot;}" data-outputid="b886106b-7d30-48c1-f78c-9a97bd1e5b34" data-trusted="true" data-execution_count="32">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_B_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_B_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-1">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:22:23.269973Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:22:23.269748Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:22:29.060680Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:22:29.059996Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:22:23.269948Z&quot;}" data-outputid="ee004991-ee4f-4778-c6b7-72d459ac81c1" data-trusted="true" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:22:32.334662Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:22:32.333867Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:22:32.340872Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:22:32.339937Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:22:32.334624Z&quot;}" data-outputid="5484102d-1158-48c2-cb2e-f67d7751953b" data-trusted="true" data-execution_count="34">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_B_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_B_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(0.5, 0.85)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-1">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:26:40.994007Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:26:40.993740Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:26:41.000087Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:26:40.999259Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:26:40.993980Z&quot;}" data-outputid="7f153334-7712-4b1f-8277-54d93cf9ddcb" data-trusted="true" data-execution_count="36">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_B_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_B_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>(0.49, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-1" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-1">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:30:18.190218Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:30:18.189864Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:30:18.197158Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:30:18.196203Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:30:18.190179Z&quot;}" data-outputid="0fbaa6c4-f6e8-4fd3-a9dd-41fffe8a5eef" data-trusted="true" data-execution_count="38">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_B_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_B_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(0.52, 0.84)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-c-1-paragraph-wo-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-c-1-paragraph-wo-headers">Chunking Strategy C: 1-Paragraph (w/o headers)</h2>
<p>Next, I’ll remove markdown headers from each chunk.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:18:36.662925Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:18:36.662593Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:18:36.710061Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:18:36.709141Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:18:36.662894Z&quot;}" data-outputid="812b1cfa-de14-43a9-90f0-244bdfd34eb2" data-trusted="true" data-execution_count="39">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chunking each notebook</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, nb <span class="kw">in</span> nbs.items():</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    data[chapter] <span class="op">=</span> get_chunks(nb)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    data[chapter] <span class="op">=</span> [re.sub(<span class="vs">r'^#+\s+[^\n]+\n*'</span>, <span class="st">''</span>, c) <span class="cf">for</span> c <span class="kw">in</span> data[chapter]]</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">1967</span> <span class="co"># 1-paragraph chunks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 307
2 227
4 433
8 157
9 387
10 190
13 266</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-2">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:50:28.409613Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:50:28.408983Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:50:29.306803Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:50:29.306115Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:50:28.409574Z&quot;}" data-outputid="2a763f15-020f-4031-e770-0115470e8698" data-trusted="true" data-execution_count="40">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"C"</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:50:29.977570Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:50:29.977247Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:50:29.983900Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:50:29.983041Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:50:29.977541Z&quot;}" data-outputid="7202028e-894e-4629-9d7c-a424626b1cfb" data-trusted="true" data-execution_count="41">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_C_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_C_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>(0.29, 0.65)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-2">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:51:05.345206Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:51:05.344866Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:51:10.910854Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:51:10.909942Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:51:05.345173Z&quot;}" data-outputid="8bb433d4-333f-4fe5-b908-480a0ecd232e" data-trusted="true" data-execution_count="42">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"C"</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:51:19.644687Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:51:19.644254Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:51:19.651422Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:51:19.650429Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:51:19.644651Z&quot;}" data-outputid="e16721c1-080b-415d-898b-4bb81587c524" data-trusted="true" data-execution_count="43">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_C_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_C_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>(0.35, 0.72)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-2">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"C"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:55:36.156991Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:55:36.156709Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:55:36.163281Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:55:36.162427Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:55:36.156963Z&quot;}" data-outputid="00f173f8-10af-4ba9-f683-4445ac7b762e" data-trusted="true" data-execution_count="45">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_C_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_C_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>(0.41, 0.74)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-2" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-2">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"C"</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T01:59:13.167358Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T01:59:13.166923Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T01:59:13.174970Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T01:59:13.174299Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T01:59:13.167298Z&quot;}" data-outputid="b4d69dc6-1001-4e86-f231-9f7d7e5c26ba" data-trusted="true" data-execution_count="47">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_C_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_C_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(0.45, 0.77)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-d-3-paragraph-wo-headers" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-d-3-paragraph-wo-headers">Chunking Strategy D: 3-Paragraph (w/o headers)</h2>
<p>Expanding header-less chunks to 3-paragraphs.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:18:59.619716Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:18:59.618912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:18:59.624729Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:18:59.623786Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:18:59.619681Z&quot;}" data-trusted="true" data-execution_count="48">
<details>
<summary>Show modified <code>combine_chunks</code> function</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_chunks2(chunks, num_p<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Combines text chunks into groups of specified size (num_p).</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">    If chunks have no headers, treats them as standalone content.</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    combined_chunks <span class="op">=</span> []</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    current_group <span class="op">=</span> []</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">&lt;</span> num_p:</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>            current_group.append(chunk)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(current_group) <span class="op">==</span> num_p:</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>            combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>            current_group <span class="op">=</span> []</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add any remaining chunks</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_group:</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        combined_chunks.append(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(current_group))</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:01.221431Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:01.221066Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:01.227953Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:01.227032Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:01.221397Z&quot;}" data-outputid="1a99dfba-0541-44f6-b31e-0e1f3cb0d4d0" data-trusted="true" data-execution_count="49">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> combine_chunks2(chunks, num_p<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(chapter, <span class="bu">len</span>(chunks))</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">659</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 103
2 76
4 145
8 53
9 129
10 64
13 89</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-3">Retrieval Method: Full Text Search</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:08.187884Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:08.187252Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:09.404320Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:09.403632Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:08.187848Z&quot;}" data-outputid="c829e29b-5397-49a6-c798-2ee73ab94753" data-trusted="true" data-execution_count="50">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:11.000307Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:10.999957Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:11.006879Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:11.005978Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:11.000258Z&quot;}" data-outputid="8bb81432-28e6-4472-d2e1-05e14e0c1e0f" data-trusted="true" data-execution_count="51">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_D_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_D_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(0.44, 0.82)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-3">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:26.213399Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:26.212708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:31.639801Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:31.639098Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:26.213361Z&quot;}" data-outputid="8feac0c6-3779-4b47-90ad-e4ed75fa12aa" data-trusted="true" data-execution_count="52">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:19:31.860104Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:19:31.859901Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:19:31.866516Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:19:31.865665Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:19:31.860081Z&quot;}" data-outputid="6a21ac81-4f08-4ead-fffc-08ddccf49f01" data-trusted="true" data-execution_count="53">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_D_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_D_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(0.46, 0.82)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-3">Retrieval Method: ColBERTv2</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:25:00.952874Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:25:00.952598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:25:00.959190Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:25:00.958249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:25:00.952846Z&quot;}" data-outputid="db7e3b68-f54e-49f9-dada-53f746fe9d34" data-trusted="true" data-execution_count="55">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_D_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_D_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(0.5, 0.8)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-3" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-3">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-26T02:28:36.873734Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-26T02:28:36.873458Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-26T02:28:36.880094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-26T02:28:36.879220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-26T02:28:36.873707Z&quot;}" data-outputid="713135f7-7b6e-47f3-add7-5b3db7dbdbce" data-trusted="true" data-execution_count="57">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_D_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_D_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(0.52, 0.82)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-e-3-paragraph-wheaders-wo-html-tags" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-e-3-paragraph-wheaders-wo-html-tags">Chunking Strategy E: (3-paragraph w/headers, w/o HTML tags)</h2>
<p>I’ll add headers back, but will remove HTML tags.</p>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chunking each notebook</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, nb <span class="kw">in</span> nbs.items():</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> get_chunks(nb)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">1967</span> <span class="co"># 1-paragraph chunks</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> combine_chunks(chunks, num_p<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">713</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="9f240ac1-b0ec-49c2-a440-fd29ac67be70" data-execution_count="138">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>chunks[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n&lt;img src="images/chapter9_conv_basic.png" id="basic_conv" caption="Applying a kernel to one location" alt="Applying a kernel to one location" width="700"&gt;'</code></pre>
</div>
</div>
<div class="cell" data-outputid="20111447-31ee-48b8-9d01-a40bdd0c12d6" data-execution_count="139">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_html(text):</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Temporarily replace double-bracketed content with a placeholder</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> uuid</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    placeholder <span class="op">=</span> <span class="ss">f"PLACEHOLDER_</span><span class="sc">{</span>uuid<span class="sc">.</span>uuid4()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    double_bracketed <span class="op">=</span> re.findall(<span class="vs">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, text)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    step1 <span class="op">=</span> re.sub(<span class="vs">r'&lt;&lt;[^&gt;]*&gt;&gt;'</span>, placeholder, text)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Remove HTML tags</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    step2 <span class="op">=</span> re.sub(<span class="vs">r'&lt;[/]?[a-zA-Z][^&gt;]*&gt;'</span>, <span class="st">''</span>, step1)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Restore double-bracketed content</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> double_bracketed:</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>        step3 <span class="op">=</span> step2.replace(placeholder, double_bracketed[<span class="dv">0</span>])</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> step3</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> step2</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>clean_html(<span class="st">'The &lt;a href="#"&gt;text&lt;/a&gt; is &lt;&lt;untouched&gt;&gt;.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>'The text is &lt;&lt;untouched&gt;&gt;.'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> [clean_html(chunk) <span class="cf">for</span> chunk <span class="kw">in</span> chunks]</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">713</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="f0271933-ae7b-482e-cca5-32542a8e5130" data-execution_count="141">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>chunks[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n'</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-4">Retrieval Method: Full Text Search</h3>
<div class="cell" data-outputid="af2da950-e989-4a3a-f7aa-2036de7e493b" data-execution_count="113">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"E"</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="83446096-6429-453b-a860-31a9cdcdfa82" data-execution_count="114">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_E_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_E_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-4">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-outputid="831fe930-bc8a-4e64-9f5e-b709703860ba" data-execution_count="115">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"E"</span>,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="abadbb46-d641-4003-a353-5da32f447cbb" data-execution_count="116">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_E_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_E_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>(0.5, 0.87)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-4">Retrieval Method: ColBERTv2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"E"</span>,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="4108adcd-495a-4c42-c56b-5e5dc685cef5" data-execution_count="118">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_E_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_E_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>(0.49, 0.81)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-4" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-4">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"E"</span>,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>benchmark,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="e723ecd0-7550-488b-a202-2b20b378a599" data-execution_count="120">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_E_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_E_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>(0.52, 0.84)</code></pre>
</div>
</div>
</section>
</section>
<section id="chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation" class="level2">
<h2 class="anchored" data-anchor-id="chunking-strategy-f-wheaders-wo-html-tags-wo-punctuation">Chunking Strategy F: (w/headers, w/o HTML tags, w/o punctuation)</h2>
<p>Finally, I’ll keep headers, remove HTML tags and remove all punctuation.</p>
<div class="cell" data-outputid="ce7661e8-c5ee-44f5-950e-d01dd944b7f1" data-execution_count="142">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>chunks[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use something called a *convolution*. A convolution requires nothing more than multiplication, and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book!\n\nA convolution applies a *kernel* across an image. A kernel is a little matrix, such as the 3×3 matrix in the top right of &lt;&lt;basic_conv&gt;&gt;.\n\n'</code></pre>
</div>
</div>
<div class="cell" data-outputid="cf3eb589-4d15-4760-82ab-c02317c613a2" data-execution_count="145">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_punctuation(text):</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> string</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">''</span>.join(char <span class="cf">if</span> char.isalnum() <span class="kw">or</span> char <span class="op">==</span> <span class="st">'#'</span> <span class="cf">else</span> <span class="st">' '</span> <span class="cf">if</span> char <span class="kw">in</span> string.punctuation <span class="cf">else</span> char <span class="cf">for</span> char <span class="kw">in</span> text)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>remove_punctuation(chunks[<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision  and is surprisingly straightforward  To do it  we use something called a  convolution   A convolution requires nothing more than multiplication  and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book \n\nA convolution applies a  kernel  across an image  A kernel is a little matrix  such as the 3×3 matrix in the top right of   basic conv   \n\n'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  data[chapter] <span class="op">=</span> [remove_punctuation(chunk) <span class="cf">for</span> chunk <span class="kw">in</span> chunks]</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>total_chunks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chapter, chunks <span class="kw">in</span> data.items():</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  total_chunks <span class="op">+=</span> <span class="bu">len</span>(chunks)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> total_chunks <span class="op">==</span> <span class="dv">713</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="421a9221-8070-419a-e330-f5382c9dee54" data-execution_count="147">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>chunks[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>'## The Magic of Convolutions\n\nIt turns out that finding the edges in an image is a very common task in computer vision  and is surprisingly straightforward  To do it  we use something called a  convolution   A convolution requires nothing more than multiplication  and addition—two operations that are responsible for the vast majority of work that we will see in every single deep learning model in this book \n\nA convolution applies a  kernel  across an image  A kernel is a little matrix  such as the 3×3 matrix in the top right of   basic conv   \n\n'</code></pre>
</div>
</div>
<p>Since I’m removing punctuation from the contexts, I need to do the same for the benchmark dataset. I think a better solution would be to modify the scoring functions by removing the punctuation there, but I’m saving some time and space by just copying the benchmark dataset and removing punctuation from each context string in it:</p>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_contexts(data):</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process questions</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> question <span class="kw">in</span> data[<span class="st">'questions'</span>]:</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process only answer_context</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'answer_context'</span> <span class="kw">in</span> question:</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> context_item <span class="kw">in</span> question[<span class="st">'answer_context'</span>]:</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'context'</span> <span class="kw">in</span> context_item:</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(context_item[<span class="st">'context'</span>], <span class="bu">list</span>):</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># If context is a list, process each string in the list</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>                        context_item[<span class="st">'context'</span>] <span class="op">=</span> [</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>                            remove_punctuation(text) <span class="cf">if</span> text <span class="cf">else</span> text</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> text <span class="kw">in</span> context_item[<span class="st">'context'</span>]</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>                        ]</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> <span class="bu">isinstance</span>(context_item[<span class="st">'context'</span>], <span class="bu">str</span>):</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># If context is a single string, process it directly</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>                        context_item[<span class="st">'context'</span>] <span class="op">=</span> remove_punctuation(context_item[<span class="st">'context'</span>])</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>modified_benchmark <span class="op">=</span> process_contexts(benchmark)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="7d2c1a5b-5162-481f-eb62-b5a1789e29f5" data-execution_count="165">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>modified_benchmark[<span class="st">'questions'</span>][<span class="dv">4</span>][<span class="st">'answer_context'</span>][<span class="dv">0</span>][<span class="st">'context'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre><code>['An MIT professor named Marvin Minsky  who was a grade behind Rosenblatt at the same high school    along with Seymour Papert  wrote a book called  Perceptrons   MIT Press   about Rosenblatt s invention  They showed that a single layer of these devices was unable to learn some simple but critical mathematical functions  such as XOR   In the same book  they also showed that using multiple layers of the devices would allow these limitations to be addressed  Unfortunately  only the first of these insights was widely recognized  As a result  the global academic community nearly entirely gave up on neural networks for the next two decades ']</code></pre>
</div>
</div>
<section id="retrieval-method-full-text-search-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-full-text-search-5">Retrieval Method: Full Text Search</h3>
<div class="cell" data-outputid="13b24ca1-582e-416d-bbbf-eafaf4e4732f" data-execution_count="166">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"bm25"</span>,</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"F"</span>,</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>modified_benchmark,</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results,</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    questions<span class="op">=</span>questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chapter 1: True
Chapter 2: True
Chapter 4: True
Chapter 8: True
Chapter 9: True
Chapter 10: True
Chapter 13: True
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="4f94af84-57fa-4326-ddf9-c65f4c6d1251" data-execution_count="167">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'bm25_F_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'bm25_F_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="167">
<pre><code>(0.46, 0.83)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-single-vector-cosine-similarity-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-single-vector-cosine-similarity-5">Retrieval Method: Single-Vector Cosine Similarity</h3>
<div class="cell" data-outputid="ec40a8af-9cc9-4051-c89c-760d8e374fff" data-execution_count="168">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"single_vector"</span>,</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"F"</span>,</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>modified_benchmark,</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding Questions...
Encoding Data...
Retrieving passages...
Retrieval complete.</code></pre>
</div>
</div>
<div class="cell" data-outputid="15ad5b99-d7b2-4560-b4ae-2be1280375a0" data-execution_count="169">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_F_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'single_vector_F_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="169">
<pre><code>(0.49, 0.86)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-colbertv2-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-colbertv2-5">Retrieval Method: ColBERTv2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"colbertv2"</span>,</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"F"</span>,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>modified_benchmark,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="2a96fd76-8b57-486d-947b-e049cb8be797" data-execution_count="171">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_F_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'colbertv2_F_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="171">
<pre><code>(0.44, 0.71)</code></pre>
</div>
</div>
</section>
<section id="retrieval-method-answerai-colbert-small-v1-5" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-method-answerai-colbert-small-v1-5">Retrieval Method: answerai-colbert-small-v1</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>benchmark_results <span class="op">=</span> do_retrieval(</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"answerai_colbert"</span>,</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    chunking_strategy<span class="op">=</span><span class="st">"F"</span>,</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data,</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    benchmark<span class="op">=</span>modified_benchmark,</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    benchmark_results<span class="op">=</span>benchmark_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="f72ca3d9-cfda-43ec-8548-14c4d124db5a" data-execution_count="173">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_F_mrr10'</span>].mean(),<span class="dv">2</span>), <span class="bu">round</span>(benchmark_results[<span class="st">'answerai_colbert_F_recall10'</span>].mean(),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="173">
<pre><code>(0.45, 0.73)</code></pre>
</div>
</div>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Here are the definitions of the metrics, retrieval methods and chunking strategies that I am using in this benchmark evaluation:</p>
<p><strong>Metrics</strong></p>
<ul>
<li><p>Answer Component MRR@10: Returns the rank of the n-th passage needed to satisfy all <code>answer_component</code>s for the question. So, if a question has 4 <code>answer_component</code>s and their relevant contexts were contained across the first 5 retrieved passages, MRR would be 1/5 = 0.2.</p></li>
<li><p>Answer Component Recall@10: Measures the proportion of answer components for which at least one supporting context was retrieved. Using the same example, if the top-10 passages only contain contexts relevant to 2 <code>answer_component</code>s, Recall would be 2/4 = 0.5</p></li>
</ul>
<p><strong>Retrieval Methods</strong></p>
<ul>
<li>Full text search (using sqlite and Claude-generated keywords)</li>
<li>Single-vector cosine similarity (using BAAI/bge-small-en-v1.5)</li>
<li>ColBERTv2</li>
<li>answerai-colbert-small-v1</li>
</ul>
<p><strong>Chunking Strategies</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Chunking Strategy Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1-paragraph (w/headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">3-paragraph (w/headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1-paragraph (w/o headers)</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">3-paragraph (w/o headers)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">E</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags)</td>
</tr>
<tr class="even">
<td style="text-align: center;">F</td>
<td style="text-align: center;">3-paragraph (w/headers, w/o HTML tags, w/o punctuation)</td>
</tr>
</tbody>
</table>
<p>Here are the results from this notebook:</p>
<p><strong>Answer Component MRR@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.44</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.46</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.35</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">0.46</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.41</td>
<td style="text-align: center;">0.50</td>
<td style="text-align: center;">0.49</td>
<td style="text-align: center;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">0.48</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.52</td>
<td style="text-align: center;">0.45</td>
</tr>
</tbody>
</table>
<p><strong>Answer Component Recall@10</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">E</th>
<th style="text-align: center;">F</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Full text search</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">83%</td>
<td style="text-align: center;">83%</td>
</tr>
<tr class="even">
<td style="text-align: center;">Single-vector cosine similiarity</td>
<td style="text-align: center;">71%</td>
<td style="text-align: center;">85%</td>
<td style="text-align: center;">72%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">87%</td>
<td style="text-align: center;">86%</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ColBERTv2</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">74%</td>
<td style="text-align: center;">80%</td>
<td style="text-align: center;">81%</td>
<td style="text-align: center;">71%</td>
</tr>
<tr class="even">
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">77%</td>
<td style="text-align: center;">82%</td>
<td style="text-align: center;">84%</td>
<td style="text-align: center;">73%</td>
</tr>
</tbody>
</table>
<p>The best-performing retrieval method and chunking strategies:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Metric Name</th>
<th style="text-align: center;">Retrieval Method</th>
<th style="text-align: center;">Chunking Strategies</th>
<th style="text-align: center;">Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Answer Component MRR@10</td>
<td style="text-align: center;">answerai-colbert-small-v1</td>
<td style="text-align: center;">B, D, E</td>
<td style="text-align: center;">0.52</td>
</tr>
<tr class="even">
<td style="text-align: center;">Answer Component Recall@10</td>
<td style="text-align: center;">Single-vector cosine similiarty</td>
<td style="text-align: center;">E</td>
<td style="text-align: center;">87%</td>
</tr>
</tbody>
</table>
<p>I was quite surprised that single-vector cosine similarity yielded the best Recall. I was less surprised that answerai-colbert-small-v1 had the best MRR@10 since it was better than the other retrieval methods for 5 out of 6 chunking strategies. Other noteworthy observations:</p>
<ul>
<li>ColBERTv2 and answerai-colbert-small-v1 both experienced a considerable performance drop when punctuation was removed from the documents.</li>
<li>Full text search was very competitive after the chunk size was increased to 3-paragraphs (B, D, E, F). It yielded the second-highest MRR@10 for Chunking Strategy F (3-paragraph, w/headers, w/o HTMl tags, w/o punctuation).</li>
<li>Removing HTML tags (Chunking Strategy E) improved the performance of all four retrieval methods than when they were included (Chunking Strategy D). The biggest beneficiary of removing them was single-vector cosine similarity (82% –&gt; 87%).</li>
</ul>
<p>A couple of notes about my process:</p>
<ul>
<li>Having a benchmark dataset saved me about 15-20 hours of manual evaluation.</li>
<li>Refactoring the code (into a <code>do_retrieval</code> function) made it easier for me to iterate quickly different chunking strategies.</li>
</ul>
<p>Before I move on to experimenting with hybrid approaches (full text search + semantic search) I want to research and apply chunking strategies that are particularly suited to ColBERTv2 and answerai-colbert-small-v1 to see if I can improve on the overall-best Recall@10 of 87% and MRR@10 of 0.52.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>