<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2023-08-19">
<meta name="description" content="In this notebook I train single and multi-target regression tabular deep learning models using fastai, and compare the results.">

<title>vishal bakshi - Training a Multi-Target Regression Deep Learning Model with fastai</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">vishal bakshi</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#plan-of-attack" id="toc-plan-of-attack" class="nav-link" data-scroll-target="#plan-of-attack">Plan of Attack</a>
  <ul class="collapse">
  <li><a href="#creating-dataloaders" id="toc-creating-dataloaders" class="nav-link" data-scroll-target="#creating-dataloaders">Creating <code>DataLoaders</code></a></li>
  <li><a href="#calculating-losses" id="toc-calculating-losses" class="nav-link" data-scroll-target="#calculating-losses">Calculating Losses</a></li>
  <li><a href="#calculating-metrics" id="toc-calculating-metrics" class="nav-link" data-scroll-target="#calculating-metrics">Calculating Metrics</a></li>
  </ul></li>
  <li><a href="#training-a-multi-target-model" id="toc-training-a-multi-target-model" class="nav-link" data-scroll-target="#training-a-multi-target-model">Training a Multi-Target Model</a>
  <ul class="collapse">
  <li><a href="#load-and-clean-data" id="toc-load-and-clean-data" class="nav-link" data-scroll-target="#load-and-clean-data">Load and Clean Data</a></li>
  <li><a href="#create-dataloaders" id="toc-create-dataloaders" class="nav-link" data-scroll-target="#create-dataloaders">Create <code>DataLoaders</code></a></li>
  <li><a href="#create-loss-function" id="toc-create-loss-function" class="nav-link" data-scroll-target="#create-loss-function">Create Loss Function</a></li>
  <li><a href="#create-metric-function" id="toc-create-metric-function" class="nav-link" data-scroll-target="#create-metric-function">Create Metric Function</a></li>
  <li><a href="#comparing-predictions-to-actuals" id="toc-comparing-predictions-to-actuals" class="nav-link" data-scroll-target="#comparing-predictions-to-actuals">Comparing Predictions to Actuals</a></li>
  </ul></li>
  <li><a href="#comparing-to-single-target-models" id="toc-comparing-to-single-target-models" class="nav-link" data-scroll-target="#comparing-to-single-target-models">Comparing to Single-Target Models</a>
  <ul class="collapse">
  <li><a href="#single-target-age" id="toc-single-target-age" class="nav-link" data-scroll-target="#single-target-age">Single Target: Age</a></li>
  <li><a href="#single-target-survived" id="toc-single-target-survived" class="nav-link" data-scroll-target="#single-target-survived">Single Target: Survived</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Training a Multi-Target Regression Deep Learning Model with fastai</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I train single and multi-target regression tabular deep learning models using fastai, and compare the results.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 19, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this blog post I will use fastai to train a model that predicts more than one target for the Kaggle Titanic dataset.</p>
<p>I’ve referenced the notebook <a href="https://www.kaggle.com/code/jhoward/multi-target-road-to-the-top-part-4/notebook">Multi-target: Road to the Top, Part 4</a> by Jeremy Howard as well as a derivative notebook <a href="https://www.kaggle.com/code/archietram/small-models-multi-targets/notebook">Small models + Multi-targets</a> by Kaggle user Archie Tram (in which he creates a test <code>DataLoader</code> to get predictions from the model).</p>
</section>
<section id="plan-of-attack" class="level2">
<h2 class="anchored" data-anchor-id="plan-of-attack">Plan of Attack</h2>
<section id="creating-dataloaders" class="level3">
<h3 class="anchored" data-anchor-id="creating-dataloaders">Creating <code>DataLoaders</code></h3>
<p>In Jeremy’s notebook, he is classifying images of plants with two targets: disease and variety of plant.</p>
<p>He creates his <code>DataLoaders</code> object as follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataBlock(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock,CategoryBlock,CategoryBlock),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [parent_label,get_variety],</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>).dataloaders(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are three <code>blocks</code>: 1 input <code>ImageBlock</code> and 2 output <code>CategoryBlock</code>s. The model gets the outputs with <code>parent_label</code> (for the disease) and a custom function <code>get_variety</code> (which grabs the <code>variety</code> column value of the given image from a <code>DataFrame</code>).</p>
<p>In my use case, I will have to follow a similar approach, albeit catered to tabular data.</p>
</section>
<section id="calculating-losses" class="level3">
<h3 class="anchored" data-anchor-id="calculating-losses">Calculating Losses</h3>
<p>Jeremy calculates loss as the sum of the following:</p>
<ul>
<li>Cross-Entropy loss of the disease inputs</li>
<li>Cross-Entropy loss of the variety inputs</li>
</ul>
<p>I’ll follow a similar approach, except if I use continuous variables as targets I’ll use MSE instead of Cross-Entropy.</p>
</section>
<section id="calculating-metrics" class="level3">
<h3 class="anchored" data-anchor-id="calculating-metrics">Calculating Metrics</h3>
<p>Similar to the loss calculation, I’ll combine the calculation of the metric for each of the two targets. For continuous variables, I’ll use RMSE.</p>
</section>
</section>
<section id="training-a-multi-target-model" class="level2">
<h2 class="anchored" data-anchor-id="training-a-multi-target-model">Training a Multi-Target Model</h2>
<p>With a rough plan outlined, I’ll start the training process with loading and cleaning the Titanic dataset.</p>
<section id="load-and-clean-data" class="level3">
<h3 class="anchored" data-anchor-id="load-and-clean-data">Load and Clean Data</h3>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>cred_path <span class="op">=</span> Path(<span class="st">'~/.kaggle/kaggle.json'</span>).expanduser()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> cred_path.exists():</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    cred_path.parent.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    cred_path.write_text(creds)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    cred_path.chmod(<span class="bn">0o600</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="9d29f07d-4897-4fa5-acb5-2784165f50fb" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>iskaggle <span class="op">=</span> os.environ.get(<span class="st">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st">''</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iskaggle: path <span class="op">=</span> Path(<span class="st">"../input/titanic"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  path <span class="op">=</span> Path(<span class="st">'titanic'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> path.exists():</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> zipfile, kaggle</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    kaggle.api.competition_download_cli(<span class="bu">str</span>(path))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    zipfile.ZipFile(<span class="ss">f'</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">.zip'</span>).extractall(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading titanic.zip to /content</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 34.1k/34.1k [00:00&lt;00:00, 6.18MB/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div class="cell" data-outputid="cb3036e1-5244-49cc-ddb2-e262842810d0" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the training data and look at it</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'train.csv'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">


  <div id="df-1a7a74cb-269c-4ea6-84f6-1871a56c3d68" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Thayer)</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>886</th>
      <td>887</td>
      <td>0</td>
      <td>2</td>
      <td>Montvila, Rev. Juozas</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>211536</td>
      <td>13.0000</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>887</th>
      <td>888</td>
      <td>1</td>
      <td>1</td>
      <td>Graham, Miss. Margaret Edith</td>
      <td>female</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>112053</td>
      <td>30.0000</td>
      <td>B42</td>
      <td>S</td>
    </tr>
    <tr>
      <th>888</th>
      <td>889</td>
      <td>0</td>
      <td>3</td>
      <td>Johnston, Miss. Catherine Helen "Carrie"</td>
      <td>female</td>
      <td>NaN</td>
      <td>1</td>
      <td>2</td>
      <td>W./C. 6607</td>
      <td>23.4500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>889</th>
      <td>890</td>
      <td>1</td>
      <td>1</td>
      <td>Behr, Mr. Karl Howell</td>
      <td>male</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>111369</td>
      <td>30.0000</td>
      <td>C148</td>
      <td>C</td>
    </tr>
    <tr>
      <th>890</th>
      <td>891</td>
      <td>0</td>
      <td>3</td>
      <td>Dooley, Mr. Patrick</td>
      <td>male</td>
      <td>32.0</td>
      <td>0</td>
      <td>0</td>
      <td>370376</td>
      <td>7.7500</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
  </tbody>
</table>
<p>891 rows × 12 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-1a7a74cb-269c-4ea6-84f6-1871a56c3d68')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-1a7a74cb-269c-4ea6-84f6-1871a56c3d68 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-1a7a74cb-269c-4ea6-84f6-1871a56c3d68');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-8302bf67-b73d-4786-8ac4-7056e70c9688">
  <button class="colab-df-quickchart" onclick="quickchart('df-8302bf67-b73d-4786-8ac4-7056e70c9688')" title="Suggest charts." style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-quickchart {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-quickchart:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
</style>

  <script>
    async function quickchart(key) {
      const charts = await google.colab.kernel.invokeFunction(
          'suggestCharts', [key], {});
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-8302bf67-b73d-4786-8ac4-7056e70c9688 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># feature engineering</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(df):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'LogFare'</span>] <span class="op">=</span> np.log1p(df[<span class="st">'Fare'</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'Deck'</span>] <span class="op">=</span> df.Cabin.<span class="bu">str</span>[<span class="dv">0</span>].<span class="bu">map</span>(<span class="bu">dict</span>(A<span class="op">=</span><span class="st">"ABC"</span>, B<span class="op">=</span><span class="st">"ABC"</span>, C<span class="op">=</span><span class="st">"ABC"</span>, D<span class="op">=</span><span class="st">"DE"</span>, E<span class="op">=</span><span class="st">"DE"</span>, F<span class="op">=</span><span class="st">"FG"</span>, G<span class="op">=</span><span class="st">"FG"</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'Family'</span>] <span class="op">=</span> df.SibSp<span class="op">+</span>df.Parch</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'Alone'</span>] <span class="op">=</span> df.Family <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'TicketFreq'</span>] <span class="op">=</span> df.groupby(<span class="st">'Ticket'</span>)[<span class="st">'Ticket'</span>].transform(<span class="st">'count'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'Title'</span>] <span class="op">=</span> df.Name.<span class="bu">str</span>.split(<span class="st">', '</span>, expand<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>].<span class="bu">str</span>.split(<span class="st">'.'</span>, expand<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'Title'</span>] <span class="op">=</span> df.Title.<span class="bu">map</span>(<span class="bu">dict</span>(Mr<span class="op">=</span><span class="st">"Mr"</span>, Miss<span class="op">=</span><span class="st">"Miss"</span>, Mrs<span class="op">=</span><span class="st">"Mrs"</span>, Master<span class="op">=</span><span class="st">"Master"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add the features to our dataframe</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>add_features(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="f1f24ac8-0f29-4f97-95bf-0be9c57af815" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the topmost row of the modes DataFrame</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>modes <span class="op">=</span> df.mode().iloc[<span class="dv">0</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>modes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>PassengerId                      1
Survived                       0.0
Pclass                         3.0
Name           Abbing, Mr. Anthony
Sex                           male
Age                           24.0
SibSp                          0.0
Parch                          0.0
Ticket                        1601
Fare                          8.05
Cabin                      B96 B98
Embarked                         S
LogFare                   2.202765
Deck                           ABC
Family                         0.0
Alone                         True
TicketFreq                     1.0
Title                           Mr
Name: 0, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fill missing data with the column's mode</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df.fillna(modes, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="95c3918d-1085-4fb7-d4d1-25a71f8c73a2" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check that we no longer have missing data</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>PassengerId    0
Survived       0
Pclass         0
Name           0
Sex            0
Age            0
SibSp          0
Parch          0
Ticket         0
Fare           0
Cabin          0
Embarked       0
LogFare        0
Deck           0
Family         0
Alone          0
TicketFreq     0
Title          0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create training and validation index lists</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> RandomSplitter(seed<span class="op">=</span><span class="dv">42</span>)(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-dataloaders" class="level3">
<h3 class="anchored" data-anchor-id="create-dataloaders">Create <code>DataLoaders</code></h3>
<p>I’ll take most of the code from the <a href="https://www.kaggle.com/code/jhoward/why-you-should-use-a-framework">Why you should use a framework</a> notebook by Jeremy, with the following changes:</p>
<ul>
<li>Remove <code>"Age"</code> from <code>cont_names</code> and move it to <code>y_names</code> along with <code>"Survived"</code> which will be our two targets.</li>
<li>Set <code>n_out=2</code> for the <code>RegressionBlock</code>.</li>
</ul>
<p>I’ll treat both targets as a regression, as I wasn’t able to provide two <code>DataBlock</code>s for <code>y_block</code>.</p>
<p>Since I’ve filled in missing values manually, I have removed the <code>FillMissing</code> item from <code>procs</code>.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataloaders object</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> TabularPandas(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    splits<span class="op">=</span>splits,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    procs<span class="op">=</span>[Categorify, Normalize],</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    cat_names<span class="op">=</span>[<span class="st">"Sex"</span>, <span class="st">"Pclass"</span>, <span class="st">"Embarked"</span>, <span class="st">"Deck"</span>, <span class="st">"Title"</span>],</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    cont_names<span class="op">=</span>[<span class="st">"SibSp"</span>, <span class="st">"Parch"</span>, <span class="st">"LogFare"</span>, <span class="st">"Alone"</span>, <span class="st">"TicketFreq"</span>, <span class="st">"Family"</span>],</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    y_names<span class="op">=</span>[<span class="st">"Age"</span>, <span class="st">"Survived"</span>],</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    y_block<span class="op">=</span>RegressionBlock(n_out<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>).dataloaders(path<span class="op">=</span><span class="st">"."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="ce9b202b-ba83-4c0e-8d75-dd358ef47f6e" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Sex</th>
      <th>Pclass</th>
      <th>Embarked</th>
      <th>Deck</th>
      <th>Title</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>LogFare</th>
      <th>Alone</th>
      <th>TicketFreq</th>
      <th>Family</th>
      <th>Age</th>
      <th>Survived</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>male</td>
      <td>1</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.000000e+00</td>
      <td>-9.897945e-09</td>
      <td>3.970292</td>
      <td>2.458140e-08</td>
      <td>2.0</td>
      <td>1.000000e+00</td>
      <td>42.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>male</td>
      <td>3</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.689237e-09</td>
      <td>-9.897945e-09</td>
      <td>2.230014</td>
      <td>1.000000e+00</td>
      <td>1.0</td>
      <td>-1.856774e-08</td>
      <td>18.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>male</td>
      <td>2</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.000000e+00</td>
      <td>2.000000e+00</td>
      <td>3.358638</td>
      <td>2.458140e-08</td>
      <td>3.0</td>
      <td>3.000000e+00</td>
      <td>36.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>male</td>
      <td>3</td>
      <td>C</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.000000e+00</td>
      <td>1.000000e+00</td>
      <td>2.107689</td>
      <td>2.458140e-08</td>
      <td>1.0</td>
      <td>2.000000e+00</td>
      <td>17.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>male</td>
      <td>3</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.689237e-09</td>
      <td>-9.897945e-09</td>
      <td>2.351375</td>
      <td>1.000000e+00</td>
      <td>1.0</td>
      <td>-1.856774e-08</td>
      <td>28.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>female</td>
      <td>3</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mrs</td>
      <td>1.000000e+00</td>
      <td>4.000000e+00</td>
      <td>3.363842</td>
      <td>2.458140e-08</td>
      <td>6.0</td>
      <td>5.000000e+00</td>
      <td>45.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>male</td>
      <td>3</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.689237e-09</td>
      <td>-9.897945e-09</td>
      <td>2.324836</td>
      <td>1.000000e+00</td>
      <td>1.0</td>
      <td>-1.856774e-08</td>
      <td>23.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>female</td>
      <td>3</td>
      <td>C</td>
      <td>ABC</td>
      <td>Mrs</td>
      <td>1.689237e-09</td>
      <td>-9.897945e-09</td>
      <td>2.107178</td>
      <td>1.000000e+00</td>
      <td>1.0</td>
      <td>-1.856774e-08</td>
      <td>24.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>male</td>
      <td>3</td>
      <td>S</td>
      <td>ABC</td>
      <td>Mr</td>
      <td>1.689237e-09</td>
      <td>-9.897945e-09</td>
      <td>2.188856</td>
      <td>1.000000e+00</td>
      <td>1.0</td>
      <td>-1.856774e-08</td>
      <td>39.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>female</td>
      <td>2</td>
      <td>C</td>
      <td>ABC</td>
      <td>Mrs</td>
      <td>1.000000e+00</td>
      <td>-9.897945e-09</td>
      <td>3.436269</td>
      <td>2.458140e-08</td>
      <td>2.0</td>
      <td>1.000000e+00</td>
      <td>14.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="create-loss-function" class="level3">
<h3 class="anchored" data-anchor-id="create-loss-function">Create Loss Function</h3>
<p>If I understand correctly, we will get 2 columns of predictions, and two variables of targets to compute the loss with:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> age_loss(pred, yb): <span class="cf">return</span> F.mse_loss(pred[:,<span class="dv">0</span>], yb[:,<span class="dv">0</span>])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> survived_loss(pred, yb): <span class="cf">return</span> F.mse_loss(pred[:,<span class="dv">1</span>], yb[:,<span class="dv">1</span>])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_loss(pred, yb): <span class="cf">return</span> age_loss(pred, yb) <span class="op">+</span> survived_loss(pred, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-metric-function" class="level3">
<h3 class="anchored" data-anchor-id="create-metric-function">Create Metric Function</h3>
<p>I’ll create an RMSE function for each target variable:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> age_rmse(pred, yb): <span class="cf">return</span> torch.sqrt(F.mse_loss(pred[:,<span class="dv">0</span>], yb[:,<span class="dv">0</span>]))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> survived_rmse(pred, yb): <span class="cf">return</span> torch.sqrt(F.mse_loss(pred[:,<span class="dv">1</span>], yb[:,<span class="dv">1</span>]))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>rmse_metrics <span class="op">=</span> (age_rmse, survived_rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, loss_func<span class="op">=</span>combine_loss, metrics<span class="op">=</span>rmse_metrics, layers<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">10</span>], n_out<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Most times that I ran the learning rate finder, the loss was steadily increasing from the get-go. I randomly came across the following learning rate regime which looks more stable, so I’ll use the given value.</p>
<div class="cell" data-outputid="4ff12a38-30c9-445f-e9eb-08fb1f134c0c" data-execution_count="38">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find(suggest_funcs<span class="op">=</span>(slide, valley))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>SuggestedLRs(slide=6.309573450380412e-07, valley=0.14454397559165955)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-08-19-fastai-multi-target_files/figure-html/cell-17-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="cd521cdc-c1f2-4ce1-9270-b0307bd7001a" data-execution_count="39">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">20</span>, lr<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>age_rmse</th>
      <th>survived_rmse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>766.320923</td>
      <td>554.657837</td>
      <td>23.431234</td>
      <td>0.721841</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>460.486603</td>
      <td>170.207932</td>
      <td>13.030014</td>
      <td>0.590790</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>335.931213</td>
      <td>132.264999</td>
      <td>11.456180</td>
      <td>0.649899</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>265.317535</td>
      <td>116.719322</td>
      <td>10.778342</td>
      <td>0.477045</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>221.392242</td>
      <td>121.840828</td>
      <td>11.004195</td>
      <td>0.441827</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>192.420349</td>
      <td>132.113815</td>
      <td>11.457218</td>
      <td>0.472019</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>173.592255</td>
      <td>120.654694</td>
      <td>10.943729</td>
      <td>0.462033</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>159.223709</td>
      <td>113.375626</td>
      <td>10.612040</td>
      <td>0.519316</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>148.853653</td>
      <td>114.346222</td>
      <td>10.654099</td>
      <td>0.484549</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>140.409439</td>
      <td>109.572639</td>
      <td>10.437387</td>
      <td>0.467927</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>10</td>
      <td>133.942352</td>
      <td>114.497719</td>
      <td>10.642965</td>
      <td>0.590436</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>11</td>
      <td>129.807709</td>
      <td>110.892578</td>
      <td>10.500125</td>
      <td>0.455730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>12</td>
      <td>125.972458</td>
      <td>112.508110</td>
      <td>10.570338</td>
      <td>0.451019</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>13</td>
      <td>122.350586</td>
      <td>126.790512</td>
      <td>11.167099</td>
      <td>0.512433</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>14</td>
      <td>119.345764</td>
      <td>112.307846</td>
      <td>10.571351</td>
      <td>0.579465</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>15</td>
      <td>117.329689</td>
      <td>113.805359</td>
      <td>10.628425</td>
      <td>0.484336</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>16</td>
      <td>116.328194</td>
      <td>115.227859</td>
      <td>10.696632</td>
      <td>0.475317</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>17</td>
      <td>115.390640</td>
      <td>115.162354</td>
      <td>10.710686</td>
      <td>0.500142</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>18</td>
      <td>116.044281</td>
      <td>125.941689</td>
      <td>11.149549</td>
      <td>0.558260</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>19</td>
      <td>115.501900</td>
      <td>116.436340</td>
      <td>10.739085</td>
      <td>0.500779</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>After a few epochs, the RMSE values stop improving. The validation loss also fluctuates throughout the training after decreasing for the first three epochs.</p>
</section>
<section id="comparing-predictions-to-actuals" class="level3">
<h3 class="anchored" data-anchor-id="comparing-predictions-to-actuals">Comparing Predictions to Actuals</h3>
<p>Based on how the training went, I’m not expecting this model to be able to predict <code>Age</code> and <code>Survived</code> very well. I’ll use the validation set to get predictions and then calculate accuracy for <code>Survived</code> and correlation between actuals vs.&nbsp;predictions for <code>Age</code>.</p>
<div class="cell" data-outputid="84849ae4-32c0-49e7-dfef-e51076ade71e" data-execution_count="43">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>preds, targ <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-outputid="6abb101c-5e99-422c-8329-709bbdc1313d" data-execution_count="47">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Survived accuracy</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>(targ[:,<span class="dv">1</span>] <span class="op">==</span> (preds[:,<span class="dv">1</span>]<span class="op">&gt;</span><span class="fl">0.5</span>)).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>tensor(0.6348)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr(x,y): <span class="cf">return</span> np.corrcoef(x,y)[<span class="dv">0</span>][<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="6f66c91a-4046-4fc3-bf80-3340398b0744" data-execution_count="59">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Age plot</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'equal'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Predicted Age vs Actual; r: </span><span class="sc">{</span>corr(preds[:,<span class="dv">0</span>], targ[:,<span class="dv">0</span>])<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>ax.scatter(preds[:,<span class="dv">0</span>], targ[:,<span class="dv">0</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-08-19-fastai-multi-target_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The model achieved shoddy accuracy (63%) and an uninspiring correlation between predicted and actual age. The model did particularly poorly in predicting ages above 40.</p>
</section>
</section>
<section id="comparing-to-single-target-models" class="level2">
<h2 class="anchored" data-anchor-id="comparing-to-single-target-models">Comparing to Single-Target Models</h2>
<p>I’m curious to see how the model performs when I train it for single targets. I’ll train one regression model for <code>Age</code>, another separate regression model for <code>Survived</code>, and see how their results compare to the combined two-target model.</p>
<section id="single-target-age" class="level3">
<h3 class="anchored" data-anchor-id="single-target-age">Single Target: Age</h3>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataloaders object</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>age_dls <span class="op">=</span> TabularPandas(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    splits<span class="op">=</span>splits,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    procs<span class="op">=</span>[Categorify, Normalize],</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    cat_names<span class="op">=</span>[<span class="st">"Sex"</span>, <span class="st">"Pclass"</span>, <span class="st">"Embarked"</span>, <span class="st">"Deck"</span>, <span class="st">"Title"</span>],</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    cont_names<span class="op">=</span>[<span class="st">"SibSp"</span>, <span class="st">"Parch"</span>, <span class="st">"LogFare"</span>, <span class="st">"Alone"</span>, <span class="st">"TicketFreq"</span>, <span class="st">"Family"</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    y_names<span class="op">=</span><span class="st">"Age"</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    y_block<span class="op">=</span>RegressionBlock()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>).dataloaders(path<span class="op">=</span><span class="st">"."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>age_learn <span class="op">=</span> tabular_learner(age_dls, metrics<span class="op">=</span>rmse, layers<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I ran the learning rate finder 10 times and got similar charts each time, which tells me that something about this model is more stable than my two-target model.</p>
<div class="cell" data-outputid="18094275-3ac6-4a7b-9d93-2a6927b042fb" data-execution_count="84">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>age_learn.lr_find(suggest_funcs<span class="op">=</span>(slide, valley))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>SuggestedLRs(slide=6.309573450380412e-07, valley=0.0831763744354248)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-08-19-fastai-multi-target_files/figure-html/cell-25-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="18213d31-d995-4bb6-bf0d-d785ad076a82" data-execution_count="85">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>age_learn.fit(<span class="dv">16</span>, lr<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>_rmse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>781.124268</td>
      <td>233.326263</td>
      <td>15.275021</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>454.851532</td>
      <td>408.981842</td>
      <td>20.223301</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>328.806274</td>
      <td>116.149773</td>
      <td>10.777281</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>263.302643</td>
      <td>119.088097</td>
      <td>10.912749</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>219.239166</td>
      <td>127.125175</td>
      <td>11.274981</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>190.565811</td>
      <td>111.707756</td>
      <td>10.569189</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>171.005737</td>
      <td>113.618858</td>
      <td>10.659215</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>157.105713</td>
      <td>109.284859</td>
      <td>10.453939</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>146.396072</td>
      <td>118.541183</td>
      <td>10.887661</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>138.696716</td>
      <td>107.435219</td>
      <td>10.365096</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>10</td>
      <td>132.795654</td>
      <td>109.071220</td>
      <td>10.443716</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>11</td>
      <td>128.642639</td>
      <td>112.930344</td>
      <td>10.626869</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>12</td>
      <td>124.508675</td>
      <td>107.584816</td>
      <td>10.372310</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>13</td>
      <td>121.428909</td>
      <td>113.099953</td>
      <td>10.634846</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>14</td>
      <td>119.856216</td>
      <td>114.224464</td>
      <td>10.687585</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>15</td>
      <td>118.349365</td>
      <td>109.042511</td>
      <td>10.442342</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>The validation loss also fluctuates in this model’s training. The RMSE metric also does not really improve after the first couple of epochs. Similar to last time, I’ll plot the predicted age vs actual and calculate the correlation between the two:</p>
<div class="cell" data-outputid="b0a28cd3-e9b7-4c11-dfad-faf85c911ab0" data-execution_count="86">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>age_preds, age_targ <span class="op">=</span> age_learn.get_preds(dl<span class="op">=</span>age_dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-outputid="f59357a3-7708-49a5-da0c-4d360de98d38" data-execution_count="87">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Age plot</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'equal'</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Predicted Age vs Actual; r: </span><span class="sc">{</span>corr(age_preds[:,<span class="dv">0</span>], age_targ[:,<span class="dv">0</span>])<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>ax.scatter(age_preds[:,<span class="dv">0</span>], age_targ[:,<span class="dv">0</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-08-19-fastai-multi-target_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Surprisingly, the single target Age model does not perform much better than my two-target model. I get a similar correlation, and this model also fails to predict ages above around 40.</p>
</section>
<section id="single-target-survived" class="level3">
<h3 class="anchored" data-anchor-id="single-target-survived">Single Target: Survived</h3>
<p>In Jeremy’s “Why you should use a framework” notebook, he achieves about an 83% accuracy. I’ll use this as a benchmark to compare my model with.</p>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataloaders object</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>survived_dls <span class="op">=</span> TabularPandas(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    splits<span class="op">=</span>splits,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    procs<span class="op">=</span>[Categorify, Normalize],</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    cat_names<span class="op">=</span>[<span class="st">"Sex"</span>, <span class="st">"Pclass"</span>, <span class="st">"Embarked"</span>, <span class="st">"Deck"</span>, <span class="st">"Title"</span>],</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    cont_names<span class="op">=</span>[<span class="st">"SibSp"</span>, <span class="st">"Parch"</span>, <span class="st">"LogFare"</span>, <span class="st">"Alone"</span>, <span class="st">"TicketFreq"</span>, <span class="st">"Family"</span>],</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    y_names<span class="op">=</span><span class="st">"Survived"</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    y_block<span class="op">=</span>RegressionBlock()</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>).dataloaders(path<span class="op">=</span><span class="st">"."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>survived_learn <span class="op">=</span> tabular_learner(survived_dls, metrics<span class="op">=</span>rmse, layers<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="a0f3cb2c-5c7f-45ea-b66c-67d008e130f1" data-execution_count="91">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>survived_learn.lr_find(suggest_funcs<span class="op">=</span>(slide, valley))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>SuggestedLRs(slide=0.05754399299621582, valley=0.0063095735386013985)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-08-19-fastai-multi-target_files/figure-html/cell-31-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="0cd5c074-4ba6-414e-bca9-9fd1ffdd152b" data-execution_count="92">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>survived_learn.fit(<span class="dv">16</span>, lr<span class="op">=</span><span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>_rmse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.250865</td>
      <td>0.240620</td>
      <td>0.490530</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.200100</td>
      <td>0.214276</td>
      <td>0.462899</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.177398</td>
      <td>0.150440</td>
      <td>0.387866</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.163052</td>
      <td>0.135140</td>
      <td>0.367615</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.153141</td>
      <td>0.131269</td>
      <td>0.362311</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.147007</td>
      <td>0.133025</td>
      <td>0.364726</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.143294</td>
      <td>0.132439</td>
      <td>0.363922</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.138928</td>
      <td>0.131754</td>
      <td>0.362979</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.135169</td>
      <td>0.128147</td>
      <td>0.357976</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.133087</td>
      <td>0.125253</td>
      <td>0.353910</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.130366</td>
      <td>0.126195</td>
      <td>0.355240</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.128971</td>
      <td>0.130248</td>
      <td>0.360899</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.127474</td>
      <td>0.128108</td>
      <td>0.357922</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.126128</td>
      <td>0.124583</td>
      <td>0.352963</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.125103</td>
      <td>0.125416</td>
      <td>0.354142</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.123530</td>
      <td>0.129710</td>
      <td>0.360152</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-outputid="14efd873-7950-431e-c11a-7cec83141f20" data-execution_count="93">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>survived_preds, survived_targ <span class="op">=</span> survived_learn.get_preds(dl<span class="op">=</span>survived_dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-outputid="3832ca2d-5ecb-4a20-e48b-1e9f18e6581d" data-execution_count="95">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(survived_targ <span class="op">==</span> (survived_preds<span class="op">&gt;</span><span class="fl">0.5</span>)).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>tensor(0.8258)</code></pre>
</div>
</div>
<p>I get an accuracy of around 83% as well.</p>
</section>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Here are my takeaways from this experiment:</p>
<ul>
<li>A single-target regression model predicts <code>Survived</code> better than <code>Age</code>.</li>
<li>A two-target regression model (<code>Survived</code> and <code>Age</code>) predicts <code>Survived</code> significantly worse than a single-target model (<code>Survived</code> only). Something about introducing an output for <code>Age</code> decreases the model’s performance when predicting survival rate.</li>
<li>A two-target regression model (<code>Survived</code> and <code>Age</code>) predicts <code>Age</code> with about the same correlation as a single-target model (<code>Age</code> only).</li>
</ul>
<p>Something about this dataset (and how the model learns from it) makes <code>Age</code> a poor target for prediction. Perhaps it’s the distribution of ages in the dataset, or the relationship with other columns, that makes it harder for the model to predict it accurately.</p>
<p>I’m happy and proud that I was able to run this experiment after failing to overcome some errors the first couple of times I tried to train a two-target model earlier this week.</p>
<p>I hope you enjoyed this blog post!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>