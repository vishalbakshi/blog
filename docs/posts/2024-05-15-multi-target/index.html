<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-05-15">
<meta name="description" content="In this notebook I apply Jeremy Howard’s approach to multi-target classification in fastai to improve a Kaggle submission score.">

<title>Vishal Bakshi’s Blog - Improving Kaggle Private Score with Multi-Target Classification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#multi-output-dataloader" id="toc-multi-output-dataloader" class="nav-link" data-scroll-target="#multi-output-dataloader">Multi-output <code>DataLoader</code></a></li>
  <li><a href="#single-target-model-with-multi-output-dataloaders" id="toc-single-target-model-with-multi-output-dataloaders" class="nav-link" data-scroll-target="#single-target-model-with-multi-output-dataloaders">Single-target Model with Multi-output <code>DataLoaders</code></a></li>
  <li><a href="#single-target-model-with-single-output-dataloaders" id="toc-single-target-model-with-single-output-dataloaders" class="nav-link" data-scroll-target="#single-target-model-with-single-output-dataloaders">Single-target Model with Single-output <code>DataLoaders</code></a></li>
  <li><a href="#multi-target-model-on-multi-output-dataloaders" id="toc-multi-target-model-on-multi-output-dataloaders" class="nav-link" data-scroll-target="#multi-target-model-on-multi-output-dataloaders">Multi-target model on Multi-output <code>DataLoaders</code></a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Improving Kaggle Private Score with Multi-Target Classification</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I apply Jeremy Howard’s approach to multi-target classification in fastai to improve a Kaggle submission score.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 15, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook, I’ll use the code from Jeremy’s <a href="https://www.kaggle.com/code/jhoward/multi-target-road-to-the-top-part-4">Road to the Top, Part 4</a> notebook to train a model that classifies both the disease and the variety of the rice paddy. In the fastai course Part 1 <a href="https://www.youtube.com/watch?v=p4ZZq0736Po&amp;embeds_referring_euri=https%3A%2F%2Fcourse.fast.ai%2F&amp;feature=emb_logo">Lesson 7 video</a>, Jeremy encourages viewers/students to see how this model scores and to explore the inputs and outputs in order to understand how the model behaves. I’ll do just that in this notebook.</p>
<p>::: {.cell _kg_hide-input=‘true’ _kg_hide-output=‘true’ execution=‘{“iopub.execute_input”:“2024-05-16T00:04:59.838201Z”,“iopub.status.busy”:“2024-05-16T00:04:59.837710Z”,“iopub.status.idle”:“2024-05-16T00:05:32.536710Z”,“shell.execute_reply”:“2024-05-16T00:05:32.535138Z”,“shell.execute_reply.started”:“2024-05-16T00:04:59.838095Z”}’ trusted=‘true’ execution_count=1}</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>iskaggle <span class="op">=</span> os.environ.get(<span class="st">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st">''</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iskaggle:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>Uqq fastcore fastai timm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.widgets <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># install fastkaggle if not available</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="im">import</span> fastkaggle</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> ModuleNotFoundError:</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>Uqq fastkaggle</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastkaggle <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastdownload <span class="im">import</span> download_url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
</section>
<section id="multi-output-dataloader" class="level2">
<h2 class="anchored" data-anchor-id="multi-output-dataloader">Multi-output <code>DataLoader</code></h2>
<p>::: {.cell _kg_hide-output=‘true’ execution=‘{“iopub.execute_input”:“2024-05-16T00:05:32.540740Z”,“iopub.status.busy”:“2024-05-16T00:05:32.539503Z”,“iopub.status.idle”:“2024-05-16T00:05:42.792866Z”,“shell.execute_reply”:“2024-05-16T00:05:42.791792Z”,“shell.execute_reply.started”:“2024-05-16T00:05:32.540695Z”}’ trusted=‘true’ execution_count=2}</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>comp <span class="op">=</span> <span class="st">'paddy-disease-classification'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> setup_comp(comp, install<span class="op">=</span><span class="st">'fastai "timm&gt;=0.6.2.dev0"'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.parallel <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:06:48.541947Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:06:48.541514Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:06:48.606090Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:06:48.605044Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:06:48.541912Z&quot;}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'train.csv'</span>, index_col<span class="op">=</span><span class="st">'image_id'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>label</th>
      <th>variety</th>
      <th>age</th>
    </tr>
    <tr>
      <th>image_id</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>100330.jpg</th>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>100365.jpg</th>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>100382.jpg</th>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>100632.jpg</th>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>101918.jpg</th>
      <td>bacterial_leaf_blight</td>
      <td>ADT45</td>
      <td>45</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>There are 10 unique <code>label</code>s (including <code>normal</code>) and 10 unique <code>variety</code> values. This means the model will have to predict 10 + 10 = 20 different probabilities.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:47:19.157462Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:47:19.156877Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:47:19.166832Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:47:19.165756Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:47:19.157429Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'label'</span>].unique().shape, df[<span class="st">'variety'</span>].unique().shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>((10,), (10,))</code></pre>
</div>
</div>
<p>Jeremy creates a <code>get_variety</code> helper function which returns the <code>variety</code> column value for a given image path. Note that when he created <code>df</code>, he passes <code>index_col='image_id'</code> in order to make the index of that DataFrame the image path for easier lookup.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:06:11.793210Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:06:11.792340Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:06:11.799313Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:06:11.797985Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:06:11.793164Z&quot;}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_variety(p): <span class="cf">return</span> df.loc[p.name, <span class="st">'variety'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:49:53.516651Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:49:53.515609Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:49:53.526114Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:49:53.524937Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:49:53.516599Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>get_variety(Path(<span class="st">'100330.jpg'</span>)) <span class="op">==</span> <span class="st">'ADT45'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>True</code></pre>
</div>
</div>
<p>Jeremy’s <code>DataBlock</code> consists of three <code>blocks</code>—one <code>ImageBlock</code> that processes the inputs and two <code>CategoryBlock</code>s, one per target (<code>label</code> and <code>variety</code>). Because there are three <code>blocks</code> we have to specify that the number of inputs, <code>n_inp</code> is <code>1</code>. Note that we can specify a list of <code>get_y</code> getters, one for each target.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:53:02.693817Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:53:02.692935Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:53:18.560028Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:53:18.558998Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:53:02.693773Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataBlock(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock,CategoryBlock,CategoryBlock),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [parent_label,get_variety],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>).dataloaders(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:53:20.597867Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:53:20.597470Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:53:22.108365Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:53:22.107139Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:53:20.597817Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>As done in his notebook, I’ll first test this approach by training a single-target classifier for disease label. Since there are three <code>blocks</code>, the loss function and metrics will receive three things: the predictions (<code>inp</code>), the <code>disease</code> labels and the <code>variety</code> labels.</p>
</section>
<section id="single-target-model-with-multi-output-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="single-target-model-with-multi-output-dataloaders">Single-target Model with Multi-output <code>DataLoaders</code></h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:55:46.960805Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:55:46.959700Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:55:46.972591Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:55:46.971509Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:55:46.960759Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>error_rate??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> error_rate<span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">,</span> targ<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> error_rate<span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">,</span> targ<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"1 - `accuracy`"</span>
    <span class="ansi-green-fg">return</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">-</span> accuracy<span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">,</span> targ<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span>axis<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.7/site-packages/fastai/metrics.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:54:58.846697Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:54:58.845451Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:54:58.853235Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:54:58.851918Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:54:58.846651Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_err(inp,disease,variety): <span class="cf">return</span> error_rate(inp,disease)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_loss(inp,disease,variety): <span class="cf">return</span> F.cross_entropy(inp,disease)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:56:16.108163Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:56:16.107384Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T17:56:17.413491Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T17:56:17.412383Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:56:16.108110Z&quot;}" data-trusted="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>disease_loss, metrics<span class="op">=</span>disease_err, n_out<span class="op">=</span><span class="dv">10</span>).to_fp16()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet34-b627a593.pth" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fc439cfd1984456597fe763a876a0507","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T17:57:33.936029Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T17:57:33.934810Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:12:11.802486Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:12:11.801101Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T17:57:33.935983Z&quot;}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.950858</td>
      <td>1.315877</td>
      <td>0.420471</td>
      <td>01:15</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.804355</td>
      <td>0.466699</td>
      <td>0.148967</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.602656</td>
      <td>0.520798</td>
      <td>0.152811</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.535991</td>
      <td>0.533135</td>
      <td>0.146084</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.499837</td>
      <td>0.413230</td>
      <td>0.125420</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.374249</td>
      <td>0.522707</td>
      <td>0.145123</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.303674</td>
      <td>0.249570</td>
      <td>0.074003</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.233556</td>
      <td>0.222586</td>
      <td>0.061989</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.162041</td>
      <td>0.166682</td>
      <td>0.044690</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.123177</td>
      <td>0.137297</td>
      <td>0.036521</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.080774</td>
      <td>0.139264</td>
      <td>0.034599</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.051097</td>
      <td>0.124689</td>
      <td>0.031235</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.054974</td>
      <td>0.123993</td>
      <td>0.032196</td>
      <td>01:07</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:14:55.090821Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:14:55.089764Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:14:55.387545Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:14:55.386260Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:14:55.090775Z&quot;}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>learn.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The outputs of this model consist of 10 predictions for each image:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:15:58.882809Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:15:58.881892Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:17:05.491899Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:17:05.490548Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:15:58.882757Z&quot;}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>learn.dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:18:32.503015Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:18:32.502101Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:18:32.510495Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:18:32.509446Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:18:32.502965Z&quot;}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>probs[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>torch.Size([2081, 10])</code></pre>
</div>
</div>
<p>Here’s what the activations of the models look like:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:20:14.023582Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:20:14.023163Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:20:14.034078Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:20:14.032720Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:20:14.023549Z&quot;}" data-trusted="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>probs[<span class="dv">0</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>tensor([[ 2.8325, -7.3865, -3.3020,  8.6670, -3.5552, -5.3201,  0.5134,  0.8277,
         -1.1257,  1.3131],
        [-0.3330, -4.0044, -4.1958,  0.3577, -2.9964, -3.6226, -0.7052,  3.2369,
          9.9019, -0.7284],
        [-1.3333, -3.0190, -4.2167, -2.3115, -2.1287, -2.2457, -1.8324, -2.1084,
         -1.1698, 13.2637],
        [ 4.0613, 16.8584, -3.1682, -1.8026, -0.4133, -5.2385,  0.7230, -3.3894,
         -7.2209, -2.8204],
        [-1.5410, -0.0458,  1.3879, -0.5194, -2.3740, 13.3403, -1.4106, -4.4908,
         -1.3759, -1.7310]])</code></pre>
</div>
</div>
<p>Most of the output activations are between -5 and +5:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:21:25.152964Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:21:25.151900Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:21:25.366106Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:21:25.364917Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:21:25.152911Z&quot;}" data-trusted="true" data-execution_count="32">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plt.hist(probs[<span class="dv">0</span>].flatten().detach().numpy())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The second object returned by <code>tta</code> is a tuple where the first tensor is the target <code>label</code> for disease and the second tensor is the target <code>variety</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:22:31.548747Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:22:31.548308Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:22:31.557494Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:22:31.556296Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:22:31.548709Z&quot;}" data-trusted="true" data-execution_count="33">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>tensor([3, 8, 9,  ..., 9, 5, 1])</code></pre>
</div>
</div>
<p>The error rate for the TTA predictions on the validation set is <strong>0.025</strong>, similar to what Jeremy had.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:29:01.164724Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:29:01.163718Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:29:01.174597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:29:01.173467Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:29:01.164675Z&quot;}" data-trusted="true" data-execution_count="54">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> (probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> probs[<span class="dv">1</span>][<span class="dv">0</span>]).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>tensor(0.0250)</code></pre>
</div>
</div>
<p>I’ll now create the test DataLoaders using the test set (making sure to sort the files so they are in the same order as the sample submission CSV):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:34:01.562771Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:34:01.561607Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:34:04.885944Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:34:04.884911Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:34:01.562710Z&quot;}" data-trusted="true" data-execution_count="62">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>tst_files.sort()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>tst_files[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>(#5) [Path('../input/paddy-disease-classification/test_images/200001.jpg'),Path('../input/paddy-disease-classification/test_images/200002.jpg'),Path('../input/paddy-disease-classification/test_images/200003.jpg'),Path('../input/paddy-disease-classification/test_images/200004.jpg'),Path('../input/paddy-disease-classification/test_images/200005.jpg')]</code></pre>
</div>
</div>
<p>Then I’ll calculate the TTA predictions on the test set:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:35:33.222885Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:35:33.222420Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:37:19.042840Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:37:19.041502Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:35:33.222833Z&quot;}" data-trusted="true" data-execution_count="63">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:37:31.924407Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:37:31.924014Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:37:31.931511Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:37:31.930472Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:37:31.924373Z&quot;}" data-trusted="true" data-execution_count="65">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tst_files), probs[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>(3469, torch.Size([3469, 10]))</code></pre>
</div>
</div>
<p>Most of the activations are between -10 and +10.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:38:09.458540Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:38:09.458137Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:38:09.711432Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:38:09.710243Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:38:09.458508Z&quot;}" data-trusted="true" data-execution_count="67">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plt.hist(probs[<span class="dv">0</span>].flatten().detach().numpy())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Here is the distribution of classes (index of maximum activation per image):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:38:59.792035Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:38:59.791137Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:38:59.992901Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:38:59.991895Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:38:59.791992Z&quot;}" data-trusted="true" data-execution_count="68">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plt.hist(probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>).flatten().detach().numpy())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>I’ll export this as a CSV so I can submit it to Kaggle for scoring.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:39:46.321605Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:39:46.320412Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:39:46.331957Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:39:46.330763Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:39:46.321549Z&quot;}" data-trusted="true" data-execution_count="69">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the index (class) of the maximum prediction for each item</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>idxs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>tensor([7, 8, 3,  ..., 8, 1, 5])</code></pre>
</div>
</div>
<p>The <code>vocab</code> contains two sets of labels—one for disease and one for variety. I only want to map the disease labels for now.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:39:49.609796Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:39:49.609404Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:39:49.616886Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:39:49.615827Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:39:49.609761Z&quot;}" data-trusted="true" data-execution_count="70">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dls.vocab[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>['bacterial_leaf_blight', 'bacterial_leaf_streak', 'bacterial_panicle_blight', 'blast', 'brown_spot', 'dead_heart', 'downy_mildew', 'hispa', 'normal', 'tungro']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:39:50.840552Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:39:50.839411Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:39:50.848840Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:39:50.847780Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:39:50.840504Z&quot;}" data-trusted="true" data-execution_count="71">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert indexes to vocab strings</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab[<span class="dv">0</span>]))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>mapping</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>{0: 'bacterial_leaf_blight',
 1: 'bacterial_leaf_streak',
 2: 'bacterial_panicle_blight',
 3: 'blast',
 4: 'brown_spot',
 5: 'dead_heart',
 6: 'downy_mildew',
 7: 'hispa',
 8: 'normal',
 9: 'tungro'}</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:40:04.390953Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:40:04.389863Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:40:04.416599Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:40:04.415690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:40:04.390889Z&quot;}" data-trusted="true" data-execution_count="72">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add vocab strings to sample submission file and export to CSV</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>).<span class="bu">map</span>(mapping)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>ss.label <span class="op">=</span> results</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm1.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T18:40:05.626689Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T18:40:05.625583Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T18:40:06.675785Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T18:40:06.674360Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T18:40:05.626635Z&quot;}" data-trusted="true" data-execution_count="73">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm1.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>This submission resulted in a Private score of <strong>0.97580</strong>.</p>
</section>
<section id="single-target-model-with-single-output-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="single-target-model-with-single-output-dataloaders">Single-target Model with Single-output <code>DataLoaders</code></h2>
<p>As another comparison/baseline, I’ll train a single-target disease classifier using a single-output <code>DataLoaders</code> object.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T20:32:45.358096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T20:32:45.357031Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T20:33:00.483740Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T20:33:00.482578Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T20:32:45.358029Z&quot;}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataBlock(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock,CategoryBlock),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> parent_label,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>).dataloaders(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T20:33:00.486329Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T20:33:00.485743Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T20:33:02.085221Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T20:33:02.083962Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T20:33:00.486289Z&quot;}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T20:33:07.590089Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T20:33:07.589134Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T20:45:47.825655Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T20:45:47.824406Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T20:33:07.590016Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet34-b627a593.pth" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5eb83538b23a4db8a23b8cd02bf4a4f0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.941936</td>
      <td>1.325037</td>
      <td>0.419990</td>
      <td>01:16</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.808069</td>
      <td>0.461713</td>
      <td>0.158097</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.592128</td>
      <td>0.562304</td>
      <td>0.172033</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.553166</td>
      <td>0.526510</td>
      <td>0.142239</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.499870</td>
      <td>0.468296</td>
      <td>0.137914</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.365323</td>
      <td>0.344052</td>
      <td>0.095627</td>
      <td>00:58</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.315392</td>
      <td>0.372406</td>
      <td>0.105718</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.245668</td>
      <td>0.210443</td>
      <td>0.062470</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.165351</td>
      <td>0.178430</td>
      <td>0.047093</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.112827</td>
      <td>0.153295</td>
      <td>0.038924</td>
      <td>00:50</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.079190</td>
      <td>0.144607</td>
      <td>0.033638</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.048934</td>
      <td>0.128548</td>
      <td>0.029313</td>
      <td>00:51</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.046523</td>
      <td>0.129133</td>
      <td>0.027871</td>
      <td>00:50</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T21:15:51.725031Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T21:15:51.724006Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T21:16:57.038213Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T21:16:57.036652Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T21:15:51.724988Z&quot;}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>learn.dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T21:17:16.160594Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T21:17:16.159555Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T21:17:16.168003Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T21:17:16.166861Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T21:17:16.160555Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>probs[<span class="dv">0</span>].shape, probs[<span class="dv">1</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(torch.Size([2081, 10]), torch.Size([2081]))</code></pre>
</div>
</div>
<p>This model has a slightly better TTA error rate on the validation set.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T21:17:23.334757Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T21:17:23.333626Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T21:17:23.343470Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T21:17:23.342191Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T21:17:23.334715Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> (probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> probs[<span class="dv">1</span>]).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>tensor(0.0240)</code></pre>
</div>
</div>
<p>There is only one set of <code>vocab</code> since there is only 1 target:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T21:18:02.183020Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T21:18:02.182605Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T21:18:02.190725Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T21:18:02.189367Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T21:18:02.182984Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dls.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>['bacterial_leaf_blight', 'bacterial_leaf_streak', 'bacterial_panicle_blight', 'blast', 'brown_spot', 'dead_heart', 'downy_mildew', 'hispa', 'normal', 'tungro']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-15T21:18:21.257101Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-15T21:18:21.256615Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-15T21:20:15.057603Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-15T21:20:15.056117Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-15T21:18:21.257032Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>tst_files.sort()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get the index (class) of the maximum prediction for each item</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> probs[<span class="dv">0</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># convert indexes to vocab strings</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co"># add vocab strings to sample submission file and export to CSV</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>).<span class="bu">map</span>(mapping)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>ss.label <span class="op">=</span> results</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm2.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm2.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>This submission got the same Private score as the single-target model trained on the multi-output DataLoaders: <strong>0.97580</strong></p>
</section>
<section id="multi-target-model-on-multi-output-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="multi-target-model-on-multi-output-dataloaders">Multi-target model on Multi-output <code>DataLoaders</code></h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:03.095437Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:03.094782Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:13.685733Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:13.684788Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:03.095393Z&quot;}" data-trusted="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataBlock(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock,CategoryBlock,CategoryBlock),</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    n_inp<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    get_y <span class="op">=</span> [parent_label,get_variety],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>).dataloaders(trn_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:15.561035Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:15.560640Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:17.373667Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:17.372536Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:15.561000Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Jeremy picks the first ten activations of the model as the disease classes and the second ten as the variety classes. The <code>disease_loss</code> and <code>variety_loss</code> are defined accordingly:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:26.930933Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:26.929987Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:26.936644Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:26.935507Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:26.930884Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_loss(inp,disease,variety): <span class="cf">return</span> F.cross_entropy(inp[:,:<span class="dv">10</span>],disease)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:28.301739Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:28.301346Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:28.306951Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:28.305809Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:28.301699Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> variety_loss(inp,disease,variety): <span class="cf">return</span> F.cross_entropy(inp[:,<span class="dv">10</span>:],variety)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The combined loss we are trying to minimize is the sum of the two target’s loss:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:29.272156Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:29.271210Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:29.277238Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:29.276231Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:29.272114Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_loss(inp,disease,variety): <span class="cf">return</span> disease_loss(inp,disease,variety)<span class="op">+</span>variety_loss(inp,disease,variety)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The error rates are defined the same way (first 10 predictions for disease, second 10 for variety):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:30.050463Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:30.049526Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:30.055943Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:30.054782Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:30.050424Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disease_err(inp,disease,variety): <span class="cf">return</span> error_rate(inp[:,:<span class="dv">10</span>],disease)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> variety_err(inp,disease,variety): <span class="cf">return</span> error_rate(inp[:,<span class="dv">10</span>:],variety)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>err_metrics <span class="op">=</span> (disease_err,variety_err)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Jeremy also chooses to view the disease loss and variety loss separately.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:36.993478Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:36.992585Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:36.998510Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:36.997395Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:36.993432Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="op">=</span> err_metrics<span class="op">+</span>(disease_loss,variety_loss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>n_out</code> is set to <code>20</code> since we have two pairs of 10 classes that the model is trying to predict.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:38.419027Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:38.418111Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:07:39.590742Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:07:39.589675Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:38.418977Z&quot;}" data-trusted="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>combine_loss, metrics<span class="op">=</span>all_metrics, n_out<span class="op">=</span><span class="dv">20</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet34-b627a593.pth" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"68556c882ec9433ea85c2a21781f1f05","version_major":2,"version_minor":0}
</script>
</div>
</div>
<p>Jeremy mentioned that we might have to train this model for longer before it performs as well as the single-target model since we are asking to do more (predicts twice the number of targets). I’ll train and submit with 12 epochs first as a baseline.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:07:41.167185Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:07:41.166807Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:22:22.385708Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:22:22.384465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:07:41.167152Z&quot;}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>3.191633</td>
      <td>1.969826</td>
      <td>0.419990</td>
      <td>0.219125</td>
      <td>1.272959</td>
      <td>0.696868</td>
      <td>01:19</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.266333</td>
      <td>0.694686</td>
      <td>0.154733</td>
      <td>0.059106</td>
      <td>0.489899</td>
      <td>0.204788</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.887806</td>
      <td>0.605122</td>
      <td>0.146564</td>
      <td>0.053340</td>
      <td>0.440036</td>
      <td>0.165086</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.834215</td>
      <td>1.014124</td>
      <td>0.188371</td>
      <td>0.090341</td>
      <td>0.617206</td>
      <td>0.396918</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.709637</td>
      <td>0.634970</td>
      <td>0.117732</td>
      <td>0.058145</td>
      <td>0.439491</td>
      <td>0.195479</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.587873</td>
      <td>0.580158</td>
      <td>0.120135</td>
      <td>0.045651</td>
      <td>0.420883</td>
      <td>0.159275</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.453230</td>
      <td>0.404975</td>
      <td>0.084575</td>
      <td>0.031716</td>
      <td>0.295974</td>
      <td>0.109001</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.332355</td>
      <td>0.315852</td>
      <td>0.069678</td>
      <td>0.017780</td>
      <td>0.252630</td>
      <td>0.063222</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.240017</td>
      <td>0.276671</td>
      <td>0.054781</td>
      <td>0.025469</td>
      <td>0.197499</td>
      <td>0.079172</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.166121</td>
      <td>0.182990</td>
      <td>0.039885</td>
      <td>0.012494</td>
      <td>0.140265</td>
      <td>0.042726</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.112039</td>
      <td>0.182566</td>
      <td>0.036040</td>
      <td>0.011533</td>
      <td>0.138646</td>
      <td>0.043920</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.081297</td>
      <td>0.177871</td>
      <td>0.034599</td>
      <td>0.008650</td>
      <td>0.136665</td>
      <td>0.041206</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.074365</td>
      <td>0.173486</td>
      <td>0.031716</td>
      <td>0.008650</td>
      <td>0.133155</td>
      <td>0.040331</td>
      <td>01:06</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:23:54.242809Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:23:54.241727Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:24:59.952326Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:24:59.951136Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:23:54.242751Z&quot;}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>learn.dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>There are 20 predictions for each image.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:25:23.815415Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:25:23.814405Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:25:23.822470Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:25:23.821305Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:25:23.815364Z&quot;}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>probs[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>torch.Size([2081, 20])</code></pre>
</div>
</div>
<p>The first 10 predictions are for the disease <code>label</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:35:04.686839Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:35:04.686403Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:35:04.697353Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:35:04.696265Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:35:04.686795Z&quot;}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> (probs[<span class="dv">0</span>][:,:<span class="dv">10</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> probs[<span class="dv">1</span>][<span class="dv">0</span>]).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>tensor(0.0279)</code></pre>
</div>
</div>
<p>The TTA error rate on the validation set is slightly lower than the single-target models.</p>
<p>Just out of curiosity, I’ll also calculate the TTA error rate for <code>variety</code>:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:36:06.001511Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:36:06.001102Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:36:06.011447Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:36:06.010226Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:36:06.001476Z&quot;}" data-trusted="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> (probs[<span class="dv">0</span>][:,<span class="dv">10</span>:].argmax(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> probs[<span class="dv">1</span>][<span class="dv">1</span>]).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>tensor(0.0077)</code></pre>
</div>
</div>
<p>The model is much more accurate at predicting the <code>variety</code> of rice.</p>
<p>I’ll submit TTA predictions on the test set:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:39:16.914213Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:39:16.913727Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T00:41:04.238363Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T00:41:04.237222Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:39:16.914177Z&quot;}" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>tst_files.sort()</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get the index (class) of the maximum prediction for each item</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> probs[<span class="dv">0</span>][:,:<span class="dv">10</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># convert indexes to vocab strings</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab[<span class="dv">0</span>]))</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co"># add vocab strings to sample submission file and export to CSV</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>).<span class="bu">map</span>(mapping)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>ss.label <span class="op">=</span> results</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm3.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm3.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>This model gave me the same Private score: <strong>0.97580</strong>.</p>
<p>Finally, I’ll train the model for a few more epochs and see if that improves the score.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T00:43:26.831182Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T00:43:26.830737Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T01:02:40.941877Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T01:02:40.940371Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T00:43:26.831142Z&quot;}" data-trusted="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>combine_loss, metrics<span class="op">=</span>all_metrics, n_out<span class="op">=</span><span class="dv">20</span>).to_fp16()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">16</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>3.186875</td>
      <td>2.025326</td>
      <td>0.409419</td>
      <td>0.214320</td>
      <td>1.350042</td>
      <td>0.675284</td>
      <td>01:06</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>disease_err</th>
      <th>variety_err</th>
      <th>disease_loss</th>
      <th>variety_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.275486</td>
      <td>0.722841</td>
      <td>0.168188</td>
      <td>0.068236</td>
      <td>0.495478</td>
      <td>0.227363</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.812811</td>
      <td>0.582493</td>
      <td>0.128784</td>
      <td>0.053340</td>
      <td>0.401935</td>
      <td>0.180558</td>
      <td>01:08</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.736832</td>
      <td>0.655212</td>
      <td>0.145603</td>
      <td>0.064873</td>
      <td>0.447887</td>
      <td>0.207325</td>
      <td>01:08</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.777283</td>
      <td>1.089296</td>
      <td>0.193176</td>
      <td>0.119654</td>
      <td>0.611161</td>
      <td>0.478135</td>
      <td>01:08</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.656918</td>
      <td>0.736651</td>
      <td>0.132148</td>
      <td>0.063912</td>
      <td>0.465955</td>
      <td>0.270696</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.611457</td>
      <td>0.523899</td>
      <td>0.104277</td>
      <td>0.044690</td>
      <td>0.359421</td>
      <td>0.164478</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.497228</td>
      <td>0.408523</td>
      <td>0.076886</td>
      <td>0.039885</td>
      <td>0.276221</td>
      <td>0.132302</td>
      <td>01:11</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.418236</td>
      <td>0.349095</td>
      <td>0.065834</td>
      <td>0.026430</td>
      <td>0.262863</td>
      <td>0.086232</td>
      <td>01:10</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.292306</td>
      <td>0.334778</td>
      <td>0.070639</td>
      <td>0.022105</td>
      <td>0.253223</td>
      <td>0.081556</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.223652</td>
      <td>0.276235</td>
      <td>0.051418</td>
      <td>0.014897</td>
      <td>0.214205</td>
      <td>0.062030</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.172232</td>
      <td>0.222825</td>
      <td>0.046612</td>
      <td>0.013936</td>
      <td>0.166589</td>
      <td>0.056236</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.117083</td>
      <td>0.198665</td>
      <td>0.038443</td>
      <td>0.008650</td>
      <td>0.154245</td>
      <td>0.044420</td>
      <td>01:06</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.086082</td>
      <td>0.196476</td>
      <td>0.040365</td>
      <td>0.010091</td>
      <td>0.159040</td>
      <td>0.037436</td>
      <td>01:08</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.074184</td>
      <td>0.185352</td>
      <td>0.039404</td>
      <td>0.006728</td>
      <td>0.152728</td>
      <td>0.032625</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.056641</td>
      <td>0.174692</td>
      <td>0.033638</td>
      <td>0.006728</td>
      <td>0.144675</td>
      <td>0.030018</td>
      <td>01:07</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.043815</td>
      <td>0.177776</td>
      <td>0.034118</td>
      <td>0.007208</td>
      <td>0.144719</td>
      <td>0.033058</td>
      <td>01:06</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T01:13:42.053801Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T01:13:42.053449Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T01:13:42.287533Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T01:13:42.286583Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T01:13:42.053751Z&quot;}" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>learn.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-54-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T01:14:18.695656Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T01:14:18.695240Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T01:15:24.589569Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T01:15:24.588430Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T01:14:18.695621Z&quot;}" data-trusted="true" data-execution_count="28">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>learn.dls.valid)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> (probs[<span class="dv">0</span>][:,:<span class="dv">10</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> probs[<span class="dv">1</span>][<span class="dv">0</span>]).<span class="bu">float</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="16" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>tensor(0.0245)</code></pre>
</div>
</div>
<p>That’s a slightly better TTA validation error rate.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-05-16T01:21:43.291536Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-05-16T01:21:43.291087Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-05-16T01:23:27.951959Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-05-16T01:23:27.950597Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-05-16T01:21:43.291494Z&quot;}" data-trusted="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>tst_files.sort()</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get the index (class) of the maximum prediction for each item</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> probs[<span class="dv">0</span>][:,:<span class="dv">10</span>].argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co"># convert indexes to vocab strings</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab[<span class="dv">0</span>]))</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="co"># add vocab strings to sample submission file and export to CSV</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>).<span class="bu">map</span>(mapping)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>ss.label <span class="op">=</span> results</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm4.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm4.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="16" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>The Private scored improved to <strong>0.97811</strong>! That’s not insignificant. Training on multi-target, at least for a resnet34 on the <code>Resize(192, method='squish')</code> item transform and <code>aug_transforms(size=128, min_scale=0.75)</code> batch transform. Here is the summary of the four submissions from this notebook:</p>
<p><img src="1.png" class="img-fluid"></p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I am so glad that I ran this experiment since I am currently involved in a Kaggle competition where I was considering multi-target classification. There’s no certainty that it’ll improve my Private score in that situation, but it’s promising to see it improve the Paddy Disease Classification Private score here. Many thanks to Jeremy for introducing us to these engaging concepts.</p>
<p>I hope you enjoyed this blog post!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>