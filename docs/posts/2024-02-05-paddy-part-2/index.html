<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-02-05">
<meta name="description" content="In this notebook I work through Jeremy Howard’s Live Coding 9 video in which he continues working on the Paddy Doctor Disease Classification Kaggle Competition.">

<title>Paddy Doctor Kaggle Competition - Part 2 – Vishal Bakshi’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9c1ae87ad5063dce4f793ccd314a7566.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#miscellaneous-topics" id="toc-miscellaneous-topics" class="nav-link" data-scroll-target="#miscellaneous-topics">Miscellaneous topics</a></li>
  <li><a href="#improving-a-model-for-a-kaggle-competition" id="toc-improving-a-model-for-a-kaggle-competition" class="nav-link" data-scroll-target="#improving-a-model-for-a-kaggle-competition">Improving a model for a kaggle competition</a></li>
  <li><a href="#saving-a-trained-model" id="toc-saving-a-trained-model" class="nav-link" data-scroll-target="#saving-a-trained-model">Saving a trained model</a></li>
  <li><a href="#test-time-augmentation" id="toc-test-time-augmentation" class="nav-link" data-scroll-target="#test-time-augmentation">Test Time Augmentation</a></li>
  <li><a href="#prepare-file-for-kaggle-submission" id="toc-prepare-file-for-kaggle-submission" class="nav-link" data-scroll-target="#prepare-file-for-kaggle-submission">Prepare file for kaggle submission</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Paddy Doctor Kaggle Competition - Part 2</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I work through Jeremy Howard’s Live Coding 9 video in which he continues working on the Paddy Doctor Disease Classification Kaggle Competition.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the fastai course Part 1 <a href="https://youtu.be/AdhG64NF76E?feature=shared&amp;t=3117">Lesson 6 video</a> Jeremy Howard walked through the notebooks <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2">Small models: Road to the Top, Part 2</a> where he builds increasingly accurate solutions to the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> Kaggle Competition. In the video, Jeremy referenced a series of walkthrough videos that he made while working through the four-notebook series for this competition. I’m excited to watch these walkthroughs to better understand how to approach a Kaggle competition from the perspective of a former #1 Kaggle grandmaster.</p>
<p>In this blog post series, I’ll walk through the code Jeremy shared in each of the 6 Live Coding videos focused on this competition, submitting predictions to Kaggle along the way. My last two blog posts in this series reference Jeremy’s <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a> notebook to improve my large model ensemble predictions. Here are the links to each of the blog posts in this series:</p>
<ul>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-1/">Part 1: Live Coding 8</a></li>
<li>Part 2: Live Coding 9 (You are here)</li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">Part 3: Live Coding 10</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-4/">Part 4: Live Coding 11</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-5/">Part 5: Live Coding 12</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-6/">Part 6: Live Coding 13</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-7/">Part 7: Improving My Large Ensemble, Part 1</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-8/">Part 8: Improving My Large Ensemble, Part 2</a></li>
</ul>
<p><a href="https://www.youtube.com/watch?v=EK5wJRzffas">Link to the Live Coding 9 video</a></p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="cell-4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:45:54.252762Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:45:54.251839Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:46:14.077920Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:46:14.076924Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:45:54.252729Z&quot;}}" data-trusted="true" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq timm<span class="op">==</span><span class="fl">0.6.13</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>timm.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>'0.6.13'</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:46:44.565642Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:46:44.564680Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:10.564745Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:10.563498Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:46:44.565601Z&quot;}}" data-trusted="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install fastkaggle if not available</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="im">import</span> fastkaggle</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ModuleNotFoundError</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>Uq fastkaggle</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastkaggle <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>comp <span class="op">=</span> <span class="st">'paddy-disease-classification'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> setup_comp(comp, install<span class="op">=</span><span class="st">'fastai'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.16.5 and &lt;1.23.0 is required for this version of SciPy (detected version 1.24.3
  warnings.warn(f"A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}"</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:10.567260Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:10.566803Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:10.574628Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:10.573776Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:10.567231Z&quot;}}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#4) [Path('../input/paddy-disease-classification/sample_submission.csv'),Path('../input/paddy-disease-classification/train_images'),Path('../input/paddy-disease-classification/train.csv'),Path('../input/paddy-disease-classification/test_images')]</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:10.576096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:10.575759Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:10.582440Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:10.581669Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:10.576055Z&quot;}}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="miscellaneous-topics" class="level2">
<h2 class="anchored" data-anchor-id="miscellaneous-topics">Miscellaneous topics</h2>
<p>These are interesting topics Jeremy walked through before going into the Paddy competition stuff.</p>
<p>To keep installed libraries persistent in Paperspace, install them with the <code>--user</code> flag.</p>
<ul>
<li>Edit <code>/storage/.bash.local</code></li>
<li>Add to it: <code>alias pi="pip install -U --user"</code></li>
<li>In bash <code>type pi</code> will display what <code>pi</code> is aliased as</li>
<li><code>which pi</code> won’t tell you anything useful because <code>pi</code> is not a binary</li>
<li>Run <code>pi timm</code>. The <code>--user</code> flag will put in the <code>.local</code> directory</li>
<li>Need to make sure that your <code>.local</code> directory is symlinked</li>
<li>This way, you don’t have to restart your kernel after <code>pip install</code></li>
</ul>
<p>Vim commands:</p>
<ul>
<li><code>/</code> searches (<code>/init</code> will search for the next thing called “init” in the file)</li>
<li>To go back to where we were: <code>Ctrl+o</code></li>
<li>To go forward to where you were: <code>Ctrl+i</code></li>
<li>If you type <code>f</code> it will search on the line the next thing you type, <code>Shift+F</code> searches backwards</li>
<li><code>Shift+A</code> to start inserting at the end of the line</li>
<li>Delete everything up to the next double quote: <code>d+f+"</code></li>
<li>Press <code>.</code> to repeat the previous command</li>
<li><code>%</code> goes to the next parenthesis (goes to closing parenthesis first)</li>
<li>Replace all parameters in functions: <code>c</code> (for change) + <code>i</code> (inside parenthesis) + type the change (like <code>a,b</code>) then go down to the next spot and type <code>.</code></li>
</ul>
</section>
<section id="improving-a-model-for-a-kaggle-competition" class="level2">
<h2 class="anchored" data-anchor-id="improving-a-model-for-a-kaggle-competition">Improving a model for a kaggle competition</h2>
<p>Let’s now try to improve the model from the first walkthrough.</p>
<p>If you train past 10 epochs, you are in danger of overfitting as your model has seen each image 10 times. In order to avoid overfitting we should make it so that it sees a slightly different image each time. You can pass in <code>batch_tfms</code> which will be applied to each mini-batch.</p>
<p>What does <code>aug_transforms</code> do? Flip, zoom, adjust brightness for, rotated, warp images. This is called data augmentation. It returns a list of transformations.</p>
<div id="cell-13" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:10.584932Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:10.584651Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:10.598105Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:10.597244Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:10.584910Z&quot;}}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[Flip -- {'size': None, 'mode': 'bilinear', 'pad_mode': 'reflection', 'mode_mask': 'nearest', 'align_corners': True, 'p': 0.5}:
 encodes: (TensorImage,object) -&gt; encodes
 (TensorMask,object) -&gt; encodes
 (TensorBBox,object) -&gt; encodes
 (TensorPoint,object) -&gt; encodes
 decodes: ,
 Brightness -- {'max_lighting': 0.2, 'p': 1.0, 'draw': None, 'batch': False}:
 encodes: (TensorImage,object) -&gt; encodes
 decodes: ,
 RandomResizedCropGPU -- {'size': (224, 224), 'min_scale': 0.75, 'ratio': (1, 1), 'mode': 'bilinear', 'valid_scale': 1.0, 'max_scale': 1.0, 'mode_mask': 'nearest', 'p': 1.0}:
 encodes: (TensorImage,object) -&gt; encodes
 (TensorBBox,object) -&gt; encodes
 (TensorPoint,object) -&gt; encodes
 (TensorMask,object) -&gt; encodes
 decodes: ]</code></pre>
</div>
</div>
<p>Most models trained on ImageNet are trained on image sizes of 224x224.</p>
<div id="cell-15" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:10.599655Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:10.599304Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:18.954950Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:18.954124Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:10.599622Z&quot;}}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    trn_path, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">460</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In <code>show_batch</code> if you say <code>unique=True</code> it will show the same picture with the different transformations (sometimes it’s flipped, sometimes it’s moved a little bit up and down, sometimes it’s a little bit darker or brighter, or rotated).</p>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:18.956506Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:18.956144Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:20.374505Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:20.373643Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:18.956473Z&quot;}}" data-trusted="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dls.train.show_batch(max_n<span class="op">=</span><span class="dv">4</span>, nrows<span class="op">=</span><span class="dv">1</span>, unique<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The default learning rate from fastai is on the conservative side, meaning it’s a little bit lower than you probably need because Jeremy wanted things to always be able to train. There’s a couple of downsides to using a lower learning rate than you need:</p>
<ul>
<li>Given fixed resources and fixed amount of time, you’re going to have less distance that the weights can move</li>
<li>A high learning rate helps the optimizer to explore the space of options by jumping further to see if there’s better places to go</li>
</ul>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:20.375897Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:20.375595Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:23.741357Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:23.740596Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:20.375871Z&quot;}}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, <span class="st">'convnext_small_in22k'</span>, metrics<span class="op">=</span>error_rate).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_small_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_small_22k_224.pth</code></pre>
</div>
</div>
<p><a href="https://forums.fast.ai/t/getting-error-on-kaggle-kernel-when-using-cnn-learner-function/74934/5">This forum post</a> (sign-in required) helped resolve the <code>[Errno 30] Read-only file system:</code> error thrown when calling <code>lr_find</code>, by changing the <code>model_dir</code> attribute of the <code>Learner</code>:</p>
<div id="cell-21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:23.742614Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:23.742356Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:47:23.747733Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:47:23.746763Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:23.742591Z&quot;}}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">"/kaggle/working"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:47:23.749985Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:47:23.748899Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T04:48:16.132947Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T04:48:16.131796Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:47:23.749960Z&quot;}}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find(suggest_funcs<span class="op">=</span>(valley, slide))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>SuggestedLRs(valley=0.0008317637839354575, slide=0.004365158267319202)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The suggested learning rate is 0.002, but you can see that all the way up to 10^-2 it has a pretty nice slope. We are using 1cycle training schedule which means we are gradually increasing the learning rate and by doing that we can reach higher learning rates, so even these recommendations are going to be on the conservative side.</p>
<div id="cell-24" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T04:52:54.439223Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T04:52:54.438839Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:12:21.918058Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:12:21.917058Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T04:52:54.439193Z&quot;}}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.026152</td>
<td>0.743547</td>
<td>0.227775</td>
<td>01:21</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.495129</td>
<td>0.281290</td>
<td>0.087938</td>
<td>01:34</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.354283</td>
<td>0.253887</td>
<td>0.085055</td>
<td>01:35</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.334391</td>
<td>0.299357</td>
<td>0.084575</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.267883</td>
<td>0.188827</td>
<td>0.052859</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.231655</td>
<td>0.188384</td>
<td>0.052379</td>
<td>01:29</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.167554</td>
<td>0.158490</td>
<td>0.043248</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.117927</td>
<td>0.157844</td>
<td>0.039404</td>
<td>01:29</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.091830</td>
<td>0.144641</td>
<td>0.033638</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.067092</td>
<td>0.108346</td>
<td>0.027391</td>
<td>01:29</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.044437</td>
<td>0.108044</td>
<td>0.025949</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.040759</td>
<td>0.107195</td>
<td>0.024027</td>
<td>01:28</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.031392</td>
<td>0.108461</td>
<td>0.024988</td>
<td>01:29</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="saving-a-trained-model" class="level2">
<h2 class="anchored" data-anchor-id="saving-a-trained-model">Saving a trained model</h2>
<p><code>Learner.export</code> exports the <code>Learner</code> to <code>Learner.path/fname</code>. You specify an absolute path with a preceding <code>'/'</code>. The <code>Learner</code>, in addition to the model and optimizer, contains information about the <code>DataLoaders</code> and what transformations were applied.</p>
<p><code>Learner.save</code> exports just the model and optimizer, not the <code>Learner</code>.</p>
<div id="cell-27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2023-12-07T02:10:08.867981Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-07T02:10:08.867107Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-07T02:10:08.873005Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-07T02:10:08.871769Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-07T02:10:08.867935Z&quot;}}" data-trusted="true">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>learn.path <span class="op">=</span> Path(<span class="st">"/kaggle/working"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2023-12-07T02:10:11.016721Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-07T02:10:11.015777Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-07T02:10:11.459911Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-07T02:10:11.458845Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-07T02:10:11.016681Z&quot;}}" data-trusted="true">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">'cn_sml_12.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-time-augmentation" class="level2">
<h2 class="anchored" data-anchor-id="test-time-augmentation">Test Time Augmentation</h2>
<p>If you don’t use the <code>'squish'</code> item transform, the validation set will only use the cropped center portion of the image, and this is a particularly important situation when you should use test time augmentation.</p>
<p>In test time augmentation, we get multiple versions of each image (4 by default) plus the un-augmented version, we get the prediction on every one and then we get the average (or max) prediction.</p>
<p>We should be able to replicate the final epoch’s error rate manually:</p>
<div id="cell-32" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:13:11.009785Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:13:11.009386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:13:23.214154Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:13:23.213012Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:13:11.009750Z&quot;}}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>probs,targs <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-33" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:14:05.418694Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:14:05.417882Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:14:05.436276Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:14:05.435155Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:14:05.418662Z&quot;}}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>error_rate(probs, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>TensorBase(0.0250)</code></pre>
</div>
</div>
<p>Good. That is the same error rate as the final epoch during training. Now let’s try out <code>tta</code> using the average prediction (of the 4 augemented and 1 un-augmented predictions). We would likely much more clearly see the benefit of <code>tta</code> if we did not <code>squish</code> the images when creating the <code>DataLoaders</code>.</p>
<div id="cell-35" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:16:12.411373Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:16:12.410985Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:17:27.183618Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:17:27.182500Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:16:12.411343Z&quot;}}" data-trusted="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>probs,targs <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.valid)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>error_rate(probs,targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>TensorBase(0.0216)</code></pre>
</div>
</div>
<p>The average <code>tta</code> prediction error rate is less than the regular prediction error rate. Let’s see what error rate we get if we use the maximum <code>tta</code> predictions:</p>
<div id="cell-37" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:17:43.731982Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:17:43.731590Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:18:59.082816Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:18:59.081704Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:17:43.731949Z&quot;}}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>probs,targs <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.valid, use_max<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>error_rate(probs,targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>TensorBase(0.0235)</code></pre>
</div>
</div>
<p>In this case, using the max predictions results in a worse error rate. Generally speaking, Jeremy has found then when you are not using <code>squish</code>, <code>use_max=True</code> results in more accurate predictions.</p>
</section>
<section id="prepare-file-for-kaggle-submission" class="level2">
<h2 class="anchored" data-anchor-id="prepare-file-for-kaggle-submission">Prepare file for kaggle submission</h2>
<div id="cell-40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:20:11.882274Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:20:11.881861Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:20:14.697513Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:20:14.696528Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:20:11.882239Z&quot;}}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>).<span class="bu">sorted</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:20:14.699769Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:20:14.699420Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:20:14.710543Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:20:14.709401Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:20:14.699722Z&quot;}}" data-trusted="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:20:14.712389Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:20:14.711942Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.389665Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.388787Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:20:14.712355Z&quot;}}" data-trusted="true" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>probs,targs <span class="op">=</span> learn.tta(dl<span class="op">=</span>tst_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Each row of <code>probs</code> will contain a probability for each element of the <code>vocab</code>. There are 10 probabilities for each of the 3469 images in the test set.</p>
<div id="cell-44" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.392533Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.391663Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.399538Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.398094Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.392501Z&quot;}}" data-trusted="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls.vocab), <span class="bu">len</span>(tst_dl.dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(10, 3469)</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.401299Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.401019Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.413939Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.412885Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.401275Z&quot;}}" data-trusted="true" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>probs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>torch.Size([3469, 10])</code></pre>
</div>
</div>
<p>What is actually predicting? The thing is predicting is whatever thing that has the highest probability. Go through each row and find the index of the thing with the highest probability (<code>argmax</code>).</p>
<div id="cell-47" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.415489Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.415132Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.431312Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.430254Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.415455Z&quot;}}" data-trusted="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> probs.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>idxs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>torch.Size([3469])</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.434037Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.433399Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.445619Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.444758Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.434010Z&quot;}}" data-trusted="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can rewrite how we create <code>mapping</code> by passing it directly the <code>enumarate</code> object.</p>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.450519Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.449688Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.495778Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.494977Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.450486Z&quot;}}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> idxs.<span class="bu">map</span>(mapping)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ss[<span class="st">'label'</span>] <span class="op">=</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.497999Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.497077Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:17.516247Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:17.515407Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.497961Z&quot;}}" data-trusted="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>ss.to_csv(<span class="st">'subm.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-52" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-29T05:22:17.517852Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-29T05:22:17.517494Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-29T05:22:18.499427Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-29T05:22:18.498224Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-29T05:22:17.517820Z&quot;}}" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>Given that this is an image classification task for natural photos, it will almost certainly have exactly the same characteristics as ImageNet in terms of fine-tuning, so work on the assumption that the things that are in the timm model comparison notebook will apply to this dataset. Once everything is working well, try it on a couple of models or at least run it on a bigger one.</p>
<p>If it was like a segmentation problem or an object detection problem, medical imaging dataset which has pictures that aren’t in ImageNet, Jeremy would try more different architectures, but in those cases he would not try to replicate the research of others and would look at paperswithcode.com to find out which techniques have the best results on segmentation and better still would go and find 2-3 previous Kaggle competitions that have a similar problem type and see who won and see what they did. They’ll likely have done an ensemble, which is fine, but they will also say “the best model in the ensemble was X”, and so just use the smallest version of X I can get away with.</p>
<p>Generally fiddling with architectures tends not to be very useful for any kind of problem that people have fairly regularly studied.</p>
<p>In my <a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">next blog post</a> I walk through the discussion and code from Live Coding 10.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vishalbakshi\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>