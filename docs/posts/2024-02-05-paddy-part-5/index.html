<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-02-05">
<meta name="description" content="In this notebook I work through Jeremy Howard’s Live Coding 12 video in which he continues working on the Paddy Doctor Disease Classification Kaggle Competition.">

<title>Paddy Doctor Kaggle Competition - Part 5 – Vishal Bakshi’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9c1ae87ad5063dce4f793ccd314a7566.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the Data</a></li>
  <li><a href="#review-of-best-vision-models-for-fine-tuning" id="toc-review-of-best-vision-models-for-fine-tuning" class="nav-link" data-scroll-target="#review-of-best-vision-models-for-fine-tuning">Review of best vision models for fine-tuning</a></li>
  <li><a href="#multi-head-deep-learning-model-setup" id="toc-multi-head-deep-learning-model-setup" class="nav-link" data-scroll-target="#multi-head-deep-learning-model-setup">Multi-head deep learning model setup</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Paddy Doctor Kaggle Competition - Part 5</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I work through Jeremy Howard’s Live Coding 12 video in which he continues working on the Paddy Doctor Disease Classification Kaggle Competition.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the fastai course Part 1 <a href="https://youtu.be/AdhG64NF76E?feature=shared&amp;t=3117">Lesson 6 video</a> Jeremy Howard walked through the notebooks <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2">Small models: Road to the Top, Part 2</a> where he builds increasingly accurate solutions to the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> Kaggle Competition. In the video, Jeremy referenced a series of walkthrough videos that he made while working through the four-notebook series for this competition. I’m excited to watch these walkthroughs to better understand how to approach a Kaggle competition from the perspective of a former #1 Kaggle grandmaster.</p>
<p>In this blog post series, I’ll walk through the code Jeremy shared in each of the 6 Live Coding videos focused on this competition, submitting predictions to Kaggle along the way. My last two blog posts in this series reference Jeremy’s <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a> notebook to improve my large model ensemble predictions. Here are the links to each of the blog posts in this series:</p>
<ul>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-1/">Part 1: Live Coding 8</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-2/">Part 2: Live Coding 9</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">Part 3: Live Coding 10</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-4/">Part 4: Live Coding 11</a></li>
<li>Part 5: Live Coding 12 (You are here)</li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-6/">Part 6: Live Coding 13</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-7/">Part 7: Improving My Large Ensemble, Part 1</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-8/">Part 8: Improving My Large Ensemble, Part 2</a></li>
</ul>
<p><a href="https://www.youtube.com/watch?v=GuCkpjXHdTc">Link to Live Coding 12 video</a></p>
<section id="loading-the-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-data">Loading the Data</h3>
<div id="cell-4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-24T00:35:46.598408Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T00:35:46.598058Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T00:36:05.535760Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T00:36:05.533402Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T00:35:46.598379Z&quot;}}" data-trusted="true" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq timm<span class="op">==</span><span class="fl">0.6.13</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>timm.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>'0.6.13'</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-24T00:36:09.906461Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T00:36:09.905638Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T00:36:35.001664Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T00:36:35.000622Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T00:36:09.906416Z&quot;}}" data-trusted="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install fastkaggle if not available</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="im">import</span> fastkaggle</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ModuleNotFoundError</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">-</span>Uq fastkaggle</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastkaggle <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>comp <span class="op">=</span> <span class="st">'paddy-disease-classification'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> setup_comp(comp, install<span class="op">=</span><span class="st">'fastai'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.16.5 and &lt;1.23.0 is required for this version of SciPy (detected version 1.24.3
  warnings.warn(f"A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}"</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-24T00:36:35.004587Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T00:36:35.003956Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T00:36:35.013022Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T00:36:35.012169Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T00:36:35.004549Z&quot;}}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#4) [Path('../input/paddy-disease-classification/sample_submission.csv'),Path('../input/paddy-disease-classification/train_images'),Path('../input/paddy-disease-classification/train.csv'),Path('../input/paddy-disease-classification/test_images')]</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-24T00:36:35.014554Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-24T00:36:35.014279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-24T00:36:35.028839Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-24T00:36:35.028041Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-24T00:36:35.014530Z&quot;}}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="review-of-best-vision-models-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="review-of-best-vision-models-for-fine-tuning">Review of <a href="https://www.kaggle.com/code/jhoward/the-best-vision-models-for-fine-tuning">best vision models for fine-tuning</a></h3>
<p>On PETS, in the top 15, you have a bit of everything (resnetrs, resnetv2, vit, swin, resnet26d, regnet, convnext). The larger vit models only work on larger images. Pleasantly surprised to see some of the vit’s didn’t use much memory and they were pretty fast. resnetrs is small and fast.</p>
<p>On PLANET, it doesn’t look that different except it’s entirely vit, swin and convnext in the top 15. vit_small_patch32_224’s memory usage is amazing.</p>
<p>Running these models took less than 3 hours on Jeremy’s three GPUs. 1200 runs.</p>
<p>When to use larger images? Do everything you can on smaller images, as long as it gets you reasonable results, because you want to iterate quickly. Then, when you want the best accuracy you try bigger and bigger images and see what you can get away with–keep doing that as long as the accuracy improves. In a production environment it’s similar, you make it bigger and bigger until the latency of the model is too high, and you find the right trade-off between model latency and accuracy. Generally speaking, larger images will give you more accurate results but a lot slower (you end up with a lot more pixels from 224^2 to 360^2). For initial iterating you don’t need a really accurate model because you are trying to figure out what data preprocessing works best, or what architecture works best. In a business context, Jeremy would do exactly what he has done here—try a few things on small fast models on small images on a small subset of the data to find out what data preprocessing and architecture to use, and then he would look at what are the constraints in operationalizing this (how much RAM do we have, how much latency can we get away with, how expensive is it going to be) to scale it up to the point where we are getting acceptable results using acceptable resources. It wouldn’t look very different at all than a Kaggle competition in terms of the modeling, but there would be a whole piece of it around user requirements, costs, and stuff like that.</p>
<p>One student tried going from smaller to larger models but it resulted in lower accuracy (note: this is what essentially happened to me, except for the large ensemble with 3-times weighted vit model which matches the small ensemble’s private score), is it just a fluke? No, it’s not a fluke. It means you pressed the wrong buttons somehow. Re-run Jeremy’s notebooks and then look at yours and see how they’re different. And then figure out where you went wrong. When debugging, look at the inputs and outputs—what predictions are you making? For example are you always predicting 0? Did you run <code>lr.find</code> to see what learning rate works well? Stuff like that.</p>
<p>When exporting a model, the format is pickle but the file extension is <code>pth</code> (what PyTorch uses).</p>
</section>
<section id="multi-head-deep-learning-model-setup" class="level3">
<h3 class="anchored" data-anchor-id="multi-head-deep-learning-model-setup">Multi-head deep learning model setup</h3>
<p>Let’s take a look at the <code>variety</code> column in <code>train.csv</code>:</p>
<div id="cell-12" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T04:11:11.150626Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T04:11:11.149810Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T04:11:11.182567Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T04:11:11.181642Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T04:11:11.150585Z&quot;}}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'train.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-13" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T04:11:19.321608Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T04:11:19.320787Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T04:11:19.343856Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T04:11:19.343151Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T04:11:19.321577Z&quot;}}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">image_id</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">variety</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>100330.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>100365.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>100382.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>100632.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>101918.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10402</td>
<td>107607.jpg</td>
<td>tungro</td>
<td>Zonal</td>
<td>55</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10403</td>
<td>107811.jpg</td>
<td>tungro</td>
<td>Zonal</td>
<td>55</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10404</td>
<td>108547.jpg</td>
<td>tungro</td>
<td>Zonal</td>
<td>55</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10405</td>
<td>110245.jpg</td>
<td>tungro</td>
<td>Zonal</td>
<td>55</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10406</td>
<td>110381.jpg</td>
<td>tungro</td>
<td>Zonal</td>
<td>55</td>
</tr>
</tbody>
</table>

<p>10407 rows × 4 columns</p>
</div>
</div>
</div>
<div id="cell-14" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T04:12:40.645975Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T04:12:40.645640Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T04:12:40.657820Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T04:12:40.656782Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T04:12:40.645946Z&quot;}}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df.variety.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>variety
ADT45             6992
KarnatakaPonni     988
Ponni              657
AtchayaPonni       461
Zonal              399
AndraPonni         377
Onthanel           351
IR20               114
RR                  36
Surya               32
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>About 70% of the ~10k rows of data are of the “ADT45” variety. But there are ~3k rows that contain other varieties. Something that is a bit counterintuitive: when there’s two different things (what kind of rice is it, what kind of disease is it) sometimes trying to get your model to predict two different things makes tham better at both. This sounds counterintuitive because you are giving it more work to do but you are also giving it more signal—things you’re teaching it to look for. So maybe if it knows how to recognize different kinds of rice, it can use that information to also recognize how different kinds of rice are impacted by different diseases. No idea if this is going to be useful or not but it would be an interesting exercise to try to do that. Also a good exercise of delving into models in a way we haven’t done before. This is going to be much more sophisticated than anything we’ve done with deep learning before. It’s a really good test of how well you understand what’s going on inside a neural network.</p>
<p>Jeremy trained a model three times to see what the error rate was, to see what kind of variation there is. A learning rate of 0.02 for 3 epochs gave consistent results. People are often into doing reproducible training where they have set the seed for their training and run the same thing everytime. I think that’s normally a bad idea because I actually want to see what the natural variation is and so <strong>if I make a change I want to know if the difference I see in the result is due to natural variation or it’s actually something significant.</strong> If the natural variation is very large, it’s going to be tough to see if you actually improved things. But then if the natural variation is so large that improvements are invisible then trying to improve it seems pointless because it sounds like you haven’t really found a way to stably train something. And normally that happens because the learning rate is too big. If you bump the learning rate to 0.04 you’ll see the error rate go all over the place (5%, 6^, etc.). Training for more epochs at a lower learning rate will generally give you more stable results. There’s a compromise because doing more epochs is slow. You could also try using a smaller subset of the data. In the end sometimes things will just be slow but most of the time Jeremy finds that you can get a compromise.</p>
<p>With 6 epochs at half the learning rate (0.01) the model is more accurate (4% error rate rather than 5%).</p>
<p>These improvements you make on a small scale show up on a larger scale. They pretty much always will because they are the same models with more layers or wider activations. If you find some preprocessing step that works well on a convnext tiny, it’s going to work also well on a convnext larg, 99.9% of the time. Most people act as if that’s not true, like in academia, or most people never think to try. But intuitively, of course it’s the same. Why wouldn’t it be the same? It’s the same model just scaled up a bit that behaves very similarly. You can argue that it’s intuitive, but it might not be intuitive because everybody has told you for years that it doesn’t work that way.</p>
<p>I’ll run three trainings of the model as Jeremy has done, to get a sense of the variation in error rates for the <code>convnext_tiny_in22k</code> model:</p>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T00:08:40.074730Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T00:08:40.073962Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T00:08:48.301851Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T00:08:48.300943Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T00:08:40.074681Z&quot;}}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    trn_path, seed<span class="op">=</span><span class="dv">42</span>, valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>), batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T00:08:48.303561Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T00:08:48.303068Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T00:08:48.308311Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T00:08:48.307181Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T00:08:48.303524Z&quot;}}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'convnext_tiny_in22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T15:05:50.248620Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T15:05:50.247663Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T15:10:00.912397Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T15:10:00.911272Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T15:05:50.248573Z&quot;}}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>, <span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.183931</td>
<td>0.734716</td>
<td>0.228736</td>
<td>00:57</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.706453</td>
<td>0.518948</td>
<td>0.162422</td>
<td>01:04</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.408914</td>
<td>0.192417</td>
<td>0.058626</td>
<td>01:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.220568</td>
<td>0.127589</td>
<td>0.037482</td>
<td>01:04</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-20" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T15:11:10.339931Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T15:11:10.339525Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T15:15:25.065628Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T15:15:25.064296Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T15:11:10.339896Z&quot;}}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>, <span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.156675</td>
<td>0.834739</td>
<td>0.226333</td>
<td>00:57</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.689531</td>
<td>0.731114</td>
<td>0.203268</td>
<td>01:04</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.420913</td>
<td>0.229073</td>
<td>0.076886</td>
<td>01:05</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.221704</td>
<td>0.140325</td>
<td>0.041807</td>
<td>01:06</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-22T15:15:46.405521Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-22T15:15:46.404510Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-22T15:19:55.000975Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-22T15:19:54.999561Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-22T15:15:46.405484Z&quot;}}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate).to_fp16()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>, <span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.198419</td>
<td>0.696659</td>
<td>0.214320</td>
<td>00:57</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.651208</td>
<td>0.480119</td>
<td>0.150889</td>
<td>01:04</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.429291</td>
<td>0.229344</td>
<td>0.069197</td>
<td>01:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.225388</td>
<td>0.136109</td>
<td>0.043248</td>
<td>01:03</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The final error rates for convnext_tiny_in22k using a learning rate of 0.02 for 3 epochs were 0.037482, 0.041807, and 0.043248 (the first time I ran these three models). The largest difference in error rate between the three models was 15%. That seems not great. In the video, Jeremy’s models had a difference of 3%.</p>
<p>Let’s actually look at a model. To simplify things later on (when adding new layers to handle two categories of classification) we will remove the <code>to_fp16</code> call.</p>
<div id="cell-23" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:12.507664Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:12.507157Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:13.379515Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:13.378620Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:12.507625Z&quot;}}" data-trusted="true" data-execution_count="42">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-24" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:16.297539Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:16.296774Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:16.301588Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:16.300545Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:16.297506Z&quot;}}" data-trusted="true" data-execution_count="43">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are two things at the top of the model:</p>
<ul>
<li>TimmBody (which has multiple things in it, the first being the <code>model</code>, which in turn has multiple things, the first being the <code>stem</code>, the next being <code>stages</code> and so on).
<ul>
<li>The body does all the hard work of looking at the pixels and trying to find features and things like that. In this case it’s a convolutional neural network. At the very end of it it spits out a whole bunch of information about those pixels.</li>
</ul></li>
<li>the head ((1): Sequential).
<ul>
<li>the head makes sense of what the body spits out and returns predictions. The head is pretty simple, the body is not.</li>
</ul></li>
</ul>
<p>We want to predict two things: what kind of rice it is and what disease it has. Currently the very last layer is a linear layer:</p>
<pre><code>(8): Linear(in_features=512, out_features=10, bias=False)</code></pre>
<p>A lineary layer is something that does a matrix product, with an input of 512 features and output of 10 features. A 512 x 10 matrix.</p>
<p>Let’s grab the head (which is the index-1 thing in the model)</p>
<div id="cell-26" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:20.198613Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:20.197845Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:20.202888Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:20.201668Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:20.198580Z&quot;}}" data-trusted="true" data-execution_count="44">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> m[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:21.890740Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:21.889664Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:21.897448Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:21.896388Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:21.890698Z&quot;}}" data-trusted="true" data-execution_count="45">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): fastai.layers.Flatten(full=False)
  (2): BatchNorm1d(1536, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=1536, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
  (8): Linear(in_features=512, out_features=10, bias=False)
)</code></pre>
</div>
</div>
<p>Is there a way to see the shape of the data as it flows through the model?</p>
<p>Yes, with <code>learn.summary()</code> (full output is too long so showing a snippet here). The <code>64</code> is because we are using a batch size of <code>64</code>. For each image we are predicting 10 probabitilies (for 10 classes of disease).</p>
<pre><code>Sequential (Input shape: 64 x 3 x 224 x 224)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================

...

____________________________________________________________________________
                     64 x 1536           
Flatten                                                        
BatchNorm1d                               3072       True      
Dropout                                                        
____________________________________________________________________________
                     64 x 512            
Linear                                    786432     True      
ReLU                                                           
BatchNorm1d                               1024       True      
Dropout                                                        
____________________________________________________________________________
                     64 x 10             
Linear                                    5120       True      
____________________________________________________________________________</code></pre>
<p>Let’s look at the last layer of the head:</p>
<div id="cell-30" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:26.616532Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:26.616111Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:26.621358Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:26.620132Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:26.616504Z&quot;}}" data-trusted="true" data-execution_count="46">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ll <span class="op">=</span> h[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:27.828983Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:27.828001Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:27.838269Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:27.837373Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:27.828940Z&quot;}}" data-trusted="true" data-execution_count="47">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>Linear(in_features=512, out_features=10, bias=False)</code></pre>
</div>
</div>
<p>We can view the parameters in the layer, which are generated lazily so we have to put it in a <code>list</code> to force it to generate them:</p>
<div id="cell-33" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:30.832811Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:30.832418Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:30.837480Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:30.836347Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:30.832782Z&quot;}}" data-trusted="true" data-execution_count="48">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>llp <span class="op">=</span> <span class="bu">list</span>(ll.parameters())[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:31.461182Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:31.460795Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:31.467710Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:31.466582Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:31.461152Z&quot;}}" data-trusted="true" data-execution_count="49">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>llp.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>torch.Size([10, 512])</code></pre>
</div>
</div>
<p>The last layer parameters (<code>llp</code>) is a matrix which is 10 x 512. We’re getting 512 inputs, and when we multiply them by this matrix we get 10 outputs.</p>
<p>If we removed this layer, the last layer would be taking in 1536 features and spitting out 512 features:</p>
<pre><code>(4): Linear(in_features=1536, out_features=512, bias=False)</code></pre>
<p>We’ll delete it, and then take those 512 features and create two linear layers for them, one with 10 outputs as before (for disease classification) and one with 10 outputs for variety classification (there are 10 varieties). The final output would be 2 x 10 for each image—one with probabilities for disease classes, and one for variety classes.</p>
<p>Let’s do the easy thing first which is to delete the layer we don’t want. A PyTorch <code>Sequential</code> takes the output of each layer and passes it as the input to the next layer. If we delete the last layer, that’s no problem, it just won’t ever call it. PyTorch’s <code>Sequential</code> has normal <code>list</code> semantics so you can delete a layer like so:</p>
<div id="cell-37" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:34.773714Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:34.773347Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:34.778293Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:34.777305Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:34.773688Z&quot;}}" data-trusted="true" data-execution_count="50">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(h[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T01:33:35.649774Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T01:33:35.648932Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T01:33:35.658802Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T01:33:35.657879Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T01:33:35.649731Z&quot;}}" data-trusted="true" data-execution_count="51">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): fastai.layers.Flatten(full=False)
  (2): BatchNorm1d(1536, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=1536, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
)</code></pre>
</div>
</div>
<p>We’re going to create a <code>class</code> which includes this model and adds the final two layers:</p>
<div id="cell-40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:09:37.177266Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:09:37.176415Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:09:37.181962Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:09:37.180924Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:09:37.177223Z&quot;}}" data-trusted="true" data-execution_count="72">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:29:20.877104Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:29:20.876755Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:29:25.340439Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:29:25.339421Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:29:20.877078Z&quot;}}" data-trusted="true" data-execution_count="94">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    trn_path, seed<span class="op">=</span><span class="dv">42</span>, valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>), batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>learn2 <span class="op">=</span> deepcopy(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:29:28.977847Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:29:28.977480Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:29:28.984876Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:29:28.983835Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:29:28.977819Z&quot;}}" data-trusted="true" data-execution_count="95">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DiseaseAndTypeClassifier(nn.Module):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the constructor</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, m):</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>() <span class="co"># always call the superclass init to construct the object</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.l1 <span class="op">=</span> nn.Linear(<span class="dv">512</span>, <span class="dv">10</span>, bias<span class="op">=</span><span class="va">False</span>) <span class="co"># variety</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.l2 <span class="op">=</span> nn.Linear(<span class="dv">512</span>, <span class="dv">10</span>, bias<span class="op">=</span><span class="va">False</span>) <span class="co"># disease</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span>(m[<span class="dv">1</span>][<span class="op">-</span><span class="dv">1</span>]) <span class="co"># delete the last layer of the model's head</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.m <span class="op">=</span> m <span class="co"># model</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.m(x)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> <span class="va">self</span>.l1(x) <span class="co"># variety output</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> <span class="va">self</span>.l2(x) <span class="co"># disease output</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x1, x2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-43" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:29:32.847709Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:29:32.847329Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:29:32.853675Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:29:32.852731Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:29:32.847679Z&quot;}}" data-trusted="true" data-execution_count="96">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dtc <span class="op">=</span> DiseaseAndTypeClassifier(learn2.model)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>learn2.model <span class="op">=</span> dtc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When calling <code>get_preds</code> even though <code>with_loss=False</code> the <code>Learner</code> is still needing to use the loss function for something. So, we’ll write the new loss function. The loss function is the thing which is a number which says how good is this model. The loss function that we were using was designed on something that only returned a single tensor. And now we’re returning a tuple of tensors (<code>x1, x2</code>). So that’s why when it tries to call the loss function, it gets confused.</p>
<p>The loss function is another thing that is stored inside the <code>Learner</code>.</p>
<div id="cell-45" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:29:36.191717Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:29:36.191338Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:29:36.198093Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:29:36.196970Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:29:36.191687Z&quot;}}" data-trusted="true" data-execution_count="97">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>learn.loss_func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>FlattenedLoss of CrossEntropyLoss()</code></pre>
</div>
</div>
<p>In the initial new loss function, we’ll just return the loss for the disease predictions using the current loss function. We don’t have to split the <code>targs</code> yet because currently they hold just the disease targets. We’re going to have to change our data loading as well to include the rice variety as well.</p>
<p>Why is the loss function determined from the dataset? (As seen in the <code>Learner</code> source code).</p>
<p>Generally speaking, what is the appropriate loss function to use as a reasonable default depends on what kind of data you have. So if you’re data is a single continuous output you probably have a regression problem so you probably want mean squared error. If it’s a single categorical variable you probably want cross entropy loss. If you have a mult-categorical variable you probably want log loss without softmax. And so forth. By having it come from the dataset means that you can get sensible defaults that ought to work for that dataset. That’s why we generally don’t have to specify what loss function to use unless we’re doing something non-standard.</p>
<div id="cell-48" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:29:39.475292Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:29:39.474173Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:29:39.481186Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:29:39.480249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:29:39.475250Z&quot;}}" data-trusted="true" data-execution_count="98">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>curr_loss <span class="op">=</span> learn2.loss_func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:01.901286Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:01.900906Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:01.906409Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:01.905107Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:01.901258Z&quot;}}" data-trusted="true" data-execution_count="100">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dtc_loss(preds, targs):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    rice_preds, dis_preds <span class="op">=</span> preds</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> curr_loss(dis_preds, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:03.373003Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:03.372556Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:03.378172Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:03.377044Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:03.372970Z&quot;}}" data-trusted="true" data-execution_count="101">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dtc_error(preds, targs):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    rice_preds, dis_preds <span class="op">=</span> preds</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> error_rate(dis_preds, targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:06.885383Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:06.884976Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:06.890418Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:06.889251Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:06.885351Z&quot;}}" data-trusted="true" data-execution_count="102">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>learn2.loss_func <span class="op">=</span> dtc_loss</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>learn2.metrics <span class="op">=</span> [dtc_error]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-52" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:09.414015Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:09.412988Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:09.420051Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:09.419008Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:09.413980Z&quot;}}" data-trusted="true" data-execution_count="103">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>learn2.loss_func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>&lt;function __main__.dtc_loss(preds, targs)&gt;</code></pre>
</div>
</div>
<div id="cell-53" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:10.970037Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:10.969065Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:10.976683Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:10.975618Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:10.969994Z&quot;}}" data-trusted="true" data-execution_count="104">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>learn2.metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>(#1) [&lt;fastai.learner.AvgMetric object at 0x78339534eb00&gt;]</code></pre>
</div>
</div>
<p>At this point we should be able to get some predictions to verify that the plumbing is working.</p>
<div id="cell-55" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:15.785118Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:15.784329Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:25.346664Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:25.345415Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:15.785085Z&quot;}}" data-trusted="true" data-execution_count="105">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn2.get_preds(dl<span class="op">=</span>learn2.dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>We’ve now got two sets of preditions, variety, and disease.</p>
<div id="cell-57" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:29.142952Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:29.141861Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:29.150021Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:29.149107Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:29.142903Z&quot;}}" data-trusted="true" data-execution_count="106">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>2</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:29.826844Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:29.825843Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:29.836651Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:29.835321Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:29.826801Z&quot;}}" data-trusted="true" data-execution_count="107">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>(tensor([[ 1.4707,  1.5254, -1.5469,  ...,  3.5859, -9.7422, -7.9531],
         [ 2.8262, -0.3391, -1.0713,  ...,  3.9258, -6.7891, -5.5508],
         [ 1.2178,  0.2090, -1.3574,  ...,  2.4629, -6.9688, -6.0234],
         ...,
         [ 1.2422,  0.5278, -0.7520,  ...,  1.9199, -7.2109, -6.4258],
         [ 2.9219, -0.2183, -1.1211,  ...,  1.8584, -6.8516, -6.2461],
         [ 2.0469,  0.6406, -1.3174,  ...,  3.8027, -9.2891, -5.8086]],
        dtype=torch.float16),
 tensor([[ 2.8516, -2.9395, -3.2852,  ...,  1.3027, -1.5234, -2.8223],
         [ 3.4375, -1.3428, -3.8047,  ..., -0.9033, -0.5435, -3.0449],
         [ 4.1719, -1.0127, -2.9375,  ..., -0.5962,  0.7446, -3.3828],
         ...,
         [ 3.5781, -1.2656, -2.3008,  ..., -0.3660, -0.0957, -4.2734],
         [ 4.9727, -0.4153, -2.6562,  ...,  0.9844,  0.7559, -3.6738],
         [ 6.0703, -1.4375, -3.6797,  ..., -1.5928,  2.6211, -5.0625]],
        dtype=torch.float16))</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:32.390768Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:32.389787Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:32.398209Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:32.397169Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:32.390724Z&quot;}}" data-trusted="true" data-execution_count="108">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>rice_preds, dis_preds <span class="op">=</span> preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:30:33.192863Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:30:33.192496Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:30:33.199302Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:30:33.198407Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:30:33.192836Z&quot;}}" data-trusted="true" data-execution_count="109">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dis_preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>torch.Size([2081, 10])</code></pre>
</div>
</div>
<p>Initially, Jeremy got some errors when running <code>learn2.get_preds(dl=learn2.dls.valid)</code>. To debug them, he first tried to get a minimum reproducible example—not changing <code>learn.model</code> to <code>dtc</code>. This still threw an error. Then, instead of running <code>learn2 = copy(learn)</code> he assigned to <code>learn2</code> the line <code>vision_learner(dls, arch, metrics=error_rate)</code>.</p>
<p>That didn’t solve the problem either. Something was keeping some part of the <code>Learner</code>’s state in half-precision. Finally, Jeremy tried restarting the kernel. That solved the problem, and the <code>get_preds</code> call was successful.</p>
<p>He also got an error because the metrics function was trying to calculate on a tuple of preds, so in order to test just the new loss function at first, we removed the metrics from the <code>Learner</code>.</p>
<p>We should be able to replicate our disease clasification model at this point because we’re not doing anything with the extra rice type (variety).</p>
<div id="cell-64" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:33:16.302240Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:33:16.301317Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:33:16.307262Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:33:16.306166Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:33:16.302174Z&quot;}}" data-trusted="true" data-execution_count="111">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>learn2.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:33:18.961071Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:33:18.960379Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:33:52.629400Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:33:52.628411Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:33:18.961039Z&quot;}}" data-trusted="true" data-execution_count="112">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>learn2.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>SuggestedLRs(valley=0.0063095735386013985)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-41-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The valley (0.01) is pretty conservative so Jeremy recommends picking a learning rate further down the curve (0.1) which seems more reasonable. Look for a learning rate that’s as far to the right as possible but on a still pretty steep gradient.</p>
<div id="cell-67" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-01-23T02:42:07.398441Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-23T02:42:07.397523Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-23T02:43:49.627167Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-23T02:43:49.626170Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-23T02:42:07.398403Z&quot;}}" data-trusted="true" data-execution_count="114">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>learn2.fine_tune(<span class="dv">1</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">dtc_error</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.070556</td>
<td>1.182892</td>
<td>0.401249</td>
<td>00:47</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">dtc_error</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.211720</td>
<td>0.858449</td>
<td>0.259491</td>
<td>00:54</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In my <a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-6/">next blog post</a> I walk through the discussion and code from Live Coding 13, the last Live Coding video on the Paddy Doctor Kaggle competition.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vishalbakshi\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>