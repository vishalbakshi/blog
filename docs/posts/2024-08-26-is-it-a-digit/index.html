<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-08-26">
<meta name="description" content="In this notebook, I train a model on noisy MNIST images and deploy it in a HuggingFace Space. The model is then used to predict the probability that a user-drawn figure on a canvas is a digit.">

<title>vishal bakshi - Is it a Digit?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">vishal bakshi</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#generate-synthetic-data" id="toc-generate-synthetic-data" class="nav-link" data-scroll-target="#generate-synthetic-data">Generate Synthetic Data</a>
  <ul class="collapse">
  <li><a href="#loading-existing-mnist-data" id="toc-loading-existing-mnist-data" class="nav-link" data-scroll-target="#loading-existing-mnist-data">Loading Existing MNIST Data</a></li>
  <li><a href="#adding-and-subtracting-varying-levels-of-noise" id="toc-adding-and-subtracting-varying-levels-of-noise" class="nav-link" data-scroll-target="#adding-and-subtracting-varying-levels-of-noise">Adding and Subtracting Varying Levels of Noise</a></li>
  </ul></li>
  <li><a href="#training-an-image-regressor" id="toc-training-an-image-regressor" class="nav-link" data-scroll-target="#training-an-image-regressor">Training an Image Regressor</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  <li><a href="#production-environment-results" id="toc-production-environment-results" class="nav-link" data-scroll-target="#production-environment-results">Production Environment Results</a></li>
  <li><a href="#training-on-a-different-dataset" id="toc-training-on-a-different-dataset" class="nav-link" data-scroll-target="#training-on-a-different-dataset">Training on a Different Dataset</a></li>
  <li><a href="#training-the-new-model" id="toc-training-the-new-model" class="nav-link" data-scroll-target="#training-the-new-model">Training the New Model</a></li>
  <li><a href="#inference-1" id="toc-inference-1" class="nav-link" data-scroll-target="#inference-1">Inference</a></li>
  <li><a href="#production-environment-results-1" id="toc-production-environment-results-1" class="nav-link" data-scroll-target="#production-environment-results-1">Production Environment Results</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Is it a Digit?</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">computer vision</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook, I train a model on noisy MNIST images and deploy it in a HuggingFace Space. The model is then used to predict the probability that a user-drawn figure on a canvas is a digit.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 26, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the <a href="https://youtu.be/_7rMfsA24Ls?feature=shared&amp;t=2772">second half of the fastai Lesson 9 video</a>, Jeremy introduces the idea of a “magic API” that predicts the probability an image is a handwritten digit—where clearer images result in higher probabilities and noisier ones yield lower scores.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="A magic API which predicts the probability that the input image is a handwritten digit"><img src="1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">A magic API which predicts the probability that the input image is a handwritten digit</figcaption><p></p>
</figure>
</div>
<p>Inspired by this, I set out to build a neural network that predicts the probability an image is a handwritten digit. But I wanted to go a step further and bring abstract ideas into something tangible, so I designed a <a href="https://huggingface.co/spaces/vishalbakshi/isitadigit">HuggingFace Space</a> where users can interactively explore how this probability shifts as they draw. The Space connects to an <a href="https://huggingface.co/spaces/vishalbakshi/isitadigit-inference/blob/main/app.py">inference endpoint</a> hosting the model trained in this notebook. As you sketch on the canvas, the app dynamically sends the image to the endpoint, processes it through the model, and displays the predicted probability beneath the drawing.</p>
<p>The frontend for this project came together thanks to Claude-3.5 Sonnet, which generated most of the code. The initial proof-of-concept is available on <a href="https://codepen.io/vishalbakshi/full/eYweKrN">this Codepen</a>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:08:32.392055Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:08:32.391251Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:08:39.062408Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:08:39.061648Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:08:32.392009Z&quot;}" data-trusted="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generate-synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="generate-synthetic-data">Generate Synthetic Data</h2>
<p>The MNIST dataset contains images of handwritten digits. This alone is not sufficient for my training objective. I’ll add varying levels of noise to the MNIST images—these will be my inputs. The outputs will be 1 minus the amount of noise (which I’ll limit to the range <code>0.0</code> to <code>1.0</code>).</p>
<p>I want images where there is a lot of noise (black pixels) in addition to the black-pixel digit (on a white background). I also want images where some of the black pixels from the digit are removed. Both of these are approximately the kinds of images seen by my model in my <strong>Is it a digit?</strong> app.</p>
<section id="loading-existing-mnist-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-existing-mnist-data">Loading Existing MNIST Data</h3>
<p>I’ll start by loading the original MNIST dataset and preparing the training and validation set tensors.</p>
<p>::: {.cell _cell_guid=‘b1076dfc-b9ad-4769-8c92-a6c4dae69d19’ _uuid=‘8f2839f25d086af736a60e9eeb907d3b93b6e0e5’ execution=‘{“iopub.execute_input”:“2024-08-21T23:32:46.055506Z”,“iopub.status.busy”:“2024-08-21T23:32:46.055033Z”,“iopub.status.idle”:“2024-08-21T23:33:08.283155Z”,“shell.execute_reply”:“2024-08-21T23:33:08.281943Z”,“shell.execute_reply.started”:“2024-08-21T23:32:46.055473Z”}’ trusted=‘true’ execution_count=2}</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.MNIST)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="15687680" class="" max="15683414" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.03% [15687680/15683414 00:02&lt;00:00]
    </div>
    
</div>
<p>:::</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:35:55.657908Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:35:55.657442Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:35:55.667701Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:35:55.666354Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:35:55.657870Z&quot;}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#2) [Path('/root/.fastai/data/mnist_png/testing'),Path('/root/.fastai/data/mnist_png/training')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:35:56.672304Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:35:56.671826Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:35:57.090602Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:35:57.089465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:35:56.672268Z&quot;}" data-trusted="true" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>training_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> path <span class="kw">in</span> (path<span class="op">/</span><span class="st">'training'</span>).ls().<span class="bu">sorted</span>() <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> path.ls()]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>validation_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> path <span class="kw">in</span> (path<span class="op">/</span><span class="st">'testing'</span>).ls().<span class="bu">sorted</span>() <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> path.ls()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:00.326053Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:00.325570Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:00.333555Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:00.332406Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:00.326017Z&quot;}" data-trusted="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(training_files), <span class="bu">len</span>(validation_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:00.816663Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:00.816264Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:20.616104Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:20.614749Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:00.816632Z&quot;}" data-trusted="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> training_files]).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>train_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>torch.Size([60000, 28, 28])</code></pre>
</div>
</div>
<p>I want black pixels to represent the digit and white pixels to be the background so I’ll invert the data.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:22.506147Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:22.505659Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:22.610391Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:22.609007Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:22.506110Z&quot;}" data-trusted="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> train_x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:23.722636Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:23.722224Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:27.032937Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:27.031644Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:23.722606Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> torch.stack([tensor(Image.<span class="bu">open</span>(o)) <span class="cf">for</span> o <span class="kw">in</span> validation_files]).<span class="bu">float</span>()<span class="op">/</span><span class="dv">255</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>valid_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>torch.Size([10000, 28, 28])</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:27.036188Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:27.035339Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:27.049955Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:27.048191Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:27.036153Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> valid_x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:28.182812Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:28.182292Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:28.264186Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:28.262636Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:28.182774Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a zero</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>show_image(train_x[<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-11-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:36:29.297333Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:36:29.296292Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:36:29.358369Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:36:29.356779Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:36:29.297294Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this should be a nine</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>show_image(valid_x[<span class="op">-</span><span class="dv">1</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-12-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-and-subtracting-varying-levels-of-noise" class="level3">
<h3 class="anchored" data-anchor-id="adding-and-subtracting-varying-levels-of-noise">Adding and Subtracting Varying Levels of Noise</h3>
<p>I’ll start by showing an example of Gaussian (Normal) noise.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T22:05:01.075702Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T22:05:01.074792Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T22:05:01.238596Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T22:05:01.237601Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T22:05:01.075669Z&quot;}" data-trusted="true" data-execution_count="73">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a binary noise image (1 for white, 0 for black)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>plt.imshow(noise, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"28x28 Binary Noise Image"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>) </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Next I’ll add some noise to a handwritten digit and print out the “probability” (<code>1 - noise_threshold</code>) that it’s a digit:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T22:31:53.817151Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T22:31:53.816301Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T22:31:53.975275Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T22:31:53.974077Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T22:31:53.817111Z&quot;}" data-trusted="true" data-execution_count="133">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a binary noise image (1 for white, 0 for black)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">min</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span><span class="dv">1</span> <span class="op">-</span> noise_threshold<span class="sc">}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T22:32:25.097118Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T22:32:25.096273Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T22:32:25.269144Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T22:32:25.267941Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T22:32:25.097077Z&quot;}" data-trusted="true" data-execution_count="134">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a binary noise image (1 for white, 0 for black)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>()</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">min</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span><span class="dv">1</span> <span class="op">-</span> noise_threshold<span class="sc">}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T22:51:48.150955Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T22:51:48.149871Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T22:51:48.341797Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T22:51:48.340826Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T22:51:48.150908Z&quot;}" data-trusted="true" data-execution_count="237">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> torch.rand(<span class="dv">1</span>).<span class="bu">abs</span>()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>() </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">min</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span><span class="dv">1</span> <span class="op">-</span> noise_threshold<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I’ll also generate images where pixels of the digit are taken away.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T22:52:05.041783Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T22:52:05.041265Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T22:52:05.208715Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T22:52:05.207496Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T22:52:05.041751Z&quot;}" data-trusted="true" data-execution_count="242">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> torch.rand(<span class="dv">1</span>).<span class="bu">abs</span>()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>() </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">max</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span>noise_threshold<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T23:00:22.857668Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T23:00:22.857304Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T23:00:23.018135Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T23:00:23.014594Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T23:00:22.857637Z&quot;}" data-trusted="true" data-execution_count="251">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> torch.rand(<span class="dv">1</span>).<span class="bu">abs</span>()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>() </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">max</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span>noise_threshold<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-18-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-20T23:00:46.491647Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-20T23:00:46.490872Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-20T23:00:46.590791Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-20T23:00:46.589672Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-20T23:00:46.491613Z&quot;}" data-trusted="true" data-execution_count="259">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>noise_threshold <span class="op">=</span> torch.rand(<span class="dv">1</span>).<span class="bu">abs</span>()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> (torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>() </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">max</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span>noise_threshold<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I’ll create 140,000 different <code>noise</code> images. I’ll take 70k of those and “add” them to the 60k MNIST training image and 10k validation images and store <code>1 - noise_threshold</code> as the target. For the other 70k, I’ll “subtract” them from the 60k training digits 10k validation digits and store <code>noise_threshold</code> as the target. In total, I’ll have 120k training and 20k validation images that I can use to train the full spectrum of noise (additive and subtractive).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:42:57.211514Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:42:57.211042Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:43:02.457759Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:43:02.456409Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:42:57.211476Z&quot;}" data-trusted="true" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>noise_imgs <span class="op">=</span> []</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>noise_thresholds <span class="op">=</span> []</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">140_000</span>):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    noise_threshold <span class="op">=</span> torch.rand(<span class="dv">1</span>).<span class="bu">abs</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    noise_imgs.append((torch.rand(<span class="dv">28</span>, <span class="dv">28</span>) <span class="op">&gt;=</span> noise_threshold).<span class="bu">float</span>())</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    noise_thresholds.append(noise_threshold)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:47:21.613204Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:47:21.612773Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:47:22.370510Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:47:22.369372Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:47:21.613170Z&quot;}" data-trusted="true" data-execution_count="23">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>noise_t <span class="op">=</span> torch.stack(noise_imgs)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>thresh_t <span class="op">=</span> tensor(noise_thresholds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s make sure the noise and thresholds look okay:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:47:35.260643Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:47:35.260133Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:47:35.433237Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:47:35.432269Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:47:35.260603Z&quot;}" data-trusted="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> noise_t[<span class="dv">0</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>thresh <span class="op">=</span> thresh_t[<span class="dv">0</span>]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the inverted digit with noise using element-wise minimum</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>noisy_image <span class="op">=</span> torch.<span class="bu">min</span>(train_x[<span class="dv">0</span>], noise)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(noisy_image, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"p = </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>thresh<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-22-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Now, I’ll create my new training and validation sets:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:51:53.892903Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:51:53.892438Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:51:53.902265Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:51:53.900614Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:51:53.892868Z&quot;}" data-trusted="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>noise_t.shape, train_x.shape, valid_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(torch.Size([140000, 28, 28]),
 torch.Size([60000, 28, 28]),
 torch.Size([10000, 28, 28]))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:53:26.488671Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:53:26.488224Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:53:27.117107Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:53:27.115750Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:53:26.488637Z&quot;}" data-trusted="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>noise_train_min <span class="op">=</span> noise_t[:<span class="dv">60000</span>]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>noise_valid_min <span class="op">=</span> noise_t[<span class="dv">60000</span>:<span class="dv">70000</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>noise_train_max <span class="op">=</span> noise_t[<span class="dv">70000</span>:<span class="dv">130000</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>noise_valid_max <span class="op">=</span> noise_t[<span class="dv">130000</span>:]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># additive noise</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>result_train_min <span class="op">=</span> torch.<span class="bu">min</span>(train_x, noise_train_min)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>result_valid_min <span class="op">=</span> torch.<span class="bu">min</span>(valid_x, noise_valid_min)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># subtractive noise</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>result_train_max <span class="op">=</span> torch.<span class="bu">max</span>(train_x, noise_train_max)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>result_valid_max <span class="op">=</span> torch.<span class="bu">max</span>(valid_x, noise_valid_max)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># concatenate to create training and validation sets</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>noise_valid <span class="op">=</span> torch.cat([result_valid_min, result_valid_max])</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>noise_train <span class="op">=</span> torch.cat([result_train_min, result_train_max])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:57:14.826723Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:57:14.825616Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:57:14.835198Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:57:14.834241Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:57:14.826673Z&quot;}" data-trusted="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># additive thresholds</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>thresh_train_min <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> thresh_t[:<span class="dv">60000</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>thresh_valid_min <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> thresh_t[<span class="dv">60000</span>:<span class="dv">70000</span>]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># subtractive thresholds</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>thresh_train_max <span class="op">=</span> thresh_t[<span class="dv">70000</span>:<span class="dv">130000</span>]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>thresh_valid_max <span class="op">=</span> thresh_t[<span class="dv">130000</span>:]</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># concatenate to get training and validation targets</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>thresh_valid <span class="op">=</span> torch.cat([thresh_valid_min, thresh_valid_max])</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>thresh_train <span class="op">=</span> torch.cat([thresh_train_min, thresh_train_max])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, I’ll spot-check a few training and validation set inputs and targets:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:17:42.740436Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:17:42.739824Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:17:42.745366Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:17:42.744428Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:17:42.740405Z&quot;}" data-trusted="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_noise(img, thresh):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img, cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"p = </span><span class="sc">{</span>thresh<span class="sc">.</span>item()<span class="sc">:.2f}</span><span class="ss"> that it's a digit"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:58:51.053152Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:58:51.052314Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:58:51.235177Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:58:51.233536Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:58:51.053111Z&quot;}" data-trusted="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>plot_noise(noise_train[<span class="dv">0</span>], thresh_train[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-27-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-21T23:59:32.613688Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-21T23:59:32.613259Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-21T23:59:32.795884Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-21T23:59:32.794771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-21T23:59:32.613639Z&quot;}" data-trusted="true" data-execution_count="30">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plot_noise(noise_train[<span class="op">-</span><span class="dv">1</span>], thresh_train[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-28-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="index_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-22T00:01:40.227042Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-22T00:01:40.226511Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-22T00:01:40.418024Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-22T00:01:40.416817Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-22T00:01:40.226976Z&quot;}" data-trusted="true" data-execution_count="33">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>plot_noise(noise_valid[<span class="dv">10</span>], thresh_valid[<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-29-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="index_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-22T00:01:48.207866Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-22T00:01:48.207338Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-22T00:01:48.387137Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-22T00:01:48.385949Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-22T00:01:48.207820Z&quot;}" data-trusted="true" data-execution_count="34">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plot_noise(noise_valid[<span class="op">-</span><span class="dv">10</span>], thresh_valid[<span class="op">-</span><span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-30-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="index_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="training-an-image-regressor" class="level2">
<h2 class="anchored" data-anchor-id="training-an-image-regressor">Training an Image Regressor</h2>
<p>Now that I have my noisy inputs (and corresponding “probability” targets) I can start training models! I’ll start by training a ResNet34 to get a sense of the baseline MSE. I got a major assist from both Claude and ChatGPT to build the appropriate <code>DataBlock</code> (and getters <code>get_items</code>, <code>get_x</code> and <code>get_y</code>) based on how my data is sources (4 NumPy arrays).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:08:51.574454Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:08:51.574095Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:08:54.709287Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:08:54.708300Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:08:51.574425Z&quot;}" data-trusted="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'/kaggle/input/noisy-mnist'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>train_noise <span class="op">=</span> np.load(path<span class="op">/</span><span class="st">'noise_train.npy'</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>train_thresh <span class="op">=</span> np.load(path<span class="op">/</span><span class="st">'thresh_train.npy'</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>valid_noise <span class="op">=</span> np.load(path<span class="op">/</span><span class="st">'noise_valid.npy'</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>valid_thresh <span class="op">=</span> np.load(path<span class="op">/</span><span class="st">'thresh_valid.npy'</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine train and valid data</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>all_noise <span class="op">=</span> np.concatenate([train_noise, valid_noise])</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>all_thresh <span class="op">=</span> np.concatenate([train_thresh, valid_thresh])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:05:57.893218Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:05:57.892553Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:05:58.088212Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:05:58.087217Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:05:57.893182Z&quot;}" data-trusted="true" data-execution_count="64">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>all_noise <span class="op">=</span> (all_noise <span class="op">*</span> <span class="dv">255</span>).astype(np.uint8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:06:15.235658Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:06:15.235223Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:06:15.421222Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:06:15.420228Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:06:15.235623Z&quot;}" data-trusted="true" data-execution_count="65">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>plot_noise(all_noise[<span class="dv">0</span>], all_thresh[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-33-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="index_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:39:58.738336Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:39:58.737974Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:39:58.744884Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:39:58.743847Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:39:58.738306Z&quot;}" data-trusted="true" data-execution_count="122">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_x(i):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert NumPy array to a single-channel PIL image with inverted colors</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PILImageBW.create(all_noise[i])</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(i):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_thresh[i].astype(np.float32)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_items(_):</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">range</span>(<span class="bu">len</span>(all_noise))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:40:00.386488Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:40:00.385559Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:40:00.395748Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:40:00.394847Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:40:00.386447Z&quot;}" data-trusted="true" data-execution_count="123">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create valid_idx for IndexSplitter</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>valid_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(train_noise), <span class="bu">len</span>(all_noise)))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(valid_idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>20000</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:40:01.978343Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:40:01.977990Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:40:01.984111Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:40:01.982979Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:40:01.978316Z&quot;}" data-trusted="true" data-execution_count="124">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock(PILImageBW), RegressionBlock),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_items,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>get_x,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_y,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>IndexSplitter(valid_idx),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span><span class="va">None</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:40:07.399540Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:40:07.399177Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:40:07.780749Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:40:07.779772Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:40:07.399511Z&quot;}" data-trusted="true" data-execution_count="125">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(all_noise, bs<span class="op">=</span><span class="dv">1024</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:40:09.306841Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:40:09.306467Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:40:10.705109Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:40:10.704029Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:40:09.306813Z&quot;}" data-trusted="true" data-execution_count="126">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dblock.summary(all_noise)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting-up type transforms pipelines
Collecting items from [[[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [  0 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255   0 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[  0   0 255 ...   0   0   0]
  [255   0 255 ... 255   0   0]
  [255   0   0 ... 255   0 255]
  ...
  [255   0   0 ...   0   0   0]
  [255   0   0 ... 255   0   0]
  [  0   0   0 ...   0   0 255]]

 [[  0   0   0 ...   0   0   0]
  [255   0 255 ... 255   0   0]
  [  0   0 255 ...   0   0   0]
  ...
  [  0   0 255 ... 255   0   0]
  [  0   0   0 ...   0   0   0]
  [  0   0   0 ... 255   0   0]]

 ...

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]]
Found 140000 items
2 datasets of sizes 120000,20000
Setting up Pipeline: get_x -&gt; PILBase.create
Setting up Pipeline: get_y -&gt; RegressionSetup -- {'c': None}

Building one sample
  Pipeline: get_x -&gt; PILBase.create
    starting from
      0
    applying get_x gives
      PILImageBW mode=L size=28x28
    applying PILBase.create gives
      PILImageBW mode=L size=28x28
  Pipeline: get_y -&gt; RegressionSetup -- {'c': None}
    starting from
      0
    applying get_y gives
      0.95005137
    applying RegressionSetup -- {'c': None} gives
      tensor(0.9501)

Final sample: (PILImageBW mode=L size=28x28, tensor(0.9501))


Collecting items from [[[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [  0 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255   0 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[  0   0 255 ...   0   0   0]
  [255   0 255 ... 255   0   0]
  [255   0   0 ... 255   0 255]
  ...
  [255   0   0 ...   0   0   0]
  [255   0   0 ... 255   0   0]
  [  0   0   0 ...   0   0 255]]

 [[  0   0   0 ...   0   0   0]
  [255   0 255 ... 255   0   0]
  [  0   0 255 ...   0   0   0]
  ...
  [  0   0 255 ... 255   0   0]
  [  0   0   0 ...   0   0   0]
  [  0   0   0 ... 255   0   0]]

 ...

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]]
Found 140000 items
2 datasets of sizes 120000,20000
Setting up Pipeline: get_x -&gt; PILBase.create
Setting up Pipeline: get_y -&gt; RegressionSetup -- {'c': None}
Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}

Building one batch
Applying item_tfms to the first sample:
  Pipeline: ToTensor
    starting from
      (PILImageBW mode=L size=28x28, tensor(0.9501))
    applying ToTensor gives
      (TensorImageBW of size 1x28x28, tensor(0.9501))

Adding the next 3 samples

No before_batch transform to apply

Collating items in a batch

Applying batch_tfms to the batch built
  Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}
    starting from
      (TensorImageBW of size 4x1x28x28, tensor([0.9501, 0.2629, 0.1410, 0.6715], device='cuda:0'))
    applying IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} gives
      (TensorImageBW of size 4x1x28x28, tensor([0.9501, 0.2629, 0.1410, 0.6715], device='cuda:0'))</code></pre>
</div>
</div>
<p>I’m not sure why <code>dls.show_batch</code> is showing white digits on black backgrounds but I’m guessing it has to do with the colormap it’s using.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:40:42.129023Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:40:42.128265Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:40:43.759522Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:40:43.758612Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:40:42.128989Z&quot;}" data-trusted="true" data-execution_count="128">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-39-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="index_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>When I plot one of the batch items using <code>plt.imshow</code> with <code>cmap='gray'</code> I get the expected displayed result:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:41:02.831732Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:41:02.830902Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:41:03.838989Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:41:03.837766Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:41:02.831679Z&quot;}" data-trusted="true" data-execution_count="133">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls.one_batch()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>plot_noise(xb[<span class="dv">0</span>][<span class="dv">0</span>].cpu(), yb[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-40-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="index_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:41:39.508647Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:41:39.508277Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:41:39.752812Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:41:39.751765Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:41:39.508617Z&quot;}" data-trusted="true" data-execution_count="136">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(all_noise[<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-41-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="index_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:41:49.884967Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:41:49.884141Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:41:50.190283Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:41:50.189337Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:41:49.884925Z&quot;}" data-trusted="true" data-execution_count="138">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(xb[<span class="dv">0</span>][<span class="dv">0</span>].cpu(), cmap<span class="op">=</span><span class="st">'gray'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-42-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="index_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Great! Now onto training:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:41:56.014687Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:41:56.013734Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:44:22.020194Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:44:22.019146Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:41:56.014648Z&quot;}" data-trusted="true" data-execution_count="139">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>mse, metrics<span class="op">=</span>mse, n_in<span class="op">=</span><span class="dv">1</span>, n_out<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">1</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.395260</td>
      <td>0.016736</td>
      <td>0.016736</td>
      <td>01:08</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.018071</td>
      <td>0.007796</td>
      <td>0.007796</td>
      <td>01:17</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Given that the predictions are between <code>0.0</code> and <code>1.0</code>, the mean squared error of <code>0.008</code> is not bad! I’ll train for a few more epochs:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:45:06.008395Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:45:06.008011Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:52:42.981219Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:52:42.980182Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:45:06.008363Z&quot;}" data-trusted="true" data-execution_count="140">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>mse, metrics<span class="op">=</span>mse, n_in<span class="op">=</span><span class="dv">1</span>, n_out<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">5</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.451190</td>
      <td>0.015501</td>
      <td>0.015501</td>
      <td>01:09</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.018069</td>
      <td>0.010948</td>
      <td>0.010948</td>
      <td>01:16</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.011859</td>
      <td>0.005137</td>
      <td>0.005137</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.007378</td>
      <td>0.003288</td>
      <td>0.003288</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.005160</td>
      <td>0.002453</td>
      <td>0.002453</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.004174</td>
      <td>0.001957</td>
      <td>0.001957</td>
      <td>01:17</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:54:02.016202Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:54:02.015442Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:54:02.705118Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:54:02.704191Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:54:02.016157Z&quot;}" data-trusted="true" data-execution_count="143">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">'model.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>Glancing at the predictions on the validation set, the model is quite good at predicting the “probability” that an image is a handwritten digit!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:54:10.979604Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:54:10.979247Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:54:18.529699Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:54:18.528659Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:54:10.979575Z&quot;}" data-trusted="true" data-execution_count="144">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:54:27.730770Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:54:27.730357Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:54:27.741515Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:54:27.740480Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:54:27.730711Z&quot;}" data-trusted="true" data-execution_count="145">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>preds[:<span class="dv">10</span>], targs[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>(tensor([[0.3102],
         [0.3155],
         [0.3329],
         [0.8646],
         [0.1457],
         [0.9295],
         [0.5802],
         [0.0132],
         [0.3224],
         [0.7590]]),
 tensor([0.3085, 0.2647, 0.3427, 0.8443, 0.1768, 0.9317, 0.5976, 0.0090, 0.3992,
         0.7359]))</code></pre>
</div>
</div>
<p>I’ll make sure that I can get predictions on a single image tensor. The first time I trained a model, I got an error in <code>learn.predict</code> that the model expected 3 channels. This prompted me to set <code>n_in=1</code> when defining the <code>vision_learner</code>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:54:43.656468Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:54:43.656108Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:54:43.713001Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:54:43.712078Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:54:43.656439Z&quot;}" data-trusted="true" data-execution_count="146">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>learn<span class="sc">.</span>predict(all_noise[<span class="dv">0</span>])[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>0.94</code></pre>
</div>
</div>
<p>Next, I’ll test out the model on images it hasn’t seen before.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:04:48.727929Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:04:48.726930Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:04:48.733526Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:04:48.732460Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:04:48.727894Z&quot;}" data-trusted="true" data-execution_count="119">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_image_array(url):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download the image</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the content to an image</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> Image.<span class="bu">open</span>(BytesIO(response.content))</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> image.convert(<span class="st">"L"</span>)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resize the image to 28x28</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> image.resize((<span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the image to a numpy array</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    image_array <span class="op">=</span> np.array(image)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize the pixel values to [0, 1] and convert to a PyTorch tensor</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#image_tensor = torch.tensor(image_array, dtype=torch.float32) / 255.0</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_array</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:04:51.094026Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:04:51.093655Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:04:51.099563Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:04:51.098115Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:04:51.093996Z&quot;}" data-trusted="true" data-execution_count="120">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_image(url):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    image_array <span class="op">=</span> get_image_array(url)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Probability it's a digit: </span><span class="sc">{</span>learn<span class="sc">.</span>predict(image_array)[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    plt.imshow(image_array, cmap<span class="op">=</span><span class="st">'gray'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model correctly predicts a very high probability that this is an image of a digit (97%):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:54:56.671087Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:54:56.670688Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:54:59.015613Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:54:59.014447Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:54:56.671059Z&quot;}" data-trusted="true" data-execution_count="149">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1qNNgt4z-PPn8JKlQU5pFiRE1KCFnqb2R'</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.97</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-51-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="index_files/figure-html/cell-51-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Next I’ll use the model to predict the handwritten digit probability for an image that is clearly NOT a digit. The model correctly predicts a low probability:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:08.508885Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:08.508493Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:11.093317Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:11.091997Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:08.508856Z&quot;}" data-trusted="true" data-execution_count="150">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1LjJEMldL2CaWpYxRqv0Byrg0GqdOWGOO'</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.08</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-52-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="index_files/figure-html/cell-52-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>For another obviously not a digit, the model correctly predicts a very low probability:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:14.513637Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:14.513268Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:16.733684Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:16.732753Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:14.513607Z&quot;}" data-trusted="true" data-execution_count="151">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1OZjXvk74Lpv7teWJ4BY5-xGsjGhblpux'</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.05</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-53-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="index_files/figure-html/cell-53-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I’ll try more difficult images, starting with an easy image of <code>4</code>, and then three subsequent images with increasing amounts of noise. The model correctly predicts lower probabilities as more noise is introduced.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:20.161216Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:20.160821Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:22.653392Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:22.652372Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:20.161184Z&quot;}" data-trusted="true" data-execution_count="152">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=16rs0ARMoaUqUPmQIrMaVqtMiQvIIhT7n'</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.98</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-54-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="index_files/figure-html/cell-54-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:25.596598Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:25.595211Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:27.809530Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:27.808372Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:25.596543Z&quot;}" data-trusted="true" data-execution_count="153">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1UrUZRJpA2hLtTukQNQJdK8VDnL7Ap2xr'</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.96</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-55-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="index_files/figure-html/cell-55-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:29.118011Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:29.117294Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:31.787258Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:31.786310Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:29.117970Z&quot;}" data-trusted="true" data-execution_count="154">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1di1Pw6yaQlzi-JWOv2JGMuc69UKzlKYm'</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.94</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-56-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="index_files/figure-html/cell-56-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:55:33.618430Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:55:33.618045Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:55:36.615528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:55:36.614313Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:55:33.618401Z&quot;}" data-trusted="true" data-execution_count="155">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1opKjl3xJavdINgr7RhiP27JIUbFNto-h'</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.76</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-57-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="index_files/figure-html/cell-57-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The model is not perfect—it predicts the following blob with a probability of 85%. I would expect something lower. However, it’s indicative of the type of data it’s seen during training so something I can adjust in the training data.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:56:18.737963Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:56:18.737577Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:56:20.903264Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:56:20.902148Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:56:18.737933Z&quot;}" data-trusted="true" data-execution_count="157">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1JF6dTa38GIlO8FcVGoVQ69Pi0esZe3M1'</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.85</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-58-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28"><img src="index_files/figure-html/cell-58-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The model seems more sensitive to black pixels in the corners and sides—the probability that it’s a digit drops:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-23T18:56:24.877551Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-23T18:56:24.877194Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-23T18:56:27.060891Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-23T18:56:27.060056Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-23T18:56:24.877522Z&quot;}" data-trusted="true" data-execution_count="158">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1dft9riZGAL0aCxGO6LmuvNPP5RSGLrny'</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.72</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-59-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29"><img src="index_files/figure-html/cell-59-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I think this model is good enough for now. I’ll export it and utilize in <a href="https://huggingface.co/spaces/vishalbakshi/isitadigit">this Huggingface Space</a>.</p>
</section>
<section id="production-environment-results" class="level2">
<h2 class="anchored" data-anchor-id="production-environment-results">Production Environment Results</h2>
<p>Here are some examples of how this models fares in the <a href="https://huggingface.co/spaces/vishalbakshi/isitadigit">HuggingFace Space</a> “production” environment:</p>
<p>Enough randomly placed pixels leads the model to believe a handwritten digit is present. I sort of understand how it comes to this conclusion (based on the training data) and it’s not ideal. I would want this image to have a much lower probability.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/e9162f27-1-c3c8b7ea-c4d4-49d9-95b2-ead0570765a6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30" title="image.png"><img src="index_files/figure-html/e9162f27-1-c3c8b7ea-c4d4-49d9-95b2-ead0570765a6.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>It correctly gives the following images high (90%+) probability of being a handwritten digit (it particularly likes 6s):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/dd5c8205-1-87b6387d-1f9d-411d-af66-78c576e02fb2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31" title="image.png"><img src="index_files/figure-html/dd5c8205-1-87b6387d-1f9d-411d-af66-78c576e02fb2.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/79769049-1-d90d9b72-1e9a-4dae-a32f-2fde2f5b59b1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32" title="image.png"><img src="index_files/figure-html/79769049-1-d90d9b72-1e9a-4dae-a32f-2fde2f5b59b1.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>While I appreciate the model giving this <code>8</code> a high probability of being a handwritten digit, I need to clamp the predictions to between <code>0</code> and <code>1</code>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/ad0d8780-1-2a6e3ca0-fca4-492e-970c-2fec26618483.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33" title="image.png"><img src="index_files/figure-html/ad0d8780-1-2a6e3ca0-fca4-492e-970c-2fec26618483.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>The model incorrectly gives the following image a high probability:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/f5d349a5-1-4031b0a3-3d4c-4feb-8b94-904075fa432a.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34" title="image.png"><img src="index_files/figure-html/f5d349a5-1-4031b0a3-3d4c-4feb-8b94-904075fa432a.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>The model correctly gives the following image a relatively low probability:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/e555ed61-1-ee8ae637-45b3-4df4-af27-4ea6aec05abc.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35" title="image.png"><img src="index_files/figure-html/e555ed61-1-ee8ae637-45b3-4df4-af27-4ea6aec05abc.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
</section>
<section id="training-on-a-different-dataset" class="level2">
<h2 class="anchored" data-anchor-id="training-on-a-different-dataset">Training on a Different Dataset</h2>
<p>I want to try a different approach: what I train the model only on the data where pixels are “subtracted” from the digit?</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:14:07.326386Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:14:07.325954Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:14:07.332507Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:14:07.331531Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:14:07.326354Z&quot;}" data-trusted="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>train_noise.shape, valid_noise.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>((120000, 28, 28), (20000, 28, 28))</code></pre>
</div>
</div>
<p>The second half of each array (training and validation noise) are the “subtracted noise” images:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:16:26.078373Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:16:26.078040Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:16:26.085655Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:16:26.084648Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:16:26.078347Z&quot;}" data-trusted="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> train_noise[<span class="dv">60000</span>:]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>valid_x <span class="op">=</span> valid_noise[<span class="dv">10000</span>:]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>train_y <span class="op">=</span> train_thresh[<span class="dv">60000</span>:]</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>valid_y <span class="op">=</span> valid_thresh[<span class="dv">10000</span>:]</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>train_x.shape, train_y.shape, valid_x.shape, valid_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>((60000, 28, 28), (60000,), (10000, 28, 28), (10000,))</code></pre>
</div>
</div>
<p>I’ll spot-check a few images of the training and validation sets to make sure it contains only the “subtractive noise” data:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:17:55.094050Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:17:55.093684Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:17:55.346390Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:17:55.345448Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:17:55.094023Z&quot;}" data-trusted="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="dv">0</span>], train_y[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-62-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-36"><img src="index_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:18:03.672823Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:18:03.671835Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:18:03.837247Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:18:03.836294Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:18:03.672789Z&quot;}" data-trusted="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="op">-</span><span class="dv">1</span>], train_y[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-63-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-37"><img src="index_files/figure-html/cell-63-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:18:16.214650Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:18:16.213927Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:18:16.378663Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:18:16.377204Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:18:16.214598Z&quot;}" data-trusted="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="dv">30000</span>], train_y[<span class="dv">30000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-64-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38"><img src="index_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:18:30.929985Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:18:30.929348Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:18:31.095417Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:18:31.094515Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:18:30.929955Z&quot;}" data-trusted="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="dv">0</span>], valid_y[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-65-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-39"><img src="index_files/figure-html/cell-65-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:18:41.691956Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:18:41.691153Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:18:41.855364Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:18:41.854487Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:18:41.691925Z&quot;}" data-trusted="true" data-execution_count="15">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="op">-</span><span class="dv">1</span>], valid_y[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-66-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-40"><img src="index_files/figure-html/cell-66-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:18:49.841198Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:18:49.840211Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:18:50.016709Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:18:50.015718Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:18:49.841157Z&quot;}" data-trusted="true" data-execution_count="16">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="dv">5000</span>], valid_y[<span class="dv">5000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-67-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-41"><img src="index_files/figure-html/cell-67-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Next, I want to “penalize” noisy images that have a low probability (say &lt;=75%) and “favor” images with a high probability (&gt;=75%). I’ll create a <code>transform_threshold</code> function to achieve this. I prompted Claude to give me such a function and then modified the parameters to get the following result.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:42:47.189214Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:42:47.188854Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:42:47.446739Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:42:47.445697Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:42:47.189186Z&quot;}" data-trusted="true" data-execution_count="80">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_threshold(p):</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> tensor(p)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    k1, k2 <span class="op">=</span> <span class="fl">0.5</span>, <span class="dv">20</span> <span class="co"># Steepness parameters</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    mid1, mid2 <span class="op">=</span> <span class="fl">0.65</span>, <span class="fl">0.65</span>  <span class="co"># Midpoints</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> torch.sigmoid(k1 <span class="op">*</span> (p <span class="op">-</span> mid1))</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> torch.sigmoid(k2 <span class="op">*</span> (p <span class="op">-</span> mid2))</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p <span class="op">*</span> lower <span class="op">+</span> upper</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an array of 101 evenly spaced values from 0 to 1</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">101</span>)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the transform_threshold function to each value</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> transform_threshold(x)</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Transformed values'</span>)</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>plt.plot(x, x, <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'Original values (y=x)'</span>)</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Original probability'</span>)</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Transformed probability'</span>)</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Effect of transform_threshold function'</span>)</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>, adjustable<span class="op">=</span><span class="st">'box'</span>)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-68-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-42"><img src="index_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I’ll apply this transformation to the training and validation set target probabilities:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:42:51.454155Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:42:51.453775Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:42:51.460657Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:42:51.459717Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:42:51.454125Z&quot;}" data-trusted="true" data-execution_count="81">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>t_train_y <span class="op">=</span> transform_threshold(train_y)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>t_valid_y <span class="op">=</span> transform_threshold(valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:43:32.410933Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:43:32.410569Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:43:34.007407Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:43:34.006497Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:43:32.410904Z&quot;}" data-trusted="true" data-execution_count="85">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(train_y, t_train_y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-70-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-43"><img src="index_files/figure-html/cell-70-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:42:52.553331Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:42:52.552926Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:42:52.560638Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:42:52.559697Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:42:52.553299Z&quot;}" data-trusted="true" data-execution_count="82">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>train_y[<span class="dv">0</span>], t_train_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>(0.52439004, tensor(0.2915))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:42:55.040751Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:42:55.039865Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:42:55.201666Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:42:55.200363Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:42:55.040715Z&quot;}" data-trusted="true" data-execution_count="83">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="dv">0</span>], t_train_y[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-72-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-44"><img src="index_files/figure-html/cell-72-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:49:49.255351Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:49:49.254513Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:49:49.262199Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:49:49.261248Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:49:49.255322Z&quot;}" data-trusted="true" data-execution_count="93">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>train_y[<span class="op">-</span><span class="dv">1</span>], t_train_y[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>(0.3380698, tensor(0.1569))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:45:08.657096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:45:08.656346Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:45:08.821174Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:45:08.820411Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:45:08.657063Z&quot;}" data-trusted="true" data-execution_count="87">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="op">-</span><span class="dv">1</span>], t_train_y[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-74-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-45"><img src="index_files/figure-html/cell-74-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:50:05.411644Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:50:05.410820Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:50:05.418183Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:50:05.417350Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:50:05.411613Z&quot;}" data-trusted="true" data-execution_count="94">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>train_y[<span class="dv">10000</span>], t_train_y[<span class="dv">10000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(0.83755004, tensor(0.9269))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:45:20.814830Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:45:20.814487Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:45:20.946122Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:45:20.945124Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:45:20.814806Z&quot;}" data-trusted="true" data-execution_count="88">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>plot_noise(train_x[<span class="dv">10000</span>], t_train_y[<span class="dv">10000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-76-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-46"><img src="index_files/figure-html/cell-76-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:43:50.046121Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:43:50.045301Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:43:50.423376Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:43:50.422496Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:43:50.046088Z&quot;}" data-trusted="true" data-execution_count="86">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(valid_y, t_valid_y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-77-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47"><img src="index_files/figure-html/cell-77-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:50:17.167538Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:50:17.166883Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:50:17.174383Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:50:17.173436Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:50:17.167508Z&quot;}" data-trusted="true" data-execution_count="95">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>valid_y[<span class="dv">0</span>], t_valid_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>(0.23614848, tensor(0.1060))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:46:21.878712Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:46:21.878050Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:46:22.042811Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:46:22.041841Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:46:21.878681Z&quot;}" data-trusted="true" data-execution_count="89">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="dv">0</span>], t_valid_y[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-79-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48"><img src="index_files/figure-html/cell-79-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:50:26.967199Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:50:26.966306Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:50:26.973397Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:50:26.972510Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:50:26.967167Z&quot;}" data-trusted="true" data-execution_count="96">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>valid_y[<span class="op">-</span><span class="dv">1</span>], t_valid_y[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>(0.4010573, tensor(0.1915))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:46:30.567214Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:46:30.566371Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:46:30.732311Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:46:30.731457Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:46:30.567182Z&quot;}" data-trusted="true" data-execution_count="90">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="op">-</span><span class="dv">1</span>], t_valid_y[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-81-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-49"><img src="index_files/figure-html/cell-81-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:50:36.544247Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:50:36.543368Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:50:36.551997Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:50:36.550802Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:50:36.544213Z&quot;}" data-trusted="true" data-execution_count="97">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>valid_y[<span class="dv">5000</span>], t_valid_y[<span class="dv">5000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>(0.34754837, tensor(0.1618))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T00:46:51.284666Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T00:46:51.283852Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T00:46:51.455043Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T00:46:51.453829Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T00:46:51.284625Z&quot;}" data-trusted="true" data-execution_count="92">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>plot_noise(valid_x[<span class="dv">5000</span>], t_valid_y[<span class="dv">5000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-83-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-50"><img src="index_files/figure-html/cell-83-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Great! I have successfully penalized low-probability images. I would expect the model to favor more fully-formed digits, creating what I think is a better user experience for this app.</p>
</section>
<section id="training-the-new-model" class="level2">
<h2 class="anchored" data-anchor-id="training-the-new-model">Training the New Model</h2>
<p>I’ll reuse nearly all of the code from before.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:42:40.478042Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:42:40.477314Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:42:40.561824Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:42:40.560766Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:42:40.478011Z&quot;}" data-trusted="true" data-execution_count="131">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine train and valid data</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>all_noise <span class="op">=</span> np.concatenate([train_x, valid_x])</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>all_thresh <span class="op">=</span> np.concatenate([t_train_y, t_valid_y])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:42:41.034346Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:42:41.033426Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:42:41.127907Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:42:41.126894Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:42:41.034312Z&quot;}" data-trusted="true" data-execution_count="132">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>all_noise <span class="op">=</span> (all_noise <span class="op">*</span> <span class="dv">255</span>).astype(np.uint8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:42:41.842943Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:42:41.842240Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:42:41.849616Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:42:41.848655Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:42:41.842911Z&quot;}" data-trusted="true" data-execution_count="133">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>train_x.shape, valid_x.shape, all_noise.shape, t_train_y.shape, t_valid_y.shape, all_thresh.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>((60000, 28, 28),
 (10000, 28, 28),
 (70000, 28, 28),
 torch.Size([60000]),
 torch.Size([10000]),
 (70000,))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:01.490670Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:01.489725Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:01.496689Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:01.495484Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:01.490636Z&quot;}" data-trusted="true" data-execution_count="134">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_x(i):</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert NumPy array to a single-channel PIL image with inverted colors</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PILImageBW.create(all_noise[i])</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(i):</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_thresh[i].astype(np.float32)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_items(_):</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">range</span>(<span class="bu">len</span>(all_noise))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:02.537544Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:02.536660Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:02.545390Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:02.544271Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:02.537502Z&quot;}" data-trusted="true" data-execution_count="135">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create valid_idx for IndexSplitter</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>valid_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(train_x), <span class="bu">len</span>(all_noise)))</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(valid_idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>10000</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:05.432849Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:05.431861Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:05.439938Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:05.438687Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:05.432803Z&quot;}" data-trusted="true" data-execution_count="136">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock(PILImageBW), RegressionBlock),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_items,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>get_x,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_y,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>IndexSplitter(valid_idx),</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span><span class="va">None</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:10.138974Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:10.138608Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:10.841897Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:10.840964Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:10.138942Z&quot;}" data-trusted="true" data-execution_count="137">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>dblock.summary(all_noise)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting-up type transforms pipelines
Collecting items from [[[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 ...

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]]
Found 70000 items
2 datasets of sizes 60000,10000
Setting up Pipeline: get_x -&gt; PILBase.create
Setting up Pipeline: get_y -&gt; RegressionSetup -- {'c': None}

Building one sample
  Pipeline: get_x -&gt; PILBase.create
    starting from
      0
    applying get_x gives
      PILImageBW mode=L size=28x28
    applying PILBase.create gives
      PILImageBW mode=L size=28x28
  Pipeline: get_y -&gt; RegressionSetup -- {'c': None}
    starting from
      0
    applying get_y gives
      0.29146788
    applying RegressionSetup -- {'c': None} gives
      tensor(0.2915)

Final sample: (PILImageBW mode=L size=28x28, tensor(0.2915))


Collecting items from [[[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 ...

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]

 [[255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  ...
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]
  [255 255 255 ... 255 255 255]]]
Found 70000 items
2 datasets of sizes 60000,10000
Setting up Pipeline: get_x -&gt; PILBase.create
Setting up Pipeline: get_y -&gt; RegressionSetup -- {'c': None}
Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}

Building one batch
Applying item_tfms to the first sample:
  Pipeline: ToTensor
    starting from
      (PILImageBW mode=L size=28x28, tensor(0.2915))
    applying ToTensor gives
      (TensorImageBW of size 1x28x28, tensor(0.2915))

Adding the next 3 samples

No before_batch transform to apply

Collating items in a batch

Applying batch_tfms to the batch built
  Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1}
    starting from
      (TensorImageBW of size 4x1x28x28, tensor([0.2915, 1.0310, 0.1721, 0.1027], device='cuda:0'))
    applying IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} gives
      (TensorImageBW of size 4x1x28x28, tensor([0.2915, 1.0310, 0.1721, 0.1027], device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:22.865638Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:22.865257Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:23.078815Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:23.077888Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:22.865607Z&quot;}" data-trusted="true" data-execution_count="138">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(all_noise, bs<span class="op">=</span><span class="dv">1024</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:23.918735Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:23.918348Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:25.638115Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:25.637051Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:23.918706Z&quot;}" data-trusted="true" data-execution_count="139">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-92-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-51"><img src="index_files/figure-html/cell-92-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:31.100553Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:31.099715Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:43:32.055884Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:43:32.054753Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:31.100511Z&quot;}" data-trusted="true" data-execution_count="140">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls.one_batch()</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>plot_noise(xb[<span class="dv">0</span>][<span class="dv">0</span>].cpu(), yb[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-93-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-52"><img src="index_files/figure-html/cell-93-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The MSE for this dataset (<code>0.008</code>) is 4x than the first dataset (<code>0.002</code>).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:43:38.493378Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:43:38.493005Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:47:23.801697Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:47:23.800533Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:43:38.493348Z&quot;}" data-trusted="true" data-execution_count="141">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, loss_func<span class="op">=</span>mse, metrics<span class="op">=</span>mse, n_in<span class="op">=</span><span class="dv">1</span>, n_out<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">5</span>, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.144769</td>
      <td>0.068298</td>
      <td>0.068298</td>
      <td>00:32</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mse</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.052315</td>
      <td>0.035616</td>
      <td>0.035616</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.038064</td>
      <td>0.013611</td>
      <td>0.013611</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.032048</td>
      <td>0.015357</td>
      <td>0.015357</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.026942</td>
      <td>0.013210</td>
      <td>0.013210</td>
      <td>00:39</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.018786</td>
      <td>0.008574</td>
      <td>0.008574</td>
      <td>00:39</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:48:58.562369Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:48:58.561948Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:48:59.074703Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:48:59.073756Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:48:58.562335Z&quot;}" data-trusted="true" data-execution_count="142">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">'model2.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inference-1" class="level2">
<h2 class="anchored" data-anchor-id="inference-1">Inference</h2>
<p>I’ll take a look at the predictions and a few test images before deploying this model in my HuggingFace Space. At first glance, the model looks pretty good at predicting the validation set:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:05:05.877629Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:05:05.876550Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:05:10.256558Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:05:10.255423Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:05:05.877594Z&quot;}" data-trusted="true" data-execution_count="121">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.valid)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>preds[:<span class="dv">10</span>], targs[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>(tensor([[0.1268],
         [0.8752],
         [0.0170],
         [0.9900],
         [0.2933],
         [0.0500],
         [0.9181],
         [0.9602],
         [1.0142],
         [0.8437]]),
 tensor([0.1060, 0.8329, 0.0078, 0.9869, 0.2650, 0.0298, 0.9310, 0.9779, 1.0219,
         0.9140]))</code></pre>
</div>
</div>
<p>I’ll make sure that <code>learn.predict</code> works as expected in my “production” environment:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:05:51.891786Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:05:51.891399Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:05:51.966594Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:05:51.965514Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:05:51.891756Z&quot;}" data-trusted="true" data-execution_count="122">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>learn<span class="sc">.</span>predict(x[<span class="dv">0</span>])[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>0.31</code></pre>
</div>
</div>
<p>This model predicts very high (higher than the first model) probabilities for images that are meant to be handwritten digits:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:06:19.780439Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:06:19.779703Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:06:22.186190Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:06:22.184898Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:06:19.780405Z&quot;}" data-trusted="true" data-execution_count="123">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1qNNgt4z-PPn8JKlQU5pFiRE1KCFnqb2R'</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.99</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-98-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-53"><img src="index_files/figure-html/cell-98-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:06:39.546846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:06:39.546410Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:06:41.699328Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:06:41.698452Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:06:39.546813Z&quot;}" data-trusted="true" data-execution_count="125">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=16rs0ARMoaUqUPmQIrMaVqtMiQvIIhT7n'</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 1.00</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-99-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-54"><img src="index_files/figure-html/cell-99-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>This model also seems to be better at predicting low probability for obvious not-digits:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:07:30.286529Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:07:30.285678Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:07:32.728479Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:07:32.727500Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:07:30.286487Z&quot;}" data-trusted="true" data-execution_count="126">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1LjJEMldL2CaWpYxRqv0Byrg0GqdOWGOO'</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.04</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-100-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-55"><img src="index_files/figure-html/cell-100-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-08-27T01:06:28.130517Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-08-27T01:06:28.130144Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-08-27T01:06:30.747765Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-08-27T01:06:30.746642Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-08-27T01:06:28.130462Z&quot;}" data-trusted="true" data-execution_count="124">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://drive.google.com/uc?export=view&amp;id=1OZjXvk74Lpv7teWJ4BY5-xGsjGhblpux'</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>predict_image(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Probability it's a digit: 0.10</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-101-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-56"><img src="index_files/figure-html/cell-101-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="production-environment-results-1" class="level2">
<h2 class="anchored" data-anchor-id="production-environment-results-1">Production Environment Results</h2>
<p>This model is better at predicting a low probability for random noise:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/0dc8ce8e-1-7a64900e-3a83-452d-be6b-f01f3aeba234.png" class="lightbox" data-gallery="quarto-lightbox-gallery-57" title="image.png"><img src="index_files/figure-html/0dc8ce8e-1-7a64900e-3a83-452d-be6b-f01f3aeba234.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/2d5b6024-1-f548a20f-bb2e-4f3c-a932-99c1a065e444.png" class="lightbox" data-gallery="quarto-lightbox-gallery-58" title="image.png"><img src="index_files/figure-html/2d5b6024-1-f548a20f-bb2e-4f3c-a932-99c1a065e444.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>It performs worse when the image is full of black pixels.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/141bbaaf-1-fbf23b6f-c560-463d-a340-3ef46697421f.png" class="lightbox" data-gallery="quarto-lightbox-gallery-59" title="image.png"><img src="index_files/figure-html/141bbaaf-1-fbf23b6f-c560-463d-a340-3ef46697421f.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>It predicts obviously-digits with higher probability than before:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/b728eb0b-1-0cf79ce9-e074-4aa1-9bf7-6529171f60fb.png" class="lightbox" data-gallery="quarto-lightbox-gallery-60" title="image.png"><img src="index_files/figure-html/b728eb0b-1-0cf79ce9-e074-4aa1-9bf7-6529171f60fb.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/ce7ab491-1-21a39ad0-95a6-48a1-a87d-c40a1b05d267.png" class="lightbox" data-gallery="quarto-lightbox-gallery-61" title="image.png"><img src="index_files/figure-html/ce7ab491-1-21a39ad0-95a6-48a1-a87d-c40a1b05d267.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>Though it predicts some digits with higher than <code>1.00</code>—I’ll implement a clamp on the probability to resolve this issue:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/da2da2fb-1-a623cc5b-4a9d-437c-802c-4c8f242a98b4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-62" title="image.png"><img src="index_files/figure-html/da2da2fb-1-a623cc5b-4a9d-437c-802c-4c8f242a98b4.png" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>This exercise turned out to be even more exciting than I expected (and I was already pretty pumped!). Here’s what I learned:</p>
<ul>
<li><p><strong>Production feedback is unmatched.</strong> The best move was deploying the initial model quickly with a user interface to see how it performed in real-world conditions. That feedback led me to revamp the training dataset with adjustments I wouldn’t have thought of otherwise, resulting in a better user experience.</p></li>
<li><p><strong>Building a good “product” is tougher than I thought.</strong> I assumed generating synthetic data, training a model, and deploying it with MNIST would be straightforward. <em>I was wrong!</em> I’ve put in 5-10 hours (including time wrestling with deployment dependencies) and still wouldn’t say the model is perfect for users.</p></li>
<li><p><strong>Claude accelerates the learning curve.</strong> A few simple prompts were all it took for Claude to generate a <a href="https://codepen.io/vishalbakshi/full/eYweKrN">working prototype</a>. Claude handled 95% of the frontend code. Without it, I’d have spent days figuring out how to create a responsive UI with a drawable canvas and real-time prediction display—and might’ve abandoned the project entirely without that assist.</p></li>
</ul>
<p>I hope you enjoyed this notebook! If so, please give it an upvote :).</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","selector":".lightbox","descPosition":"bottom","loop":true});</script>



</body></html>