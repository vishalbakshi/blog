<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-09-12">
<meta name="description" content="In this blog post I use phi-3 to classify sentiment in the financial_phrasebank dataset with 92.79% accuracy.">

<title>Vishal Bakshi’s Blog - Sentiment Classification with phi-3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#prompt-a" id="toc-prompt-a" class="nav-link" data-scroll-target="#prompt-a">Prompt A</a></li>
  <li><a href="#prompt-b" id="toc-prompt-b" class="nav-link" data-scroll-target="#prompt-b">Prompt B</a></li>
  <li><a href="#prompt-c" id="toc-prompt-c" class="nav-link" data-scroll-target="#prompt-c">Prompt C</a></li>
  <li><a href="#prompt-d" id="toc-prompt-d" class="nav-link" data-scroll-target="#prompt-d">Prompt D</a></li>
  <li><a href="#prompt-e" id="toc-prompt-e" class="nav-link" data-scroll-target="#prompt-e">Prompt E</a></li>
  <li><a href="#prompt-f" id="toc-prompt-f" class="nav-link" data-scroll-target="#prompt-f">Prompt F</a></li>
  <li><a href="#prompt-g" id="toc-prompt-g" class="nav-link" data-scroll-target="#prompt-g">Prompt G</a></li>
  <li><a href="#prompt-h" id="toc-prompt-h" class="nav-link" data-scroll-target="#prompt-h">Prompt H</a></li>
  <li><a href="#prompt-i" id="toc-prompt-i" class="nav-link" data-scroll-target="#prompt-i">Prompt I</a></li>
  <li><a href="#prompt-j" id="toc-prompt-j" class="nav-link" data-scroll-target="#prompt-j">Prompt J</a></li>
  <li><a href="#prompt-k" id="toc-prompt-k" class="nav-link" data-scroll-target="#prompt-k">Prompt K</a></li>
  <li><a href="#prompt-l" id="toc-prompt-l" class="nav-link" data-scroll-target="#prompt-l">Prompt L</a></li>
  <li><a href="#prompt-m" id="toc-prompt-m" class="nav-link" data-scroll-target="#prompt-m">Prompt M</a></li>
  <li><a href="#prompt-n" id="toc-prompt-n" class="nav-link" data-scroll-target="#prompt-n">Prompt N</a></li>
  <li><a href="#prompt-o" id="toc-prompt-o" class="nav-link" data-scroll-target="#prompt-o">Prompt O</a></li>
  <li><a href="#prompt-p" id="toc-prompt-p" class="nav-link" data-scroll-target="#prompt-p">Prompt P</a></li>
  <li><a href="#prompt-q" id="toc-prompt-q" class="nav-link" data-scroll-target="#prompt-q">Prompt Q</a></li>
  <li><a href="#prompt-r" id="toc-prompt-r" class="nav-link" data-scroll-target="#prompt-r">Prompt R</a></li>
  <li><a href="#running-inference-with-the-best-prompt-multiple-times" id="toc-running-inference-with-the-best-prompt-multiple-times" class="nav-link" data-scroll-target="#running-inference-with-the-best-prompt-multiple-times">Running Inference with the Best Prompt Multiple Times</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sentiment Classification with phi-3</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">LLM</div>
    <div class="quarto-category">TinySentiment</div>
  </div>
  </div>

<div>
  <div class="description">
    In this blog post I use phi-3 to classify sentiment in the <code>financial_phrasebank</code> dataset with 92.79% accuracy.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell">
<details>
<summary>Show pip installs</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install torch<span class="op">==</span><span class="fl">2.3.1</span> <span class="op">-</span>qq</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install accelerate<span class="op">==</span><span class="fl">0.31.0</span> <span class="op">-</span>qq</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install transformers<span class="op">==</span><span class="fl">4.41.2</span> <span class="op">-</span>qq</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install huggingface_hub <span class="op">-</span>qq</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install datasets<span class="op">~=</span><span class="fl">2.16.1</span> <span class="op">-</span>qq</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install plotly<span class="op">==</span><span class="fl">5.19.0</span> <span class="op">-</span>qq</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn<span class="op">==</span><span class="fl">1.2</span> <span class="op">-</span>qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show imports and setup</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, ConfusionMatrixDisplay</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.api.types <span class="im">import</span> CategoricalDtype</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#warnings.filterwarnings("ignore")</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset, Dataset</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer, pipeline </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers.pipelines.pt_utils <span class="im">import</span> KeyDataset</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">#torch.set_default_device("cuda")</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained( </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"microsoft/Phi-3-mini-4k-instruct"</span>,  </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    device_map<span class="op">=</span><span class="st">"cuda"</span>,  </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    torch_dtype<span class="op">=</span><span class="st">"auto"</span>,  </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    trust_remote_code<span class="op">=</span><span class="va">True</span>,  </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">"microsoft/Phi-3-mini-4k-instruct"</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> pipeline( </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text-generation"</span>, </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model, </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    tokenizer<span class="op">=</span>tokenizer, </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># load dataset</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"financial_phrasebank"</span>, <span class="st">"sentences_allagree"</span>, </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">"train"</span>  <span class="co"># note that the dataset does not have a default test split</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.873906Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.873708Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.956535Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.955896Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.873888Z&quot;}">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new column with the numeric label verbalised as label_text (e.g. "positive" instead of "0")</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>label_map <span class="op">=</span> {i: label_text <span class="cf">for</span> i, label_text <span class="kw">in</span> <span class="bu">enumerate</span>(dataset.features[<span class="st">"label"</span>].names)}</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_label_text(example):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    example[<span class="st">"label_text"</span>] <span class="op">=</span> label_map[example[<span class="st">"label"</span>]]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> example</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_label_text)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.958152Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.957941Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.963961Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.963323Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.958135Z&quot;}" data-execution_count="5">
<details>
<summary>Show <code>add_prompt</code> and <code>generate_responses</code> functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_prompt(item, prompt):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        item[<span class="st">'prompt'</span>] <span class="op">=</span> prompt.<span class="bu">format</span>(text<span class="op">=</span>item[<span class="st">'sentence'</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> item</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_responses(dataset, prompt):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that the prompt is correctly formatted</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset[<span class="dv">0</span>][<span class="st">'prompt'</span>])</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'---------'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        ] </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.965072Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.964877Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.968694Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.968162Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.965055Z&quot;}" data-execution_count="6">
<details>
<summary>Show <code>generate_response</code> function</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_response(prompt):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt},</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    ] </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    generation_args <span class="op">=</span> { </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output[<span class="dv">0</span>][<span class="st">'generated_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.969979Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.969498Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.974132Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.973551Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.969960Z&quot;}" data-execution_count="7">
<details>
<summary>Show <code>make_cm</code> function</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_cm(df):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create confusion matrix for true vs predicted sentiment classes"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true<span class="op">=</span>df[<span class="st">'label_text'</span>], y_pred<span class="op">=</span>df[<span class="st">'responses'</span>], labels<span class="op">=</span>[<span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'other'</span>])</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    disp <span class="op">=</span> ConfusionMatrixDisplay(cm, display_labels<span class="op">=</span>[<span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'other'</span>])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I chose 8x8 so it fits on one screen but still is large</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    disp.plot(ax<span class="op">=</span>ax,text_kw<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">16</span>}, cmap<span class="op">=</span><span class="st">'Blues'</span>, colorbar<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change label font size without changing label text</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.label.set_fontsize(<span class="dv">18</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.label.set_fontsize(<span class="dv">18</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make tick labels larger</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.975111Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.974939Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.978759Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.978159Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.975096Z&quot;}" data-execution_count="8">
<details>
<summary>Show <code>ds_subset</code> function</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ds_subset(dataset, exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(dataset)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> idxs <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> exclude_idxs]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    ddf <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    new_ds <span class="op">=</span> Dataset.from_pandas(ddf.iloc[idxs, columns])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I’ll use <a href="https://huggingface.co/microsoft/Phi-3-mini-4k-instruct">Phi-3-mini-4k-instruct</a> to classify sentiment in the <a href="https://huggingface.co/datasets/financial_phrasebank"><code>financial_phrasebank</code> dataset</a>. In previous notebooks I have performed <a href="https://vishalbakshi.github.io/blog/posts/2024-08-31-tinysentiment-phi-2-sentiment-classification/">sentiment classification with phi-2</a> and <a href="https://vishalbakshi.github.io/blog/posts/2024-08-29-tinysentiment-claude-experiments/">the Claude series</a>.</p>
<p>This notebook is part of <a href="https://vishalbakshi.github.io/blog/#category=TinySentiment">a series of blog posts</a> for a project I’m working called TinySentiment where I’m experimenting with tiny models to improve their ability to classify sentiment in the <code>financial_phrasebank dataset</code>. I was inspired to do so after reading <a href="https://huggingface.co/blog/synthetic-data-save-costs">this blog post</a> and <a href="https://github.com/MoritzLaurer/synthetic-data-blog/blob/main/notebooks/synthetic_data_creation.ipynb">this corresponding notebook</a> by Moritz Laurer as part of a fastai study group last year.</p>
<p>Here are the results from my experiments so far (**the best-performing prompt from this notebook):</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">**phi-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
</tbody>
</table>
<p>Here are the per-prompt results from this notebook (phi-3):</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">prompt</th>
<th style="text-align: center;">strategy</th>
<th style="text-align: center;">accuracy</th>
<th style="text-align: center;">negative</th>
<th style="text-align: center;">neutral</th>
<th style="text-align: center;">positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-A">A</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">47.00%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">16% (220/1391)</td>
<td style="text-align: center;">96% (546/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-B">B</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">73.23%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">59% (821/1391)</td>
<td style="text-align: center;">94% (537/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-C">C</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">66.25%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">47% (650/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-D">D</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">49.65%</td>
<td style="text-align: center;"><u><strong>99% (301/303)</strong></u></td>
<td style="text-align: center;">19% (269/1391)</td>
<td style="text-align: center;">97% (554/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-E">E</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">72.44%</td>
<td style="text-align: center;">99% (299/303)</td>
<td style="text-align: center;">58% (803/1391)</td>
<td style="text-align: center;">94% (538/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-F">F</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">82.62%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">73% (1009/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-G">G</a></td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">76.13%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">62% (865/1387)</td>
<td style="text-align: center;">98% (557/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-H">H</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.10%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">73% (1021/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-I">I</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">81.16%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">70% (977/1390)</td>
<td style="text-align: center;">99% (563/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-J">J</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">84.61%</td>
<td style="text-align: center;">97% (294/302)</td>
<td style="text-align: center;">76% (1055/1390)</td>
<td style="text-align: center;"><u><strong>99% (564/569)<u></u></strong></u></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-K">K</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.19%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">74% (1024/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-L">L</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">87.35%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">81% (1120/1390)</td>
<td style="text-align: center;">98% (560/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-M">M</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.41%</td>
<td style="text-align: center;">97% (292/302)</td>
<td style="text-align: center;">83% (1149/1390)</td>
<td style="text-align: center;">98% (558/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-N">N</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.28%</td>
<td style="text-align: center;">97% (293/302)</td>
<td style="text-align: center;">82% (1142/1390)</td>
<td style="text-align: center;">99% (561/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-O">O</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.59%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">82% (1145/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-P">P</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">90.00%</td>
<td style="text-align: center;">97% (294/302)</td>
<td style="text-align: center;">85% (1179/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-Q">Q</a></td>
<td style="text-align: center;">20-Shot w/System Prompt</td>
<td style="text-align: center;">91.71%</td>
<td style="text-align: center;">97% (291/299)</td>
<td style="text-align: center;">89% (1226/1379)</td>
<td style="text-align: center;">96% (541/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u><strong><a href="#prompt-R">R</a></strong></u></td>
<td style="text-align: center;"><u><strong>30-Shot w/System Prompt</strong></u></td>
<td style="text-align: center;"><u><strong>92.79%</strong></u></td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;"><u><strong>94% (1284/1373)</strong></u></td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
</tbody>
</table>
</section>
<section id="prompt-a" class="level2">
<h2 class="anchored" data-anchor-id="prompt-a">Prompt A</h2>
<p>The HuggingFace model card for Phi-3 Mini-4K-Instruct says:</p>
<blockquote class="blockquote">
<p>Given the nature of the training data, the Phi-3 Mini-4K-Instruct model is best suited for prompts using the chat format</p>
</blockquote>
<p>So, the first prompt I’ll try will be a simple instruction:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:22:58.171065Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:22:58.170403Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:22:58.174206Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:22:58.173501Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:22:58.171044Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>promptA <span class="op">=</span> <span class="st">"""Label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:22:59.869195Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:22:59.868425Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:22:59.876347Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:22:59.875787Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:22:59.869175Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> dataset[<span class="dv">1</span>][<span class="st">"sentence"</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>"For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m ."</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:23:02.411463Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:23:02.411203Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:23:02.414920Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:23:02.414420Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:23:02.411446Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>formatted_prompt <span class="op">=</span> promptA.<span class="bu">format</span>(text<span class="op">=</span>text)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:23:04.265018Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:23:04.264224Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:23:05.025735Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:23:05.025207Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:23:04.264987Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>' Negative'</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:23:07.005848Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:23:07.005343Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:23:07.074481Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:23:07.073733Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:23:07.005829Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 64.3 ms, sys: 87 µs, total: 64.4 ms
Wall time: 63.5 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>' Negative'</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:23:09.606602Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:23:09.605994Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:23:13.816757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:23:13.816293Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:23:09.606574Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>60.1 ms ± 926 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<p>Good–at least it works! Although it looks like I’ll have to strip the outputs of whitespace and convert them to lowercase. It takes about 0.06 seconds to generate the response, so it should take about 2-3 minutes to run inference on the whole dataset.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:29:04.340598Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:29:04.339668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:31:23.726730Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:31:23.726090Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:29:04.340572Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
---------</code></pre>
</div>
</div>
<p>As expected, the model does not perform well with this prompt. It actually performs worse than phi-2 (58%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:31:23.728244Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:31:23.728033Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:31:23.732473Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:31:23.731727Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:31:23.728228Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.46996466431095407</code></pre>
</div>
</div>
<p>The model actually performs quite well for <code>negative</code> (298/393) and <code>positive</code> (546/570) sentiment, but performs badly for <code>neutral</code> sentiment (220/1391).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:31:23.739578Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:31:23.739395Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:31:23.859315Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:31:23.858535Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:31:23.739559Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:34:12.912658Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:34:12.911598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:34:12.934248Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:34:12.933529Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:34:12.912614Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_A.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-b" class="level2">
<h2 class="anchored" data-anchor-id="prompt-b">Prompt B</h2>
<p>I’ll repeat the instruction after the sentence and see if that improves the performance (as it did for phi-2).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:44:30.434958Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:44:30.433987Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:44:30.438329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:44:30.437633Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:44:30.434928Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>promptB <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:44:39.509562Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:44:39.509104Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:47:02.869196Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:47:02.868447Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:44:39.509544Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6d937294918046ebaa59ebf8dd0cbf5b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>As expected, repeating the instruction boosts the accuracy significantly. This is something I learned to do in a fastai study group.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:47:02.870685Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:47:02.870477Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:47:02.874837Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:47:02.874334Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:47:02.870667Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>0.7323321554770318</code></pre>
</div>
</div>
<p>The model improves its performance for <code>negative</code> and <code>neutral</code> sentences, while its performance for <code>positive</code> sentences worsens.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:54:18.185349Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:54:18.184616Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:54:18.295573Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:54:18.294895Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:54:18.185309Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-22-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:54:32.589596Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:54:32.589352Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:54:32.633195Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:54:32.632571Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:54:32.589579Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_B.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-c" class="level2">
<h2 class="anchored" data-anchor-id="prompt-c">Prompt C</h2>
<p>I’ll add some introductory text to the prompt to see if that improves the model’s performance:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:48:10.156569Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:48:10.155777Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:48:10.159809Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:48:10.159086Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:48:10.156542Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>promptC <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:48:19.108345Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:48:19.107978Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:44.221796Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:44.221149Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:48:19.108316Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3dd4f7bf478d43e288c0f524e379bc60","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Your task is to analyze the sentiment (from an investor's perspective) of the text below.

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>Unlike phi-2 (although I applied this introductory text to few-shot prompting, not 0-shot) this worsens the model’s overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:50:44.223444Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:50:44.223152Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:44.228329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:44.227544Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:50:44.223418Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>0.6625441696113075</code></pre>
</div>
</div>
<p>Interestingly, this prompt improves the <code>positive</code> sentiment true positive rate (550/570 &gt; 537/570).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:50:44.229723Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:50:44.229198Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:44.312358Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:44.311868Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:50:44.229669Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-27-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:53:50.084167Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:53:50.083522Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:53:50.109510Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:53:50.108874Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:53:50.084145Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_C.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-d" class="level2">
<h2 class="anchored" data-anchor-id="prompt-d">Prompt D</h2>
<p>I’ll try another prompt language adjustment to Prompt B: I’ll replace “label” with “Respond”.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:58:02.299718Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:58:02.299443Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:58:02.303068Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:58:02.302387Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:58:02.299700Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>promptD <span class="op">=</span> <span class="st">"""Instruct: Respond with only one of these words: negative, positive, or neutral</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with only one of these words: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:58:08.867762Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:58:08.867125Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T21:00:29.080593Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T21:00:29.079904Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:58:08.867742Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"12ca7972b5d9473fb9f45b4156310405","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: Respond with only one of these words: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
Respond with only one of these words: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>Yikes! The overall accuracy plummets to 49.6%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T21:00:29.082043Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T21:00:29.081806Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T21:00:29.086983Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T21:00:29.086277Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T21:00:29.082022Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.49646643109540634</code></pre>
</div>
</div>
<p>Interestingly, the true positive rate for <code>negative</code> and <code>positive</code> sentences increses, but for <code>neutral</code> <em>significantly</em> decreases.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T21:00:29.088378Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T21:00:29.087897Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T21:00:29.185117Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T21:00:29.184295Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T21:00:29.088353Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-32-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T21:01:51.218382Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T21:01:51.217783Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T21:01:51.239870Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T21:01:51.239224Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T21:01:51.218360Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_D.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-e" class="level2">
<h2 class="anchored" data-anchor-id="prompt-e">Prompt E</h2>
<p>Another adjustment that improved phi-2’s performance was to add a period after the instruction. I’ll see if doing so improves phi-3’s performance.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:54:47.598940Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:54:47.598584Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:54:47.602084Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:54:47.601552Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:54:47.598916Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>promptE <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral.</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:54:52.874608Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:54:52.874351Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:57:15.215234Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:57:15.214545Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:54:52.874590Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7179db2a368f44528716c9d3677679ec","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral.
---------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>The accuracy drops from 73% to 72%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:57:19.060634Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:57:19.060094Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:57:19.069672Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:57:19.069109Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:57:19.060609Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>0.7243816254416962</code></pre>
</div>
</div>
<p>The true positive rate for <code>negative</code> and <code>neutral</code> sentiment drops a bit while for <code>positive</code> sentiments increases (538/570 &gt; 537/570).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:57:53.409599Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:57:53.409365Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:57:53.546589Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:57:53.546031Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:57:53.409583Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-37-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:59:02.994678Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:59:02.994302Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:59:03.025590Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:59:03.024866Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:59:02.994650Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_E.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-f" class="level2">
<h2 class="anchored" data-anchor-id="prompt-f">Prompt F</h2>
<p>I’ll now move on to few-shot prompting to see if I can improve on the best overall accuracy so far (73.1%). To do so, I’ll create a new helper function (since the chat template handles few-shot prompt as multiple query-response exchanges between user and assistant).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:03:11.706206Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:03:11.705954Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:03:11.712285Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:03:11.711710Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:03:11.706188Z&quot;}" data-execution_count="15">
<details>
<summary>Show <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>: <span class="bu">print</span>(messages)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:29:14.022827Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:29:14.022463Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:29:14.026552Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:29:14.025937Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:29:14.022800Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:29:15.715885Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:29:15.715224Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:29:15.728471Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:29:15.727872Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:29:15.715859Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>promptF_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>promptF_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:29:18.533049Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:29:18.532776Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:29:18.539721Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:29:18.539005Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:29:18.533029Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:04:12.147743Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:04:12.146780Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:08:34.288192Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:08:34.287447Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:04:12.147675Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptB, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"41db0a90f09b4b80a3c2f296eb9bf43d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral'}]</code></pre>
</div>
</div>
<p>Nice! Few-shot prompting improves the overall accuracy by almost 10% (from 73.06% to 82.62%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:09:25.926256Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:09:25.925965Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:09:25.931365Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:09:25.930697Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:09:25.926237Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>0.8261831048208758</code></pre>
</div>
</div>
<p>Compared to prompt B, this prompt yields worse results for <code>negative</code> sentiment (297 &lt; 300), and better results for <code>neutral</code> (1009 &gt; 817) and <code>positive</code> sentiment (562 &gt; 537).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:09:53.780432Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:09:53.779880Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:09:53.870792Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:09:53.870182Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:09:53.780404Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-45-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:12:19.830024Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:12:19.829642Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:12:19.868602Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:12:19.867954Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:12:19.830001Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_F.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-g" class="level2">
<h2 class="anchored" data-anchor-id="prompt-g">Prompt G</h2>
<p>I’ll now try a 6-Shot prompt using the examples that were best-performing for phi-2.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:12:56.545789Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:12:56.545487Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:12:56.560444Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:12:56.559909Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:12:56.545770Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>]</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>promptG_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>promptG_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2258
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:13:02.572986Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:13:02.572636Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:13:02.581312Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:13:02.580325Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:13:02.572959Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 6)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:13:10.532044Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:13:10.531717Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:20:35.600025Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:20:35.599481Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:13:10.532024Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptG_ds, promptB, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4204fc33a64d4207a48dc0fc965a8ea5","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral'}]</code></pre>
</div>
</div>
<p>Surprisingly, the overall accuracy drops from 82.6% (3-Shot) to 76.13% (6-Shot).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:20:35.601300Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:20:35.601102Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:20:35.605850Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:20:35.604961Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:20:35.601282Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.7612931798051373</code></pre>
</div>
</div>
<p>The model performs the same for <code>negative</code> sentences (297/302), much worse for <code>neutral</code> sentences (865 &lt; 1009), and slightly worse for <code>positive</code> sentences (557 &lt; 562).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:20:35.607238Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:20:35.607006Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:20:35.693356Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:20:35.692609Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:20:35.607217Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-51-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:22:58.125927Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:22:58.125625Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:22:58.146982Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:22:58.146222Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:22:58.125907Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_G.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-h" class="level2">
<h2 class="anchored" data-anchor-id="prompt-h">Prompt H</h2>
<p>I’ll return to the 3-Shot prompt (82.62%) and see if I can improve it by adjusting the language. First, I’ll add some introductory text to the start of the prompt. Note that this did not improve the 0-Shot performance.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:54:52.475210Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:54:52.474624Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:54:52.478243Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:54:52.477633Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:54:52.475188Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>promptH <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:28:37.677466Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:28:37.676867Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:28:37.685710Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:28:37.685134Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:28:37.677443Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:29:24.960707Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:29:24.960097Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:29:24.964923Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:29:24.964347Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:29:24.960685Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>promptF_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:55:05.411985Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:55:05.411415Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:00:18.949294Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:00:18.948638Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:55:05.411958Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptH, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3680f3d7add543968c1f74f6cf387326","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>I get a tiny boost (0.48%) with this approach. I’ll take it!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:00:18.950651Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:00:18.950453Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:00:18.955069Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:00:18.954545Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:00:18.950651Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>0.8310482087571871</code></pre>
</div>
</div>
<p>Compared to the previous 3-Shot prompt (82.62%), this prompt results in a lower true positive rate for <code>negative</code> sentences (296 &lt; 297), a slightly higher rate for <code>neutral</code> sentences (1021 &gt; 1009), and the same rate for <code>positive</code> sentences (562).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:09:02.702388Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:09:02.701667Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:09:02.785609Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:09:02.784967Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:09:02.702366Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-58-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/cell-58-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:09:18.624424Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:09:18.623823Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:09:18.649221Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:09:18.648567Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:09:18.624401Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_H.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-i" class="level2">
<h2 class="anchored" data-anchor-id="prompt-i">Prompt I</h2>
<p>Given my success with the language adjustment for 3-Shot prompting, I’ll make another one: adding a period to the end of each instruction sentence.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:13:49.853937Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:13:49.853360Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:13:49.857156Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:13:49.856334Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:13:49.853910Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>promptI <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral.</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:14:13.197435Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:14:13.196827Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:19:29.081329Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:19:29.080651Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:14:13.197414Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptI, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3896e2c5931747f29c160d4b4f8c60cc","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral.\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral."}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral.\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral."}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral.\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral."}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral.\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral."}]</code></pre>
</div>
</div>
<p>Surprisingly, adding periods at the end of the instructions actually reduces the overall accuracy (81.16%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:20:13.784699Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:20:13.783889Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:20:13.788404Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:20:13.787840Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:20:13.784669Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0.8115877930119416</code></pre>
</div>
</div>
<p>The true positive rate drops for <code>negative</code> (295 &lt; 296) and <code>neutral</code> (977 &lt; 1021) but increases for <code>positive</code> (563 &gt; 562) when compared to the best-performing prompt.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:23:11.851928Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:23:11.851433Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:23:11.962093Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:23:11.961356Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:23:11.851909Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-63-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/cell-63-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:26:31.437199Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:26:31.436576Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:26:31.462832Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:26:31.462166Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:26:31.437174Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_I.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-j" class="level2">
<h2 class="anchored" data-anchor-id="prompt-j">Prompt J</h2>
<p>I’ll try another language adjustment for the few-shot prompt: replacing “Instruct: label the TEXT with a single word: negative, positive, or neutral.” with “Respond with a single word: negative, positive, or neutral”.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:10:14.702138Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:10:14.701514Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:10:14.704791Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:10:14.704314Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:10:14.702113Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>promptJ <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:23:52.626324Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:23:52.625840Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:28:42.802363Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:28:42.801690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:23:52.626303Z&quot;}" data-execution_count="64">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a392d5264d544e9c80da17a56560a725","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>Yes!! I achieve my best result so far with 84.6% overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:29:15.947435Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:29:15.946786Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:29:15.950773Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:29:15.950282Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:29:15.947415Z&quot;}" data-execution_count="65">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>0.8460858027421495</code></pre>
</div>
</div>
<p>Compared to Prompt H, this prompt yields a worse <code>negative</code> sentiment true positive rate (294 &lt; 296), but a better rate for <code>neutral</code> (1055 &gt; 1021) and <code>positive</code> (564 &gt; 562).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:30:02.259620Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:30:02.259050Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:30:02.343769Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:30:02.343080Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:30:02.259597Z&quot;}" data-execution_count="66">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-68-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:32:15.893961Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:32:15.893138Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:32:15.925782Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:32:15.925258Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:32:15.893935Z&quot;}" data-execution_count="67">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_J.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-k" class="level2">
<h2 class="anchored" data-anchor-id="prompt-k">Prompt K</h2>
<p>Another language adjustment that worked for phi-2: adding the phrase “if you’re not sure, respond with neutral”.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:29:52.534700Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:29:52.534459Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:29:52.538113Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:29:52.537458Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:29:52.534683Z&quot;}" data-execution_count="86">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>promptK <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:29:54.885366Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:29:54.884871Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:35:36.555288Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:35:36.554703Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:29:54.885346Z&quot;}" data-execution_count="87">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptK, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7e5ddbdbf5e04f9690fdf6dc5f85c271","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."}]</code></pre>
</div>
</div>
<p>This does not improve the overall accuracy.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:35:36.556506Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:35:36.556336Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:35:36.560655Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:35:36.560082Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:35:36.556491Z&quot;}" data-execution_count="88">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>0.8319327731092437</code></pre>
</div>
</div>
<p>Compared to Prompt J, this prompt results in a higher true positive rate for <code>negative</code> sentiment (295 &gt; 294), but a lower rate for <code>neutral</code> (1024 &lt; 1055) and <code>positive</code> sentiment (562 &lt; 564).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:35:36.563815Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:35:36.563673Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:35:36.646184Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:35:36.645593Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:35:36.563802Z&quot;}" data-execution_count="89">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-73-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/cell-73-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:35:36.647324Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:35:36.647116Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:35:36.688626Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:35:36.688036Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:35:36.647305Z&quot;}" data-execution_count="90">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_K.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-l" class="level2">
<h2 class="anchored" data-anchor-id="prompt-l">Prompt L</h2>
<p>I’ll see if adding a system prompt improves performance.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:15:29.814884Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:15:29.814393Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:15:29.820686Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:15:29.820155Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:15:29.814864Z&quot;}" data-execution_count="76">
<details>
<summary>Show updated <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples, sp<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp:</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: <span class="st">'You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification.'</span>}</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>                       ] <span class="op">+</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>: <span class="bu">print</span>(messages)</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:15:59.192511Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:15:59.192250Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:21:20.784432Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:21:20.783913Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:15:59.192493Z&quot;}" data-execution_count="79">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples, sp<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aa0751e284d747e3b06cbf2688652f7d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': 'You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification.'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>Adding this sytem prompt increases the accuracy from 84.6% to 87.4%!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:24:45.803247Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:24:45.802293Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:24:45.808520Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:24:45.807730Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:24:45.803206Z&quot;}" data-execution_count="80">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>0.8735072976559045</code></pre>
</div>
</div>
<p>Compared to Prompt J (without system prompt) adding this system prompt results in a higher true positive rate for <code>negative</code> (295 &gt; 294) and <code>neutral</code> (1120 &gt; 1055) sentiment but a lower rate for <code>positive</code> sentiment (560 &lt; 564).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:25:30.689022Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:25:30.688295Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:25:30.773288Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:25:30.772842Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:25:30.689016Z&quot;}" data-execution_count="81">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-78-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="index_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:29:45.067540Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:29:45.067236Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:29:45.090108Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:29:45.089612Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:29:45.067518Z&quot;}" data-execution_count="85">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_L.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-m" class="level2">
<h2 class="anchored" data-anchor-id="prompt-m">Prompt M</h2>
<p>I’ll add the following phrase to the system prompt:</p>
<blockquote class="blockquote">
<p>If you’re not sure, respond with neutral.</p>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:08:38.580370Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:08:38.579131Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:08:38.587127Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:08:38.586640Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:08:38.580323Z&quot;}" data-execution_count="9">
<details>
<summary>Show updated <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples, sp<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp:</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: sp}] <span class="op">+</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>: <span class="bu">print</span>(messages)</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:11.738638Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:11.738272Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:11.742008Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:11.741396Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:11.738615Z&quot;}" data-execution_count="96">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If you're not sure, respond with neutral."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:12.956743Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:12.956377Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:12.960697Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:12.959959Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:12.956718Z&quot;}" data-execution_count="97">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If you're not sure, respond with neutral.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:34.554501Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:34.554255Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:57:57.295929Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:57:57.295199Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:34.554482Z&quot;}" data-execution_count="98">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ed703516a6894f3ba6e4e1608c63a3f2","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': "You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If you're not sure, respond with neutral."}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>Excellent—the new system prompt results in the best-so-far overall accuracy (88.4%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:57:57.297711Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:57:57.297209Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:57:57.301703Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:57:57.301110Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:57:57.297693Z&quot;}" data-execution_count="99">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>0.8841220698805838</code></pre>
</div>
</div>
<p>Compared to the last system prompt, this one yields a lower true positive rates for <code>negative</code> sentiment (292 &lt; 295) and <code>positive</code> sentiment (558 &lt; 560) but a higher rate for <code>neutral</code> (1149 &gt; 1120) sentiment.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:57:57.304549Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:57:57.304365Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:57:57.390765Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:57:57.390132Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:57:57.304544Z&quot;}" data-execution_count="100">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-85-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="index_files/figure-html/cell-85-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:57:57.391832Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:57:57.391636Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:57:57.417029Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:57:57.416239Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:57:57.391812Z&quot;}" data-execution_count="101">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_M.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-n" class="level2">
<h2 class="anchored" data-anchor-id="prompt-n">Prompt N</h2>
<p>I’ll iterate on the system prompt. I’ll replace:</p>
<blockquote class="blockquote">
<p>If you’re not sure, respond with neutral.</p>
</blockquote>
<p>with</p>
<blockquote class="blockquote">
<p>If the amount of money is not explicitly increasing or decreasing, respond with neutral.</p>
</blockquote>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:09:05.300926Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:09:05.300414Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:09:05.303867Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:09:05.303230Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:09:05.300906Z&quot;}" data-execution_count="105">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money is not explicitly increasing or decreasing, respond with neutral."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:09:06.691909Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:09:06.691263Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:09:06.695186Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:09:06.694693Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:09:06.691887Z&quot;}" data-execution_count="106">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money is not explicitly increasing or decreasing, respond with neutral.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:09:10.369384Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:09:10.368645Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:14:36.222238Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:14:36.221495Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:09:10.369365Z&quot;}" data-execution_count="107">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ff6352c1e04a489cb9101dfb0553228c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': 'You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>The updated system prompt causes the overall accuracy to drop a tiny bit.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:14:36.223939Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:14:36.223727Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:14:36.231684Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:14:36.230994Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:14:36.223923Z&quot;}" data-execution_count="108">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>0.8827952233524989</code></pre>
</div>
</div>
<p>The true positive rate for <code>negative</code> (293 &gt; 292) and <code>positive</code> (561 &gt; 558) sentiment actually increases, but decreases for <code>neutral</code> sentiment (1142 &lt; 1149) when compare to the previous system prompt.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:14:36.233019Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:14:36.232824Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:14:36.323759Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:14:36.322836Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:14:36.233003Z&quot;}" data-execution_count="109">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-91-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="index_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:14:36.325323Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:14:36.325126Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:14:36.349878Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:14:36.349139Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:14:36.325306Z&quot;}" data-execution_count="110">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_N.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-o" class="level2">
<h2 class="anchored" data-anchor-id="prompt-o">Prompt O</h2>
<p>I’ll iterate on the best-performing (88.4%) Prompt M by adding more detail to how the model should handle neutral sentiment (based on a suggestion by Claude):</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:30:09.967168Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:30:09.966668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:30:09.970269Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:30:09.969729Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:30:09.967148Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:30:12.069794Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:30:12.069201Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:30:12.073224Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:30:12.072661Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:30:12.069772Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:30:16.703133Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:30:16.702608Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:35:51.823535Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:35:51.822919Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:30:16.703109Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9a0b9fb3557a4470b3f3e55ef4f4523b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': 'You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>Nice! This modification resulted in the best overall accuracy so far, 88.6%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:39:55.129881Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:39:55.128865Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:39:55.133869Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:39:55.133389Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:39:55.129857Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>0.885891198584697</code></pre>
</div>
</div>
<p>The true positive rate increased for <code>negative</code> and <code>positive</code> sentiments and decreased a bit for <code>neutral</code> sentiment.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:40:30.062359Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:40:30.062098Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:40:30.237596Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:40:30.235280Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:40:30.062341Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-97-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="index_files/figure-html/cell-97-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:40:41.681714Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:40:41.681395Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:40:41.707362Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:40:41.706520Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:40:41.681692Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_O.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-p" class="level2">
<h2 class="anchored" data-anchor-id="prompt-p">Prompt P</h2>
<p>Given the improvement with a more nuanced system prompt, I’ll continue adding to the prompt.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:09:52.894697Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:09:52.894074Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:09:52.897862Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:09:52.897357Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:09:52.894668Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:09:55.579512Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:09:55.578640Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:09:55.582378Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:09:55.581992Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:09:55.579482Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:44:29.388924Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:44:29.388073Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:50:18.613681Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:50:18.612855Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:44:29.388900Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"09a05bf2d4b34a0cb8be987754d3df78","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': "You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change."}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>Awesome!! I’ve broken the 90% mark with that system prompt.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:50:42.169372Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:50:42.169112Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:50:42.173867Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:50:42.173092Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:50:42.169354Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.9000442282176029</code></pre>
</div>
</div>
<p>Compared to the previous best-performing prompt O, this prompt yields fewer correct <code>negative</code> sentences (294 &lt; 296), more correct <code>neutral</code> sentences (1179 &gt; 1145) and thes same number of correct <code>positive</code> sentences (562).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:51:06.153343Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:51:06.152418Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:51:06.239716Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:51:06.239033Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:51:06.153341Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-103-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="index_files/figure-html/cell-103-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:53:56.053511Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:53:56.052770Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:53:56.079152Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:53:56.078485Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:53:56.053486Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_P.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-q" class="level2">
<h2 class="anchored" data-anchor-id="prompt-q">Prompt Q</h2>
<p>I’ll now increase the number of examples to a significantly larger number (20) and see if that improves performance.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:48:15.832614Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:48:15.831882Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:48:15.837026Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:48:15.836454Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:48:15.832614Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:48:24.139454Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:48:24.138883Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:48:24.152244Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:48:24.151659Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:48:24.139434Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>promptQ_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>promptQ_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2244
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:48:31.223763Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:48:31.223095Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:48:31.231019Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:48:31.230463Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:48:31.223743Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>(("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 20)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:49:13.932289Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:49:13.931482Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T22:24:45.208921Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T22:24:45.208360Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:49:13.932267Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptQ_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0aa9e6e810f64f4fb84261ac7eb33b2b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': "You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change."}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Operating profit rose to EUR 13.1 mn from EUR 8.7 mn in the corresponding period in 2007 representing 7.7 % of net sales .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Operating profit totalled EUR 21.1 mn , up from EUR 18.6 mn in 2007 , representing 9.7 % of net sales .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Pharmaceuticals group Orion Corp reported a fall in its third-quarter earnings that were hit by larger expenditures on R&amp;D and marketing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: However , the growth margin slowed down due to the financial crisis .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: 2009 3 February 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR46m in the fourth quarter of 2009 from a year-earlier profit of EUR45m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Tiimari operates 194 stores in six countries -- including its core Finnish market -- and generated a turnover of 76.5 mln eur in 2005 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Finnish Talvivaara Mining Co HEL : TLV1V said Thursday it had picked BofA Merrill Lynch and JPMorgan NYSE : JPM as joint bookrunners of its planned issue of convertible notes worth up to EUR250m USD332m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The mall is part of the Baltic Pearl development project in the city of St Petersburg , where Baltic Pearl CJSC , a subsidiary of Shanghai Foreign Joint Investment Company , is developing homes for 35,000 people .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Vacon controls a further 5 % of the company via investment fund Power Fund I. EUR 1.0 = USD 1.397\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: 4 ) Complete name of the shareholder : Otto Henrik Bernhard Nyberg 5 ) Further information : The amount of shares now transferred corresponds to 5.68 % of the total number of shares in Aspo Plc. .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: It has some 30 offices worldwide and more than 90 pct of its net sales are generated outside Finland .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The contract value amounts to about EUR11m , the company added .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The business to be divested generates consolidated net sales of EUR 60 million annually and currently has some 640 employees .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Finnish Talentum reports its operating profit increased to EUR 20.5 mn in 2005 from EUR 9.3 mn in 2004 , and net sales totaled EUR 103.3 mn , up from EUR 96.4 mn .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>Another improvement! I am now pretty close to phi-2’s accuracy (91.94%).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T22:35:34.612544Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T22:35:34.611824Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T22:35:34.617153Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T22:35:34.616481Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T22:35:34.612486Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>0.9171122994652406</code></pre>
</div>
</div>
<p>Compared to Prompt P, this prompt yields a lower true positive rate for <code>negative</code> (291 &lt; 294) and <code>positive</code> (541 &lt; 562) sentiment but more than compensates for that with an increased true positive rate for <code>neutral</code> sentiment (1226 &gt; 1179).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T22:36:10.170897Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T22:36:10.170381Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T22:36:10.256802Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T22:36:10.256182Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T22:36:10.170879Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-110-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="index_files/figure-html/cell-110-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T22:36:16.290631Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T22:36:16.289695Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T22:36:16.313181Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T22:36:16.312515Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T22:36:16.290602Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_Q.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-r" class="level2">
<h2 class="anchored" data-anchor-id="prompt-r">Prompt R</h2>
<p>I’ll increase the number of examples and see if that improves performance.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:10:23.125814Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:10:23.125254Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:10:23.129052Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:10:23.128574Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:10:23.125785Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="co"># positive</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">348</span>, <span class="dv">349</span>, <span class="co"># negative</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>, <span class="dv">284</span>, <span class="dv">285</span>, <span class="dv">286</span>, <span class="dv">287</span>, <span class="dv">288</span>, <span class="dv">289</span> <span class="co"># neutral</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:10:25.272973Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:10:25.272145Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:10:25.280122Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:10:25.279564Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:10:25.272944Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 30)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:10:27.805790Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:10:27.805059Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:10:27.818831Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:10:27.818412Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:10:27.805766Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>promptR_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>promptR_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:10:32.377965Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:10:32.377110Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:12:06.347855Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:12:06.347151Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:10:32.377937Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptR_ds, promptJ, examples, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db465add5f944fab84d766a95730c8d9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'system', 'content': "You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change."}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Operating profit rose to EUR 13.1 mn from EUR 8.7 mn in the corresponding period in 2007 representing 7.7 % of net sales .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Operating profit totalled EUR 21.1 mn , up from EUR 18.6 mn in 2007 , representing 9.7 % of net sales .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Finnish Talentum reports its operating profit increased to EUR 20.5 mn in 2005 from EUR 9.3 mn in 2004 , and net sales totaled EUR 103.3 mn , up from EUR 96.4 mn .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Clothing retail chain Sepp+ñl+ñ 's sales increased by 8 % to EUR 155.2 mn , and operating profit rose to EUR 31.1 mn from EUR 17.1 mn in 2004 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Pharmaceuticals group Orion Corp reported a fall in its third-quarter earnings that were hit by larger expenditures on R&amp;D and marketing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: However , the growth margin slowed down due to the financial crisis .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: 2009 3 February 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR46m in the fourth quarter of 2009 from a year-earlier profit of EUR45m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: ( ADPnews ) - Feb 3 , 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR 46 million ( USD 64.5 m ) in the fourth quarter of 2009 from a\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Result before taxes decreased to nearly EUR 14.5 mn , compared to nearly EUR 20mn in the previous accounting period .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Tiimari operates 194 stores in six countries -- including its core Finnish market -- and generated a turnover of 76.5 mln eur in 2005 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Finnish Talvivaara Mining Co HEL : TLV1V said Thursday it had picked BofA Merrill Lynch and JPMorgan NYSE : JPM as joint bookrunners of its planned issue of convertible notes worth up to EUR250m USD332m .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The mall is part of the Baltic Pearl development project in the city of St Petersburg , where Baltic Pearl CJSC , a subsidiary of Shanghai Foreign Joint Investment Company , is developing homes for 35,000 people .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Vacon controls a further 5 % of the company via investment fund Power Fund I. EUR 1.0 = USD 1.397\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: 4 ) Complete name of the shareholder : Otto Henrik Bernhard Nyberg 5 ) Further information : The amount of shares now transferred corresponds to 5.68 % of the total number of shares in Aspo Plc. .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: It has some 30 offices worldwide and more than 90 pct of its net sales are generated outside Finland .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The contract value amounts to about EUR11m , the company added .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The business to be divested generates consolidated net sales of EUR 60 million annually and currently has some 640 employees .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The company generates net sales of about 600 mln euro $ 775.5 mln annually and employs 6,000 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The contract covers the manufacturing , surface-treatment and installation of the steel structures .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The order also includes start-up and commissioning services .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: The phones are targeted at first time users in growth markets .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Tielinja generated net sales of 7.5 mln euro $ 9.6 mln in 2005 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Tikkurila Powder Coatings has some 50 employees at its four paint plants , which generated revenues of EUR2 .4 m USD3 .3 m in 2010 .\nRespond with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nRespond with a single word: negative, positive, or neutral\nTEXT: Consolidated net sales increased 16 % to reach EUR74 .8 m , while operating profit amounted to EUR0 .9 m compared to a loss of EUR0 .7 m in the prior year period .\nRespond with a single word: negative, positive, or neutral"}]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>And with that I have surpassed phi-2!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:12:06.349595Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:12:06.349154Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:12:06.353708Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:12:06.352949Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:12:06.349576Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.9279319606087735</code></pre>
</div>
</div>
<p>Compared to Prompt P, this prompt yields a lower true positive rate for <code>negative</code> (290 &lt; 294) and <code>positive</code> (499 &lt; 562) sentiment but like Prompt Q, more than compensates for that with an increased true positive rate for <code>neutral</code> sentiment (1284 &gt; 1179).</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:12:06.355026Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:12:06.354822Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:12:06.454528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:12:06.453827Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:12:06.355011Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-117-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="index_files/figure-html/cell-117-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:12:06.456275Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:12:06.456057Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:12:06.479548Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:12:06.478906Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:12:06.456257Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3_R.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="running-inference-with-the-best-prompt-multiple-times" class="level2">
<h2 class="anchored" data-anchor-id="running-inference-with-the-best-prompt-multiple-times">Running Inference with the Best Prompt Multiple Times</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.979665Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.979505Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.982954Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.982335Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.979650Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="co"># positive</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">348</span>, <span class="dv">349</span>, <span class="co"># negative</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>, <span class="dv">284</span>, <span class="dv">285</span>, <span class="dv">286</span>, <span class="dv">287</span>, <span class="dv">288</span>, <span class="dv">289</span> <span class="co"># neutral</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.983842Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.983683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:47.994406Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:47.993865Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.983828Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>30</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:47.996130Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:47.995952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:48.019102Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:48.018673Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:47.996115Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>promptR_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>promptR_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2234
})</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:38:48.019989Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:38:48.019825Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:38:48.022582Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:38:48.022139Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:38:48.019975Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>promptJ <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:39:05.094316Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:39:05.093827Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:39:05.096980Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:39:05.096604Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:39:05.094298Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:39:12.437882Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:39:12.437616Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:39:12.441983Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:39:12.441400Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:39:12.437864Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. Consider terms like 'growth', 'decline', 'improvement', or 'deterioration' as indicators of change.</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:41:39.921805Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:41:39.921194Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:41:39.926446Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:41:39.925853Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:41:39.921781Z&quot;}" data-execution_count="18">
<details>
<summary>Show <code>test_gen</code> function</summary>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_gen(examples, sp):</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: promptJ.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: sp}] <span class="op">+</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: promptJ.<span class="bu">format</span>(text<span class="op">=</span>dataset[<span class="dv">0</span>][<span class="st">'sentence'</span>])}]</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>    generation_args <span class="op">=</span> { </span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>    responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> responses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model takes about 1.64 seconds to generate a response for a single dataset item, or about 1.01 hours for the 2234 items (on a Paperspace Free-A4000). Given the 6 hour limit, the max I can do is run inference on the dataset 5 times.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:43:40.097885Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:43:40.096982Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:45:34.570819Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:45:34.570259Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:43:40.097860Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> test_gen(examples, sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.64 s ± 3.04 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:46:23.039270Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:46:23.039031Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:46:23.045333Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:46:23.044430Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:46:23.039252Z&quot;}" data-execution_count="21">
<details>
<summary>Show <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples, sp):</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: sp}] <span class="op">+</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>accs <span class="op">=</span> []</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    df, acc <span class="op">=</span> few_shot_responses(promptR_ds, promptJ, examples, sp)</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    accs.append(acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The accuracy for this prompt is consistently around 92.7%.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-09-12T14:11:25.228720Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T14:11:25.227508Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T14:11:25.265651Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T14:11:25.264402Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T14:11:25.228671Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>pd.Series(accs).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>count    5.000000
mean     0.928111
std      0.000981
min      0.927484
25%      0.927484
50%      0.927484
75%      0.928380
max      0.929722
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Here is a summary of results including phi-2, phi-3.5, and the Claude family:</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
</tbody>
</table>
<p>Here is a summary of results from this notebook:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">prompt</th>
<th style="text-align: center;">strategy</th>
<th style="text-align: center;">accuracy</th>
<th style="text-align: center;">negative</th>
<th style="text-align: center;">neutral</th>
<th style="text-align: center;">positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-A">A</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">47.00%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">16% (220/1391)</td>
<td style="text-align: center;">96% (546/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-B">B</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">73.23%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">59% (821/1391)</td>
<td style="text-align: center;">94% (537/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-C">C</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">66.25%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">47% (650/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-D">D</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">49.65%</td>
<td style="text-align: center;"><u><strong>99% (301/303)</strong></u></td>
<td style="text-align: center;">19% (269/1391)</td>
<td style="text-align: center;">97% (554/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-E">E</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">72.44%</td>
<td style="text-align: center;">99% (299/303)</td>
<td style="text-align: center;">58% (803/1391)</td>
<td style="text-align: center;">94% (538/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-F">F</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">82.62%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">73% (1009/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-G">G</a></td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">76.13%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">62% (865/1387)</td>
<td style="text-align: center;">98% (557/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-H">H</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.10%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">73% (1021/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-I">I</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">81.16%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">70% (977/1390)</td>
<td style="text-align: center;">99% (563/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-J">J</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">84.61%</td>
<td style="text-align: center;">97% (294/302)</td>
<td style="text-align: center;">76% (1055/1390)</td>
<td style="text-align: center;"><u><strong>99% (564/569)<u></u></strong></u></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-K">K</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.19%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">74% (1024/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-L">L</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">87.35%</td>
<td style="text-align: center;">98% (295/302)</td>
<td style="text-align: center;">81% (1120/1390)</td>
<td style="text-align: center;">98% (560/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-M">M</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.41%</td>
<td style="text-align: center;">97% (292/302)</td>
<td style="text-align: center;">83% (1149/1390)</td>
<td style="text-align: center;">98% (558/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-N">N</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.28%</td>
<td style="text-align: center;">97% (293/302)</td>
<td style="text-align: center;">82% (1142/1390)</td>
<td style="text-align: center;">99% (561/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-O">O</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">88.59%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">82% (1145/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-P">P</a></td>
<td style="text-align: center;">3-Shot w/System Prompt</td>
<td style="text-align: center;">90.00%</td>
<td style="text-align: center;">97% (294/302)</td>
<td style="text-align: center;">85% (1179/1390)</td>
<td style="text-align: center;">99% (562/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-Q">Q</a></td>
<td style="text-align: center;">20-Shot w/System Prompt</td>
<td style="text-align: center;">91.71%</td>
<td style="text-align: center;">97% (291/299)</td>
<td style="text-align: center;">89% (1226/1379)</td>
<td style="text-align: center;">96% (541/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u><strong><a href="#prompt-R">R</a></strong></u></td>
<td style="text-align: center;"><u><strong>30-Shot w/System Prompt</strong></u></td>
<td style="text-align: center;"><u><strong>92.79%</strong></u></td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;"><u><strong>94% (1284/1373)</strong></u></td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
</tbody>
</table>
<p>I ran inference for phi-3 and phi-3.5 in separate notebooks at the same time, so I have shared final thoughts for both:</p>
<ul>
<li><strong>Few-shot prompting in a chat format is a different experience</strong>: The sentence/label pairs have to be presented as a multi-turn conversation. For a large number of examples, this can lead to running out of GPU memory (as it did for 30-Shot prompting with phi-3.5).</li>
<li><strong>Few-shot example proportion matters</strong>: I used a higher proportion of neutral examples in my 20-shot prompt since the majority of the dataset is made up of <code>neutral</code> sentences. Determining whether the proportion I used is optimal would require further experimentation.</li>
<li><strong>30-Shot phi-3 surpassed 6-Shot phi-2</strong>: Although it took more experimentation than I expected to do so. I was honestly expecting to try a couple of prompts and easily beat phi-2. I did not try a 30-Shot prompt with phi-2, so it may have performed equally well (or better). I’m not convinced that 24 more examples and 50% more parameters to yield ~0.8% more accuracy is worth it.</li>
<li><strong>30-Shot phi-3 surpassed 3-Shot Claude-3-Haiku</strong>: Again, I did not try 30-Shot prompting with Haiku, so it very well could have performed better. Regardless, I was not expecting phi-3 to beat Haiku’s score.</li>
<li><strong>The best performing prompt suffers from a low true positive rate for <code>positive</code> sentiments</strong>: Although the 30-Shot phi-3 prompt achieved the highest true positive rate (TPR) for <code>neutral</code> sentences (94%), it had the lowest TPR for <code>positive</code> sentences (88%). It’s unclear if this is due to the imbalance between <code>positive</code> and <code>neutral</code> examples, since the TPR for <code>negative</code> sentiment is high (98%) despite having the same number of examples (6) as <code>positive</code>.</li>
<li><strong>phi-3 performed differently than phi-3.5</strong>: phi-3 performed well with a system prompt while phi-3.5 did not. On the other hand, phi-3.5 performed better with 0-Shot prompting than phi-3 (results not shown here). <strong>Future work</strong>: My next step is to run inference on this dataset using the Qwen2-1.5B model. After that, I’ll analyze the errors, especially for sentences that a majority of models classified incorrectly. With prompt engineering, there is potentially unlimited future work. Before I finish this project, I’ll try 30-Shot prompts for phi-2 and Haiku to see if they can beat phi-3’s 92.79% overall accuracy (and maybe even phi-3.5’s 93.94% accuracy).</li>
</ul>
<p>I hope you enjoyed this blog post! Follow me on Twitter <a href="https://twitter.com/vishal_learner"><span class="citation" data-cites="vishal_learner">@vishal_learner</span></a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","selector":".lightbox","descPosition":"bottom","loop":true,"openEffect":"zoom"});</script>



</body></html>