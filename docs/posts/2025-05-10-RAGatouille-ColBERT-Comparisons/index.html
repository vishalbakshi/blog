<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2025-05-10">
<meta name="description" content="In this blog post I answer two questions: 1. For a given document collection and indexing configuration, do RAGatouille and ColBERT produce the same index? and 2. For a given index and search configuration, do RAGatouille and ColBERT retrieve the same passages/Recall@10?">

<title>Comparing RAGatouille and ColBERT Indexes and Search Results – Vishal Bakshi’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9c1ae87ad5063dce4f793ccd314a7566.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data">Load the Data</a></li>
  <li><a href="#create-ragatouille-index-1k-subset" id="toc-create-ragatouille-index-1k-subset" class="nav-link" data-scroll-target="#create-ragatouille-index-1k-subset">Create RAGatouille Index (1k subset)</a></li>
  <li><a href="#create-vanilla-colbert-index-1k-subset" id="toc-create-vanilla-colbert-index-1k-subset" class="nav-link" data-scroll-target="#create-vanilla-colbert-index-1k-subset">Create Vanilla ColBERT Index (1k subset)</a></li>
  <li><a href="#comparing-1k-subset-index-artifacts" id="toc-comparing-1k-subset-index-artifacts" class="nav-link" data-scroll-target="#comparing-1k-subset-index-artifacts">Comparing 1k subset Index Artifacts</a>
  <ul class="collapse">
  <li><a href="#codes.pt" id="toc-codes.pt" class="nav-link" data-scroll-target="#codes.pt">0.codes.pt</a></li>
  <li><a href="#residuals.pt" id="toc-residuals.pt" class="nav-link" data-scroll-target="#residuals.pt">0.residuals.pt</a></li>
  <li><a href="#centroids.pt" id="toc-centroids.pt" class="nav-link" data-scroll-target="#centroids.pt">centroids.pt</a></li>
  <li><a href="#ivf.pid.pt" id="toc-ivf.pid.pt" class="nav-link" data-scroll-target="#ivf.pid.pt">ivf.pid.pt</a></li>
  <li><a href="#buckets.pt" id="toc-buckets.pt" class="nav-link" data-scroll-target="#buckets.pt">buckets.pt</a></li>
  <li><a href="#avg_residual.pt" id="toc-avg_residual.pt" class="nav-link" data-scroll-target="#avg_residual.pt">avg_residual.pt</a></li>
  <li><a href="#doclens.0.json" id="toc-doclens.0.json" class="nav-link" data-scroll-target="#doclens.0.json">doclens.0.json</a></li>
  </ul></li>
  <li><a href="#indexing-full-conditionalqa-comparing-artifacts" id="toc-indexing-full-conditionalqa-comparing-artifacts" class="nav-link" data-scroll-target="#indexing-full-conditionalqa-comparing-artifacts">Indexing Full ConditionalQA + Comparing Artifacts</a>
  <ul class="collapse">
  <li><a href="#comparing-metadata" id="toc-comparing-metadata" class="nav-link" data-scroll-target="#comparing-metadata">Comparing Metadata</a></li>
  <li><a href="#comparing-index-artifacts" id="toc-comparing-index-artifacts" class="nav-link" data-scroll-target="#comparing-index-artifacts">Comparing Index Artifacts</a></li>
  </ul></li>
  <li><a href="#comparing-search-results" id="toc-comparing-search-results" class="nav-link" data-scroll-target="#comparing-search-results">Comparing Search Results</a>
  <ul class="collapse">
  <li><a href="#searching-ragatouille-index-with-ragatouille" id="toc-searching-ragatouille-index-with-ragatouille" class="nav-link" data-scroll-target="#searching-ragatouille-index-with-ragatouille">Searching RAGatouille Index with RAGatouille</a></li>
  <li><a href="#searching-the-colbert-index-with-colbert" id="toc-searching-the-colbert-index-with-colbert" class="nav-link" data-scroll-target="#searching-the-colbert-index-with-colbert">Searching the ColBERT Index with ColBERT</a></li>
  <li><a href="#searching-ragatouille-index-with-colbert-and-vice-versa" id="toc-searching-ragatouille-index-with-colbert-and-vice-versa" class="nav-link" data-scroll-target="#searching-ragatouille-index-with-colbert-and-vice-versa">Searching RAGatouille Index with ColBERT (and vice versa)</a></li>
  <li><a href="#searching-colbert-index-with-ragatouille" id="toc-searching-colbert-index-with-ragatouille" class="nav-link" data-scroll-target="#searching-colbert-index-with-ragatouille">Searching ColBERT Index with RAGatouille</a></li>
  </ul></li>
  <li><a href="#closing-thoughts" id="toc-closing-thoughts" class="nav-link" data-scroll-target="#closing-thoughts">Closing Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Comparing RAGatouille and ColBERT Indexes and Search Results</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">information retrieval</div>
    <div class="quarto-category">RAGatouille</div>
    <div class="quarto-category">ColBERT</div>
  </div>
  </div>

<div>
  <div class="description">
    In this blog post I answer two questions: 1. For a given document collection and indexing configuration, do RAGatouille and ColBERT produce the same index? and 2. For a given index and search configuration, do RAGatouille and ColBERT retrieve the same passages/Recall@10?
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="3522db3b-9d42-426d-9f78-36bf770e7c05" class="cell">
<details class="code-fold">
<summary>Show setup</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> faiss</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">hasattr</span>(faiss, <span class="st">"StandardGpuResources"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ragatouille <span class="im">import</span> RAGPretrainedModel</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytrec_eval</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ranx <span class="im">import</span> evaluate</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ranx <span class="im">import</span> Qrels, Run</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> srsly</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colbert <span class="im">import</span> Indexer</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colbert.infra <span class="im">import</span> RunConfig, ColBERTConfig</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colbert.infra.run <span class="im">import</span> Run</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colbert.data <span class="im">import</span> Queries</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colbert <span class="im">import</span> Searcher</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I am trying to answer two questions:</p>
<ol type="1">
<li>For a given document collection and indexing configuration, do RAGatouille and ColBERT produce the same index?</li>
<li>For a given index and search configuration, do RAGatouille and ColBERT retrieve the same passages/Recall@10?</li>
</ol>
<p>For this exercise, I’m using the UKPLab/DAPR’s ConditionalQA document collection which is 69k rows. If this exercise is successful, I’ll scale to larger document collections.</p>
<p>Here’s my rough plan:</p>
<ol type="1">
<li>Index the ConditionalQA document collection using RAGatouille and ColBERT. Be very thorough in ensuring the same configuration values are used.</li>
<li>Compare artifacts of the index (json and pt files). Document differences.</li>
<li>If successful, I would expect both indexes to largely be identical. If not, that’s a deeper dive.</li>
<li>Assuming successful equality of indexes, I’ll then perform search on the index using each framework, and compare retrieved passages and Recall@10. Initially, I’ll use RAGatouille search on the RAGatouille index, and ColBERT search on the ColBERT index. If that goes well, I might use one framework to search on the other’s index. RAGatouille requires some additional files so I’ll likely have to create them manually from the ColBERT index artifacts.</li>
<li>If I get similar Recall@10 and retrieved passages, great! If not, that’s a deeper dive.</li>
</ol>
</section>
<section id="load-the-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-data">Load the Data</h2>
<div id="9c609912-0058-4c49-95df-2c08a29021e9" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dataset_name <span class="op">=</span> <span class="st">"ConditionalQA"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dataset_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre><code>'ConditionalQA'</code></pre>
</div>
</div>
<div id="6a10253a-4d87-46d8-a922-6c85ce2ee06f" class="cell" data-execution_count="292">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>passages <span class="op">=</span> load_dataset(<span class="st">"UKPLab/dapr"</span>, <span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">-corpus"</span>, split<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>queries <span class="op">=</span> load_dataset(<span class="st">"UKPLab/dapr"</span>, <span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">-queries"</span>, split<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>qrels_rows <span class="op">=</span> load_dataset(<span class="st">"UKPLab/dapr"</span>, <span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">-qrels"</span>, split<span class="op">=</span><span class="st">"test"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-ragatouille-index-1k-subset" class="level2">
<h2 class="anchored" data-anchor-id="create-ragatouille-index-1k-subset">Create RAGatouille Index (1k subset)</h2>
<div id="3a2de694-4d3c-47b1-be93-96c87218c729" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>RAG <span class="op">=</span> RAGPretrainedModel.from_pretrained(<span class="st">"answerdotai/answerai-colbert-small-v1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6681a72d-48c1-460c-a654-33bb0ec20001" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>n_items <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n_items</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>1000</code></pre>
</div>
</div>
<p>Notes about <code>RAG.model.config</code> before indexing:</p>
<ul>
<li>The following values are <code>None</code>: <code>ncells</code>, <code>centroid_score_threshold</code>, <code>ndocs</code></li>
<li><code>kmeans_niters=4</code></li>
<li><code>nbits=1</code></li>
<li><code>index_bsize=64</code></li>
<li><code>bsize=32</code></li>
<li><code>dim=96</code></li>
<li><code>doc_maxlen=300</code></li>
<li><code>rank=0</code></li>
<li><code>nranks=4</code></li>
<li><code>gpus=4</code></li>
</ul>
<div id="0169e78c-14c4-4861-9777-03e989b6a6cd" class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>RAG.model.config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=None, centroid_score_threshold=None, ndocs=None, load_index_with_mmap=False, index_path=None, index_bsize=64, nbits=1, kmeans_niters=4, resume=False, pool_factor=1, clustering_mode='hierarchical', protected_tokens=0, similarity='cosine', bsize=32, accumsteps=1, lr=1e-05, maxsteps=15626, save_every=None, warmup=781, warmup_bert=None, relu=False, nway=32, use_ib_negatives=False, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name='answerdotai/AnswerAI-ColBERTv2.5-small', query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=96, doc_maxlen=300, mask_punctuation=True, checkpoint='/home/vishal/.cache/huggingface/hub/models--answerdotai--answerai-colbert-small-v1/snapshots/be1703c55532145a844da800eea4c9a692d7e267/', triples='/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl', collection='/home/bclavie/colbertv2.5_en/data/msmarco/collection.tsv', queries='/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv', index_name=None, overwrite=False, root='.ragatouille/', experiment='colbert', index_root=None, name='2024-08/07/08.16.20', rank=0, nranks=4, amp=True, gpus=4, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<div id="711dbfb8-0934-4693-a1c2-4aa09a7d2793" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!rm -rf .ragatouille/colbert/indexes/ConditionalQA_RAGatouille_index_1k</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="df9ef92a-f309-4fbf-a805-769f980db3c0" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>RAG_index_path <span class="op">=</span> RAG.index(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    index_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">_RAGatouille_index_1k"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    collection<span class="op">=</span>passages[:n_items][<span class="st">"text"</span>],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    document_ids<span class="op">=</span>passages[:n_items][<span class="st">"_id"</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    use_faiss<span class="op">=</span><span class="va">True</span> <span class="co"># to match ColBERT</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="24a51af0-edd0-4094-9871-e8f54235c55b" class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>du <span class="op">-</span>sh {RAG_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.2M    .ragatouille/colbert/indexes/ConditionalQA_RAGatouille_index_1k</code></pre>
</div>
</div>
<div id="e5100ce6-276e-41d7-8ff8-8c3a2017b09d" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls {RAG_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.codes.pt   avg_residual.pt  collection.json  metadata.json
0.metadata.json  buckets.pt   doclens.0.json   pid_docid_map.json
0.residuals.pt   centroids.pt     ivf.pid.pt       plan.json</code></pre>
</div>
</div>
<p>Notes about <code>metadata.json</code> <em>after</em> indexing:</p>
<ul>
<li>The following values are still <code>None</code>: <code>ncells</code>, <code>centroid_score_threshold</code>, <code>ndocs</code></li>
<li><code>kmeans_niters=20</code> (up from 4)</li>
<li><code>nbits=4</code> (up from 1)</li>
<li><code>index_bsize=64</code></li>
<li><code>bsize=64</code> (up from 32)</li>
<li><code>dim=96</code></li>
<li><code>doc_maxlen=256</code> (down from 300)</li>
<li><code>rank=0</code></li>
<li><code>nranks=1</code> (down from 4)</li>
<li><code>gpus=1</code> (down from 4)</li>
<li><code>'num_partitions'=1024</code> (not in original config)</li>
</ul>
<p>Inspecting the RAGatouille metadata:</p>
<div id="ffd3f36b-a608-4343-842f-7049e0bb09f8" class="cell" data-scrolled="true" data-execution_count="159">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/metadata.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    RAG_metadata <span class="op">=</span> json.load(f)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>RAG_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="159">
<pre><code>{'config': {'query_token_id': '[unused0]',
  'doc_token_id': '[unused1]',
  'query_token': '[Q]',
  'doc_token': '[D]',
  'ncells': None,
  'centroid_score_threshold': None,
  'ndocs': None,
  'load_index_with_mmap': False,
  'index_path': None,
  'index_bsize': 32,
  'nbits': 4,
  'kmeans_niters': 20,
  'resume': False,
  'pool_factor': 1,
  'clustering_mode': 'hierarchical',
  'protected_tokens': 0,
  'similarity': 'cosine',
  'bsize': 64,
  'accumsteps': 1,
  'lr': 1e-05,
  'maxsteps': 15626,
  'save_every': None,
  'warmup': 781,
  'warmup_bert': None,
  'relu': False,
  'nway': 32,
  'use_ib_negatives': False,
  'reranker': False,
  'distillation_alpha': 1.0,
  'ignore_scores': False,
  'model_name': 'answerdotai/AnswerAI-ColBERTv2.5-small',
  'query_maxlen': 32,
  'attend_to_mask_tokens': False,
  'interaction': 'colbert',
  'dim': 96,
  'doc_maxlen': 256,
  'mask_punctuation': True,
  'checkpoint': 'answerdotai/answerai-colbert-small-v1',
  'triples': '/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl',
  'collection': ['list with 1000 elements starting with...',
   ['Overview',
    'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
    'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.']],
  'queries': '/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv',
  'index_name': 'ConditionalQA_RAGatouille_index_1k',
  'overwrite': False,
  'root': '.ragatouille/',
  'experiment': 'colbert',
  'index_root': None,
  'name': '2025-05/09/10.30.23',
  'rank': 0,
  'nranks': 1,
  'amp': True,
  'gpus': 1,
  'avoid_fork_if_possible': False},
 'num_chunks': 1,
 'num_partitions': 1024,
 'num_embeddings': 15198,
 'avg_doclen': 15.198,
 'RAGatouille': {'index_config': {'index_type': 'PLAID',
   'index_name': 'ConditionalQA_RAGatouille_index_1k'}}}</code></pre>
</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 32%">
<col style="width: 30%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Before Indexing</th>
<th>After Indexing</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>kmeans_niters</code></td>
<td>4</td>
<td>20</td>
<td>5× more iterations for clustering</td>
</tr>
<tr class="even">
<td><code>nbits</code></td>
<td>1</td>
<td>4</td>
<td>4× more bits for residual compression</td>
</tr>
<tr class="odd">
<td><code>bsize</code></td>
<td>32</td>
<td>64</td>
<td>Doubled batch size</td>
</tr>
<tr class="even">
<td><code>doc_maxlen</code></td>
<td>300</td>
<td>256</td>
<td>Reduced document length limit</td>
</tr>
<tr class="odd">
<td><code>nranks</code></td>
<td>4</td>
<td>1</td>
<td>Changed to single-process execution</td>
</tr>
<tr class="even">
<td><code>gpus</code></td>
<td>4</td>
<td>1</td>
<td>Changed to single-GPU execution</td>
</tr>
<tr class="odd">
<td><code>num_partitions</code></td>
<td>(not set)</td>
<td>1024</td>
<td>New parameter added during indexing</td>
</tr>
</tbody>
</table>
<p>The following are search parameters so they are not set/used for indexing: <code>ncells</code>, <code>centroid_score_threshold</code>, <code>ndocs</code>.</p>
</section>
<section id="create-vanilla-colbert-index-1k-subset" class="level2">
<h2 class="anchored" data-anchor-id="create-vanilla-colbert-index-1k-subset">Create Vanilla ColBERT Index (1k subset)</h2>
<p>Next, I’ll index the same document collection using vanilla ColBERT (which is installed with RAGatouille).</p>
<div id="296400ca-0c19-4227-8cf3-437fbb331bfb" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dataset_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="160">
<pre><code>'ConditionalQA'</code></pre>
</div>
</div>
<div id="d004e602-fdd7-4e3f-9615-7be2c6260c43" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ColBERTConfig()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="161">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=None, centroid_score_threshold=None, ndocs=None, load_index_with_mmap=False, index_path=None, index_bsize=64, nbits=1, kmeans_niters=4, resume=False, pool_factor=1, clustering_mode='hierarchical', protected_tokens=0, similarity='cosine', bsize=32, accumsteps=1, lr=3e-06, maxsteps=500000, save_every=None, warmup=None, warmup_bert=None, relu=False, nway=2, use_ib_negatives=False, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name=None, query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=128, doc_maxlen=220, mask_punctuation=True, checkpoint=None, triples=None, collection=None, queries=None, index_name=None, overwrite=False, root='/mnt/my4tb/vishal_data/SuperPassage/experiments', experiment='default', index_root=None, name='2025-05/09/10.30.23', rank=0, nranks=1, amp=True, gpus=1, avoid_fork_if_possible=False)</code></pre>
</div>
</div>
<p>Key differences from this initial config and RAGatouille’s post-indexing metadata:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Parameter</th>
<th style="text-align: center;">RAGatouille value</th>
<th style="text-align: center;">ColBERT value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>kmeans_iter</code></td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>nbits</code></td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>dim</code></td>
<td style="text-align: center;">96</td>
<td style="text-align: center;">128</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>doc_maxlen</code></td>
<td style="text-align: center;">256</td>
<td style="text-align: center;">220</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>index_bsize</code></td>
<td style="text-align: center;">32</td>
<td style="text-align: center;">64</td>
</tr>
</tbody>
</table>
<p>I will set these explicitly in the ColBERTConfig before indexing.</p>
<div id="5d882d9f-6153-42ea-bb58-834830079f55" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>n_items</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="162">
<pre><code>1000</code></pre>
</div>
</div>
<p>The following environmental variable needs to be set otherwise the script won’t run.</p>
<div id="2e43ce9d-9990-47fd-a56d-8d9a8501fa96" class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"MKL_SERVICE_FORCE_INTEL"</span>] <span class="op">=</span> <span class="st">"1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ec8269b2-1777-4a18-83b7-df9491ac94db" class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!rm -rf /mnt/my4tb/vishal_data/SuperPassage/.ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_1k</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="feea96b5-ff50-46ea-be80-141b76536c77" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Run().context(RunConfig(nranks<span class="op">=</span><span class="dv">1</span>)):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> ColBERTConfig(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        doc_maxlen<span class="op">=</span><span class="dv">256</span>,      </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        nbits<span class="op">=</span><span class="dv">4</span>,             </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        dim<span class="op">=</span><span class="dv">96</span>,             </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        kmeans_niters<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        index_bsize<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        bsize<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        checkpoint<span class="op">=</span><span class="st">"answerdotai/answerai-colbert-small-v1"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    indexer <span class="op">=</span> Indexer(checkpoint<span class="op">=</span><span class="st">"answerdotai/answerai-colbert-small-v1"</span>, config<span class="op">=</span>config)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    indexer.index(name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">_ColBERT_index_1k"</span>, collection<span class="op">=</span>passages[:n_items][<span class="st">"text"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="077cda6a-2093-4c3a-8083-471eb47eebf3" class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ColBERT_index_path <span class="op">=</span> <span class="st">".ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_1k"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ColBERT index is a tiny bit smaller than RAGatouille, likely because it doesn’t store the collection as a JSON file and doesn’t store pid to docid map as a JSON file (which RAGatouille does—something we’ll encounter later on during search).</p>
<div id="2316914c-3da7-42a3-9a69-4369aae484df" class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>du <span class="op">-</span>sh {ColBERT_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.1M    .ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_1k</code></pre>
</div>
</div>
<div id="7d95b7ff-1c24-439e-83ce-e281ea34f102" class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls {ColBERT_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.codes.pt   0.residuals.pt   buckets.pt    doclens.0.json  metadata.json
0.metadata.json  avg_residual.pt  centroids.pt  ivf.pid.pt  plan.json</code></pre>
</div>
</div>
<div id="2bcf5fc6-f471-4c6f-a6b3-36b10ae2e973" class="cell" data-scrolled="true" data-execution_count="170">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/metadata.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    ColBERT_metadata <span class="op">=</span> json.load(f)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ColBERT_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="170">
<pre><code>{'config': {'query_token_id': '[unused0]',
  'doc_token_id': '[unused1]',
  'query_token': '[Q]',
  'doc_token': '[D]',
  'ncells': None,
  'centroid_score_threshold': None,
  'ndocs': None,
  'load_index_with_mmap': False,
  'index_path': None,
  'index_bsize': 32,
  'nbits': 4,
  'kmeans_niters': 20,
  'resume': False,
  'pool_factor': 1,
  'clustering_mode': 'hierarchical',
  'protected_tokens': 0,
  'similarity': 'cosine',
  'bsize': 64,
  'accumsteps': 1,
  'lr': 1e-05,
  'maxsteps': 15626,
  'save_every': None,
  'warmup': 781,
  'warmup_bert': None,
  'relu': False,
  'nway': 32,
  'use_ib_negatives': False,
  'reranker': False,
  'distillation_alpha': 1.0,
  'ignore_scores': False,
  'model_name': 'answerdotai/AnswerAI-ColBERTv2.5-small',
  'query_maxlen': 32,
  'attend_to_mask_tokens': False,
  'interaction': 'colbert',
  'dim': 96,
  'doc_maxlen': 256,
  'mask_punctuation': True,
  'checkpoint': 'answerdotai/answerai-colbert-small-v1',
  'triples': '/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl',
  'collection': ['list with 1000 elements starting with...',
   ['Overview',
    'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
    'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.']],
  'queries': '/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv',
  'index_name': 'ConditionalQA_ColBERT_index_1k',
  'overwrite': False,
  'root': '.ragatouille/',
  'experiment': 'colbert',
  'index_root': None,
  'name': '2025-05/09/10.30.23',
  'rank': 0,
  'nranks': 1,
  'amp': True,
  'gpus': 1,
  'avoid_fork_if_possible': False},
 'num_chunks': 1,
 'num_partitions': 1024,
 'num_embeddings': 15198,
 'avg_doclen': 15.198}</code></pre>
</div>
</div>
</section>
<section id="comparing-1k-subset-index-artifacts" class="level2">
<h2 class="anchored" data-anchor-id="comparing-1k-subset-index-artifacts">Comparing 1k subset Index Artifacts</h2>
<p>RAGatouille files:</p>
<ul>
<li>0.codes.pt<br>
</li>
<li>0.residuals.pt</li>
<li>buckets.pt<br>
</li>
<li>doclens.0.json</li>
<li>metadata.json</li>
<li>0.metadata.json</li>
<li>avg_residual.pt</li>
<li>centroids.pt</li>
<li>ivf.pid.pt</li>
<li>plan.json</li>
<li>collection.json (unique to RAGatouille)</li>
<li>pid_docid_map.json (unique to RAGatouille)</li>
</ul>
<p>ColBERT files:</p>
<ul>
<li>0.codes.pt</li>
<li>0.residuals.pt</li>
<li>buckets.pt</li>
<li>doclens.0.json</li>
<li>metadata.json</li>
<li>0.metadata.json</li>
<li>avg_residual.pt</li>
<li>centroids.pt<br>
</li>
<li>ivf.pid.pt<br>
</li>
<li>plan.json</li>
</ul>
<p>All parameters relevant to indexing are matching in the corresponding metadata.json files:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
<th style="text-align: center;">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>index_bsize</code></td>
<td style="text-align: left;">32</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>nbits</code></td>
<td style="text-align: left;">4</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>kmeans_niters</code></td>
<td style="text-align: left;">20</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>dim</code></td>
<td style="text-align: left;">96</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>doc_maxlen</code></td>
<td style="text-align: left;">256</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>num_partitions</code></td>
<td style="text-align: left;">1024</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>num_embeddings</code></td>
<td style="text-align: left;">15198</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>avg_doclen</code></td>
<td style="text-align: left;">15.198</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>checkpoint</code></td>
<td style="text-align: left;">‘answerdotai/answerai-colbert-small-v1’</td>
<td style="text-align: center;">✅ Matches</td>
</tr>
</tbody>
</table>
<p>Walking through each file and comparing contents:</p>
<div id="5d14b941-de6f-4326-b610-89796907e18a" class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _compare_pt(r_path, c_path):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> torch.load(r_path)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> torch.load(c_path)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(r,<span class="bu">tuple</span>):</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"0 shape:"</span>, r[<span class="dv">0</span>].shape, c[<span class="dv">0</span>].shape)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r[<span class="dv">0</span>])</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(c[<span class="dv">0</span>])</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"0 match: "</span>, (r[<span class="dv">0</span>] <span class="op">==</span> c[<span class="dv">0</span>]).<span class="bu">float</span>().mean())</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'#'</span><span class="op">*</span><span class="dv">30</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"1 shape:"</span>, r[<span class="dv">1</span>].shape, c[<span class="dv">1</span>].shape)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r[<span class="dv">1</span>])</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(c[<span class="dv">1</span>])</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"1 match: "</span>, (r[<span class="dv">1</span>] <span class="op">==</span> c[<span class="dv">1</span>]).<span class="bu">float</span>().mean())</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(c)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r.shape, c.shape)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"match: "</span>,(r <span class="op">==</span> c).<span class="bu">float</span>().mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="codes.pt" class="level3">
<h3 class="anchored" data-anchor-id="codes.pt">0.codes.pt</h3>
<div id="d43ca0a1-a161-4be2-94fb-9de4cedf59fd" class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/0.codes.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/0.codes.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([345, 288, 647,  ..., 232, 767,  29], dtype=torch.int32)


tensor([345, 288, 647,  ..., 232, 767,  29], dtype=torch.int32)


torch.Size([15198]) torch.Size([15198])


match:  tensor(1.)</code></pre>
</div>
</div>
</section>
<section id="residuals.pt" class="level3">
<h3 class="anchored" data-anchor-id="residuals.pt">0.residuals.pt</h3>
<div id="296fb874-a6be-4bb1-87ec-fc34cc0a2bc5" class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/0.residuals.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/0.residuals.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[ 30, 225, 225,  ..., 238, 238,  30],
        [238, 238, 238,  ..., 238, 238, 238],
        [240, 254, 253,  ..., 175, 240, 128],
        ...,
        [ 99, 105, 231,  ...,  40,  95,  48],
        [ 85, 241,  87,  ..., 128,   8, 179],
        [ 89, 106, 150,  ..., 162, 238,  22]], dtype=torch.uint8)


tensor([[ 30, 225, 225,  ..., 238, 238,  30],
        [238, 238, 238,  ..., 238, 238, 238],
        [240, 254, 253,  ..., 175, 240, 128],
        ...,
        [ 99, 105, 231,  ...,  40,  95,  48],
        [ 85, 241,  87,  ..., 128,   8, 179],
        [ 89, 106, 150,  ..., 162, 238,  22]], dtype=torch.uint8)


torch.Size([15198, 48]) torch.Size([15198, 48])


match:  tensor(1.)</code></pre>
</div>
</div>
</section>
<section id="centroids.pt" class="level3">
<h3 class="anchored" data-anchor-id="centroids.pt">centroids.pt</h3>
<div id="8726c303-0691-4bc2-92b9-7bc391129273" class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/centroids.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/centroids.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[-0.0701,  0.0035, -0.0785,  ...,  0.1628,  0.0201, -0.0419],
        [-0.0350, -0.0082, -0.0715,  ...,  0.1119, -0.0159, -0.1164],
        [-0.0753,  0.0172, -0.0513,  ...,  0.1070,  0.1476, -0.0699],
        ...,
        [-0.1425,  0.1393, -0.2316,  ...,  0.0169,  0.0897, -0.0431],
        [-0.0690,  0.0513, -0.0935,  ...,  0.1311,  0.0324, -0.0705],
        [-0.0812,  0.0511, -0.0482,  ...,  0.1010,  0.0365, -0.0582]],
       device='cuda:0', dtype=torch.float16)


tensor([[-0.0701,  0.0035, -0.0785,  ...,  0.1628,  0.0201, -0.0419],
        [-0.0350, -0.0082, -0.0715,  ...,  0.1119, -0.0159, -0.1164],
        [-0.0753,  0.0172, -0.0513,  ...,  0.1070,  0.1476, -0.0699],
        ...,
        [-0.1425,  0.1393, -0.2316,  ...,  0.0169,  0.0897, -0.0431],
        [-0.0690,  0.0513, -0.0935,  ...,  0.1311,  0.0324, -0.0705],
        [-0.0812,  0.0511, -0.0482,  ...,  0.1010,  0.0365, -0.0582]],
       device='cuda:0', dtype=torch.float16)


torch.Size([1024, 96]) torch.Size([1024, 96])


match:  tensor(1., device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="ivf.pid.pt" class="level3">
<h3 class="anchored" data-anchor-id="ivf.pid.pt">ivf.pid.pt</h3>
<div id="d67ac41f-cbd5-42f1-a6cf-5fdad9c84381" class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/ivf.pid.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/ivf.pid.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 shape: torch.Size([11696]) torch.Size([11696])
tensor([889, 894, 916,  ...,   0,   0,   0], dtype=torch.int32)
tensor([889, 894, 916,  ...,   0,   0,   0], dtype=torch.int32)


0 match:  tensor(1.)


##############################


1 shape: torch.Size([1024]) torch.Size([1024])
tensor([ 5, 46, 16,  ...,  7, 11,  3])
tensor([ 5, 46, 16,  ...,  7, 11,  3])


1 match:  tensor(1.)</code></pre>
</div>
</div>
</section>
<section id="buckets.pt" class="level3">
<h3 class="anchored" data-anchor-id="buckets.pt">buckets.pt</h3>
<div id="c324e81e-d261-40c9-87aa-acc68ba64f5d" class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/buckets.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/buckets.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 shape: torch.Size([15]) torch.Size([15])
tensor([-0.0310, -0.0208, -0.0148, -0.0101, -0.0065, -0.0037, -0.0015,  0.0000,
         0.0016,  0.0037,  0.0067,  0.0103,  0.0150,  0.0210,  0.0312],
       device='cuda:0')
tensor([-0.0310, -0.0208, -0.0148, -0.0101, -0.0065, -0.0037, -0.0015,  0.0000,
         0.0016,  0.0037,  0.0067,  0.0103,  0.0150,  0.0210,  0.0312],
       device='cuda:0')


0 match:  tensor(1., device='cuda:0')


##############################


1 shape: torch.Size([16]) torch.Size([16])
tensor([-0.0417, -0.0248, -0.0175, -0.0123, -0.0082, -0.0050, -0.0025, -0.0006,
         0.0007,  0.0026,  0.0051,  0.0084,  0.0125,  0.0178,  0.0251,  0.0417],
       device='cuda:0', dtype=torch.float16)
tensor([-0.0417, -0.0248, -0.0175, -0.0123, -0.0082, -0.0050, -0.0025, -0.0006,
         0.0007,  0.0026,  0.0051,  0.0084,  0.0125,  0.0178,  0.0251,  0.0417],
       device='cuda:0', dtype=torch.float16)


1 match:  tensor(1., device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="avg_residual.pt" class="level3">
<h3 class="anchored" data-anchor-id="avg_residual.pt">avg_residual.pt</h3>
<div id="cd32d8f9-e2bf-4fa7-8950-9082666ccf65" class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>_compare_pt(r_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/avg_residual.pt"</span>, c_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/avg_residual.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor(0.0150, device='cuda:0', dtype=torch.float16)


tensor(0.0150, device='cuda:0', dtype=torch.float16)


torch.Size([]) torch.Size([])


match:  tensor(1., device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="doclens.0.json" class="level3">
<h3 class="anchored" data-anchor-id="doclens.0.json">doclens.0.json</h3>
<div id="c6eabd97-125b-4502-b30a-42d4b7099fbe" class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/doclens.0.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    RAGatouille_doclens <span class="op">=</span> json.load(f)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>RAGatouille_doclens[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="180">
<pre><code>[4, 20, 18, 23, 8]</code></pre>
</div>
</div>
<div id="1e491dce-39c9-4a5b-85f3-32ed4c422cbc" class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/doclens.0.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    ColBERT_doclens <span class="op">=</span> json.load(f)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>ColBERT_doclens[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="181">
<pre><code>[4, 20, 18, 23, 8]</code></pre>
</div>
</div>
<div id="26d9b761-9880-4a0d-a47b-125b8c3b70b7" class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>RAGatouille_doclens <span class="op">==</span> ColBERT_doclens</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="182">
<pre><code>True</code></pre>
</div>
</div>
<p>Based on these comparisons, I can conclude that ColBERT and RAGatouille do indeed produce identical index artifacts given the same configuration and document collection!</p>
</section>
</section>
<section id="indexing-full-conditionalqa-comparing-artifacts" class="level2">
<h2 class="anchored" data-anchor-id="indexing-full-conditionalqa-comparing-artifacts">Indexing Full ConditionalQA + Comparing Artifacts</h2>
<p>With a 1k subset confirmed, I’ll now index the full ConditionalQA document collection, which contains ~70k rows.</p>
<div id="4dc307f2-934b-48ee-aaf7-6fb84a82519f" class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>dataset_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="183">
<pre><code>'ConditionalQA'</code></pre>
</div>
</div>
<div id="3d60f235-9a3f-416d-b076-2931efe2797d" class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(passages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre><code>69199</code></pre>
</div>
</div>
<div id="99595696-05bf-43df-a9b4-8e25f97a8c75" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>RAG <span class="op">=</span> RAGPretrainedModel.from_pretrained(<span class="st">"answerdotai/answerai-colbert-small-v1"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>RAG_index_path <span class="op">=</span> RAG.index(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    index_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">_RAGatouille_index_full"</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    collection<span class="op">=</span>passages[<span class="st">"text"</span>],</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    document_ids<span class="op">=</span>passages[<span class="st">"_id"</span>],</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    use_faiss<span class="op">=</span><span class="va">True</span> <span class="co"># to match ColBERT</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a57481c3-aca3-4dff-ae93-a4e701bc40d7" class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>du <span class="op">-</span>sh {RAG_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>45M .ragatouille/colbert/indexes/ConditionalQA_RAGatouille_index_full</code></pre>
</div>
</div>
<div id="c4d11b3b-616b-4cba-bfab-2bf744265c45" class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls {RAG_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.codes.pt   1.residuals.pt   buckets.pt       doclens.2.json
0.metadata.json  2.codes.pt   centroids.pt     ivf.pid.pt
0.residuals.pt   2.metadata.json  collection.json  metadata.json
1.codes.pt   2.residuals.pt   doclens.0.json   pid_docid_map.json
1.metadata.json  avg_residual.pt  doclens.1.json   plan.json</code></pre>
</div>
</div>
<div id="4f5385d8-c03e-4ad2-8a00-3508ad730564" class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!rm -rf .ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_full</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cfbe7e0c-c4b4-4651-a1ea-28aa9fe7e23d" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"MKL_SERVICE_FORCE_INTEL"</span>] <span class="op">=</span> <span class="st">"1"</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Run().context(RunConfig(nranks<span class="op">=</span><span class="dv">1</span>)):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> ColBERTConfig(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        doc_maxlen<span class="op">=</span><span class="dv">256</span>,      </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        nbits<span class="op">=</span><span class="dv">2</span>,  <span class="co"># to match RAGatouille           </span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        dim<span class="op">=</span><span class="dv">96</span>,             </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        kmeans_niters<span class="op">=</span><span class="dv">10</span>, <span class="co"># to match RAGatouille</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        index_bsize<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        bsize<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        checkpoint<span class="op">=</span><span class="st">"answerdotai/answerai-colbert-small-v1"</span>,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    indexer <span class="op">=</span> Indexer(checkpoint<span class="op">=</span><span class="st">"answerdotai/answerai-colbert-small-v1"</span>, config<span class="op">=</span>config)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    indexer.index(name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">_ColBERT_index_full"</span>, collection<span class="op">=</span>passages[<span class="st">"text"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a79f8069-0215-4b0b-a7f4-a27e6ae63416" class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>ColBERT_index_path <span class="op">=</span> <span class="st">".ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_full"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4cc1acdd-2a9d-464f-afea-c457f000142f" class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>du <span class="op">-</span>sh {ColBERT_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>38M .ragatouille/colbert/indexes/ConditionalQA_ColBERT_index_full</code></pre>
</div>
</div>
<div id="3a19a735-3308-464c-bdb2-eeccce195c08" class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls {ColBERT_index_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.codes.pt   1.residuals.pt   buckets.pt      ivf.pid.pt
0.metadata.json  2.codes.pt   centroids.pt    metadata.json
0.residuals.pt   2.metadata.json  doclens.0.json  plan.json
1.codes.pt   2.residuals.pt   doclens.1.json
1.metadata.json  avg_residual.pt  doclens.2.json</code></pre>
</div>
</div>
<section id="comparing-metadata" class="level3">
<h3 class="anchored" data-anchor-id="comparing-metadata">Comparing Metadata</h3>
<p>All key metadata parameters are equivalent between the RAGatouille and ColBERT indexes.</p>
<div id="fcb215de-50c1-48a6-b8a5-4018a15ea098" class="cell" data-execution_count="221">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> [<span class="st">"index_bsize"</span>, <span class="st">"nbits"</span>, <span class="st">"kmeans_niters"</span>, <span class="st">"bsize"</span>, <span class="st">"dim"</span>, <span class="st">"rank"</span>, <span class="st">"gpus"</span>, <span class="st">"nranks"</span>, <span class="st">"num_chunks"</span>, <span class="st">"num_partitions"</span>, <span class="st">"num_embeddings"</span>, <span class="st">"avg_doclen"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="837e2100-78f5-4d18-920b-34029fa491c2" class="cell" data-scrolled="true" data-execution_count="222">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/metadata.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    RAG_metadata <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="04f07e6a-f065-4237-8e01-f73be27cca39" class="cell" data-scrolled="true" data-execution_count="223">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/metadata.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    ColBERT_metadata <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c0a7cb0b-891a-453d-ab06-411a7e32c4d0" class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> params: </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"num_chunks"</span>, <span class="st">"num_partitions"</span>, <span class="st">"num_embeddings"</span>, <span class="st">"avg_doclen"</span>]: <span class="cf">assert</span> RAG_metadata[<span class="st">'config'</span>][p] <span class="op">==</span> ColBERT_metadata[<span class="st">'config'</span>][p], p</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> p <span class="op">==</span> <span class="st">"avg_doclen"</span>: <span class="cf">assert</span> (RAG_metadata[p] <span class="op">-</span> ColBERT_metadata[p]) <span class="op">&lt;</span> <span class="fl">1e-7</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="cf">assert</span> RAG_metadata[p] <span class="op">==</span> ColBERT_metadata[p], p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="comparing-index-artifacts" class="level3">
<h3 class="anchored" data-anchor-id="comparing-index-artifacts">Comparing Index Artifacts</h3>
<div id="731a8a9f-5450-4e9a-a862-0a9465d11318" class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _compare_pt(r_path, c_path):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> torch.load(r_path)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> torch.load(c_path)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(r,<span class="bu">tuple</span>):</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> r[<span class="dv">0</span>].shape <span class="op">==</span> c[<span class="dv">0</span>].shape</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (r[<span class="dv">0</span>] <span class="op">==</span> c[<span class="dv">0</span>]).<span class="bu">float</span>().mean() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (r[<span class="dv">1</span>] <span class="op">==</span> c[<span class="dv">1</span>]).<span class="bu">float</span>().mean() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> r.shape <span class="op">==</span> c.shape</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (r <span class="op">==</span> c).<span class="bu">float</span>().mean() <span class="op">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7646a39f-af14-4621-a219-2c295215a2ef" class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"0.codes.pt"</span>,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"0.residuals.pt"</span>,</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"centroids.pt"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ivf.pid.pt"</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"buckets.pt"</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avg_residual.pt"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"doclens.0.json"</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cf2cd589-f586-4e51-8cba-39bba101858d" class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f <span class="op">==</span> <span class="st">"doclens.0.json"</span>: </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">"</span>, <span class="st">'r'</span>) <span class="im">as</span> _f: RAG_doclens <span class="op">=</span> json.load(_f)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">"</span>, <span class="st">'r'</span>) <span class="im">as</span> _f: ColBERT_doclens <span class="op">=</span> json.load(_f)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> RAG_doclens <span class="op">==</span> ColBERT_doclens</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: _compare_pt(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All index artifacts are equivalent! This further confirms the equivalency of the indexes created by RAGatouille and ColBERT.</p>
</section>
</section>
<section id="comparing-search-results" class="level2">
<h2 class="anchored" data-anchor-id="comparing-search-results">Comparing Search Results</h2>
<p>To reset, I had started this exploration with two questions:</p>
<ol type="1">
<li>For a given document collection and indexing configuration, do RAGatouille and ColBERT produce the same index?</li>
<li>For a given index and search configuration, do RAGatouille and ColBERT retrieve the same passages/Recall@10?</li>
</ol>
<p>The answer to the first question is YES. Let’s move on to answering the second question, starting by searching the RAGatouille index with RAGatouille.</p>
<section id="searching-ragatouille-index-with-ragatouille" class="level3">
<h3 class="anchored" data-anchor-id="searching-ragatouille-index-with-ragatouille">Searching RAGatouille Index with RAGatouille</h3>
<p>I will explicitly set search parameters for RAGatouille, even though they get set based on document collection size in <a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L266"><code>PLAIDModelIndex._load_searcher</code></a>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> force_fast:</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.searcher.configure(ndocs<span class="op">=</span><span class="dv">1024</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.searcher.configure(ncells<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.searcher.collection) <span class="op">&lt;</span> <span class="dv">10000</span>:</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.searcher.configure(ncells<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.searcher.configure(centroid_score_threshold<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">len</span>(<span class="va">self</span>.searcher.collection) <span class="op">&lt;</span> <span class="dv">100000</span>:</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.searcher.configure(ncells<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.searcher.configure(centroid_score_threshold<span class="op">=</span><span class="fl">0.45</span>)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Otherwise, use defaults for k</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use fast settingss</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.searcher.configure(ncells<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.searcher.configure(centroid_score_threshold<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.searcher.configure(ndocs<span class="op">=</span><span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="d22e109f-942a-4e54-94f2-dadd431d976b" class="cell" data-execution_count="244">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>RAG.model.config.ncells <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>RAG.model.config.centroid_score_threshold <span class="op">=</span> <span class="fl">0.45</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>RAG.model.config.ndocs <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>RAG.model.config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="244">
<pre><code>ColBERTConfig(query_token_id='[unused0]', doc_token_id='[unused1]', query_token='[Q]', doc_token='[D]', ncells=4, centroid_score_threshold=0.45, ndocs=1024, load_index_with_mmap=False, index_path=None, index_bsize=32, nbits=2, kmeans_niters=10, resume=False, pool_factor=1, clustering_mode='hierarchical', protected_tokens=0, similarity='cosine', bsize=32, accumsteps=1, lr=1e-05, maxsteps=15626, save_every=None, warmup=781, warmup_bert=None, relu=False, nway=32, use_ib_negatives=False, reranker=False, distillation_alpha=1.0, ignore_scores=False, model_name='answerdotai/AnswerAI-ColBERTv2.5-small', query_maxlen=32, attend_to_mask_tokens=False, interaction='colbert', dim=96, doc_maxlen=256, mask_punctuation=True, checkpoint='/home/vishal/.cache/huggingface/hub/models--answerdotai--answerai-colbert-small-v1/snapshots/be1703c55532145a844da800eea4c9a692d7e267/', triples='/home/bclavie/colbertv2.5_en/data/msmarco/triplets.jsonl', collection='/home/bclavie/colbertv2.5_en/data/msmarco/collection.tsv', queries='/home/bclavie/colbertv2.5_en/data/msmarco/queries.tsv', index_name=None, overwrite=False, root='.ragatouille/colbert/indexes', experiment='colbert', index_root=None, name='2024-08/07/08.16.20', rank=0, nranks=4, amp=True, gpus=4, avoid_fork_if_possible=True)</code></pre>
</div>
</div>
<div id="bc3ddcbb-d5e5-4d49-b77f-44698d2c5d8d" class="cell" data-execution_count="422">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>ragatouille_results <span class="op">=</span> {}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="df4f1f89-68b6-46e9-857b-b305f83a1eeb" class="cell" data-scrolled="true" data-execution_count="423">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> queries:</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> RAG.search(q[<span class="st">'text'</span>], k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    ragatouille_results[q[<span class="st">'_id'</span>]] <span class="op">=</span> {result[<span class="st">'document_id'</span>]: <span class="bu">float</span>(result[<span class="st">'score'</span>]) <span class="cf">for</span> result <span class="kw">in</span> results}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1497a78d-aeb9-4945-9383-3c70166317c4" class="cell" data-execution_count="424">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>ragatouille_results[<span class="st">'dev-0'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="424">
<pre><code>{'107-242': 69.9375,
 '496-116': 69.9375,
 '86-28': 69.875,
 '254-4': 69.875,
 '107-103': 69.875,
 '8-67': 69.8125,
 '98-46': 69.8125,
 '8-80': 69.8125,
 '8-116': 69.8125,
 '107-43': 69.8125}</code></pre>
</div>
</div>
<p>The mean Recall@10 for all 271 queries is 0.29.</p>
<div id="8d1c4e70-fe30-4dc3-8781-cb82ecc398a2" class="cell" data-execution_count="429">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>qrels <span class="op">=</span> {}</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> qrel_row <span class="kw">in</span> qrels_rows:</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    qid <span class="op">=</span> qrel_row[<span class="st">"query_id"</span>]</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> qrel_row[<span class="st">"corpus_id"</span>]</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    rel <span class="op">=</span> qrel_row[<span class="st">"score"</span>]</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    qrels.setdefault(qid, {})</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    qrels[qid][pid] <span class="op">=</span> rel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6c4c4442-843d-4d71-90a1-9e61c689a6bc" class="cell" data-execution_count="430">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> pytrec_eval.RelevanceEvaluator(qrels, {<span class="st">'recall.10'</span>})</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> evaluator.evaluate(ragatouille_results)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(metrics) <span class="op">==</span> <span class="bu">len</span>(<span class="bu">set</span>(qrels_rows[<span class="st">"query_id"</span>]))</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>mean_recall <span class="op">=</span> <span class="bu">sum</span>(metrics[qid][<span class="st">'recall_10'</span>] <span class="cf">for</span> qid <span class="kw">in</span> metrics.keys()) <span class="op">/</span> <span class="bu">len</span>(metrics)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>mean_recall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="430">
<pre><code>0.2855810510889169</code></pre>
</div>
</div>
</section>
<section id="searching-the-colbert-index-with-colbert" class="level3">
<h3 class="anchored" data-anchor-id="searching-the-colbert-index-with-colbert">Searching the ColBERT Index with ColBERT</h3>
<p>Next, I’ll search the ColBERT index with ColBERT, setting the same configuration values as RAGatouille.</p>
<div id="fc99ef77-2343-4799-bdd7-02d3e33cbf4b" class="cell" data-execution_count="297">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>RAG.model.config.ncells, <span class="op">\</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>RAG.model.config.centroid_score_threshold, <span class="op">\</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>RAG.model.config.ndocs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="297">
<pre><code>(4, 0.45, 1024)</code></pre>
</div>
</div>
<p>ColBERT expects the queries to be structured as a dictionary, so I’ll prepare that accordingly:</p>
<div id="2542ecd0-31d4-41c2-8e66-b8ea11e70327" class="cell" data-execution_count="425">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>queries_dict <span class="op">=</span> {}</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> queries:</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    queries_dict[item[<span class="st">'_id'</span>]] <span class="op">=</span> item[<span class="st">'text'</span>]</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(queries_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="425">
<pre><code>271</code></pre>
</div>
</div>
<p>I was posting on Twitter about how I wasn’t getting the same search results when using RAGatouille and vanilla ColBERT given the same index. <a href="https://ben.clavie.eu/">Benjamin Clavie</a>, the author of RAGatouille, kindly took some time to explain a core difference in how RAGatouille and ColBERT process queries:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
Oh that'll be because ragatouille has a policy to never truncate queries so it updates the querylen to be <em>at least</em> the actual query length (further tests show it should be querylen + 8 at least, to get better augmentation). Your colbert (stanford) config is truncating to 32…
</p>
— Ben Clavié (<span class="citation" data-cites="bclavie">@bclavie</span>) <a href="https://twitter.com/bclavie/status/1921056639739678751?ref_src=twsrc%5Etfw">May 10, 2025</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>As was shared in his tweet, <a href="https://github.com/AnswerDotAI/RAGatouille/blob/2bd4d2ed01c847854be78704a012f9ab35d679b2/ragatouille/models/index.py#L298">RAGatouille uses a larger maximum query length than ColBERT</a>. ColBERT uses a default of 32. So to replicate the same scores (and therefore the same top-k retrieved passages) I needed to mimic RAGatouille’s query length maximum.</p>
<p>Note that ColBERT doesn’t store original passage <code>_id</code>s like RAGatouille does, so I have to extract it from the original <code>passages</code> with <code>passages[idx]['_id']</code>.</p>
<div id="20797fcf-3979-4b77-ab09-cf0f63a949fc" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>current_dir <span class="op">=</span> os.path.abspath(<span class="st">"."</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>index_root <span class="op">=</span> os.path.join(current_dir, <span class="st">".ragatouille"</span>, <span class="st">"colbert"</span>, <span class="st">"indexes"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>colbert_results <span class="op">=</span> {}</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> queries:</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    query_length <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(q[<span class="st">'text'</span>].split(<span class="st">" "</span>)) <span class="op">*</span> <span class="fl">1.35</span>) <span class="co"># this lines comes from RAGatouille</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Run().context(RunConfig(nranks<span class="op">=</span><span class="dv">1</span>)):</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        searcher <span class="op">=</span> Searcher(</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span><span class="st">"ConditionalQA_ColBERT_index_full"</span>,</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>            index_root<span class="op">=</span>index_root,  </span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>ColBERTConfig(</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>                ncells<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>                centroid_score_threshold<span class="op">=</span><span class="fl">0.45</span>,</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>                ndocs<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>                query_maxlen<span class="op">=</span>query_length</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>        ranking <span class="op">=</span> searcher.search(q[<span class="st">'text'</span>], k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>        colbert_results[q[<span class="st">'_id'</span>]] <span class="op">=</span> {passages[idx][<span class="st">'_id'</span>]: score <span class="cf">for</span> idx, score <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">zip</span>(ranking[<span class="dv">0</span>], ranking[<span class="dv">2</span>]))}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0c4c0a50-30c7-474d-8f89-c166c8908512" class="cell" data-execution_count="427">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> pytrec_eval.RelevanceEvaluator(qrels, {<span class="st">'recall.10'</span>})</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> evaluator.evaluate(colbert_results)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(metrics) <span class="op">==</span> <span class="bu">len</span>(<span class="bu">set</span>(qrels_rows[<span class="st">"query_id"</span>]))</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>mean_recall <span class="op">=</span> <span class="bu">sum</span>(metrics[qid][<span class="st">'recall_10'</span>] <span class="cf">for</span> qid <span class="kw">in</span> metrics.keys()) <span class="op">/</span> <span class="bu">len</span>(metrics)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>mean_recall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="427">
<pre><code>0.2855810510889169</code></pre>
</div>
</div>
<p>With the maximum query length adjusted, ColBERT yields the same Recall@10 as RAGatouille! This makes sense because as Benjamin said in another tweet reply:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
It's most likely down to the default search settings in ragatouille being a bit more aggressive, so you end up with better results. If you change ncells/score_thresh/ndocs to more aggressive values I reckon the colbert library would match it? All ragatouille does under the hood is wrap things with strong defaults/abstractions 😄
</p>
— Ben Clavié (<span class="citation" data-cites="bclavie">@bclavie</span>) <a href="https://twitter.com/bclavie/status/1921052397314732447?ref_src=twsrc%5Etfw">May 10, 2025</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>While the exact same recall is a good check, I’ll double check that for each query, the retrieved passage IDs and scores are identical between RAGatouille and ColBERT.</p>
<div id="e3ea66a7-7c8a-4b39-b199-e8a9412484e3" class="cell" data-execution_count="428">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> colbert_results.keys():</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid, score <span class="kw">in</span> colbert_results[i].items():</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> ragatouille_results[i][pid] <span class="op">==</span> score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="searching-ragatouille-index-with-colbert-and-vice-versa" class="level3">
<h3 class="anchored" data-anchor-id="searching-ragatouille-index-with-colbert-and-vice-versa">Searching RAGatouille Index with ColBERT (and vice versa)</h3>
<p>As a final check of consistency, I’ll search the RAGatouille index with ColBERT and search the ColBERT index with RAGatouille and confirm that they yield the same retrieved passages and Recall@10.</p>
<div id="29b4c47d-7f20-405b-a974-34d4830a74f9" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>current_dir <span class="op">=</span> os.path.abspath(<span class="st">"."</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>index_root <span class="op">=</span> os.path.join(current_dir, <span class="st">".ragatouille"</span>, <span class="st">"colbert"</span>, <span class="st">"indexes"</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>colbert_results2 <span class="op">=</span> {}</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> queries:</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    query_length <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(q[<span class="st">'text'</span>].split(<span class="st">" "</span>)) <span class="op">*</span> <span class="fl">1.35</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Run().context(RunConfig(nranks<span class="op">=</span><span class="dv">1</span>)):</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        searcher <span class="op">=</span> Searcher(</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span><span class="st">"ConditionalQA_RAGatouille_index_full"</span>,</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>            index_root<span class="op">=</span>index_root,  </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>ColBERTConfig(</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>                ncells<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>                centroid_score_threshold<span class="op">=</span><span class="fl">0.45</span>,</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>                ndocs<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>                query_maxlen<span class="op">=</span>query_length</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        ranking <span class="op">=</span> searcher.search(q[<span class="st">'text'</span>], k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>        colbert_results2[q[<span class="st">'_id'</span>]] <span class="op">=</span> {passages[idx][<span class="st">'_id'</span>]: score <span class="cf">for</span> idx, score <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">zip</span>(ranking[<span class="dv">0</span>], ranking[<span class="dv">2</span>]))}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get the same results as searching the ColBERT index with ColBERT! This again further proves that these two frameworks produce the same indexes (which is to be expected).</p>
<div id="6863e54c-d5aa-41c2-82c9-9686a3d4f187" class="cell" data-execution_count="432">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> colbert_results.keys():</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid, score <span class="kw">in</span> colbert_results[i].items():</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> colbert_results2[i][pid] <span class="op">==</span> score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="23ccaf41-c28a-437b-98f0-4154e95770fb" class="cell" data-execution_count="433">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> pytrec_eval.RelevanceEvaluator(qrels, {<span class="st">'recall.10'</span>})</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> evaluator.evaluate(colbert_results2)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(metrics) <span class="op">==</span> <span class="bu">len</span>(<span class="bu">set</span>(qrels_rows[<span class="st">"query_id"</span>]))</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>mean_recall <span class="op">=</span> <span class="bu">sum</span>(metrics[qid][<span class="st">'recall_10'</span>] <span class="cf">for</span> qid <span class="kw">in</span> metrics.keys()) <span class="op">/</span> <span class="bu">len</span>(metrics)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>mean_recall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="433">
<pre><code>0.2855810510889169</code></pre>
</div>
</div>
<p>Finally, as the last piece of this exercise, I’ll search the ColBERT index with RAGatouille and see if I get the same result. I certainly expect to!</p>
</section>
<section id="searching-colbert-index-with-ragatouille" class="level3">
<h3 class="anchored" data-anchor-id="searching-colbert-index-with-ragatouille">Searching ColBERT Index with RAGatouille</h3>
<p>RAGatouille creates two files (collection.json and pid_docid_map.json) which ColBERT does not, so we have to create them manually for RAGatouille to search the ColBERT Index.</p>
<p>collection.json is just a list of the document collection text.</p>
<div id="e9fc9172-88ba-4aaf-95dc-88a6929f7d41" class="cell" data-execution_count="434">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/collection.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    RAG_collection <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="61b48a62-9c52-40db-bb39-2e058d4c953f" class="cell" data-execution_count="435">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(RAG_collection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="435">
<pre><code>69199</code></pre>
</div>
</div>
<div id="90c05267-ea50-4264-8c08-12d904edfd97" class="cell" data-execution_count="436">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>RAG_collection[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="436">
<pre><code>['Overview',
 'You can only make a claim for Child Tax Credit if you already get Working Tax Credit.',
 'If you cannot apply for Child Tax Credit, you can apply for Universal Credit instead.',
 'You might be able to apply for Pension Credit if you and your partner are State Pension age or over.',
 'What you’ll get']</code></pre>
</div>
</div>
<p>pid_docid_map.json is a dictionary where the keys are the index in the collection and the values are the dataset’s defined <code>_id</code> string.</p>
<div id="8ff4615a-29c5-41c6-b32f-7263666c8b10" class="cell" data-execution_count="437">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>RAG_index_path<span class="sc">}</span><span class="ss">/pid_docid_map.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    RAG_pid_docid_map <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1d4c11a1-281f-45b5-803d-ef270f410cb9" class="cell" data-execution_count="438">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(RAG_pid_docid_map.items())[<span class="dv">0</span>], <span class="bu">list</span>(RAG_pid_docid_map.items())[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="438">
<pre><code>(('0', '0-0'), ('69198', '651-91'))</code></pre>
</div>
</div>
<div id="1b2b52c8-f593-4f20-be7e-0c43c4e49407" class="cell" data-execution_count="439">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>passages[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="439">
<pre><code>{'_id': '651-91',
 'text': 'Trade union reps can be on picket lines at different workplaces if they’re responsible for organising workers in those workplaces.',
 'title': 'Taking part in industrial action and strikes',
 'doc_id': '651',
 'paragraph_no': 91,
 'total_paragraphs': 92,
 'is_candidate': True}</code></pre>
</div>
</div>
<p>Saving the collection as a JSON is simple enough, I just dump <code>passages['text']</code> into a JSON file.</p>
<div id="c9d2fd17-5017-49a3-9970-4fc87ae3f583" class="cell" data-execution_count="289">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>srsly.write_json(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/collection.json"</span>, passages[<span class="st">'text'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating pid_docid_map.json is also quite straightforward. I map from the index of the passage item to its <code>_id</code>.</p>
<div id="0a9d228b-4dbd-4484-a7ea-4396afcc9f40" class="cell" data-execution_count="440">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>pid_docid_map <span class="op">=</span> {<span class="bu">str</span>(i): p[<span class="st">'_id'</span>] <span class="cf">for</span> i,p <span class="kw">in</span> <span class="bu">enumerate</span>(passages)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="175333e7-23ff-48f7-917e-9a31fba3e120" class="cell" data-execution_count="441">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(pid_docid_map.items())[<span class="dv">0</span>], <span class="bu">list</span>(pid_docid_map.items())[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="441">
<pre><code>(('0', '0-0'), ('69198', '651-91'))</code></pre>
</div>
</div>
<div id="5622a5ba-554b-4229-b8c2-e1e9c46aca22" class="cell" data-execution_count="287">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>srsly.write_json(<span class="ss">f"</span><span class="sc">{</span>ColBERT_index_path<span class="sc">}</span><span class="ss">/pid_docid_map.json"</span>, pid_docid_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s make sure these match the RAGatouille-built artifacts:</p>
<div id="e55e05e7-e3ae-44a8-b2e4-b9d71008064d" class="cell" data-execution_count="442">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, _id <span class="kw">in</span> RAG_pid_docid_map.items(): <span class="cf">assert</span> _id <span class="op">==</span> pid_docid_map[i]</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, _id <span class="kw">in</span> pid_docid_map.items(): <span class="cf">assert</span> _id <span class="op">==</span> RAG_pid_docid_map[i]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With those two files created, I can now create a <code>RAGPretrainedModel</code> object <code>from_index</code> using the ColBERT index.</p>
<div id="058cbd58-2dfb-4e6b-b002-f4160596dcd0" class="cell" data-execution_count="443">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>RAG2 <span class="op">=</span> RAGPretrainedModel.from_index(ColBERT_index_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Constructing default index configuration for index `None` as it does not contain RAGatouille specific metadata.</code></pre>
</div>
</div>
<div id="e575a2b9-9cf8-4573-bbd8-221b71ffd29d" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>RAG2.model.config.ncells <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>RAG2.model.config.centroid_score_threshold <span class="op">=</span> <span class="fl">0.45</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>RAG2.model.config.ndocs <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>ragatouille_results2 <span class="op">=</span> {}</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> queries:</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> RAG2.search(q[<span class="st">'text'</span>], k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    ragatouille_results2[q[<span class="st">'_id'</span>]] <span class="op">=</span> {result[<span class="st">'document_id'</span>]: <span class="bu">float</span>(result[<span class="st">'score'</span>]) <span class="cf">for</span> result <span class="kw">in</span> results}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get the same results as searching the RAGatouille index with RAGatouille, searching the ColBERT index with ColBERT and searching the RAGatouille index with ColBERT!</p>
<div id="72f2902c-47ff-477f-a12b-08c3aff19422" class="cell" data-execution_count="445">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> colbert_results.keys():</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid, score <span class="kw">in</span> colbert_results[i].items():</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> ragatouille_results2[i][pid] <span class="op">==</span> score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2cafc7e9-57d7-4158-9808-8405871d0225" class="cell" data-execution_count="446">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> pytrec_eval.RelevanceEvaluator(qrels, {<span class="st">'recall.10'</span>})</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> evaluator.evaluate(ragatouille_results2)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(metrics) <span class="op">==</span> <span class="bu">len</span>(<span class="bu">set</span>(qrels_rows[<span class="st">"query_id"</span>]))</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>mean_recall <span class="op">=</span> <span class="bu">sum</span>(metrics[qid][<span class="st">'recall_10'</span>] <span class="cf">for</span> qid <span class="kw">in</span> metrics.keys()) <span class="op">/</span> <span class="bu">len</span>(metrics)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>mean_recall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="446">
<pre><code>0.2855810510889169</code></pre>
</div>
</div>
</section>
</section>
<section id="closing-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="closing-thoughts">Closing Thoughts</h2>
<p>Every interaction I’ve had with RAGatouille and ColBERT has been an awesome learning experience. I feel like inspecting their behavior and artifacts as left me with a better understanding of information retrieval in general. One small learning that I left out: ColBERT uses FAISS for k-means clustering while for small document collections (such as my initial 1k subset) RAGatouille uses a PyTorch implementation. This difference, even though all relevant configuration parameters were equal, resulted in different index artifacts. There was only about a 15% overlap between the <code>centroids.pt</code> tensors of the resulting RAGatouille and ColBERT indexes.</p>
<p>Another piece of motivation for me is that I needed to use both RAGatouille and ColBERT for indexing the full set of UKPLab/DAPR document collections, as ColBERT was able to index the larger collections (6M+) without crashing the kernel, while RAGatouille was not. In some initial experiments I was getting different mean Recall@10 values when using RAGatouille versus when using ColBERT (because I hadn’t incorporated the max query length code and probably had different configs). So I felt like this was a good opportunity, once and for all, to answer the two questions I listed at the start of this notebook:</p>
<ol type="1">
<li>For a given document collection and indexing configuration, do RAGatouille and ColBERT produce the same index?</li>
<li>For a given index and search configuration, do RAGatouille and ColBERT retrieve the same passages/Recall@10?</li>
</ol>
<p>The answer for both, is a resounding yes! With this knowledge in my belt, I can now move forward with indexing and searching with either library as I please.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vishalbakshi\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>