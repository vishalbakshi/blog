<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-09-12">
<meta name="description" content="In this blog post I use phi-3.5 to classify sentiment in the financial_phrasebank dataset with 93.94% accuracy.">

<title>Sentiment Classification with phi-3.5 – Vishal Bakshi’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9c1ae87ad5063dce4f793ccd314a7566.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#prompt-a" id="toc-prompt-a" class="nav-link" data-scroll-target="#prompt-a">Prompt A</a></li>
  <li><a href="#prompt-b" id="toc-prompt-b" class="nav-link" data-scroll-target="#prompt-b">Prompt B</a></li>
  <li><a href="#prompt-c" id="toc-prompt-c" class="nav-link" data-scroll-target="#prompt-c">Prompt C</a></li>
  <li><a href="#prompt-d" id="toc-prompt-d" class="nav-link" data-scroll-target="#prompt-d">Prompt D</a></li>
  <li><a href="#prompt-e" id="toc-prompt-e" class="nav-link" data-scroll-target="#prompt-e">Prompt E</a></li>
  <li><a href="#prompt-f" id="toc-prompt-f" class="nav-link" data-scroll-target="#prompt-f">Prompt F</a></li>
  <li><a href="#prompt-g" id="toc-prompt-g" class="nav-link" data-scroll-target="#prompt-g">Prompt G</a></li>
  <li><a href="#prompt-h" id="toc-prompt-h" class="nav-link" data-scroll-target="#prompt-h">Prompt H</a></li>
  <li><a href="#prompt-i" id="toc-prompt-i" class="nav-link" data-scroll-target="#prompt-i">Prompt I</a></li>
  <li><a href="#prompt-j" id="toc-prompt-j" class="nav-link" data-scroll-target="#prompt-j">Prompt J</a></li>
  <li><a href="#prompt-k" id="toc-prompt-k" class="nav-link" data-scroll-target="#prompt-k">Prompt K</a></li>
  <li><a href="#prompt-l" id="toc-prompt-l" class="nav-link" data-scroll-target="#prompt-l">Prompt L</a></li>
  <li><a href="#prompt-m" id="toc-prompt-m" class="nav-link" data-scroll-target="#prompt-m">Prompt M</a></li>
  <li><a href="#prompt-n" id="toc-prompt-n" class="nav-link" data-scroll-target="#prompt-n">Prompt N</a></li>
  <li><a href="#prompt-o" id="toc-prompt-o" class="nav-link" data-scroll-target="#prompt-o">Prompt O</a></li>
  <li><a href="#prompt-p" id="toc-prompt-p" class="nav-link" data-scroll-target="#prompt-p">Prompt P</a></li>
  <li><a href="#prompt-q" id="toc-prompt-q" class="nav-link" data-scroll-target="#prompt-q">Prompt Q</a></li>
  <li><a href="#prompt-r" id="toc-prompt-r" class="nav-link" data-scroll-target="#prompt-r">Prompt R</a></li>
  <li><a href="#prompt-s" id="toc-prompt-s" class="nav-link" data-scroll-target="#prompt-s">Prompt S</a></li>
  <li><a href="#prompt-t" id="toc-prompt-t" class="nav-link" data-scroll-target="#prompt-t">Prompt T</a></li>
  <li><a href="#running-inference-with-the-best-prompt-multiple-times" id="toc-running-inference-with-the-best-prompt-multiple-times" class="nav-link" data-scroll-target="#running-inference-with-the-best-prompt-multiple-times">Running Inference with the Best Prompt Multiple Times</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sentiment Classification with phi-3.5</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">LLM</div>
    <div class="quarto-category">TinySentiment</div>
  </div>
  </div>

<div>
  <div class="description">
    In this blog post I use phi-3.5 to classify sentiment in the <code>financial_phrasebank</code> dataset with 93.94% accuracy.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="cell-2" class="cell">
<details class="code-fold">
<summary>Show pip installs</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install torch<span class="op">==</span><span class="fl">2.3.1</span> <span class="op">-</span>qq</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install accelerate<span class="op">==</span><span class="fl">0.31.0</span> <span class="op">-</span>qq</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install transformers<span class="op">==</span><span class="fl">4.41.2</span> <span class="op">-</span>qq</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install huggingface_hub <span class="op">-</span>qq</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install datasets<span class="op">~=</span><span class="fl">2.16.1</span> <span class="op">-</span>qq</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install plotly<span class="op">==</span><span class="fl">5.19.0</span> <span class="op">-</span>qq</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn<span class="op">==</span><span class="fl">1.2</span> <span class="op">-</span>qq</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install pynvml <span class="op">-</span>qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-3" class="cell">
<details class="code-fold">
<summary>Show imports and setup</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, ConfusionMatrixDisplay</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.api.types <span class="im">import</span> CategoricalDtype</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report_gpu():</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(torch.cuda.list_gpu_processes())</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    gc.collect()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    torch.cuda.empty_cache()</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#warnings.filterwarnings("ignore")</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset, Dataset</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer, pipeline </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers.pipelines.pt_utils <span class="im">import</span> KeyDataset</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">#torch.set_default_device("cuda")</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>model_nm <span class="op">=</span> <span class="st">"microsoft/Phi-3.5-mini-instruct"</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained( </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    model_nm,  </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    device_map<span class="op">=</span><span class="st">"cuda"</span>,  </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    torch_dtype<span class="op">=</span><span class="st">"auto"</span>,  </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    trust_remote_code<span class="op">=</span><span class="va">True</span>,  </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(model_nm)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> pipeline( </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text-generation"</span>, </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model, </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    tokenizer<span class="op">=</span>tokenizer, </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># load dataset</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"financial_phrasebank"</span>, <span class="st">"sentences_allagree"</span>, </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    split<span class="op">=</span><span class="st">"train"</span>  <span class="co"># note that the dataset does not have a default test split</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.637296Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.635721Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.731681Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.731221Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.637268Z&quot;}}">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new column with the numeric label verbalised as label_text (e.g. "positive" instead of "0")</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>label_map <span class="op">=</span> {i: label_text <span class="cf">for</span> i, label_text <span class="kw">in</span> <span class="bu">enumerate</span>(dataset.features[<span class="st">"label"</span>].names)}</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_label_text(example):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    example[<span class="st">"label_text"</span>] <span class="op">=</span> label_map[example[<span class="st">"label"</span>]]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> example</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_label_text)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.733598Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.732874Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.738812Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.738359Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.733576Z&quot;}}" data-execution_count="5">
<details class="code-fold">
<summary>Show <code>add_prompt</code> and <code>generate_responses</code> functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_prompt(item, prompt):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        item[<span class="st">'prompt'</span>] <span class="op">=</span> prompt.<span class="bu">format</span>(text<span class="op">=</span>item[<span class="st">'sentence'</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> item</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_responses(dataset, prompt):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that the prompt is correctly formatted</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset[<span class="dv">0</span>][<span class="st">'prompt'</span>])</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'---------'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        ] </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.740157Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.739469Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.753695Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.753249Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.740138Z&quot;}}" data-execution_count="6">
<details class="code-fold">
<summary>Show <code>generate_response</code> function</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_response(prompt):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt},</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    ] </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    generation_args <span class="op">=</span> { </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> output[<span class="dv">0</span>][<span class="st">'generated_text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.755529Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.754846Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.772413Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.771764Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.755510Z&quot;}}" data-execution_count="7">
<details class="code-fold">
<summary>Show <code>make_cm</code> function</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_cm(df):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create confusion matrix for true vs predicted sentiment classes"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true<span class="op">=</span>df[<span class="st">'label_text'</span>], y_pred<span class="op">=</span>df[<span class="st">'responses'</span>], labels<span class="op">=</span>[<span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'other'</span>])</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    disp <span class="op">=</span> ConfusionMatrixDisplay(cm, display_labels<span class="op">=</span>[<span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'other'</span>])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I chose 8x8 so it fits on one screen but still is large</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    disp.plot(ax<span class="op">=</span>ax,text_kw<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">16</span>}, cmap<span class="op">=</span><span class="st">'Blues'</span>, colorbar<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change label font size without changing label text</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.label.set_fontsize(<span class="dv">18</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.label.set_fontsize(<span class="dv">18</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make tick labels larger</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.773673Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.773216Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.790228Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.789771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.773673Z&quot;}}" data-execution_count="8">
<details class="code-fold">
<summary>Show <code>ds_subset</code> function</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ds_subset(dataset, exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(dataset)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> idxs <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> exclude_idxs]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    ddf <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    new_ds <span class="op">=</span> Dataset.from_pandas(ddf.iloc[idxs, columns])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In this notebook I’ll use <a href="https://huggingface.co/microsoft/Phi-3.5-mini-instruct">Phi-3-5-mini-4k-instruct</a> to classify sentiment in the <a href="https://huggingface.co/datasets/financial_phrasebank"><code>financial_phrasebank</code> dataset</a>. In previous notebooks I have performed <a href="https://vishalbakshi.github.io/blog/posts/2024-08-31-tinysentiment-phi-2-sentiment-classification/">sentiment classification with phi-2</a> and <a href="https://vishalbakshi.github.io/blog/posts/2024-08-29-tinysentiment-claude-experiments/">the Claude series</a>.</p>
<p>This notebook is part of <a href="https://vishalbakshi.github.io/blog/#category=TinySentiment">a series of blog posts</a> for a project I’m working called TinySentiment where I’m experimenting with tiny models to improve their ability to classify sentiment in the <code>financial_phrasebank dataset</code>. I was inspired to do so after reading <a href="https://huggingface.co/blog/synthetic-data-save-costs">this blog post</a> and <a href="https://github.com/MoritzLaurer/synthetic-data-blog/blob/main/notebooks/synthetic_data_creation.ipynb">this corresponding notebook</a> by Moritz Laurer as part of a fastai study group last year.</p>
<p>Here are the results from my experiments so far (**the best-performing prompt from this notebook):</p>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">**phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">ph-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
</tbody>
</table>
<p>Here are the per-prompt results from this notebook (phi-3.5):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">prompt</th>
<th style="text-align: center;">strategy</th>
<th style="text-align: center;">accuracy</th>
<th style="text-align: center;">negative</th>
<th style="text-align: center;">neutral</th>
<th style="text-align: center;">positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-A">A</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">62.32%</td>
<td style="text-align: center;">98% (296/303)</td>
<td style="text-align: center;">43% (592/1391)</td>
<td style="text-align: center;">92% (523/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-B">B</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">88.60%</td>
<td style="text-align: center;">96% (290/303)</td>
<td style="text-align: center;">87% (1215/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-C">C</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">83.48%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">76% (1062/1391)</td>
<td style="text-align: center;">93% (530/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-D">D</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">68.64%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">51% (713/1391)</td>
<td style="text-align: center;">95% (541/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-E">E</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">88.25%</td>
<td style="text-align: center;">96% (290/303)</td>
<td style="text-align: center;">87% (1207/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-F">F</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">84.65%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">77% (1070/1390)</td>
<td style="text-align: center;">96% (548/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-G">G</a></td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">77.99%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">66% (913/1387)</td>
<td style="text-align: center;">97% (551/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-H">H</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.06%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">74% (1028/1390)</td>
<td style="text-align: center;">97% (554/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-I">I</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">51.61%</td>
<td style="text-align: center;"><u><strong>100% (302/302)</strong></u></td>
<td style="text-align: center;">32% (447/1390)</td>
<td style="text-align: center;">73% (418/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-J">J</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">85.94%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">80% (1108/1390)</td>
<td style="text-align: center;">95% (539/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-K">K</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">77.96%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">66% (919/1391)</td>
<td style="text-align: center;">96% (548/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-L">L</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">80.57%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">70% (972/1391)</td>
<td style="text-align: center;"><u><strong>97% (555/570)</strong></u></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-M">M</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">91.30%</td>
<td style="text-align: center;">97% (294/303)</td>
<td style="text-align: center;">90% (1257/1391)</td>
<td style="text-align: center;">91% (516/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-N">N</a></td>
<td style="text-align: center;">0-Shot w/System Prompt</td>
<td style="text-align: center;">88.74%</td>
<td style="text-align: center;">97% (295/303)</td>
<td style="text-align: center;">85% (1184/1391)</td>
<td style="text-align: center;">93% (530/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-O">O</a></td>
<td style="text-align: center;">0-Shot w/System Prompt</td>
<td style="text-align: center;">87.10%</td>
<td style="text-align: center;">94% (285/303)</td>
<td style="text-align: center;">83% (1156/1391)</td>
<td style="text-align: center;">93% (531/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-P">P</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">92.23%</td>
<td style="text-align: center;">94% (285/303)</td>
<td style="text-align: center;">94% (1307/1391)</td>
<td style="text-align: center;">87% (496/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-Q">Q</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">79.37%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">73% (1009/1391)</td>
<td style="text-align: center;">86% (488/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u><strong><a href="#prompt-R">R</a></strong></u></td>
<td style="text-align: center;"><u><strong>20-Shot</strong></u></td>
<td style="text-align: center;"><u><strong>93.94%</strong></u></td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-S">S</a></td>
<td style="text-align: center;">28-Shot</td>
<td style="text-align: center;">93.25%</td>
<td style="text-align: center;">94% (281/298)</td>
<td style="text-align: center;">99% (1358/1373)</td>
<td style="text-align: center;">79% (446/565)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-T">T</a></td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">84.54%</td>
<td style="text-align: center;">78% (232/299)</td>
<td style="text-align: center;"><u><strong>99.9% (1378/1379)</strong></u></td>
<td style="text-align: center;">51% (287/566)</td>
</tr>
</tbody>
</table>
</section>
<section id="prompt-a" class="level2">
<h2 class="anchored" data-anchor-id="prompt-a">Prompt A</h2>
<p>The HuggingFace model card for Phi-3-5 Mini-4K-Instruct says:</p>
<blockquote class="blockquote">
<p>Given the nature of the training data, the Phi-3.5-mini-instruct model is best suited for prompts using the chat format</p>
</blockquote>
<p>So, the first prompt I’ll try will be a simple instruction:</p>
<div id="cell-16" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:40.018837Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:40.018545Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:02:40.022232Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:02:40.021652Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:40.018819Z&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>promptA <span class="op">=</span> <span class="st">"""Label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:41.247165Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:41.246867Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:02:41.255051Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:02:41.254389Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:41.247141Z&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> dataset[<span class="dv">1</span>][<span class="st">"sentence"</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>"For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m ."</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:46.015818Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:46.015183Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:02:46.020146Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:02:46.019285Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:46.015791Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>formatted_prompt <span class="op">=</span> promptA.<span class="bu">format</span>(text<span class="op">=</span>text)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</code></pre>
</div>
</div>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:47.909112Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:47.908357Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:02:48.865358Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:02:48.864639Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:47.909080Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>' Negative'</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:51.716386Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:51.715735Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:02:51.832068Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:02:51.831049Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:51.716359Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 101 ms, sys: 9.29 ms, total: 111 ms
Wall time: 109 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>' Negative'</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:02:55.830009Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:02:55.828992Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:03:02.265808Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:03:02.265236Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:02:55.829979Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> generate_response(formatted_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>91.9 ms ± 1.59 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<p>Good–at least it works! Although it looks like I’ll have to strip the outputs of whitespace and convert them to lowercase. It takes about 0.1 seconds to generate the response, so it should take about 4 minutes to run inference on the whole dataset.</p>
<div id="cell-23" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:04:21.999316Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:04:21.998952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:07:55.903348Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:07:55.902566Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:04:21.999292Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"14ff8c0d5eb244f79e948b69742b6751","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
---------</code></pre>
</div>
</div>
<div id="cell-24" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:07:55.905841Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:07:55.904872Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:07:55.910901Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:07:55.910048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:07:55.905814Z&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>0.6232332155477032</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:11:02.525509Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:11:02.525041Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:11:02.529941Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:11:02.529251Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:11:02.525488Z&quot;}}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:11:04.197739Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:11:04.197046Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:11:04.218321Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:11:04.217816Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:11:04.197713Z&quot;}}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_A.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This prompt struggled with the <code>neutral</code> sentiment, as 568/1391 were misclassified as something other than <code>positive</code>, <code>neutral</code> or <code>negative</code>.</p>
<div id="cell-28" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:11:05.544808Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:11:05.544141Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:11:05.633516Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:11:05.632959Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:11:05.544780Z&quot;}}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prompt-b" class="level2">
<h2 class="anchored" data-anchor-id="prompt-b">Prompt B</h2>
<p>I’ll repeat the instruction after the sentence and see if that improves the performance (as it did for phi-2).</p>
<div id="cell-31" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:13:39.968208Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:13:39.967800Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:13:39.972114Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:13:39.971194Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:13:39.968176Z&quot;}}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>promptB <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:13:53.990465Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:13:53.989888Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:17:26.823921Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:17:26.823201Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:13:53.990444Z&quot;}}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8516adff265d4dcab181a62b59653fc1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>The accuracy jumps up from 62.3% to 88.6%! Repeating the instruction after the dataset item was something I learned to do in fastai study group.</p>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:17:26.827209Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:17:26.827044Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:17:26.831332Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:17:26.830690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:17:26.827194Z&quot;}}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.8860424028268551</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:19:01.457993Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:19:01.457629Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:19:01.463234Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:19:01.462471Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:19:01.457969Z&quot;}}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-36" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:19:02.814014Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:19:02.813654Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:19:02.839168Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:19:02.838427Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:19:02.813987Z&quot;}}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_B.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model does a much better job at predicting <code>neutral</code> sentiment with this adjustment.</p>
<div id="cell-38" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:19:15.994990Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:19:15.994593Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:19:16.090640Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:19:16.089862Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:19:15.994965Z&quot;}}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-25-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prompt-c" class="level2">
<h2 class="anchored" data-anchor-id="prompt-c">Prompt C</h2>
<p>I’ll add some introductory text to the prompt to see if that improves the model’s performance:</p>
<div id="cell-41" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:22:12.162149Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:22:12.161827Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:22:12.166169Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:22:12.165389Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:22:12.162128Z&quot;}}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>promptC <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:22:23.894458Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:22:23.893740Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:26:01.864511Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:26:01.863762Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:22:23.894435Z&quot;}}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"28fb1133a3214a958546bd43393573f4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Your task is to analyze the sentiment (from an investor's perspective) of the text below.

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>The addition of this introductory text actually worsens the model’s performance by about 5%.</p>
<div id="cell-44" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:26:01.867383Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:26:01.867234Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:26:01.871757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:26:01.871104Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:26:01.867368Z&quot;}}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.8348056537102474</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:26:22.395487Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:26:22.394834Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:26:22.401022Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:26:22.399960Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:26:22.395460Z&quot;}}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:26:24.198390Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:26:24.197692Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:26:24.287352Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:26:24.286780Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:26:24.198355Z&quot;}}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-30-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-47" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:26:31.662582Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:26:31.661980Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:26:31.686166Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:26:31.685563Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:26:31.662561Z&quot;}}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_C.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-d" class="level2">
<h2 class="anchored" data-anchor-id="prompt-d">Prompt D</h2>
<p>I’ll try another prompt language adjustment to Prompt B: I’ll replace “label” with “Respond”.</p>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:34:40.583440Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:34:40.583159Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:34:40.587130Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:34:40.586329Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:34:40.583422Z&quot;}}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>promptD <span class="op">=</span> <span class="st">"""Instruct: Respond with only one of these words: negative, positive, or neutral</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with only one of these words: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:34:45.986606Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:34:45.986326Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:38:19.125140Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:38:19.124552Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:34:45.986588Z&quot;}}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3593d9b0003f47b69d801e63355b7447","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: Respond with only one of these words: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
Respond with only one of these words: negative, positive, or neutral
---------</code></pre>
</div>
</div>
<p>Wow! The accuracy plummets to 69%. This was something that had improved the accuracy for phi-2.</p>
<div id="cell-53" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:38:19.126487Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:38:19.126281Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:38:19.130311Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:38:19.129771Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:38:19.126471Z&quot;}}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>0.6863957597173145</code></pre>
</div>
</div>
<p>The model actually improves its performance on <code>negative</code> and <code>positive</code> sentences, but significantly worsens its performance when classifying <code>neutral</code> sentences.</p>
<div id="cell-55" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:38:19.131202Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:38:19.131052Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:38:19.222226Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:38:19.221714Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:38:19.131202Z&quot;}}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-56" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:43:08.929116Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:43:08.928590Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:43:08.954648Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:43:08.953983Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:43:08.929097Z&quot;}}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_D.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-e" class="level2">
<h2 class="anchored" data-anchor-id="prompt-e">Prompt E</h2>
<p>Another adjustment that improved phi-2’s performance was to add a period after the instruction. I’ll see if doing so improves phi-3.5’s performance.</p>
<div id="cell-59" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:47:05.858952Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:47:05.858147Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:47:05.862763Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:47:05.861985Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:47:05.858916Z&quot;}}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>promptE <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral.</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:47:18.132661Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:47:18.132005Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:49.801782Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:49.801210Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:47:18.132640Z&quot;}}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ead0011c23ae4691a79fd373f4556ba0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral.
---------</code></pre>
</div>
</div>
<p>Interestingly, this actually worsens the overall accuracy a bit.</p>
<div id="cell-62" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:50:49.803545Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:50:49.802803Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:49.807758Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:49.807280Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:50:49.803522Z&quot;}}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>0.8825088339222615</code></pre>
</div>
</div>
<p>The <code>negative</code> and <code>positive</code> true positive rate is the same as Prompt B, but <code>neutral</code> rate is worse (1207 &lt; 1215).</p>
<div id="cell-64" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:50:49.809136Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:50:49.808520Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:50:50.289943Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:50:50.289510Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:50:49.809111Z&quot;}}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-40-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-65" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T20:55:16.875770Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T20:55:16.874732Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T20:55:16.900740Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T20:55:16.899988Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T20:55:16.875738Z&quot;}}" data-execution_count="53">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_E.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-f" class="level2">
<h2 class="anchored" data-anchor-id="prompt-f">Prompt F</h2>
<p>I’ll now move on to few-shot prompting to see if I can improve on the best overall accuracy so far (88.6%). To do so, I’ll create a new helper function (since the chat template handles few-shot prompt as multiple query-response exchanges between user and assistant).</p>
<div id="cell-68" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:05:34.897057Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:05:34.896452Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:05:34.904439Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:05:34.903670Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:05:34.897030Z&quot;}}" data-execution_count="8">
<details class="code-fold">
<summary>Show <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>: <span class="bu">print</span>(messages)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-69" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:50:51.353719Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:50:51.352913Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:50:51.356629Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:50:51.356046Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:50:51.353695Z&quot;}}" data-execution_count="74">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:50:52.656744Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:50:52.656131Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:50:52.668656Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:50:52.668056Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:50:52.656722Z&quot;}}" data-execution_count="75">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>promptF_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-71" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:50:54.608654Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:50:54.607761Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:50:54.613924Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:50:54.612935Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:50:54.608651Z&quot;}}" data-execution_count="76">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>promptF_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div id="cell-72" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:50:58.383449Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:50:58.383169Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:50:58.390470Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:50:58.389298Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:50:58.383430Z&quot;}}" data-execution_count="77">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div id="cell-73" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:52:01.738560Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:52:01.737833Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:57:17.142603Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:57:17.142106Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:52:01.738529Z&quot;}}" data-execution_count="82">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptB, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"72728f4fc3804af8aa0dfa462faa774d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral'}]</code></pre>
</div>
</div>
<p>The accuracy drops to 84.65%.</p>
<div id="cell-75" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T22:59:26.040819Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T22:59:26.040466Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T22:59:26.046232Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T22:59:26.045531Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T22:59:26.040795Z&quot;}}" data-execution_count="83">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>0.8465280849181778</code></pre>
</div>
</div>
<p>Compared to Prompt B, the true positive rate for <code>neutral</code> decreases (1070 &lt; 1215) whereas for <code>positive</code> and <code>negative</code> sentiment the TPR increases (296 &gt; 290, 548 &gt; 501).</p>
<div id="cell-77" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:00:15.083099Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:00:15.082114Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:00:15.210950Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:00:15.210294Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:00:15.083065Z&quot;}}" data-execution_count="84">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-49-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-78" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:01:55.650702Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:01:55.650420Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:01:55.674125Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:01:55.673487Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:01:55.650684Z&quot;}}" data-execution_count="85">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_F.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-g" class="level2">
<h2 class="anchored" data-anchor-id="prompt-g">Prompt G</h2>
<p>I’ll now try a 6-Shot prompt using the examples that were best-performing for phi-2.</p>
<div id="cell-81" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:07:05.099893Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:07:05.099560Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:07:05.118682Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:07:05.117924Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:07:05.099871Z&quot;}}" data-execution_count="86">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>]</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>promptG_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>promptG_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2258
})</code></pre>
</div>
</div>
<div id="cell-82" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:07:33.184273Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:07:33.183702Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:07:33.190417Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:07:33.189882Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:07:33.184245Z&quot;}}" data-execution_count="88">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>(('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 6)</code></pre>
</div>
</div>
<div id="cell-83" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:07:54.251745Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:07:54.250798Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:16:17.108382Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:16:17.107675Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:07:54.251714Z&quot;}}" data-execution_count="89">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptG_ds, promptB, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"45e3402d656648abb2526d0bb8470703","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nlabel the TEXT with a single word: negative, positive, or neutral'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral'}]</code></pre>
</div>
</div>
<p>Unexpectedly, the accuracy drops to 78%.</p>
<div id="cell-85" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:16:59.805335Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:16:59.804990Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:16:59.812852Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:16:59.812154Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:16:59.805314Z&quot;}}" data-execution_count="90">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>0.7798937112488928</code></pre>
</div>
</div>
<p>The model performs better with this prompt than the so far best-performing 3-Shot prompt (84.7%) for <code>negative</code> sentences (297 &gt; 296) and <code>positive</code> sentences (551 &gt; 548) but performs much worse for <code>neutral</code> sentences (913 &lt; 1070).</p>
<div id="cell-87" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:18:10.022360Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:18:10.021974Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:18:10.148122Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:18:10.147150Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:18:10.022334Z&quot;}}" data-execution_count="91">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-55-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/cell-55-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-88" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:20:46.063111Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:20:46.062824Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:20:46.094183Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:20:46.093385Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:20:46.063091Z&quot;}}" data-execution_count="92">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_G.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-h" class="level2">
<h2 class="anchored" data-anchor-id="prompt-h">Prompt H</h2>
<p>I’ll return to the 3-Shot prompt (84.65%) and see if I can improve it by adjusting the language. First, I’ll add some introductory text to the start of the prompt. Note that this did not improve the 0-Shot performance.</p>
<div id="cell-91" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:29:50.247086Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:29:50.246698Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:29:50.251079Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:29:50.250196Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:29:50.247061Z&quot;}}" data-execution_count="94">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>promptH <span class="op">=</span> <span class="st">"""Your task is to analyze the sentiment (from an investor's perspective) of the text below.</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-92" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:29:52.229127Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:29:52.228465Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:29:52.233928Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:29:52.233526Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:29:52.229104Z&quot;}}" data-execution_count="95">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">292</span>]</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>[('According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .',
  'neutral'),
 ("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 ('Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .',
  'negative')]</code></pre>
</div>
</div>
<div id="cell-93" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:30:04.197021Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:30:04.196560Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:30:04.200748Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:30:04.200318Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:30:04.197000Z&quot;}}" data-execution_count="96">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>promptF_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div id="cell-94" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:30:38.532044Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:30:38.530922Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:36:55.692114Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:36:55.691165Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:30:38.531996Z&quot;}}" data-execution_count="97">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptF_ds, promptH, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c47d528604a64c9b95488edba268f985","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral"}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': "Your task is to analyze the sentiment (from an investor's perspective) of the text below.\nInstruct: label the following TEXT with a single word: negative, positive, or neutral\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral"}]</code></pre>
</div>
</div>
<p>This does not improve the overall accuracy. Instead, it drops by about 1.6%.</p>
<div id="cell-96" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:37:15.878306Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:37:15.877406Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:37:15.883427Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:37:15.882654Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:37:15.878271Z&quot;}}" data-execution_count="98">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>0.8306059265811587</code></pre>
</div>
</div>
<p>Compared to the 3-Shot prompt, <code>negative</code> sentences are classified at the same frequency (296/302), <code>neutral</code> sentences at a lower rate (1028 &lt; 1070) and <code>positive</code> sentences at a higher rate (554 &gt; 548).</p>
<div id="cell-98" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:37:49.183327Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:37:49.182973Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:37:49.274064Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:37:49.273314Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:37:49.183301Z&quot;}}" data-execution_count="99">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-62-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-99" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-10T23:43:53.666021Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-10T23:43:53.665207Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-10T23:43:53.691776Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-10T23:43:53.691048Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-10T23:43:53.666014Z&quot;}}" data-execution_count="101">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_H.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-i" class="level2">
<h2 class="anchored" data-anchor-id="prompt-i">Prompt I</h2>
<p>Before I give the model more than 6 examples, I’ll deviate from the recommended multi-turn chat format for few-shot prompting and give the examples in a single prompt.</p>
<div id="cell-102" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:11:10.258963Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:11:10.258310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:11:10.262724Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:11:10.261992Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:11:10.258939Z&quot;}}" data-execution_count="103">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>promptI <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="st">Examples:</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="st">neutral</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="st">positive</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="st">negative</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-103" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:11:15.094159Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:11:15.093812Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:11:15.099555Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:11:15.098849Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:11:15.094135Z&quot;}}" data-execution_count="104">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>promptF_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2261
})</code></pre>
</div>
</div>
<div id="cell-104" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:11:21.741690Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:11:21.741092Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:16:20.147703Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:16:20.147083Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:11:21.741669Z&quot;}}" data-execution_count="105">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(promptF_ds, promptI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2a668ff38927486fbe1f9914c3c88e01","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral

Examples:

TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
neutral

TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .
label the TEXT with a single word: negative, positive, or neutral
positive

TEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .
label the TEXT with a single word: negative, positive, or neutral
negative

TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .
label the TEXT with a single word: negative, positive, or neutral

---------</code></pre>
</div>
</div>
<p>Nope! The performance of few-shot prompting without multi-turn format is drastically worse.</p>
<div id="cell-106" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:17:13.031855Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:17:13.031256Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:17:13.037086Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:17:13.035878Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:17:13.031830Z&quot;}}" data-execution_count="106">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>0.5161432994250331</code></pre>
</div>
</div>
<p>The true positive rate for <code>negative</code> sentiment is actually higher (302/302 or 100%) but the rate is much lower for <code>neutral</code> sentiment (917 &lt; 1070) and <code>positive</code> sentiment (418 &lt; 548).</p>
<div id="cell-108" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:18:01.793415Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:18:01.792417Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:18:01.923508Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:18:01.922526Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:18:01.793385Z&quot;}}" data-execution_count="107">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-68-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-109" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:19:57.819876Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:19:57.819509Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:19:57.880943Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:19:57.880035Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:19:57.819848Z&quot;}}" data-execution_count="108">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_I.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-j" class="level2">
<h2 class="anchored" data-anchor-id="prompt-j">Prompt J</h2>
<p>I’ll try one more prompt with single-turn few-shot examples. I’ll add “Output:” before the label in each example, and add the “Instruct:” instructions before each example TEXT. I’ll also remove the extra new line that I have after the final instruction.</p>
<div id="cell-112" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:36:07.116641Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:36:07.116376Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:36:07.120613Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:36:07.119923Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:36:07.116623Z&quot;}}" data-execution_count="111">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>promptJ <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="st">Examples:</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="st">Output: neutral</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="st">Output: positive</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="st">Output: negative</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="st">Instruct: label the following TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="st">Output: """</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-113" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:36:11.193841Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:36:11.193506Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:41:41.578407Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:41:41.577423Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:36:11.193818Z&quot;}}" data-execution_count="112">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(promptF_ds, promptJ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7cbf3fa476ed452fb6a70da296b763eb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral

Examples:

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral
Output: neutral

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .
label the TEXT with a single word: negative, positive, or neutral
Output: positive

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .
label the TEXT with a single word: negative, positive, or neutral
Output: negative

Instruct: label the following TEXT with a single word: negative, positive, or neutral
TEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .
label the TEXT with a single word: negative, positive, or neutral
Output: 
---------</code></pre>
</div>
</div>
<p>Wow! This actually made a difference. This is the second-best overall accuracy I have achieved.</p>
<div id="cell-115" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:41:41.579807Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:41:41.579613Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:41:41.584568Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:41:41.583843Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:41:41.579791Z&quot;}}" data-execution_count="113">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>0.8593542680229986</code></pre>
</div>
</div>
<p>Compared to the previous second-best prompt (3-Shot), this prompt results in the same true positive rate for <code>negative</code> sentiment (296/302), a much higher rate for <code>neutral</code> sentiment (1108 &gt; 1070) and a lower rate for <code>positive</code> sentiment (539 &lt; 548).</p>
<div id="cell-117" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:41:41.585668Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:41:41.585475Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:41:41.689292Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:41:41.688519Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:41:41.585652Z&quot;}}" data-execution_count="114">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-73-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/cell-73-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-118" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T00:41:41.691229Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T00:41:41.690952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T00:41:41.754843Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T00:41:41.754097Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T00:41:41.691208Z&quot;}}" data-execution_count="115">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_J.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-k" class="level2">
<h2 class="anchored" data-anchor-id="prompt-k">Prompt K</h2>
<p>I’ll return to few-shot prompting in a bit, but want to first revisit zero-shot prompting as it yielded the best overall performance so far (88.6% overall accuracy).</p>
<p>I asked Claude for suggestions on how to improve that prompt and will be trying them out.</p>
<p>First suggestion:</p>
<blockquote class="blockquote">
<p>Refine the Instruction: Try slight variations of the instruction to see if they yield better results:</p>
</blockquote>
<div id="cell-121" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:17:20.452006Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:17:20.451054Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:17:20.455324Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:17:20.454568Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:17:20.451976Z&quot;}}" data-execution_count="117">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>promptK <span class="op">=</span> <span class="st">"""Instruct: Analyze the sentiment of the following financial statement and respond with a single word: negative, positive, or neutral</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="st">Financial statement: </span><span class="sc">{text}</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="st">Sentiment (respond with a single word):"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-122" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:17:25.001223Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:17:25.000583Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:20:57.770782Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:20:57.770261Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:17:25.001200Z&quot;}}" data-execution_count="118">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptK)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d6ad1a122d304da9b3dd9137d82fdc42","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: Analyze the sentiment of the following financial statement and respond with a single word: negative, positive, or neutral
Financial statement: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
Sentiment (respond with a single word):
---------</code></pre>
</div>
</div>
<p>This yields a worse overall accuracy.</p>
<div id="cell-124" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:24:11.377325Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:24:11.376537Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:24:11.382597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:24:11.381743Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:24:11.377293Z&quot;}}" data-execution_count="119">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>0.7795936395759717</code></pre>
</div>
</div>
<p>Compared to the best-performing 0-Shot Prompt B (88.6%) this prompt yields a higher true positive rate for <code>neutral</code> sentiment (298 &gt; 290) and <code>positive</code> sentiment (548 &gt; 501) but lower for <code>neutral</code> sentiment (919 &lt; 1215).</p>
<div id="cell-126" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:24:29.034590Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:24:29.033665Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:24:29.117428Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:24:29.116819Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:24:29.034582Z&quot;}}" data-execution_count="120">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-78-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-127" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:26:19.539523Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:26:19.538911Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:26:19.566301Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:26:19.565483Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:26:19.539497Z&quot;}}" data-execution_count="121">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_K.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-l" class="level2">
<h2 class="anchored" data-anchor-id="prompt-l">Prompt L</h2>
<p>Given the success of that prompt with <code>negative</code> and <code>positive</code> sentiment, I’ll see if I can improve it for <code>neutral</code> sentiment by adding the phrase: “if you’re not sure, respond with neutral.”</p>
<div id="cell-130" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:28:20.996824Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:28:20.996540Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:28:21.000715Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:28:20.999925Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:28:20.996805Z&quot;}}" data-execution_count="122">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>promptL <span class="op">=</span> <span class="st">"""Instruct: Analyze the sentiment of the following financial statement and respond with a single word: negative, positive, or neutral. If you’re not sure, respond with neutral.</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="st">Financial statement: </span><span class="sc">{text}</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="st">Sentiment (respond with a single word, if you’re not sure, respond with neutral):"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-131" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:28:32.175907Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:28:32.175209Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:32:07.839373Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:32:07.838898Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:28:32.175878Z&quot;}}" data-execution_count="123">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"391f7c4c97bf43a0be71688f8cf02241","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: Analyze the sentiment of the following financial statement and respond with a single word: negative, positive, or neutral. If you’re not sure, respond with neutral.
Financial statement: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
Sentiment (respond with a single word, if you’re not sure, respond with neutral):
---------</code></pre>
</div>
</div>
<p>This improves the overall accuracy but is still lower than the Prompt B (88.6%).</p>
<div id="cell-133" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:33:13.313113Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:33:13.312430Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:33:13.316856Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:33:13.316425Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:33:13.313088Z&quot;}}" data-execution_count="124">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">
<pre><code>0.8056537102473498</code></pre>
</div>
</div>
<p>Compared to Prompt K, the true positive rate for each sentiment increased.</p>
<div id="cell-135" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:33:55.618489Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:33:55.617624Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:33:55.702037Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:33:55.701514Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:33:55.618458Z&quot;}}" data-execution_count="125">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-83-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="index_files/figure-html/cell-83-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-136" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:34:01.500786Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:34:01.499934Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:34:01.526850Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:34:01.526118Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:34:01.500756Z&quot;}}" data-execution_count="126">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_L.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-m" class="level2">
<h2 class="anchored" data-anchor-id="prompt-m">Prompt M</h2>
<p>Given the success of the phrase “if you’re not sure, respond with neutral” I’ll add it to Prompt B.</p>
<div id="cell-139" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:10:12.783650Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:10:12.782746Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:10:12.788399Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:10:12.787934Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:10:12.783625Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>promptM <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-140" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:36:43.595009Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:36:43.594149Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:40:17.962291Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:40:17.961499Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:36:43.594974Z&quot;}}" data-execution_count="130">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8597ac841deb43b4ab2bbfefed854efc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
---------</code></pre>
</div>
</div>
<p>Hooray!! With this language adjustment, I have achieved the best overall accuracy so far.</p>
<div id="cell-142" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:40:33.702562Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:40:33.702290Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:40:33.707654Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:40:33.706767Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:40:33.702544Z&quot;}}" data-execution_count="131">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre><code>0.9129858657243817</code></pre>
</div>
</div>
<p>The true positive rate for all three sentiments has increased.</p>
<div id="cell-144" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:41:12.796096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:41:12.795386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:41:13.369597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:41:13.368887Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:41:12.796092Z&quot;}}" data-execution_count="132">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-88-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="index_files/figure-html/cell-88-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-145" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T01:43:51.134811Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T01:43:51.134066Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T01:43:51.170985Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T01:43:51.170162Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T01:43:51.134783Z&quot;}}" data-execution_count="133">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_M.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-n" class="level2">
<h2 class="anchored" data-anchor-id="prompt-n">Prompt N</h2>
<p>I’ll see if adding a system prompt improves the performance.</p>
<div id="cell-148" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:10:02.255320Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:10:02.254445Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:10:02.263278Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:10:02.262648Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:10:02.255287Z&quot;}}" data-execution_count="12">
<details class="code-fold">
<summary>Show updated <code>generate_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_responses(dataset, prompt, sp<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that the prompt is correctly formatted</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset[<span class="dv">0</span>][<span class="st">'prompt'</span>])</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'---------'</span>)</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp:</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: <span class="st">'You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification.'</span>}</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>                       ] <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},]</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: messages <span class="op">=</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},] </span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-149" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:10:19.250053Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:10:19.249482Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:14:19.562949Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:14:19.562180Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:10:19.250025Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptM, sp<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a21f5f55e43142d7b0f398367f045611","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
---------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>Adding that system prompt results in a worse accuracy.</p>
<div id="cell-151" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:31:25.907262Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:31:25.906993Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:31:25.911045Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:31:25.910581Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:31:25.907242Z&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.8873674911660777</code></pre>
</div>
</div>
<p>The true positive rate for <code>negative</code> (295 &gt; 290) and <code>positive</code> (530 &gt; 501) increases but for <code>neutral</code> (1184 &lt; 1215) decreases.</p>
<div id="cell-153" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:31:28.761086Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:31:28.760791Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:31:28.849023Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:31:28.848380Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:31:28.761066Z&quot;}}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-93-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="index_files/figure-html/cell-93-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-154" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:31:35.027697Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:31:35.027390Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:31:35.054537Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:31:35.053784Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:31:35.027697Z&quot;}}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_N.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-o" class="level2">
<h2 class="anchored" data-anchor-id="prompt-o">Prompt O</h2>
<p>I’ll see if adding “if you’re not sure, respond with neutral” to the system message improves performance.</p>
<div id="cell-157" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T22:59:30.009240Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T22:59:30.008439Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T22:59:30.014376Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T22:59:30.013837Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T22:59:30.009219Z&quot;}}" data-execution_count="7">
<details class="code-fold">
<summary>Show updated <code>generate_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_responses(dataset, prompt, sp<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that the prompt is correctly formatted</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset[<span class="dv">0</span>][<span class="st">'prompt'</span>])</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'---------'</span>)</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sp:</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>            messages <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'system'</span>, <span class="st">'content'</span>: sp}</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>                       ] <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},]</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: messages <span class="op">=</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]},] </span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-158" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:55:22.512243Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:55:22.511386Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:55:22.514830Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:55:22.514412Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:55:22.512216Z&quot;}}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If you're not sure, respond with neutral."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-159" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:55:23.924798Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:55:23.924543Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:55:23.928159Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:55:23.927750Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:55:23.924780Z&quot;}}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert in financial sentiment analysis. Your task is to accurately classify the sentiment of financial statements as negative, positive, or neutral. Consider the overall impact and implications of the statement when making your classification. If you're not sure, respond with neutral.</code></pre>
</div>
</div>
<div id="cell-160" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:55:35.923166Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:55:35.922623Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:59:40.208307Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:59:40.207497Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:55:35.923141Z&quot;}}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptM, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral. If you're not sure, respond with neutral.
---------</code></pre>
</div>
</div>
<p>This system prompt still performs worse than no system prompt.</p>
<div id="cell-162" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:59:40.209638Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:59:40.209436Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:59:40.213723Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:59:40.212974Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:59:40.209621Z&quot;}}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>0.8710247349823321</code></pre>
</div>
</div>
<p>Compared to the best-performing Prompt M, this prompt yields a higher true positive rate for <code>positive</code> sentiment (531 &gt; 501) but a lower rate for <code>neutral</code> sentiment (1156 &lt; 1215) and for <code>negative</code> (294 &gt; 290) sentiment.</p>
<div id="cell-164" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:59:40.214612Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:59:40.214455Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:59:40.302582Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:59:40.301881Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:59:40.214598Z&quot;}}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-100-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="index_files/figure-html/cell-100-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-165" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T03:02:03.088032Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T03:02:03.087433Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T03:02:03.112132Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T03:02:03.111507Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T03:02:03.088010Z&quot;}}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_O.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-p" class="level2">
<h2 class="anchored" data-anchor-id="prompt-p">Prompt P</h2>
<p>I’ll move away from system prompts for now and revisit language adjustments. For Prompt M, I’ll replace:</p>
<blockquote class="blockquote">
<p>If you’re not sure, respond with neutral.</p>
</blockquote>
<p>with</p>
<blockquote class="blockquote">
<p>If the amount of money is not explicitly increasing or decreasing, respond with neutral.</p>
</blockquote>
<div id="cell-168" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:06:03.550437Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:06:03.549947Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:06:03.553145Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:06:03.552670Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:06:03.550414Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>promptP <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-169" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:48:59.761850Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:48:59.761246Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:34.075642Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:34.074997Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:48:59.761828Z&quot;}}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"da7c266036ad4153ac220062b6c0814e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.
---------</code></pre>
</div>
</div>
<p>Excellent! The overall accuracy again increases, this time to 92.2%. I’m still quite surprised it’s taken so much effort to surpass phi-2, but I’ll reflect on that later on.</p>
<div id="cell-171" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:34.077514Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:34.077290Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:34.082303Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:34.080841Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:34.077494Z&quot;}}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>0.9222614840989399</code></pre>
</div>
</div>
<p>Both <code>negative</code> and <code>positive</code> sentiment true positive rates decrease, but this prompt results in almost 100 more correct <code>neutral</code> responses.</p>
<div id="cell-173" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:34.083615Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:34.083381Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:34.188610Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:34.187891Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:34.083596Z&quot;}}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-105-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="index_files/figure-html/cell-105-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-174" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T02:52:34.190492Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T02:52:34.190258Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T02:52:34.221369Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T02:52:34.220605Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T02:52:34.190474Z&quot;}}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_P.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-q" class="level2">
<h2 class="anchored" data-anchor-id="prompt-q">Prompt Q</h2>
<p>Given the success of the zero-shot prompt with instructions on handling neutral statements, I’ll try a prompt suggested by Claude, which adds more nuance to handling neutral sentences:</p>
<div id="cell-177" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:08:25.978721Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:08:25.978164Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:08:25.981742Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:08:25.981158Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:08:25.978701Z&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>promptQ <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. </span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral. If key financial metrics are not clearly changing, respond with neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-178" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:08:35.163876Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:08:35.163249Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:08:35.167260Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:08:35.166604Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:08:35.163847Z&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(promptQ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. 
TEXT: {text}
label the TEXT with a single word: negative, positive, or neutral. If key financial metrics are not clearly changing, respond with neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral.</code></pre>
</div>
</div>
<div id="cell-179" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:09:07.504776Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:09:07.504039Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:13:00.537777Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:13:00.537131Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:09:07.504744Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> generate_responses(dataset, promptQ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a32337cb82ff4a1298504b8e44470cb1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral. 
TEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .
label the TEXT with a single word: negative, positive, or neutral. If key financial metrics are not clearly changing, respond with neutral. If the amount of money, market share, or key performance indicators are not explicitly increasing or decreasing, respond with neutral.
---------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>A more nuanced prompt actually deteriorates the overall accuracy by about 13%.</p>
<div id="cell-181" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:16:43.708545Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:16:43.707676Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:16:43.718595Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:16:43.717999Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:16:43.708517Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>0.7937279151943463</code></pre>
</div>
</div>
<p>Compared to the best performing prompt P (92.2%), this prompt performs better on <code>negative</code> sentiment and worse on <code>neutral</code> and <code>positive</code> sentiment.</p>
<div id="cell-183" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:17:09.235809Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:17:09.235053Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:17:09.393949Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:17:09.393181Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:17:09.235787Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-111-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="index_files/figure-html/cell-111-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-184" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:18:06.668348Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:18:06.667916Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:18:06.709005Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:18:06.708304Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:18:06.668329Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_Q.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-r" class="level2">
<h2 class="anchored" data-anchor-id="prompt-r">Prompt R</h2>
<p>I’ll now try providing a large number of examples (20) in the prompt. I don’t expect this to improve upon my 92.2% accuracy since 3-Shot and 6-Shot prompting performed worse. Nevertheless, I’ve heard that it’s not uncommon to give a model dozens of examples.</p>
<div id="cell-187" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:30:07.388460Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:30:07.388258Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:30:07.392774Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:30:07.391661Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:30:07.388443Z&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-188" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:30:07.394220Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:30:07.394021Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:30:07.414290Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:30:07.413655Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:30:07.394204Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>promptR_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>promptR_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2244
})</code></pre>
</div>
</div>
<div id="cell-189" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:37:55.131498Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:37:55.130598Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T20:37:55.138965Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T20:37:55.138244Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:37:55.131450Z&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 20)</code></pre>
</div>
</div>
<div id="cell-190" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T20:39:25.182483Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T20:39:25.181894Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:23:24.516313Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:23:24.515802Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T20:39:25.182457Z&quot;}}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptR_ds, promptP, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b3a4bdd6fb314bf38ec5402a838fe225","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Operating profit rose to EUR 13.1 mn from EUR 8.7 mn in the corresponding period in 2007 representing 7.7 % of net sales .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Operating profit totalled EUR 21.1 mn , up from EUR 18.6 mn in 2007 , representing 9.7 % of net sales .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Pharmaceuticals group Orion Corp reported a fall in its third-quarter earnings that were hit by larger expenditures on R&amp;D and marketing .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: However , the growth margin slowed down due to the financial crisis .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: 2009 3 February 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR46m in the fourth quarter of 2009 from a year-earlier profit of EUR45m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Tiimari operates 194 stores in six countries -- including its core Finnish market -- and generated a turnover of 76.5 mln eur in 2005 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Finnish Talvivaara Mining Co HEL : TLV1V said Thursday it had picked BofA Merrill Lynch and JPMorgan NYSE : JPM as joint bookrunners of its planned issue of convertible notes worth up to EUR250m USD332m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The mall is part of the Baltic Pearl development project in the city of St Petersburg , where Baltic Pearl CJSC , a subsidiary of Shanghai Foreign Joint Investment Company , is developing homes for 35,000 people .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Vacon controls a further 5 % of the company via investment fund Power Fund I. EUR 1.0 = USD 1.397\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: 4 ) Complete name of the shareholder : Otto Henrik Bernhard Nyberg 5 ) Further information : The amount of shares now transferred corresponds to 5.68 % of the total number of shares in Aspo Plc. .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: It has some 30 offices worldwide and more than 90 pct of its net sales are generated outside Finland .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The contract value amounts to about EUR11m , the company added .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The business to be divested generates consolidated net sales of EUR 60 million annually and currently has some 640 employees .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Finnish Talentum reports its operating profit increased to EUR 20.5 mn in 2005 from EUR 9.3 mn in 2004 , and net sales totaled EUR 103.3 mn , up from EUR 96.4 mn .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}]</code></pre>
</div>
</div>
<p>Wow! I’m so glad I tried a larger number of examples. The accuracy (93.94%) is now competitive with the Claude models!</p>
<div id="cell-192" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:23:41.420414Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:23:41.420146Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:23:41.424933Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:23:41.424358Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:23:41.420396Z&quot;}}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>0.9393939393939394</code></pre>
</div>
</div>
<p>With 20-Shot prompting, the true positive rate for <code>negative</code> (286 &gt; 285) and <code>neutral</code> (1355 &gt; 1307) sentiment increases, and decreases for <code>positive</code> (467 &lt; 496) sentiment.</p>
<div id="cell-194" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:28:07.681485Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:28:07.681186Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:28:07.771933Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:28:07.771417Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:28:07.681465Z&quot;}}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-118-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="index_files/figure-html/cell-118-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-195" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T21:29:09.334179Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T21:29:09.333618Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T21:29:09.363094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T21:29:09.362375Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T21:29:09.334159Z&quot;}}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_R.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-s" class="level2">
<h2 class="anchored" data-anchor-id="prompt-s">Prompt S</h2>
<p>I’ll increase the number of examples to 28 and see if that yields an improvement. I currently have 4 <code>positive</code>, 4 <code>negative</code> and 12 <code>neutral</code> examples. I’ll up that to 5:5:18.</p>
<div id="cell-198" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:05:45.588209Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:05:45.587945Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:05:45.591657Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:05:45.591110Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:05:45.588192Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="co"># positive</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">348</span>, <span class="co"># negative</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>, <span class="dv">284</span>, <span class="dv">285</span>, <span class="dv">286</span>, <span class="dv">287</span>, <span class="dv">288</span>, <span class="dv">289</span> <span class="co"># neutral</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-199" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:05:46.917173Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:05:46.916914Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:05:46.927084Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:05:46.926555Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:05:46.917155Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  'positive'),
 28)</code></pre>
</div>
</div>
<div id="cell-200" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:05:50.236099Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:05:50.235837Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-11T23:05:50.253589Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-11T23:05:50.253165Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:05:50.236082Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>promptS_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>promptS_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2236
})</code></pre>
</div>
</div>
<div id="cell-201" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-11T23:06:11.442082Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-11T23:06:11.441679Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:17:18.158404Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:17:18.157636Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-11T23:06:11.442062Z&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>df, acc <span class="op">=</span> few_shot_responses(promptS_ds, promptP, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8af4b803118f416595b1a232389e48f4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Operating profit rose to EUR 13.1 mn from EUR 8.7 mn in the corresponding period in 2007 representing 7.7 % of net sales .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Operating profit totalled EUR 21.1 mn , up from EUR 18.6 mn in 2007 , representing 9.7 % of net sales .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Finnish Talentum reports its operating profit increased to EUR 20.5 mn in 2005 from EUR 9.3 mn in 2004 , and net sales totaled EUR 103.3 mn , up from EUR 96.4 mn .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'positive'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Pharmaceuticals group Orion Corp reported a fall in its third-quarter earnings that were hit by larger expenditures on R&amp;D and marketing .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: However , the growth margin slowed down due to the financial crisis .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: 2009 3 February 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR46m in the fourth quarter of 2009 from a year-earlier profit of EUR45m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: ( ADPnews ) - Feb 3 , 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR 46 million ( USD 64.5 m ) in the fourth quarter of 2009 from a\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'negative'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Tiimari operates 194 stores in six countries -- including its core Finnish market -- and generated a turnover of 76.5 mln eur in 2005 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Finnish Talvivaara Mining Co HEL : TLV1V said Thursday it had picked BofA Merrill Lynch and JPMorgan NYSE : JPM as joint bookrunners of its planned issue of convertible notes worth up to EUR250m USD332m .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The mall is part of the Baltic Pearl development project in the city of St Petersburg , where Baltic Pearl CJSC , a subsidiary of Shanghai Foreign Joint Investment Company , is developing homes for 35,000 people .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Vacon controls a further 5 % of the company via investment fund Power Fund I. EUR 1.0 = USD 1.397\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: 4 ) Complete name of the shareholder : Otto Henrik Bernhard Nyberg 5 ) Further information : The amount of shares now transferred corresponds to 5.68 % of the total number of shares in Aspo Plc. .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: It has some 30 offices worldwide and more than 90 pct of its net sales are generated outside Finland .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The contract value amounts to about EUR11m , the company added .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The business to be divested generates consolidated net sales of EUR 60 million annually and currently has some 640 employees .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The company generates net sales of about 600 mln euro $ 775.5 mln annually and employs 6,000 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The contract covers the manufacturing , surface-treatment and installation of the steel structures .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The order also includes start-up and commissioning services .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: The phones are targeted at first time users in growth markets .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Tielinja generated net sales of 7.5 mln euro $ 9.6 mln in 2005 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Tikkurila Powder Coatings has some 50 employees at its four paint plants , which generated revenues of EUR2 .4 m USD3 .3 m in 2010 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.'}, {'role': 'assistant', 'content': 'neutral'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.\nTEXT: Clothing retail chain Sepp+ñl+ñ 's sales increased by 8 % to EUR 155.2 mn , and operating profit rose to EUR 31.1 mn from EUR 17.1 mn in 2004 .\nlabel the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."}]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<p>Interestingly, that decreases the overall accuracy by about 0.7%.</p>
<div id="cell-203" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:17:18.160494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:17:18.159663Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:17:18.164052Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:17:18.163692Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:17:18.160493Z&quot;}}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.932468694096601</code></pre>
</div>
</div>
<p>Compared to Prompt R, this prompt yields fewer correct <code>negative</code> and <code>positive</code> sentences. It classifies 3 more <code>neutral</code> sentences correctly, but that doesn’t make up for the loss in performance of the other two sentiments.</p>
<div id="cell-205" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:17:18.165245Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:17:18.164692Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:17:18.261091Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:17:18.260416Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:17:18.165227Z&quot;}}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-125-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="index_files/figure-html/cell-125-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-206" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T00:17:18.262758Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T00:17:18.262199Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T00:17:18.291122Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T00:17:18.290537Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T00:17:18.262735Z&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'/notebooks/phi-3-5_S.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-t" class="level2">
<h2 class="anchored" data-anchor-id="prompt-t">Prompt T</h2>
<p>I noticed in the Prompt R results that 14 sentences were classified as something “other” than <code>neutral</code>, <code>positive</code>, or <code>negative</code>. Instead of asking the model to respond with <code>negative</code>, <code>neutral</code> or <code>positive</code>, I’ll ask it to respond with <code>0</code>, <code>1</code> or <code>2</code> and see if that simplification yields better results.</p>
<div id="cell-209" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:01.388228Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:01.387905Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:34:01.391702Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:34:01.391004Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:01.388205Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>promptT <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral)."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-210" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:03.622214Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:03.621934Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:34:03.626463Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:34:03.625666Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:03.622197Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(promptT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).
TEXT: {text}
label the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).</code></pre>
</div>
</div>
<div id="cell-211" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:22.381354Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:22.381089Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:34:22.385225Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:34:22.384293Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:22.381335Z&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-212" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:25.112835Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:25.112025Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:34:25.118805Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:34:25.118378Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:25.112833Z&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], <span class="bu">str</span>(dataset[idx][<span class="st">'label'</span>])))</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>examples[<span class="dv">0</span>], <span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(("For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .",
  '2'),
 20)</code></pre>
</div>
</div>
<div id="cell-213" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:36.148342Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:36.147870Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T01:34:36.153188Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T01:34:36.152697Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:36.148320Z&quot;}}" data-execution_count="17">
<details class="code-fold">
<summary>Show updated <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>: <span class="bu">print</span>(messages)</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-214" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T01:34:43.182534Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T01:34:43.181702Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T02:38:46.349392Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T02:38:46.348932Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T01:34:43.182504Z&quot;}}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> few_shot_responses(promptR_ds, promptT, examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"536369ac3fd9438cbdc294fff1150de8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'role': 'user', 'content': "Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: For the last quarter of 2010 , Componenta 's net sales doubled to EUR131m from EUR76m for the same period a year earlier , while it moved to a zero pre-tax profit from a pre-tax loss of EUR7m .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral)."}, {'role': 'assistant', 'content': '2'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: In the third quarter of 2010 , net sales increased by 5.2 % to EUR 205.5 mn , and operating profit by 34.9 % to EUR 23.5 mn .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '2'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Operating profit rose to EUR 13.1 mn from EUR 8.7 mn in the corresponding period in 2007 representing 7.7 % of net sales .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '2'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Operating profit totalled EUR 21.1 mn , up from EUR 18.6 mn in 2007 , representing 9.7 % of net sales .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '2'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Jan. 6 -- Ford is struggling in the face of slowing truck and SUV sales and a surfeit of up-to-date , gotta-have cars .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '0'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Pharmaceuticals group Orion Corp reported a fall in its third-quarter earnings that were hit by larger expenditures on R&amp;D and marketing .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '0'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: However , the growth margin slowed down due to the financial crisis .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '0'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: 2009 3 February 2010 - Finland-based steel maker Rautaruukki Oyj ( HEL : RTRKS ) , or Ruukki , said today it slipped to a larger-than-expected pretax loss of EUR46m in the fourth quarter of 2009 from a year-earlier profit of EUR45m .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '0'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: According to Gran , the company has no plans to move all production to Russia , although that is where the company is growing .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': "Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: At the request of Finnish media company Alma Media 's newspapers , research manager Jari Kaivo-oja at the Finland Futures Research Centre at the Turku School of Economics has drawn up a future scenario for Finland 's national economy by using a model developed by the University of Denver .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral)."}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: STOCK EXCHANGE ANNOUNCEMENT 20 July 2006 1 ( 1 ) BASWARE SHARE SUBSCRIPTIONS WITH WARRANTS AND INCREASE IN SHARE CAPITAL A total of 119 850 shares have been subscribed with BasWare Warrant Program .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: A maximum of 666,104 new shares can further be subscribed for by exercising B options under the 2004 stock option plan .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Tiimari operates 194 stores in six countries -- including its core Finnish market -- and generated a turnover of 76.5 mln eur in 2005 .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Finnish Talvivaara Mining Co HEL : TLV1V said Thursday it had picked BofA Merrill Lynch and JPMorgan NYSE : JPM as joint bookrunners of its planned issue of convertible notes worth up to EUR250m USD332m .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: The mall is part of the Baltic Pearl development project in the city of St Petersburg , where Baltic Pearl CJSC , a subsidiary of Shanghai Foreign Joint Investment Company , is developing homes for 35,000 people .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Vacon controls a further 5 % of the company via investment fund Power Fund I. EUR 1.0 = USD 1.397\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: 4 ) Complete name of the shareholder : Otto Henrik Bernhard Nyberg 5 ) Further information : The amount of shares now transferred corresponds to 5.68 % of the total number of shares in Aspo Plc. .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: It has some 30 offices worldwide and more than 90 pct of its net sales are generated outside Finland .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: The contract value amounts to about EUR11m , the company added .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: The business to be divested generates consolidated net sales of EUR 60 million annually and currently has some 640 employees .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}, {'role': 'assistant', 'content': '1'}, {'role': 'user', 'content': 'Instruct: label the following TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).\nTEXT: Finnish Talentum reports its operating profit increased to EUR 20.5 mn in 2005 from EUR 9.3 mn in 2004 , and net sales totaled EUR 103.3 mn , up from EUR 96.4 mn .\nlabel the TEXT with a single integer: 0 (negative), 1 (neutral), or 2 (positive). If the amount of money is not explicitly increasing or decreasing, respond with 1 (neutral).'}]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You are not running the flash-attention implementation, expect numerical differences.
You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset</code></pre>
</div>
</div>
<div id="cell-215" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T02:57:48.333200Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T02:57:48.332575Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T02:57:48.408877Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T02:57:48.408173Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T02:57:48.333177Z&quot;}}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: dataset.features[<span class="st">"label"</span>].names[<span class="bu">int</span>(x)])</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> df[<span class="st">'lm_match'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interestingly, this decreases the overall accuracy by almost 10%.</p>
<div id="cell-217" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T02:57:50.436174Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T02:57:50.435549Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T02:57:50.439853Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T02:57:50.439335Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T02:57:50.436152Z&quot;}}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.8453654188948306</code></pre>
</div>
</div>
<p>While there are no <code>other</code> classifications, and <code>neutral</code> true positive rate increases (1378 &gt; 1355), the rate for <code>negative</code> (232 &lt; 286) and especially <code>positive</code> (287 &lt; 467) sentiment decreases. The model classifies almost half of the <code>positive</code> sentences as <code>neutral</code>.</p>
<div id="cell-219" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T02:57:53.424305Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T02:57:53.423753Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T02:57:53.513084Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T02:57:53.512420Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T02:57:53.424283Z&quot;}}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>make_cm(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-135-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="index_files/figure-html/cell-135-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="running-inference-with-the-best-prompt-multiple-times" class="level2">
<h2 class="anchored" data-anchor-id="running-inference-with-the-best-prompt-multiple-times">Running Inference with the Best Prompt Multiple Times</h2>
<p>For phi-2 I ran the best-performing prompt 10 times to see if it consistently performed at a high accuracy. Inference with phi-3.5, given the 20 examples in each prompt, takes much longer:</p>
<div id="cell-222" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.791487Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.790878Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.807315Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.806823Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.791467Z&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>exclude_idxs <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">292</span>, <span class="dv">293</span>, <span class="dv">294</span>, <span class="dv">347</span>, <span class="dv">0</span>, <span class="dv">37</span>, <span class="dv">38</span>, <span class="dv">39</span>, <span class="dv">40</span>, <span class="dv">263</span>, <span class="dv">264</span>, <span class="dv">265</span>, <span class="dv">266</span>, <span class="dv">270</span>, <span class="dv">274</span>, <span class="dv">283</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-223" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.808965Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.807960Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.863705Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.863255Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.808948Z&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>promptR_ds <span class="op">=</span> ds_subset(dataset, exclude_idxs<span class="op">=</span>exclude_idxs, columns<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>promptR_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Dataset({
    features: ['sentence', 'label', 'label_text', '__index_level_0__'],
    num_rows: 2244
})</code></pre>
</div>
</div>
<div id="cell-224" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.865904Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.865196Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.872413Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.871997Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.865880Z&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> []</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> exclude_idxs:</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    examples.append((dataset[idx][<span class="st">'sentence'</span>], dataset[idx][<span class="st">'label_text'</span>]))</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>20</code></pre>
</div>
</div>
<div id="cell-225" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.873663Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.873055Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.889046Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.888628Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.873646Z&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>promptP <span class="op">=</span> <span class="st">"""Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="st">TEXT: </span><span class="sc">{text}</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="st">label the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-226" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:16.890414Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:16.889758Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:16.903267Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:16.902880Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:16.890396Z&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(promptP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Instruct: label the following TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.
TEXT: {text}
label the TEXT with a single word: negative, positive, or neutral. If the amount of money is not explicitly increasing or decreasing, respond with neutral.</code></pre>
</div>
</div>
<div id="cell-227" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:19:14.300508Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:19:14.299964Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:19:14.304786Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:19:14.304229Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:19:14.300486Z&quot;}}" data-execution_count="41">
<details class="code-fold">
<summary>Show <code>test_gen</code> function</summary>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_gen(examples):</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: promptP.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: promptP.<span class="bu">format</span>(text<span class="op">=</span>dataset[<span class="dv">0</span>])}]</span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>    generation_args <span class="op">=</span> { </span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb210-21"><a href="#cb210-21" aria-hidden="true" tabindex="-1"></a>    responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb210-22"><a href="#cb210-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> responses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model takes about 1.2 seconds to generate a response for a single dataset item, or about 45 minutes for the 2244 items (on a Paperspace Free-A4000). Given the 6 hour limit, the max I can do is run inference on the dataset 8 times. To be conservative, I’ll do it 7 times.</p>
<div id="cell-229" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:19:20.396441Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:19:20.396171Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:20:44.274870Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:20:44.274234Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:19:20.396423Z&quot;}}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> test_gen(examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.2 s ± 14.5 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<div id="cell-230" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T03:30:23.465527Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T03:30:23.465270Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T03:30:23.470717Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T03:30:23.470270Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T03:30:23.465509Z&quot;}}" data-execution_count="14">
<details class="code-fold">
<summary>Show <code>few_shot_responses</code> function</summary>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> few_shot_responses(dataset, prompt, examples):</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> []</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(add_prompt, fn_kwargs<span class="op">=</span>{<span class="st">"prompt"</span>: prompt})</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    few_shot_examples <span class="op">=</span> []</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt.<span class="bu">format</span>(text<span class="op">=</span>example[<span class="dv">0</span>])})</span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>        few_shot_examples.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: example[<span class="dv">1</span>]})</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> dataset:</span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> few_shot_examples <span class="op">+</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: row[<span class="st">'prompt'</span>]}]</span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a>        generation_args <span class="op">=</span> { </span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_new_tokens"</span>: <span class="dv">2</span>, </span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"return_full_text"</span>: <span class="va">False</span>, </span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"temperature"</span>: <span class="fl">0.1</span>, </span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"do_sample"</span>: <span class="va">True</span>, </span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-21"><a href="#cb213-21" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> pipe(messages, <span class="op">**</span>generation_args) </span>
<span id="cb213-22"><a href="#cb213-22" aria-hidden="true" tabindex="-1"></a>        responses.append(response[<span class="dv">0</span>][<span class="st">'generated_text'</span>].strip().lower())</span>
<span id="cb213-23"><a href="#cb213-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb213-24"><a href="#cb213-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate accuracy</span></span>
<span id="cb213-25"><a href="#cb213-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> dataset.to_pandas()</span>
<span id="cb213-26"><a href="#cb213-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> pd.Series(responses)</span>
<span id="cb213-27"><a href="#cb213-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'responses'</span>] <span class="op">=</span> df[<span class="st">'responses'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'negative'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>] <span class="cf">else</span> <span class="st">"other"</span>)</span>
<span id="cb213-28"><a href="#cb213-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lm_match'</span>] <span class="op">=</span> df[<span class="st">'label_text'</span>] <span class="op">==</span> df[<span class="st">'responses'</span>]</span>
<span id="cb213-29"><a href="#cb213-29" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> df.lm_match.mean()</span>
<span id="cb213-30"><a href="#cb213-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-231" class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>accs <span class="op">=</span> []</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>):</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    df, acc <span class="op">=</span> few_shot_responses(promptR_ds, promptP, examples)</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>    accs.append(acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The accuracy of this prompt is consistently around 93.9%.</p>
<div id="cell-233" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2024-09-12T14:12:47.911188Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-09-12T14:12:47.910833Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-09-12T14:12:47.936470Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-09-12T14:12:47.935054Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-09-12T14:12:47.911161Z&quot;}}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>pd.Series(accs).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>count    7.000000
mean     0.939139
std      0.000992
min      0.937611
25%      0.938503
50%      0.939394
75%      0.939840
max      0.940285
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Here is a summary of results including phi-2, phi-3, and the Claude family:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Prompting Strategy</th>
<th style="text-align: center;">Overall Accuracy</th>
<th style="text-align: center;"><code>negative</code></th>
<th style="text-align: center;"><code>neutral</code></th>
<th style="text-align: center;"><code>positive</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">claude-3-5-sonnet-20240620</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">94.78%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">94% (1302/1391)</td>
<td style="text-align: center;">95% (544/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">claude-3-opus-20240229</td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">94.13%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">96% (1333/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">phi-3.5</td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">93.94%</td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-3</td>
<td style="text-align: center;">30-Shot w/System Prompt</td>
<td style="text-align: center;">92.79%</td>
<td style="text-align: center;">98% (290/297)</td>
<td style="text-align: center;">94% (1284/1373)</td>
<td style="text-align: center;">88% (499/564)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">claude-3-haiku-20240307</td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">92.39%</td>
<td style="text-align: center;">90% (272/303)</td>
<td style="text-align: center;">91% (1267/1391)</td>
<td style="text-align: center;">96% (550/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;">phi-2</td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">91.94%</td>
<td style="text-align: center;">88% (267/302)</td>
<td style="text-align: center;">94% (1299/1387)</td>
<td style="text-align: center;">90% (510/569)</td>
</tr>
</tbody>
</table>
<p>Here are the per-prompt results from this notebook (phi-3.5):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">prompt</th>
<th style="text-align: center;">strategy</th>
<th style="text-align: center;">accuracy</th>
<th style="text-align: center;">negative</th>
<th style="text-align: center;">neutral</th>
<th style="text-align: center;">positive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-A">A</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">62.32%</td>
<td style="text-align: center;">98% (296/303)</td>
<td style="text-align: center;">43% (592/1391)</td>
<td style="text-align: center;">92% (523/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-B">B</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">88.60%</td>
<td style="text-align: center;">96% (290/303)</td>
<td style="text-align: center;">87% (1215/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-C">C</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">83.48%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">76% (1062/1391)</td>
<td style="text-align: center;">93% (530/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-D">D</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">68.64%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">51% (713/1391)</td>
<td style="text-align: center;">95% (541/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-E">E</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">88.25%</td>
<td style="text-align: center;">96% (290/303)</td>
<td style="text-align: center;">87% (1207/1391)</td>
<td style="text-align: center;">88% (501/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-F">F</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">84.65%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">77% (1070/1390)</td>
<td style="text-align: center;">96% (548/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-G">G</a></td>
<td style="text-align: center;">6-Shot</td>
<td style="text-align: center;">77.99%</td>
<td style="text-align: center;">98% (297/302)</td>
<td style="text-align: center;">66% (913/1387)</td>
<td style="text-align: center;">97% (551/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-H">H</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">83.06%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">74% (1028/1390)</td>
<td style="text-align: center;">97% (554/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-I">I</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">51.61%</td>
<td style="text-align: center;"><u><strong>100% (302/302)</strong></u></td>
<td style="text-align: center;">32% (447/1390)</td>
<td style="text-align: center;">73% (418/569)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-J">J</a></td>
<td style="text-align: center;">3-Shot</td>
<td style="text-align: center;">85.94%</td>
<td style="text-align: center;">98% (296/302)</td>
<td style="text-align: center;">80% (1108/1390)</td>
<td style="text-align: center;">95% (539/569)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-K">K</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">77.96%</td>
<td style="text-align: center;">98% (298/303)</td>
<td style="text-align: center;">66% (919/1391)</td>
<td style="text-align: center;">96% (548/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-L">L</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">80.57%</td>
<td style="text-align: center;">98% (297/303)</td>
<td style="text-align: center;">70% (972/1391)</td>
<td style="text-align: center;"><u><strong>97% (555/570)</strong></u></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-M">M</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">91.30%</td>
<td style="text-align: center;">97% (294/303)</td>
<td style="text-align: center;">90% (1257/1391)</td>
<td style="text-align: center;">91% (516/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-N">N</a></td>
<td style="text-align: center;">0-Shot w/System Prompt</td>
<td style="text-align: center;">88.74%</td>
<td style="text-align: center;">97% (295/303)</td>
<td style="text-align: center;">85% (1184/1391)</td>
<td style="text-align: center;">93% (530/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-O">O</a></td>
<td style="text-align: center;">0-Shot w/System Prompt</td>
<td style="text-align: center;">87.10%</td>
<td style="text-align: center;">94% (285/303)</td>
<td style="text-align: center;">83% (1156/1391)</td>
<td style="text-align: center;">93% (531/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-P">P</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">92.23%</td>
<td style="text-align: center;">94% (285/303)</td>
<td style="text-align: center;">94% (1307/1391)</td>
<td style="text-align: center;">87% (496/570)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-Q">Q</a></td>
<td style="text-align: center;">0-Shot</td>
<td style="text-align: center;">79.37%</td>
<td style="text-align: center;">99% (300/303)</td>
<td style="text-align: center;">73% (1009/1391)</td>
<td style="text-align: center;">86% (488/570)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u><strong><a href="#prompt-R">R</a></strong></u></td>
<td style="text-align: center;"><u><strong>20-Shot</strong></u></td>
<td style="text-align: center;"><u><strong>93.94%</strong></u></td>
<td style="text-align: center;">96% (286/299)</td>
<td style="text-align: center;">98% (1355/1379)</td>
<td style="text-align: center;">83% (467/566)</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><a href="#prompt-S">S</a></td>
<td style="text-align: center;">28-Shot</td>
<td style="text-align: center;">93.25%</td>
<td style="text-align: center;">94% (281/298)</td>
<td style="text-align: center;">99% (1358/1373)</td>
<td style="text-align: center;">79% (446/565)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="#prompt-T">T</a></td>
<td style="text-align: center;">20-Shot</td>
<td style="text-align: center;">84.54%</td>
<td style="text-align: center;">78% (232/299)</td>
<td style="text-align: center;"><u><strong>99.9% (1378/1379)</strong></u></td>
<td style="text-align: center;">51% (287/566)</td>
</tr>
</tbody>
</table>
<p>I ran inference for phi-3 and phi-3.5 in separate notebooks at the same time, so I have shared final thoughts for both:</p>
<ul>
<li><strong>Few-shot prompting in a chat format is a different experience</strong>: The sentence/label pairs have to be presented as a multi-turn conversation. For a large number of examples, this can lead to running out of GPU memory (as it did for 30-Shot prompting with phi-3.5).</li>
<li><strong>Few-shot example proportion matters</strong>: I used a higher proportion of neutral examples in my 20-shot prompt since the majority of the dataset is made up of <code>neutral</code> sentences. Determining whether the proportion I used is optimal would require further experimentation.</li>
<li><strong>20-Shot phi-3.5 approaches Opus, Sonnet and GPT4 accuracy</strong>: I was pleasantly surprised that phi-3.5 reached the 94% mark that was achieved by GPT4 (<a href="https://huggingface.co/blog/synthetic-data-save-costs">in the original work</a> by Moritz Laurer), and 3-Opus and 3.5-Sonnet in <a href="https://vishalbakshi.github.io/blog/posts/2024-08-29-tinysentiment-claude-experiments/">my previous experiments</a>.</li>
<li><strong>The best performing prompt suffers from a low true positive rate for <code>positive</code> sentiments</strong>: Although the 20-Shot phi-3.5 prompt achieved a high true positive rate (TPR) for <code>neutral</code> sentences (96%), it had one of the lowest TPRs for <code>positive</code> sentences (83%). It’s unclear if this is due to the imbalance between <code>positive</code> and <code>neutral</code> examples, since the TPR for <code>negative</code> sentiment is high (98%) despite having the same number of examples (4) as <code>positive</code>.</li>
<li><strong>phi-3 performed differently than phi-3.5</strong>: phi-3 performed well with a system prompt while phi-3.5 did not. On the other hand, phi-3.5 performed better with 0-Shot prompting than phi-3 (results not shown here).</li>
<li><strong>Future work</strong>: My next step is to run inference on this dataset using the Qwen2-1.5B model. After that, I’ll analyze the errors, especially for sentences that a majority of models classified incorrectly. With prompt engineering, there is potentially unlimited future work. Before I finish this project, I’ll try 30-Shot prompts for phi-2 and Haiku to see if they can beat phi-3’s 92.79% overall accuracy (and maybe even phi-3.5’s 93.94% accuracy).</li>
</ul>
<p>I hope you enjoyed this blog post! Follow me on Twitter <a href="https://twitter.com/vishal_learner"><span class="citation" data-cites="vishal_learner">@vishal_learner</span></a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vishalbakshi\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>