<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2021-06-04">

<title>vishal bakshi - fast.ai Chapter 8: Collaborative Filter Deep Dive</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">vishal bakshi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-collaborative-filtering" id="toc-what-is-collaborative-filtering" class="nav-link active" data-scroll-target="#what-is-collaborative-filtering">What is Collaborative Filtering?</a>
  <ul class="collapse">
  <li><a href="#latent-factors" id="toc-latent-factors" class="nav-link" data-scroll-target="#latent-factors">Latent Factors</a></li>
  </ul></li>
  <li><a href="#movielens-100k-dataset" id="toc-movielens-100k-dataset" class="nav-link" data-scroll-target="#movielens-100k-dataset">MovieLens 100K Dataset</a>
  <ul class="collapse">
  <li><a href="#matrices-for-latent-factors" id="toc-matrices-for-latent-factors" class="nav-link" data-scroll-target="#matrices-for-latent-factors">Matrices for Latent Factors</a></li>
  <li><a href="#embeddings-instead-of-one-hot-encoded-matrix-multiplication" id="toc-embeddings-instead-of-one-hot-encoded-matrix-multiplication" class="nav-link" data-scroll-target="#embeddings-instead-of-one-hot-encoded-matrix-multiplication">Embeddings instead of One Hot Encoded Matrix Multiplication</a></li>
  <li><a href="#building-a-collaborative-filtering-model-from-scratch" id="toc-building-a-collaborative-filtering-model-from-scratch" class="nav-link" data-scroll-target="#building-a-collaborative-filtering-model-from-scratch">Building a Collaborative Filtering Model from Scratch</a></li>
  <li><a href="#deep-learning-for-collaborative-filtering" id="toc-deep-learning-for-collaborative-filtering" class="nav-link" data-scroll-target="#deep-learning-for-collaborative-filtering">Deep Learning for Collaborative Filtering</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">fast.ai Chapter 8: Collaborative Filter Deep Dive</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">python</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 4, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Here’s the video walkthrough of this notebook</p>
<div id="cell-3" class="cell" data-outputid="43a671a1-6d4c-482a-90ac-8df4549a98cc" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">'&lt;iframe width="560" height="315" src="https://www.youtube.com/embed/MgRNk9DUqN8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen&gt;&lt;/iframe&gt;'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<iframe width="560" height="315" src="https://www.youtube.com/embed/MgRNk9DUqN8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="collaborative-filter-plot.png" class="img-fluid figure-img"></p>
<figcaption>Scatter plot for a 2-component Principal Component Analysis</figcaption>
</figure>
</div>
<p>In this notebook, I’ll walkthrough the code and concepts introduced in Chapter 8 of the fastai textbook. This chapter explores the various ways fastai can handle a collaborative filtering problem.</p>
<section id="what-is-collaborative-filtering" class="level2">
<h2 class="anchored" data-anchor-id="what-is-collaborative-filtering">What is Collaborative Filtering?</h2>
<p>In a situation where two variables have some numeric relationship, such as <strong>users</strong> rating <strong>movies</strong>, collaborative filtering is a solution for predicting ratings that are blank, based on existing data.</p>
<p>A machine learning model for collaborative filtering implicitly learns the answers to the following questions:</p>
<ul>
<li>What types of movies do users like?</li>
<li>What are characteristics of each movie?</li>
</ul>
<section id="latent-factors" class="level3">
<h3 class="anchored" data-anchor-id="latent-factors">Latent Factors</h3>
<p>For the movie rating example, latent factors are the “types of movies” users like and “characteristics” of each movie. Latent factors are not explicitly categorical, they are numeric values, but they represent the implicit categories of each variable.</p>
<p>The reason that they are implicit categories, is that the model learns the ideal latent factors as it trains on the dataset, observing patterns between users and their movie ratings.</p>
</section>
</section>
<section id="movielens-100k-dataset" class="level2">
<h2 class="anchored" data-anchor-id="movielens-100k-dataset">MovieLens 100K Dataset</h2>
<p>The dataset used to train the collaborative filtering model is a subset (100,000 rows in length) of the <a href="https://oreil.ly/gP3Q5">full MovieLens dataset</a> which is 25 million rows.</p>
<div id="cell-11" class="cell" data-outputid="12673166-c442-448d-81f9-facf8239c2ec">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a first look at the data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.collab <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.ML_100k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>The dataset lists users, movies, ratings and a timestamp.</p>
<div id="cell-13" class="cell" data-outputid="52152746-d754-4215-dc9a-87927626aed6">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data into a DataFrame</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'u.data'</span>, delimiter<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>, names<span class="op">=</span>[<span class="st">'user'</span>, <span class="st">'movie'</span>, <span class="st">'rating'</span>, <span class="st">'timestamp'</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ratings.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">timestamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
<td>881250949</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>186</td>
<td>302</td>
<td>3</td>
<td>891717742</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>377</td>
<td>1</td>
<td>878887116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>244</td>
<td>51</td>
<td>2</td>
<td>880606923</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>166</td>
<td>346</td>
<td>1</td>
<td>886397596</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Before we get into the training, I want to familiarize myself with how the data is structured. There are 943 unique users and 1682 unique movies.</p>
<div id="cell-15" class="cell" data-outputid="cfb4dcd5-008e-434e-df61-ebf7d630d68b">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many unique users and movies are there?</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(ratings[<span class="st">'user'</span>].unique()), <span class="bu">len</span>(ratings[<span class="st">'movie'</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(943, 1682)</code></pre>
</div>
</div>
<p>The movie IDs are a consecutive range from 1 to 1682 and the user IDs are a consecutive range from 1 to 943. The movie ratings range from 1 to 5.</p>
<div id="cell-17" class="cell" data-outputid="7c20e6f6-d2af-469b-9ffa-7ef6362d23fb">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># are movie IDs consecutive?</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>(ratings[<span class="st">'movie'</span>].sort_values().unique() <span class="op">==</span> np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">1683</span>))).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>1682</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-outputid="78e8df0c-2dfb-4308-811d-4bdaada2d747">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># are user IDs consecutive?</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>(ratings[<span class="st">'user'</span>].sort_values().unique() <span class="op">==</span> np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">944</span>))).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>943</code></pre>
</div>
</div>
<div id="cell-19" class="cell" data-outputid="23708cce-bc66-4774-cff4-9e2e01d3b848">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what is the range of ratings?</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ratings[<span class="st">'rating'</span>].<span class="bu">min</span>(), ratings[<span class="st">'rating'</span>].<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(1, 5)</code></pre>
</div>
</div>
<p>To visualize the problem we are trying to solve with collaborative filtering the book recommended that we observe a cross-tabulation of the data because then we can see that what we are trying to predict are the null values between user and movie, and what we are training our model on are the non-null ratings in the dataset.</p>
<p>The model will learn something about user 2 and movie 2 in order to predict what rating that user would give that movie. That “something” the model will learn are the latent factors for users and latent factors for movies.</p>
<div id="cell-21" class="cell" data-outputid="da05da90-befd-451a-eb31-853ec7151832">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view crosstab of users and movies with rating values</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> pd.crosstab(ratings[<span class="st">'user'</span>], ratings[<span class="st">'movie'</span>], ratings[<span class="st">'rating'</span>],aggfunc<span class="op">=</span><span class="st">'mean'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ct</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
<th data-quarto-table-cell-role="th">12</th>
<th data-quarto-table-cell-role="th">13</th>
<th data-quarto-table-cell-role="th">14</th>
<th data-quarto-table-cell-role="th">15</th>
<th data-quarto-table-cell-role="th">16</th>
<th data-quarto-table-cell-role="th">17</th>
<th data-quarto-table-cell-role="th">18</th>
<th data-quarto-table-cell-role="th">19</th>
<th data-quarto-table-cell-role="th">20</th>
<th data-quarto-table-cell-role="th">21</th>
<th data-quarto-table-cell-role="th">22</th>
<th data-quarto-table-cell-role="th">23</th>
<th data-quarto-table-cell-role="th">24</th>
<th data-quarto-table-cell-role="th">25</th>
<th data-quarto-table-cell-role="th">26</th>
<th data-quarto-table-cell-role="th">27</th>
<th data-quarto-table-cell-role="th">28</th>
<th data-quarto-table-cell-role="th">29</th>
<th data-quarto-table-cell-role="th">30</th>
<th data-quarto-table-cell-role="th">31</th>
<th data-quarto-table-cell-role="th">32</th>
<th data-quarto-table-cell-role="th">33</th>
<th data-quarto-table-cell-role="th">34</th>
<th data-quarto-table-cell-role="th">35</th>
<th data-quarto-table-cell-role="th">36</th>
<th data-quarto-table-cell-role="th">37</th>
<th data-quarto-table-cell-role="th">38</th>
<th data-quarto-table-cell-role="th">39</th>
<th data-quarto-table-cell-role="th">40</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">1643</th>
<th data-quarto-table-cell-role="th">1644</th>
<th data-quarto-table-cell-role="th">1645</th>
<th data-quarto-table-cell-role="th">1646</th>
<th data-quarto-table-cell-role="th">1647</th>
<th data-quarto-table-cell-role="th">1648</th>
<th data-quarto-table-cell-role="th">1649</th>
<th data-quarto-table-cell-role="th">1650</th>
<th data-quarto-table-cell-role="th">1651</th>
<th data-quarto-table-cell-role="th">1652</th>
<th data-quarto-table-cell-role="th">1653</th>
<th data-quarto-table-cell-role="th">1654</th>
<th data-quarto-table-cell-role="th">1655</th>
<th data-quarto-table-cell-role="th">1656</th>
<th data-quarto-table-cell-role="th">1657</th>
<th data-quarto-table-cell-role="th">1658</th>
<th data-quarto-table-cell-role="th">1659</th>
<th data-quarto-table-cell-role="th">1660</th>
<th data-quarto-table-cell-role="th">1661</th>
<th data-quarto-table-cell-role="th">1662</th>
<th data-quarto-table-cell-role="th">1663</th>
<th data-quarto-table-cell-role="th">1664</th>
<th data-quarto-table-cell-role="th">1665</th>
<th data-quarto-table-cell-role="th">1666</th>
<th data-quarto-table-cell-role="th">1667</th>
<th data-quarto-table-cell-role="th">1668</th>
<th data-quarto-table-cell-role="th">1669</th>
<th data-quarto-table-cell-role="th">1670</th>
<th data-quarto-table-cell-role="th">1671</th>
<th data-quarto-table-cell-role="th">1672</th>
<th data-quarto-table-cell-role="th">1673</th>
<th data-quarto-table-cell-role="th">1674</th>
<th data-quarto-table-cell-role="th">1675</th>
<th data-quarto-table-cell-role="th">1676</th>
<th data-quarto-table-cell-role="th">1677</th>
<th data-quarto-table-cell-role="th">1678</th>
<th data-quarto-table-cell-role="th">1679</th>
<th data-quarto-table-cell-role="th">1680</th>
<th data-quarto-table-cell-role="th">1681</th>
<th data-quarto-table-cell-role="th">1682</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>5.0</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>3.0</td>
<td>5.0</td>
<td>4.0</td>
<td>1.0</td>
<td>5.0</td>
<td>3.0</td>
<td>2.0</td>
<td>5.0</td>
<td>5.0</td>
<td>5.0</td>
<td>5.0</td>
<td>5.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
<td>4.0</td>
<td>1.0</td>
<td>4.0</td>
<td>4.0</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>2.0</td>
<td>4.0</td>
<td>1.0</td>
<td>3.0</td>
<td>3.0</td>
<td>5.0</td>
<td>4.0</td>
<td>2.0</td>
<td>1.0</td>
<td>2.0</td>
<td>2.0</td>
<td>3.0</td>
<td>4.0</td>
<td>3.0</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>4.0</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">939</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">940</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>5.0</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">941</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">942</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">943</td>
<td>NaN</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3.0</td>
<td>NaN</td>
<td>4.0</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>4.0</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>943 rows × 1682 columns</p>
</div>
</div>
</div>
</div>
<p>Instead of movie IDs, we can get the movie titles into a DataFrame and add that column to our <code>ratings</code> DataFrame by merging the two.</p>
<p>The movie titles are in the <code>u.item</code> file, which is pipe-delimited, with latin-1 encoding. The <code>u.item</code> file has 24 columns, but we only want the first two which have the <code>movie</code> id and the <code>title</code>.</p>
<div id="cell-23" class="cell" data-outputid="7d573468-c7ab-4a9d-989f-8d71f09df3cb">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get movie titles</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>movies <span class="op">=</span> pd.read_csv(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    path<span class="op">/</span><span class="st">'u.item'</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    delimiter<span class="op">=</span><span class="st">'|'</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    encoding<span class="op">=</span><span class="st">'latin-1'</span>, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    usecols<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>), </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span>(<span class="st">'movie'</span>, <span class="st">'title'</span>), </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>movies.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Toy Story (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>GoldenEye (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Four Rooms (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>Get Shorty (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>Copycat (1995)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>The <code>movies</code> DataFrame and the <code>ratings</code> DataFrame are merged using the <code>movie</code> column as the key to match title in <code>movies</code> to <code>movie</code> ID in <code>ratings</code>. By default, pandas uses as the <code>key</code> whichever column name exists in both DataFrames.</p>
<div id="cell-25" class="cell" data-outputid="1c73f7b4-12de-4715-e316-43b8ce4ed33f">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the user ratings by title</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> ratings.merge(movies)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>ratings.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
<td>881250949</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>63</td>
<td>242</td>
<td>3</td>
<td>875747190</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>226</td>
<td>242</td>
<td>5</td>
<td>883888671</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>154</td>
<td>242</td>
<td>3</td>
<td>879138235</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>306</td>
<td>242</td>
<td>5</td>
<td>876503793</td>
<td>Kolya (1996)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Does this change the uniqueness of the data? Yes it actually does! There are 1682 unique movie IDs but there are only 1664 unique movie titles. 18 movies have associated with it duplicate titles.</p>
<div id="cell-27" class="cell" data-outputid="d013b37e-9323-477a-dcb3-186c88fa874e">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many unique titles and movies are there?</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(ratings[<span class="st">'title'</span>].unique()), <span class="bu">len</span>(ratings[<span class="st">'movie'</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(1664, 1682)</code></pre>
</div>
</div>
<p>The <code>.duplicated</code> DataFrame method takes a list of columns for the <code>subset</code> parameter, finds values in those columns that are duplicated, and returns a boolean Series with a <code>True</code> value at indexes with duplicates. I use that as a mask and pass it to the <code>movies</code> DataFrame to view those duplicate titles.</p>
<div id="cell-29" class="cell" data-outputid="ef03ac5f-24af-48ef-d5c5-f63f6a34240e">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 18 movies have duplicate titles</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>movies[movies.duplicated(subset<span class="op">=</span>[<span class="st">'title'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">267</td>
<td>268</td>
<td>Chasing Amy (1997)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">302</td>
<td>303</td>
<td>Ulee's Gold (1997)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">347</td>
<td>348</td>
<td>Desperate Measures (1998)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">499</td>
<td>500</td>
<td>Fly Away Home (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">669</td>
<td>670</td>
<td>Body Snatchers (1993)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">679</td>
<td>680</td>
<td>Kull the Conqueror (1997)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">864</td>
<td>865</td>
<td>Ice Storm, The (1997)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">880</td>
<td>881</td>
<td>Money Talks (1997)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1002</td>
<td>1003</td>
<td>That Darn Cat! (1997)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1256</td>
<td>1257</td>
<td>Designated Mourner, The (1997)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1605</td>
<td>1606</td>
<td>Deceiver (1997)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1606</td>
<td>1607</td>
<td>Hurricane Streets (1998)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1616</td>
<td>1617</td>
<td>Hugo Pool (1997)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1624</td>
<td>1625</td>
<td>Nightwatch (1997)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1649</td>
<td>1650</td>
<td>Butcher Boy, The (1998)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1653</td>
<td>1654</td>
<td>Chairman of the Board (1998)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1657</td>
<td>1658</td>
<td>Substance of Fire, The (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1679</td>
<td>1680</td>
<td>Sliding Doors (1998)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>fastai has a built-in constructor for DataLoaders specific to collaborative filtering. I pass it the ratings DataFrame, specify that the items are the titles, and that I want 64 rows in each batch.</p>
<div id="cell-31" class="cell" data-outputid="9bdc3642-082a-4b77-e91a-a15b41348276">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create DataLoaders</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> CollabDataLoaders.from_df(ratings, item_name<span class="op">=</span><span class="st">'title'</span>, bs<span class="op">=</span><span class="dv">64</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>297</td>
<td>Indian Summer (1996)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>934</td>
<td>Grease (1978)</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>846</td>
<td>Money Train (1995)</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>479</td>
<td>Crumb (1994)</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>499</td>
<td>Local Hero (1983)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>455</td>
<td>Adventures of Priscilla, Queen of the Desert, The (1994)</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>943</td>
<td>Rumble in the Bronx (1995)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>374</td>
<td>Dead Poets Society (1989)</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>533</td>
<td>Deer Hunter, The (1978)</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>846</td>
<td>Vanya on 42nd Street (1994)</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="matrices-for-latent-factors" class="level3">
<h3 class="anchored" data-anchor-id="matrices-for-latent-factors">Matrices for Latent Factors</h3>
<p>We need the model to find relationships between users and movies. And we need to give the model something concrete and numeric to represent those relationships. We will give it latent factor matrices.</p>
<p>In this example, they have chosen to use 5 latent factors for movies and 5 latent factors for users. We represent these latent factors by creating a matrix of random values.</p>
<p>The user latent factors will have 944 rows, one for each user including a null user, and 5 columns, one for each latent factor. The movies latent factors will have 1665, one for each movie including a null movie, and 5 columns.</p>
<div id="cell-35" class="cell" data-outputid="a6e7ce10-2983-4154-9a18-cf9998496448">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># user and title classes contain '#na#'</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>L(dls.classes[<span class="st">'title'</span>]),L(dls.classes[<span class="st">'user'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>((#1665) ['#na#',"'Til There Was You (1997)",'1-900 (1994)','101 Dalmatians (1996)','12 Angry Men (1957)','187 (1997)','2 Days in the Valley (1996)','20,000 Leagues Under the Sea (1954)','2001: A Space Odyssey (1968)','3 Ninjas: High Noon At Mega Mountain (1998)'...],
 (#944) ['#na#',1,2,3,4,5,6,7,8,9...])</code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-outputid="59403097-9ada-494e-db16-366d66f00fec">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define dimensions for users and movies latent factor matrices</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>n_users <span class="op">=</span> <span class="bu">len</span>(dls.classes[<span class="st">'user'</span>])</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>n_movies <span class="op">=</span> <span class="bu">len</span>(dls.classes[<span class="st">'title'</span>])</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>n_factors <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>n_users, n_movies, n_factors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>(944, 1665, 5)</code></pre>
</div>
</div>
<div id="cell-37" class="cell" data-outputid="956c966d-e654-43eb-8871-1bee2e2d18df">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build users and movies latent factor matrices</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>user_factors <span class="op">=</span> torch.randn(n_users,n_factors)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>movie_factors <span class="op">=</span> torch.randn(n_movies, n_factors)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>user_factors.shape, movie_factors.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>(torch.Size([944, 5]), torch.Size([1665, 5]))</code></pre>
</div>
</div>
</section>
<section id="embeddings-instead-of-one-hot-encoded-matrix-multiplication" class="level3">
<h3 class="anchored" data-anchor-id="embeddings-instead-of-one-hot-encoded-matrix-multiplication">Embeddings instead of One Hot Encoded Matrix Multiplication</h3>
<p>Okay so how do we use these latent factor matrices?</p>
<p>For each row in our batch, we have a user ID and a movie ID. We need to get the latent factors for each of those and calculate the dot product, in order to predict our rating. As it adjusts the latent factors during the training loop, the predictions will get better.</p>
<p>I’ll grab one batch from the <code>dls</code> DataLoaders object and illustrate an example prediction calculation. Each independent variable, <code>x</code>, is a tensor with <code>[user, movie]</code>. Each dependent variable, <code>y</code>, is a tensor with <code>[rating]</code>.</p>
<div id="cell-40" class="cell" data-outputid="70a2cb01-92e1-4a9c-96a1-044c44697b87">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dls.one_batch()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>x.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>(torch.Size([64, 2]), torch.Size([64, 1]))</code></pre>
</div>
</div>
<div id="cell-41" class="cell" data-outputid="b98e3c7f-cc90-4e33-8826-13be7c53c61a">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>], y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>(tensor([466, 614]), tensor([3], dtype=torch.int8))</code></pre>
</div>
</div>
<div id="cell-42" class="cell" data-outputid="64712d98-95dd-4d5c-e5ec-bad1a7b9f121">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>]), <span class="bu">type</span>(y[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>(torch.Tensor, torch.Tensor)</code></pre>
</div>
</div>
<p>I determined the order of the x values by looking at the maximum value in each column, specifying axis=0. The movie IDs go up to 1644, so a max value of 1608 means that the movie is the second value in each tensor.</p>
<div id="cell-44" class="cell" data-outputid="78a3b3df-d463-4f3e-f178-48748e5a040e">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>x.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>torch.return_types.max(values=tensor([ 935, 1642]), indices=tensor([24,  3]))</code></pre>
</div>
</div>
<p>I get the latent factors for the user and movie in the first batch item.</p>
<div id="cell-46" class="cell" data-outputid="8b130e8c-82b8-4359-8fd5-2cda18c1600c">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> user_factors[x[<span class="dv">0</span>][<span class="dv">0</span>]]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>tensor([-0.6595, -0.3355,  1.0491,  1.1764,  0.8750])</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-outputid="c880d222-3091-4bfe-b2e2-7453246e6ae0">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> movie_factors[x[<span class="dv">0</span>][<span class="dv">1</span>]]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>tensor([-0.1751, -0.5016,  0.6298,  0.2370, -0.7902])</code></pre>
</div>
</div>
<p>I calculate the dot product of the two vectors, which is the sum of the element-wise product.</p>
<div id="cell-49" class="cell" data-outputid="26a6e28b-f782-4115-a4fe-524f319b702c">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> (u <span class="op">*</span> m).<span class="bu">sum</span>()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>tensor(0.5320)</code></pre>
</div>
</div>
<p>I pass it through <code>sigmoid_range</code> to get a value between 0 and 5. Sigmoid outputs a value between 0 and 1, and <code>sigmoid_range</code> scales and shifts that function to fit the specified range. The output is the prediction for the rating that this user would give this movie.</p>
<div id="cell-51" class="cell" data-outputid="97192df5-b9c1-4433-eb67-5112aa7c69b3">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> sigmoid_range(pred, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>tensor(3.1497)</code></pre>
</div>
</div>
<p>Since the prediction and the target are a single numeric value, we’ll use Mean Squared Error loss. For a single value, the loss is the squared error. For a batch, the mean would be calculated.</p>
<div id="cell-53" class="cell" data-outputid="ccc0d923-8a90-495b-9e5b-42108f8a3aa2">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> (pred <span class="op">-</span> y[<span class="dv">0</span>].item()) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor(0.0224)</code></pre>
</div>
</div>
</section>
<section id="building-a-collaborative-filtering-model-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="building-a-collaborative-filtering-model-from-scratch">Building a Collaborative Filtering Model from Scratch</h3>
<p>I’ll create a <code>DotProduct</code> class which builds an <code>Embedding</code> to store latent factor matrices for users and movies, and calculates the prediction in its <code>forward</code> method using the dot product of the user and movie latent factors.</p>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProduct(Module):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors, y_range<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">5.5</span>)):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> <span class="va">self</span>.movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigmoid_range((users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>), <span class="op">*</span><span class="va">self</span>.y_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll illustrate how this model operates by coding through the calculation of predictions for one batch.</p>
<p>I create Embeddings for users and movies. Their shape corresponds to the number of users and movies and the number of latent factors.</p>
<div id="cell-58" class="cell" data-outputid="12c82d07-997e-4b4b-9058-4f799ded40cb">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>user_factors, movie_factors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>(Embedding(944, 5), Embedding(1665, 5))</code></pre>
</div>
</div>
<p>The <code>weight</code> attribute holds the latent factor values, which are parameters whose gradient can be calculated. The values are from a normal distribution with mean 0 and variance 1.</p>
<div id="cell-60" class="cell" data-outputid="0b3e699b-9651-4d69-cfd4-a8f28618f349">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>user_factors.weight.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>torch.Size([944, 5])</code></pre>
</div>
</div>
<div id="cell-61" class="cell" data-outputid="6ec97c4c-e460-4d8f-916d-d9bf2b7fc00b">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>user_factors.weight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>Parameter containing:
tensor([[-0.0066, -0.0111,  0.0091,  0.0056,  0.0075],
        [-0.0138, -0.0014,  0.0189,  0.0028, -0.0166],
        [ 0.0149,  0.0053, -0.0153,  0.0078, -0.0119],
        ...,
        [-0.0051, -0.0117,  0.0170, -0.0102, -0.0044],
        [ 0.0037, -0.0084,  0.0042, -0.0049,  0.0186],
        [ 0.0199, -0.0194,  0.0044,  0.0012,  0.0084]], requires_grad=True)</code></pre>
</div>
</div>
<p>The user_factors weight has the shape 944 rows by 5 columns. You can see that they are a tensor with requires_grad equals True.</p>
<div id="cell-63" class="cell" data-outputid="55643cd1-a117-41c6-c00d-46dd3d201eb4">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>movie_factors.weight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>Parameter containing:
tensor([[-0.0017, -0.0051,  0.0065,  0.0050, -0.0095],
        [-0.0065, -0.0158,  0.0062, -0.0145, -0.0087],
        [ 0.0067,  0.0111,  0.0059, -0.0003,  0.0061],
        ...,
        [-0.0012,  0.0002, -0.0088, -0.0022, -0.0152],
        [-0.0053, -0.0058, -0.0074, -0.0033, -0.0171],
        [ 0.0030,  0.0031, -0.0037, -0.0023,  0.0157]], requires_grad=True)</code></pre>
</div>
</div>
<p>The movie_factors weight has the shape 1665 rows by 5 columns. And here you can see it is a tensor as well with requires_grad equals True.</p>
<div id="cell-65" class="cell" data-outputid="44b895f9-4ab2-4e66-f1d8-cd4fba4002df">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>movie_factors.weight.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>torch.Size([1665, 5])</code></pre>
</div>
</div>
<p>In my batch, the 0th column of the dependent variable x holds user indexes. I pass that to user_factors and receive a tensor with those users’ latent factors. Column index 1 holds the movie indexes, I pass that to movie_factors and receive a tensor with those movies’ latent factors.</p>
<div id="cell-67" class="cell" data-outputid="7be857d3-9691-4d53-d855-8750b34fd58c">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>users[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>tensor([[ 0.0029,  0.0042, -0.0093,  0.0023, -0.0053],
        [ 0.0029,  0.0008,  0.0193,  0.0082,  0.0117],
        [-0.0025,  0.0070, -0.0144, -0.0193,  0.0086],
        [ 0.0103,  0.0028,  0.0172,  0.0110,  0.0084],
        [-0.0087, -0.0109,  0.0062, -0.0018, -0.0012]],
       grad_fn=&lt;SliceBackward&gt;)</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-outputid="dde35133-ea99-48d4-f460-f391a19edf7d">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>movies <span class="op">=</span> movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>movies[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>tensor([[ 0.0011, -0.0009,  0.0114,  0.0017,  0.0033],
        [ 0.0049, -0.0019,  0.0175,  0.0027, -0.0014],
        [-0.0047, -0.0026,  0.0032,  0.0028, -0.0146],
        [-0.0103, -0.0024,  0.0057, -0.0141, -0.0080],
        [ 0.0099,  0.0113,  0.0022,  0.0123,  0.0096]],
       grad_fn=&lt;SliceBackward&gt;)</code></pre>
</div>
</div>
<p>I take the dot product and pass it through a sigmoid_range and the calculate the predictions for the batch.</p>
<div id="cell-70" class="cell" data-outputid="e7ffd9d2-e66e-447f-b096-4f1e5385e804">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> sigmoid_range((users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>), <span class="dv">0</span>, <span class="fl">5.5</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>preds, preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>(tensor([2.7498, 2.7505, 2.7497, 2.7497, 2.7497, 2.7501, 2.7495, 2.7506, 2.7499,
         2.7502, 2.7503, 2.7506, 2.7501, 2.7498, 2.7497, 2.7507, 2.7498, 2.7497,
         2.7499, 2.7500, 2.7499, 2.7500, 2.7502, 2.7501, 2.7502, 2.7499, 2.7500,
         2.7499, 2.7499, 2.7501, 2.7503, 2.7497, 2.7500, 2.7498, 2.7497, 2.7496,
         2.7502, 2.7502, 2.7501, 2.7498, 2.7501, 2.7502, 2.7500, 2.7501, 2.7506,
         2.7500, 2.7498, 2.7499, 2.7501, 2.7502, 2.7502, 2.7501, 2.7498, 2.7501,
         2.7501, 2.7499, 2.7499, 2.7499, 2.7498, 2.7502, 2.7499, 2.7498, 2.7494,
         2.7499], grad_fn=&lt;AddBackward0&gt;), torch.Size([64]))</code></pre>
</div>
</div>
<p>That’s what the <code>DotProduct</code> model will return. I can then take the mean squared error and calculate the loss value, which I can then call backward on, to calculate the gradients for the latent factors. I can then multiply them by the learning rate, and add them to the weights, and repeat the training loop.</p>
<div id="cell-72" class="cell" data-outputid="11d858a6-8e7c-4eeb-c638-f730803fb143">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> ((preds <span class="op">-</span> y) <span class="op">**</span> <span class="dv">2</span>).mean()</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>tensor(2.0156, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell" data-outputid="d00d5490-b2b4-4bd0-be8d-c2b53dfaaed5">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>user_factors.weight.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>tensor([[0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        ...,
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-outputid="a98901ac-0d97-41f2-96dc-397b441144f1">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>movie_factors.weight.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>tensor([[0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        ...,
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<p>We see here that the gradients are small but not all of them are zero:</p>
<div id="cell-77" class="cell" data-outputid="a5a554f2-d4f3-498b-e346-f97e841a84f2">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>user_factors.weight.grad.<span class="bu">sum</span>(), movie_factors.weight.grad.<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>(tensor(-0.0108), tensor(-0.0026))</code></pre>
</div>
</div>
<section id="training-the-model" class="level4">
<h4 class="anchored" data-anchor-id="training-the-model">Training the Model</h4>
<p>There are five different models that I will build, from simple to complex.</p>
<p><em>Model 1</em> will not use <code>sigmoid_range</code> for the dot product prediction calculation. Instead, I will get a value that is normally distributed with a mean of zero and a variance of 1. <em>Model 2</em> will pass the predictions through <code>sigmoid_range</code> to get an output between 0 and 5.5. <em>Model 3</em> will add a bias parameter to the dot product prediction, so that we can establish some baseline rating of each movie that’s independent of a particular latent factor. <em>Model 4</em> will introduce weight decay in order to better generalize our model, and in <em>Model 5</em> I’ll implement a custom class instead of using the built-in PyTorch Embedding class.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Model</th>
<th style="text-align: center;"><code>sigmoid_range</code></th>
<th style="text-align: center;">Bias</th>
<th style="text-align: center;">Weight Decay</th>
<th style="text-align: center;">Custom Embedding</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">N</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Y</td>
</tr>
</tbody>
</table>
<section id="model-1-no-sigmoid_range" class="level5">
<h5 class="anchored" data-anchor-id="model-1-no-sigmoid_range">Model 1: No <code>sigmoid_range</code></h5>
<p>The <code>DotProduct</code> class will initialize an <code>Embedding</code> for users and movies with random values from a normal distribution with mean 0 and variance 1. In the <code>forward</code> method, called during the <em>prediction</em> step of the training loop, the latent factors for the batch’s users and movies are accessed from the corresponding <code>Embedding</code> and the dot product is calculated and returned as the prediction.</p>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProduct(Module):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors):</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> <span class="va">self</span>.movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell" data-outputid="3b7098d2-fe80-48c9-998b-b9b0b24e5f0e">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProduct(n_users, n_movies, <span class="dv">50</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>MSELossFlat())</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>,<span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.339355</td>
<td>1.274582</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.039260</td>
<td>1.061794</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.945793</td>
<td>0.954731</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.826578</td>
<td>0.871694</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.752750</td>
<td>0.858231</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The average prediction error on the validation ratings is the square root of the final validation loss.</p>
<div id="cell-85" class="cell" data-outputid="cf511824-1d9b-4fd8-cb69-c6f71e51a040">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>math.sqrt(learn.recorder.final_record[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>0.9264077107145671</code></pre>
</div>
</div>
<p>Here are some predictions on the validation set ratings:</p>
<div id="cell-87" class="cell" data-outputid="81eab572-4349-4cab-8ca4-6b1dda7398bf">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">rating_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>554</td>
<td>37</td>
<td>4</td>
<td>4.181926</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>561</td>
<td>811</td>
<td>4</td>
<td>3.008064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>503</td>
<td>298</td>
<td>5</td>
<td>4.451642</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>380</td>
<td>581</td>
<td>4</td>
<td>3.474877</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>666</td>
<td>422</td>
<td>4</td>
<td>4.054492</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>444</td>
<td>933</td>
<td>2</td>
<td>3.940120</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>368</td>
<td>1612</td>
<td>3</td>
<td>2.864129</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>537</td>
<td>457</td>
<td>3</td>
<td>2.955165</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>224</td>
<td>1535</td>
<td>1</td>
<td>2.940819</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="model-2---with-sigmoid_range" class="level5">
<h5 class="anchored" data-anchor-id="model-2---with-sigmoid_range">Model 2 - with <code>sigmoid_range</code></h5>
<p>In this model, I’ll force the predictions to fall within the range of actual ratings. The book recommends, based on what they’ve experienced, using a maximum rating for predictions that is slightly larger than the maximum ground truth rating. The range of predictions we’ll use is 0 to 5.5.</p>
<div id="cell-90" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProduct(Module):</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors, y_range<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">5.5</span>)):</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> <span class="va">self</span>.movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigmoid_range((users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>), <span class="op">*</span><span class="va">self</span>.y_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-91" class="cell" data-outputid="b6b1f4c1-70fb-4e8d-a5e8-199051f637fa">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProduct(n_users, n_movies, <span class="dv">50</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>MSELossFlat())</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>,<span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.009657</td>
<td>0.977510</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.881551</td>
<td>0.891973</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.686247</td>
<td>0.853506</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.487054</td>
<td>0.857519</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.374934</td>
<td>0.862651</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-92" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>math.sqrt(learn.recorder.final_record[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The valid loss starts off lower, but by the end of the training, I don’t see an improvement. In fact, the valid loss starts to increase at the end. This is an indication that overfitting is taking place. This will be addressed in Model 4.</p>
</section>
<section id="model-3---add-bias" class="level5">
<h5 class="anchored" data-anchor-id="model-3---add-bias">Model 3 - Add bias</h5>
<p>But first, let’s look at Model 3, which adds a bias parameter to the predictions, which provides a baseline rating for each movie independent of the weights related to the different latent factors.</p>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProductBias(Module):</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors, y_range<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">5.5</span>)):</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_bias <span class="op">=</span> Embedding(n_users, <span class="dv">1</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_bias <span class="op">=</span> Embedding(n_movies, <span class="dv">1</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> <span class="va">self</span>.movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> (users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    res <span class="op">+=</span> <span class="va">self</span>.user_bias(x[:,<span class="dv">0</span>]) <span class="op">+</span> <span class="va">self</span>.movie_bias(x[:,<span class="dv">1</span>])</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigmoid_range(res, <span class="op">*</span><span class="va">self</span>.y_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition to initializing new Embeddings for bias, the dot product is first kept in matrix form by passing <code>keepdim=True</code> to the <code>sum</code> method. The biases are then added on afterwhich the result is passed through <code>sigmoid_range</code>. Here’s a illustrative example for how <code>keepdim=True</code> affects the dot product:</p>
<div id="cell-99" class="cell" data-outputid="b3e70771-e340-4270-c6ee-34ad607a0297">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> Tensor([[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>], [<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]])</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>(a <span class="op">*</span> a).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>).shape, (a <span class="op">*</span> a).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>(torch.Size([2]), torch.Size([2, 1]))</code></pre>
</div>
</div>
<p>The first tensor is a 2-vector, whereas the second tensor is a 2 x 1 matrix.</p>
<hr>
<p>Let’s train Model 3 and view the results!</p>
<div id="cell-101" class="cell" data-outputid="760fc64a-49db-4e64-d283-b7a65c8f1166">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProductBias(n_users, n_movies, <span class="dv">50</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>MSELossFlat())</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>,<span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.952214</td>
<td>0.912603</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.825348</td>
<td>0.845193</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.618910</td>
<td>0.852381</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.406514</td>
<td>0.875637</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.293729</td>
<td>0.882840</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The initial validation loss is lower than the previous trainings, but Model 3 is overfitting even more than Model 2. It’s time to introduce <em>weight decay</em>.</p>
</section>
<section id="model-4---use-weight-decay" class="level5">
<h5 class="anchored" data-anchor-id="model-4---use-weight-decay">Model 4 - Use Weight Decay</h5>
<p>Smaller weights lead to a smoother function which corresponds to fewer inflection points, leading to a better generalization of the model. Larger weights lead to a sharper function, corresponding to more inflection points which overfit the training data.</p>
<p>The text uses the basic example of a parabola to illustrate. As the weight <code>a</code> increases, the function becomes narrower, with a sharper trough.</p>
<div id="cell-106" class="cell" data-outputid="a194620f-307a-4643-a275-d1a76ae99862">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">'&lt;iframe src="https://www.desmos.com/calculator/uog6rvyubg" width="500" height="500" style="border: 1px solid #ccc" frameborder=0&gt;&lt;/iframe&gt;'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<iframe src="https://www.desmos.com/calculator/uog6rvyubg" width="500" height="500" style="border: 1px solid #ccc" frameborder="0"></iframe>
</div>
</div>
<p>We will intentionally increase the gradients so that the weights are stepped with larger increments toward a smaller value.</p>
<p>This corresponds to an intentionally larger loss value calculated for each batch:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>loss_with_wd <span class="op">=</span> loss <span class="op">+</span> wd <span class="op">*</span> (parameters<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The parameters are squared to ensure a positive value. Taking the derivative of the loss function means taking the derivative of the following function:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>wd <span class="op">*</span> (parameters<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which results in:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">*</span> wd <span class="op">*</span> parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead of multiplying by 2, we can just use twice the weight decay value as <code>wd</code>. I’ll use a weight decay of <code>0.1</code> as they do in the text.</p>
<div id="cell-108" class="cell" data-outputid="d70a2940-9c6a-419d-f69a-afa29c06a1a7">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProductBias(n_users, n_movies, <span class="dv">50</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>MSELossFlat())</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>,<span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.939321</td>
<td>0.937423</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.851871</td>
<td>0.855584</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.720202</td>
<td>0.815807</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.630149</td>
<td>0.806268</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.491224</td>
<td>0.807063</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-109" class="cell" data-outputid="54927e83-fa93-4216-f83a-8dca8be0c3d6">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">rating_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>877</td>
<td>1538</td>
<td>3</td>
<td>3.708797</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>601</td>
<td>1285</td>
<td>1</td>
<td>2.832736</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>292</td>
<td>1147</td>
<td>2</td>
<td>3.675529</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>132</td>
<td>400</td>
<td>4</td>
<td>3.504542</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>405</td>
<td>1614</td>
<td>1</td>
<td>1.930779</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>655</td>
<td>458</td>
<td>3</td>
<td>3.274209</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>453</td>
<td>60</td>
<td>4</td>
<td>3.864617</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>629</td>
<td>1498</td>
<td>4</td>
<td>3.598821</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>724</td>
<td>580</td>
<td>4</td>
<td>3.921505</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="model-5---custom-embedding-class" class="level5">
<h5 class="anchored" data-anchor-id="model-5---custom-embedding-class">Model 5 - custom Embedding class</h5>
<p>The final model I’ll train does not have a fundamentally different component than the other four. Instead of using the built-in <code>Embedding</code> PyTorch class, the text has us write our own class.</p>
<p>Optimizers get a module’s parameters by calling the <code>parameters</code> method. We have to wrap parameters in <code>nn.Parameter</code> for them to be recognized as such. This class also calls <code>requires_grad_</code> for us.</p>
<p>I’ll replace each <code>Embedding</code> with a tensor filled with random values from a normal distribution with mean 0 and variance 0.01.</p>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_params(size):</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> nn.Parameter(torch.zeros(<span class="op">*</span>size).normal_(<span class="dv">0</span>,<span class="fl">0.01</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-113" class="cell" data-outputid="513200ed-28ef-448b-aa14-28a34dc429e3">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>torch.zeros(<span class="dv">3</span>,<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>tensor([[0., 0., 0., 0.],
        [0., 0., 0., 0.],
        [0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="cell-114" class="cell" data-outputid="bb7a14ef-7e57-40a1-da08-f76c0f81e33f">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>torch.zeros(<span class="dv">3</span>,<span class="dv">4</span>).normal_(<span class="dv">0</span>,<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>tensor([[-0.0134,  0.0098, -0.0124, -0.0032],
        [ 0.0056,  0.0071,  0.0005,  0.0014],
        [-0.0236, -0.0024, -0.0060,  0.0017]])</code></pre>
</div>
</div>
<p>I redefine the <code>DotProductBias</code> model using the <code>create_params</code> method instead of <code>Embedding</code>, and train the model.<em>italicized text</em></p>
<div id="cell-116" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProductBias(Module):</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors, y_range<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">5.5</span>)):</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> create_params([n_users, n_factors])</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_bias <span class="op">=</span> create_params([n_users])</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_factors <span class="op">=</span> create_params([n_movies, n_factors])</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.movie_bias <span class="op">=</span> create_params([n_movies])</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> <span class="va">self</span>.user_factors[x[:,<span class="dv">0</span>]]</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    movies <span class="op">=</span> <span class="va">self</span>.movie_factors[x[:,<span class="dv">1</span>]]</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> (users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    res <span class="op">+=</span> <span class="va">self</span>.user_bias[x[:,<span class="dv">0</span>]] <span class="op">+</span> <span class="va">self</span>.movie_bias[x[:,<span class="dv">1</span>]]</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigmoid_range(res, <span class="op">*</span><span class="va">self</span>.y_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-117" class="cell" data-outputid="7a7c03d6-2ce8-4a34-9589-d43c0ef684f7">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProductBias(n_users, n_movies, <span class="dv">50</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>MSELossFlat())</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>,<span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.934845</td>
<td>0.933218</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.841111</td>
<td>0.859618</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.730065</td>
<td>0.820388</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.599684</td>
<td>0.807086</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.484760</td>
<td>0.807552</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-118" class="cell" data-outputid="d36e0e2f-3613-4a7f-d7ae-c013cc9fbdf6">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">rating_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>487</td>
<td>6</td>
<td>3</td>
<td>2.994869</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>54</td>
<td>349</td>
<td>3</td>
<td>2.511689</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>501</td>
<td>1252</td>
<td>4</td>
<td>4.130728</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>244</td>
<td>861</td>
<td>4</td>
<td>2.314526</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>322</td>
<td>1501</td>
<td>5</td>
<td>3.823119</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>537</td>
<td>1294</td>
<td>2</td>
<td>3.124064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>193</td>
<td>1530</td>
<td>3</td>
<td>2.546681</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>581</td>
<td>286</td>
<td>5</td>
<td>3.062707</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>450</td>
<td>154</td>
<td>4</td>
<td>4.161049</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>I get similar results as before!</p>
</section>
</section>
<section id="interpreting-embeddings-and-biases" class="level4">
<h4 class="anchored" data-anchor-id="interpreting-embeddings-and-biases">Interpreting Embeddings and Biases</h4>
<p>I’ll save this model so that the embedding and bias analyses I perform can be recreated.</p>
<div id="cell-122" class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> load_learner(<span class="st">"/content/gdrive/MyDrive/fastai-course-v4/dot_product_bias.pkl"</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Bias represents a baseline rating of a movie regardless of how well the latent factors of the movie match the latent factors of the user. Low bias values correspond to movies that people didn’t enjoy, even if it matched their preferences.</p>
<p>What were the 5 generally least liked movies?</p>
<p>To answer that question, I get the indexes of the sorted movie_bias values in ascending order, grab the first 5, and get their title from the DataLoaders classes. These 5 movies had the 5 lowest bias values.</p>
<div id="cell-124" class="cell" data-outputid="dcfbccc6-0ada-4b0c-f607-a9354f725823">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>movie_bias <span class="op">=</span> model.movie_bias</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> movie_bias.argsort()[:<span class="dv">5</span>]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>[dls.classes[<span class="st">'title'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> idxs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>['Children of the Corn: The Gathering (1996)',
 'Robocop 3 (1993)',
 'Showgirls (1995)',
 'Kansas City (1996)',
 'Lawnmower Man 2: Beyond Cyberspace (1996)']</code></pre>
</div>
</div>
<p>To answer that question, I get the indexes of the sorted movie_bias values in ascending order, grab the first 5, and get their title from the DataLoaders classes. These 5 movies had the 5 lowest bias values.</p>
<div id="cell-126" class="cell" data-outputid="dcbd3b2b-404a-404b-eb87-fc053de357d8">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> movie_bias.argsort(descending<span class="op">=</span><span class="va">True</span>)[:<span class="dv">5</span>]</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>[dls.classes[<span class="st">'title'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> idxs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>['Titanic (1997)',
 'L.A. Confidential (1997)',
 'As Good As It Gets (1997)',
 'Shawshank Redemption, The (1994)',
 'Good Will Hunting (1997)']</code></pre>
</div>
</div>
<section id="visualizing-embeddings" class="level5">
<h5 class="anchored" data-anchor-id="visualizing-embeddings">Visualizing Embeddings</h5>
<p>The embeddings are a 50-dimensional matrix of latent factors. I’ll use Principal Component Analysis (PCA) to extract the two most descriptive dimensions and plot the latent factor values. I’ll also calculate the distance from 0 of each movie so that I can filter for outliers in order to reduce the number of data points on the plot, and help me understand what these latent factors may be.</p>
<div id="cell-129" class="cell" data-outputid="3b401311-5d7f-4463-8409-862e102457e1">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install fbpca</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fbpca</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting fbpca
  Downloading https://files.pythonhosted.org/packages/a7/a5/2085d0645a4bb4f0b606251b0b7466c61326e4a471d445c1c3761a2d07bc/fbpca-1.0.tar.gz
Building wheels for collected packages: fbpca
  Building wheel for fbpca (setup.py) ... done
  Created wheel for fbpca: filename=fbpca-1.0-cp37-none-any.whl size=11376 sha256=719b80446eeb8f157c99e298adb61b0978c0ae279ade82e500dbe37902c447e4
  Stored in directory: /root/.cache/pip/wheels/53/a2/dd/9b66cf53dbc58cec1e613d216689e5fa946d3e7805c30f60dc
Successfully built fbpca
Installing collected packages: fbpca
Successfully installed fbpca-1.0</code></pre>
</div>
</div>
<p>I grab the <code>movie_factors</code> from the trained model, bring it over the the <code>.cpu()</code>, <code>.detach()</code> it from the gradients and convert it to a <code>.numpy()</code> array.</p>
<div id="cell-131" class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>movie_embeddings <span class="op">=</span> model.movie_factors.cpu().detach().numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I pass those embeddings to the <code>fbpca.pca</code> method and get back the rank-2 approximation.</p>
<div id="cell-133" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>U, s, Va <span class="op">=</span> fbpca.pca(movie_embeddings, k<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I then create a DataFrame from the <code>U</code> matrix which is an <code>m</code> x <code>k</code> (1665 movies x 2 components) matrix. I also create a column with the calculated distance from 0 of each movie, based on the 2-component coordinates, and a column specifying which quadrant the movie is in (First, Second, Third or Fourth).</p>
<p>My <code>distance</code> function receives each DataFrame <code>row</code>, and returns the square root of the sum of squares of the two coordinates.</p>
<p>My <code>quadrant</code> function received each <code>row</code> and based on the sign of the <code>x</code> or <code>0</code> column and the <code>y</code> or <code>1</code> column, determines which quadrant that movie lies in.</p>
<p>I <code>apply</code> both functions to the DataFrame and specify <code>axis=1</code> so that I can access the column names.</p>
<div id="cell-135" class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> distance(row):</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> np.sqrt(row[<span class="dv">0</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> row[<span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quadrant(row):</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (row[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> row[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"First Quadrant"</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elif</span> (row[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> row[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Second Quadrant"</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elif</span> (row[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> row[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">0</span>):</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Third Quadrant"</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elif</span> (row[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> row[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">0</span>):</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Fourth Quadrant"</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Center"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-136" class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create DataFrame from PCA output</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pca_to_df(U):</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span>U)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the distance of each Embedding from 0</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">2</span>] <span class="op">=</span> df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.sqrt(x[<span class="dv">0</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> x[<span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># identify which quadrant the movie is in</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">3</span>] <span class="op">=</span> df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: quadrant(x), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll import the DataFrame I created from my original PCA output so that I can recreate the corresponding plots.</p>
<div id="cell-138" class="cell" data-outputid="fc7b5272-5026-4340-b299-46d84db6c5c1">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"/content/gdrive/MyDrive/fastai-course-v4/movie_pca.csv"</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.010150</td>
<td>0.004517</td>
<td>0.011110</td>
<td>First Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.025090</td>
<td>-0.000186</td>
<td>0.025091</td>
<td>Fourth Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.005773</td>
<td>0.025443</td>
<td>0.026090</td>
<td>Second Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.015933</td>
<td>-0.021972</td>
<td>0.027141</td>
<td>Fourth Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.056279</td>
<td>-0.013351</td>
<td>0.057841</td>
<td>Third Quadrant</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>When I plot the first two columns as x,y coordinates, I can see that the movies are spread out quite evenly across those latent factors.</p>
<div id="cell-140" class="cell" data-outputid="96b36dc8-09ca-46af-f8e5-0474d139d74f">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(df[<span class="st">'0'</span>], df[<span class="st">'1'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I’m going to plot the farthest points from the origin and label them on the plot in order to get a sense of what these two latent factors may represent.</p>
<p>For each quadrant, I grab the indexes for the rows with the 5 largest distances and create a DataFrame from that and plot that data.</p>
<div id="cell-142" class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_top_5(df):</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the 5 points farthest from 0 from each quadrant</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  idxs <span class="op">=</span> np.array([])</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> quad <span class="kw">in</span> df[<span class="st">'3'</span>].unique():</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> np.append(idxs, df[df[<span class="st">'3'</span>]<span class="op">==</span>quad][<span class="st">'2'</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>).index[:<span class="dv">5</span>].values)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="op">=</span> df.loc[idxs]</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">%</span>matplotlib inline</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>  plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> [<span class="dv">15</span>, <span class="dv">15</span>]</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the movie titles which will be plot annotations</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>  movies <span class="op">=</span> dls.classes[<span class="st">'title'</span>][idxs]</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  ax.scatter(plot_df[<span class="st">'0'</span>], plot_df[<span class="st">'1'</span>])</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(idxs):</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>    ax.annotate(movies[i], (plot_df.loc[idx,<span class="st">'0'</span>], plot_df.loc[idx, <span class="st">'1'</span>]))</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>  plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-143" class="cell" data-outputid="b2cdee50-d2fb-4bd9-dbe7-276855c999fa">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>plot_top_5(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-73-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The first quadrant seems to represent comedies (Ed, Ready to Wear, The Stupids) although Barb Wire is not a comedy.</p>
<p>The second quadrant has movies with some more dark and disturbing elements to it.</p>
<p>The third quadrant has movies which are drama and I guess share some theme of gaining freedom?</p>
<p>Finally, the fourth quadrant seems to have drama and action movies which have a distinct American storyline to them. I haven’t seen all of these movies, but Dirty Dancing and The American President seem like anomalies in this group.</p>
<p>I should also take a look at other movies that do not fall on the extreme ends of each quadrant. For example, which movies fall close to the vertical and horizontal axes?</p>
<div id="cell-146" class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_close_to_axes(df):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get 5 points closes to each axis </span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  idxs <span class="op">=</span> np.array([])</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> key <span class="kw">in</span> [<span class="st">'0'</span>, <span class="st">'1'</span>]:</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> np.append(idxs, df[np.<span class="bu">abs</span>(df[key]) <span class="op">&lt;</span> <span class="fl">0.0002</span>].index.values)</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="op">=</span> df.loc[idxs]</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="op">=</span> plot_df.drop_duplicates()</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set figure size</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">%</span>matplotlib inline</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> [<span class="dv">15</span>, <span class="dv">15</span>]</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the movie titles which will be plot annotations</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>  movies <span class="op">=</span> dls.classes[<span class="st">'title'</span>][idxs]</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>  ax.scatter(plot_df[<span class="st">'0'</span>], plot_df[<span class="st">'1'</span>])</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># annotate with movie titles</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(idxs):</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    ax.annotate(movies[i], (plot_df.loc[idx,<span class="st">'0'</span>], plot_df.loc[idx, <span class="st">'1'</span>]))</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>  plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-147" class="cell" data-outputid="051b1b9a-2d22-468e-a8ed-08252f75c0da">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>plot_close_to_axes(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-75-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The latent factor corresponding to the vertical axis seems to represent drama (positive values) and romance (negative values) whereas the horizontal axis represents elements mystery (negative values) and comedy (positive values). However, I could just be focusing on genre whereas there are other features of a movie these may represent. Unfortunately, I’m not a movie buff, so the need for a domain expert is evident here!</p>
</section>
<section id="robust-pca" class="level5">
<h5 class="anchored" data-anchor-id="robust-pca">Robust PCA</h5>
<p>Although it’s out of scope for this chapter and my understanding, I’d like to at least experiment with using Robust PCA for visualizing embeddings. Robust PCA is an algorithm which decomposes a matrix M into two components: a low rank matrix L and a sparse matrix S such that M = L + S. From what I understand, the sparse matrix S contains anomalies or outliers or “corrupted” data, whereas L contains a more accurate representation of the original data. For example, if an image has some additional noise added to it, the original image matrix M can be decomposed into a noise-less “clean” image L and a sparse noise matrix S. Another example is if you have an image with a background (such as a landscape with lawn, sidewalks, buildings) and a foreground (people walking on the sidewalk) passing that image through the RPCA algorithm would yield a background matrix L with the lawn, sidewalk and buildings and a foreground sparse matrix S with the people. Since my <code>movie_embeddings</code> matrix may contain anomalies which would affect the effectiveness and accuracy of my 2-component PCA approximation, I will pass it through a RPCA algorithm and calculate the 2-component approximation on the low-rank L and sparse S matrices and compare the results with what I calculated above.</p>
<p>The following algorithm is from Rachel Thomas’ lesson on RPCA as part of her Computational Linear Algebra course.</p>
<div id="cell-151" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> sparse</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.extmath <span class="im">import</span> randomized_svd</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fbpca</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-152" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>TOL<span class="op">=</span><span class="fl">1e-9</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>MAX_ITERS<span class="op">=</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-153" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> converged(Z, d_norm):</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    err <span class="op">=</span> np.linalg.norm(Z, <span class="st">'fro'</span>) <span class="op">/</span> d_norm</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'error: '</span>, err)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> err <span class="op">&lt;</span> TOL</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-154" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shrink(M, tau):</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.<span class="bu">abs</span>(M) <span class="op">-</span> tau</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.sign(M) <span class="op">*</span> np.where(S<span class="op">&gt;</span><span class="dv">0</span>, S, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-155" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _svd(M, rank): <span class="cf">return</span> fbpca.pca(M, k<span class="op">=</span><span class="bu">min</span>(rank, np.<span class="bu">min</span>(M.shape)), raw<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-156" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm_op(M): <span class="cf">return</span> _svd(M, <span class="dv">1</span>)[<span class="dv">1</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-157" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> svd_reconstruct(M, rank, min_sv):</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    u, s, v <span class="op">=</span> _svd(M, rank)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    s <span class="op">-=</span> min_sv</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    nnz <span class="op">=</span> (s <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u[:,:nnz] <span class="op">@</span> np.diag(s[:nnz]) <span class="op">@</span> v[:nnz], nnz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-158" class="cell" hidden="true">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pcp(X, maxiter<span class="op">=</span><span class="dv">10</span>, k<span class="op">=</span><span class="dv">10</span>): <span class="co"># refactored</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    m, n <span class="op">=</span> X.shape</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    trans <span class="op">=</span> m<span class="op">&lt;</span>n</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trans: X <span class="op">=</span> X.T<span class="op">;</span> m, n <span class="op">=</span> X.shape</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    lamda <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>np.sqrt(m)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    op_norm <span class="op">=</span> norm_op(X)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> np.copy(X) <span class="op">/</span> <span class="bu">max</span>(op_norm, np.linalg.norm( X, np.inf) <span class="op">/</span> lamda)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> k<span class="op">*</span><span class="fl">1.25</span><span class="op">/</span>op_norm<span class="op">;</span> mu_bar <span class="op">=</span> mu <span class="op">*</span> <span class="fl">1e7</span><span class="op">;</span> rho <span class="op">=</span> k <span class="op">*</span> <span class="fl">1.5</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    d_norm <span class="op">=</span> np.linalg.norm(X, <span class="st">'fro'</span>)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> np.zeros_like(X)<span class="op">;</span> sv <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> []</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(maxiter):</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"rank sv:"</span>, sv)</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>        X2 <span class="op">=</span> X <span class="op">+</span> Y<span class="op">/</span>mu</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update estimate of Sparse Matrix by "shrinking/truncating": original - low-rank</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>        S <span class="op">=</span> shrink(X2 <span class="op">-</span> L, lamda<span class="op">/</span>mu)</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update estimate of Low-rank Matrix by doing truncated SVD of rank sv &amp; reconstructing.</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># count of singular values &gt; 1/mu is returned as svp</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>        L, svp <span class="op">=</span> svd_reconstruct(X2 <span class="op">-</span> S, sv, <span class="dv">1</span><span class="op">/</span>mu)</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If svp &lt; sv, you are already calculating enough singular values.</span></span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If not, add 20% (in this case 240) to sv</span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>        sv <span class="op">=</span> svp <span class="op">+</span> (<span class="dv">1</span> <span class="cf">if</span> svp <span class="op">&lt;</span> sv <span class="cf">else</span> <span class="bu">round</span>(<span class="fl">0.05</span><span class="op">*</span>n))</span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># residual</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> X <span class="op">-</span> L <span class="op">-</span> S</span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">+=</span> mu<span class="op">*</span>Z<span class="op">;</span> mu <span class="op">*=</span> rho</span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>        examples.extend([S[<span class="dv">140</span>,:], L[<span class="dv">140</span>,:]])</span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> m <span class="op">&gt;</span> mu_bar: m <span class="op">=</span> mu_bar</span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> converged(Z, d_norm): <span class="cf">break</span></span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trans: L<span class="op">=</span>L.T<span class="op">;</span> S<span class="op">=</span>S.T</span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L, S, examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-159" class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>L, S, examples <span class="op">=</span> pcp(movie_embeddings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-160" class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>L.shape, S.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll calculate 2-component PCA for the <code>L</code> and <code>S</code> matrices and plot those to see how they compare to the plots above.</p>
<div id="cell-162" class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>U_L, _, _ <span class="op">=</span> fbpca.pca(L, k<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>U_S, _, _ <span class="op">=</span> fbpca.pca(S, k<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I exported the outputs to CSV for repeatability, so I’ll import them in again:</p>
<div id="cell-164" class="cell" data-outputid="2693b8d3-d038-4d6f-d269-25b6c3036e99">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"/content/gdrive/MyDrive/fastai-course-v4/movies_L_pca.csv"</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.009254</td>
<td>-0.003454</td>
<td>0.009877</td>
<td>Fourth Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.032954</td>
<td>0.008637</td>
<td>0.034067</td>
<td>First Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.014662</td>
<td>-0.047128</td>
<td>0.049356</td>
<td>Third Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.012602</td>
<td>0.029182</td>
<td>0.031787</td>
<td>First Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.037841</td>
<td>0.008742</td>
<td>0.038838</td>
<td>Second Quadrant</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-165" class="cell" data-outputid="463625dd-960d-4712-9324-5bf27bd950d6">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(df[<span class="st">'0'</span>], df[<span class="st">'1'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-88-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The scatter plot for the 2-component PCA result seems much more evenly distributed across the quadrants.</p>
<p>I take the 5 farthest movies from each quadrant and plot those separately.</p>
<div id="cell-167" class="cell" data-outputid="6f0270d3-fa6a-45a5-e0a2-d1a672c0c046">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>plot_top_5(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-89-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here are the patterns I observe. Again, someone who has watched these movies and is not just reading online descriptions of them would see themes and patterns that I would not.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Quadrant</th>
<th style="text-align: center;">Observation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">Romance/Drama movies. Fausto and Castle Freak seem out of place</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">More romance movies. Top Gun and Prefontaine seem out of place</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">More romance movies. The Butcher Boy seems out of place.</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">Comedies. The Carmen Miranda documentary seems out of place.</td>
</tr>
</tbody>
</table>
<p>After making these observations, either the low-rank matrix L is a poor choice to use for this type of analysis, or my understanding these movies is too shallow to see the deeper relationships between them. With so many romance movies across the plot, I don’t think these latent factors represent genres.</p>
<p>I’m not too confident the <code>S</code> matrix will provide more clarity, but let’s see!</p>
<div id="cell-169" class="cell" data-outputid="13ae439f-175e-406c-ff5d-7001b4f286b7">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import previously generated CSV</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"/content/gdrive/MyDrive/fastai-course-v4/movies_S_pca.csv"</span>)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.009776</td>
<td>0.005041</td>
<td>0.010999</td>
<td>Second Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.021503</td>
<td>0.001765</td>
<td>0.021576</td>
<td>Second Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.005098</td>
<td>0.024645</td>
<td>0.025166</td>
<td>First Quadrant</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.016745</td>
<td>-0.021457</td>
<td>0.027218</td>
<td>Third Quadrant</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.056964</td>
<td>-0.023095</td>
<td>0.061467</td>
<td>Fourth Quadrant</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-170" class="cell" data-outputid="95df5a31-8c96-4534-c61f-a3f2b2c6a20c">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(df[<span class="st">'0'</span>], df[<span class="st">'1'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-171" class="cell" data-outputid="4150ba89-d329-441d-bcca-5e61b4a39090">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>plot_top_5(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021-06-04-fastai-chapter-08_files/figure-html/cell-92-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Interesting! This plot looks like the plot of the original M matrix PCA results reflected across the y-axis. Similar movies are grouped together but the latent factors are showing an inverse relationship to the original 2-components.</p>
</section>
</section>
<section id="using-fastai.collab" class="level4">
<h4 class="anchored" data-anchor-id="using-fastai.collab">Using fastai.collab</h4>
<p>fastai comes with a built-in method to create a collaborative filtering model similar to the <code>DotProductBias</code> model I created.</p>
<div id="cell-175" class="cell" data-outputid="7b36048c-b1e1-41c3-8268-a6c91aba1c5f">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> collab_learner(dls, n_factors<span class="op">=</span><span class="dv">50</span>, y_range<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">5.5</span>))</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.932735</td>
<td>0.930009</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.834800</td>
<td>0.862961</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.746893</td>
<td>0.822192</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.585107</td>
<td>0.811398</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.490022</td>
<td>0.812597</td>
<td>00:10</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This yields similar results to what I’ve done above. Here are this model’s results:</p>
<div id="cell-177" class="cell" data-outputid="3de24539-2824-4b3b-f3d4-cf78838dc869">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">rating_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>541</td>
<td>332</td>
<td>1</td>
<td>2.542970</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>899</td>
<td>1295</td>
<td>4</td>
<td>3.555057</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>346</td>
<td>1492</td>
<td>3</td>
<td>3.456876</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>933</td>
<td>1399</td>
<td>4</td>
<td>3.380442</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>310</td>
<td>1618</td>
<td>5</td>
<td>4.623110</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>276</td>
<td>1572</td>
<td>4</td>
<td>3.636531</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>463</td>
<td>322</td>
<td>5</td>
<td>3.901797</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>130</td>
<td>408</td>
<td>4</td>
<td>3.343735</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>914</td>
<td>1617</td>
<td>4</td>
<td>3.076288</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The model created is a <code>EmbeddingDotBias</code> model</p>
<div id="cell-179" class="cell" data-outputid="2865c281-f6c6-4bc6-be52-a17aae0e9f06">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>EmbeddingDotBias(
  (u_weight): Embedding(944, 50)
  (i_weight): Embedding(1665, 50)
  (u_bias): Embedding(944, 1)
  (i_bias): Embedding(1665, 1)
)</code></pre>
</div>
</div>
<p>The top biases can be obtained similar to how we did it before, but with a slightly different API:</p>
<div id="cell-181" class="cell" data-outputid="e3a0a996-47ee-49b9-9f43-016c58baf98c">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>movie_bias <span class="op">=</span> learn.model.i_bias.weight.squeeze()</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> movie_bias.argsort(descending<span class="op">=</span><span class="va">True</span>)[:<span class="dv">5</span>]</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>[dls.classes[<span class="st">'title'</span>][i] <span class="cf">for</span> i <span class="kw">in</span> idxs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>['Titanic (1997)',
 'Shawshank Redemption, The (1994)',
 'L.A. Confidential (1997)',
 'Star Wars (1977)',
 "Schindler's List (1993)"]</code></pre>
</div>
</div>
<p>Similar to the <code>distance</code> function I created, PyTorch has a <code>nn.CosineSimilarity</code> function which calculates the cosine of the angle between two vectors. The smaller the angle, the closer the two points are, and the more similar they are. <code>nn.CosineSimilarity</code> returns the similarity (cosine of the angle) between two vectors where <code>1.000</code> means the angle is 0.</p>
<div id="cell-183" class="cell" data-outputid="97182cbc-a5f4-41dd-e84a-ffa6d93e6f19">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>movie_factors <span class="op">=</span> learn.model.i_weight.weight</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> dls.classes[<span class="st">'title'</span>].o2i[<span class="st">'Silence of the Lambs, The (1991)'</span>]</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>similarity <span class="op">=</span> nn.CosineSimilarity(dim<span class="op">=</span><span class="dv">1</span>)(movie_factors, movie_factors[idx][<span class="va">None</span>])</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> similarity.argsort(descending<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>dls.classes[<span class="st">'title'</span>][idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>'Some Folks Call It a Sling Blade (1993)'</code></pre>
</div>
</div>
</section>
</section>
<section id="deep-learning-for-collaborative-filtering" class="level3">
<h3 class="anchored" data-anchor-id="deep-learning-for-collaborative-filtering">Deep Learning for Collaborative Filtering</h3>
<p>In this final section, we create a Deep Learning model which can make predictions on movie ratings after training on the MovieLens dataset. The model uses Embeddings (for users and movies) which are then fed into a small neural net (with one ReLu sandwiched between two Linear layers) which outputs an activation which we normalize using <code>sigmoid_range</code>. The embedding matrices are sized based on a heuristic built-in to fastai with the <code>get_emb_sz</code> method:</p>
<div id="cell-186" class="cell" data-outputid="17422515-2dd1-49b4-8d10-5cee7a24107c">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>embs <span class="op">=</span> get_emb_sz(dls)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>embs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>[(944, 74), (1665, 102)]</code></pre>
</div>
</div>
<p>The model used is constructed as follows: the user and item latent factors are created using <code>Embedding</code>s, and the neural net is created using the <code>nn.Sequential</code> class. Each time a prediction is needed, the user and item matrices for one batch are concatenated and passed through the neural net. The returned activation is sent to <code>sigmoid_range</code> and a prediction between 0 and 5.5 is calculated.</p>
<div id="cell-188" class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CollabNN(Module):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, user_sz, item_sz, y_range<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">5.5</span>), n_act<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(<span class="op">*</span>user_sz)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.item_factors <span class="op">=</span> Embedding(<span class="op">*</span>item_sz)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>        nn.Linear(user_sz[<span class="dv">1</span>]<span class="op">+</span>item_sz[<span class="dv">1</span>], n_act),</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        nn.Linear(n_act, <span class="dv">1</span>))</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    embs <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>]), <span class="va">self</span>.item_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.layers(torch.cat(embs, dim<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigmoid_range(x, <span class="op">*</span><span class="va">self</span>.y_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I want to visualize the <code>forward</code> method, so I’ll create the model and a batch, and walkthrough the code.</p>
<div id="cell-190" class="cell" data-outputid="cfc5fafa-e3d5-420c-cf78-d8c09a5b2452">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> CollabNN(<span class="op">*</span>embs)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> dls.one_batch()</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cpu"</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x.to(device)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>embs <span class="op">=</span> torch.cat((model.user_factors(x[:,<span class="dv">0</span>]), model.item_factors(x[:,<span class="dv">1</span>])), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>embs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>torch.Size([64, 176])</code></pre>
</div>
</div>
<div id="cell-191" class="cell" data-outputid="87f799fe-e775-4a5c-94c5-71cde06adca4">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> model.layers(embs)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>sigmoid_range(x, <span class="op">*</span>model.y_range)[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>tensor([[2.8637],
        [2.8647],
        [2.8624],
        [2.8696],
        [2.8601]], grad_fn=&lt;SliceBackward&gt;)</code></pre>
</div>
</div>
<p>The fastai <code>collab_learner</code>, instead of using the <code>EmbeddingDotBias</code> model, will use a neural network if passed <code>True</code> for its <code>use_nn</code> parameter. The number and size of neural network layers can also be specified.</p>
<div id="cell-193" class="cell" data-outputid="e9cc51fa-51f2-413d-a02f-7403784a5dfc">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> collab_learner(dls, use_nn<span class="op">=</span><span class="va">True</span>, y_range<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">5.5</span>), layers<span class="op">=</span>[<span class="dv">100</span>,<span class="dv">50</span>])</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.988426</td>
<td>0.984418</td>
<td>00:15</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.893442</td>
<td>0.909180</td>
<td>00:16</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.900106</td>
<td>0.877499</td>
<td>00:16</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.809255</td>
<td>0.853736</td>
<td>00:16</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.769467</td>
<td>0.853571</td>
<td>00:16</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-194" class="cell" data-outputid="c5215a0c-f010-4bb5-e0b4-84dd48757daf">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">rating_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>244</td>
<td>1305</td>
<td>4</td>
<td>4.185966</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>902</td>
<td>965</td>
<td>3</td>
<td>3.474954</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>87</td>
<td>1173</td>
<td>5</td>
<td>4.206645</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>759</td>
<td>333</td>
<td>5</td>
<td>4.247213</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>109</td>
<td>1624</td>
<td>3</td>
<td>3.726794</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>363</td>
<td>743</td>
<td>1</td>
<td>1.774737</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>756</td>
<td>1216</td>
<td>5</td>
<td>4.058509</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>378</td>
<td>179</td>
<td>4</td>
<td>3.192873</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>18</td>
<td>141</td>
<td>3</td>
<td>3.296141</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="cell-195" class="cell" data-outputid="88983ce9-2975-48cd-f7f6-676726d91f66">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>EmbeddingNN(
  (embeds): ModuleList(
    (0): Embedding(944, 74)
    (1): Embedding(1665, 102)
  )
  (emb_drop): Dropout(p=0.0, inplace=False)
  (bn_cont): BatchNorm1d(0, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (layers): Sequential(
    (0): LinBnDrop(
      (0): Linear(in_features=176, out_features=100, bias=False)
      (1): ReLU(inplace=True)
      (2): BatchNorm1d(100, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (1): LinBnDrop(
      (0): Linear(in_features=100, out_features=50, bias=False)
      (1): ReLU(inplace=True)
      (2): BatchNorm1d(50, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (2): LinBnDrop(
      (0): Linear(in_features=50, out_features=1, bias=True)
    )
    (3): SigmoidRange(low=0, high=5.5)
  )
)</code></pre>
</div>
</div>
<p>The <code>EmbeddingNN</code> architecture extends the <code>TabularModel</code> class which we will explore in Chapter 9.</p>
<p>That finishes my review of Chapter 8, I’ll be working through the “Further Research” section in upcoming blog posts and associated videos:</p>
<blockquote class="blockquote">
<ol type="1">
<li>Take a look at all the differences between the <code>Embedding</code> version of <code>DotProductBias</code> and the <code>create_params</code> version, and try to understand why each of those changes is required. If you’re not sure, try reverting each change to see what happens.</li>
</ol>
</blockquote>
<blockquote class="blockquote">
<ol start="2" type="1">
<li>Find three other areas where collaborative filtering is being used, and identify the pros and cons of this approach in those areas.</li>
</ol>
</blockquote>
<blockquote class="blockquote">
<ol start="3" type="1">
<li>Complete this notebook using the full MovieLens dataset, and compare your results to online benchmarks. See if you can improve your accuracy. Look on the book’s website and the fast.ai forums for ideas. Note that there are more columns in the full dataset–see if you can use those too (the next chapter might give you ideas).</li>
</ol>
</blockquote>
<blockquote class="blockquote">
<ol start="4" type="1">
<li>Create a model for MovieLens that works with cross-entropy loss, and compare it to the model in this chapter.</li>
</ol>
</blockquote>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>