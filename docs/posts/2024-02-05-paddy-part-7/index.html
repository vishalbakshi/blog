<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishal Bakshi">
<meta name="dcterms.date" content="2024-02-05">
<meta name="description" content="In this notebook I run the code from Jeremy Howard’s “Scaling Up - Road to the Top, Part 3” notebook.">

<title>Vishal Bakshi’s Blog - Paddy Doctor Kaggle Competition - Part 7</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vishal Bakshi’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#using-lr_find-for-large-models" id="toc-using-lr_find-for-large-models" class="nav-link" data-scroll-target="#using-lr_find-for-large-models">Using <code>lr_find</code> for Large Models</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Paddy Doctor Kaggle Competition - Part 7</h1>
  <div class="quarto-categories">
    <div class="quarto-category">deep learning</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">kaggle competition</div>
    <div class="quarto-category">paddy doctor</div>
    <div class="quarto-category">python</div>
  </div>
  </div>

<div>
  <div class="description">
    In this notebook I run the code from Jeremy Howard’s “Scaling Up - Road to the Top, Part 3” notebook.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vishal Bakshi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In the fastai course Part 1 <a href="https://youtu.be/AdhG64NF76E?feature=shared&amp;t=3117">Lesson 6 video</a> Jeremy Howard walked through the notebooks <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2">Small models: Road to the Top, Part 2</a> where he builds increasingly accurate solutions to the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> Kaggle Competition. In the video, Jeremy referenced a series of walkthrough videos that he made while working through the four-notebook series for this competition. I’m excited to watch these walkthroughs to better understand how to approach a Kaggle competition from the perspective of a former #1 Kaggle grandmaster.</p>
<p>In this blog post series, I’ll walk through the code Jeremy shared in each of the 6 Live Coding videos focused on this competition, submitting predictions to Kaggle along the way. My last two blog posts in this series reference Jeremy’s <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a> notebook to improve my large model ensemble predictions. Here are the links to each of the blog posts in this series:</p>
<ul>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-1/">Part 1: Live Coding 8</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-2/">Part 2: Live Coding 9</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-3/">Part 3: Live Coding 10</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-4/">Part 4: Live Coding 11</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-5/">Part 5: Live Coding 12</a></li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-6/">Part 6: Live Coding 13</a></li>
<li>Part 7: Improving My Large Ensemble, Part 1 (You are here)</li>
<li><a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-8/">Part 8: Improving My Large Ensemble, Part 2</a></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> userdata</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>creds <span class="op">=</span> userdata.get(<span class="st">'kaggle'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>cred_path <span class="op">=</span> Path(<span class="st">"~/.kaggle/kaggle.json"</span>).expanduser()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> cred_path.exists():</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  cred_path.parent.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  cred_path.write_text(creds)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  cred_path.chmod(<span class="bn">0o600</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="07c9a967-935b-4606-8dc7-265a5f4b1dc8">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq timm<span class="op">==</span><span class="fl">0.6.13</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timm</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>timm.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 0.0/549.1 kB ? eta -:--:--     ━━━━━━╸━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 92.2/549.1 kB 2.8 MB/s eta 0:00:01     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸━━━━━━ 460.8/549.1 kB 7.0 MB/s eta 0:00:01     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 549.1/549.1 kB 6.5 MB/s eta 0:00:00</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>'0.6.13'</code></pre>
</div>
</div>
<div class="cell" data-outputid="6c784853-d435-4310-ba58-d545434934c0">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile,kaggle</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'paddy-disease-classification'</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> path.exists():</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  kaggle.api.competition_download_cli(<span class="bu">str</span>(path))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  zipfile.ZipFile(<span class="ss">f'</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">.zip'</span>).extractall(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading paddy-disease-classification.zip to /content</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1.02G/1.02G [00:35&lt;00:00, 30.9MB/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="b810c338-938d-4191-99ba-18d28196ad7c">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(#4) [Path('paddy-disease-classification/train.csv'),Path('paddy-disease-classification/sample_submission.csv'),Path('paddy-disease-classification/test_images'),Path('paddy-disease-classification/train_images')]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>trn_path <span class="op">=</span> path<span class="op">/</span><span class="st">'train_images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run this once and re-use for all trainings</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tst_files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'test_images'</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>tst_files.sort()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="90c37b15-89d4-4d8f-a99d-4beb36f9b312">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tst_files[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(#5) [Path('paddy-disease-classification/test_images/200001.jpg'),Path('paddy-disease-classification/test_images/200002.jpg'),Path('paddy-disease-classification/test_images/200003.jpg'),Path('paddy-disease-classification/test_images/200004.jpg'),Path('paddy-disease-classification/test_images/200005.jpg')]</code></pre>
</div>
</div>
</section>
<section id="using-lr_find-for-large-models" class="level2">
<h2 class="anchored" data-anchor-id="using-lr_find-for-large-models">Using <code>lr_find</code> for Large Models</h2>
<p>One of the students in Live coding 12 faced the same problem as I did: their large model ensemble submission did not improve their Kaggle scores. Jeremy said this is probably because they ran some incorrect code somewhere, and suggested (among other things), to see if using a learning rate from <code>lr_find</code> improved their ensemble. This is what I’ll try next to improve my Kaggle score. If it doesn’t work, I’ll reference Jeremy’s Road to the Top notebook corresponding to large model training, and see what I coded wrong.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:16:10.934616Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:16:10.934185Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:16:10.941924Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:16:10.940875Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:16:10.934587Z&quot;}" data-trusted="true">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>kwargs <span class="op">=</span> {<span class="st">'bs'</span>: <span class="dv">16</span>}</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>cbs <span class="op">=</span> GradientAccumulation(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:16:11.829690Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:16:11.828824Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:16:11.834303Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:16:11.833235Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:16:11.829646Z&quot;}" data-trusted="true">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'swinv2_large_window12_192_22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I wasn’t getting a very promising learning rate result the first few times I rant it. The <code>lr_find</code> plot didn’t have a section that was steep and somewhat linear, so I’ll run <code>lr_find</code> a few times here to show what I was seeing:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:29:43.625980Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:29:43.625442Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:30:28.392480Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:30:28.391238Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:29:43.625937Z&quot;}" data-outputid="b568b75b-35df-4c77-fbda-5c3b9c5c1267" data-trusted="true">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:31:41.586283Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:31:41.585180Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:32:28.927204Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:32:28.925928Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:31:41.586192Z&quot;}" data-outputid="94a26c1a-d91b-44d1-f46a-826c619d4026" data-trusted="true">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-14-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:34:28.749017Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:34:28.748592Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:35:15.395256Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:35:15.394251Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:34:28.748982Z&quot;}" data-outputid="3e95b805-a45b-482e-8e16-036688a2637e" data-trusted="true">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>SuggestedLRs(valley=0.0012022644514217973)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-15-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>The suggested learning rate (~0.001) is always conservative, so I’ll pick something larger for the swinv2_large_window12_192_22k architecture: 0.005.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:39:32.130036Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:39:32.129660Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:39:32.134566Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:39:32.133636Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:39:32.130006Z&quot;}" data-trusted="true">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'convnext_large_in22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:39:33.549379Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:39:33.548926Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:40:24.339486Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:40:24.338333Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:39:33.549344Z&quot;}" data-outputid="7441d171-a621-4c90-8c34-02283e7cd0a2" data-trusted="true">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize((<span class="dv">640</span>,<span class="dv">480</span>)),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">288</span>,<span class="dv">224</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_large_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_large_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-17-output-5.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:41:25.307181Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:41:25.306284Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:42:06.886455Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:42:06.885180Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:41:25.307140Z&quot;}" data-outputid="b8ddef98-ee7a-445f-c569-a781c88ffaea" data-trusted="true">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize((<span class="dv">640</span>,<span class="dv">480</span>)),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">288</span>,<span class="dv">224</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-18-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:44:30.155226Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:44:30.154829Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:45:12.976928Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:45:12.975690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:44:30.155176Z&quot;}" data-outputid="cfa4c766-b63e-48f2-fcb0-9d91a81158f1" data-trusted="true">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize((<span class="dv">640</span>,<span class="dv">480</span>)),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">288</span>,<span class="dv">224</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-19-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>For convnext_large_in22k, I’m tempted to use 0.02, but in the last run of <code>lr_find</code> the loss just starts to inflect upwards at this learning rate. I’ll go with 0.015.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:47:47.591699Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:47:47.590705Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:47:47.597310Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:47:47.596170Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:47:47.591637Z&quot;}" data-trusted="true">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'vit_large_patch16_224'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:47:52.294071Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:47:52.293126Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:49:21.817528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:49:21.816289Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:47:52.294028Z&quot;}" data-outputid="69edf5a1-bb7b-415d-b0f5-3bc8628b0702" data-trusted="true">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-21-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:49:41.734445Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:49:41.734090Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:50:34.118557Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:50:34.117385Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:49:41.734417Z&quot;}" data-outputid="b8823c63-954e-419b-e1d7-4862af9ff442" data-trusted="true">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-22-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-01-30T03:50:34.121172Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-01-30T03:50:34.120756Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-01-30T03:51:24.676613Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-01-30T03:51:24.675471Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-01-30T03:50:34.121132Z&quot;}" data-outputid="2ad7eaed-81e4-45b1-c65a-517a5455534a" data-trusted="true">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    trn_path,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    valid_pct<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">480</span>),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>learn.model_dir <span class="op">=</span> <span class="st">'/tmp/model'</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>SuggestedLRs(valley=0.00363078061491251)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-23-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>For vit_large_patch16_224, I’ll use a learning rate of 0.005. I was tempted to use 0.01 but the loss starts to enter instability in the second <code>lr_find</code> run.</p>
<p>Here is a summary of learning rates I’ll use for each architecture:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Architecture</th>
<th style="text-align: center;">Learning Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">swinv2_large_window12_192_22k</td>
<td style="text-align: center;">0.005</td>
</tr>
<tr class="even">
<td style="text-align: center;">convnext_large_in22k</td>
<td style="text-align: center;">0.015</td>
</tr>
<tr class="odd">
<td style="text-align: center;">vit_large_patch16_224</td>
<td style="text-align: center;">0.005</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">=</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that my <code>train</code> function now has the parameters <code>lr</code> and <code>n_epochs</code> to specify learning rate and number of training epochs, respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(arch, item, batch, lr, n_epochs<span class="op">=</span><span class="dv">24</span>, accum<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    kwargs <span class="op">=</span> {<span class="st">'bs'</span>: <span class="dv">16</span>} <span class="cf">if</span> accum <span class="cf">else</span> {}</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>item, batch_tfms<span class="op">=</span>batch, <span class="op">**</span>kwargs)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    cbs <span class="op">=</span> GradientAccumulation(<span class="dv">2</span>) <span class="cf">if</span> accum <span class="cf">else</span> []</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> vision_learner(dls, arch, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>cbs).to_fp16()</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    learn.fine_tune(n_epochs, lr)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># view losses</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    learn.recorder.plot_loss()</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TTA predictions using test dataset</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    tst_dl <span class="op">=</span> dls.test_dl(tst_files)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    tta_res.append(learn.tta(dl<span class="op">=</span>tst_dl))</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return error rate using validation dataset</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error_rate(<span class="op">*</span>learn.tta(dl<span class="op">=</span>dls.valid)))</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> learn, dls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prep_submission(fn, tta_res):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pull out predictions from tta_res list</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    tta_prs <span class="op">=</span> first(<span class="bu">zip</span>(<span class="op">*</span>tta_res))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert tta_res from list to stacked tensor</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    t_tta <span class="op">=</span> torch.stack(tta_prs)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># take mean of each item's predictions</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    avg_pr <span class="op">=</span> t_tta.mean(<span class="dv">0</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the index (class) of the maximum prediction for each item</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> avg_pr.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create DataLoaders to get its vocab</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op">=</span><span class="fl">0.2</span>, item_tfms<span class="op">=</span>Resize(<span class="dv">224</span>))</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert indexes to vocab strings</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    mapping <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(dls.vocab))</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add vocab strings to sample submission file and export to CSV</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    ss <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'sample_submission.csv'</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.Series(idxs.numpy(), name<span class="op">=</span><span class="st">'idxs'</span>).<span class="bu">map</span>(mapping)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    ss.label <span class="op">=</span> results</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    ss.to_csv(fn, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'swinv2_large_window12_192_22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="8af49f53-4ed3-4279-cea9-e24b08d80233">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>train(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    arch,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    item<span class="op">=</span>Resize(<span class="dv">480</span>, method<span class="op">=</span><span class="st">'squish'</span>),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    batch<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">0.005</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">24</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    accum<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.10/dist-packages/torch/functional.py:504: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at ../aten/src/ATen/native/TensorShape.cpp:3526.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
Downloading: "https://github.com/SwinTransformer/storage/releases/download/v2.0.0/swinv2_large_patch4_window12_192_22k.pth" to /root/.cache/torch/hub/checkpoints/swinv2_large_patch4_window12_192_22k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.070781</td>
      <td>0.601547</td>
      <td>0.201346</td>
      <td>04:03</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">


    <div>
      <progress value="17" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      70.83% [17/24 1:33:49&lt;38:38]
    </div>
    
<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.430227</td>
      <td>0.230742</td>
      <td>0.080250</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.336965</td>
      <td>0.175396</td>
      <td>0.056704</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.298998</td>
      <td>0.187081</td>
      <td>0.057665</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.307775</td>
      <td>0.166967</td>
      <td>0.055742</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.274865</td>
      <td>0.170166</td>
      <td>0.045651</td>
      <td>05:34</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.314666</td>
      <td>0.183352</td>
      <td>0.049976</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.225893</td>
      <td>0.139452</td>
      <td>0.038924</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.209061</td>
      <td>0.147105</td>
      <td>0.039885</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.166353</td>
      <td>0.107878</td>
      <td>0.027871</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.220547</td>
      <td>0.132710</td>
      <td>0.033638</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.141531</td>
      <td>0.133753</td>
      <td>0.039404</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.076975</td>
      <td>0.186801</td>
      <td>0.036040</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.070114</td>
      <td>0.119698</td>
      <td>0.026910</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.086218</td>
      <td>0.103130</td>
      <td>0.025469</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.059969</td>
      <td>0.075689</td>
      <td>0.019702</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.064261</td>
      <td>0.080532</td>
      <td>0.018260</td>
      <td>05:33</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.048361</td>
      <td>0.083898</td>
      <td>0.019222</td>
      <td>05:33</td>
    </tr>
  </tbody>
</table><p>

    </p><div>
      <progress value="81" class="" max="520" style="width:300px; height:20px; vertical-align: middle;"></progress>
      15.58% [81/520 00:47&lt;04:18 0.0468]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.430227</td>
      <td>0.230742</td>
      <td>0.080250</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.336965</td>
      <td>0.175396</td>
      <td>0.056704</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.298998</td>
      <td>0.187081</td>
      <td>0.057665</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.307775</td>
      <td>0.166967</td>
      <td>0.055742</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.274865</td>
      <td>0.170166</td>
      <td>0.045651</td>
      <td>05:34</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.314666</td>
      <td>0.183352</td>
      <td>0.049976</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.225893</td>
      <td>0.139452</td>
      <td>0.038924</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.209061</td>
      <td>0.147105</td>
      <td>0.039885</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.166353</td>
      <td>0.107878</td>
      <td>0.027871</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.220547</td>
      <td>0.132710</td>
      <td>0.033638</td>
      <td>05:29</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.141531</td>
      <td>0.133753</td>
      <td>0.039404</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.076975</td>
      <td>0.186801</td>
      <td>0.036040</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.070114</td>
      <td>0.119698</td>
      <td>0.026910</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.086218</td>
      <td>0.103130</td>
      <td>0.025469</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.059969</td>
      <td>0.075689</td>
      <td>0.019702</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.064261</td>
      <td>0.080532</td>
      <td>0.018260</td>
      <td>05:33</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.048361</td>
      <td>0.083898</td>
      <td>0.019222</td>
      <td>05:33</td>
    </tr>
    <tr>
      <td>17</td>
      <td>0.031970</td>
      <td>0.089230</td>
      <td>0.019222</td>
      <td>05:32</td>
    </tr>
    <tr>
      <td>18</td>
      <td>0.031545</td>
      <td>0.079374</td>
      <td>0.019222</td>
      <td>05:30</td>
    </tr>
    <tr>
      <td>19</td>
      <td>0.026196</td>
      <td>0.078567</td>
      <td>0.018260</td>
      <td>05:32</td>
    </tr>
    <tr>
      <td>20</td>
      <td>0.016311</td>
      <td>0.070167</td>
      <td>0.018260</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>21</td>
      <td>0.022081</td>
      <td>0.068992</td>
      <td>0.016338</td>
      <td>05:31</td>
    </tr>
    <tr>
      <td>22</td>
      <td>0.024040</td>
      <td>0.073405</td>
      <td>0.017780</td>
      <td>05:32</td>
    </tr>
    <tr>
      <td>23</td>
      <td>0.016780</td>
      <td>0.072001</td>
      <td>0.017299</td>
      <td>05:32</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorBase(0.0178)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(&lt;fastai.learner.Learner at 0x782e6b00a860&gt;,
 &lt;fastai.data.core.DataLoaders at 0x782e6b00a740&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-17.png" class="img-fluid"></p>
</div>
</div>
<p>The output is unfortunately a bit messy, but here are my observations:</p>
<ul>
<li>The TTA error rate is 0.0178 and the final epoch’s validation error rate is a bit lower. This is a good sign as this shows an improvement in error rate compared to the error rate (0.01862) when using a learning rate of 0.01. However, the improvement is only 5%, which seems unremarkable.</li>
<li>The training and validation losses look okay. The both decrease over epochs, and the validation loss does not seem to be increasing significantly at the end, so the model is not overfitting.</li>
</ul>
<p>I’m not convinced that changing the learning rate from 0.01 to 0.005 has significantly improved my model, but I will go ahead and train the other two models in this ensemble and submit the predictions to Kaggle. If the private score does not improve, I’ll reference Jeremy’s “Road to the Top” notebook series to see how he trained his large models.</p>
<div class="cell" data-outputid="f7a637e9-51e3-4dbc-98a5-5b96c9850ad9">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(1, 3469)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'convnext_large_in22k'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="2bc37254-ed7c-4254-b4d1-229451e8d631">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>learn, dls <span class="op">=</span> train(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    arch,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    item<span class="op">=</span>Resize((<span class="dv">640</span>,<span class="dv">480</span>)),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    batch<span class="op">=</span>aug_transforms(size<span class="op">=</span>(<span class="dv">288</span>,<span class="dv">224</span>), min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">0.015</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">24</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    accum<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_large_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_large_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.350656</td>
      <td>0.639466</td>
      <td>0.192696</td>
      <td>03:17</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.393383</td>
      <td>0.226754</td>
      <td>0.069678</td>
      <td>05:01</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.278609</td>
      <td>0.194963</td>
      <td>0.054301</td>
      <td>05:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.258872</td>
      <td>0.242242</td>
      <td>0.069678</td>
      <td>04:59</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.272949</td>
      <td>0.242155</td>
      <td>0.070639</td>
      <td>05:01</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.250942</td>
      <td>0.288342</td>
      <td>0.073042</td>
      <td>04:59</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.256650</td>
      <td>0.224654</td>
      <td>0.060067</td>
      <td>05:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.215623</td>
      <td>0.242569</td>
      <td>0.054781</td>
      <td>04:59</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.204849</td>
      <td>0.183193</td>
      <td>0.049495</td>
      <td>04:59</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.175016</td>
      <td>0.224864</td>
      <td>0.044210</td>
      <td>04:58</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.179674</td>
      <td>0.374226</td>
      <td>0.078328</td>
      <td>04:58</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.105390</td>
      <td>0.209836</td>
      <td>0.037482</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.088776</td>
      <td>0.209220</td>
      <td>0.039404</td>
      <td>04:58</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.071399</td>
      <td>0.180012</td>
      <td>0.034118</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.066381</td>
      <td>0.153438</td>
      <td>0.030754</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.062488</td>
      <td>0.146692</td>
      <td>0.028832</td>
      <td>04:58</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.062825</td>
      <td>0.142316</td>
      <td>0.026430</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.044528</td>
      <td>0.153894</td>
      <td>0.025949</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>17</td>
      <td>0.043213</td>
      <td>0.144824</td>
      <td>0.024027</td>
      <td>04:56</td>
    </tr>
    <tr>
      <td>18</td>
      <td>0.018004</td>
      <td>0.145353</td>
      <td>0.022585</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>19</td>
      <td>0.024245</td>
      <td>0.138911</td>
      <td>0.021624</td>
      <td>04:59</td>
    </tr>
    <tr>
      <td>20</td>
      <td>0.009057</td>
      <td>0.139719</td>
      <td>0.022105</td>
      <td>04:57</td>
    </tr>
    <tr>
      <td>21</td>
      <td>0.015471</td>
      <td>0.134287</td>
      <td>0.020663</td>
      <td>04:56</td>
    </tr>
    <tr>
      <td>22</td>
      <td>0.020319</td>
      <td>0.135233</td>
      <td>0.021624</td>
      <td>04:56</td>
    </tr>
    <tr>
      <td>23</td>
      <td>0.011382</td>
      <td>0.138716</td>
      <td>0.019702</td>
      <td>04:57</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="1" class="" max="4" style="width:300px; height:20px; vertical-align: middle;"></progress>
      25.00% [1/4 00:24&lt;01:12]
    </div>
    


    <div>
      <progress value="77" class="" max="131" style="width:300px; height:20px; vertical-align: middle;"></progress>
      58.78% [77/131 00:14&lt;00:09 0.0114]
    </div>
    
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorBase(0.0197)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-32-output-16.png" class="img-fluid"></p>
</div>
</div>
<p>Here are my observations:</p>
<ul>
<li>The larger learning rate of 0.015, although reasonably estimated from the <code>lr_find</code> plot, has decreased the performance of the model. The final validation error rate with lr=0.015 is 0.019702, which is larger than the final validation error rate with lr=0.01 (0.014416). I’ll stick with this for now—perhaps this difference in validation error rate can be attributed to the difference in validation sets. Again, if my large model ensemble does not result in an improved Kaggle score, I’ll reference Jeremy’s solution.</li>
<li>The training and validation losses are generally decreasing over the epochs, and are not showing signs of overfitting (i.e., validation loss increasing).</li>
</ul>
<p>I’ll train the final model next.</p>
<div class="cell" data-outputid="45cf1510-02aa-4b0f-ca0b-95d2e4c8e39b">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">1</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(2, 3469, 3469)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save_pickle("colab_tta_res.pkl", tta_res)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tta_res = load_pickle("colab_tta_res.pkl")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>arch <span class="op">=</span> <span class="st">'vit_large_patch16_224'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="0982070f-0afb-44ad-a865-d2c5c476491b">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>learn, dls <span class="op">=</span> train(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    arch,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    item<span class="op">=</span>Resize(<span class="dv">480</span>),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    batch<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">0.005</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">24</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    accum<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.163018</td>
      <td>0.609755</td>
      <td>0.195579</td>
      <td>04:13</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.495968</td>
      <td>0.220330</td>
      <td>0.067756</td>
      <td>06:21</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.365600</td>
      <td>0.222172</td>
      <td>0.073522</td>
      <td>06:22</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.306510</td>
      <td>0.231306</td>
      <td>0.064873</td>
      <td>06:22</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.312357</td>
      <td>0.164647</td>
      <td>0.044690</td>
      <td>06:21</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.326301</td>
      <td>0.223919</td>
      <td>0.060548</td>
      <td>06:21</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.291703</td>
      <td>0.213934</td>
      <td>0.057665</td>
      <td>06:21</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.221403</td>
      <td>0.221377</td>
      <td>0.055262</td>
      <td>06:18</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.234319</td>
      <td>0.178601</td>
      <td>0.044690</td>
      <td>06:19</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.171401</td>
      <td>0.246879</td>
      <td>0.049976</td>
      <td>06:18</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.194408</td>
      <td>0.148840</td>
      <td>0.035079</td>
      <td>06:18</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.145152</td>
      <td>0.149591</td>
      <td>0.041326</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.113229</td>
      <td>0.159672</td>
      <td>0.032196</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.085892</td>
      <td>0.125524</td>
      <td>0.020663</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.053963</td>
      <td>0.106966</td>
      <td>0.023546</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.110243</td>
      <td>0.099779</td>
      <td>0.024507</td>
      <td>06:16</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.048981</td>
      <td>0.129755</td>
      <td>0.031235</td>
      <td>06:18</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.055013</td>
      <td>0.106256</td>
      <td>0.017299</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>17</td>
      <td>0.043242</td>
      <td>0.111034</td>
      <td>0.021624</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>18</td>
      <td>0.034097</td>
      <td>0.097368</td>
      <td>0.016819</td>
      <td>06:16</td>
    </tr>
    <tr>
      <td>19</td>
      <td>0.035058</td>
      <td>0.098730</td>
      <td>0.017780</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>20</td>
      <td>0.030310</td>
      <td>0.098341</td>
      <td>0.014897</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>21</td>
      <td>0.019945</td>
      <td>0.096790</td>
      <td>0.013936</td>
      <td>06:17</td>
    </tr>
    <tr>
      <td>22</td>
      <td>0.010267</td>
      <td>0.095050</td>
      <td>0.014416</td>
      <td>06:18</td>
    </tr>
    <tr>
      <td>23</td>
      <td>0.015022</td>
      <td>0.094428</td>
      <td>0.014416</td>
      <td>06:19</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="1" class="" max="4" style="width:300px; height:20px; vertical-align: middle;"></progress>
      25.00% [1/4 00:45&lt;02:16]
    </div>
    


    <div>
      <progress value="40" class="" max="217" style="width:300px; height:20px; vertical-align: middle;"></progress>
      18.43% [40/217 00:08&lt;00:38 0.0150]
    </div>
    
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorBase(0.0139)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-37-output-15.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="bba2841d-dbac-4b97-bac5-9c1f9e347f87">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">1</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">2</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(3, 3469, 3469, 3469)</code></pre>
</div>
</div>
<p>Observations about this training:</p>
<ul>
<li>The final validation error rate for lr=0.005 was 0.014416, which is about 35% less than when lr=0.01 (0.02215). That’s a good sign that this smaller learning rate was a better choice.</li>
<li>As with the other models, the training and validation losses generally decrease over epochs.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save_pickle("final_tta_res.pkl", tta_res)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tta_res = load_pickle("final_tta_res.pkl")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll make a new submission with these predictions to Kaggle and see how it scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>prep_submission(<span class="st">"subm.csv"</span>, tta_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="b8225470-078e-40d8-cded-ebd8f015e9e5">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>The submission’s first few values are the same as before, so that’s a good sign.</p>
<p>This submission’s scores were:</p>
<ul>
<li>Private: 0.98387 (previous best: 0.98617)</li>
<li>Public: 0.98577 (previous best: 0.98577)</li>
</ul>
<p>The submissions with the best private score are still my small ensemble of these architectures that were trained for 12 epochs, and a large ensemble with the vit predictions with 3x the weight of the others.</p>
<p>I’ll triple the weight of the large vit model predictions and submit it to Kaggle to see if it improves the private score:</p>
<div class="cell" data-outputid="400ca0ab-da14-46a1-8b90-99199efad89e">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">1</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">2</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(3, 3469, 3469, 3469)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tta_res <span class="op">+=</span> <span class="dv">2</span> <span class="op">*</span> [tta_res[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="c670618a-55e6-4aa8-a0d8-1e89eecfb885">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tta_res), <span class="bu">len</span>(tta_res[<span class="dv">0</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">1</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">2</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">3</span>][<span class="dv">0</span>]), <span class="bu">len</span>(tta_res[<span class="dv">4</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(5, 3469, 3469, 3469, 3469, 3469)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>prep_submission(<span class="st">"subm.csv"</span>, tta_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="6a16cfcf-fdc9-498e-bf81-7f802a52b089">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head subm.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
<p>This submission matched my previous best Private score, and improved upon my previous best Public score:</p>
<ul>
<li>Private score: 0.98617</li>
<li>Public score: 0.98654</li>
</ul>
<p>It’s interesting to me that I can’t break this ceiling of 0.98617! I will now reference Jeremy’s large model ensemble and see if I can improve my score by following his methodology in my <a href="https://vishalbakshi.github.io/blog/posts/2024-02-05-paddy-part-8/">next blog post.</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>